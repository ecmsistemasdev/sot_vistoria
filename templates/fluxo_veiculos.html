<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="static/img/logo_sotweb.jpg">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fluxo de Veículos</title>
    <link rel="stylesheet" href="/static/css/controle_locacoes.css">    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <!-- Menu de navegação fixo -->
    <nav class="navbar navbar-expand-lg navbar-light fixed-navbar">
        <div class="container">
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <!-- Cadastros -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarCadastros" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Cadastros
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="navbarCadastros">
                            <li><a class="dropdown-item" href="/motoristas">Motorista</a></li>
                            <li><a class="dropdown-item" href="/veiculos_frota">Veículo da Frota</a></li>
                        </ul>
                    </li>
                    
                    <!-- Controles -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarControles" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Controles
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="navbarControles">
                            <li><a class="dropdown-item" href="/controle_locacoes">Locação de Veículos</a></li>
                            <li><a class="dropdown-item" href="/fluxo_veiculos">Fluxo de Veículo</a></li>
                        </ul>
                    </li>
                    
                    <!-- Vistorias -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarVistorias" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Vistorias
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="navbarVistorias">
                            <li><a class="dropdown-item" href="/nova_vistoria">Nova Vistoria Completa</a></li>
                            <li><a class="dropdown-item" href="/nova_vistoria2">Nova Vistoria em Duas Etapas</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="/vistorias">Lista Vistorias</a></li>
                        </ul>
                    </li>
                    
                    <!-- Relatórios -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarRelatorios" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Relatórios
                        </a>
                        <!-- <ul class="dropdown-menu" aria-labelledby="navbarRelatorios">
                            <li><a class="dropdown-item" href="#">Relatório 1</a></li>
                            <li><a class="dropdown-item" href="#">Relatório 2</a></li>
                        </ul> -->
                    </li>
                </ul>
                <!-- Botão Sair -->
                <div class="ms-auto">
                    <button class="btn btn-sm btn-logout" id="btnLogout" onclick="fazerLogout()">Sair</button>
                </div>                
            </div>
        </div>
    </nav>
    
    <div class="container-fluid mt-2">
        <h4 class="mb-3">Fluxo de Veículos</h4>
        
        <!-- GroupBox - Saída de Veículo do dia -->
        <div class="row">
            <div class="col-12">
                <div class="groupbox">
                    <div class="groupbox-header">Saída de veículos do dia (Sem retorno)</div>
                    <div class="groupbox-body lista-grande">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Setor Solicitante</th>
                                        <th>Destino</th>
                                        <th>Veículo</th>
                                        <th>Motorista</th>
                                        <th>Data/Hora Saída</th>
                                        <th>Obs</th>
                                        <th class="sticky-column">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="tabela-saida-sem-retorno-dia">
                                    <!-- Dados carregados via AJAX -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row splitter-row">
            <div class="col-12">
                <div class="splitter" id="splitter1">
                    <div class="splitter-handle">
                        <i class="fas fa-grip-lines"></i>
                    </div>
                </div>
            </div>
        </div>        
        <!-- GroupBox - Retorno de Veículo do dia -->
        <div class="row">
            <div class="col-12">
                <div class="groupbox">
                    <div class="groupbox-header">Retorno de veículos do dia</div>
                    <div class="groupbox-body lista-grande">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Setor Solicitante</th>
                                        <th>Destino</th>
                                        <th>Veículo</th>
                                        <th>Motorista</th>
                                        <th>Data/Hora Saída</th>
                                        <th>Data/Hora Retorno</th>
                                        <th>Obs</th>
                                    </tr>
                                </thead>
                                <tbody id="tabela-retorno-dia">
                                    <!-- Dados carregados via AJAX -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row splitter-row">
            <div class="col-12">
                <div class="splitter" id="splitter2">
                    <div class="splitter-handle">
                        <i class="fas fa-grip-lines"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- GroupBox - Saída de Veículo com retorno pendente -->
        <div class="row">
            <div class="col-12">
                <div class="groupbox">
                    <div class="groupbox-header">Saída de veículos pedentes de retorno</div>
                    <div class="groupbox-body lista-grande">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Setor Solicitante</th>
                                        <th>Destino</th>
                                        <th>Veículo</th>
                                        <th>Motorista</th>
                                        <th>Data/Hora Saída</th>
                                        <th>Obs</th>
                                        <th class="sticky-column">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="tabela-saida-retorno-pendente">
                                    <!-- Dados carregados via AJAX -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Footer (novo, baseado no footer da página de motoristas) -->
    <div class="footer">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <button id="btnNovaSaida" class="btn btn-success me-2">
                        <i class="fas fa-plus-circle"></i> Nova Saída
                    </button>
                    <button id="btnRelatorioAnalitico" class="btn btn-info">
                        <i class="fas fa-file-alt"></i> Relatório Analítico
                    </button>
                    <button id="btnPesquisar" class="btn btn-warning ms-2">
                        <i class="fas fa-search"></i> Pesquisar
                    </button>
                </div>
                <button id="btnVoltar" class="btn btn-secondary" onclick="window.history.back();">
                    <i class="fas fa-arrow-left"></i> Voltar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Nova Saida -->
    <div class="modal fade" id="modalNovaSaida" data-bs-backdrop="static" tabindex="-1" aria-labelledby="modalNovaSaidaLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalNovaSaidaLabel">Nova Saída</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="formNovaSaida" class="row g-3">
                        <div class="col-md-6">
                            <label for="setorSolicitante_saida" class="form-label small">Setor Solicitante</label>
                            <input type="text" class="form-control form-control-sm uppercase" id="setorSolicitante_saida" maxlength="25" required>
                            <div id="sugestoesSetor_saida" class="position-absolute bg-white border shadow-sm" 
                                 style="z-index: 9999; display: none; width: calc(100% - 24px); max-height: 200px; overflow-y: auto;">
                            </div>                             
                        </div>
                        <div class="col-md-6">
                            <label for="destino_saida" class="form-label small">Destino</label>
                            <input type="text" class="form-control form-control-sm uppercase" id="destino_saida" maxlength="25" required>
                            <div id="sugestoesDestino_saida" class="position-absolute bg-white border shadow-sm" 
                                 style="z-index: 9999; display: none; width: calc(100% - 24px); max-height: 200px; overflow-y: auto;">
                            </div>                             
                        </div>
                        <div class="col-md-6">
                            <label for="veiculo_saida" class="form-label small">Veículo</label>
                            <select class="form-select form-select-sm" id="veiculo_saida" required>
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="motorista_saida" class="form-label small">Motorista 
                                <a href="#" id="btnBuscarMotorista" class="ms-2 small text-primary">
                                    <i class="fas fa-search"></i> Buscar Motorista
                                </a>
                            </label>
                            <select class="form-select form-select-sm" id="motorista_saida" required>
                                <option value="">Selecione...</option>
                            </select>
                            <input type="text" class="form-control form-control-sm uppercase" id="motoristanaocad_saida" maxlength="50" style="display: none;">
                        </div>
                        <div class="col-md-4">
                            <label for="datasaida_saida" class="form-label small">Data Saída</label>
                            <input type="date" class="form-control form-control-sm" id="datasaida_saida" required>
                        </div>
                        <div class="col-md-4">
                            <label for="horasaida_saida" class="form-label small">Hora Saída</label>
                            <input type="time" class="form-control form-control-sm" id="horasaida_saida" required>
                        </div>                        
                        <div class="col-md-12">
                            <label for="obs_saida" class="form-label small">Observações</label>
                            <textarea class="form-control form-control-sm" id="obs_saida" rows="2" maxlength="100"></textarea>
                            <div class="text-end">
                                <small><span id="charCount">0</span>/100</small>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger btn-sm" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="button" class="btn btn-success btn-sm" id="btnSalvarSaida">
                        <i class="fas fa-save"></i> Salvar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Buscar Motorista -->
    <div class="modal fade" id="modalBuscarMotorista" data-bs-backdrop="static" tabindex="-1" aria-labelledby="modalBuscarMotoristaLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalBuscarMotoristaLabel">Buscar Motorista</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-3">
                    <div class="row mb-3">
                        <div class="col-md-10">
                            <input type="text" class="form-control form-control-sm" id="pesquisaMotorista" placeholder="Pesquise por matrícula, nome ou setor...">
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-primary btn-sm w-100 d-flex align-items-center justify-content-center" id="btnPesquisarMotorista" style="height: 31px;">
                                <i class="fas fa-search me-1"></i> Pesquisar
                            </button>
                        </div>
                    </div>
                    <div class="table-container" style="max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 4px;">
                        <table class="table table-sm table-striped table-hover mb-0">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th style="position: sticky; top: 0; background-color: #f8f9fa; z-index: 1;">Matrícula</th>
                                    <th style="position: sticky; top: 0; background-color: #f8f9fa; z-index: 1;">Nome</th>
                                    <th style="position: sticky; top: 0; background-color: #f8f9fa; z-index: 1;">Setor</th>
                                    <th style="position: sticky; top: 0; background-color: #f8f9fa; z-index: 1; text-align: center;">Ação</th>
                                </tr>
                            </thead>
                            <tbody id="resultadoPesquisaMotorista">
                                <!-- Resultados serão carregados aqui -->
                            </tbody>
                        </table>
                    </div>
                    <div id="semResultados" class="text-center py-2 d-none">
                        <p class="text-muted mb-0">Nenhum motorista encontrado</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Fechar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Retorno -->
    <div class="modal fade" id="modalRetorno" data-bs-backdrop="static" tabindex="-1" aria-labelledby="modalRetornoLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalRetornoLabel">Retorno de Veículo</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="formRetorno" class="row g-3">
                        <div class="col-md-6">
                            <label for="setorSolicitante_retorno" class="form-label small">Setor Solicitante</label>
                            <input type="text" class="form-control form-control-sm bg-readonly-green" id="setorSolicitante_retorno" readonly>
                        </div>
                        <div class="col-md-6">
                            <label for="destino_retorno" class="form-label small">Destino</label>
                            <input type="text" class="form-control form-control-sm bg-readonly-green" id="destino_retorno" readonly>
                        </div>
                        <div class="col-md-6">
                            <label for="veiculo_retorno" class="form-label small">Veículo</label>
                            <input type="text" class="form-control form-control-sm bg-readonly-green" id="veiculo_retorno" readonly>
                        </div>
                        <div class="col-md-6">
                            <label for="motorista_retorno" class="form-label small">Motorista</label>
                            <input type="text" class="form-control form-control-sm bg-readonly-green" id="motorista_retorno" readonly >
                        </div>
                        <div class="col-md-4">
                            <label for="datasaida_retorno" class="form-label small">Data Saída</label>
                            <input type="date" class="form-control form-control-sm bg-readonly-green" id="datasaida_retorno" readonly>
                        </div>
                        <div class="col-md-4">
                            <label for="horasaida_retorno" class="form-label small">Hora Saída</label>
                            <input type="time" class="form-control form-control-sm bg-readonly-green" id="horasaida_retorno" readonly>
                        </div>

                        <hr>
                        
                        <div class="col-md-4">
                            <label for="data_retorno" class="form-label small">Data Retorno</label>
                            <input type="date" class="form-control form-control-sm" id="data_retorno" required>
                        </div>
                        <div class="col-md-4">
                            <label for="hora_retorno" class="form-label small">Hora Retorno</label>
                            <input type="time" class="form-control form-control-sm" id="hora_retorno" required>
                        </div>
                        <div class="col-md-12">
                            <label for="obs_retorno" class="form-label small">Observações</label>
                            <textarea class="form-control form-control-sm" id="obs_retorno" rows="2" maxlength="100"></textarea>
                            <div class="text-end">
                                <small><span id="charCount2">0</span>/100</small>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger btn-sm" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="button" class="btn btn-success btn-sm" id="btnSalvarRetorno">
                        <i class="fas fa-save"></i> Salvar
                    </button>
                </div>
            </div>
        </div>
    </div>    
    
    <!-- Modal de Sucesso -->
    <div class="modal fade" id="modalSucesso" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">Sucesso</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="mensagemSucesso">
                    <!-- Mensagem será inserida via JavaScript -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Pesquisa -->
    <div class="modal fade" id="modalPesquisa" data-bs-backdrop="static" tabindex="-1" aria-labelledby="modalPesquisaLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="modalPesquisaLabel">Pesquisar Fluxo de Veículos</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="formPesquisa" class="row g-3">
                        <div class="col-md-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="usarPeriodo">
                                <label class="form-check-label" for="usarPeriodo">
                                    Filtrar por período
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6" id="campoDataInicio" style="display: none;">
                            <label for="dataInicio" class="form-label small">Data Início</label>
                            <input type="date" class="form-control form-control-sm" id="dataInicio">
                        </div>
                        <div class="col-md-6" id="campoDataFim" style="display: none;">
                            <label for="dataFim" class="form-label small">Data Fim</label>
                            <input type="date" class="form-control form-control-sm" id="dataFim">
                        </div>
                        <div class="col-md-6">
                            <label for="veiculoPesquisa" class="form-label small">Veículo (opcional)</label>
                            <select class="form-select form-select-sm" id="veiculoPesquisa">
                                <option value="">Todos os veículos</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="motoristaPesquisa" class="form-label small">Motorista (opcional)</label>
                            <select class="form-select form-select-sm" id="motoristaPesquisa">
                                <option value="">Todos os motoristas</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="button" class="btn btn-primary btn-sm" id="btnLimparPesquisa">
                        <i class="fas fa-eraser"></i> Limpar
                    </button>
                    <button type="button" class="btn btn-success btn-sm" id="btnExecutarPesquisa">
                        <i class="fas fa-search"></i> Pesquisar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Resultado da Pesquisa -->
    <div class="modal fade" id="modalResultadoPesquisa" data-bs-backdrop="static" tabindex="-1" aria-labelledby="modalResultadoPesquisaLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title" id="modalResultadoPesquisaLabel">
                        <i class="fas fa-search"></i> Resultado da Pesquisa
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="table-responsive" style="max-height: 70vh;">
                        <table class="table table-sm table-hover mb-0">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th style="position: sticky; top: 0; background-color: #f8f9fa; z-index: 1;">ID</th>
                                    <th style="position: sticky; top: 0; background-color: #f8f9fa; z-index: 1;">Setor Solicitante</th>
                                    <th style="position: sticky; top: 0; background-color: #f8f9fa; z-index: 1;">Destino</th>
                                    <th style="position: sticky; top: 0; background-color: #f8f9fa; z-index: 1;">Veículo</th>
                                    <th style="position: sticky; top: 0; background-color: #f8f9fa; z-index: 1;">Motorista</th>
                                    <th style="position: sticky; top: 0; background-color: #f8f9fa; z-index: 1;">Data/Hora Saída</th>
                                    <th style="position: sticky; top: 0; background-color: #f8f9fa; z-index: 1;">Data/Hora Retorno</th>
                                    <th style="position: sticky; top: 0; background-color: #f8f9fa; z-index: 1;">Obs</th>
                                </tr>
                            </thead>
                            <tbody id="tabela-resultado-pesquisa">
                                <!-- Dados carregados via AJAX -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="me-auto">
                        <small class="text-muted" id="totalResultados">0 resultados encontrados</small>
                    </div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Fechar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ============== HTML DO MODAL DE CARREGAMENTO ============== -->
    <div class="modal fade" id="modalCarregando" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-hidden="true">
         <div class="modal-dialog modal-dialog-centered modal-sm">
             <div class="modal-content">
                 <div class="modal-body text-center p-4">
                     <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                         <span class="visually-hidden">Carregando...</span>
                     </div>
                     <h5>Carregando dados</h5>
                     <p class="mb-0">Por favor aguarde...</p>
                 </div>
             </div>
         </div>
     </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js"></script>
    <script>
        // Variáveis globais
        let motoristasLista = [];
        let veiculosLista = [];
        let fluxoId;
        
        // Declarando as funções no escopo global
        function carregarSaidaSemRetorno() {
            $.ajax({
                url: `/api/fluxo_veiculo_saida_sem_retorno`,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    console.log("Saida de veículo sem retorno do dia carregadas:", data);
                    let html = '';
                    if (data.length === 0) {
                        html = '<tr><td colspan="10" class="text-center">Nenhuma saída pendente de retorno pra esta data</td></tr>';
                    } else {
                        data.forEach(function(itens) {
                            html += `<tr>
                                <td>${itens.id_fluxo}</td>
                                <td>${itens.setor_solicitante}</td>
                                <td>${itens.destino}</td>
                                <td>${itens.veiculo}</td>
                                <td>${itens.nome_motorista}</td>
                                <td>${itens.datahora_saida}</td>
                                <td>${itens.obs}</td>
                                <td class="sticky-column">
                                    <div class="d-flex justify-content-around">
                                        <a href="javascript:void(0)" class="btn btn-sm btn-danger ms-1" title="Devolução" onclick="abrirModalRetorno(${itens.id_fluxo})">
                                            <i class="fa-solid fa-car"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>`;
                        });
                    }
                    $('#tabela-saida-sem-retorno-dia').html(html);
                },
                error: function(xhr, status, error) {
                    console.error("Erro ao carregar locações em trânsito:", error);
                    console.error("Status:", xhr.status);
                    console.error("Resposta:", xhr.responseText);
                    $('#tabela-saida-sem-retorno-dia').html('<tr><td colspan="10" class="text-center text-danger">Erro ao carregar dados</td></tr>');
                }
            });
        }

        function carregarRetornoDia() {
            $.ajax({
                url: `/api/fluxo_veiculo_retorno_dia`,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    console.log("Retorno de veículo do dia carregadas:", data);
                    let html = '';
                    if (data.length === 0) {
                        html = '<tr><td colspan="10" class="text-center">Nenhum retorno diário registrado até o momento</td></tr>';
                    } else {
                        data.forEach(function(itens) {
                            html += `<tr>
                                <td>${itens.id_fluxo}</td>
                                <td>${itens.setor_solicitante}</td>
                                <td>${itens.destino}</td>
                                <td>${itens.veiculo}</td>
                                <td>${itens.nome_motorista}</td>
                                <td>${itens.datahora_saida}</td>
                                <td>${itens.datahora_retorno}</td>
                                <td>${itens.obs || ''}</td>
                            </tr>`;
                        });
                    }
                    $('#tabela-retorno-dia').html(html);
                },
                error: function(xhr, status, error) {
                    console.error("Erro ao carregar locações em trânsito:", error);
                    console.error("Status:", xhr.status);
                    console.error("Resposta:", xhr.responseText);
                    $('#tabela-retorno-dia').html('<tr><td colspan="10" class="text-center text-danger">Erro ao carregar dados</td></tr>');
                }
            });
        }

        function carregarSaidasRetornoPendente() {
            $.ajax({
                url: `/api/fluxo_veiculo_saida_retorno_pendente`,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    console.log("Saida de veículo sem retorno do dia carregadas:", data);
                    let html = '';
                    if (data.length === 0) {
                        html = '<tr><td colspan="10" class="text-center">Nenhuma saída pendente de retorno.</td></tr>';
                    } else {
                        data.forEach(function(itens) {
                            html += `<tr>
                                <td>${itens.id_fluxo}</td>
                                <td>${itens.setor_solicitante}</td>
                                <td>${itens.destino}</td>
                                <td>${itens.veiculo}</td>
                                <td>${itens.nome_motorista}</td>
                                <td>${itens.datahora_saida}</td>
                                <td>${itens.obs}</td>
                                <td class="sticky-column">
                                    <div class="d-flex justify-content-around">
                                        <a href="javascript:void(0)" class="btn btn-sm btn-danger ms-1" title="Devolução" onclick="abrirModalRetorno(${itens.id_fluxo})">
                                            <i class="fa-solid fa-car"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>`;
                        });
                    }
                    $('#tabela-saida-retorno-pendente').html(html);
                },
                error: function(xhr, status, error) {
                    console.error("Erro ao carregar locações em trânsito:", error);
                    console.error("Status:", xhr.status);
                    console.error("Resposta:", xhr.responseText);
                    $('#tabela-saida-retorno-pendente').html('<tr><td colspan="10" class="text-center text-danger">Erro ao carregar dados</td></tr>');
                }
            });
        }

        // Função para mostrar o modal de carregamento
        function mostrarModalCarregando() {
            const modalCarregando = new bootstrap.Modal(document.getElementById('modalCarregando'), {
                backdrop: 'static',
                keyboard: false
            });
            modalCarregando.show();
        }

        // Função para fechar o modal de carregamento
        function fecharModalCarregando() {
            const modalCarregandoEl = document.getElementById('modalCarregando');
            const modalCarregando = bootstrap.Modal.getInstance(modalCarregandoEl);
            if (modalCarregando) {
                modalCarregando.hide();
            }
        }

        // Primeiro, vamos definir a função formatarDataParaInput que está faltando
        function formatarDataParaInput(dataString) {
            // Se a data já estiver no formato YYYY-MM-DD, retorna ela mesma
            if (dataString && dataString.match(/^\d{4}-\d{2}-\d{2}$/)) {
                return dataString;
            }
            
            // Caso contrário, tenta converter a data para o formato adequado
            try {
                const data = new Date(dataString);
                return data.toISOString().split('T')[0];
            } catch (e) {
                console.error("Erro ao formatar data:", e);
                return '';
            }
        }

        // Função para abrir o modal de retorno
        function abrirModalRetorno(idFluxo) {
            // Implementar lógica para carregar os dados do fluxo e abrir o modal
            console.log("Abrindo modal de retorno para ID:", idFluxo);
            // Aqui você faria uma requisição AJAX para buscar os dados do veículo
            // alimenta variavel global
            fluxoId = idFluxo;

            // Primeiro, carregar os dados da locação
            $.ajax({
                url: `/api/fluxo_saida_item/${idFluxo}`,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    console.log("Dados da locação carregados:", data);
                    
                    // Preencher os campos de texto
                    $('#idfluxo').val(idFluxo);
                    $('#setorSolicitante_retorno').val(data.setor_solicitante);
                    $('#destino_retorno').val(data.destino);
                    $('#veiculo_retorno').val(data.veiculo); 
                    $('#motorista_retorno').val(data.nome_motorista);
                    
                    // Tratamento específico para os campos de data e hora
                    if (data.dt_saida) {
                        $('#datasaida_retorno').val(data.dt_saida);
                    }
                    
                    if (data.hora_saida) {
                        // Para campos time, precisamos apenas dos primeiros 5 caracteres (HH:MM)
                        $('#horasaida_retorno').val(data.hora_saida.substring(0, 5));
                    }
                    
                    // Definindo a data e hora atual para os campos de retorno se estiverem vazios
                    $('#data_retorno').val(new Date().toISOString().split('T')[0]);
                    
                    $('#hora_retorno').val(new Date().toTimeString().substring(0, 5));
                    
                    console.log("Campos preenchidos com sucesso");
                },
                error: function(xhr, status, error) {
                    console.error("Erro ao carregar dados da locação:", error);
                    alert("Erro ao carregar dados da locação: " + (xhr.responseJSON?.erro || error));
                    $(self).html('<i class="fas fa-arrow-right-to-bracket"></i>');
                    fecharModalCarregando();
                }
            });

          
            const modalRetorno = new bootstrap.Modal(document.getElementById('modalRetorno'));
            modalRetorno.show();
        }

        // Função para validar o formulário
        function validarFormularioSaida() {
            if (!$('#setorSolicitante_saida').val()) {
                alert("Por favor, selecione o setor solicitante.");
                return false;
            }
            
            if (!$('#destino_saida').val()) {
                alert("Por favor, informe o destino.");
                return false;
            }
            
            if (!$('#veiculo_saida').val()) {
                alert("Por favor, selecione um veículo.");
                return false;
            }
            
            if (!$('#motorista_saida').val()) {
                alert("Por favor, selecione um motorista.");
                return false;
            }
            
            if (!$('#datasaida_saida').val()) {
                alert("Por favor, informe a data de saída.");
                return false;
            }
            
            if (!$('#horasaida_saida').val()) {
                alert("Por favor, informe a hora de saida.");
                return false;
            }
            
            // Verificar se é necessário o nome do motorista não cadastrado
            const idMotorista = $('#motorista_saida').val();
            
            if (idMotorista == 0 || idMotorista === '0') {
                if (!$('#motoristanaocad_saida').val()) {
                    alert("Por favor, informe o nome do motorista.");
                    return false;
                }
            }
                            
            return true;
        }    

        // Função para validar o formulário
        function validarFormularioRetorno() {
            
            if (!$('#data_retorno').val()) {
                alert("Por favor, informe a data de retorno.");
                return false;
            }
            
            if (!$('#hora_retorno').val()) {
                alert("Por favor, informe a hora de retorno.");
                return false;
            }
            
            // Compondo as datas completas com hora
            const dataSaidaStr = $('#datasaida_retorno').val();
            const horaSaidaStr = $('#horasaida_retorno').val();
            
            const dataRetornoStr = $('#data_retorno').val();
            const horaRetornoStr = $('#hora_retorno').val();
            
            // Criando objetos Date com data e hora juntos
            const dataSaidaCompleta = new Date(`${dataSaidaStr}T${horaSaidaStr}`);
            const dataRetornoCompleta = new Date(`${dataRetornoStr}T${horaRetornoStr}`);
            
            // Verificando se o datetime de retorno é anterior ao datetime de saída
            if (dataRetornoCompleta < dataSaidaCompleta) {
                alert("A data/hora de retorno não pode ser anterior à data/hora de saída!");
                return false;
            }

            return true;
        }

        // Carregar lista de processos ao iniciar a página
        $(document).ready(function() {
            // Agora chama as funções depois que o documento estiver pronto
            carregarSaidaSemRetorno();
            carregarRetornoDia();
            carregarSaidasRetornoPendente();

            // Converter para maiúsculo os campos com classe uppercase
            $('.uppercase').on('input', function() {
                $(this).val($(this).val().toUpperCase());
            });

            document.getElementById('motorista_saida').addEventListener('change', function() {
                var selectValue = this.value;
                var inputElement = document.getElementById('motoristanaocad_saida');

                if (selectValue === "0") {
                    inputElement.style.display = 'block';
                } else {
                    inputElement.style.display = 'none';
                }
            });

            // Quando o campo recebe foco, ajusta a largura da lista de sugestões
            $("#setorSolicitante_saida").on("focus", function() {
                const inputWidth = $(this).outerWidth();
                $("#sugestoesSetor_saida").css("width", inputWidth + "px");
            });


            // Quando o campo recebe foco, ajusta a largura da lista de sugestões
            $("#destino_saida").on("focus", function() {
                const inputWidth = $(this).outerWidth();
                $("#sugestoesDestino_saida").css("width", inputWidth + "px");
            });

            // Configuração dos splitters
            function setupSplitters() {
                // Configurar o primeiro splitter (entre grupos superiores e Locações em Trânsito)
                let isDragging1 = false;
                let startY1 = 0;
                let startHeight1 = 0;
                
                $('#splitter1').on('mousedown', function(e) {
                    e.preventDefault();
                    isDragging1 = true;
                    startY1 = e.pageY;
                    
                    // Alturas dos grupos superiores
                    const saidaGroupbox = $('.groupbox').eq(0);
                    startHeight1 = {
                        saidas: saidaGroupbox.find('.groupbox-body').height()
                    };
                    
                    $(document).on('mousemove', function(e) {
                        if (!isDragging1) return;
                        
                        const deltaY = e.pageY - startY1;
                        
                        // Aplicar nova altura aos groupbox superiores
                        saidaGroupbox.find('.groupbox-body').height(Math.max(100, startHeight1.saidas + deltaY));
                    });
                    
                    $(document).on('mouseup', function() {
                        isDragging1 = false;
                        $(document).off('mousemove');
                        $(document).off('mouseup');
                    });
                });
                
                // Configurar o segundo splitter (entre Locações em Trânsito e Locações Finalizadas)
                let isDragging2 = false;
                let startY2 = 0;
                let startHeight2 = 0;
                let startHeightPendente = 0;
                
                $('#splitter2').on('mousedown', function(e) {
                    e.preventDefault();
                    isDragging2 = true;
                    startY2 = e.pageY;
                    
                    // Altura dos grupos relevantes
                    const retornoGroupbox = $('.groupbox').eq(1);
                    const pendenteGroupbox = $('.groupbox').eq(2);
                    
                    startHeight2 = retornoGroupbox.find('.groupbox-body').height();
                    startHeightPendente = pendenteGroupbox.find('.groupbox-body').height();
                    
                    $(document).on('mousemove', function(e) {
                        if (!isDragging2) return;
                        
                        const deltaY = e.pageY - startY2;
                        
                        // Permitir redução significativa - mínimo de apenas 50px
                        const novaAlturaRetorno = Math.max(50, startHeight2 + deltaY);
                        
                        // Aplicar nova altura ao groupbox de Locações em Trânsito
                        retornoGroupbox.find('.groupbox-body').height(novaAlturaRetorno);
                        
                        // Opcionalmente, ajustar o grupo de Locações Finalizadas para compensar
                        // Isso criará um efeito de "push" em vez de apenas redimensionar um grupo
                        pendenteGroupbox.find('.groupbox-body').height(Math.max(50, startHeightPendente - deltaY));
                    });
                    
                    $(document).on('mouseup', function() {
                        isDragging2 = false;
                        $(document).off('mousemove');
                        $(document).off('mouseup');
                    });
                });
                
                // Definir alturas iniciais adequadas para os grupos
                setTimeout(function() {
                    const alturaRetorno = 200; 
                    const alturaPendente = 200; 
                    
                    $('.groupbox').eq(1).find('.groupbox-body').height(alturaRetorno);
                    $('.groupbox').eq(2).find('.groupbox-body').height(alturaPendente);
                }, 100);
            }

            // Chamar a configuração dos splitters quando a página estiver pronta
            setupSplitters();

            // Garantir que os splitters se ajustem quando a janela for redimensionada
            $(window).on('resize', function() {
                // Recalcular dimensões se necessário
            });
            
            // Contador de caracteres para observações
            $('#obs_saida').on('input', function() {
                const caracteres = $(this).val().length;
                $('#charCount').text(caracteres);
            });
            
            $('#obs_retorno').on('input', function() {
                const caracteres = $(this).val().length;
                $('#charCount2').text(caracteres);
            });
            
            // Fechar modal event
            $('#modalNovaSaida').on('hidden.bs.modal', function() {
                // Reativar o footer quando o modal fechar
                $('.footer').removeClass('d-none');
            });
            
            // Abrir modal de busca de motorista
            $('#btnBuscarMotorista').on('click', function(e) {
                e.preventDefault();
                $('#modalBuscarMotorista').modal({
                    backdrop: 'static',
                    keyboard: false
                });
                $('#modalBuscarMotorista').modal('show');
                $('#pesquisaMotorista').val('').focus();
                $('#resultadoPesquisaMotorista').empty();
                $('#semResultados').addClass('d-none');
            });

            // Função para pesquisar motoristas
            function pesquisarMotoristas(nome = '') {
                if (nome.trim() === '') {
                    $('#resultadoPesquisaMotorista').empty();
                    $('#semResultados').addClass('d-none');
                    return;
                }

                $.ajax({
                    url: '/api/busca_motorista',
                    type: 'GET',
                    data: { nome: nome },
                    success: function(response) {
                        $('#resultadoPesquisaMotorista').empty();
                        
                        if (response.length > 0) {
                            $('#semResultados').addClass('d-none');
                            
                            response.forEach(function(motorista) {
                                let linha = `
                                    <tr>
                                        <td>${motorista.matricula}</td>
                                        <td>${motorista.nm_motorista}</td>
                                        <td>${motorista.sigla_setor}</td>
                                        <td class="text-center">
                                            <button type="button" class="btn btn-sm btn-outline-success selecionar-motorista" 
                                                    data-id="${motorista.id_motorista}" 
                                                    data-nome="${motorista.nm_motorista}">
                                                <i class="fas fa-check"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `;
                                $('#resultadoPesquisaMotorista').append(linha);
                            });
                            
                            // Adicionar evento aos botões de seleção
                            $('.selecionar-motorista').on('click', function() {
                                let id = $(this).data('id');
                                let nome = $(this).data('nome');
                                
                                // Verificar se o motorista já existe no select
                                let existeOpcao = false;
                                $('#motorista_saida option').each(function() {
                                    if ($(this).val() == id) {
                                        existeOpcao = true;
                                        return false;
                                    }
                                });
                                
                                // Se não existir, adiciona a opção
                                if (!existeOpcao) {
                                    $('#motorista_saida').append(new Option(nome, id));
                                }
                                
                                // Seleciona o motorista
                                $('#motorista_saida').val(id);
                                
                                // Fecha o modal
                                $('#modalBuscarMotorista').modal('hide');
                            });
                            
                        } else {
                            $('#semResultados').removeClass('d-none');
                        }
                    },
                    error: function(error) {
                        console.error('Erro ao buscar motoristas:', error);
                        alert('Erro ao buscar motoristas. Por favor, tente novamente.');
                    }
                });
            }

            // Evento de clique no botão de pesquisa
            $('#btnPesquisarMotorista').on('click', function() {
                let termoPesquisa = $('#pesquisaMotorista').val().trim();
                pesquisarMotoristas(termoPesquisa);
            });

            // Evento de tecla Enter no campo de pesquisa
            $('#pesquisaMotorista').on('keypress', function(e) {
                if (e.which === 13) {
                    e.preventDefault();
                    let termoPesquisa = $(this).val().trim();
                    pesquisarMotoristas(termoPesquisa);
                }
            });

            // Configurar modal para ser estático (não fechar quando clicar fora)
            $('#modalBuscarMotorista').modal({
                backdrop: 'static',
                keyboard: false
            });

            // Ação do botão Nova Saída
            $('#btnNovaSaida').click(function() {
                console.log("Botão Nova Saída clicado");
                
                // Mostrar modal de carregamento
                mostrarModalCarregando();

                // Esconder o footer quando o modal estiver aberto
                $('.footer').addClass('d-none');
                
                // Resetar o formulário
                $('#formNovaSaida')[0].reset();
                
                // Definir data atual para o campo de data
                const dataAtual = new Date().toISOString().split('T')[0];
                $('#datasaida_saida').val(dataAtual);
                
                // Definir hora atual para o campo de hora
                const horaAtual = new Date().toTimeString().split(' ')[0].substring(0, 5);
                $('#horasaida_saida').val(horaAtual);
                
                // Contador para controlar carregamentos pendentes
                let carregamentosPendentes = 2; // Quantidade de carregamentos assíncronos

                function verificarCarregamentoCompleto() {
                    carregamentosPendentes--;
                    if (carregamentosPendentes <= 0) {
                        // Todos os dados foram carregados
                        fecharModalCarregando();
                        
                        // Abrir o modal principal apenas após todos os dados estarem carregados
                        const modalNovaSaida = new bootstrap.Modal(document.getElementById('modalNovaSaida'));
                        modalNovaSaida.show();
                    }
                }
                
                // Carregar motoristas com callback
                $.ajax({
                    url: '/api/fluxo_lista_motorista',
                    type: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        motoristasLista = data;
                        let html = '<option value="">Selecione...</option>';
                        html += '<option value="0">MOTORISTA NÃO CADASTRADO</option>';
                        data.forEach(function(lista) {
                            html += `<option value="${lista.ID_MOTORISTA}">${lista.NM_MOTORISTA}</option>`;
                        });
                        $('#motorista_saida').html(html);
                        verificarCarregamentoCompleto();
                    },
                    error: function(xhr, status, error) {
                        console.error("Erro ao carregar motoristas:", error);
                        alert("Erro ao carregar lista de motoristas.");
                        verificarCarregamentoCompleto();
                    }
                });
                
                // Carregar veículos com callback
                $.ajax({
                    url: '/api/fluxo_lista_veiculos',
                    type: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        veiculosLista = data;
                        let html = '<option value="">Selecione...</option>';
                        data.forEach(function(lista) {
                            html += `<option value="${lista.ID_VEICULO}">${lista.VEICULO}</option>`;
                        });
                        $('#veiculo_saida').html(html);
                        verificarCarregamentoCompleto();
                    },
                    error: function(xhr, status, error) {
                        console.error("Erro ao carregar veículos:", error);
                        alert("Erro ao carregar lista de veículos.");
                        verificarCarregamentoCompleto();
                    }
                });
            });
            
            // Busca de setores
            $('#setorSolicitante_saida').on('input', function() {
                const termo = $(this).val().trim();
                if (termo.length >= 3) {
                    $.ajax({
                        url: `/api/fluxo_busca_setor?termo=${encodeURIComponent(termo)}`,
                        type: 'GET',
                        dataType: 'json',
                        success: function(data) {
                            let html = '';
                            if (data.length > 0) {
                                data.forEach(function(setores) {
                                    html += `<div class="p-2 border-bottom setor-sugestao" style="cursor: pointer;">${setores}</div>`;
                                });
                                $('#sugestoesSetor_saida').html(html).show();
                                
                                // Adicionar evento de clique às sugestões
                                $('.setor-sugestao').click(function() {
                                    const setorSelecionado = $(this).text();
                                    $('#setorSolicitante_saida').val(setorSelecionado);
                                    $('#sugestoesSetor_saida').hide();
                                });
                            } else {
                                $('#sugestoesSetor_saida').hide();
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error("Erro ao buscar setor:", error);
                            $('#sugestoesSetor_saida').hide();
                        }
                    });
                } else {
                    $('#sugestoesSetor_saida').hide();
                }
            });

            // Adicionar o mesmo comportamento para o campo de destino
            $('#destino_saida').on('input', function() {
                const termo = $(this).val().trim();
                if (termo.length >= 3) {
                    $.ajax({
                        url: `/api/fluxo_busca_destino?termo=${encodeURIComponent(termo)}`,
                        type: 'GET',
                        dataType: 'json',
                        success: function(data) {
                            let html = '';
                            if (data.length > 0) {
                                data.forEach(function(destinos) {
                                    html += `<div class="p-2 border-bottom destino-sugestao" style="cursor: pointer;">${destinos}</div>`;
                                });
                                $('#sugestoesDestino_saida').html(html).show();
                                
                                // Adicionar evento de clique às sugestões
                                $('.destino-sugestao').click(function() {
                                    const destinoSelecionado = $(this).text();
                                    $('#destino_saida').val(destinoSelecionado);
                                    $('#sugestoesDestino_saida').hide();
                                });
                            } else {
                                $('#sugestoesDestino_saida').hide();
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error("Erro ao buscar destino:", error);
                            $('#sugestoesDestino_saida').hide();
                        }
                    });
                } else {
                    $('#sugestoesDestino_saida').hide();
                }
            });

            // Fechar sugestões ao clicar fora
            $(document).click(function(e) {
                if (!$(e.target).closest('#setorSolicitante_saida, #sugestoesSetor_saida').length) {
                    $('#sugestoesSetor_saida').hide();
                }
                if (!$(e.target).closest('#destino_saida, #sugestoesDestino_saida').length) {
                    $('#sugestoesDestino_saida').hide();
                }
            });
            
            // Adicionar evento para o botão Salvar Saída
            $('#btnSalvarSaida').click(function() {
                console.log("Botão Salvar Saída clicado");
                // Validar formulário
                if (!validarFormularioSaida()) {
                    return;
                }                
                
                $(this).prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Salvando...');

                // Preparar dados para envio
                const formData = new FormData();
                formData.append('setorSolicitante_saida', $('#setorSolicitante_saida').val());
                formData.append('destino_saida', $('#destino_saida').val());
                formData.append('veiculo_saida', $('#veiculo_saida').val());
                formData.append('motorista_saida', $('#motorista_saida').val());
                formData.append('motoristanaocad_saida', $('#motoristanaocad_saida').val());
                formData.append('datasaida_saida', $('#datasaida_saida').val());
                formData.append('horasaida_saida', $('#horasaida_saida').val());
                formData.append('obs_saida', $('#obs_saida').val());
            
                // Enviar dados para API
                $.ajax({
                    url: '/api/fluxo_nova_saida',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        console.log("Resposta:", response);
                        
                        // Mostrar mensagem de sucesso
                        let mensagem = "Saída registrada com sucesso!";
                        
                        $('#mensagemSucesso').text(mensagem);
                        
                        // Fechar modal de locação
                        $('#modalNovaSaida').modal('hide');
                        
                        // Mostrar modal de sucesso
                        $('#mensagemSucesso').html("Saída de veículo registrada com sucesso!");
                        const modalSucesso = new bootstrap.Modal(document.getElementById('modalSucesso'));
                        modalSucesso.show();
                        
                        // Reativar o footer quando o modal fechar
                        $('.footer').removeClass('d-none');
                        
                        // Fechar o modal principal
                        const modalNovaSaida = bootstrap.Modal.getInstance(document.getElementById('modalNovaSaida'));
                        if (modalNovaSaida) {
                            modalNovaSaida.hide();
                        }
                        
                        // Recarregar os dados
                        carregarSaidaSemRetorno();


                        // Reset botão salvar
                        $('#btnSalvarSaida').prop('disabled', false).html('<i class="fas fa-save"></i> Salvar');
                    },
                    error: function(xhr, status, error) {
                        console.error("Erro ao salvar saída:", error);
                        console.error("Resposta:", xhr.responseText);
                        
                        let mensagemErro = "Erro ao salvar saída";
                        if (xhr.responseJSON && xhr.responseJSON.mensagem) {
                            mensagemErro += ": " + xhr.responseJSON.mensagem;
                        } else if (xhr.statusText) {
                            mensagemErro += ": " + xhr.statusText;
                        } else {
                            mensagemErro += ": " + error;
                        }
                        
                        alert(mensagemErro);
                        
                        // Reset botão salvar
                        $('#btnSalvarSaida').prop('disabled', false).html('<i class="fas fa-save"></i> Salvar');
                    }
                });

            });

            // Adicionar evento para o botão Salvar retorno
            $('#btnSalvarRetorno').click(function() {
                console.log("Botão Salvar retorno clicado");
                // Validar formulário
                if (!validarFormularioRetorno()) {
                    return;
                }                
                
                $(this).prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Salvando...');

                // Preparar dados para envio
                const formData = new FormData();
                formData.append('data_retorno', $('#data_retorno').val());
                formData.append('hora_retorno', $('#hora_retorno').val());
                formData.append('obs_retorno', $('#obs_retorno').val());
            
                // Enviar dados para API
                $.ajax({
                    url: `/api/fluxo_lanca_retorno/${fluxoId}`,
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        console.log("Resposta:", response);
                        
                        // Mostrar mensagem de sucesso
                        let mensagem = "Retorno registrado com sucesso!";
                        
                        $('#mensagemSucesso').text(mensagem);
                        
                        // Fechar modal de locação
                        $('#modalRetorno').modal('hide');
                        
                        // Mostrar modal de sucesso
                        $('#mensagemSucesso').html("Retorno de veículo registrado com sucesso!");
                        const modalSucesso = new bootstrap.Modal(document.getElementById('modalSucesso'));
                        modalSucesso.show();
                        
                        // Reativar o footer quando o modal fechar
                        $('.footer').removeClass('d-none');
                        
                        // Fechar o modal principal
                        const modalNovaSaida = bootstrap.Modal.getInstance(document.getElementById('modalNovaSaida'));
                        if (modalNovaSaida) {
                            modalNovaSaida.hide();
                        }
                        
                        // Recarregar os dados
                        carregarSaidaSemRetorno();
                        carregarRetornoDia();
                        carregarSaidasRetornoPendente();

                        // Reset botão salvar
                        $('#btnSalvarRetorno').prop('disabled', false).html('<i class="fas fa-save"></i> Salvar');
                    },
                    error: function(xhr, status, error) {
                        console.error("Erro ao salvar retorno:", error);
                        console.error("Resposta:", xhr.responseText);
                        
                        let mensagemErro = "Erro ao salvar retorno";
                        if (xhr.responseJSON && xhr.responseJSON.mensagem) {
                            mensagemErro += ": " + xhr.responseJSON.mensagem;
                        } else if (xhr.statusText) {
                            mensagemErro += ": " + xhr.statusText;
                        } else {
                            mensagemErro += ": " + error;
                        }
                        
                        alert(mensagemErro);
                        
                        // Reset botão salvar
                        $('#btnSalvarRetorno').prop('disabled', false).html('<i class="fas fa-save"></i> Salvar');
                    }
                });
            });

            // Implementação da Pesquisa:
            // Event handler para o botão Pesquisar
            $('#btnPesquisar').click(function() {
                console.log("Botão Pesquisar clicado");
                
                // Mostrar modal de carregamento
                mostrarModalCarregando();
                
                // Limpar formulário
                $('#formPesquisa')[0].reset();
                $('#usarPeriodo').prop('checked', false);
                $('#campoDataInicio, #campoDataFim').hide();
                
                // Contador para controlar carregamentos
                let carregamentosPendentes = 2;

                function verificarCarregamentoPesquisa() {
                    carregamentosPendentes--;
                    if (carregamentosPendentes <= 0) {
                        fecharModalCarregando();
                        const modalPesquisa = new bootstrap.Modal(document.getElementById('modalPesquisa'));
                        modalPesquisa.show();
                    }
                }
                
                // Carregar veículos para pesquisa
                $.ajax({
                    url: '/api/fluxo_lista_veiculos_pesquisa',
                    type: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        let html = '<option value="">Todos os veículos</option>';
                        data.forEach(function(veiculo) {
                            html += `<option value="${veiculo.ID_VEICULO}">${veiculo.VEICULO}</option>`;
                        });
                        $('#veiculoPesquisa').html(html);
                        verificarCarregamentoPesquisa();
                    },
                    error: function(xhr, status, error) {
                        console.error("Erro ao carregar veículos para pesquisa:", error);
                        verificarCarregamentoPesquisa();
                    }
                });
                
                // Carregar motoristas para pesquisa
                $.ajax({
                    url: '/api/fluxo_lista_motoristas_pesquisa',
                    type: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        let html = '<option value="">Todos os motoristas</option>';
                        data.forEach(function(motorista) {
                            html += `<option value="${motorista.ID_MOTORISTA}">${motorista.NM_MOTORISTA}</option>`;
                        });
                        $('#motoristaPesquisa').html(html);
                        verificarCarregamentoPesquisa();
                    },
                    error: function(xhr, status, error) {
                        console.error("Erro ao carregar motoristas para pesquisa:", error);
                        verificarCarregamentoPesquisa();
                    }
                });
            });

            // Controle do checkbox de período (adicionar)
            $('#usarPeriodo').change(function() {
                if ($(this).is(':checked')) {
                    $('#campoDataInicio, #campoDataFim').show();
                    
                    // Definir período padrão (último mês)
                    const dataAtual = new Date();
                    const dataInicio = new Date();
                    dataInicio.setMonth(dataAtual.getMonth() - 1);
                    
                    $('#dataInicio').val(dataInicio.toISOString().split('T')[0]);
                    $('#dataFim').val(dataAtual.toISOString().split('T')[0]);
                } else {
                    $('#campoDataInicio, #campoDataFim').hide();
                    $('#dataInicio, #dataFim').val('');
                }
            });

            // Executar pesquisa
            $('#btnExecutarPesquisa').click(function() {
                // Verificar se pelo menos um filtro foi aplicado
                const usaPeriodo = $('#usarPeriodo').is(':checked');
                const veiculo = $('#veiculoPesquisa').val();
                const motorista = $('#motoristaPesquisa').val();
                
                if (!usaPeriodo && !veiculo && !motorista) {
                    alert("Por favor, selecione pelo menos um filtro de pesquisa.");
                    return;
                }
                
                // Validar período se estiver sendo usado
                if (usaPeriodo) {
                    if (!$('#dataInicio').val() || !$('#dataFim').val()) {
                        alert("Por favor, informe o período completo (data início e fim).");
                        return;
                    }
                    
                    const dataInicio = new Date($('#dataInicio').val());
                    const dataFim = new Date($('#dataFim').val());
                    
                    if (dataFim < dataInicio) {
                        alert("A data fim não pode ser anterior à data início.");
                        return;
                    }
                }
                
                $(this).prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Pesquisando...');
                
                const params = {
                    usarPeriodo: usaPeriodo,
                    dataInicio: usaPeriodo ? $('#dataInicio').val() : '',
                    dataFim: usaPeriodo ? $('#dataFim').val() : '',
                    veiculo: veiculo,
                    motorista: motorista
                };
                
                $.ajax({
                    url: '/api/fluxo_pesquisar',
                    type: 'GET',
                    data: params,
                    dataType: 'json',
                    success: function(data) {
                        console.log("Resultado da pesquisa:", data);
                        let html = '';
                        if (data.length === 0) {
                            html = '<tr><td colspan="8" class="text-center">Nenhum resultado encontrado</td></tr>';
                        } else {
                            data.forEach(function(item) {
                                html += `<tr>
                                    <td>${item.id_fluxo}</td>
                                    <td>${item.setor_solicitante}</td>
                                    <td>${item.destino}</td>
                                    <td>${item.veiculo}</td>
                                    <td>${item.nome_motorista}</td>
                                    <td>${item.datahora_saida}</td>
                                    <td>${item.datahora_retorno || '-'}</td>
                                    <td>${item.obs || ''}</td>
                                </tr>`;
                            });
                        }
                        $('#tabela-resultado-pesquisa').html(html);
                        
                        // Atualizar contador de resultados
                        $('#totalResultados').text(`${data.length} resultado${data.length !== 1 ? 's' : ''} encontrado${data.length !== 1 ? 's' : ''}`);
                        
                        // Fechar modal de pesquisa
                        $('#modalPesquisa').modal('hide');
                        
                        // Ocultar as listas principais
                        $('.container-fluid .row').not('#resultadoPesquisa').hide();
                        
                        // Mostrar modal de resultado
                        const modalResultado = new bootstrap.Modal(document.getElementById('modalResultadoPesquisa'));
                        modalResultado.show();
                        
                        // Reset botão
                        $('#btnExecutarPesquisa').prop('disabled', false).html('<i class="fas fa-search"></i> Pesquisar');
                    },
                    error: function(xhr, status, error) {
                        console.error("Erro ao pesquisar:", error);
                        alert("Erro ao executar pesquisa: " + error);
                        $('#btnExecutarPesquisa').prop('disabled', false).html('<i class="fas fa-search"></i> Pesquisar');
                    }
                });
            });

            // Event handler para quando o modal de resultado for fechado (adicionar)
            $('#modalResultadoPesquisa').on('hidden.bs.modal', function() {
                // Mostrar novamente as listas principais
                $('.container-fluid .row').not('#resultadoPesquisa').show();
            });

            // Limpar pesquisa (substituir a função anterior)
            $('#btnLimparPesquisa').click(function() {
                $('#formPesquisa')[0].reset();
                $('#usarPeriodo').prop('checked', false);
                $('#campoDataInicio, #campoDataFim').hide();
                $('#veiculoPesquisa').val('');
                $('#motoristaPesquisa').val('');
            });

            //// fim pesquisa ///////////

            // Correção automática para SEJEOP -> SEGEOP
            $('#setorSolicitante_saida').on('input', function() {
                let valor = $(this).val().toUpperCase();
                
                // Verificar e corrigir SEJEOP para SEGEOP
                if (valor === 'SEJEOP') {
                    $(this).val('SEGEOP');
                } else if (valor === 'ANEXO') {
                    $(this).val('ANEXO ADM');
                } else if (valor === 'COMU') {
                    $(this).val('CCOM');
                } else if (valor === 'COMUNICACAO') {
                    $(this).val('CCOM');
                }
                
                // Continuar com a lógica de busca existente
                const termo = $(this).val().trim();
                if (termo.length >= 3) {
                    // ... resto do código de busca de setores permanece igual
                }
            });

        });       

        // Função de logout corrigida
        function fazerLogout() {
            const btnLogout = document.getElementById('btnLogout');
            
            // Desabilitar o botão para evitar múltiplos cliques
            btnLogout.disabled = true;
            btnLogout.textContent = 'Saindo...';
            
            // Fazer requisição para o endpoint de logout do backend
            fetch('/logout', {
                method: 'GET',
                credentials: 'same-origin' // Importante para manter os cookies de sessão
            })
            .then(response => {
                // Independente da resposta, limpar o localStorage
                localStorage.removeItem('usuario_logado');
                localStorage.removeItem('usuario_id');
                localStorage.removeItem('usuario_login');
                localStorage.removeItem('usuario_nome');
                localStorage.removeItem('nivel_acesso');
                
                // Redirecionar para a página de login
                window.location.href = '/login';
            })
            .catch(error => {
                console.error('Erro durante logout:', error);
                
                // Mesmo com erro, limpar o localStorage e redirecionar
                localStorage.removeItem('usuario_logado');
                localStorage.removeItem('usuario_id');
                localStorage.removeItem('usuario_login');
                localStorage.removeItem('usuario_nome');
                localStorage.removeItem('nivel_acesso');
                
                // Redirecionar para a página de login
                window.location.href = '/login';
            })
            .finally(() => {
                // Reabilitar o botão (caso algo dê errado)
                btnLogout.disabled = false;
                btnLogout.textContent = 'Sair';
            });
        }
        
    </script>
</body>
</html>
