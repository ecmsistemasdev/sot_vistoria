<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nova Vistoria</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/css/bootstrap.min.css">
    <style>
        .preview-container {
            text-align: center;
            margin-top: 10px;
        }
        .preview-image {
            max-width: 100%;
            max-height: 300px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px;
        }
        .camera-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 10px;
        }
        #video {
            width: 100%;
            max-width: 500px;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: none;
        }
        #canvas {
            display: none;
        }
        .foto-item {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .camera-buttons {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }
        .tipo-vistoria-badge {
            font-size: 1rem;
            padding: 0.5rem 1rem;
            margin-left: 1rem;
        }
        #multi-foto-container {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px dashed #ccc;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        /* Estilos para o controle deslizante de combustível */
        .fuel-slider-container {
            margin: 0;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
            border: 1px solid #ddd;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .fuel-slider-label {
            display: flex;
            align-items: center;
            margin-right: 10px;
            font-weight: bold;
            font-size: 1rem;
        }
        .fuel-slider-value {
            margin-left: 5px;
            font-weight: normal;
        }
        .fuel-slider-content {
            flex: 1;
        }
        .fuel-slider {
            width: 100%;
            margin: 5px 0;
        }
        .fuel-markers {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: #666;
        }
        /* Estilos para as áreas de assinatura */
        .signature-container {
            margin-top: 30px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            background-color: #f9f9f9;
        }
        .signature-pad-container {
            position: relative;
            width: 100%;
            height: 200px;
            margin-top: 10px;
            border: 1px solid #ccc;
            background-color: #fff;
            border-radius: 4px;
        }
        .signature-pad {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
        }
        .signature-buttons {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }
        .signature-preview {
            max-width: 100%;
            max-height: 200px;
            margin-top: 10px;
            display: none;
            border: 1px solid #ddd;
        }
        
        .fixed-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #fff;
            border-top: 1px solid #ddd;
            padding: 15px 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }
        
        .container {
            padding-bottom: 5px;
        }

        .btn-saving {
            pointer-events: none;
            opacity: 0.8;
        }
        
        /* Responsividade para o layout de 4 colunas */
        @media (min-width: 992px) {
            .flex-fields-container {
                display: flex;
                gap: 15px;
                margin-bottom: 20px;
            }
            .flex-field {
                flex: 1;
                margin-bottom: 0;
            }
            .fuel-slider-container {
                margin: 0;
            }
        }
        
        /* Para telas menores */
        @media (max-width: 991px) {
            .flex-field {
                margin-bottom: 15px;
            }
            .fuel-slider-container {
                margin-bottom: 20px;
            }
        }
        
        /* Estilo para a área de fotos geradas */
        .foto-gerada-item {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .foto-preview-container {
            position: relative;
            width: 100%;
            height: 300px;
            margin-bottom: 10px;
            overflow: hidden;
        }
        .foto-preview {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 4px;
        }
        .drawing-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            cursor: crosshair;
        }
        
        /* Estilos para os controles de desenho */
        .drawing-tools {
            margin-top: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .drawing-tools button {
            min-width: 80px;
        }
        .brush-size-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .color-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 1px solid #ccc;
            background-color: #00ff00;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex align-items-center">
            <h5>Nova Vistoria</h5>
            {% if tipo == 'SAIDA' %}
            <span class="badge bg-primary tipo-vistoria-badge">Saída</span>
            {% else %}
            <span class="badge bg-success tipo-vistoria-badge">Devolução</span>
            {% endif %}
        </div>
        
        <form id="vistoriaForm" action="/salvar_vistoria" method="post" enctype="multipart/form-data">
            <input type="hidden" name="tipo" value="{{ tipo }}">
            {% if vistoria_saida_id %}
            <input type="hidden" name="vistoria_saida_id" value="{{ vistoria_saida_id }}">
            {% endif %}
            
            <!-- Layout modificado com 4 colunas em telas maiores -->
            <div class="flex-fields-container">
                <div class="flex-field">
                    <label for="id_motorista" class="form-label">Motorista</label>
                    {% if tipo == 'DEVOLUCAO' %}
                    <input type="hidden" name="id_motorista" value="{{ motorista_id }}">
                    <input type="text" class="form-control" value="{{ motorista_nome }}" readonly>
                    {% else %}
                    <select class="form-select" id="id_motorista" name="id_motorista" required>
                        <option value="">Selecione um motorista</option>
                        {% for motorista in motoristas %}
                        <option value="{{ motorista[0] }}">{{ motorista[1] }}</option>
                        {% endfor %}
                    </select>
                    {% endif %}
                </div>
                
                <div class="flex-field">
                    <label for="id_veiculo" class="form-label">Veículo</label>
                    {% if tipo == 'DEVOLUCAO' %}
                    <input type="hidden" name="id_veiculo" value="{{ veiculo_id }}">
                    <input type="text" class="form-control" value="{{ veiculo_placa }}" readonly>
                    {% else %}
                    <select class="form-select" id="id_veiculo" name="id_veiculo" required>
                        <option value="">Selecione um veículo</option>
                        {% for veiculo in veiculos %}
                        <option value="{{ veiculo[0] }}">{{ veiculo[1] }}</option>
                        {% endfor %}
                    </select>
                    {% endif %}
                </div>
                
                <!-- Novo campo de Hodômetro -->
                <div class="flex-field">
                    <label for="hodometro" class="form-label">Hodômetro (Km)</label>
                    <input type="number" class="form-control" id="hodometro" name="hodometro" min="0" required>
                </div>
                
                <!-- Controle deslizante para o nível de combustível -->
                <div class="flex-field fuel-slider-container">
                    <div class="fuel-slider-label">
                        Combustível: <span class="fuel-slider-value" id="combustivel-valor">100%</span>
                    </div>
                    <div class="fuel-slider-content">
                        <input type="range" class="form-range fuel-slider" id="combustivel" name="combustivel" min="0" max="100" value="100" step="1">
                        <div class="fuel-markers">
                            <span>0</span>
                            <span>1/4</span>
                            <span>1/2</span>
                            <span>3/4</span>
                            <span>1</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="multi-foto-container" class="mb-4">
                <h3>Selecionar Fotos</h3>
                <div class="mb-3">
                    <input type="file" class="form-control" id="multi-foto-input" accept="image/*" multiple required>
                    <div class="form-text">Selecione as fotos para adicionar à vistoria</div>
                </div>
            </div>
            
            <!-- Área onde as fotos selecionadas serão mostradas com campos de detalhamento -->
            <div id="fotos-geradas-container">
                <!-- As fotos com campos de detalhamento serão adicionadas aqui -->
            </div>

            <div class="mb-4">
                <label for="observacoes" class="form-label">Observações Gerais</label>
                <textarea class="form-control" id="observacoes" name="observacoes" maxlength="150" rows="3" placeholder="Digite observações gerais sobre a vistoria (máx. 150 caracteres)"></textarea>
                <div class="form-text"><span id="char-count">0</span>/150 caracteres</div>
            </div>
            
            <div class="camera-container" id="camera-container">
                <video id="video" autoplay></video>
                <canvas id="canvas"></canvas>
                <div class="camera-buttons" id="main-camera-buttons" style="display: none;">
                    <button type="button" class="btn btn-primary" id="capture">Capturar Foto</button>
                    <button type="button" class="btn btn-secondary" id="closeCamera">Fechar Câmera</button>
                </div>
            </div>
            
            <!-- Área de assinatura do usuário -->
            <div class="signature-container">
                <h4>Assinatura Vistoriador</h4>
                <p class="text-muted">Assine usando o dedo ou uma caneta stylus na área abaixo:</p>
                
                <div class="signature-pad-container">
                    <canvas id="signature-pad-usuario" class="signature-pad"></canvas>
                </div>
                
                <input type="hidden" name="assinatura_usuario" id="assinatura-usuario-input">
                
                <div class="signature-buttons">
                    <button type="button" class="btn btn-secondary" id="limpar-assinatura-usuario">Limpar</button>
                </div>
                
                <div class="preview-container">
                    <img id="assinatura-usuario-preview" class="signature-preview">
                </div>
            </div>
            
            <!-- Área de assinatura do motorista -->
            <div class="signature-container">
                <h4>Assinatura do Motorista</h4>
                <p class="text-muted">Peça ao motorista para assinar usando o dedo ou uma caneta stylus na área abaixo:</p>
                
                <div class="signature-pad-container">
                    <canvas id="signature-pad-motorista" class="signature-pad"></canvas>
                </div>
                
                <input type="hidden" name="assinatura_motorista" id="assinatura-motorista-input">
                
                <div class="signature-buttons">
                    <button type="button" class="btn btn-secondary" id="limpar-assinatura-motorista">Limpar</button>
                </div>
                
                <div class="preview-container">
                    <img id="assinatura-motorista-preview" class="signature-preview">
                </div>
            </div>
            <!--
            <div class="mt-4">
                <button type="submit" class="btn btn-primary">Salvar Vistoria</button>
                <a href="/vistorias" class="btn btn-secondary">Cancelar</a>
            </div>
            -->
            <div class="fixed-footer">
                <div class="container">
                    <div class="d-flex justify-content-between align-items-center">
                        <button type="submit" class="btn btn-primary" id="salvar-btn">
                            <span id="btn-text">Salvar Vistoria</span>
                            <span id="spinner-loading" class="spinner-border spinner-border-sm ms-2" role="status" style="display: none;"></span>
                        </button>
                        <a href="/vistorias" class="btn btn-secondary">Cancelar</a>
                    </div>
                </div>
            </div>
            <div style="height: 80px;"></div>            
        </form>
    </div>
    
    <!-- Template para itens de foto gerados automaticamente -->
    <template id="foto-gerada-template">
        <div class="foto-gerada-item">
            <div class="foto-preview-container">
                <img class="foto-preview" src="">
                <canvas class="drawing-canvas"></canvas>
            </div>
            <input type="hidden" class="foto-input" name="fotos[]">
            <input type="hidden" class="drawing-data" name="desenhos[]" value="">
            
            <div class="drawing-tools">
                <div class="brush-size-container">
                    <span>Espessura:</span>
                    <input type="range" class="form-range brush-size" min="1" max="10" value="3" style="width: 100px;">
                </div>
                <div class="color-selector">
                    <span>Cor:</span>
                    <span class="color-indicator" style="background-color: #00ff00;"></span>
                    <select class="form-select form-select-sm color-select" style="width: 130px;">
                        <option value="#00ff00" selected>Verde Fluorescente</option>
                        <option value="#ff0000">Vermelho</option>
                        <option value="#0000ff">Azul</option>
                        <option value="#ffff00">Amarelo</option>
                    </select>
                </div>
                <button type="button" class="btn btn-sm btn-primary habilitar-desenho">Desenhar</button>
                <button type="button" class="btn btn-sm btn-warning limpar-desenho">Limpar Desenho</button>
            </div>
        </div>
    </template>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/1.5.3/signature_pad.min.js"></script>
    <script>
        let videoStream = null;
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const captureButton = document.getElementById('capture');
        const closeButton = document.getElementById('closeCamera');
        let activeDrawingCanvas = null;

        function redimensionarImagem(file, callback) {
            // Criar um objeto FileReader para ler o arquivo de imagem
            const reader = new FileReader();
            
            reader.onload = function(e) {
                // Criar uma imagem para obter as dimensões originais
                const img = new Image();
                
                img.onload = function() {
                    // Calcular as novas dimensões (60% do original)
                    const novaLargura = Math.round(img.width * 0.6);
                    const novaAltura = Math.round(img.height * 0.6);
                    
                    // Criar um canvas para desenhar a imagem redimensionada
                    const canvas = document.createElement('canvas');
                    canvas.width = novaLargura;
                    canvas.height = novaAltura;
                    
                    // Desenhar a imagem redimensionada no canvas
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, novaLargura, novaAltura);
                    
                    // Converter o canvas para um blob com qualidade reduzida
                    canvas.toBlob(function(blob) {
                        // Criar um novo arquivo com o blob
                        const imagemRedimensionada = new File([blob], file.name, {
                            type: 'image/jpeg', // Forçar JPEG para melhor compressão
                            lastModified: new Date().getTime()
                        });
                        
                        // Retornar a imagem redimensionada através do callback
                        callback(imagemRedimensionada);
                    }, 'image/jpeg', 0.85); // Qualidade 85% para melhor equilíbrio tamanho/qualidade
                };
                
                img.src = e.target.result;
            };
            
            // Ler o arquivo como uma URL de dados
            reader.readAsDataURL(file);
        }
        
        let imagensRedimensionadas = [];
        
        
        // Inicializar as áreas de assinatura
        const signaturePadUsuario = new SignaturePad(document.getElementById('signature-pad-usuario'), {
            backgroundColor: 'rgb(255, 255, 255)',
            penColor: 'rgb(0, 0, 0)'
        });
        
        const signaturePadMotorista = new SignaturePad(document.getElementById('signature-pad-motorista'), {
            backgroundColor: 'rgb(255, 255, 255)',
            penColor: 'rgb(0, 0, 0)'
        });
        
        // Botões para limpar assinaturas
        document.getElementById('limpar-assinatura-usuario').addEventListener('click', function() {
            signaturePadUsuario.clear();
            document.getElementById('assinatura-usuario-preview').style.display = 'none';
            document.getElementById('assinatura-usuario-input').value = '';
        });
        
        document.getElementById('limpar-assinatura-motorista').addEventListener('click', function() {
            signaturePadMotorista.clear();
            document.getElementById('assinatura-motorista-preview').style.display = 'none';
            document.getElementById('assinatura-motorista-input').value = '';
        });
        
        // Configurar o controle deslizante de combustível
        const combustivelSlider = document.getElementById('combustivel');
        const combustivelValor = document.getElementById('combustivel-valor');
        
        combustivelSlider.addEventListener('input', function() {
            combustivelValor.textContent = this.value + '%';
        });

        document.getElementById('observacoes').addEventListener('input', function() {
            const charCount = this.value.length;
            document.getElementById('char-count').textContent = charCount;
            
            // Mudar a cor se estiver próximo do limite
            if (charCount > 130) {
                document.getElementById('char-count').style.color = 'red';
            } else {
                document.getElementById('char-count').style.color = '';
            }
        });
        
        // Ajustar tamanho dos pads de assinatura para dispositivos móveis
        document.addEventListener('DOMContentLoaded', function() {
            window.addEventListener('resize', resizeSignaturePads);
            resizeSignaturePads();
            
            // Configurar processamento de múltiplas fotos
            document.getElementById('multi-foto-input').addEventListener('change', function(e) {
                const files = this.files;
                const fotosContainer = document.getElementById('fotos-geradas-container');
                fotosContainer.innerHTML = '';
                
                if (files.length === 0) {
                    return;
                }

                // Limpar o array de imagens redimensionadas
                imagensRedimensionadas = [];
                
                // Contador para acompanhar o progresso de redimensionamento
                let imagensProcessadas = 0;
                
                // Mostrar um indicador de progresso
                const progressIndicator = document.createElement('div');
                progressIndicator.className = 'alert alert-info';
                progressIndicator.textContent = 'Processando imagens...';
                document.querySelector('.container').insertBefore(progressIndicator, fotosContainer);

                // Para cada arquivo selecionado, redimensionar e criar um item
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const fileIndex = i;
                    
                    // Redimensionar a imagem
                    redimensionarImagem(file, function(imagemRedimensionada) {
                        // Armazenar a imagem redimensionada para uso posterior
                        imagensRedimensionadas[fileIndex] = imagemRedimensionada;
                        
                        // Criar item de foto
                        criarItemFotoComDetalhamento(imagemRedimensionada, fotosContainer);
                        
                        // Incrementar contador
                        imagensProcessadas++;
                        
                        // Verificar se todas as imagens foram processadas
                        if (imagensProcessadas === files.length) {
                            // Remover o indicador de progresso
                            progressIndicator.remove();
                        }
                    });
                }
            });
        });
        
        // Função para criar um item de foto com campo de detalhamento e canvas de desenho
        function criarItemFotoComDetalhamento(file, container) {
            const template = document.getElementById('foto-gerada-template');
            const fotoItem = document.importNode(template.content, true).firstElementChild;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                // Definir a imagem preview
                const previewImg = fotoItem.querySelector('.foto-preview');
                previewImg.src = e.target.result;
                
                // Armazenar o arquivo em um atributo de dados no input
                const fotoInput = fotoItem.querySelector('.foto-input');
                fotoInput.setAttribute('data-file', file.name);
                
                // Configurar o canvas de desenho
                const drawingCanvas = fotoItem.querySelector('.drawing-canvas');
                ajustarTamanhoCanvas(previewImg, drawingCanvas);
                
                // Adicionar eventos depois que a imagem carregar completamente
                previewImg.onload = function() {
                    ajustarTamanhoCanvas(previewImg, drawingCanvas);
                };
            }
            
            reader.readAsDataURL(file);
            container.appendChild(fotoItem);
            
            // Configurar botões de desenho
            const habilitarDesenhoBtn = fotoItem.querySelector('.habilitar-desenho');
            const limparDesenhoBtn = fotoItem.querySelector('.limpar-desenho');
            const drawingCanvas = fotoItem.querySelector('.drawing-canvas');
            const drawingDataInput = fotoItem.querySelector('.drawing-data');
            const brushSizeInput = fotoItem.querySelector('.brush-size');
            const colorSelect = fotoItem.querySelector('.color-select');
            const colorIndicator = fotoItem.querySelector('.color-indicator');
            
            // Evento para mudar a cor do desenho
            colorSelect.addEventListener('change', function() {
                const selectedColor = this.value;
                colorIndicator.style.backgroundColor = selectedColor;
            });
            
            habilitarDesenhoBtn.addEventListener('click', function() {
                // Desativar qualquer canvas ativo anterior
                if (activeDrawingCanvas && activeDrawingCanvas !== drawingCanvas) {
                    desativarDesenho(activeDrawingCanvas);
                }
                
                // Ativar o desenho no canvas atual
                ativarDesenho(drawingCanvas, drawingDataInput, brushSizeInput, colorSelect);
                activeDrawingCanvas = drawingCanvas;
                habilitarDesenhoBtn.classList.add('disabled');
                habilitarDesenhoBtn.textContent = 'Desenhando...';
            });
            
            limparDesenhoBtn.addEventListener('click', function() {
                const ctx = drawingCanvas.getContext('2d');
                ctx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
                drawingDataInput.value = '';
                
                if (activeDrawingCanvas === drawingCanvas) {
                    desativarDesenho(drawingCanvas);
                    activeDrawingCanvas = null;
                    habilitarDesenhoBtn.classList.remove('disabled');
                    habilitarDesenhoBtn.textContent = 'Desenhar';
                }
            });
            
            return fotoItem;
        }
        
        // Função para ajustar o tamanho do canvas de desenho para corresponder à imagem
        function ajustarTamanhoCanvas(imgElement, canvasElement) {
            if (!imgElement || !canvasElement) return;
            
            const container = imgElement.parentElement;
            const containerWidth = container.offsetWidth;
            const containerHeight = container.offsetHeight;
            
            // Calcular a proporção da imagem
            const imgWidth = imgElement.naturalWidth || imgElement.width;
            const imgHeight = imgElement.naturalHeight || imgElement.height;
            
            // Definir o tamanho do canvas para corresponder ao tamanho do container
            canvasElement.width = containerWidth;
            canvasElement.height = containerHeight;
        }
        
        // Função para ativar a capacidade de desenho no canvas
        function ativarDesenho(canvas, dataInput, brushSize, colorSelect) {
            const ctx = canvas.getContext('2d');
            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;
            
            // Função para começar a desenhar
            function startDrawing(e) {
                isDrawing = true;
                
                // Obter a posição do mouse/toque relativa ao canvas
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX || e.touches[0].clientX) - rect.left;
                const y = (e.clientY || e.touches[0].clientY) - rect.top;
                
                lastX = x;
                lastY = y;
            }
            
            // Função para desenhar
            function draw(e) {
                if (!isDrawing) return;
                
                // Impedir o comportamento padrão (como rolagem da página em dispositivos móveis)
                e.preventDefault();
                
                // Obter posição atual
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX || e.touches[0].clientX) - rect.left;
                const y = (e.clientY || e.touches[0].clientY) - rect.top;
                
                // Configurar a caneta
                ctx.strokeStyle = colorSelect.value;
                ctx.lineWidth = brushSize.value;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                
                // Desenhar linha
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(x, y);
                ctx.stroke();
                
                lastX = x;
                lastY = y;
                
                // Salvar o desenho no input hidden
                dataInput.value = canvas.toDataURL('image/png');
            }
            
            // Função para parar de desenhar
            function stopDrawing() {
                isDrawing = false;
            }
            
            // Adicionar event listeners para desktop
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // Adicionar event listeners para dispositivos móveis
            canvas.addEventListener('touchstart', startDrawing);
            canvas.addEventListener('touchmove', draw);
            canvas.addEventListener('touchend', stopDrawing);
            
            // Armazenar os event listeners no canvas para poder removê-los depois
            canvas.drawingListeners = {
                mousedown: startDrawing,
                mousemove: draw,
                mouseup: stopDrawing,
                mouseout: stopDrawing,
                touchstart: startDrawing,
                touchmove: draw,
                touchend: stopDrawing
            };
        }
        
        // Função para desativar a capacidade de desenho no canvas
        function desativarDesenho(canvas) {
            if (!canvas.drawingListeners) return;
            
            // Remover todos os event listeners
            canvas.removeEventListener('mousedown', canvas.drawingListeners.mousedown);
            canvas.removeEventListener('mousemove', canvas.drawingListeners.mousemove);
            canvas.removeEventListener('mouseup', canvas.drawingListeners.mouseup);
            canvas.removeEventListener('mouseout', canvas.drawingListeners.mouseout);
            canvas.removeEventListener('touchstart', canvas.drawingListeners.touchstart);
            canvas.removeEventListener('touchmove', canvas.drawingListeners.touchmove);
            canvas.removeEventListener('touchend', canvas.drawingListeners.touchend);
            
            // Limpar a referência aos listeners
            canvas.drawingListeners = null;
            
            // Restaurar o botão de desenho
            const fotoItem = canvas.closest('.foto-gerada-item');
            const habilitarDesenhoBtn = fotoItem.querySelector('.habilitar-desenho');
            habilitarDesenhoBtn.classList.remove('disabled');
            habilitarDesenhoBtn.textContent = 'Desenhar';
        }
        
        function resizeSignaturePads() {
            // Ajusta a altura do canvas para manter a proporção
            const containerWidth = document.querySelector('.signature-pad-container').offsetWidth;
            const ratio = Math.max(0.5, Math.min(1, containerWidth / 500)); // Mantém uma proporção razoável
            
            const height = 200 * ratio;
            
            // Ajusta o tamanho do canvas
            const signaturePads = document.querySelectorAll('.signature-pad');
            signaturePads.forEach(pad => {
                // Salva o conteúdo atual antes de redimensionar
                const currentPad = pad.id === 'signature-pad-usuario' ? signaturePadUsuario : signaturePadMotorista;
                const data = currentPad.toDataURL();
                
                // Ajusta o tamanho do container e do canvas
                pad.parentElement.style.height = `${height}px`;
                
                // Redefine o canvas (isso limpa o conteúdo)
                pad.width = pad.offsetWidth;
                pad.height = pad.offsetHeight;
                
                // Restaura o conteúdo se houver
                if (!currentPad.isEmpty()) {
                    // Restaura a assinatura após um redimensionamento
                    const img = new Image();
                    img.onload = function() {
                        pad.getContext('2d').drawImage(img, 0, 0, pad.width, pad.height);
                    };
                    img.src = data;
                }
            });
            
            // Também ajusta os canvas de desenho
            const fotosContainer = document.getElementById('fotos-geradas-container');
            const fotosItems = fotosContainer.querySelectorAll('.foto-gerada-item');
            fotosItems.forEach(item => {
                const previewImg = item.querySelector('.foto-preview');
                const drawingCanvas = item.querySelector('.drawing-canvas');
                ajustarTamanhoCanvas(previewImg, drawingCanvas);
            });
        }
        
        // Adicionar evento de redimensionamento para ajustar os canvas quando a janela mudar de tamanho
        window.addEventListener('resize', function() {
            resizeSignaturePads();
            
            // Reajustar todos os canvas de desenho
            const drawingCanvases = document.querySelectorAll('.drawing-canvas');
            drawingCanvases.forEach(canvas => {
                const previewImg = canvas.previousElementSibling;
                ajustarTamanhoCanvas(previewImg, canvas);
                
                // Restaurar o desenho após o redimensionamento
                const dataInput = canvas.closest('.foto-gerada-item').querySelector('.drawing-data');
                if (dataInput.value) {
                    const ctx = canvas.getContext('2d');
                    const img = new Image();
                    img.onload = function() {
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    };
                    img.src = dataInput.value;
                }
            });
        });
        
        // Validação do formulário antes de enviar
        document.getElementById('vistoriaForm').addEventListener('submit', function(e) {
            e.preventDefault(); // Impede o envio padrão do formulário
            
            // Verifica se há fotos
            const fotosContainerItens = document.getElementById('fotos-geradas-container').children;
            if (fotosContainerItens.length === 0) {
                alert('É necessário incluir pelo menos uma foto na vistoria.');
                return;
            }
            
            // Verificar as assinaturas
            if (signaturePadUsuario.isEmpty()) {
                alert('É necessário incluir a assinatura do usuário.');
                return;
            }
            
            if (signaturePadMotorista.isEmpty()) {
                alert('É necessário incluir a assinatura do motorista.');
                return;
            }
            
            // Capturar as assinaturas como imagens base64
            const assinaturaUsuarioData = signaturePadUsuario.toDataURL('image/png');
            const assinaturaMotoristaData = signaturePadMotorista.toDataURL('image/png');
            
            // Armazenar nos campos hidden
            document.getElementById('assinatura-usuario-input').value = assinaturaUsuarioData;
            document.getElementById('assinatura-motorista-input').value = assinaturaMotoristaData;
            
            // Mostrar as previews das assinaturas
            const previewUsuario = document.getElementById('assinatura-usuario-preview');
            previewUsuario.src = assinaturaUsuarioData;
            previewUsuario.style.display = 'block';
            
            const previewMotorista = document.getElementById('assinatura-motorista-preview');
            previewMotorista.src = assinaturaMotoristaData;
            previewMotorista.style.display = 'block';
            
            // Criar um FormData para o envio
            const formData = new FormData(this);
            
            // Limpar as entradas de fotos existentes
            const inputsExistentes = formData.getAll('fotos[]');
            inputsExistentes.forEach(() => {
                formData.delete('fotos[]');
            });
            
            // Processar cada item de foto para mesclar o desenho com a imagem
            const fotoItems = document.querySelectorAll('.foto-gerada-item');
            let processedItems = 0;
            let totalItems = fotoItems.length;
            
            // Se não houver fotos, enviar o formulário diretamente
            if (totalItems === 0) {
                enviarFormulario(formData);
                return;
            }
            
            // Para cada foto, mesclar o desenho com a imagem
            fotoItems.forEach(function(item, index) {
                const previewImg = item.querySelector('.foto-preview');
                const drawingCanvas = item.querySelector('.drawing-canvas');
                const drawingData = item.querySelector('.drawing-data').value;
                
                // Usar a imagem redimensionada correspondente
                const originalFile = imagensRedimensionadas[index];
                
                // Verificar se há desenho para mesclar
                if (drawingData) {
                    // Criar um canvas temporário para a mesclagem
                    const tempCanvas = document.createElement('canvas');
                    const tempCtx = tempCanvas.getContext('2d');
                    
                    // Criar uma nova imagem para carregar a imagem original
                    const img = new Image();
                    img.onload = function() {
                        // Definir o tamanho do canvas temporário para o tamanho da imagem redimensionada
                        tempCanvas.width = img.naturalWidth;
                        tempCanvas.height = img.naturalHeight;
                        
                        // Desenhar a imagem no canvas temporário
                        tempCtx.drawImage(img, 0, 0, tempCanvas.width, tempCanvas.height);
                        
                        // Carregar o desenho
                        const drawingImg = new Image();
                        drawingImg.onload = function() {
                            // Desenhar o desenho em cima da imagem
                            tempCtx.drawImage(drawingImg, 0, 0, tempCanvas.width, tempCanvas.height);
                            
                            // Converter o canvas mesclado em um blob
                            tempCanvas.toBlob(function(blob) {
                                // Criar um novo arquivo com o blob
                                const mergedFile = new File([blob], originalFile.name, {
                                    type: 'image/jpeg',
                                    lastModified: new Date().getTime()
                                });
                                
                                // Adicionar o arquivo mesclado ao FormData
                                formData.append('fotos[]', mergedFile);
                                
                                // Incrementar o contador de itens processados
                                processedItems++;
                                
                                // Se todos os itens foram processados, enviar o formulário
                                if (processedItems === totalItems) {
                                    enviarFormulario(formData);
                                }
                            }, 'image/jpeg', 0.85); // Qualidade 85%
                        };
                        drawingImg.src = drawingData;
                    };
                    
                    // Carregar a imagem redimensionada
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(originalFile);
                } else {
                    // Se não houver desenho, adicionar o arquivo redimensionado diretamente
                    formData.append('fotos[]', originalFile);
                    
                    // Incrementar o contador de itens processados
                    processedItems++;
                    
                    // Se todos os itens foram processados, enviar o formulário
                    if (processedItems === totalItems) {
                        enviarFormulario(formData);
                    }
                }
            });
        });
        
        // Função para enviar o formulário com o FormData
        function enviarFormulario(formData) {
            // Mostrar spinner e alterar texto do botão
            const salvarBtn = document.getElementById('salvar-btn');
            const btnText = document.getElementById('btn-text');
            const spinner = document.getElementById('spinner-loading');
            
            // Desativar o botão e mostrar o spinner
            salvarBtn.classList.add('btn-saving');
            btnText.textContent = "Salvando, aguarde...";
            spinner.style.display = "inline-block";
            
            const xhr = new XMLHttpRequest();
            xhr.open('POST', document.getElementById('vistoriaForm').action, true);
            
            xhr.onload = function() {
                if (xhr.status === 200) {
                    window.location.href = '/vistorias';
                } else {
                    // Restaurar o botão em caso de erro
                    salvarBtn.classList.remove('btn-saving');
                    btnText.textContent = "Salvar Vistoria";
                    spinner.style.display = "none";
                    
                    alert('Houve um erro ao salvar a vistoria. Por favor, tente novamente.');
                }
            };
            
            xhr.onerror = function() {
                // Restaurar o botão em caso de erro
                salvarBtn.classList.remove('btn-saving');
                btnText.textContent = "Salvar Vistoria";
                spinner.style.display = "none";
                
                alert('Houve um erro na conexão. Por favor, verifique sua internet e tente novamente.');
            };
            
            xhr.send(formData);
        }

    </script>
</body>
</html>
