<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="static/img/logo_sotweb.jpg">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nova Vistoria</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/css/bootstrap.min.css">
    <style>
        /* 
        body {
            padding-top: 60px; 
        }
        */

        /* Reset b√°sico para garantir que n√£o haja espa√ßamentos indesejados */
        * {
            margin: 0;
            padding: 0px;
            box-sizing: border-box;
        }
        
        html, body {
            margin: 0;
            padding: 10px;
            height: 100%;
            font-size: 14px; /* Reduzido de 16px para 14px */
        }
        
        body {
            padding-bottom: 65px; /* Reduzido de 80px */
            margin: 0;
            overflow-x: hidden;
            background-color: #f8f9fa;
        }       
        /* Menu de navega√ß√£o fixo */
        .fixed-navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1030;
            background-color: #d0e4ff !important;
            padding: 0.2rem 0; /* Reduzido de 0.3rem */
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); /* Sombra mais sutil */
            margin: 0;
        }
        
        .navbar-nav .nav-link {
            padding: 0.25rem 0.5rem; /* Reduzido */
            color: #333 !important;
            font-size: 0.9rem; /* Reduzido */
        }
        
        .navbar-nav .nav-link:hover {
            background-color: rgba(255,255,255,0.3);
            border-radius: 3px;
        }
        
        .nav-item {
            margin-right: 3px; /* Reduzido de 5px */
        }
        
        .dropdown-divider {
            margin: 0.2rem 0; /* Reduzido */
        }
        
        .dropdown-menu {
            font-size: 0.9rem; /* Reduzido */
            padding: 0.3rem 0; /* Reduzido */
        }
        
        .dropdown-item {
            padding: 0.3rem 1rem; /* Reduzido */
        }
        
        .btn-logout {
            color: #333 !important;
            background-color: transparent;
            border: 1px solid rgba(0,0,0,0.3);
            font-size: 0.85rem; /* Reduzido */
            padding: 0.2rem 0.6rem; /* Reduzido */
        }
        
        .btn-logout:hover {
            background-color: rgba(0,0,0,0.1);
            color: #333 !important;
        }        

        /* Responsividade */
        @media (max-width: 768px) {
            body {
                padding-top: 80px; /* Mais espa√ßo para dispositivos m√≥veis */
            }
        }
        /* Fim Menu de navega√ß√£o */

        
        .preview-container {
            text-align: center;
            margin-top: 10px;
        }
        .preview-image {
            max-width: 100%;
            max-height: 300px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px;
        }
        .camera-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 10px;
        }
        #video {
            width: 100%;
            max-width: 500px;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: none;
        }
        #canvas {
            display: none;
        }
        .foto-item {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .camera-buttons {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }
        .tipo-vistoria-badge {
            font-size: 1rem;
            padding: 0.5rem 1rem;
            margin-left: 1rem;
        }
        #multi-foto-container {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px dashed #ccc;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        /* Estilos para o controle deslizante de combust√≠vel */
        .fuel-slider-container {
            margin: 0;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
            border: 1px solid #ddd;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .fuel-slider-label {
            display: flex;
            align-items: center;
            margin-right: 10px;
            font-weight: bold;
            font-size: 1rem;
        }
        .fuel-slider-value {
            margin-left: 5px;
            font-weight: normal;
        }
        .fuel-slider-content {
            flex: 1;
        }
        .fuel-slider {
            width: 100%;
            margin: 5px 0;
        }
        .fuel-markers {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: #666;
        }
        /* Estilos para as √°reas de assinatura */
        .signature-container {
            margin-top: 30px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            background-color: #f9f9f9;
        }
        .signature-pad-container {
            position: relative;
            width: 100%;
            height: 200px;
            margin-top: 10px;
            border: 1px solid #ccc;
            background-color: #fff;
            border-radius: 4px;
        }
        .signature-pad {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
        }
        .signature-buttons {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }
        .signature-preview {
            max-width: 100%;
            max-height: 200px;
            margin-top: 10px;
            display: none;
            border: 1px solid #ddd;
        }
        
        .fixed-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #fff;
            border-top: 1px solid #ddd;
            padding: 15px 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }
        
        .container {
            padding-bottom: 5px;
        }

        .btn-saving {
            pointer-events: none;
            opacity: 0.8;
        }

        
        .flex-fields-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .flex-field {
            flex: 1;
            min-width: 200px;
        }
        
        @media (max-width: 768px) {
            .flex-field {
                flex-basis: 100%;
            }
        }

        /* Responsividade para o layout de 4 colunas */
        @media (min-width: 992px) {
            .flex-fields-container {
                display: flex;
                gap: 15px;
                margin-bottom: 20px;
            }
            .flex-field {
                flex: 1;
                margin-bottom: 0;
            }
            .fuel-slider-container {
                margin: 0;
            }
        }

        /* Para telas menores */
        @media (max-width: 991px) {
            .flex-field {
                margin-bottom: 15px;
            }
            .fuel-slider-container {
                margin-bottom: 20px;
            }
        }
        /* Estilo para a √°rea de fotos geradas */
        .foto-gerada-item {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .foto-preview-container {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        .foto-preview {
            max-width: 100%;
            max-height: 100%;
            display: block;
        }
        .drawing-canvas {
            position: absolute;
           /* pointer-events: none; /* Desativa eventos quando n√£o estiver desenhando */
        }
        /*
        .drawing-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            cursor: crosshair;
        }
        */
        .drawing-canvas.active {
            pointer-events: auto;
        }
        /* Estilos para os controles de desenho */
        .drawing-tools {
            margin-top: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .drawing-tools button {
            min-width: 80px;
        }
        .brush-size-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .color-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 1px solid #ccc;
            background-color: #00ff00;
        }
        .sei-field {
            flex: 1.5; /* D√° mais espa√ßo para este campo em rela√ß√£o aos outros */
            min-width: 280px; /* Garante um m√≠nimo de largura */
        }

        /* Garantir que o campo NumSei tenha largura suficiente */
        #numSei {
            font-family: monospace; /* Usa fonte monoespa√ßada para melhor visualiza√ß√£o da m√°scara */
            letter-spacing: 0.5px; /* Pequeno espa√ßamento entre caracteres */
        }

    </style>
    <script src="{{ url_for('static', filename='js/auth-check.js') }}"></script>
</head>
<body>
    <!-- Menu de navega√ß√£o fixo -->
    <nav class="navbar navbar-expand-lg navbar-light fixed-navbar">
        <div class="container">
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <!-- Cadastros -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarCadastros" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Cadastros
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="navbarCadastros">
                            <li><a class="dropdown-item" href="/motoristas">Motorista</a></li>
                            <li><a class="dropdown-item" href="/veiculos_frota">Ve√≠culo da Frota</a></li>
                        </ul>
                    </li>
                    
                    <!-- Controles -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarControles" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Controles
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="navbarControles">
                            <li><a class="dropdown-item" href="/controle_locacoes">Loca√ß√£o de Ve√≠culos</a></li>
                            <li><a class="dropdown-item" href="/fluxo_veiculos">Fluxo de Ve√≠culo</a></li>
                        </ul>
                    </li>
                    
                    <!-- Vistorias -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarVistorias" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Vistorias
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="navbarVistorias">
                            <li><a class="dropdown-item" href="/nova_vistoria">Nova Vistoria Completa</a></li>
                            <li><a class="dropdown-item" href="/nova_vistoria2">Nova Vistoria em Duas Etapas</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="/vistorias">Lista Vistorias</a></li>
                        </ul>
                    </li>
                    
                    <!-- Agenda SEGEOP -->
                    <li class="nav-item">
                        <a class="nav-link" href="/">
                            üè† In√≠cio
                        </a>
                    </li>
                </ul>
                <!-- Bot√£o Sair -->
                <div class="ms-auto">
                    <button class="btn btn-sm btn-logout" id="btnLogout" onclick="fazerLogout()">Sair</button>
                </div>
                
            </div>
        </div>
    </nav>
    
    <div class="container mt-4">
        <div class="d-flex align-items-center">
            <h3>Nova Vistoria</h3>
            {% if tipo == 'SAIDA' %}
            <span class="badge bg-primary tipo-vistoria-badge">Sa√≠da</span>
            {% else %}
            <span class="badge bg-success tipo-vistoria-badge">Devolu√ß√£o</span>
            {% endif %}
        </div>
        
        <form id="vistoriaForm" action="/salvar_vistoria" method="post" enctype="multipart/form-data">
            <input type="hidden" name="tipo" value="{{ tipo }}">
            {% if vistoria_saida_id %}
            <input type="hidden" name="vistoria_saida_id" value="{{ vistoria_saida_id }}">
            {% endif %}
            
            <!-- Layout modificado com 4 colunas em telas maiores -->
            <div class="flex-fields-container">
                <div class="flex-field">
                    <label for="id_motorista" class="form-label">Motorista</label>
                    {% if tipo == 'DEVOLUCAO' %}
                    <input type="hidden" name="id_motorista" value="{{ motorista_id }}">
                    <input type="text" class="form-control" value="{{ motorista_nome }}" readonly>
                    {% else %}
                    
                    <!-- Checkbox para motorista n√£o cadastrado -->
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="motorista_nao_cadastrado" name="motorista_nao_cadastrado" value="true">
                        <label class="form-check-label" for="motorista_nao_cadastrado">
                            Motorista N√£o Cadastrado
                        </label>
                    </div>
                    
                    <!-- Select de motoristas cadastrados -->
                    <select class="form-select" id="id_motorista" name="id_motorista" required>
                        <option value="">Selecione um motorista</option>
                        {% for motorista in motoristas %}
                        <option value="{{ motorista[0] }}">{{ motorista[1] }}</option>
                        {% endfor %}
                    </select>
                    
                    <!-- Input para nome do motorista n√£o cadastrado (inicialmente oculto) -->
                    <input type="text" 
                           class="form-control mt-2" 
                           id="nc_motorista" 
                           name="nc_motorista" 
                           placeholder="Digite o nome do motorista"
                           style="display: none;"
                           maxlength="100">
                    
                    {% endif %}
                </div>
                
                <div class="flex-field">
                    <label for="id_veiculo" class="form-label">Ve√≠culo</label>
                    {% if tipo == 'DEVOLUCAO' %}
                    <input type="hidden" name="id_veiculo" value="{{ veiculo_id }}">
                    <input type="text" class="form-control" value="{{ veiculo_placa }}" readonly>
                    {% else %}
                    <select class="form-select" id="id_veiculo" name="id_veiculo" required>
                        <option value="">Selecione um ve√≠culo</option>
                        {% for veiculo in veiculos %}
                        <option value="{{ veiculo[0] }}">{{ veiculo[1] }}</option>
                        {% endfor %}
                    </select>
                    {% endif %}
                </div>
                
                <!-- Novo campo de Hod√¥metro -->
                <div class="flex-field">
                    <label for="hodometro" class="form-label">Hod√¥metro (Km)</label>
                    <input type="number" class="form-control" id="hodometro" name="hodometro" min="0" required>
                </div>
                
                <!-- Controle deslizante para o n√≠vel de combust√≠vel -->
                <div class="flex-field fuel-slider-container">
                    <div class="fuel-slider-label">
                        Combust√≠vel: <span class="fuel-slider-value" id="combustivel-valor">100%</span>
                    </div>
                    <div class="fuel-slider-content">
                        <input type="range" class="form-range fuel-slider" id="combustivel" name="combustivel" min="0" max="100" value="100" step="1">
                        <div class="fuel-markers">
                            <span>0</span>
                            <span>1/4</span>
                            <span>1/2</span>
                            <span>3/4</span>
                            <span>1</span>
                        </div>
                    </div>
                </div>
                
                <!-- Novos campos: Data Sa√≠da, Data Retorno e N√∫mero SEI -->
                <div class="flex-fields-container">
                    {% if tipo == 'SAIDA' %}
                    <div class="flex-field">
                        <label for="dataSaida" class="form-label">Data Sa√≠da (Deslocamento)</label>
                        <input type="date" class="form-control" id="dataSaida" value="{{ data_saida }}" name="dataSaida">
                    </div>
                    {% else %}                  
                    <div class="flex-field">
                        <label for="dataSaida" class="form-label">Data Sa√≠da (Deslocamento)</label>
                        <input type="date" class="form-control" id="dataSaida" value="{{ data_saida }}" name="dataSaida" readonly>
                    </div>
                    <div class="flex-field">
                        <label for="dataRetorno" class="form-label">Data Retorno (Desloc.)</label>
                        <input type="date" class="form-control" id="dataRetorno" value="{{ data_retorno }}" name="dataRetorno">
                    </div>
                    {% endif %}
                    <div class="flex-field sei-field">
                        <label for="numSei" class="form-label">N√∫mero SEI</label>
                        <input type="text" class="form-control" id="numSei" name="numSei" value="{{ nu_sei }}" placeholder="0000000-00.0000.0.00.0000">
                    </div>
                </div>

            </div>
            
            <div id="multi-foto-container" class="mb-4">
                <h3>Selecionar Fotos</h3>
                <div class="mb-3">
                    <input type="file" class="form-control" id="multi-foto-input" accept="image/*" multiple required>
                    <div class="form-text">Selecione as fotos para adicionar √† vistoria. (m√°x. 20 fotos)</div>
                </div>
            </div>
            
            <!-- √Årea onde as fotos selecionadas ser√£o mostradas com campos de detalhamento -->
            <div id="fotos-geradas-container">
                <!-- As fotos com campos de detalhamento ser√£o adicionadas aqui -->
            </div>

            <div class="mb-4">
                <label for="observacoes" class="form-label">Observa√ß√µes Gerais</label>
                <textarea class="form-control" id="observacoes" name="observacoes" maxlength="1000" rows="3" placeholder="Digite observa√ß√µes gerais sobre a vistoria (m√°x. 1000 caracteres)"></textarea>
                <div class="form-text"><span id="char-count">0</span>/1000 caracteres</div>
            </div>
            
            <div class="camera-container" id="camera-container">
                <video id="video" autoplay></video>
                <canvas id="canvas"></canvas>
                <div class="camera-buttons" id="main-camera-buttons" style="display: none;">
                    <button type="button" class="btn btn-primary" id="capture">Capturar Foto</button>
                    <button type="button" class="btn btn-secondary" id="closeCamera">Fechar C√¢mera</button>
                </div>
            </div>
            
            <!-- √Årea de assinatura do usu√°rio -->
            <div class="signature-container">
                <h4>Assinatura Vistoriador</h4>
                <p class="text-muted">Assine usando o dedo ou uma caneta stylus na √°rea abaixo:</p>
                
                <div class="signature-pad-container">
                    <canvas id="signature-pad-usuario" class="signature-pad"></canvas>
                </div>
                
                <input type="hidden" name="assinatura_usuario" id="assinatura-usuario-input">
                
                <div class="signature-buttons">
                    <button type="button" class="btn btn-secondary" id="limpar-assinatura-usuario">Limpar</button>
                </div>
                
                <div class="preview-container">
                    <img id="assinatura-usuario-preview" class="signature-preview">
                </div>
            </div>
            
            <!-- √Årea de assinatura do motorista -->
            <div class="signature-container">
                <h4>Assinatura do Motorista</h4>
                <p class="text-muted">Pe√ßa ao motorista para assinar usando o dedo ou uma caneta stylus na √°rea abaixo:</p>
                
                <div class="signature-pad-container">
                    <canvas id="signature-pad-motorista" class="signature-pad"></canvas>
                </div>
                
                <input type="hidden" name="assinatura_motorista" id="assinatura-motorista-input">
                
                <div class="signature-buttons">
                    <button type="button" class="btn btn-secondary" id="limpar-assinatura-motorista">Limpar</button>
                </div>
                
                <div class="preview-container">
                    <img id="assinatura-motorista-preview" class="signature-preview">
                </div>
            </div>
            <div class="fixed-footer">
                <div class="container">
                    <div class="d-flex justify-content-between align-items-center">
                        <button type="submit" class="btn btn-primary" id="salvar-btn">
                            <span id="btn-text">Salvar Vistoria</span>
                            <span id="spinner-loading" class="spinner-border spinner-border-sm ms-2" role="status" style="display: none;"></span>
                        </button>
                        <button id="btnVoltar" class="btn btn-secondary" onclick="window.history.back();">
                            <i class="fas fa-arrow-left"></i> Voltar
                        </button>
                    </div>
                </div>
            </div>
            <div style="height: 80px;"></div>            
        </form>
    </div>
    
    <!-- Template para itens de foto gerados automaticamente -->
    <template id="foto-gerada-template">
        <div class="foto-gerada-item">
            <div class="foto-preview-container">
                <img class="foto-preview" src="">
                <canvas class="drawing-canvas"></canvas>
            </div>
            <input type="hidden" class="foto-input" name="fotos[]">
            <input type="hidden" class="drawing-data" name="desenhos[]" value="">
            
            <div class="drawing-tools">
                <div class="brush-size-container">
                    <span>Espessura:</span>
                    <input type="range" class="form-range brush-size" min="1" max="10" value="3" style="width: 100px;">
                </div>
                <div class="color-selector">
                    <span>Cor:</span>
                    <span class="color-indicator" style="background-color: #00ff00;"></span>
                    <select class="form-select form-select-sm color-select" style="width: 130px;">
                        <option value="#00ff00" selected>Verde Fluorescente</option>
                        <option value="#ff0000">Vermelho</option>
                        <option value="#0000ff">Azul</option>
                        <option value="#ffff00">Amarelo</option>
                    </select>
                </div>
                <button type="button" class="btn btn-sm btn-primary habilitar-desenho">Desenhar</button>
                <button type="button" class="btn btn-sm btn-warning limpar-desenho">Limpar Desenho</button>
            </div>
        </div>
    </template>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/1.5.3/signature_pad.min.js"></script>
    <script>
        let videoStream = null;
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const captureButton = document.getElementById('capture');
        const closeButton = document.getElementById('closeCamera');
        let activeDrawingCanvas = null;
        let signaturePadUsuario = null;
        let signaturePadMotorista = null;

        function redimensionarImagem(file, callback) {
            // Criar um objeto FileReader para ler o arquivo de imagem
            const reader = new FileReader();
            
            reader.onload = function(e) {
                // Criar uma imagem para obter as dimens√µes originais
                const img = new Image();
                
                img.onload = function() {
                    // Calcular as novas dimens√µes (30% do original)
                    const novaLargura = Math.round(img.width * 0.3);
                    const novaAltura = Math.round(img.height * 0.3);
                    
                    // Criar um canvas para desenhar a imagem redimensionada
                    const canvas = document.createElement('canvas');
                    canvas.width = novaLargura;
                    canvas.height = novaAltura;
                    
                    // Desenhar a imagem redimensionada no canvas
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, novaLargura, novaAltura);
                    
                    // Converter o canvas para um blob com qualidade reduzida
                    canvas.toBlob(function(blob) {
                        // Criar um novo arquivo com o blob
                        const imagemRedimensionada = new File([blob], file.name, {
                            type: 'image/jpeg', // For√ßar JPEG para melhor compress√£o
                            lastModified: new Date().getTime()
                        });
                        
                        // Retornar a imagem redimensionada atrav√©s do callback
                        callback(imagemRedimensionada);
                    }, 'image/jpeg', 0.75); // Qualidade 75% para melhor equil√≠brio tamanho/qualidade
                };
                
                img.src = e.target.result;
            };
            
            // Ler o arquivo como uma URL de dados
            reader.readAsDataURL(file);
        }

        // Array para armazenar as imagens redimensionadas
        let imagensRedimensionadas = [];

        // Fun√ß√£o para salvar o estado atual das assinaturas
        function salvarEstadoAssinaturas() {
            if (signaturePadUsuario && !signaturePadUsuario.isEmpty()) {
                const assinaturaUsuarioData = signaturePadUsuario.toDataURL('image/png');
                document.getElementById('assinatura-usuario-input').value = assinaturaUsuarioData;
                
                // Mostrar preview
                const previewUsuario = document.getElementById('assinatura-usuario-preview');
                previewUsuario.src = assinaturaUsuarioData;
                previewUsuario.style.display = 'none';  //'block';
            }
            
            if (signaturePadMotorista && !signaturePadMotorista.isEmpty()) {
                const assinaturaMotoristaData = signaturePadMotorista.toDataURL('image/png');
                document.getElementById('assinatura-motorista-input').value = assinaturaMotoristaData;
                
                // Mostrar preview
                const previewMotorista = document.getElementById('assinatura-motorista-preview');
                previewMotorista.src = assinaturaMotoristaData;
                previewMotorista.style.display = 'none';  //'block';
            }
        }                
        
        // Fun√ß√£o para processar cada item de foto para manter o desenho ap√≥s a rolagem
        function processarItensDesenho() {
            const fotoItems = document.querySelectorAll('.foto-gerada-item');
            
            fotoItems.forEach(function(item) {
                const drawingCanvas = item.querySelector('.drawing-canvas');
                const drawingData = item.querySelector('.drawing-data').value;
                
                if (drawingData && drawingCanvas) {
                    // Restaurar o desenho
                    const img = new Image();
                    img.onload = function() {
                        const ctx = drawingCanvas.getContext('2d');
                        ctx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
                        ctx.drawImage(img, 0, 0, drawingCanvas.width, drawingCanvas.height);
                    };
                    img.src = drawingData;
                }
            });
        }

        // Adicionar event listener para processar itens de desenho ap√≥s rolagem
        window.addEventListener('scroll', function() {
            // Usar debounce para n√£o chamar muitas vezes durante rolagem
            clearTimeout(window.scrollTimer);
            window.scrollTimer = setTimeout(function() {
                processarItensDesenho();
            }, 200);
        }, { passive: true });        
        
        // Ajustes para o canvas de assinatura
        function inicializarAssinaturas() {
            // Inicializar as √°reas de assinatura apenas uma vez
            if (typeof SignaturePad !== 'undefined' && !signaturePadUsuario && !signaturePadMotorista) {
                const padUsuario = document.getElementById('signature-pad-usuario');
                const padMotorista = document.getElementById('signature-pad-motorista');
                
                if (padUsuario && padMotorista) {
                    signaturePadUsuario = new SignaturePad(padUsuario, {
                        backgroundColor: 'rgb(255, 255, 255)',
                        penColor: 'rgb(0, 0, 0)'
                    });
                    
                    signaturePadMotorista = new SignaturePad(padMotorista, {
                        backgroundColor: 'rgb(255, 255, 255)',
                        penColor: 'rgb(0, 0, 0)'
                    });
                    
                    // Bot√µes para limpar assinaturas
                    document.getElementById('limpar-assinatura-usuario').addEventListener('click', function() {
                        signaturePadUsuario.clear();
                        document.getElementById('assinatura-usuario-preview').style.display = 'none';
                        document.getElementById('assinatura-usuario-input').value = '';
                    });
                    
                    document.getElementById('limpar-assinatura-motorista').addEventListener('click', function() {
                        signaturePadMotorista.clear();
                        document.getElementById('assinatura-motorista-preview').style.display = 'none';
                        document.getElementById('assinatura-motorista-input').value = '';
                    });
                    
                    // Verificar e salvar o estado das assinaturas quando o usu√°rio interage com elas
                    padUsuario.addEventListener('mouseup', salvarEstadoAssinaturas);
                    padUsuario.addEventListener('touchend', salvarEstadoAssinaturas, { passive: false });
                    padMotorista.addEventListener('mouseup', salvarEstadoAssinaturas);
                    padMotorista.addEventListener('touchend', salvarEstadoAssinaturas, { passive: false });
                    
                    // Impedir o comportamento padr√£o para evitar a rolagem durante o desenho
                    padUsuario.addEventListener('touchmove', function(e) { e.preventDefault(); }, { passive: false });
                    padMotorista.addEventListener('touchmove', function(e) { e.preventDefault(); }, { passive: false });
                    
                    // Salvar assinaturas tamb√©m nos eventos de scroll
                    window.addEventListener('scroll', salvarEstadoAssinaturas, { passive: true });
                }
            }
            
            // Ajustar tamanho dos pads de assinatura
            resizeSignaturePads();
            
            // Adicionar evento de redimensionamento
            window.addEventListener('resize', resizeSignaturePads);
        }        
        
        // Event listener para o input de m√∫ltiplas fotos
        document.addEventListener('DOMContentLoaded', function() {
            const multiPhotoInput = document.getElementById('multi-foto-input');
            
            if (multiPhotoInput) {
                // Limitar para 20 arquivos
                multiPhotoInput.setAttribute('max', '20');

                multiPhotoInput.addEventListener('change', function(e) {
                    console.log("File input change detected, files selected:", this.files.length);
                    
                    const files = this.files;
                    const fotosContainer = document.getElementById('fotos-geradas-container');
                    
                    // Verificar se o usu√°rio selecionou mais de 20 fotos
                    if (files.length > 20) {
                        alert('Voc√™ s√≥ pode selecionar at√© 20 fotos. Por favor, tente novamente.');
                        this.value = ''; // Limpar a sele√ß√£o
                        return;
                    }

                    // Clear the container
                    fotosContainer.innerHTML = '';
                    
                    if (files.length === 0) {
                        console.log("No files selected");
                        return;
                    }

                    // Add a simple loading indicator
                    const loadingIndicator = document.createElement('div');
                    loadingIndicator.className = 'alert alert-info';
                    loadingIndicator.textContent = 'Processando imagens...';
                    fotosContainer.appendChild(loadingIndicator);

                    // Clear the array of resized images
                    imagensRedimensionadas = [];
                    
                    // Process each file
                    let processedCount = 0;
                    
                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];
                        const fileIndex = i;
                        
                        console.log("Processing file:", file.name);
                        
                        // Create a temporary preview while processing
                        const tempPreview = document.createElement('div');
                        tempPreview.className = 'temp-preview';
                        tempPreview.textContent = `Processando: ${file.name}`;
                        fotosContainer.appendChild(tempPreview);
                        
                        // Process the image
                        processImage(file, fileIndex, function(processedImage) {
                            // Remove the temporary preview
                            if (tempPreview && tempPreview.parentNode) {
                                tempPreview.parentNode.removeChild(tempPreview);
                            }
                            
                            // Store the processed image
                            imagensRedimensionadas[fileIndex] = processedImage;
                            
                            // Create the photo item
                            criarItemFotoComDetalhamento(processedImage, fotosContainer);
                            
                            // Update processed count
                            processedCount++;
                            
                            // Check if all images are processed
                            if (processedCount === files.length) {
                                // Remove loading indicator
                                if (loadingIndicator && loadingIndicator.parentNode) {
                                    loadingIndicator.parentNode.removeChild(loadingIndicator);
                                }
                                console.log("All images processed successfully");
                            }
                        });
                    }
                });
            } else {
                console.error("File input element not found!");
            }
            
            // Initialize other components
            inicializarAssinaturas();
            configurarControleDeslizanteCombustivel();
            configurarObservacoes();
            configurarCamposDataSeI();
            configurarFormulario();
            configurarMotoristaNC();

            // Adicionar event listener para touchstart em todo o documento
            document.addEventListener('touchstart', function(e) {
                // Esta √© apenas uma fun√ß√£o vazia para garantir que o navegador
                // preste aten√ß√£o aos nossos event listeners de touchmove
            }, { passive: false });
                        
        });

        // Simplified image processing function for better reliability
        function processImage(file, index, callback) {
            console.log("Processing image:", file.name);
            
            // Create a FileReader
            const reader = new FileReader();
            
            reader.onload = function(e) {
                // Create an image to get dimensions
                const img = new Image();
                
                img.onload = function() {
                    try {
                        // Step 1: Rotate image if height > width
                        let processedWidth = img.width;
                        let processedHeight = img.height;
                        let canvas = document.createElement('canvas');
                        let ctx = canvas.getContext('2d');
                        
                        // Check and rotate if needed
                        if (img.height > img.width) {
                            canvas.width = img.height;
                            canvas.height = img.width;
                            
                            // Rotate 90 degrees
                            ctx.translate(img.height, 0);
                            ctx.rotate(Math.PI / 2);
                            ctx.drawImage(img, 0, 0);
                            
                            // Swap width and height
                            processedWidth = img.height;
                            processedHeight = img.width;
                        } else {
                            canvas.width = img.width;
                            canvas.height = img.height;
                            ctx.drawImage(img, 0, 0);
                        }
                        
                        // Step 2: Crop to 4:3 aspect ratio
                        const targetAspectRatio = 4 / 3;
                        let finalCanvas = document.createElement('canvas');
                        let finalCtx = finalCanvas.getContext('2d');
                        
                        if (processedWidth / processedHeight > targetAspectRatio) {
                            // Width is too wide, crop width
                            const targetWidth = processedHeight * targetAspectRatio;
                            const cropX = (processedWidth - targetWidth) / 2;
                            
                            finalCanvas.width = targetWidth;
                            finalCanvas.height = processedHeight;
                            
                            finalCtx.drawImage(
                                canvas, 
                                cropX, 0, targetWidth, processedHeight,
                                0, 0, targetWidth, processedHeight
                            );
                        } else {
                            // Height is too tall, crop height
                            const targetHeight = processedWidth / targetAspectRatio;
                            const cropY = (processedHeight - targetHeight) / 2;
                            
                            finalCanvas.width = processedWidth;
                            finalCanvas.height = targetHeight;
                            
                            finalCtx.drawImage(
                                canvas, 
                                0, cropY, processedWidth, targetHeight,
                                0, 0, processedWidth, targetHeight
                            );
                        }
                        
                        // Convert to blob with reduced quality
                        finalCanvas.toBlob(function(blob) {
                            if (!blob) {
                                console.error("Failed to create blob for image");
                                callback(file);
                                return;
                            }
                            
                            // Create a new file with the blob
                            const processedImage = new File([blob], file.name, {
                                type: 'image/jpeg',
                                lastModified: new Date().getTime()
                            });
                            
                            console.log("Image processed successfully:", file.name);
                            callback(processedImage);
                            
                        }, 'image/jpeg', 0.75);
                        
                    } catch (error) {
                        console.error("Error processing image:", error);
                        callback(file);
                    }
                };
                
                img.onerror = function() {
                    console.error("Error loading image:", file.name);
                    callback(file);
                };
                
                img.src = e.target.result;
            };
            
            reader.onerror = function() {
                console.error("Error reading file:", file.name);
                callback(file);
            };
            
            // Read the file
            reader.readAsDataURL(file);
        }

        // Configurar o controle deslizante de combust√≠vel
        function configurarControleDeslizanteCombustivel() {
            const combustivelSlider = document.getElementById('combustivel');
            const combustivelValor = document.getElementById('combustivel-valor');
            
            if (combustivelSlider && combustivelValor) {
                combustivelSlider.addEventListener('input', function() {
                    combustivelValor.textContent = this.value + '%';
                });
            }
        }

        // Configurar campo de observa√ß√µes
        function configurarObservacoes() {
            const observacoes = document.getElementById('observacoes');
            if (observacoes) {
                observacoes.addEventListener('input', function() {
                    const charCount = this.value.length;
                    document.getElementById('char-count').textContent = charCount;
                    
                    // Mudar a cor se estiver pr√≥ximo do limite
                    if (charCount > 980) {
                        document.getElementById('char-count').style.color = 'red';
                    } else {
                        document.getElementById('char-count').style.color = '';
                    }
                });
            }
        }

        // Configurar campos de data e m√°scara do SEI
        function configurarCamposDataSeI() {
            // Definir data atual como padr√£o para os campos de data
            const hoje = new Date();
            const dataFormatada = hoje.toISOString().split('T')[0]; // Formato YYYY-MM-DD
            
            const dataSaida = document.getElementById('dataSaida');
            const dataRetorno = document.getElementById('dataRetorno');
            
            //if (dataSaida) dataSaida.value = dataFormatada;
            //if (dataRetorno) dataRetorno.value = dataFormatada;
            
            // Configurar valida√ß√£o de data de retorno
            if (dataRetorno && dataSaida) {
                dataRetorno.addEventListener('change', function() {
                    if (this.value < dataSaida.value) {
                        alert('A data de retorno n√£o pode ser anterior √† data de sa√≠da!');
                        this.value = dataSaida.value;
                    }
                });
                
                dataSaida.addEventListener('change', function() {
                    if (dataRetorno.value < this.value) {
                        dataRetorno.value = this.value;
                    }
                });
            }
            
            // Configurar m√°scara para o campo N√∫mero SEI
            const numSei = document.getElementById('numSei');
            if (numSei) {
                numSei.addEventListener('input', function(e) {
                    let valor = this.value.replace(/\D/g, ''); // Remove caracteres n√£o num√©ricos
                    
                    if (valor.length > 0) {
                        // Aplicar a m√°scara 0000000-00.0000.0.00.0000
                        let formatado = '';
                        
                        // Adicionar os primeiros 7 d√≠gitos
                        formatado += valor.substring(0, Math.min(7, valor.length));
                        
                        // Adicionar o h√≠fen ap√≥s os primeiros 7 d√≠gitos
                        if (valor.length > 7) {
                            formatado += '-';
                            formatado += valor.substring(7, Math.min(9, valor.length));
                        }
                        
                        // Adicionar o primeiro ponto
                        if (valor.length > 9) {
                            formatado += '.';
                            formatado += valor.substring(9, Math.min(13, valor.length));
                        }
                        
                        // Adicionar o segundo ponto
                        if (valor.length > 13) {
                            formatado += '.';
                            formatado += valor.substring(13, Math.min(14, valor.length));
                        }
                        
                        // Adicionar o terceiro ponto
                        if (valor.length > 14) {
                            formatado += '.';
                            formatado += valor.substring(14, Math.min(16, valor.length));
                        }
                        
                        // Adicionar o quarto ponto
                        if (valor.length > 16) {
                            formatado += '.';
                            formatado += valor.substring(16, Math.min(20, valor.length));
                        }
                        
                        this.value = formatado;
                    }
                });
                
                // Adicionar placeholder como exemplo
                numSei.setAttribute('placeholder', '0000000-00.0000.0.00.0000');
            }
        }

        // Configurar envio do formul√°rio
        function configurarFormulario() {
            const form = document.getElementById('vistoriaForm');
            if (form) {
                form.addEventListener('submit', enviarVistoria);
            }
        }

        // Configurar comportamento do checkbox de motorista n√£o cadastrado
        function configurarMotoristaNC() {
            const checkbox = document.getElementById('motorista_nao_cadastrado');
            const selectMotorista = document.getElementById('id_motorista');
            const inputNC = document.getElementById('nc_motorista');
            
            if (checkbox && selectMotorista && inputNC) {
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        // Desabilitar select e torn√°-lo n√£o obrigat√≥rio
                        selectMotorista.disabled = true;
                        selectMotorista.required = false;
                        selectMotorista.value = '';
                        
                        // Mostrar e tornar obrigat√≥rio o input de nome
                        inputNC.style.display = 'block';
                        inputNC.required = true;
                        inputNC.focus();
                    } else {
                        // Habilitar select e torn√°-lo obrigat√≥rio
                        selectMotorista.disabled = false;
                        selectMotorista.required = true;
                        
                        // Ocultar e tornar n√£o obrigat√≥rio o input de nome
                        inputNC.style.display = 'none';
                        inputNC.required = false;
                        inputNC.value = '';
                    }
                });
            }
        }        

        // Capturar assinaturas para envio
        function capturarAssinaturas() {
            // Usar os valores j√° salvos nos inputs
            const assinaturaUsuarioData = document.getElementById('assinatura-usuario-input').value;
            const assinaturaMotoristaData = document.getElementById('assinatura-motorista-input').value;
            
            // Verificar se est√£o vazios e tentar capturar novamente se necess√°rio
            if (!assinaturaUsuarioData && signaturePadUsuario && !signaturePadUsuario.isEmpty()) {
                document.getElementById('assinatura-usuario-input').value = signaturePadUsuario.toDataURL('image/png');
            }
            
            if (!assinaturaMotoristaData && signaturePadMotorista && !signaturePadMotorista.isEmpty()) {
                document.getElementById('assinatura-motorista-input').value = signaturePadMotorista.toDataURL('image/png');
            }
            
            // Mostrar as previews das assinaturas
            if (document.getElementById('assinatura-usuario-input').value) {
                const previewUsuario = document.getElementById('assinatura-usuario-preview');
                previewUsuario.src = document.getElementById('assinatura-usuario-input').value;
                previewUsuario.style.display = 'none'; //'block';
            }
            
            if (document.getElementById('assinatura-motorista-input').value) {
                const previewMotorista = document.getElementById('assinatura-motorista-preview');
                previewMotorista.src = document.getElementById('assinatura-motorista-input').value;
                previewMotorista.style.display = 'none'; //'block';
            }
        }

        // Processar fotos para envio
        function processarFotosParaEnvio(formData) {
            // Limpar as entradas de fotos existentes
            const inputsExistentes = formData.getAll('fotos[]');
            inputsExistentes.forEach(() => {
                formData.delete('fotos[]');
            });
            
            // Processar cada item de foto para mesclar o desenho com a imagem
            const fotoItems = document.querySelectorAll('.foto-gerada-item');
            let processedItems = 0;
            let totalItems = fotoItems.length;
            
            // Se n√£o houver fotos, enviar o formul√°rio diretamente
            if (totalItems === 0) {
                enviarFormulario(formData);
                return;
            }
            
            // Array para armazenar as imagens processadas na ordem correta
            const processedImages = new Array(totalItems);
            
            // Para cada foto, mesclar o desenho com a imagem
            fotoItems.forEach(function(item, index) {
                const previewImg = item.querySelector('.foto-preview');
                const drawingCanvas = item.querySelector('.drawing-canvas');
                const drawingData = item.querySelector('.drawing-data').value;
                

                // Important: Get the file name from the data attribute 
                const fileName = item.querySelector('.foto-input').getAttribute('data-file');

                // Find the original file by name, not by index
                let originalFile = null;
                for (let i = 0; i < imagensRedimensionadas.length; i++) {
                    if (imagensRedimensionadas[i].name === fileName) {
                        originalFile = imagensRedimensionadas[i];
                        break;
                    }
                }
                
                // If we couldn't find the file, use the index as fallback
                if (!originalFile) {
                    originalFile = imagensRedimensionadas[index];
                }
                
                // Verificar se h√° desenho para mesclar
                if (drawingData) {
                    // Criar um canvas tempor√°rio para a mesclagem
                    const tempCanvas = document.createElement('canvas');
                    const tempCtx = tempCanvas.getContext('2d');
                    
                    // Criar uma nova imagem para carregar a imagem original
                    const img = new Image();
                    img.onload = function() {
                        // Definir o tamanho do canvas tempor√°rio para o tamanho original da imagem
                        tempCanvas.width = img.naturalWidth;
                        tempCanvas.height = img.naturalHeight;
                        
                        // Desenhar a imagem no canvas tempor√°rio
                        tempCtx.drawImage(img, 0, 0, tempCanvas.width, tempCanvas.height);
                        
                        // Carregar o desenho
                        const drawingImg = new Image();
                        drawingImg.onload = function() {
                            // Calcular a raz√£o de aspecto para redimensionar o desenho corretamente
                            const aspectRatio = {
                                original: img.naturalWidth / img.naturalHeight,
                                drawing: drawingCanvas.width / drawingCanvas.height
                            };
                            
                            // Ajustar o desenho para as dimens√µes da imagem original mantendo a propor√ß√£o
                            tempCtx.drawImage(
                                drawingImg, 
                                0, 0, drawingImg.width, drawingImg.height, 
                                0, 0, tempCanvas.width, tempCanvas.height
                            );
                            
                            // Converter o canvas mesclado em um blob
                            tempCanvas.toBlob(function(blob) {
                                // Criar um novo arquivo com o blob
                                const mergedFile = new File([blob], originalFile.name, {
                                    type: 'image/jpeg',
                                    lastModified: new Date().getTime()
                                });
                                
                                // Armazenar o arquivo mesclado no array na posi√ß√£o correta
                                processedImages[index] = mergedFile;
                                
                                // Incrementar o contador de itens processados
                                processedItems++;
                                
                                // Se todos os itens foram processados, adicionar ao FormData na ordem correta
                                if (processedItems === totalItems) {
                                    // Adicionar todas as imagens processadas na ordem correta
                                    processedImages.forEach(image => {
                                        if (image) {
                                            formData.append('fotos[]', image);
                                        }
                                    });
                                    
                                    enviarFormulario(formData);
                                }
                            }, 'image/jpeg', 0.75); // Qualidade 75%
                        };
                        drawingImg.src = drawingData;
                    };
                    
                    // Carregar a imagem redimensionada
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(originalFile);
                } else {
                    // Se n√£o houver desenho, adicionar o arquivo redimensionado diretamente no array
                    processedImages[index] = originalFile;
                    
                    // Incrementar o contador de itens processados
                    processedItems++;
                    
                    // Se todos os itens foram processados, adicionar ao FormData na ordem correta
                    if (processedItems === totalItems) {
                        // Adicionar todas as imagens processadas na ordem correta
                        processedImages.forEach(image => {
                            if (image) {
                                formData.append('fotos[]', image);
                            }
                        });
                        
                        enviarFormulario(formData);
                    }
                }
            });
        }

        // Fun√ß√£o para enviar o formul√°rio
        function enviarVistoria(e) {
            e.preventDefault();
            
            // Salvar o estado atual das assinaturas antes de validar
            salvarEstadoAssinaturas();
            
            // Valida√ß√µes antes de enviar
            if (!validarMotorista() || !validarAssinaturas() || !validarFotos()) {  // ‚Üê ADICIONAR validarMotorista()
                return;
            }
            
            // Capturar assinaturas
            capturarAssinaturas();
            
            // Criar FormData para o envio
            const formData = new FormData(this);
            
            if (!validarCamposDataSeI()) {
                return;
            }
        
            // Processar fotos com seus desenhos
            processarFotosParaEnvio(formData);
        }

        // Fun√ß√£o para validar motorista
        function validarMotorista() {
            const checkbox = document.getElementById('motorista_nao_cadastrado');
            const selectMotorista = document.getElementById('id_motorista');
            const inputNC = document.getElementById('nc_motorista');
            
            // Se n√£o existirem os elementos (caso de DEVOLUCAO), retorna true
            if (!checkbox || !selectMotorista || !inputNC) {
                return true;
            }
            
            if (checkbox.checked) {
                // Validar input de nome
                if (!inputNC.value || inputNC.value.trim() === '') {
                    alert('Por favor, informe o nome do motorista n√£o cadastrado.');
                    inputNC.focus();
                    return false;
                }
            } else {
                // Validar select
                if (!selectMotorista.value || selectMotorista.value === '') {
                    alert('Por favor, selecione um motorista.');
                    selectMotorista.focus();
                    return false;
                }
            }
            
            return true;
        }
        
        // Fun√ß√£o corrigida de valida√ß√£o dos campos Data e SEI
        function validarCamposDataSeI() {
            // Verifica se estamos na p√°gina de sa√≠da ou devolu√ß√£o
            const tipoInput = document.querySelector('input[name="tipo"]');
            if (!tipoInput) return true; // Se n√£o houver tipo definido, retorna true
            
            const tipo = tipoInput.value;
            
            // Verifica campo de data de sa√≠da
            const dataSaidaInput = document.getElementById('dataSaida');
            if (dataSaidaInput && !dataSaidaInput.value) {
                alert('Por favor, preencha a data de sa√≠da.');
                dataSaidaInput.focus();
                return false;
            }
            
            // Se for devolu√ß√£o, verifica data de retorno
            if (tipo === 'DEVOLUCAO') {
                const dataRetornoInput = document.getElementById('dataRetorno');
                if (dataRetornoInput && !dataRetornoInput.value) {
                    alert('Por favor, preencha a data de retorno.');
                    dataRetornoInput.focus();
                    return false;
                }
            }
            
            // Verifica o campo SEI (se existir) - tornando opcional
            const numSeiInput = document.getElementById('numSei');
            // N√£o retornamos false se o campo estiver vazio, pois √© opcional
            
            return true;
        }


        // Fun√ß√£o para validar assinaturas
        function validarAssinaturas() {
            // Verificar se assinaturas est√£o salvas nos inputs hidden
            const assinaturaUsuarioValue = document.getElementById('assinatura-usuario-input').value;
            const assinaturaMotoristaValue = document.getElementById('assinatura-motorista-input').value;
            
            if (!assinaturaUsuarioValue || assinaturaUsuarioValue === '') {
                alert('√â necess√°rio incluir a assinatura do usu√°rio.');
                return false;
            }
            
            if (!assinaturaMotoristaValue || assinaturaMotoristaValue === '') {
                alert('√â necess√°rio incluir a assinatura do motorista.');
                return false;
            }
            
            return true;
        }

        // Validar fotos
        function validarFotos() {
            const fotosContainerItens = document.getElementById('fotos-geradas-container').children;
            if (fotosContainerItens.length === 0) {
                alert('√â necess√°rio incluir pelo menos uma foto na vistoria.');
                return false;
            }
            return true;
        }

        // Fun√ß√£o para enviar o formul√°rio com o FormData
        function enviarFormulario(formData) {
            // Mostrar spinner e alterar texto do bot√£o
            const salvarBtn = document.getElementById('salvar-btn');
            const btnText = document.getElementById('btn-text');
            const spinner = document.getElementById('spinner-loading');
            
            // Desativar o bot√£o e mostrar o spinner
            salvarBtn.classList.add('btn-saving');
            btnText.textContent = "Salvando, aguarde...";
            spinner.style.display = "inline-block";
            
            const xhr = new XMLHttpRequest();
            xhr.open('POST', document.getElementById('vistoriaForm').action, true);
            
            xhr.onload = function() {
                if (xhr.status === 200) {
                    window.location.href = '/vistorias';
                } else {
                    // Restaurar o bot√£o em caso de erro
                    salvarBtn.classList.remove('btn-saving');
                    btnText.textContent = "Salvar Vistoria";
                    spinner.style.display = "none";
                    
                    alert('Houve um erro ao salvar a vistoria. Por favor, tente novamente.');
                }
            };
            
            xhr.onerror = function() {
                // Restaurar o bot√£o em caso de erro
                salvarBtn.classList.remove('btn-saving');
                btnText.textContent = "Salvar Vistoria";
                spinner.style.display = "none";
                
                alert('Houve um erro na conex√£o. Por favor, verifique sua internet e tente novamente.');
            };
            
            xhr.send(formData);
        }

        // Fun√ß√£o para ativar a capacidade de desenho no canvas
        function ativarDesenho(canvas, dataInput, brushSize, colorSelect) {
            const ctx = canvas.getContext('2d');
            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;
            
            // Fun√ß√£o para converter coordenadas do evento para coordenadas do canvas
            function getCoordenadas(e) {
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;    // Rela√ß√£o entre tamanho f√≠sico e exibido
                const scaleY = canvas.height / rect.height;
                
                const eventX = e.clientX || (e.touches && e.touches[0].clientX);
                const eventY = e.clientY || (e.touches && e.touches[0].clientY);
                
                return {
                    x: (eventX - rect.left) * scaleX,
                    y: (eventY - rect.top) * scaleY
                };
            }
            
            // Fun√ß√£o para come√ßar a desenhar
            function startDrawing(e) {
                e.preventDefault(); // Prevenir comportamento padr√£o
                
                // Obter a posi√ß√£o do mouse/toque relativa ao canvas
                const coords = getCoordenadas(e);
                
                isDrawing = true;
                lastX = coords.x;
                lastY = coords.y;
            }
            
            // Fun√ß√£o para desenhar
            function draw(e) {
                if (!isDrawing) return;
                
                // Impedir o comportamento padr√£o (como rolagem da p√°gina em dispositivos m√≥veis)
                e.preventDefault();
                
                // Obter posi√ß√£o atual
                const coords = getCoordenadas(e);
                
                // Configurar a caneta
                ctx.strokeStyle = colorSelect.value;
                ctx.lineWidth = brushSize.value;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                
                // Desenhar linha
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(coords.x, coords.y);
                ctx.stroke();
                
                lastX = coords.x;
                lastY = coords.y;
                
                // Salvar o desenho no input hidden imediatamente ap√≥s cada tra√ßo
                dataInput.value = canvas.toDataURL('image/png');
            }
            
            // Fun√ß√£o para parar de desenhar
            function stopDrawing(e) {
                if (isDrawing) {
                    isDrawing = false;
                    // Salvar o desenho no input hidden
                    dataInput.value = canvas.toDataURL('image/png');
                }
            }
            
            // Adicionar event listeners para desktop
            canvas.addEventListener('mousedown', startDrawing, { passive: false });
            canvas.addEventListener('mousemove', draw, { passive: false });
            window.addEventListener('mouseup', stopDrawing, { passive: false });
            
            // Adicionar event listeners para dispositivos m√≥veis
            canvas.addEventListener('touchstart', startDrawing, { passive: false });
            canvas.addEventListener('touchmove', draw, { passive: false });
            window.addEventListener('touchend', stopDrawing, { passive: false });
            
            // Armazenar os event listeners no canvas para poder remov√™-los depois
            canvas.drawingListeners = {
                mousedown: startDrawing,
                mousemove: draw,
                mouseup: stopDrawing,
                touchstart: startDrawing,
                touchmove: draw,
                touchend: stopDrawing
            };
        }
        
        // Fun√ß√£o para desativar a capacidade de desenho no canvas
        function desativarDesenho(canvas) {
            if (!canvas.drawingListeners) return;
            
            // Remover todos os event listeners
            canvas.removeEventListener('mousedown', canvas.drawingListeners.mousedown);
            canvas.removeEventListener('mousemove', canvas.drawingListeners.mousemove);
            window.removeEventListener('mouseup', canvas.drawingListeners.mouseup);
            canvas.removeEventListener('touchstart', canvas.drawingListeners.touchstart);
            canvas.removeEventListener('touchmove', canvas.drawingListeners.touchmove);
            window.removeEventListener('touchend', canvas.drawingListeners.touchend);
            
            // Limpar a refer√™ncia aos listeners
            canvas.drawingListeners = null;
        }        

        // Fun√ß√£o melhorada para ajustar o tamanho do canvas de desenho para corresponder exatamente √† imagem
        function ajustarTamanhoCanvas(imgElement, canvasElement) {
            if (!imgElement || !canvasElement) return;
            
            // Aguardar at√© que a imagem esteja carregada
            if (!imgElement.complete) {
                imgElement.onload = function() {
                    ajustarTamanhoCanvas(imgElement, canvasElement);
                };
                return;
            }
            
            // Obter as dimens√µes reais da imagem
            const imgWidth = imgElement.naturalWidth;
            const imgHeight = imgElement.naturalHeight;
            
            // Obter o ret√¢ngulo do elemento de imagem atual na tela
            const imgRect = imgElement.getBoundingClientRect();
            const containerRect = imgElement.parentElement.getBoundingClientRect();
            
            // Calcular a raz√£o de aspecto da imagem
            const imgAspectRatio = imgWidth / imgHeight;
            
            // Calcular o tamanho exibido da imagem (pode ter barras laterais ou superior/inferior)
            let displayedWidth, displayedHeight;
            const containerAspectRatio = containerRect.width / containerRect.height;
            
            if (imgAspectRatio > containerAspectRatio) {
                // Imagem √© mais larga - ter√° barras acima e abaixo
                displayedWidth = containerRect.width;
                displayedHeight = containerRect.width / imgAspectRatio;
            } else {
                // Imagem √© mais alta - ter√° barras laterais
                displayedHeight = containerRect.height;
                displayedWidth = containerRect.height * imgAspectRatio;
            }
            
            // Calcular os offsets para centraliz√°-la
            const offsetX = (containerRect.width - displayedWidth) / 2;
            const offsetY = (containerRect.height - displayedHeight) / 2;
            
            // Ajustar o tamanho e posi√ß√£o do canvas para corresponder exatamente √† imagem exibida
            canvasElement.width = displayedWidth;
            canvasElement.height = displayedHeight;
            
            // Ajustar a posi√ß√£o do canvas para cobrir apenas a √°rea da imagem
            canvasElement.style.position = 'absolute';
            canvasElement.style.left = offsetX + 'px';
            canvasElement.style.top = offsetY + 'px';
            
            // Restaurar desenho existente se houver
            const drawingDataInput = canvasElement.closest('.foto-gerada-item')?.querySelector('.drawing-data');
            if (drawingDataInput && drawingDataInput.value) {
                const img = new Image();
                img.onload = function() {
                    const ctx = canvasElement.getContext('2d');
                    ctx.clearRect(0, 0, canvasElement.width, canvasElement.height);
                    ctx.drawImage(img, 0, 0, canvasElement.width, canvasElement.height);
                };
                img.src = drawingDataInput.value;
            }
        }        
        
        // Modificar a fun√ß√£o para alternar entre 'Desenhar' e 'Salvar'
        function criarItemFotoComDetalhamento(file, container) {
            const template = document.getElementById('foto-gerada-template');
            const fotoItem = document.importNode(template.content, true).firstElementChild;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                // Definir a imagem preview
                const previewImg = fotoItem.querySelector('.foto-preview');
                previewImg.src = e.target.result;
                
                // Armazenar o arquivo em um atributo de dados no input
                const fotoInput = fotoItem.querySelector('.foto-input');
                fotoInput.setAttribute('data-file', file.name);
                
                // Configurar o canvas de desenho
                const drawingCanvas = fotoItem.querySelector('.drawing-canvas');
                ajustarTamanhoCanvas(previewImg, drawingCanvas);
                
                // Adicionar eventos depois que a imagem carregar completamente
                previewImg.onload = function() {
                    ajustarTamanhoCanvas(previewImg, drawingCanvas);
                };
            }
            
            reader.readAsDataURL(file);
            container.appendChild(fotoItem);
            
            // Configurar bot√µes de desenho
            const habilitarDesenhoBtn = fotoItem.querySelector('.habilitar-desenho');
            const limparDesenhoBtn = fotoItem.querySelector('.limpar-desenho');
            const drawingCanvas = fotoItem.querySelector('.drawing-canvas');
            const drawingDataInput = fotoItem.querySelector('.drawing-data');
            const brushSizeInput = fotoItem.querySelector('.brush-size');
            const colorSelect = fotoItem.querySelector('.color-select');
            const colorIndicator = fotoItem.querySelector('.color-indicator');
            
            // Evento para mudar a cor do desenho
            colorSelect.addEventListener('change', function() {
                const selectedColor = this.value;
                colorIndicator.style.backgroundColor = selectedColor;
            });
            
            // Modifica√ß√£o: estado do desenho
            let desenhoAtivo = false;
            
            habilitarDesenhoBtn.addEventListener('click', function() {
                if (!desenhoAtivo) {
                    // Est√° no modo "Desenhar" - ativa o desenho
                    
                    // Desativar qualquer canvas ativo anterior
                    if (activeDrawingCanvas && activeDrawingCanvas !== drawingCanvas) {
                        // Encontrar o bot√£o do canvas ativo anterior e restaur√°-lo
                        const itemAnterior = activeDrawingCanvas.closest('.foto-gerada-item');
                        const botaoAnterior = itemAnterior.querySelector('.habilitar-desenho');
                        botaoAnterior.textContent = 'Desenhar';
                        botaoAnterior.classList.remove('btn-warning');
                        botaoAnterior.classList.add('btn-primary');
                        
                        desativarDesenho(activeDrawingCanvas);
                    }
                    
                    // Ativar o desenho no canvas atual
                    ativarDesenho(drawingCanvas, drawingDataInput, brushSizeInput, colorSelect);
                    activeDrawingCanvas = drawingCanvas;
                    
                    // Mudar o bot√£o para "Salvar"
                    habilitarDesenhoBtn.textContent = 'Salvar';
                    habilitarDesenhoBtn.classList.remove('btn-primary');
                    habilitarDesenhoBtn.classList.add('btn-warning');
                    desenhoAtivo = true;
                } else {
                    // Est√° no modo "Salvar" - desativa o desenho
                    desativarDesenho(drawingCanvas);
                    activeDrawingCanvas = null;
                    
                    // Mudar o bot√£o de volta para "Desenhar"
                    habilitarDesenhoBtn.textContent = 'Desenhar';
                    habilitarDesenhoBtn.classList.remove('btn-warning');
                    habilitarDesenhoBtn.classList.add('btn-primary');
                    desenhoAtivo = false;
                }
            });
            
            limparDesenhoBtn.addEventListener('click', function() {
                const ctx = drawingCanvas.getContext('2d');
                ctx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
                drawingDataInput.value = '';
                
                if (activeDrawingCanvas === drawingCanvas) {
                    desativarDesenho(drawingCanvas);
                    activeDrawingCanvas = null;
                    
                    // Restaurar o bot√£o para "Desenhar"
                    habilitarDesenhoBtn.textContent = 'Desenhar';
                    habilitarDesenhoBtn.classList.remove('btn-warning');
                    habilitarDesenhoBtn.classList.add('btn-primary');
                    desenhoAtivo = false;
                }
            });
            
            return fotoItem;
        }

        // Fun√ß√£o para ajustar o tamanho dos pads de assinatura
        function resizeSignaturePads() {
            // Ajusta a altura do canvas para manter a propor√ß√£o
            const containers = document.querySelectorAll('.signature-pad-container');
            if (containers.length === 0) return;
            
            const containerWidth = containers[0].offsetWidth;
            const ratio = Math.max(0.5, Math.min(1, containerWidth / 500)); // Mant√©m uma propor√ß√£o razo√°vel
            
            const height = 200 * ratio;
            
            // Ajusta o tamanho do canvas
            const signaturePads = document.querySelectorAll('.signature-pad');
            signaturePads.forEach(pad => {
                // Ajusta o tamanho do container e do canvas
                pad.parentElement.style.height = `${height}px`;
                
                // Salvar conte√∫do atual caso exista
                let currentData = '';
                if (pad.id === 'signature-pad-usuario' && signaturePadUsuario) {
                    currentData = signaturePadUsuario.isEmpty() ? '' : signaturePadUsuario.toDataURL();
                } else if (pad.id === 'signature-pad-motorista' && signaturePadMotorista) {
                    currentData = signaturePadMotorista.isEmpty() ? '' : signaturePadMotorista.toDataURL();
                }
                
                // Redefine o tamanho do canvas
                pad.width = pad.offsetWidth;
                pad.height = pad.offsetHeight;
                
                // Restaura o conte√∫do se houver
                if (currentData) {
                    const img = new Image();
                    const ctx = pad.getContext('2d');
                    
                    img.onload = function() {
                        ctx.drawImage(img, 0, 0, pad.width, pad.height);
                        
                        // Recria a inst√¢ncia do SignaturePad com o conte√∫do restaurado
                        if (pad.id === 'signature-pad-usuario') {
                            signaturePadUsuario = new SignaturePad(pad, { backgroundColor: 'rgb(255, 255, 255)', penColor: 'rgb(0, 0, 0)' });
                            signaturePadUsuario._data = signaturePadUsuario.toData(); // Salva os dados do tra√ßo
                        } else if (pad.id === 'signature-pad-motorista') {
                            signaturePadMotorista = new SignaturePad(pad, { backgroundColor: 'rgb(255, 255, 255)', penColor: 'rgb(0, 0, 0)' });
                            signaturePadMotorista._data = signaturePadMotorista.toData(); // Salva os dados do tra√ßo
                        }
                    };
                    
                    img.src = currentData;
                }
            });
            
            // Tamb√©m ajusta os canvas de desenho
            const fotosContainer = document.getElementById('fotos-geradas-container');
            if (fotosContainer) {
                const fotosItems = fotosContainer.querySelectorAll('.foto-gerada-item');
                fotosItems.forEach(item => {
                    const previewImg = item.querySelector('.foto-preview');
                    const drawingCanvas = item.querySelector('.drawing-canvas');
                    ajustarTamanhoCanvas(previewImg, drawingCanvas);
                });
            }
        }

        // Fun√ß√£o de logout corrigida
        function fazerLogout() {
            const btnLogout = document.getElementById('btnLogout');
            
            // Desabilitar o bot√£o para evitar m√∫ltiplos cliques
            btnLogout.disabled = true;
            btnLogout.textContent = 'Saindo...';
            
            // Fazer requisi√ß√£o para o endpoint de logout do backend
            fetch('/logout', {
                method: 'GET',
                credentials: 'same-origin' // Importante para manter os cookies de sess√£o
            })
            .then(response => {
                // Independente da resposta, limpar o localStorage
                localStorage.removeItem('usuario_logado');
                localStorage.removeItem('usuario_id');
                localStorage.removeItem('usuario_login');
                localStorage.removeItem('usuario_nome');
                localStorage.removeItem('nivel_acesso');
                
                // Redirecionar para a p√°gina de login
                window.location.href = '/login';
            })
            .catch(error => {
                console.error('Erro durante logout:', error);
                
                // Mesmo com erro, limpar o localStorage e redirecionar
                localStorage.removeItem('usuario_logado');
                localStorage.removeItem('usuario_id');
                localStorage.removeItem('usuario_login');
                localStorage.removeItem('usuario_nome');
                localStorage.removeItem('nivel_acesso');
                
                // Redirecionar para a p√°gina de login
                window.location.href = '/login';
            })
            .finally(() => {
                // Reabilitar o bot√£o (caso algo d√™ errado)
                btnLogout.disabled = false;
                btnLogout.textContent = 'Sair';
            });
        }
    </script>
</body>
</html>









