<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nova Vistoria</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/css/bootstrap.min.css">
    <style>
        .preview-container {
            text-align: center;
            margin-top: 10px;
        }
        .preview-image {
            max-width: 100%;
            max-height: 300px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px;
        }
        .camera-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 10px;
        }
        #video {
            width: 100%;
            max-width: 500px;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: none;
        }
        #canvas {
            display: none;
        }
        .foto-item {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .camera-buttons {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }
        .tipo-vistoria-badge {
            font-size: 1rem;
            padding: 0.5rem 1rem;
            margin-left: 1rem;
        }
        #multi-foto-container {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px dashed #ccc;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        /* Estilos para o controle deslizante de combustível */
        .fuel-slider-container {
            margin: 0;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
            border: 1px solid #ddd;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .fuel-slider-label {
            display: flex;
            align-items: center;
            margin-right: 10px;
            font-weight: bold;
            font-size: 1rem;
        }
        .fuel-slider-value {
            margin-left: 5px;
            font-weight: normal;
        }
        .fuel-slider-content {
            flex: 1;
        }
        .fuel-slider {
            width: 100%;
            margin: 5px 0;
        }
        .fuel-markers {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: #666;
        }
        /* Estilos para as áreas de assinatura */
        .signature-container {
            margin-top: 30px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            background-color: #f9f9f9;
        }
        .signature-pad-container {
            position: relative;
            width: 100%;
            height: 200px;
            margin-top: 10px;
            border: 1px solid #ccc;
            background-color: #fff;
            border-radius: 4px;
        }
        .signature-pad {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
        }
        .signature-buttons {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }
        .signature-preview {
            max-width: 100%;
            max-height: 200px;
            margin-top: 10px;
            display: none;
            border: 1px solid #ddd;
        }
        
        /* Responsividade para o layout de 4 colunas */
        @media (min-width: 992px) {
            .flex-fields-container {
                display: flex;
                gap: 15px;
                margin-bottom: 20px;
            }
            .flex-field {
                flex: 1;
                margin-bottom: 0;
            }
            .fuel-slider-container {
                margin: 0;
            }
        }
        
        /* Para telas menores */
        @media (max-width: 991px) {
            .flex-field {
                margin-bottom: 15px;
            }
            .fuel-slider-container {
                margin-bottom: 20px;
            }
        }
        
        /* Estilo para a área de fotos geradas */
        .foto-gerada-item {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .foto-preview {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex align-items-center">
            <h1>Nova Vistoria</h1>
            {% if tipo == 'ENTREGA' %}
            <span class="badge bg-primary tipo-vistoria-badge">Entrega</span>
            {% else %}
            <span class="badge bg-success tipo-vistoria-badge">Devolução</span>
            {% endif %}
        </div>
        
        <form id="vistoriaForm" action="/salvar_vistoria" method="post" enctype="multipart/form-data">
            <input type="hidden" name="tipo" value="{{ tipo }}">
            {% if vistoria_entrega_id %}
            <input type="hidden" name="vistoria_entrega_id" value="{{ vistoria_entrega_id }}">
            {% endif %}
            
            <!-- Layout modificado com 4 colunas em telas maiores -->
            <div class="flex-fields-container">
                <div class="flex-field">
                    <label for="id_motorista" class="form-label">Motorista</label>
                    {% if tipo == 'DEVOLUCAO' %}
                    <input type="hidden" name="id_motorista" value="{{ motorista_id }}">
                    <input type="text" class="form-control" value="{{ motorista_nome }}" readonly>
                    {% else %}
                    <select class="form-select" id="id_motorista" name="id_motorista" required>
                        <option value="">Selecione um motorista</option>
                        {% for motorista in motoristas %}
                        <option value="{{ motorista[0] }}">{{ motorista[1] }}</option>
                        {% endfor %}
                    </select>
                    {% endif %}
                </div>
                
                <div class="flex-field">
                    <label for="id_veiculo" class="form-label">Veículo</label>
                    {% if tipo == 'DEVOLUCAO' %}
                    <input type="hidden" name="id_veiculo" value="{{ veiculo_id }}">
                    <input type="text" class="form-control" value="{{ veiculo_placa }}" readonly>
                    {% else %}
                    <select class="form-select" id="id_veiculo" name="id_veiculo" required>
                        <option value="">Selecione um veículo</option>
                        {% for veiculo in veiculos %}
                        <option value="{{ veiculo[0] }}">{{ veiculo[1] }}</option>
                        {% endfor %}
                    </select>
                    {% endif %}
                </div>
                
                <!-- Novo campo de Hodômetro -->
                <div class="flex-field">
                    <label for="hodometro" class="form-label">Hodômetro (Km)</label>
                    <input type="number" class="form-control" id="hodometro" name="hodometro" min="0" required>
                </div>
                
                <!-- Controle deslizante para o nível de combustível -->
                <div class="flex-field fuel-slider-container">
                    <div class="fuel-slider-label">
                        Combustível: <span class="fuel-slider-value" id="combustivel-valor">100%</span>
                    </div>
                    <div class="fuel-slider-content">
                        <input type="range" class="form-range fuel-slider" id="combustivel" name="combustivel" min="0" max="100" value="100" step="1">
                        <div class="fuel-markers">
                            <span>0</span>
                            <span>1/4</span>
                            <span>1/2</span>
                            <span>3/4</span>
                            <span>1</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="multi-foto-container" class="mb-4">
                <h3>Selecionar Fotos</h3>
                <div class="mb-3">
                    <input type="file" class="form-control" id="multi-foto-input" accept="image/*" multiple required>
                    <div class="form-text">Selecione as fotos para adicionar à vistoria</div>
                </div>
            </div>
            
            <!-- Área onde as fotos selecionadas serão mostradas com campos de detalhamento -->
            <div id="fotos-geradas-container">
                <!-- As fotos com campos de detalhamento serão adicionadas aqui -->
            </div>
            
            <div class="camera-container" id="camera-container">
                <video id="video" autoplay></video>
                <canvas id="canvas"></canvas>
                <div class="camera-buttons" id="main-camera-buttons" style="display: none;">
                    <button type="button" class="btn btn-primary" id="capture">Capturar Foto</button>
                    <button type="button" class="btn btn-secondary" id="closeCamera">Fechar Câmera</button>
                </div>
            </div>
            
            <!-- Área de assinatura do usuário -->
            <div class="signature-container">
                <h4>Assinatura Vistoriador</h4>
                <p class="text-muted">Assine usando o dedo ou uma caneta stylus na área abaixo:</p>
                
                <div class="signature-pad-container">
                    <canvas id="signature-pad-usuario" class="signature-pad"></canvas>
                </div>
                
                <input type="hidden" name="assinatura_usuario" id="assinatura-usuario-input">
                
                <div class="signature-buttons">
                    <button type="button" class="btn btn-secondary" id="limpar-assinatura-usuario">Limpar</button>
                </div>
                
                <div class="preview-container">
                    <img id="assinatura-usuario-preview" class="signature-preview">
                </div>
            </div>
            
            <!-- Área de assinatura do motorista -->
            <div class="signature-container">
                <h4>Assinatura do Motorista</h4>
                <p class="text-muted">Peça ao motorista para assinar usando o dedo ou uma caneta stylus na área abaixo:</p>
                
                <div class="signature-pad-container">
                    <canvas id="signature-pad-motorista" class="signature-pad"></canvas>
                </div>
                
                <input type="hidden" name="assinatura_motorista" id="assinatura-motorista-input">
                
                <div class="signature-buttons">
                    <button type="button" class="btn btn-secondary" id="limpar-assinatura-motorista">Limpar</button>
                </div>
                
                <div class="preview-container">
                    <img id="assinatura-motorista-preview" class="signature-preview">
                </div>
            </div>
            
            <div class="mt-4">
                <button type="submit" class="btn btn-primary">Salvar Vistoria</button>
                <a href="/vistorias" class="btn btn-secondary">Cancelar</a>
            </div>
        </form>
    </div>
    
    <!-- Template para itens de foto gerados automaticamente -->
    <template id="foto-gerada-template">
        <div class="foto-gerada-item">
            <img class="foto-preview" src="">
            <input type="hidden" class="foto-input" name="fotos[]">
            
            <div class="mb-3 mt-3">
                <label class="form-label">Observações (máx. 100 caracteres)</label>
                <textarea class="form-control" name="detalhamentos[]" maxlength="100" rows="2" placeholder="Digite detalhes sobre esta foto..."></textarea>
            </div>
        </div>
    </template>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/1.5.3/signature_pad.min.js"></script>
    <script>
        let videoStream = null;
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const captureButton = document.getElementById('capture');
        const closeButton = document.getElementById('closeCamera');
        
        // Inicializar as áreas de assinatura
        const signaturePadUsuario = new SignaturePad(document.getElementById('signature-pad-usuario'), {
            backgroundColor: 'rgb(255, 255, 255)',
            penColor: 'rgb(0, 0, 0)'
        });
        
        const signaturePadMotorista = new SignaturePad(document.getElementById('signature-pad-motorista'), {
            backgroundColor: 'rgb(255, 255, 255)',
            penColor: 'rgb(0, 0, 0)'
        });
        
        // Botões para limpar assinaturas
        document.getElementById('limpar-assinatura-usuario').addEventListener('click', function() {
            signaturePadUsuario.clear();
            document.getElementById('assinatura-usuario-preview').style.display = 'none';
            document.getElementById('assinatura-usuario-input').value = '';
        });
        
        document.getElementById('limpar-assinatura-motorista').addEventListener('click', function() {
            signaturePadMotorista.clear();
            document.getElementById('assinatura-motorista-preview').style.display = 'none';
            document.getElementById('assinatura-motorista-input').value = '';
        });
        
        // Configurar o controle deslizante de combustível
        const combustivelSlider = document.getElementById('combustivel');
        const combustivelValor = document.getElementById('combustivel-valor');
        
        combustivelSlider.addEventListener('input', function() {
            combustivelValor.textContent = this.value + '%';
        });
        
        // Ajustar tamanho dos pads de assinatura para dispositivos móveis
        document.addEventListener('DOMContentLoaded', function() {
            window.addEventListener('resize', resizeSignaturePads);
            resizeSignaturePads();
            
            // Configurar processamento de múltiplas fotos
            document.getElementById('multi-foto-input').addEventListener('change', function(e) {
                const files = this.files;
                const fotosContainer = document.getElementById('fotos-geradas-container');
                fotosContainer.innerHTML = '';
                
                if (files.length === 0) {
                    return;
                }
                
                // Para cada arquivo selecionado, criar um item com a foto e campo de detalhamento
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    criarItemFotoComDetalhamento(file, fotosContainer);
                }
            });
        });
        
        // Função para criar um item de foto com campo de detalhamento
        function criarItemFotoComDetalhamento(file, container) {
            const template = document.getElementById('foto-gerada-template');
            const fotoItem = document.importNode(template.content, true).firstElementChild;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                // Definir a imagem preview
                const previewImg = fotoItem.querySelector('.foto-preview');
                previewImg.src = e.target.result;
                
                // Criar um blob a partir do arquivo e atribuí-lo ao input
                const fotoInput = fotoItem.querySelector('.foto-input');
                fotoInput.value = file.name; // Isso será substituído pelo FormData no envio
                
                // Armazenar o arquivo em um atributo de dados no input
                fotoInput.setAttribute('data-file', file.name);
            }
            
            reader.readAsDataURL(file);
            container.appendChild(fotoItem);
            return fotoItem;
        }
        
        function resizeSignaturePads() {
            // Ajusta a altura do canvas para manter a proporção
            const containerWidth = document.querySelector('.signature-pad-container').offsetWidth;
            const ratio = Math.max(0.5, Math.min(1, containerWidth / 500)); // Mantém uma proporção razoável
            
            const height = 200 * ratio;
            
            // Ajusta o tamanho do canvas
            const signaturePads = document.querySelectorAll('.signature-pad');
            signaturePads.forEach(pad => {
                // Salva o conteúdo atual antes de redimensionar
                const currentPad = pad.id === 'signature-pad-usuario' ? signaturePadUsuario : signaturePadMotorista;
                const data = currentPad.toDataURL();
                
                // Ajusta o tamanho do container e do canvas
                pad.parentElement.style.height = `${height}px`;
                
                // Redefine o canvas (isso limpa o conteúdo)
                pad.width = pad.offsetWidth;
                pad.height = pad.offsetHeight;
                
                // Restaura o conteúdo se houver
                if (!currentPad.isEmpty()) {
                    // Restaura a assinatura após um redimensionamento
                    const img = new Image();
                    img.onload = function() {
                        pad.getContext('2d').drawImage(img, 0, 0, pad.width, pad.height);
                    };
                    img.src = data;
                }
            });
        }
        
        // Validação do formulário antes de enviar
        document.getElementById('vistoriaForm').addEventListener('submit', function(e) {
            e.preventDefault(); // Impede o envio padrão do formulário
            
            // Verifica se há fotos
            const fotosContainerItens = document.getElementById('fotos-geradas-container').children;
            if (fotosContainerItens.length === 0) {
                alert('É necessário incluir pelo menos uma foto na vistoria.');
                return;
            }
            
            // Verificar as assinaturas
            if (signaturePadUsuario.isEmpty()) {
                alert('É necessário incluir a assinatura do usuário.');
                return;
            }
            
            if (signaturePadMotorista.isEmpty()) {
                alert('É necessário incluir a assinatura do motorista.');
                return;
            }
            
            // Capturar as assinaturas como imagens base64
            const assinaturaUsuarioData = signaturePadUsuario.toDataURL('image/png');
            const assinaturaMotoristaData = signaturePadMotorista.toDataURL('image/png');
            
            // Armazenar nos campos hidden
            document.getElementById('assinatura-usuario-input').value = assinaturaUsuarioData;
            document.getElementById('assinatura-motorista-input').value = assinaturaMotoristaData;
            
            // Mostrar as previews das assinaturas (opcional)
            const previewUsuario = document.getElementById('assinatura-usuario-preview');
            previewUsuario.src = assinaturaUsuarioData;
            previewUsuario.style.display = 'block';
            
            const previewMotorista = document.getElementById('assinatura-motorista-preview');
            previewMotorista.src = assinaturaMotoristaData;
            previewMotorista.style.display = 'block';
            
            // Tratar os arquivos de imagem
            const fotosInput = document.getElementById('multi-foto-input');
            const files = fotosInput.files;
            const formData = new FormData(this);
            
            // Limpar as entradas de fotos existentes
            const inputsExistentes = formData.getAll('fotos[]');
            inputsExistentes.forEach(() => {
                formData.delete('fotos[]');
            });
            
            // Adicionar os arquivos de fotos ao FormData
            for (let i = 0; i < files.length; i++) {
                formData.append('fotos[]', files[i]);
            }
            
            // Enviar o formulário com o FormData
            const xhr = new XMLHttpRequest();
            xhr.open('POST', this.action, true);
            xhr.onload = function() {
                if (xhr.status === 200) {
                    window.location.href = '/vistorias';
                } else {
                    alert('Houve um erro ao salvar a vistoria. Por favor, tente novamente.');
                }
            };
            xhr.send(formData);
        });
    </script>
</body>
</html>
