<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="static/img/logo_sotweb.jpg">
    <title>Gest√£o de Contratos Terceirizados</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    
    <!-- CSS do Menu -->
    <link rel="stylesheet" href="/static/css/menu-styles.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding-top: 25px !important; 
            background-color: #f5f5f5;
            color: #333;
            font-size: 13px;
            min-height: 100vh;
        }

        /* Estilos do Menu */
        .navbar-nav {
            height: 100% !important;
            align-items: center !important;
        }

        .navbar .container,
        .navbar .container-fluid {
            height: 100% !important;
            align-items: center !important;
        }

        .navbar-collapse {
            height: auto !important;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background-color: #2c3e50;
            color: white;
            padding: 10px 20px;
            margin-bottom: 15px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 16px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .groupbox {
            background-color: white;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }

        .groupbox-header {
            background-color: #34495e;
            color: white;
            padding: 10px 15px;
            border-radius: 4px 4px 0 0;
            font-weight: 600;
            font-size: 13px;
        }

        .groupbox-body {
            padding: 15px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .table thead th {
            background-color: #34495e;
            color: white;
            padding: 8px;
            text-align: left;
            font-weight: 600;
            border: 1px solid #2c3e50;
        }

        /* Larguras espec√≠ficas apenas para a tabela de sele√ß√£o de contratos */
        #tabelaSelecaoContratos {
            table-layout: fixed;
        }
        
        #tabelaSelecaoContratos thead th:nth-child(1) { width: 8%; }  /* Exerc√≠cio */
        #tabelaSelecaoContratos thead th:nth-child(2) { width: 42%; } /* Empresa */
        #tabelaSelecaoContratos thead th:nth-child(3) { width: 12%; } /* Contrato */
        #tabelaSelecaoContratos thead th:nth-child(4) { width: 28%; } /* Processo */
        #tabelaSelecaoContratos thead th:nth-child(5) { width: 10%; } /* A√ß√£o */

        .table tbody td {
            padding: 8px;
            border: 1px solid #dee2e6;
        }

        .table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-success {
            background-color: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background-color: #229954;
        }

        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-warning {
            background-color: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background-color: #d68910;
        }

        .btn-secondary {
            background-color: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #7f8c8d;
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 11px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }

        .modal.active {
            display: block;
        }

        .modal-content {
            background-color: #fff;
            margin: 2% auto;
            padding: 0;
            border-radius: 4px;
            width: 90%;
            max-width: 1200px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            background-color: #2c3e50;
            color: white;
            padding: 15px 20px;
            border-radius: 4px 4px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 16px;
            font-weight: 600;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #ecf0f1;
        }

        .modal-body {
            padding: 20px;
            position: relative;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #ecf0f1;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: #555;
            margin-bottom: 5px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }

        .form-group select {
            height: auto;
            min-height: 32px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }

        .form-row {
            display: grid;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-row-2 {
            grid-template-columns: repeat(2, 1fr);
        }

        .form-row-3 {
            grid-template-columns: repeat(3, 1fr);
        }

        /* Coluna menor para ano */
        .form-row-ano-mes {
            grid-template-columns: 2fr 1fr;
        }

        .text-center {
            text-align: center;
        }

        .contract-info {
            background-color: #e8f4f8;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .contract-details {
            display: flex;
            gap: 20px;
        }

        .contract-detail-item {
            display: flex;
            flex-direction: column;
        }

        .contract-detail-item label {
            font-size: 11px;
            color: #666;
            font-weight: 600;
        }

        .contract-detail-item span {
            font-size: 13px;
            font-weight: 600;
            color: #2c3e50;
        }

        /* Customiza√ß√£o do Select2 */
        .select2-container {
            width: 100% !important;
        }

        .select2-container--default .select2-selection--single {
            height: 32px !important;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 4px 8px;
        }

        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 22px;
            padding-left: 0;
            font-size: 12px;
        }

        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 30px;
        }

        /* Dropdown do Select2 com quebra de linha */
        .select2-dropdown {
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }

        .select2-results__option {
            white-space: normal !important;
            word-wrap: break-word;
            padding: 8px 12px;
            line-height: 1.4;
        }

        .select2-container--default .select2-results__option--highlighted[aria-selected] {
            background-color: #3498db;
            color: white;
        }

        .select2-container--default .select2-search--dropdown .select2-search__field {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 6px 8px;
            font-size: 12px;
        }

        /* Ajustar largura m√°xima do dropdown */
        .select2-container--open .select2-dropdown {
            max-width: 100%;
        }

        #contratoSection {
            display: block;
        }

        #vinculosSection {
            display: none;
        }

        .filter-section {
            background-color: white;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Input de ano menor */
        .input-ano {
            max-width: 100px;
        }

        /* Fieldset para agrupar compet√™ncia */
        .fieldset-competencia {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px 15px 5px 15px;
            margin-bottom: 15px;
        }

        .fieldset-competencia legend {
            font-size: 13px;
            font-weight: 600;
            color: #2c3e50;
            padding: 0 10px;
            width: auto;
            margin-bottom: 0;
        }

        .fieldset-competencia .form-row {
            margin-bottom: 0;
        }

        /* ============================================
           MODAL VISUALIZADOR PDF - RELAT√ìRIO
           ============================================ */
        .modal-relatorio-pdf {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            overflow: auto;
        }
        
        .modal-relatorio-pdf-content {
            position: relative;
            background-color: #fff;
            margin: 2% auto;
            padding: 0;
            width: 90%;
            max-width: 1200px;
            height: 90vh;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .modal-relatorio-pdf-header {
            background-color: #2c3e50;
            color: white;
            padding: 15px 20px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-relatorio-pdf-header h5 {
            margin: 0;
            font-size: 1.1rem;
        }
        
        .modal-relatorio-pdf-close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            line-height: 1;
            transition: opacity 0.3s;
        }
        
        .modal-relatorio-pdf-close:hover {
            opacity: 0.7;
        }
        
        .modal-relatorio-pdf-body {
            padding: 0;
            height: calc(90vh - 60px);
        }
        
        .modal-relatorio-pdf-body iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        @media (max-width: 768px) {
            .modal-relatorio-pdf-content {
                width: 95%;
                height: 85vh;
                margin: 5% auto;
            }
            
            .modal-relatorio-pdf-body {
                height: calc(85vh - 60px);
            }
        }
        
        /* ============================================
           LOADING ELEGANTE - GLASSMORPHISM
           ============================================ */
        
        .loading-overlay {
            display: none;
            position: absolute;  /* ‚úÖ absolute, n√£o fixed */
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 10;  /* ‚úÖ 10, n√£o 9999 */
            animation: fadeIn 0.3s ease-in-out;
        }

        .loading-overlay.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .loading-content {
            background: white;
            border-radius: 15px;
            padding: 40px 60px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            margin: 0 auto 20px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #2c3e50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            font-size: 18px;
            color: #2c3e50;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .loading-subtext {
            font-size: 14px;
            color: #7f8c8d;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>GEST√ÉO DE CONTRATOS TERCEIRIZADOS</h1>
        </div>

        <!-- SE√á√ÉO DE SELE√á√ÉO DE CONTRATO -->
        <div id="contratoSection">
            <div class="groupbox">
                <div class="groupbox-header">
                    Sele√ß√£o de Contrato
                </div>
                <div class="groupbox-body">
                    <table class="table" id="tabelaSelecaoContratos">
                        <thead>
                            <tr>
                                <th>Exerc√≠cio</th>
                                <th>Empresa</th>
                                <th>Contrato</th>
                                <th>Processo</th>
                                <th style="text-align: center;">A√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaContratos">
                            <tr>
                                <td colspan="5" class="text-center" style="padding: 30px; color: #999;">
                                    Carregando contratos...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- SE√á√ÉO DE V√çNCULOS (MOTORISTAS E POSTOS) -->
        <div id="vinculosSection">
            <!-- Informa√ß√µes do contrato selecionado -->
            <div class="contract-info">
                <div class="contract-details">
                    <div class="contract-detail-item">
                        <label>Exerc√≠cio</label>
                        <span id="infoExercicio">-</span>
                    </div>
                    <div class="contract-detail-item">
                        <label>Empresa</label>
                        <span id="infoEmpresa">-</span>
                    </div>
                    <div class="contract-detail-item">
                        <label>Contrato</label>
                        <span id="infoContrato">-</span>
                    </div>
                    <div class="contract-detail-item">
                        <label>Processo</label>
                        <span id="infoProcesso">-</span>
                    </div>
                </div>
                <button type="button" class="btn btn-secondary" onclick="voltarSelecaoContrato()">
                    Voltar √† Sele√ß√£o
                </button>
            </div>

            <!-- Bot√µes de Relat√≥rio e Ocorr√™ncias -->
            <div class="filter-section">
                <div></div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" onclick="abrirModalRelatorioFiscalizacao()">
                        üìä Relat√≥rio de Fiscaliza√ß√£o
                    </button>
                    <button class="btn btn-warning" onclick="abrirModalOcorrencias()">
                        üìã Registro de Ocorr√™ncias
                    </button>
                </div>
            </div>

            <!-- Lista de V√≠nculos -->
            <div class="groupbox">
                <div class="groupbox-header">
                    Motoristas e Postos de Trabalho Ativos
                </div>
                <div class="groupbox-body">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Motorista</th>
                                <th>Posto de Trabalho</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaVinculos">
                            <tr>
                                <td colspan="2" class="text-center" style="padding: 30px; color: #999;">
                                    Carregando v√≠nculos...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Ocorr√™ncias -->
    <div id="modalOcorrencias" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Registro de Ocorr√™ncias</h2>
                <span class="close" onclick="fecharModalOcorrencias()">&times;</span>
            </div>
            <div class="modal-body">
                <!-- Filtro de M√™s/Ano -->
                <div class="form-row form-row-3">
                    <div class="form-group">
                        <label for="filtroMes">M√™s:</label>
                        <select id="filtroMes" onchange="carregarOcorrencias()">
                            <option value="01">Janeiro</option>
                            <option value="02">Fevereiro</option>
                            <option value="03">Mar√ßo</option>
                            <option value="04">Abril</option>
                            <option value="05">Maio</option>
                            <option value="06">Junho</option>
                            <option value="07">Julho</option>
                            <option value="08">Agosto</option>
                            <option value="09">Setembro</option>
                            <option value="10">Outubro</option>
                            <option value="11">Novembro</option>
                            <option value="12">Dezembro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filtroAno">Ano:</label>
                        <select id="filtroAno" class="input-ano" onchange="carregarOcorrencias()">
                            <!-- Ser√° preenchido dinamicamente -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button class="btn btn-success" onclick="abrirModalNovaOcorrencia()">
                            + Nova Ocorr√™ncia
                        </button>
                    </div>
                </div>

                <!-- Tabela de Ocorr√™ncias -->
                <div class="groupbox">
                    <div class="groupbox-header">
                        Ocorr√™ncias Registradas
                    </div>
                    <div class="groupbox-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th style="width: 120px;">Compet√™ncia</th>
                                    <th style="width: 100px;">Data</th>
                                    <th style="width: 200px;">Motorista</th>
                                    <th>Imperfei√ß√£o</th>
                                    <th>Especifica√ß√£o</th>
                                    <th style="width: 120px; text-align: center;">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="tabelaOcorrenciasLista">
                                <tr>
                                    <td colspan="6" class="text-center" style="padding: 30px; color: #999;">
                                        Nenhuma ocorr√™ncia encontrada
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="fecharModalOcorrencias()">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal do Relat√≥rio de Fiscaliza√ß√£o -->
    <div id="modalRelatorioFiscalizacao" class="modal">
        <div class="modal-content" style="max-width: 1400px;">
            <div class="modal-header">
                <h2>Relat√≥rio de Fiscaliza√ß√£o</h2>
                <span class="close" onclick="fecharModalRelatorioFiscalizacao()">&times;</span>
            </div>
            <div class="modal-body">
    
                <!-- ‚úÖ ADICIONAR O LOADING AQUI DENTRO -->
                <div id="loadingOverlay" class="loading-overlay">
                    <div class="loading-content">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">
                            Gerando relat√≥rio<span class="loading-dots"></span>
                        </div>
                        <div class="loading-subtext">
                            Processando dados
                        </div>
                    </div>
                </div>
    
                <!-- Filtros -->
                <div class="form-row form-row-3" style="margin-bottom: 20px;">
                    <div class="form-group">
                        <label for="relatorioMes">M√™s:</label>
                        <select id="relatorioMes">
                            <option value="JANEIRO">Janeiro</option>
                            <option value="FEVEREIRO">Fevereiro</option>
                            <option value="MAR√áO">Mar√ßo</option>
                            <option value="ABRIL">Abril</option>
                            <option value="MAIO">Maio</option>
                            <option value="JUNHO">Junho</option>
                            <option value="JULHO">Julho</option>
                            <option value="AGOSTO">Agosto</option>
                            <option value="SETEMBRO">Setembro</option>
                            <option value="OUTUBRO">Outubro</option>
                            <option value="NOVEMBRO">Novembro</option>
                            <option value="DEZEMBRO">Dezembro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="relatorioAno">Ano:</label>
                        <select id="relatorioAno" class="input-ano">
                            <!-- Ser√° preenchido dinamicamente -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button class="btn btn-primary" onclick="gerarRelatorioFiscalizacao()">
                            üîç Gerar Relat√≥rio
                        </button>
                    </div>
                </div>

                <!-- Conte√∫do do Relat√≥rio -->
                <div id="conteudoRelatorio" style="display: none;">
                    <!-- Cabe√ßalho do Relat√≥rio -->
                    <div style="border: 2px solid #2c3e50; margin-bottom: 20px;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <tr>
                                <td rowspan="3" style="width: 120px; padding: 10px; border: 1px solid #2c3e50; text-align: center; vertical-align: middle;">
                                    <img src="static/img/logo_tjronovo.jpg" alt="Logo TJRO" style="max-width: 100%; max-height: 100px; width: auto; height: auto; object-fit: contain;">
                                </td>                                
                                <td style="padding: 10px; border: 1px solid #2c3e50; text-align: center; font-weight: bold; font-size: 14px;">
                                    TRIBUNAL DE JUSTI√áA DO ESTADO DE ROND√îNIA
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 10px; border: 1px solid #2c3e50; text-align: center; font-weight: bold; font-size: 13px;">
                                    RELAT√ìRIO DE OCORR√äNCIA - LISTA DE IMPERFEI√á√ïES
                                </td>
                            </tr>
                        </table>
                        
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <tr>
                                <td style="padding: 5px 10px; border: 1px solid #2c3e50; font-weight: bold; width: 150px; background-color: #f0f0f0;">Contrato</td>
                                <td id="relCabContrato" style="padding: 5px 10px; border: 1px solid #2c3e50;">-</td>
                            </tr>
                            <tr>
                                <td style="padding: 5px 10px; border: 1px solid #2c3e50; font-weight: bold; background-color: #f0f0f0;">Protocolo</td>
                                <td id="relCabProtocolo" style="padding: 5px 10px; border: 1px solid #2c3e50;">-</td>
                            </tr>
                            <tr>
                                <td style="padding: 5px 10px; border: 1px solid #2c3e50; font-weight: bold; background-color: #f0f0f0;">Contratada</td>
                                <td id="relCabContratada" style="padding: 5px 10px; border: 1px solid #2c3e50;">-</td>
                            </tr>
                            <tr>
                                <td style="padding: 5px 10px; border: 1px solid #2c3e50; font-weight: bold; background-color: #f0f0f0;">Objeto</td>
                                <td id="relCabObjeto" style="padding: 5px 10px; border: 1px solid #2c3e50;">-</td>
                            </tr>
                            <tr>
                                <td style="padding: 5px 10px; border: 1px solid #2c3e50; font-weight: bold; background-color: #f0f0f0;">M√™s/ano de verifica√ß√£o</td>
                                <td id="relCabMesAno" style="padding: 5px 10px; border: 1px solid #2c3e50;">-</td>
                            </tr>
                        </table>
                    </div>

                    <!-- Tabela de Ocorr√™ncias -->
                    <div style="margin-bottom: 20px;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                            <thead>
                                <tr>
                                    <th colspan="13" style="background-color: #2c3e50; color: white; padding: 8px; text-align: center; border: 1px solid #2c3e50;">
                                        OCORR√äNCIAS
                                    </th>
                                </tr>
                                <tr style="background-color: #34495e; color: white;">
                                    <th style="padding: 6px; border: 1px solid #2c3e50; text-align: left;">POSTO DE TRABALHO</th>
                                    <th style="padding: 6px; border: 1px solid #2c3e50; width: 40px; text-align: center;"></th>
                                    <th id="thImp01" style="padding: 6px; border: 1px solid #2c3e50; width: 35px; text-align: center;">01</th>
                                    <th id="thImp02" style="padding: 6px; border: 1px solid #2c3e50; width: 35px; text-align: center;">02</th>
                                    <th id="thImp03" style="padding: 6px; border: 1px solid #2c3e50; width: 35px; text-align: center;">03</th>
                                    <th id="thImp04" style="padding: 6px; border: 1px solid #2c3e50; width: 35px; text-align: center;">04</th>
                                    <th id="thImp05" style="padding: 6px; border: 1px solid #2c3e50; width: 35px; text-align: center;">05</th>
                                    <th id="thImp06" style="padding: 6px; border: 1px solid #2c3e50; width: 35px; text-align: center;">06</th>
                                    <th id="thImp07" style="padding: 6px; border: 1px solid #2c3e50; width: 35px; text-align: center;">07</th>
                                    <th id="thImp08" style="padding: 6px; border: 1px solid #2c3e50; width: 35px; text-align: center;">08</th>
                                    <th id="thImp09" style="padding: 6px; border: 1px solid #2c3e50; width: 35px; text-align: center;">09</th>
                                    <th id="thImp10" style="padding: 6px; border: 1px solid #2c3e50; width: 35px; text-align: center;">10</th>
                                </tr>
                            </thead>
                            <tbody id="tabelaOcorrenciasRelatorio">
                                <!-- Ser√° preenchido dinamicamente -->
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="13" style="padding: 0; border: 1px solid #2c3e50;">
                                        <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                                            <tr style="background-color: #ffffcc;">
                                                <td style="padding: 6px; border: 1px solid #2c3e50; font-weight: bold;">Total (+)</td>
                                                <td id="relTotal01" style="padding: 6px; border: 1px solid #2c3e50; text-align: center; width: 35px;">0</td>
                                                <td id="relTotal02" style="padding: 6px; border: 1px solid #2c3e50; text-align: center; width: 35px;">0</td>
                                                <td id="relTotal03" style="padding: 6px; border: 1px solid #2c3e50; text-align: center; width: 35px;">0</td>
                                                <td id="relTotal04" style="padding: 6px; border: 1px solid #2c3e50; text-align: center; width: 35px;">0</td>
                                                <td id="relTotal05" style="padding: 6px; border: 1px solid #2c3e50; text-align: center; width: 35px;">0</td>
                                                <td id="relTotal06" style="padding: 6px; border: 1px solid #2c3e50; text-align: center; width: 35px;">0</td>
                                                <td id="relTotal07" style="padding: 6px; border: 1px solid #2c3e50; text-align: center; width: 35px;">0</td>
                                                <td id="relTotal08" style="padding: 6px; border: 1px solid #2c3e50; text-align: center; width: 35px;">0</td>
                                                <td id="relTotal09" style="padding: 6px; border: 1px solid #2c3e50; text-align: center; width: 35px;">0</td>
                                                <td id="relTotal10" style="padding: 6px; border: 1px solid #2c3e50; text-align: center; width: 35px;">0</td>
                                            </tr>
                                            <tr>
                                                <td style="padding: 6px; border: 1px solid #2c3e50; font-weight: bold;">Toler√¢ncia (-)</td>
                                                <td id="relTolerancia01" style="padding: 6px; border: 1px solid #2c3e50; text-align: center;">0</td>
                                                <td id="relTolerancia02" style="padding: 6px; border: 1px solid #2c3e50; text-align: center;">0</td>
                                                <td id="relTolerancia03" style="padding: 6px; border: 1px solid #2c3e50; text-align: center;">0</td>
                                                <td id="relTolerancia04" style="padding: 6px; border: 1px solid #2c3e50; text-align: center;">0</td>
                                                <td id="relTolerancia05" style="padding: 6px; border: 1px solid #2c3e50; text-align: center;">0</td>
                                                <td id="relTolerancia06" style="padding: 6px; border: 1px solid #2c3e50; text-align: center;">0</td>
                                                <td id="relTolerancia07" style="padding: 6px; border: 1px solid #2c3e50; text-align: center;">0</td>
                                                <td id="relTolerancia08" style="padding: 6px; border: 1px solid #2c3e50; text-align: center;">0</td>
                                                <td id="relTolerancia09" style="padding: 6px; border: 1px solid #2c3e50; text-align: center;">0</td>
                                                <td id="relTolerancia10" style="padding: 6px; border: 1px solid #2c3e50; text-align: center;">0</td>
                                            </tr>
                                            <tr>
                                                <td style="padding: 6px; border: 1px solid #2c3e50; font-weight: bold;">Excesso Imperfei√ß√µes (=)</td>
                                                <td id="relExcesso01" style="padding: 6px; border: 1px solid #2c3e50; text-align: center;">0</td>
                                                <td id="relExcesso02" style="padding: 6px; border: 1px solid #2c3e50; text-align: center;">0</td>
                                                <td id="relExcesso03" style="padding: 6px; border: 1px solid #2c3e50; text-align: center;">0</td>
                                                <td id="relExcesso04" style="padding: 6px; border: 1px solid #2c3e50; text-align: center;">0</td>
                                                <td id="relExcesso05" style="padding: 6px; border: 1px solid #2c3e50; text-align: center;">0</td>
                                                <td id="relExcesso06" style="padding: 6px; border: 1px solid #2c3e50; text-align: center;">0</td>
                                                <td id="relExcesso07" style="padding: 6px; border: 1px solid #2c3e50; text-align: center;">0</td>
                                                <td id="relExcesso08" style="padding: 6px; border: 1px solid #2c3e50; text-align: center;">0</td>
                                                <td id="relExcesso09" style="padding: 6px; border: 1px solid #2c3e50; text-align: center;">0</td>
                                                <td id="relExcesso10" style="padding: 6px; border: 1px solid #2c3e50; text-align: center;">0</td>
                                            </tr>
                                            <tr>
                                                <td style="padding: 6px; border: 1px solid #2c3e50; font-weight: bold;">Multiplicador (x)</td>
                                                <td id="relMultiplicador01" style="padding: 6px; border: 1px solid #2c3e50; text-align: center;">0</td>
                                                <td id="relMultiplicador02" style="padding: 6px; border: 1px solid #2c3e50; text-align: center;">0</td>
                                                <td id="relMultiplicador03" style="padding: 6px; border: 1px solid #2c3e50; text-align: center;">0</td>
                                                <td id="relMultiplicador04" style="padding: 6px; border: 1px solid #2c3e50; text-align: center;">0</td>
                                                <td id="relMultiplicador05" style="padding: 6px; border: 1px solid #2c3e50; text-align: center;">0</td>
                                                <td id="relMultiplicador06" style="padding: 6px; border: 1px solid #2c3e50; text-align: center;">0</td>
                                                <td id="relMultiplicador07" style="padding: 6px; border: 1px solid #2c3e50; text-align: center;">0</td>
                                                <td id="relMultiplicador08" style="padding: 6px; border: 1px solid #2c3e50; text-align: center;">0</td>
                                                <td id="relMultiplicador09" style="padding: 6px; border: 1px solid #2c3e50; text-align: center;">0</td>
                                                <td id="relMultiplicador10" style="padding: 6px; border: 1px solid #2c3e50; text-align: center;">0</td>
                                            </tr>
                                            <tr>
                                                <td style="padding: 6px; border: 1px solid #2c3e50; font-weight: bold;">N√∫mero Corrigido (=)</td>
                                                <td id="relCorrigido01" style="padding: 6px; border: 1px solid #2c3e50; text-align: center;">0</td>
                                                <td id="relCorrigido02" style="padding: 6px; border: 1px solid #2c3e50; text-align: center;">0</td>
                                                <td id="relCorrigido03" style="padding: 6px; border: 1px solid #2c3e50; text-align: center;">0</td>
                                                <td id="relCorrigido04" style="padding: 6px; border: 1px solid #2c3e50; text-align: center;">0</td>
                                                <td id="relCorrigido05" style="padding: 6px; border: 1px solid #2c3e50; text-align: center;">0</td>
                                                <td id="relCorrigido06" style="padding: 6px; border: 1px solid #2c3e50; text-align: center;">0</td>
                                                <td id="relCorrigido07" style="padding: 6px; border: 1px solid #2c3e50; text-align: center;">0</td>
                                                <td id="relCorrigido08" style="padding: 6px; border: 1px solid #2c3e50; text-align: center;">0</td>
                                                <td id="relCorrigido09" style="padding: 6px; border: 1px solid #2c3e50; text-align: center;">0</td>
                                                <td id="relCorrigido10" style="padding: 6px; border: 1px solid #2c3e50; text-align: center;">0</td>
                                            </tr>
                                            <tr style="background-color: #ffffcc;">
                                                <td colspan="10" style="padding: 6px; border: 1px solid #2c3e50; font-weight: bold; text-align: right;">
                                                    Somat√≥rio dos N√∫meros Corrigidos (Fator de Aceita√ß√£o)
                                                </td>
                                                <td id="relSomatorioFator" style="padding: 6px; border: 1px solid #2c3e50; text-align: center; font-weight: bold;">0</td>
                                            </tr>
                                        </table>
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <!-- Tabela de Faixas -->
                    <div style="margin-bottom: 20px;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                            <thead>
                                <tr style="background-color: #34495e; color: white;">
                                    <th style="padding: 6px; border: 1px solid #2c3e50; text-align: center;">Faixa</th>
                                    <th style="padding: 6px; border: 1px solid #2c3e50; text-align: center;">Fator de Aceita√ß√£o</th>
                                    <th style="padding: 6px; border: 1px solid #2c3e50; text-align: center;">Valor Mensal a Receber</th>
                                    <th style="padding: 6px; border: 1px solid #2c3e50; text-align: center;">Percentual de Glosa</th>
                                </tr>
                            </thead>
                            <tbody id="tabelaFaixas">
                                <!-- Ser√° preenchido dinamicamente -->
                            </tbody>
                            <tfoot>
                                <tr style="background-color: #ffffcc;">
                                    <td colspan="4" style="padding: 6px; border: 1px solid #2c3e50; text-align: center; font-weight: bold;">
                                        Faixa Alcan√ßada no M√™s de Refer√™ncia: <span id="relFaixaAlcancada">-</span>
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <!-- Tabela de Glosa -->
                    <div style="margin-bottom: 20px;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                            <tr>
                                <td style="padding: 8px; border: 1px solid #2c3e50; font-weight: bold; width: 200px; background-color: #f0f0f0;">
                                    Houve Glosa
                                </td>
                                <td id="relHouveGlosa" style="padding: 8px; border: 1px solid #2c3e50; text-align: center; font-weight: bold;">
                                    N√ÉO
                                </td>
                                <td rowspan="3" style="padding: 8px; border: 1px solid #2c3e50; text-align: center; vertical-align: middle; font-weight: bold;">
                                    Fator Percentual de Recebimento e Remunera√ß√£o de Servi√ßos
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #2c3e50; font-weight: bold; background-color: #f0f0f0;">
                                    Percentual de Glosa
                                </td>
                                <td id="relPercentualGlosa" style="padding: 8px; border: 1px solid #2c3e50; text-align: center; font-weight: bold; font-size: 16px; color: #e74c3c;">
                                    0,00%
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #2c3e50; font-weight: bold; background-color: #f0f0f0;">
                                    Percentual do Total a Receber
                                </td>
                                <td id="relPercentualReceber" style="padding: 8px; border: 1px solid #2c3e50; text-align: center; font-weight: bold; font-size: 16px; color: #27ae60; background-color: #ffccff;">
                                    100,00%
                                </td>
                            </tr>
                        </table>
                    </div>

                    <!-- Tabela de Localidades -->
                    <div style="margin-bottom: 20px;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                            <thead>
                                <tr style="background-color: #34495e; color: white;">
                                    <th rowspan="2" style="padding: 6px; border: 1px solid #2c3e50; text-align: center;">LOCALIDADE</th>
                                    <th rowspan="2" style="padding: 6px; border: 1px solid #2c3e50; text-align: center; width: 60px;">POSTO</th>
                                    <th colspan="2" style="padding: 6px; border: 1px solid #2c3e50; text-align: center;">Valor de Refer√™ncia</th>
                                    <th colspan="2" style="padding: 6px; border: 1px solid #2c3e50; text-align: center;">Valor Devido</th>
                                </tr>
                                <tr style="background-color: #34495e; color: white;">
                                    <th style="padding: 6px; border: 1px solid #2c3e50; text-align: center; width: 120px;">Valor Mensal</th>
                                    <th style="padding: 6px; border: 1px solid #2c3e50; text-align: center; width: 120px;">Valor Total</th>
                                    <th style="padding: 6px; border: 1px solid #2c3e50; text-align: center; width: 120px;">Valor Mensal</th>
                                    <th style="padding: 6px; border: 1px solid #2c3e50; text-align: center; width: 120px;">Valor Total</th>
                                </tr>
                            </thead>
                            <tbody id="tabelaLocalidades">
                                <!-- Ser√° preenchido dinamicamente -->
                            </tbody>
                            <tfoot style="background-color: #34495e; color: white; font-weight: bold;">
                                <tr>
                                    <td style="padding: 8px; border: 1px solid #2c3e50; text-align: right;">TOTAL</td>
                                    <td id="relTotalPosto" style="padding: 8px; border: 1px solid #2c3e50; text-align: center;">0</td>
                                    <td id="relTotalRefMensal" style="padding: 8px; border: 1px solid #2c3e50; text-align: right;">R$ 0,00</td>
                                    <td id="relTotalRefTotal" style="padding: 8px; border: 1px solid #2c3e50; text-align: right;">R$ 0,00</td>
                                    <td id="relTotalDevMensal" style="padding: 8px; border: 1px solid #2c3e50; text-align: right; color: #3498db;">R$ 0,00</td>
                                    <td id="relTotalDevTotal" style="padding: 8px; border: 1px solid #2c3e50; text-align: right; color: #3498db;">R$ 0,00</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <!-- Valores Finais -->
                    <div style="margin-bottom: 20px;">
                        <table style="width: 50%; border-collapse: collapse; font-size: 11px; margin-left: auto;">
                            <tr>
                                <td style="padding: 8px; border: 1px solid #2c3e50; font-weight: bold; background-color: #f0f0f0;">
                                    Valor Mensal a Receber
                                </td>
                                <td id="relValorMensalReceber" style="padding: 8px; border: 1px solid #2c3e50; text-align: right; font-weight: bold; color: #27ae60;">
                                    R$ 0,00
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #2c3e50; font-weight: bold; background-color: #f0f0f0;">
                                    Valor da Glosa
                                </td>
                                <td id="relValorGlosa" style="padding: 8px; border: 1px solid #2c3e50; text-align: right; font-weight: bold; color: #e74c3c;">
                                    R$ 0,00
                                </td>
                            </tr>
                        </table>
                    </div>

                    <!-- Observa√ß√µes e Gestor -->
                    <div style="margin-bottom: 20px;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                            <tr>
                                <td style="padding: 10px; border: 1px solid #2c3e50; font-weight: bold; background-color: #f0f0f0;">
                                    Observa√ß√µes:
                                </td>
                            </tr>
                            <tr>
                                <td id="relObservacoes" style="padding: 10px; border: 1px solid #2c3e50; min-height: 80px; white-space: pre-line;">
                                    &nbsp;
                                </td>
                            </tr>
                        </table>
                    </div>

                    <div>
                        <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                            <tr>
                                <td style="padding: 8px; border: 1px solid #2c3e50; font-weight: bold; width: 180px; background-color: #f0f0f0;">
                                    Gestor do Contrato:
                                </td>
                                <td id="relGestor" style="padding: 8px; border: 1px solid #2c3e50;">
                                    -
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border: 1px solid #2c3e50; font-weight: bold; background-color: #f0f0f0;">
                                    Unidade:
                                </td>
                                <td id="relUnidade" style="padding: 8px; border: 1px solid #2c3e50;">
                                    -
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>


            
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="fecharModalRelatorioFiscalizacao()">Fechar</button>
                <button id="btnVisualizarPDF" class="btn btn-success" onclick="visualizarPDFRelatorio()" style="display: none;">
                    üñ®Ô∏è Visualizar / Imprimir PDF
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Visualizador de PDF do Relat√≥rio -->
    <div id="modalRelatorioPdf" class="modal-relatorio-pdf">
        <div class="modal-relatorio-pdf-content">
            <div class="modal-relatorio-pdf-header">
                <h5>üìÑ Relat√≥rio de Fiscaliza√ß√£o - PDF</h5>
                <button class="modal-relatorio-pdf-close" onclick="fecharModalRelatorioPdf()">&times;</button>
            </div>
            <div class="modal-relatorio-pdf-body">
                <iframe id="iframeRelatorioPdf" src=""></iframe>
            </div>
        </div>
    </div>
    
    <!-- Modal de Nova/Edi√ß√£o Ocorr√™ncia -->
    <div id="modalFormOcorrencia" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 id="tituloFormOcorrencia">Nova Ocorr√™ncia</h2>
                <span class="close" onclick="fecharModalFormOcorrencia()">&times;</span>
            </div>
            <form id="formOcorrencia">
                <div class="modal-body">
                    <input type="hidden" id="idOcorrencia" name="id_ocorrencia">
                    <input type="hidden" id="idContratoOcorrencia" name="id_contrato">

                    <div class="form-row form-row-2">
                        <div class="form-group">
                            <label for="idMotoristaOcorrencia">Motorista: *</label>
                            <select id="idMotoristaOcorrencia" name="id_motorista" required>
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="dataOcorrencia">Data da Ocorr√™ncia: *</label>
                            <input type="date" id="dataOcorrencia" name="data_ocorrencia" required>
                        </div>
                    </div>

                    <!-- Compet√™ncia -->
                    <fieldset class="fieldset-competencia">
                        <legend>Compet√™ncia</legend>
                        <div class="form-row form-row-ano-mes">
                            <div class="form-group">
                                <label for="mesCompetencia">M√™s: *</label>
                                <select id="mesCompetencia" name="mes_competencia" required>
                                    <option value="">Selecione...</option>
                                    <option value="Janeiro">Janeiro</option>
                                    <option value="Fevereiro">Fevereiro</option>
                                    <option value="Mar√ßo">Mar√ßo</option>
                                    <option value="Abril">Abril</option>
                                    <option value="Maio">Maio</option>
                                    <option value="Junho">Junho</option>
                                    <option value="Julho">Julho</option>
                                    <option value="Agosto">Agosto</option>
                                    <option value="Setembro">Setembro</option>
                                    <option value="Outubro">Outubro</option>
                                    <option value="Novembro">Novembro</option>
                                    <option value="Dezembro">Dezembro</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="anoCompetencia">Ano: *</label>
                                <select id="anoCompetencia" name="ano_competencia" class="input-ano" required>
                                    <!-- Ser√° preenchido dinamicamente -->
                                </select>
                            </div>
                        </div>
                    </fieldset>

                    <div class="form-group">
                        <label for="idImperfeicao">Tipo de Imperfei√ß√£o: *</label>
                        <select id="idImperfeicao" name="id_imperfeicao" required>
                            <option value="">Selecione...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="especificacao">Especifica√ß√£o da Ocorr√™ncia:</label>
                        <textarea id="especificacao" name="especificacao" rows="4"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="fecharModalFormOcorrencia()">Cancelar</button>
                    <button type="submit" class="btn btn-success">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- jQuery (necess√°rio para o Select2) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Carregador do Menu -->
    <script src="/static/js/menu-loader.js"></script>

    <script>
        let contratoSelecionado = null;
        let motoristasContrato = [];

        // Carregar contratos ao iniciar
        window.addEventListener('DOMContentLoaded', async function() {
            await carregarContratos();
            
            // Definir m√™s e ano atual nos filtros
            const hoje = new Date();
            const anoAtual = hoje.getFullYear();
            
            document.getElementById('filtroMes').value = String(hoje.getMonth() + 1).padStart(2, '0');
            
            // Preencher select de anos do filtro (2025 at√© ano atual)
            preencherSelectAnos('filtroAno', anoAtual);
            document.getElementById('filtroAno').value = anoAtual;
            
            // Preencher select de anos de compet√™ncia
            preencherSelectAnos('anoCompetencia', anoAtual);
        });

        function preencherSelectAnos(selectId, anoAtual) {
            const select = document.getElementById(selectId);
            select.innerHTML = '';
            
            for (let ano = 2025; ano <= anoAtual; ano++) {
                const option = document.createElement('option');
                option.value = ano;
                option.textContent = ano;
                select.appendChild(option);
            }
        }

        async function carregarContratos() {
            try {
                const response = await fetch('/api/gestao-terceirizados/contratos');
                const result = await response.json();

                const tbody = document.getElementById('tabelaContratos');
                tbody.innerHTML = '';

                if (result.success && result.data.length > 0) {
                    result.data.forEach(contrato => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${contrato.EXERCICIO}</td>
                            <td>${contrato.NM_FORNECEDOR}</td>
                            <td>${contrato.CONTRATO || '-'}</td>
                            <td>${contrato.PROCESSO || '-'}</td>
                            <td class="text-center">
                                <button class="btn btn-primary btn-sm" onclick="selecionarContrato(${contrato.ID_CONTRATO})">
                                    Selecionar
                                </button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center" style="padding: 30px; color: #999;">Nenhum contrato encontrado</td></tr>';
                }
            } catch (error) {
                console.error('Erro ao carregar contratos:', error);
                alert('Erro ao carregar contratos');
            }
        }

        async function selecionarContrato(idContrato) {
            try {
                const response = await fetch(`/api/gestao-terceirizados/contratos/${idContrato}`);
                const result = await response.json();

                if (result.success) {
                    contratoSelecionado = result.data;
                    
                    // Atualizar informa√ß√µes do contrato
                    document.getElementById('infoExercicio').textContent = contratoSelecionado.EXERCICIO;
                    document.getElementById('infoEmpresa').textContent = contratoSelecionado.NM_FORNECEDOR;
                    document.getElementById('infoContrato').textContent = contratoSelecionado.CONTRATO || '-';
                    document.getElementById('infoProcesso').textContent = contratoSelecionado.PROCESSO || '-';

                    // Trocar se√ß√µes
                    document.getElementById('contratoSection').style.display = 'none';
                    document.getElementById('vinculosSection').style.display = 'block';

                    // Carregar v√≠nculos
                    await carregarVinculos(idContrato);
                } else {
                    alert('Erro ao carregar dados do contrato');
                }
            } catch (error) {
                console.error('Erro ao selecionar contrato:', error);
                alert('Erro ao selecionar contrato');
            }
        }

        async function carregarVinculos(idContrato) {
            try {
                const response = await fetch(`/api/gestao-terceirizados/vinculos/${idContrato}`);
                const result = await response.json();

                const tbody = document.getElementById('tabelaVinculos');
                tbody.innerHTML = '';

                if (result.success && result.data.length > 0) {
                    motoristasContrato = result.data;
                    result.data.forEach(vinculo => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${vinculo.NM_MOTORISTA}</td>
                            <td>${vinculo.DE_POSTO}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="2" class="text-center" style="padding: 30px; color: #999;">Nenhum v√≠nculo encontrado</td></tr>';
                }
            } catch (error) {
                console.error('Erro ao carregar v√≠nculos:', error);
                alert('Erro ao carregar v√≠nculos');
            }
        }

        function voltarSelecaoContrato() {
            contratoSelecionado = null;
            motoristasContrato = [];
            document.getElementById('contratoSection').style.display = 'block';
            document.getElementById('vinculosSection').style.display = 'none';
        }

        async function abrirModalOcorrencias() {
            if (!contratoSelecionado) {
                alert('Selecione um contrato primeiro');
                return;
            }

            document.getElementById('modalOcorrencias').classList.add('active');
            await carregarOcorrencias();
        }

        function fecharModalOcorrencias() {
            document.getElementById('modalOcorrencias').classList.remove('active');
        }

        async function carregarOcorrencias() {
            if (!contratoSelecionado) return;

            const mes = document.getElementById('filtroMes').value;
            const ano = document.getElementById('filtroAno').value;

            try {
                const response = await fetch(`/api/gestao-terceirizados/ocorrencias/${contratoSelecionado.ID_CONTRATO}?mes=${mes}&ano=${ano}`);
                const result = await response.json();

                const tbody = document.getElementById('tabelaOcorrenciasLista');
                tbody.innerHTML = '';

                if (result.success && result.data.length > 0) {
                    result.data.forEach(ocorrencia => {
                        const tr = document.createElement('tr');
                        // Formatar data corretamente
                        let dataFormatada = '-';
                        if (ocorrencia.DATA_OCORRENCIA) {
                            // Converter para string caso venha como Date object
                            let dataStr = String(ocorrencia.DATA_OCORRENCIA);
                            // Pegar apenas a parte da data (YYYY-MM-DD) caso tenha hora
                            if (dataStr.includes('T')) {
                                dataStr = dataStr.split('T')[0];
                            } else if (dataStr.includes(' ')) {
                                dataStr = dataStr.split(' ')[0];
                            }
                            // Dividir a data
                            const partesData = dataStr.split('-');
                            if (partesData.length === 3) {
                                dataFormatada = `${partesData[2]}/${partesData[1]}/${partesData[0]}`;
                            }
                        }
                        
                        // Formatar compet√™ncia
                        const competencia = ocorrencia.MES && ocorrencia.ANO 
                            ? `${ocorrencia.MES}/${ocorrencia.ANO}` 
                            : '-';
                        
                        tr.innerHTML = `
                            <td>${competencia}</td>
                            <td>${dataFormatada}</td>
                            <td>${ocorrencia.NM_MOTORISTA || '-'}</td>
                            <td>${ocorrencia.DESCRICAO}</td>
                            <td>${ocorrencia.ESPECIFICACAO || '-'}</td>
                            <td class="text-center">
                                <button class="btn btn-warning btn-sm" onclick="editarOcorrencia(${ocorrencia.ID_OCORRENCIA})">
                                    Editar
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="excluirOcorrencia(${ocorrencia.ID_OCORRENCIA})">
                                    Excluir
                                </button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center" style="padding: 30px; color: #999;">Nenhuma ocorr√™ncia encontrada</td></tr>';
                }
            } catch (error) {
                console.error('Erro ao carregar ocorr√™ncias:', error);
                alert('Erro ao carregar ocorr√™ncias');
            }
        }

        async function abrirModalNovaOcorrencia() {
            document.getElementById('tituloFormOcorrencia').textContent = 'Nova Ocorr√™ncia';
            document.getElementById('formOcorrencia').reset();
            document.getElementById('idOcorrencia').value = '';
            document.getElementById('idContratoOcorrencia').value = contratoSelecionado.ID_CONTRATO;

            // Preencher ano de compet√™ncia com ano atual
            const anoAtual = new Date().getFullYear();
            document.getElementById('anoCompetencia').value = anoAtual;

            // Carregar motoristas
            await carregarMotoristas();
            
            // Carregar imperfei√ß√µes
            await carregarImperfeicoes();

            document.getElementById('modalFormOcorrencia').classList.add('active');
        }

        async function carregarMotoristas() {
            const select = document.getElementById('idMotoristaOcorrencia');
            select.innerHTML = '<option value="">Selecione...</option>';

            motoristasContrato.forEach(motorista => {
                const option = document.createElement('option');
                option.value = motorista.ID_MOTORISTA;
                option.textContent = motorista.NM_MOTORISTA;
                select.appendChild(option);
            });
        }

        async function carregarImperfeicoes() {
            try {
                const response = await fetch('/api/gestao-terceirizados/imperfeicoes');
                const result = await response.json();

                const select = document.getElementById('idImperfeicao');
                select.innerHTML = '<option value="">Selecione...</option>';

                if (result.success && result.data.length > 0) {
                    result.data.forEach(imp => {
                        const option = document.createElement('option');
                        option.value = imp.ID_IMPERFEICAO;
                        option.textContent = imp.DESCRICAO;
                        select.appendChild(option);
                    });
                }

                // Destruir Select2 anterior se existir
                if ($(select).data('select2')) {
                    $(select).select2('destroy');
                }

                // Inicializar Select2 com configura√ß√µes
                $(select).select2({
                    dropdownParent: $('#modalFormOcorrencia'),
                    width: '100%',
                    placeholder: 'Selecione...',
                    allowClear: true,
                    language: {
                        noResults: function() {
                            return "Nenhum resultado encontrado";
                        },
                        searching: function() {
                            return "Buscando...";
                        }
                    }
                });

            } catch (error) {
                console.error('Erro ao carregar imperfei√ß√µes:', error);
            }
        }

        function fecharModalFormOcorrencia() {
            // Destruir Select2 antes de fechar o modal
            if ($('#idImperfeicao').data('select2')) {
                $('#idImperfeicao').select2('destroy');
            }
            document.getElementById('modalFormOcorrencia').classList.remove('active');
        }

        document.getElementById('formOcorrencia').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = {
                id_ocorrencia: document.getElementById('idOcorrencia').value,
                id_contrato: document.getElementById('idContratoOcorrencia').value,
                id_motorista: document.getElementById('idMotoristaOcorrencia').value,
                id_imperfeicao: document.getElementById('idImperfeicao').value,
                data_ocorrencia: document.getElementById('dataOcorrencia').value,
                mes_competencia: document.getElementById('mesCompetencia').value,
                ano_competencia: document.getElementById('anoCompetencia').value,
                especificacao: document.getElementById('especificacao').value
            };

            try {
                const url = formData.id_ocorrencia 
                    ? `/api/gestao-terceirizados/ocorrencias/${formData.id_ocorrencia}`
                    : '/api/gestao-terceirizados/ocorrencias';
                
                const method = formData.id_ocorrencia ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (result.success) {
                    alert(formData.id_ocorrencia ? 'Ocorr√™ncia atualizada com sucesso!' : 'Ocorr√™ncia cadastrada com sucesso!');
                    fecharModalFormOcorrencia();
                    await carregarOcorrencias();
                } else {
                    alert('Erro ao salvar ocorr√™ncia: ' + result.error);
                }
            } catch (error) {
                console.error('Erro ao salvar ocorr√™ncia:', error);
                alert('Erro ao salvar ocorr√™ncia');
            }
        });

        async function editarOcorrencia(idOcorrencia) {
            try {
                const response = await fetch(`/api/gestao-terceirizados/ocorrencias/detalhe/${idOcorrencia}`);
                const result = await response.json();

                if (result.success) {
                    const ocorrencia = result.data;
                    
                    document.getElementById('tituloFormOcorrencia').textContent = 'Editar Ocorr√™ncia';
                    document.getElementById('idOcorrencia').value = ocorrencia.ID_OCORRENCIA;
                    document.getElementById('idContratoOcorrencia').value = ocorrencia.ID_CONTRATO;
                    
                    await carregarMotoristas();
                    document.getElementById('idMotoristaOcorrencia').value = ocorrencia.ID_MOTORISTA;
                    
                    await carregarImperfeicoes();
                    // Usar Select2 para setar o valor
                    $('#idImperfeicao').val(ocorrencia.ID_IMPERFEICAO).trigger('change');
                    
                    document.getElementById('dataOcorrencia').value = ocorrencia.DATA_OCORRENCIA;
                    document.getElementById('mesCompetencia').value = ocorrencia.MES || '';
                    document.getElementById('anoCompetencia').value = ocorrencia.ANO || new Date().getFullYear();
                    document.getElementById('especificacao').value = ocorrencia.ESPECIFICACAO || '';

                    document.getElementById('modalFormOcorrencia').classList.add('active');
                } else {
                    alert('Erro ao carregar dados da ocorr√™ncia');
                }
            } catch (error) {
                console.error('Erro ao editar ocorr√™ncia:', error);
                alert('Erro ao editar ocorr√™ncia');
            }
        }

        async function excluirOcorrencia(idOcorrencia) {
            if (!confirm('Deseja realmente excluir esta ocorr√™ncia?')) {
                return;
            }

            try {
                const response = await fetch(`/api/gestao-terceirizados/ocorrencias/${idOcorrencia}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    alert('Ocorr√™ncia exclu√≠da com sucesso!');
                    await carregarOcorrencias();
                } else {
                    alert('Erro ao excluir ocorr√™ncia: ' + result.error);
                }
            } catch (error) {
                console.error('Erro ao excluir ocorr√™ncia:', error);
                alert('Erro ao excluir ocorr√™ncia');
            }
        }

        // ===================================
        // RELAT√ìRIO DE FISCALIZA√á√ÉO
        // ===================================
        
        function abrirModalRelatorioFiscalizacao() {
            if (!contratoSelecionado) {
                alert('Selecione um contrato primeiro!');
                return;
            }

            // Preencher anos
            preencherAnosRelatorio();

            // Definir m√™s e ano atual
            const dataAtual = new Date();
            const mesAtual = dataAtual.getMonth(); // 0-11
            const anoAtual = dataAtual.getFullYear();

            document.getElementById('relatorioMes').selectedIndex = mesAtual;
            document.getElementById('relatorioAno').value = anoAtual;

            // Limpar conte√∫do anterior
            document.getElementById('conteudoRelatorio').style.display = 'none';

            document.getElementById('modalRelatorioFiscalizacao').classList.add('active');
        }

        function fecharModalRelatorioFiscalizacao() {
            document.getElementById('modalRelatorioFiscalizacao').classList.remove('active');
        }

        function preencherAnosRelatorio() {
            const selectAno = document.getElementById('relatorioAno');
            selectAno.innerHTML = '';

            const anoAtual = new Date().getFullYear();
            for (let ano = 2025; ano <= anoAtual; ano++) {
                const option = document.createElement('option');
                option.value = ano;
                option.textContent = ano;
                selectAno.appendChild(option);
            }
        }

        async function gerarRelatorioFiscalizacao() {
            const mes = document.getElementById('relatorioMes').value;
            const ano = document.getElementById('relatorioAno').value;

            if (!contratoSelecionado) {
                alert('Selecione um contrato primeiro!');
                return;
            }

            // ‚úÖ MOSTRAR LOADING
            document.getElementById('loadingOverlay').classList.add('active');

            try {
                const response = await fetch('/api/gestao-terceirizados/relatorio-fiscalizacao', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        id_contrato: contratoSelecionado.ID_CONTRATO,
                        mes: mes,
                        ano: ano
                    })
                });

                const result = await response.json();

                if (result.success) {
                    dadosRelatorioAtual = {
                        id_contrato: contratoSelecionado.ID_CONTRATO,
                        mes: mes,
                        ano: ano
                    };
                    
                    preencherRelatorio(result.data);
                    document.getElementById('conteudoRelatorio').style.display = 'block';
                    document.getElementById('btnVisualizarPDF').style.display = 'inline-block';
                } else {
                    alert('Erro ao gerar relat√≥rio: ' + result.error);
                }
            } catch (error) {
                console.error('Erro ao gerar relat√≥rio:', error);
                alert('Erro ao gerar relat√≥rio');
            } finally {
                // ‚úÖ ESCONDER LOADING
                document.getElementById('loadingOverlay').classList.remove('active');
            }
        }

        // ‚úÖ NOVA FUN√á√ÉO: Formatar valor em BRL
        function formatarMoedaBRL(valor) {
            return valor.toLocaleString('pt-BR', {
                style: 'currency',
                currency: 'BRL',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function preencherRelatorio(data) {
            // Cabe√ßalho
            document.getElementById('relCabContrato').textContent = data.cabecalho.contrato || '-';
            document.getElementById('relCabProtocolo').textContent = data.cabecalho.protocolo || '-';
            document.getElementById('relCabContratada').textContent = data.cabecalho.contratada || '-';
            document.getElementById('relCabObjeto').textContent = data.cabecalho.objeto || '-';
            document.getElementById('relCabMesAno').textContent = data.cabecalho.mes_ano || '-';

            // Cabe√ßalhos das imperfei√ß√µes (colunas 01-10)
            data.imperfeicoes.forEach((imp, index) => {
                const colNum = String(imp.id).padStart(2, '0');
                const th = document.getElementById(`thImp${colNum}`);
                if (th) {
                    th.title = imp.descricao;
                }
            });

            // Tabela de ocorr√™ncias por posto
            const tbody = document.getElementById('tabelaOcorrenciasRelatorio');
            tbody.innerHTML = '';

            data.postos.forEach(posto => {
                const tr = document.createElement('tr');
                
                // Nome do posto
                const tdPosto = document.createElement('td');
                tdPosto.style.padding = '6px';
                tdPosto.style.border = '1px solid #2c3e50';
                tdPosto.textContent = posto.nome_posto;
                tr.appendChild(tdPosto);

                // Quantidade
                const tdQtd = document.createElement('td');
                tdQtd.style.padding = '6px';
                tdQtd.style.border = '1px solid #2c3e50';
                tdQtd.style.textAlign = 'center';
                tdQtd.textContent = posto.qtd_motoristas_total;
                tr.appendChild(tdQtd);

                // Ocorr√™ncias (colunas 01-10)
                for (let i = 1; i <= 10; i++) {
                    const td = document.createElement('td');
                    td.style.padding = '6px';
                    td.style.border = '1px solid #2c3e50';
                    td.style.textAlign = 'center';
                    td.textContent = posto.ocorrencias[i] || 0;
                    tr.appendChild(td);
                }

                tbody.appendChild(tr);
            });

            // C√°lculos por coluna (Total, Toler√¢ncia, Excesso, Multiplicador, Corrigido)
            const totaisPorColuna = {};
            for (let i = 1; i <= 10; i++) {
                totaisPorColuna[i] = 0;
            }

            data.postos.forEach(posto => {
                for (let i = 1; i <= 10; i++) {
                    totaisPorColuna[i] += posto.ocorrencias[i] || 0;
                }
            });

            // Preencher totais, toler√¢ncias e c√°lculos
            data.imperfeicoes.forEach((imp, index) => {
                const colNum = String(imp.id).padStart(2, '0');
                const total = totaisPorColuna[imp.id] || 0;
                const tolerancia = imp.tolerancia;
                const excesso = Math.max(0, total - tolerancia);
                const multiplicador = imp.multiplicador;
                const corrigido = excesso * multiplicador;

                document.getElementById(`relTotal${colNum}`).textContent = total;
                document.getElementById(`relTolerancia${colNum}`).textContent = tolerancia;
                document.getElementById(`relExcesso${colNum}`).textContent = excesso;
                document.getElementById(`relMultiplicador${colNum}`).textContent = multiplicador;
                document.getElementById(`relCorrigido${colNum}`).textContent = corrigido;
            });

            // Somat√≥rio do fator
            document.getElementById('relSomatorioFator').textContent = data.somatorio_fator;

            // Tabela de faixas
            const tabelaFaixas = document.getElementById('tabelaFaixas');
            tabelaFaixas.innerHTML = '';

            data.faixas.forEach(faixa => {
                const tr = document.createElement('tr');
                
                // Destacar faixa alcan√ßada
                if (faixa.nome === data.faixa_alcancada) {
                    tr.style.backgroundColor = '#ffcccc';
                    tr.style.fontWeight = 'bold';
                }

                tr.innerHTML = `
                    <td style="padding: 6px; border: 1px solid #2c3e50; text-align: center;">${faixa.nome}</td>
                    <td style="padding: 6px; border: 1px solid #2c3e50; text-align: center;">
                        ${faixa.min} a ${faixa.max}
                    </td>
                    <td style="padding: 6px; border: 1px solid #2c3e50; text-align: center;">
                        ${faixa.percentual_receber}% do Valor Mensal
                    </td>
                    <td style="padding: 6px; border: 1px solid #2c3e50; text-align: center;">
                        ${faixa.percentual_glosa}%
                    </td>
                `;
                tabelaFaixas.appendChild(tr);
            });

            document.getElementById('relFaixaAlcancada').textContent = data.faixa_alcancada;

            // Informa√ß√µes de glosa
            document.getElementById('relHouveGlosa').textContent = data.houve_glosa ? 'SIM' : 'N√ÉO';
            document.getElementById('relPercentualGlosa').textContent = data.percentual_glosa.toFixed(2).replace('.', ',') + '%';
            document.getElementById('relPercentualReceber').textContent = data.percentual_receber.toFixed(2).replace('.', ',') + '%';

            // Tabela de localidades
            const tabelaLocalidades = document.getElementById('tabelaLocalidades');
            tabelaLocalidades.innerHTML = '';

            let totalPostos = 0;
            let totalRefMensal = 0;
            let totalRefTotal = 0;
            let totalDevMensal = 0;
            let totalDevTotal = 0;

            data.localidades.forEach(loc => {
                const tr = document.createElement('tr');
                
                const nomePosto = loc.tem_asterisco ? `${loc.nome} (*)` : loc.nome;

                // ‚úÖ USAR FORMATA√á√ÉO BRL
                tr.innerHTML = `
                    <td style="padding: 6px; border: 1px solid #2c3e50;">${nomePosto}</td>
                    <td style="padding: 6px; border: 1px solid #2c3e50; text-align: center;">${loc.qtd_posto}</td>
                    <td style="padding: 6px; border: 1px solid #2c3e50; text-align: right;">${formatarMoedaBRL(loc.valor_ref_mensal)}</td>
                    <td style="padding: 6px; border: 1px solid #2c3e50; text-align: right;">${formatarMoedaBRL(loc.valor_ref_total)}</td>
                    <td style="padding: 6px; border: 1px solid #2c3e50; text-align: right; color: #3498db; font-weight: bold;">${formatarMoedaBRL(loc.valor_dev_mensal)}</td>
                    <td style="padding: 6px; border: 1px solid #2c3e50; text-align: right; color: #3498db; font-weight: bold;">${formatarMoedaBRL(loc.valor_dev_total)}</td>
                `;
                tabelaLocalidades.appendChild(tr);

                totalPostos += loc.qtd_posto;
                totalRefMensal += loc.valor_ref_mensal;
                totalRefTotal += loc.valor_ref_total;
                totalDevMensal += loc.valor_dev_mensal;
                totalDevTotal += loc.valor_dev_total;
            });

            // Totais - ‚úÖ USAR FORMATA√á√ÉO BRL
            document.getElementById('relTotalPosto').textContent = totalPostos;
            document.getElementById('relTotalRefMensal').textContent = formatarMoedaBRL(totalRefMensal);
            document.getElementById('relTotalRefTotal').textContent = formatarMoedaBRL(totalRefTotal);
            document.getElementById('relTotalDevMensal').textContent = formatarMoedaBRL(totalDevMensal);
            document.getElementById('relTotalDevTotal').textContent = formatarMoedaBRL(totalDevTotal);

            // Valores finais - ‚úÖ USAR FORMATA√á√ÉO BRL
            document.getElementById('relValorMensalReceber').textContent = formatarMoedaBRL(data.totais.valor_devido_total);
            document.getElementById('relValorGlosa').textContent = formatarMoedaBRL(data.totais.valor_glosa);

            // ‚úÖ NOVA FUNCIONALIDADE: Preencher observa√ß√µes dos motoristas parciais
            const observacoesDiv = document.getElementById('relObservacoes');
            if (data.observacoes_parciais && data.observacoes_parciais.length > 0) {
                let textoObservacoes = '';
                data.observacoes_parciais.forEach(obs => {
                    textoObservacoes += `${obs.posto} (*): ${obs.nome} - ${obs.dias} dias trabalhados - ${formatarMoedaBRL(obs.valor)}\\n`;
                });
                observacoesDiv.textContent = textoObservacoes;
            } else {
                observacoesDiv.innerHTML = '&nbsp;';
            }

            // Gestor e unidade
            document.getElementById('relGestor').textContent = data.cabecalho.gestor || '-';
            document.getElementById('relUnidade').textContent = data.cabecalho.unidade || '-';
        }

        function gerarPDFRelatorio() {
            alert('Funcionalidade de gera√ß√£o de PDF ser√° implementada em breve!');
        }

        // ============================================
        // VISUALIZADOR PDF DO RELAT√ìRIO
        // ============================================
        
        let dadosRelatorioAtual = null; // Armazena dados do √∫ltimo relat√≥rio gerado

        function visualizarPDFRelatorio() {
            const conteudoRelatorio = document.getElementById('conteudoRelatorio');
            
            if (!conteudoRelatorio) {
                alert('Nenhum relat√≥rio gerado ainda!');
                return;
            }
            
            const conteudoClonado = conteudoRelatorio.cloneNode(true);
            const loadingClone = conteudoClonado.querySelector('#loadingOverlay');
            if (loadingClone) loadingClone.remove();
            
            // Salvar no localStorage
            localStorage.setItem('relatorioHTML', conteudoClonado.innerHTML);
            
            // Abrir via rota
            window.open('/relatorio-fiscalizacao-impressao', '_blank');
        }
        
        function fecharModalRelatorioPdf() {
            const modal = document.getElementById('modalRelatorioPdf');
            const iframe = document.getElementById('iframeRelatorioPdf');
            modal.style.display = 'none';
            iframe.src = '';
            
            // Restaurar scroll do body
            document.body.style.overflow = 'auto';
        }
        
        // Fechar modal ao clicar fora do conte√∫do
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('modalRelatorioPdf');
            if (event.target === modal) {
                fecharModalRelatorioPdf();
            }
        });
        
        // Fechar modal com a tecla ESC
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modalRelatorio = document.getElementById('modalRelatorioPdf');
                if (modalRelatorio.style.display === 'block') {
                    fecharModalRelatorioPdf();
                }
            }
        });
        
    </script>
    
</body>
</html>
