<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="static/img/logo_sotweb.jpg">
    <title>Relatório de Diárias - Motoristas Terceirizados</title>
    <style>
        @page {
            size: A4 landscape;
            margin: 1cm 0.8cm;
        }
        
        body {
            font-family: Arial, Helvetica, sans-serif;
            font-size: 10pt;
            color: #000;
        }
        
        .header {
            width: 100%;
            border-bottom: 2px solid #1a73e8;
            padding-bottom: 8px;
            margin-bottom: 12px;
        }

        .header h1 {
            font-size: 18pt;
            color: #1a73e8;
            margin: 0 0 4px 0;
            font-weight: bold;
        }

        .header h2 {
            font-size: 13pt;
            color: #555;
            margin: 0;
            font-weight: normal;
        }
        
        .empresa {
            font-size: 11pt;
            color: #000;
            margin: 15px 0 10px 0;
            font-weight: normal;
            padding-left: 0;  /* Remove qualquer padding à esquerda */
        }
        
        .periodo-titulo {
            background-color: #1a73e8;
            color: white;
            padding: 8px 10px;
            font-size: 13pt;
            font-weight: bold;
            margin: 15px 0 8px 0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 10pt;
            margin-bottom: 10px;
            margin-left: 0;  /* Alinha à esquerda */
            margin-right: 0;  /* Alinha à direita */
        }
        
        th {
            background-color: #d0d0d0;
            border: 1px solid #666;
            padding: 8px 10px;
            text-align: left;
            font-weight: bold;
            font-size: 10pt;
            white-space: nowrap;
        }
        
        td {
            border: 1px solid #999;
            padding: 7px 10px;
            font-size: 10pt;
            white-space: nowrap;
        }
        
        /* AJUSTE DAS LARGURAS DAS COLUNAS */
        table th:nth-child(1), table td:nth-child(1) { width: 4%; }   /* Item */
        table th:nth-child(2), table td:nth-child(2) { width: 24%; }  /* Nome - REDUZIDO */
        table th:nth-child(3), table td:nth-child(3) { width: 18%; }  /* Nº SEI - AUMENTADO */
        table th:nth-child(4), table td:nth-child(4) { width: 17%; }  /* Período */
        table th:nth-child(5), table td:nth-child(5) { width: 11%; }  /* Mês/Ano */
        table th:nth-child(6), table td:nth-child(6) { width: 8%; }   /* Diárias */
        table th:nth-child(7), table td:nth-child(7) { width: 11%; }  /* Valor */
        table th:nth-child(8), table td:nth-child(8) { width: 7%; }   /* Pago */
        
        .centro {
            text-align: center;
        }
        
        .direita {
            text-align: right;
        }
        
        .zebra1 {
            background-color: #f9f9f9;
        }
        
        .zebra2 {
            background-color: #ffffff;
        }
        
        .linha-subtotal {
            background-color: #fff3cd;
            font-weight: bold;
            border-top: 2px solid #ff9800;
        }
        
        .linha-total {
            background-color: #d4edda;
            font-weight: bold;
            border-top: 2px solid #1a73e8;
            font-size: 11pt;
        }
        
        .rodape {
            margin-top: 15px;
            font-size: 9pt;
            color: #666;
            text-align: center;
            border-top: 1px solid #ccc;
            padding-top: 8px;
        }
        
        .sem-dados {
            text-align: center;
            padding: 30px;
            color: #999;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Controle de Diárias Motoristas Terceirizados</h1>
        <h2>
            {% if periodos|length == 1 %}
                Período: {{ periodos[0] }}
            {% else %}
                Períodos Selecionados: {{ periodos|length }}
            {% endif %}
        </h2>
    </div>

    {% if items|length == 0 %}
        <div class="sem-dados">
            Nenhum registro encontrado para o(s) período(s) selecionado(s).
        </div>
    {% else %}
        {% set fornecedores_dict = {} %}
        {% for item in items %}
            {% if item[8] and item[8] not in fornecedores_dict %}
                {% set _ = fornecedores_dict.update({item[8]: []}) %}
            {% endif %}
            {% if item[8] %}
                {% set _ = fornecedores_dict[item[8]].append(item) %}
            {% endif %}
        {% endfor %}
        
        {% set total_geral_diarias = namespace(value=0) %}
        {% set total_geral_valor = namespace(value=0) %}
        
        {% for fornecedor, items_fornecedor in fornecedores_dict.items() %}
            <div class="empresa">Empresa: {{ fornecedor }}</div>
            
            {% if agrupar %}
                {% set periodos_dict = {} %}
                {% for item in items_fornecedor %}
                    {% if item[4] and item[4] not in periodos_dict %}
                        {% set _ = periodos_dict.update({item[4]: []}) %}
                    {% endif %}
                    {% if item[4] %}
                        {% set _ = periodos_dict[item[4]].append(item) %}
                    {% endif %}
                {% endfor %}
                
                {% for periodo in periodos %}
                    {% if periodo in periodos_dict %}
                        <div class="periodo-titulo">{{ periodo }}</div>
                        <table>
                            <thead>
                                <tr>
                                    <th class="centro">Item</th>
                                    <th>Nome do Motorista</th>
                                    <th class="centro">Nº SEI</th>
                                    <th class="centro">Período</th>
                                    <th class="centro">Mês/Ano</th>
                                    <th class="centro">Diárias</th>
                                    <th class="direita">Valor Pago</th>
                                    <th class="centro">Pago</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% set subtotal_diarias = namespace(value=0) %}
                                {% set subtotal_valor = namespace(value=0) %}
                                
                                {% for item in periodos_dict[periodo] %}
                                    {% set subtotal_diarias.value = subtotal_diarias.value + (item[5] if item[5] else 0) %}
                                    {% set subtotal_valor.value = subtotal_valor.value + (item[6] if item[6] else 0) %}
                                    <tr class="{% if loop.index % 2 == 1 %}zebra1{% else %}zebra2{% endif %}">
                                        <td class="centro">{{ loop.index }}</td>
                                        <td>{{ item[0] if item[0] else '-' }}</td>
                                        <td class="centro">{{ item[1] if item[1] else '-' }}</td>
                                        <td class="centro">
                                            {% if item[2] and item[3] %}
                                                {% if item[2].strftime('%d/%m/%Y') == item[3].strftime('%d/%m/%Y') %}
                                                    {{ item[2].strftime('%d/%m/%Y') }}
                                                {% else %}
                                                    {{ item[2].strftime('%d/%m/%Y') }} a {{ item[3].strftime('%d/%m/%Y') }}
                                                {% endif %}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td class="centro">{{ item[4] if item[4] else '-' }}</td>
                                        <td class="centro">{{ "%.2f"|format(item[5] if item[5] else 0) }}</td>
                                        <td class="direita">R$ {{ "%.2f"|format(item[6] if item[6] else 0) }}</td>
                                        <td class="centro">{{ item[7] if item[7] else 'NÃO' }}</td>
                                    </tr>
                                {% endfor %}
                                
                                {% set total_geral_diarias.value = total_geral_diarias.value + subtotal_diarias.value %}
                                {% set total_geral_valor.value = total_geral_valor.value + subtotal_valor.value %}
                                
                                <tr class="linha-subtotal">
                                    <td colspan="5" class="direita">Subtotal {{ periodo }}:</td>
                                    <td class="centro">{{ "%.2f"|format(subtotal_diarias.value) }}</td>
                                    <td class="direita">R$ {{ "%.2f"|format(subtotal_valor.value) }}</td>
                                    <td></td>
                                </tr>
                            </tbody>
                        </table>
                    {% endif %}
                {% endfor %}
            {% else %}
                <table>
                    <thead>
                        <tr>
                            <th class="centro">Item</th>
                            <th>Nome do Motorista</th>
                            <th class="centro">Nº SEI</th>
                            <th class="centro">Período</th>
                            <th class="centro">Mês/Ano</th>
                            <th class="centro">Diárias</th>
                            <th class="direita">Valor Pago</th>
                            <th class="centro">Pago</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set total_fornecedor_diarias = namespace(value=0) %}
                        {% set total_fornecedor_valor = namespace(value=0) %}
                        
                        {% for item in items_fornecedor %}
                            {% set total_fornecedor_diarias.value = total_fornecedor_diarias.value + (item[5] if item[5] else 0) %}
                            {% set total_fornecedor_valor.value = total_fornecedor_valor.value + (item[6] if item[6] else 0) %}
                            <tr class="{% if loop.index % 2 == 1 %}zebra1{% else %}zebra2{% endif %}">
                                <td class="centro">{{ loop.index }}</td>
                                <td>{{ item[0] if item[0] else '-' }}</td>
                                <td class="centro">{{ item[1] if item[1] else '-' }}</td>
                                <td class="centro">
                                    {% if item[2] and item[3] %}
                                        {% if item[2].strftime('%d/%m/%Y') == item[3].strftime('%d/%m/%Y') %}
                                            {{ item[2].strftime('%d/%m/%Y') }}
                                        {% else %}
                                            {{ item[2].strftime('%d/%m/%Y') }} a {{ item[3].strftime('%d/%m/%Y') }}
                                        {% endif %}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td class="centro">{{ item[4] if item[4] else '-' }}</td>
                                <td class="centro">{{ "%.2f"|format(item[5] if item[5] else 0) }}</td>
                                <td class="direita">R$ {{ "%.2f"|format(item[6] if item[6] else 0) }}</td>
                                <td class="centro">{{ item[7] if item[7] else 'NÃO' }}</td>
                            </tr>
                        {% endfor %}
                        
                        {% set total_geral_diarias.value = total_geral_diarias.value + total_fornecedor_diarias.value %}
                        {% set total_geral_valor.value = total_geral_valor.value + total_fornecedor_valor.value %}
                        
                        <tr class="linha-total">
                            <td colspan="5" class="direita">TOTAL:</td>
                            <td class="centro">{{ "%.2f"|format(total_fornecedor_diarias.value) }}</td>
                            <td class="direita">R$ {{ "%.2f"|format(total_fornecedor_valor.value) }}</td>
                            <td></td>
                        </tr>
                    </tbody>
                </table>
            {% endif %}
        {% endfor %}
        
        {% if fornecedores_dict|length > 1 or agrupar %}
            <table>
                <tbody>
                    <tr class="linha-total">
                        <td colspan="5" class="direita">TOTAL GERAL:</td>
                        <td class="centro">{{ "%.2f"|format(total_geral_diarias.value) }}</td>
                        <td class="direita">R$ {{ "%.2f"|format(total_geral_valor.value) }}</td>
                        <td></td>
                    </tr>
                </tbody>
            </table>
        {% endif %}
    {% endif %}

    <div class="rodape">
        Relatório gerado em {{ data_geracao }}
    </div>
</body>
</html>

