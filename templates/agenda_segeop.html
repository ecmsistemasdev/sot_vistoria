    <!DOCTYPE html>
    <html lang="pt-BR">
    <head>
        <meta charset="UTF-8">
        <link rel="icon" type="image/png" href="static/img/logo_sotweb.jpg">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Agenda SEGEOP</title>
        <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }

            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: #f5f5f5;
                padding: 20px;
                padding-bottom: 70px;
                padding-top: 70px; /* ADICIONAR ESTA LINHA */
            }

            .container {
                max-width: 100%;
                background: white;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                overflow: hidden;
                margin-top: 10px; /* ADICIONAR ESTA LINHA */
            }

            .header {
                background: #1a73e8;
                color: white;
                padding: 10px 20px;
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 15px;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                z-index: 200;
                box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            }

            .header-left {
                display: flex;
                align-items: center;
                gap: 15px;
            }

            .header-right {
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .header-btn {
                background: white;
                color: #1a73e8;
                border: none;
                padding: 8px 16px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 600;
                transition: all 0.3s;
                display: flex;
                align-items: center;
                gap: 6px;
            }

            .header-btn:hover {
                background: #f0f0f0;
                transform: translateY(-1px);
                box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            }

            .header h1 { 
                font-size: 18px; 
                margin: 0; 
            }

            .header .periodo {
                font-size: 14px;
                color: #fff9c4;
                font-weight: 500;
            }

            .agenda-wrapper {
                overflow-x: auto;
                padding: 20px;
            }

            .agenda-section {
                margin-bottom: 20px;
            }

            .section-title {
                background: #34495e;
                color: white;
                padding: 10px 15px;
                font-size: 16px;
                font-weight: bold;
                border-radius: 4px 4px 0 0;
            }

            .agenda-table {
                width: 100%;
                border-collapse: collapse;
                border: 1px solid #ddd;
                table-layout: fixed;
            }

            .agenda-table th {
                background: #ecf0f1;
                padding: 10px;
                text-align: center;
                border: 1px solid #ddd;
                font-size: 13px;
                font-weight: 600;
            }

            .agenda-table td {
                border: 1px solid #bbb;
                padding: 6px;
                vertical-align: middle;
                font-size: 12px;
                position: relative;
                cursor: pointer;
                transition: background 0.2s;
                overflow: visible;
            }

            .cell-selected {
                filter: brightness(0.85);
                box-shadow: inset 0 0 0 2px #1a73e8;
            }

            .tipo-locacao {
                background: linear-gradient(to bottom, #c7a3e7, #d9bef0) !important;
            }

            .motorista-filter {
                display: flex;
                gap: 15px;
                margin-bottom: 15px;
                padding: 10px;
                background: #f8f9fa;
                border-radius: 4px;
            }

            .motorista-filter label {
                display: flex;
                align-items: center;
                gap: 5px;
                cursor: pointer;
                font-weight: normal;
                font-size: 14px;
            }

            .motorista-filter input[type="radio"] {
                cursor: pointer;
                width: auto;
            }

            .motorista-inline-filter {
                display: flex;
                gap: 20px;
                margin-bottom: 8px;
                padding: 8px 0;
            }

            .motorista-inline-filter label {
                display: flex;
                align-items: center;
                gap: 5px;
                cursor: pointer;
                font-weight: normal;
                font-size: 14px;
                margin: 0;
            }

            .motorista-inline-filter input[type="radio"] {
                cursor: pointer;
                width: auto;
                margin: 0;
            }

            #divSolicitado label {
                display: flex;
                align-items: center;
                font-weight: 600;
                cursor: pointer;
            }

            .tipo-solicitado {
                background: linear-gradient(to bottom, #c7a3e7, #d9bef0) !important;
            }

            .agenda-table td:hover {
                background: #f8f9fa !important;
            }

            .col-numero {
                width: 40px;
                background: #f8f9fa;
                font-weight: 600;
                text-align: center;
            }

            .col-nome {
                width: 216px;
                background: #f8f9fa;
                font-weight: 600;
                word-wrap: break-word;
                white-space: normal;
            }

            .col-dia {
                width: calc((100% - 256px) / 7);
            }

            .cell-content {
                line-height: 1.2;
                min-height: 28px;
                height: auto;
                overflow: visible;
                font-size: 11px;
            }

            .cell-content-veiculos {
                line-height: 1.2;
                min-height: 24px;
                height: auto;
                overflow: visible;
                font-size: 11px;
            }

            .cell-content-veiculos div {
                margin-bottom: 1px;
            }
            
            .cell-content div {
                margin-bottom: 1px;
            }

            .informar-veiculo {
                color: #dc3545;
                font-style: italic;
                font-size: 10px;
            }

            /* Cores por tipo de demanda */
            .tipo-1 { 
                background: linear-gradient(to bottom, #5fa1df, #8dbde8);
            }
            .tipo-2 { 
                background: linear-gradient(to bottom, #79f183, #9ff7a7);
            }
            .tipo-3 { 
                background: linear-gradient(to bottom, #f8c295, #fad4b3);
            }
            .tipo-4, .tipo-5 { 
                background: linear-gradient(to bottom, #f8c295, #fad4b3);
            }
            .tipo-6, .tipo-7, .tipo-8 { 
                background: linear-gradient(to bottom, #f3f183, #f7f5a7);
                font-weight: bold;
            }
            .tipo-9 { 
                background: linear-gradient(to bottom, #ff5d5d, #fca5a5) !important;
                font-weight: bold;
            }
            .tipo-10 { 
                background: linear-gradient(to bottom, hsl(320, 1%, 61%), hsl(330, 7%, 84%)) !important;
                font-weight: bold;
            }
            .tipo-11 { 
                background: linear-gradient(to bottom, #ffb3d9, #ffd9ec);
            }        
            .tipo-12 { 
                background: linear-gradient(to bottom, #ff5d5d, #fca5a5) !important;
                font-weight: bold;
            }
            .empty-cell {
                background: #fafafa;
            }

            .empty-cell.weekend-empty {
                background: #e0e0e0;
            }

            /* FOOTER COM TABS ESTILO EXCEL/DELPHI */
            .footer {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: #e8e8e8;
                padding: 0;
                border-top: 1px solid #c0c0c0;
                display: flex;
                justify-content: flex-start;
                align-items: flex-start;
                gap: 0;
                z-index: 100;
                box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
                height: 45px;
            }

            .btn {
                padding: 8px 16px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 13px;
                transition: all 0.3s;
                margin: 10px 0 10px 15px;
                align-self: flex-start;
            }

            .btn-primary {
                background: #1a73e8;
                color: white;
            }

            .btn-primary:hover { background: #1557b0; }

            /* .footer-divider {
                width: 1px;
                height: 40px;
                background: #c0c0c0;
                margin: 0 10px;
                align-self: center;
            } */

            /* TABS NAVEGA√á√ÉO ESTILO EXCEL */
            .week-tabs-wrapper {
                display: flex;
                align-items: flex-start;
                gap: 0;
                flex: 1;
                overflow: hidden;
                height: 100%;
                background: #e8e8e8;
                padding-bottom: 0;
            }

            .week-nav-btn {
                background: #f0f0f0;
                /* border: 1px solid #c0c0c0; */
                border: 1px solid #c0c0c0 !important;
                /* border-bottom: none; */
                cursor: pointer;
                padding: 8px 10px;
                font-size: 10px;
                transition: all 0.2s;
                flex-shrink: 0;
                width: 32px;
                height: 32px;
                display: flex;
                align-items: center;
                justify-content: center;
                margin: 2px 2px 0 8px;
                align-self: flex-start;
            }

            .week-nav-btn:hover:not(:disabled) {
                background: #fff;
            }

            .week-nav-btn:disabled {
                opacity: 0.4;
                cursor: not-allowed;
                background: #e0e0e0;
            }

            .week-tabs-scroll {
                display: flex;
                gap: 0;
                overflow-x: auto;
                overflow-y: hidden;
                scroll-behavior: smooth;
                flex: 1;
                height: 100%;
                align-items: flex-start;
                background: #e8e8e8;
                padding: 0 4px 0 0;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }

            .week-tabs-scroll::-webkit-scrollbar {
                display: none;
            }

            .week-tabs-container {
                display: inline-flex;
                gap: -1px;
                flex-wrap: nowrap;
                align-items: flex-start;
                height: 100%;
                padding: 0;
                margin: 0;
            }

            .week-tab {
                padding: 10px 20px;
                background: #d4d4d4;
                border: 1px solid #c0c0c0;
                cursor: pointer;
                font-size: 13px;
                transition: all 0.15s;
                white-space: nowrap;
                flex-shrink: 0;
                user-select: none;
                display: inline-flex;
                align-items: center;
                height: 32px;
                margin: 0;
                border-radius: 0 0 6px 6px;  /* MANT√âM: arredondado embaixo */
                border-top: none;  /* SEM borda em cima */
                border-bottom: 1px solid #c0c0c0;  /* COM borda embaixo */
                position: relative;
                color: #333;
                font-weight: 500;
            }

            .week-tab:hover:not(.active) {
                background: #e8e8e8;
                border-color: #b0b0b0;
                z-index: 1;
            }

            .week-tab.active {
                /* background: #ffffff; */
                background: #73d7e4;
                color: #000;
                border-color: #c0c0c0;
                border-top: none;  /* SEM borda em cima */
                border-bottom: 1px solid #c0c0c0;  /* COM borda embaixo */
                font-weight: 600;
                z-index: 2;
                height: 35px;
                padding: 10px 22px;
                margin-top: 0;
                margin-bottom: 0;  /* SEM margin negativo */
            }

            .week-tab.active::before {
                content: '';
                position: absolute;
                top: -1px;  /* NO topo */
                left: 0;
                right: 0;
                height: 2px;
                /* background: #ffffff; 
                background: #fc7e08; 
                background: #ffff33;  
                background: #1fc909; */
                background: #5aadb8;
            }

            .week-tab:not(.active) {
                box-shadow: inset 0 -2px 3px rgba(0,0,0,0.05);
            }

            /* MODALS */
            .modal {
                display: none;
                position: fixed;
                z-index: 1000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                animation: fadeIn 0.3s;
            }

            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }

            .modal-content {
                background: white;
                margin: 50px auto;
                padding: 0;
                width: 90%;
                max-width: 600px;
                border-radius: 8px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                animation: slideDown 0.3s;
                max-height: 90vh;
                overflow-y: auto;
            }

            @keyframes slideDown {
                from { transform: translateY(-50px); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }

            .modal-header {
                background: #1a73e8;
                color: white;
                padding: 10px 20px;
                border-radius: 8px 8px 0 0;
                display: flex;
                justify-content: space-between;
                align-items: center;
                position: sticky;
                top: 0;
                z-index: 10;
            }

            .modal-header h2 { 
                font-size: 16px;
                margin: 0;
            }

            .close {
                font-size: 28px;
                font-weight: bold;
                cursor: pointer;
                color: white;
                opacity: 0.8;
            }

            .close:hover { opacity: 1; }

            .modal-body {
                padding: 15px 20px;
            }

            .form-group {
                margin-bottom: 12px;
            }

            .form-group label {
                display: block;
                margin-bottom: 4px;
                font-weight: 600;
                font-size: 13px;
                color: #333;
            }

            .form-group label .required {
                color: #dc3545;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                width: 100%;
                padding: 8px;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 13px;
            }

            .form-group input:disabled,
            .form-group select:disabled {
                background: #e9ecef;
                cursor: not-allowed;
            }

            .form-group textarea {
                resize: vertical;
                min-height: 50px;
            }

            .form-row {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }

            .modal-footer {
                padding: 12px 20px;
                background: #f8f9fa;
                display: flex;
                justify-content: flex-end;
                gap: 10px;
                border-radius: 0 0 8px 8px;
                position: sticky;
                bottom: 0;
            }

            .btn-secondary {
                background: #6c757d;
                color: white;
            }

            .btn-secondary:hover { background: #5a6268; }

            .btn-danger {
                background: #dc3545;
                color: white;
            }

            .btn-danger:hover { background: #c82333; }

            .loading {
                text-align: center;
                padding: 40px;
                color: #666;
            }

            /* .header-icon {
                cursor: pointer;
                font-size: 20px;
                opacity: 0.85;
                transition: opacity 0.2s, transform 0.2s;
                margin-left: auto;
                padding: 5px 10px;
                text-decoration: none;
                color: white;
            }

            .header-icon:hover {
                opacity: 1;
                transform: scale(1.1);
            } */

            .feriados-container {
                padding: 20px;
                max-height: 60vh;
                overflow-y: auto;
            }

            .feriado-form {
                background: #f8f9fa;
                padding: 15px;
                border-radius: 4px;
                margin-bottom: 20px;
            }

            .feriado-form-row {
                display: grid;
                grid-template-columns: 2fr 2fr 1fr;
                gap: 10px;
                align-items: end;
            }

            .feriados-lista {
                max-height: 400px;
                overflow-y: auto;
            }

            .feriado-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 12px;
                background: white;
                border: 1px solid #dee2e6;
                border-radius: 4px;
                margin-bottom: 8px;
                transition: background 0.2s;
            }

            .feriado-item:hover {
                background: #f8f9fa;
            }

            .feriado-info {
                flex: 1;
            }

            .feriado-descricao {
                font-weight: 600;
                color: #333;
                margin-bottom: 3px;
            }

            .feriado-data {
                font-size: 12px;
                color: #666;
            }

            .btn-icon {
                background: none;
                border: none;
                cursor: pointer;
                font-size: 18px;
                padding: 5px 10px;
                opacity: 0.7;
                transition: opacity 0.2s;
            }

            .btn-icon:hover {
                opacity: 1;
            }

            .cell-feriado {
                background: #fdfcb2 !important;
                font-weight: bold;
                font-size: 11px;
                text-align: center;
                vertical-align: middle;
            }

            .cell-feriado-com-demanda {
                position: relative;
            }

            .cell-feriado-com-demanda::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: repeating-linear-gradient(
                    45deg,
                    transparent,
                    transparent 10px,
                    rgba(243, 241, 131, 0.3) 10px,
                    rgba(243, 241, 131, 0.3) 20px
                );
                pointer-events: none;
            }

            #horario:disabled {
                background: #e9ecef;
                cursor: not-allowed;
            }
            
            .demanda-horario {
                font-size: 10px;
                color: #666;
                font-style: italic;
            }
            
            .cell-divider {
                border-top: 1px dashed #999;
                margin: 5px 0;
                padding-top: 5px;
            }

            .veiculo-extra {
                background: #fffacd !important; /* Cor amarelo claro */
            }
            
            .col-nome.veiculo-extra {
                background: #fffacd !important;
                font-style: italic;
            }
            
            .col-numero.veiculo-extra {
                background: #fffacd !important;
            }
            
            .section-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                background: #34495e;
                color: white;
                padding: 10px 15px;
                font-size: 16px;
                font-weight: bold;
                border-radius: 4px 4px 0 0;
            }

            .btn-visualizar {
                background: white;
                color: #34495e;
                border: none;
                padding: 6px 12px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 13px;
                font-weight: 600;
                transition: all 0.2s;
            }

            .btn-visualizar:hover {
                background: #ecf0f1;
                transform: scale(1.05);
            }

            /* Estilos para a janela de visualiza√ß√£o */
            .print-view {
                padding: 10px;
                background: white;
                min-height: 100vh;
                box-sizing: border-box;
            }

            .print-view .agenda-section {
                margin: 0;
                height: auto;
            }

            .print-view .agenda-table {
                width: 100%;
                font-size: 11px;
            }

            .print-view .section-title,
            .print-view .section-header {
                background: #34495e;
                color: white;
                padding: 12px 15px;
                font-size: 18px;
                text-align: center;
                border-radius: 0;
            }

            .print-view .col-numero {
                width: 35px;
            }

            .print-view .col-nome {
                width: 180px;
            }

            .print-view .cell-content,
            .print-view .cell-content-veiculos {
                font-size: 10px;
                line-height: 1.3;
            }  

            /* Cabe√ßalho flutuante das se√ß√µes */
            .sticky-header {
                position: fixed;
                top: 70px;
                left: 40px;  /* ADICIONAR: margem esquerda igual ao padding do body */
                right: 40px;  /* ADICIONAR: margem direita igual ao padding do body */
                z-index: 90;
                background: rgba(236, 240, 241, 0.80);  /* ALTERADO: mais transparente (era 0.95) */
                backdrop-filter: blur(8px);
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
                display: none;
                padding: 0;  /* REMOVIDO: padding de 20px */
                transition: opacity 0.3s ease;
            }
            
            .sticky-header.visible {
                display: block;
                animation: slideDown 0.3s ease;
            }
            
            @keyframes slideDown {
                from {
                    opacity: 0;
                    transform: translateY(-10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            
            .sticky-header table {
                width: 100%;
                border-collapse: collapse;
                margin: 0;
                table-layout: fixed;  /* ADICIONAR: para manter larguras consistentes */
            }
            
            .sticky-header th {
                background: transparent;
                padding: 10px;
                text-align: center;
                border: none;
                border-right: 1px solid rgba(221, 221, 221, 0.5);
                font-size: 13px;
                font-weight: 600;
                color: #2c3e50;
            }
            
            .sticky-header th:last-child {
                border-right: none;
            }
            
            .sticky-header .col-numero {
                width: 40px;
            }
            
            .sticky-header .col-nome {
                width: 216px;
            }
            
            .sticky-header .col-dia {
                width: calc((100% - 256px) / 7);
            }   

            /* Tooltip para ve√≠culo */
            .tooltip-veiculo {
                position: absolute;
                background: rgba(0, 0, 0, 0.75); /* Aumentada transpar√™ncia de 0.9 para 0.75 */
                color: white;
                padding: 8px 12px;
                border-radius: 4px;
                font-size: 12px;
                font-weight: normal; /* Alterado de 500 para normal */
                z-index: 1000;
                pointer-events: none;
                white-space: nowrap;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                opacity: 0;
                transition: opacity 0.2s;
                line-height: 1.4; /* Adicionado para melhor espa√ßamento entre linhas */
            }
            
            .tooltip-veiculo.visible {
                opacity: 1;
            }

            /* Spinner de carregamento */
            .loading-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 9999;
                justify-content: center;
                align-items: center;
            }
            
            .loading-overlay.visible {
                display: flex;
            }
            
            .spinner-container {
                background: white;
                padding: 30px;
                border-radius: 8px;
                text-align: center;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            }
            
            .spinner {
                border: 4px solid #f3f3f3;
                border-top: 4px solid #1a73e8;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                animation: spin 1s linear infinite;
                margin: 0 auto 15px;
            }
            
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            
            .spinner-text {
                color: #333;
                font-size: 14px;
                font-weight: 500;
            }
            
            /*
            .tooltip-veiculo::before {
                content: '';
                position: absolute;
                bottom: -5px;
                left: 50%;
                transform: translateX(-50%);
                width: 0;
                height: 0;
                border-left: 5px solid transparent;
                border-right: 5px solid transparent;
                border-top: 5px solid rgba(0, 0, 0, 0.9);
            }   
            */

            /* Estilos adicionais para o formul√°rio de loca√ß√£o */
 
            /* #statusCNH {
                text-align: center;
                font-size: 14px;
            }
            
            #statusCNH.tem-cnh {
                background: #d4edda;
                color: #155724;
                border: 1px solid #c3e6cb;
            }
            
            #statusCNH.sem-cnh {
                background: #f8d7da;
                color: #721c24;
                border: 1px solid #f5c6cb;
            } */
            
            .input-group-text {
                background: #e9ecef;
                border: 1px solid #ddd;
                font-weight: 600;
            }

            /* ========== ESTILOS PARA FORMUL√ÅRIO DE LOCA√á√ÉO ========== */

            #modalFormLocacao .modal-content {
                max-width: 700px;
            }

            #modalFormLocacao .form-row {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }

            #modalFormLocacao .form-group {
                margin-bottom: 15px;
            }

            #modalFormLocacao .form-group label {
                display: block;
                margin-bottom: 5px;
                font-weight: 600;
                font-size: 13px;
                color: #333;
            }

            #modalFormLocacao .required {
                color: #dc3545;
            }

            #modalFormLocacao input[type="text"],
            #modalFormLocacao input[type="date"],
            #modalFormLocacao input[type="time"],
            #modalFormLocacao input[type="number"],
            #modalFormLocacao select,
            #modalFormLocacao textarea {
                width: 100%;
                padding: 8px;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 13px;
            }

            #modalFormLocacao input[readonly],
            #modalFormLocacao select[readonly] {
                background: #f8f9fa;
                cursor: not-allowed;
            }

            #modalFormLocacao textarea {
                resize: vertical;
                min-height: 70px;
            }

            #modalFormLocacao .text-end {
                text-align: right;
                margin-top: 5px;
                font-size: 12px;
                color: #666;
            }

            /* Input group para valores monet√°rios */
            .input-group {
                display: flex;
            }

            .input-group-sm .input-group-text {
                padding: 6px 10px;
                font-size: 13px;
                border-right: none;
                border-radius: 4px 0 0 4px;
            }

            .input-group-sm input {
                border-left: none;
                border-radius: 0 4px 4px 0;
            }

            /* Bot√£o Solicitar Loca√ß√£o na edi√ß√£o */
            #btnSolicitarLocacaoEdicao {
                font-size: 14px;
                padding: 8px 16px;
                transition: all 0.3s;
            }

            #btnSolicitarLocacaoEdicao:hover {
                background: #218838 !important;
                transform: translateY(-1px);
                box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
            }

            /* Status de loca√ß√£o solicitada */
            #areaLocacaoStatus {
                animation: fadeIn 0.3s;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(-5px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            /* Anima√ß√£o para o modal de confirma√ß√£o */
            #modalConfirmacaoLocacao .modal-content {
                animation: bounceIn 0.5s;
            }
            
            @keyframes bounceIn {
                0% {
                    transform: scale(0.3);
                    opacity: 0;
                }
                50% {
                    transform: scale(1.05);
                }
                70% {
                    transform: scale(0.9);
                }
                100% {
                    transform: scale(1);
                    opacity: 1;
                }
            }
            
            #modalConfirmacaoLocacao .btn {
                transition: all 0.3s;
            }
            
            #modalConfirmacaoLocacao .btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            }

            /* Anima√ß√£o para modal de sucesso */
            #modalSucessoLocacao .modal-dialog {
                animation: zoomIn 0.3s;
            }
            
            @keyframes zoomIn {
                0% {
                    transform: scale(0.8);
                    opacity: 0;
                }
                100% {
                    transform: scale(1);
                    opacity: 1;
                }
            }
            
            #modalSucessoLocacao .modal-content {
                border: none;
            }
            
            #modalSucessoLocacao .btn-close {
                font-size: 12px;
            }

            #statusCNHDiscrete {
                transition: all 0.3s;
                font-size: 11px !important;
                padding: 3px 8px !important;
            }

            #statusCNHDiscrete:empty {
                display: none;
            }

            /* Anima√ß√£o sutil ao aparecer */
            @keyframes fadeInRight {
                from {
                    opacity: 0;
                    transform: translateX(-10px);
                }
                to {
                    opacity: 1;
                    transform: translateX(0);
                }
            }

            #statusCNHDiscrete {
                animation: fadeInRight 0.3s;
            }

            /* Autocomplete Setor */
            .autocomplete-container {
                position: relative;
                width: 100%;
            }

            .autocomplete-list {
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: white;
                border: 1px solid #ddd;
                border-top: none;
                border-radius: 0 0 4px 4px;
                max-height: 200px;
                overflow-y: auto;
                z-index: 1000;
                box-shadow: 0 4px 8px rgba(0,0,0,0.15);
                display: none;
            }

            .autocomplete-list.visible {
                display: block;
            }

            .autocomplete-item {
                padding: 8px 12px;
                cursor: pointer;
                font-size: 13px;
                border-bottom: 1px solid #f0f0f0;
            }

            .autocomplete-item:last-child {
                border-bottom: none;
            }

            .autocomplete-item:hover,
            .autocomplete-item.selected {
                background: #e8f0fe;
                color: #1a73e8;
            }

            .autocomplete-item-highlight {
                font-weight: 600;
                color: #1a73e8;
            }

            /* Destaque sutil nas c√©lulas N. e Nome ao passar mouse na linha */
            .col-numero.row-hover,
            .col-nome.row-hover {
                filter: brightness(0.92);
                transition: filter 0.2s ease;
            }
            
            /* Alternativa com zoom sutil na fonte */
            .col-numero.row-hover-zoom,
            .col-nome.row-hover-zoom {
                font-size: 1.05em;
                transition: font-size 0.2s ease;
            }
            
            /* Voc√™ pode escolher entre os dois efeitos ou combinar ambos */
            .col-numero.row-hover-combined,
            .col-nome.row-hover-combined {
                filter: brightness(0.92);
                font-size: 1.03em;
                transition: all 0.2s ease;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <div class="header-left">
                    <h1>üìÖ AGENDA SEGEOP</h1>
                    <span class="periodo" id="semanaAtual"></span>
                </div>
                    <div class="header-right">
                        <button class="header-btn" onclick="abrirModalNovoGeral()" title="Nova Demanda">
                            ‚ûï Nova Demanda
                        </button>
                        <button class="header-btn" onclick="abrirModalFeriados()" title="Gerenciar Feriados">
                            üóìÔ∏è
                        </button>
                        <button class="header-btn" onclick="voltarPaginaInicial()" title="Retornar √† P√°gina Inicial">
                            üè† In√≠cio
                        </button>
                    </div>
            </div>

            <div class="agenda-wrapper" id="agendaWrapper">
                <div class="loading">‚è≥ Carregando agenda...</div>
            </div>
        </div>

        <!-- Cabe√ßalhos flutuantes para cada se√ß√£o -->
        <div id="stickyHeaderMotoristas" class="sticky-header">
            <table>
                <thead>
                    <tr>
                        <th class="col-numero">N.</th>
                        <th class="col-nome">Nome</th>
                        <th class="col-dia" id="sticky-dia-1"></th>
                        <th class="col-dia" id="sticky-dia-2"></th>
                        <th class="col-dia" id="sticky-dia-3"></th>
                        <th class="col-dia" id="sticky-dia-4"></th>
                        <th class="col-dia" id="sticky-dia-5"></th>
                        <th class="col-dia" id="sticky-dia-6"></th>
                        <th class="col-dia" id="sticky-dia-7"></th>
                    </tr>
                </thead>
            </table>
        </div>
        
        <div id="stickyHeaderOutrosMotoristas" class="sticky-header">
            <table>
                <thead>
                    <tr>
                        <th class="col-numero">N.</th>
                        <th class="col-nome">Nome</th>
                        <th class="col-dia" id="sticky-outros-dia-1"></th>
                        <th class="col-dia" id="sticky-outros-dia-2"></th>
                        <th class="col-dia" id="sticky-outros-dia-3"></th>
                        <th class="col-dia" id="sticky-outros-dia-4"></th>
                        <th class="col-dia" id="sticky-outros-dia-5"></th>
                        <th class="col-dia" id="sticky-outros-dia-6"></th>
                        <th class="col-dia" id="sticky-outros-dia-7"></th>
                    </tr>
                </thead>
            </table>
        </div>
        
        <div id="stickyHeaderVeiculos" class="sticky-header">
            <table>
                <thead>
                    <tr>
                        <th class="col-numero">N.</th>
                        <th class="col-nome">Ve√≠culo</th>
                        <th class="col-dia" id="sticky-veic-dia-1"></th>
                        <th class="col-dia" id="sticky-veic-dia-2"></th>
                        <th class="col-dia" id="sticky-veic-dia-3"></th>
                        <th class="col-dia" id="sticky-veic-dia-4"></th>
                        <th class="col-dia" id="sticky-veic-dia-5"></th>
                        <th class="col-dia" id="sticky-veic-dia-6"></th>
                        <th class="col-dia" id="sticky-veic-dia-7"></th>
                    </tr>
                </thead>
            </table>
        </div>
        
        <div id="stickyHeaderVeiculosAlocados" class="sticky-header">
            <table>
                <thead>
                    <tr>
                        <th class="col-numero">N.</th>
                        <th class="col-nome">Tipo Ve√≠culo / SEI / Destino</th>
                        <th class="col-dia" id="sticky-aloc-dia-1"></th>
                        <th class="col-dia" id="sticky-aloc-dia-2"></th>
                        <th class="col-dia" id="sticky-aloc-dia-3"></th>
                        <th class="col-dia" id="sticky-aloc-dia-4"></th>
                        <th class="col-dia" id="sticky-aloc-dia-5"></th>
                        <th class="col-dia" id="sticky-aloc-dia-6"></th>
                        <th class="col-dia" id="sticky-aloc-dia-7"></th>
                    </tr>
                </thead>
            </table>
        </div>
        
        <div class="footer">
            <div class="week-tabs-wrapper">
                <button class="week-nav-btn" id="btnPrevWeek" onclick="scrollWeekTabs(-1)" title="Anterior">‚óÄ</button>
                <div class="week-tabs-scroll" id="weekTabsScroll">
                    <div class="week-tabs-container" id="weekTabs"></div>
                </div>
                <button class="week-nav-btn" id="btnNextWeek" onclick="scrollWeekTabs(1)" title="Pr√≥xima">‚ñ∂</button>
            </div>
        </div>
        
        <!-- Modal -->
        <div id="modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modalTitle">Nova Demanda</h2>
                    <span class="close" onclick="fecharModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="formDemanda">
                        <input type="hidden" id="idAd" value="">
                        
                        <!-- Linha 1: Datas -->
                        <div class="form-row">
                            <div class="form-group">
                                <label>Data In√≠cio <span class="required">*</span></label>
                                <input type="date" id="dtInicio" required>
                            </div>
                            <div class="form-group">
                                <label>Data Fim <span class="required">*</span></label>
                                <input type="date" id="dtFim" required>
                            </div>
                        </div>
                        
                        <!-- Linha 2: Checkbox Hor√°rio e Input Hor√°rio -->
                        <div class="form-row">
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="definirHorario" style="width: auto; margin-right: 8px;" onchange="toggleHorario()">
                                    Definir Hor√°rio
                                </label>
                            </div>
                            <div class="form-group">
                                <label>Hor√°rio</label>
                                <input type="text" id="horario" maxlength="5" placeholder="HH:MM" disabled>
                            </div>
                        </div>
                                            
                        <!-- Linha 3: Tipo de Demanda e Tipo de Ve√≠culo -->
                        <div class="form-row">
                            <div class="form-group">
                                <label>Tipo de Demanda <span class="required">*</span></label>
                                <select id="idTipoDemanda" required></select>
                            </div>
                            <div class="form-group">
                                <label id="labelTipoVeiculo">Tipo de Ve√≠culo</label>
                                <select id="idTipoVeiculo"></select>
                            </div>
                        </div>
                        
                        <!-- Linha 4: Motorista com Radio Inline -->
                        <div class="form-group">
                            <label id="labelMotorista">Motorista <span class="required">*</span></label>
                            <div class="motorista-inline-filter" id="motoristaFilter">
                                <label>
                                    <input type="radio" name="tipoMotorista" value="segeop" checked> SEGEOP
                                </label>
                                <label>
                                    <input type="radio" name="tipoMotorista" value="todos"> Todos
                                </label>
                            </div>
                            
                            <select id="idMotorista" required></select>

                            <!-- Campo Motorista N√£o Cadastrado (oculto por padr√£o) -->
                            <div class="form-group" id="divNcMotorista" style="display: none;">
                                <label>Motorista n√£o cadastrado <span class="required">*</span></label>
                                <input type="text" id="ncMotorista" maxlength="50">
                            </div>
                        </div>
                        
                        <!-- Linha 5: Ve√≠culo -->
                        <div class="form-group">
                            <label id="labelVeiculo">Ve√≠culo</label>
                            <select id="idVeiculo"></select>
                        </div>

                        <div class="form-group" id="divExpandirVeiculos" style="display: none;">
                            <label>
                                <input type="checkbox" id="expandirVeiculos" style="width: auto; margin-right: 8px;" onchange="toggleExpandirVeiculos()">
                                Expandir para todos os ve√≠culos da frota
                            </label>
                        </div>
                        
                        <!-- Linha 6: Setor e Solicitante -->
                        <div class="form-row">
                            <div class="form-group">
                                <label id="labelSetor">Setor</label>
                                <div class="autocomplete-container">
                                    <input type="text" id="setor" maxlength="35" autocomplete="off">
                                    <div class="autocomplete-list" id="setorAutocompleteList"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label id="labelSolicitante">Solicitante</label>
                                <input type="text" id="solicitante" maxlength="30">
                            </div>
                        </div>
                        
                        <!-- Linha 7: Destino e N¬∫ SEI -->
                        <div class="form-row">
                            <div class="form-group">
                                <label id="labelDestino">Destino</label>
                                <input type="text" id="destino" maxlength="40">
                            </div>    
                            <div class="form-group">
                                <label>N¬∫ SEI</label>
                                <input type="text" id="nuSei" maxlength="25">
                            </div>
                        </div>
                        
                        <!-- Linha 8: Observa√ß√µes -->
                        <div class="form-group">
                            <label>Observa√ß√µes</label>
                            <textarea id="obs" maxlength="200" rows="3"></textarea>
                        </div>
                        
                        <!-- Checkbox Solicitado (oculto por padr√£o) -->
                        <div class="form-group" id="divSolicitado" style="display: none;">
                            <label>
                                <input type="checkbox" id="solicitado" style="width: auto; margin-right: 8px;">
                                Solicitado
                            </label>
                        </div>
                        
                        <input type="hidden" id="usuario" value="ADMIN">
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="fecharModal()">Cancelar</button>
                    <button class="btn btn-danger" id="btnExcluir" onclick="excluirDemanda()" style="display:none;">üóëÔ∏è Excluir</button>
                    <button class="btn btn-primary" onclick="salvarDemanda()">üíæ Salvar</button>
                </div>
            </div>
        </div>
        
        <!-- Modal Feriados -->
        <div id="modalFeriados" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>üóìÔ∏è Gerenciar Feriados</h2>
                    <span class="close" onclick="fecharModalFeriados()">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="feriados-container">
                        <!-- Formul√°rio de Inclus√£o -->
                        <div class="feriado-form">
                            <div class="feriado-form-row">
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label>Tipo</label>
                                    <select id="tipoFeriado">
                                        <option value="Feriado">FERIADO</option>
                                        <option value="Ponto Facultativo">PONTO FACULTATIVO</option>
                                        <option value="Outro">OUTRO</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label>Data</label>
                                    <input type="date" id="dataFeriado" required>
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label>&nbsp;</label>
                                    <button class="btn btn-primary" onclick="adicionarFeriado()">‚ûï Adicionar</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Lista de Feriados -->
                        <div class="feriados-lista" id="feriadosLista">
                            <div class="loading">Carregando feriados...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Formul√°rio de Loca√ß√£o -->
        <div id="modalFormLocacao" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Solicitar Loca√ß√£o de Ve√≠culo</h2>
                    <span class="close" onclick="fecharModalFormLocacao()">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="formSolicitacaoLocacao">
                        <!-- Campos ocultos -->
                        <input type="hidden" id="loc_id_cl" value="">
                        <input type="hidden" id="loc_id_veiculo_loc" value="">
                        <input type="hidden" id="loc_id_motorista" value="">
                        <input type="hidden" id="loc_vl_diaria" value="">
                                    
                        <!-- Linha 1: Empenho e Setor -->
                        <div class="form-row">
                            <div class="form-group">
                                <label>Empenho <span class="required">*</span></label>
                                <select id="loc_id_empenho" required>
                                    <option value="">Selecione...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Setor Solicitante <span class="required">*</span></label>
                                <input type="text" id="loc_setor" maxlength="35" required readonly style="background: #f8f9fa;">
                            </div>
                        </div>

                        <!-- Linha 2: Objetivo -->
                        <div class="form-group">
                            <label>Objetivo <span class="required">*</span></label>
                            <input type="text" id="loc_objetivo" maxlength="300" required>
                        </div>

                        <!-- Linha 3: N√∫mero SEI -->
                        <div class="form-group">
                            <label>N√∫mero SEI <span class="required">*</span></label>
                            <input type="text" id="loc_nu_sei" maxlength="25" required readonly style="background: #f8f9fa;">
                        </div>

                        <!-- Linha 3.5: Nome do Motorista + Status CNH DISCRETO -->
                        <div class="form-group">
                            <label>Motorista</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="text" id="loc_nome_motorista" readonly style="background: #f8f9fa; font-weight: 600; color: #1a73e8; flex: 1;">
                                <span id="statusCNHDiscrete" style="font-size: 12px; padding: 4px 10px; border-radius: 4px; font-weight: 600; white-space: nowrap;">
                                    <!-- Ser√° preenchido via JS -->
                                </span>
                            </div>
                        </div>
                        
                        <!-- Linha 3.6: Ve√≠culo -->
                        <div class="form-group">
                            <label>Tipo de Ve√≠culo</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="text" id="loc_tipo_veiculo" readonly style="background: #f8f9fa; font-weight: 600; color: #1a73e8; flex: 1;">
                            </div>
                        </div>

                        <!-- Linha 4: Datas -->
                        <div class="form-row">
                            <div class="form-group">
                                <label>Data In√≠cio <span class="required">*</span></label>
                                <input type="date" id="loc_dt_inicio" required readonly style="background: #f8f9fa;">
                            </div>
                            <div class="form-group">
                                <label>Data Fim <span class="required">*</span></label>
                                <input type="date" id="loc_dt_fim" required readonly style="background: #f8f9fa;">
                            </div>
                        </div>
                        
                        <!-- Linha 5: Hor√°rio e Quantidade de Di√°rias - CORRIGIDO -->
                        <div class="form-row">
                            <div class="form-group">
                                <label>Hor√°rio In√≠cio <span class="required">*</span></label>
                                <input type="time" id="loc_horario" required>
                            </div>
                            <div class="form-group">
                                <label>Qtd. Di√°rias <span class="required">*</span></label>
                                <input type="number" id="loc_qt_diarias" required readonly style="background: #f8f9fa; font-weight: 600;">
                            </div>
                        </div>
                        
                        <!-- Linha 6: Valores -->
                        <div class="form-row">
                            <div class="form-group">
                                <label>Valor Di√°ria</label>
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text">R$</span>
                                    <input type="text" id="loc_vl_diaria_display" readonly style="background: #f8f9fa; font-weight: 600;">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Valor Total</label>
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text">R$</span>
                                    <input type="text" id="loc_vl_total" readonly style="background: #f8f9fa; font-weight: 600; color: #1a73e8; font-size: 16px;">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Linha 7: Observa√ß√µes -->
                        <div class="form-group">
                            <label>Observa√ß√µes</label>
                            <textarea id="loc_obs" maxlength="200" rows="3"></textarea>
                            <div class="text-end">
                                <small><span id="loc_charCount">0</span>/200</small>
                            </div>
                        </div>
                        
                        <!-- Upload CNH (condicional) -->
                        <div id="loc_divUploadCNH" style="display: none;">
                            <div class="form-group">
                                <label>Anexar CNH do Motorista <span class="required">*</span></label>
                                <input type="file" id="loc_arquivo_cnh" accept=".pdf" class="form-control">
                                <small style="color: #dc3545;">√â necess√°rio anexar a CNH para prosseguir com a solicita√ß√£o.</small>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="fecharModalFormLocacao()">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="confirmarSolicitacaoLocacao(event)">‚úì Confirmar Solicita√ß√£o</button>
                </div>
            </div>
        </div>

        <!-- Modal de Confirma√ß√£o Personalizado -->
        <div id="modalConfirmacaoLocacao" class="modal" style="z-index: 10000;">
            <div class="modal-content" style="max-width: 450px; animation: slideDown 0.3s;">
                <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <h2 style="font-size: 18px; margin: 0;">üöó Solicita√ß√£o de Loca√ß√£o</h2>
                </div>
                <div class="modal-body" style="padding: 30px 20px; text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 15px;">üöô</div>
                    <p style="font-size: 16px; color: #333; line-height: 1.6; margin-bottom: 20px;">
                        Esta demanda possui <strong>v√≠nculo com loca√ß√£o de ve√≠culos</strong>.
                    </p>
                    <p style="font-size: 15px; color: #666; margin-bottom: 0;">
                        Deseja solicitar a loca√ß√£o agora?
                    </p>
                </div>
                <div class="modal-footer" style="justify-content: center; gap: 15px; padding: 15px 20px;">
                    <button class="btn btn-secondary" onclick="fecharModalConfirmacaoLocacao(false)" style="min-width: 100px;">
                        N√£o
                    </button>
                    <button class="btn btn-primary" onclick="fecharModalConfirmacaoLocacao(true)" style="min-width: 100px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
                        Sim, solicitar
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal de Sucesso -->
        <div id="modalSucessoLocacao" class="modal" style="z-index: 10001;">
            <div class="modal-content" style="max-width: 450px; animation: zoomIn 0.3s; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                <div class="modal-header" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border-radius: 8px 8px 0 0;">
                    <h2 style="font-size: 18px; margin: 0; font-weight: 600;">‚úì Sucesso</h2>
                    <span class="close" onclick="fecharModalSucessoLocacao()" style="color: white;">&times;</span>
                </div>
                <div class="modal-body" id="mensagemSucessoLocacao" style="padding: 25px 20px; text-align: center; font-size: 15px; line-height: 1.6;">
                    <!-- Mensagem ser√° inserida via JavaScript -->
                </div>
                <div class="modal-footer" style="justify-content: center; border-top: none; padding: 10px 20px 20px;">
                    <button type="button" class="btn btn-primary" onclick="fecharModalSucessoLocacao()" style="min-width: 100px; background: #28a745; border-color: #28a745;">OK</button>
                </div>
            </div>
        </div>

        <!-- Modal de Alerta Padr√£o (OK) -->
        <div id="modalAlerta" class="modal" style="z-index: 10002;">
            <div class="modal-content" style="max-width: 450px; animation: zoomIn 0.3s;">
                <div class="modal-header" style="background: #1a73e8;">
                    <h2 id="modalAlertaTitulo" style="font-size: 18px; margin: 0;">‚ÑπÔ∏è Informa√ß√£o</h2>
                </div>
                <div class="modal-body" id="modalAlertaMensagem" style="padding: 25px 20px; text-align: center; font-size: 15px; line-height: 1.6;">
                    <!-- Mensagem ser√° inserida via JavaScript -->
                </div>
                <div class="modal-footer" style="justify-content: center; border-top: none; padding: 10px 20px 20px;">
                    <button type="button" class="btn btn-primary" onclick="fecharModalAlerta()" style="min-width: 100px;">OK</button>
                </div>
            </div>
        </div>

        <!-- Modal de Confirma√ß√£o Padr√£o (Sim/N√£o) -->
        <div id="modalConfirmacao" class="modal" style="z-index: 10002;">
            <div class="modal-content" style="max-width: 450px; animation: slideDown 0.3s;">
                <div class="modal-header" style="background: #ffc107; color: #000;">
                    <h2 id="modalConfirmacaoTitulo" style="font-size: 18px; margin: 0;">‚ö†Ô∏è Confirma√ß√£o</h2>
                </div>
                <div class="modal-body" id="modalConfirmacaoMensagem" style="padding: 25px 20px; text-align: center; font-size: 15px; line-height: 1.6;">
                    <!-- Mensagem ser√° inserida via JavaScript -->
                </div>
                <div class="modal-footer" style="justify-content: center; gap: 15px; padding: 15px 20px;">
                    <button class="btn btn-secondary" onclick="fecharModalConfirmacao(false)" style="min-width: 100px;">
                        N√£o
                    </button>
                    <button class="btn btn-primary" onclick="fecharModalConfirmacao(true)" style="min-width: 100px;">
                        Sim
                    </button>
                </div>
            </div>
        </div>

        <!-- Tooltip para exibir ve√É¬≠culo -->
        <div id="tooltipVeiculo" class="tooltip-veiculo"></div>

        <!-- Spinner de carregamento -->
        <div id="loadingOverlay" class="loading-overlay">
            <div class="spinner-container">
                <div class="spinner"></div>
                <div class="spinner-text">Carregando...</div>
            </div>
        </div>
        
        <script>
            let semanas = [];
            let semanaAtual = 0;
            let dadosAgenda = null;
            let motoristas = [];
            let veiculos = [];
            let tiposDemanda = [];
            let tiposVeiculo = [];
            let veiculoSelecionadoOriginal = null;
            let celulaSelecionada = null;
            let locacoesAtivas = [];
            let contextoAbertura = null; // 'motorista', 'veiculo' ou null
            let feriadosPeriodo = [];
            let scrollPosition = 0;
            let veiculosExtras = [];
            let listaVeiculosExpandida = false;
            let outrosMotoristas = [];
            let tooltipVeiculo = null; // Vari√°vel para controlar o tooltip
            // ========== VARI√ÅVEIS GLOBAIS PARA LOCA√á√ÉO ==========
            let dadosVinculoLocacao = null;
            let idDemandaParaLocacao = null;
            let callbackConfirmacaoLocacao = null;
            let callbackConfirmacaoPadrao = null; // Para o modal de confirma√ß√£o padr√£o
            let setorAutocompleteTimeout = null;
            let setorSelectedIndex = -1;

            // ========== FUN√á√ïES PARA MODAIS PADR√ÉO ==========

            // Modal de Alerta (OK)
            function mostrarAlerta(mensagem, titulo = '‚ÑπÔ∏è Informa√ß√£o', cor = '#1a73e8') {
                const modal = document.getElementById('modalAlerta');
                const modalTitulo = document.getElementById('modalAlertaTitulo');
                const modalMensagem = document.getElementById('modalAlertaMensagem');
                const modalHeader = modal.querySelector('.modal-header');
                
                modalTitulo.textContent = titulo;
                modalMensagem.innerHTML = mensagem;
                modalHeader.style.background = cor;
                
                modal.style.display = 'block';
            }

            function fecharModalAlerta() {
                document.getElementById('modalAlerta').style.display = 'none';
            }

            // Modal de Confirma√ß√£o (Sim/N√£o)
            function mostrarConfirmacao(mensagem, callback, titulo = '‚ö†Ô∏è Confirma√ß√£o') {
                const modal = document.getElementById('modalConfirmacao');
                const modalTitulo = document.getElementById('modalConfirmacaoTitulo');
                const modalMensagem = document.getElementById('modalConfirmacaoMensagem');
                
                modalTitulo.textContent = titulo;
                modalMensagem.innerHTML = mensagem;
                
                callbackConfirmacaoPadrao = callback;
                modal.style.display = 'block';
            }

            function fecharModalConfirmacao(resposta) {
                document.getElementById('modalConfirmacao').style.display = 'none';
                
                if (callbackConfirmacaoPadrao) {
                    callbackConfirmacaoPadrao(resposta);
                    callbackConfirmacaoPadrao = null;
                }
            }

            // ========== FIM FUN√á√ïES MODAIS PADR√ÉO ==========

            // Fun√ß√µes para controlar o spinner
            function mostrarSpinner() {
                const overlay = document.getElementById('loadingOverlay');
                if (overlay) {
                    overlay.classList.add('visible');
                }
            }
            
            function esconderSpinner() {
                const overlay = document.getElementById('loadingOverlay');
                if (overlay) {
                    overlay.classList.remove('visible');
                }
            }
            
            // Fun√ß√£o para obter informa√ß√£o do ve√≠culo de uma demanda
            function obterVeiculoDemanda(idDemanda) {
                const demanda = dadosAgenda.demandas.find(d => d.id === idDemanda);
                if (!demanda) return null;
                
                // Se tem ID_VEICULO (ve√≠culo oficial)
                if (demanda.id_veiculo) {
                    // Procurar nos ve√≠culos padr√£o
                    let veiculo = veiculos.find(v => v.id === demanda.id_veiculo);
                    
                    // Se n√£o encontrou, procurar nos extras
                    if (!veiculo) {
                        veiculo = veiculosExtras.find(v => v.id === demanda.id_veiculo);
                    }
                    
                    return veiculo ? veiculo.veiculo : `Ve√≠culo ID ${demanda.id_veiculo}`;
                }
                
                // Se tem ID_TIPOVEICULO (ve√≠culo alocado)
                if (demanda.id_tipoveiculo && demanda.id_tipoveiculo !== 1) {
                    return demanda.de_tipoveiculo || 'Ve√≠culo Alocado';
                }
                
                return null;
            }
            
            // Fun√ß√£o para mostrar tooltip
            function mostrarTooltipVeiculo(event, idDemanda) {
                const demanda = dadosAgenda.demandas.find(d => d.id === idDemanda);
                if (!demanda) return;
                
                const veiculo = obterVeiculoDemanda(idDemanda);
                if (!veiculo) return;
                
                if (!tooltipVeiculo) {
                    tooltipVeiculo = document.getElementById('tooltipVeiculo');
                }
                
                // Formatar per√≠odo
                const dataInicio = new Date(demanda.dt_inicio + 'T00:00:00');
                const dataFim = new Date(demanda.dt_fim + 'T00:00:00');
                
                let periodoFormatado;
                if (demanda.dt_inicio === demanda.dt_fim) {
                    // Data √∫nica
                    periodoFormatado = `${dataInicio.getDate().toString().padStart(2, '0')}/${(dataInicio.getMonth() + 1).toString().padStart(2, '0')}/${dataInicio.getFullYear()}`;
                } else {
                    // Per√≠odo
                    periodoFormatado = `${dataInicio.getDate().toString().padStart(2, '0')}/${(dataInicio.getMonth() + 1).toString().padStart(2, '0')} a ${dataFim.getDate().toString().padStart(2, '0')}/${(dataFim.getMonth() + 1).toString().padStart(2, '0')}/${dataFim.getFullYear()}`;
                }
                
                // Duas linhas: ve√≠culo e per√≠odo
                tooltipVeiculo.innerHTML = `üöó ${veiculo}<br>${periodoFormatado}`;
                tooltipVeiculo.classList.add('visible');
                
                posicionarTooltip(event);
            }
            
            // Fun√ß√£o para mostrar tooltip apenas com per√≠odo (para ve√≠culos e alocados)
            function mostrarTooltipPeriodo(event, idDemanda) {
                const demanda = dadosAgenda.demandas.find(d => d.id === idDemanda);
                if (!demanda) return;
                
                if (!tooltipVeiculo) {
                    tooltipVeiculo = document.getElementById('tooltipVeiculo');
                }
                
                // Formatar per√≠odo
                const dataInicio = new Date(demanda.dt_inicio + 'T00:00:00');
                const dataFim = new Date(demanda.dt_fim + 'T00:00:00');
                // const destino = new demanda.destino;
                
                let periodoFormatado;
                if (demanda.dt_inicio === demanda.dt_fim) {
                    // Data √∫nica
                    periodoFormatado = `${dataInicio.getDate().toString().padStart(2, '0')}/${(dataInicio.getMonth() + 1).toString().padStart(2, '0')}/${dataInicio.getFullYear()}`;
                } else {
                    // Per√≠odo
                    periodoFormatado = `${dataInicio.getDate().toString().padStart(2, '0')}/${(dataInicio.getMonth() + 1).toString().padStart(2, '0')} a ${dataFim.getDate().toString().padStart(2, '0')}/${(dataFim.getMonth() + 1).toString().padStart(2, '0')}/${dataFim.getFullYear()}`;
                }
                
                // Apenas o per√≠odo
                // tooltipVeiculo.innerHTML = periodoFormatado;
                tooltipVeiculo.innerHTML = `${periodoFormatado}<br>${demanda.destino}`;
                
                tooltipVeiculo.classList.add('visible');
                
                posicionarTooltip(event);
            }        
            
            // Fun√ß√£o para posicionar tooltip com detec√ß√£o de limites
            function posicionarTooltip(event) {
                if (!tooltipVeiculo) return;
                
                const tooltip = tooltipVeiculo;
                const offsetX = 10; // Dist√¢ncia do cursor horizontalmente
                const offsetY = 20; // Dist√¢ncia do cursor verticalmente
                
                // Obter dimens√µes do tooltip
                const tooltipRect = tooltip.getBoundingClientRect();
                const tooltipWidth = tooltipRect.width;
                const tooltipHeight = tooltipRect.height;
                
                // Obter dimens√µes da viewport
                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;
                
                // Posi√ß√£o inicial (abaixo e √† direita do cursor)
                let x = event.pageX + offsetX;
                let y = event.pageY + offsetY;
                
                // Verificar se ultrapassa a direita da p√°gina
                if (event.clientX + offsetX + tooltipWidth + 20 > viewportWidth) {
                    // Posicionar √† esquerda do cursor
                    x = event.pageX - tooltipWidth - offsetX;
                }
                
                // Verificar se ultrapassa o fundo da p√°gina
                if (event.clientY + offsetY + tooltipHeight > viewportHeight) {
                    // Posicionar acima do cursor
                    y = event.pageY - tooltipHeight - offsetY;
                }
                
                // Garantir que n√£o saia pela esquerda
                if (x < 0) {
                    x = offsetX;
                }
                
                // Garantir que n√£o saia pelo topo
                if (y < window.pageYOffset) {
                    y = window.pageYOffset + offsetY;
                }
                
                tooltip.style.left = x + 'px';
                tooltip.style.top = y + 'px';
            }
            
            // Fun√ß√£o para esconder tooltip
            function esconderTooltipVeiculo() {
                if (tooltipVeiculo) {
                    tooltipVeiculo.classList.remove('visible');
                }
            }
            
            // M√°scara para o campo hor√°rio
            function aplicarMascaraHorario(input) {
                let valor = input.value.replace(/\D/g, '');
                
                if (valor.length >= 2) {
                    valor = valor.substring(0, 2) + ':' + valor.substring(2, 4);
                }
                
                input.value = valor;
            }
            
            // Toggle do campo hor√°rio
            function toggleHorario() {
                const checkbox = document.getElementById('definirHorario');
                const inputHorario = document.getElementById('horario');
                
                if (checkbox.checked) {
                    inputHorario.disabled = false;
                    inputHorario.focus();
                } else {
                    inputHorario.disabled = true;
                    inputHorario.value = '';
                }
            }
            
            // Validar formato de hor√°rio
            function validarHorario(horario) {
                if (!horario) return true; // Vazio √© v√°lido
                
                const regex = /^([0-1][0-9]|2[0-3]):([0-5][0-9])$/;
                return regex.test(horario);
            }
            
            document.addEventListener('DOMContentLoaded', function() {
                // M√°scara de hor√°rio
                const inputHorario = document.getElementById('horario');
                if (inputHorario) {
                    inputHorario.addEventListener('input', function() {
                        aplicarMascaraHorario(this);
                    });
                }
                
                // Event listeners para datas (atualizar lista expandida)
                const dtInicio = document.getElementById('dtInicio');
                const dtFim = document.getElementById('dtFim');
                
                if (dtInicio && dtFim) {
                    dtInicio.addEventListener('change', function() {
                        const expandirCheckbox = document.getElementById('expandirVeiculos');
                        const idTipoVeiculo = document.getElementById('idTipoVeiculo').value;
                        
                        if (idTipoVeiculo === '1' && expandirCheckbox.checked) {
                            toggleExpandirVeiculos();
                        }
                    });
                    
                    dtFim.addEventListener('change', function() {
                        const expandirCheckbox = document.getElementById('expandirVeiculos');
                        const idTipoVeiculo = document.getElementById('idTipoVeiculo').value;
                        
                        if (idTipoVeiculo === '1' && expandirCheckbox.checked) {
                            toggleExpandirVeiculos();
                        }
                    });
                }

                // Event listener para exibir campo NC_MOTORISTA quando ID=0
                const selectMotorista = document.getElementById('idMotorista');
                if (selectMotorista) {
                    selectMotorista.addEventListener('change', function() {
                        const divNcMotorista = document.getElementById('divNcMotorista');
                        const inputNcMotorista = document.getElementById('ncMotorista');
                        
                        if (this.value === '0') {
                            divNcMotorista.style.display = 'block';
                            inputNcMotorista.required = true;
                        } else {
                            divNcMotorista.style.display = 'none';
                            inputNcMotorista.required = false;
                            inputNcMotorista.value = '';
                        }
                    });
                }

            });
            
            ////////////////////////////////////////////////////////////////////
            //////// LOCA√á√ÉO DE VEICULOS //////////////////////////////////////
            ///////////////////////////////////////////////////////////////////

            // ========== MODIFICAR FUN√á√ÉO: verificarESolicitarLocacao ==========
            async function verificarESolicitarLocacao(idDemanda, dadosDemanda) {
                try {
                    // Verificar se tem os dados necess√°rios
                    if (!dadosDemanda.id_tipoveiculo || !dadosDemanda.id_motorista) {
                        return; // N√£o faz nada
                    }
                    
                    // Verificar se motorista √© cadastrado (> 0)
                    if (parseInt(dadosDemanda.id_motorista) <= 0) {
                        return; // N√£o faz nada para motorista n√£o cadastrado
                    }
                    
                    // Chamar API para verificar v√≠nculo
                    const url = `/api/verificar_vinculo_locacao?id_tipoveiculo=${dadosDemanda.id_tipoveiculo}&id_motorista=${dadosDemanda.id_motorista}`;
                    const res = await fetch(url);
                    const resultado = await res.json();
                    
                    if (!resultado.tem_vinculo) {
                        return; // N√£o tem v√≠nculo, n√£o faz nada
                    }
                    
                    // Guardar dados do v√≠nculo
                    dadosVinculoLocacao = resultado;
                    idDemandaParaLocacao = idDemanda;
                    
                    // ====== USAR MODAL PERSONALIZADO ======
                    mostrarModalConfirmacaoLocacao(async function(resposta) {
                        if (resposta) {
                            // Usu√°rio clicou em "Sim, solicitar"
                            await abrirFormularioLocacao(dadosDemanda);
                        }
                        // Se clicar em "N√£o", n√£o faz nada
                    });
                    // ====== FIM DO USO DO MODAL ======
                    
                } catch (error) {
                    console.error('Erro ao verificar loca√ß√£o:', error);
                }
            }

            // ========== MODIFICAR FUN√á√ÉO: abrirFormularioLocacao ==========
            async function abrirFormularioLocacao(dadosDemanda) {
                try {
                    // Preencher campos ocultos
                    document.getElementById('loc_id_cl').value = dadosVinculoLocacao.id_cl;
                    document.getElementById('loc_id_veiculo_loc').value = dadosVinculoLocacao.id_veiculo_loc;
                    document.getElementById('loc_id_motorista').value = dadosDemanda.id_motorista;
                    document.getElementById('loc_vl_diaria').value = dadosVinculoLocacao.vl_diaria_km;
                    
                    // Preencher empenhos
                    const selectEmpenho = document.getElementById('loc_id_empenho');
                    selectEmpenho.innerHTML = '<option value="">Selecione...</option>';
                    
                    dadosVinculoLocacao.empenhos.forEach(emp => {
                        selectEmpenho.innerHTML += `<option value="${emp.id}">${emp.numero}</option>`;
                    });
                    
                    // Se houver apenas um empenho, selecionar automaticamente
                    if (dadosVinculoLocacao.empenhos.length === 1) {
                        selectEmpenho.value = dadosVinculoLocacao.empenhos[0].id;
                    }
                    
                    // ====== BUSCAR NOME DO MOTORISTA ======
                    let nomeMotorista = 'N√£o identificado';
                    
                    // Procurar em motoristas SEGEOP
                    let motoristaEncontrado = motoristas.find(m => m.id == dadosDemanda.id_motorista);
                    
                    // Se n√£o encontrou, procurar em outros motoristas
                    if (!motoristaEncontrado && outrosMotoristas) {
                        motoristaEncontrado = outrosMotoristas.find(m => m.id == dadosDemanda.id_motorista);
                    }
                    
                    // Se n√£o encontrou, procurar em todos_motoristas
                    if (!motoristaEncontrado && dadosAgenda.todos_motoristas) {
                        motoristaEncontrado = dadosAgenda.todos_motoristas.find(m => m.id == dadosDemanda.id_motorista);
                    }
                    
                    // Se encontrou, usar o nome
                    if (motoristaEncontrado) {
                        nomeMotorista = motoristaEncontrado.nome;
                    } else if (dadosDemanda.nm_motorista) {
                        // Se veio da demanda carregada
                        nomeMotorista = dadosDemanda.nm_motorista;
                    }
                    
                    document.getElementById('loc_nome_motorista').value = nomeMotorista;
                    document.getElementById('loc_tipo_veiculo').value = dadosVinculoLocacao.de_veiculo_loc;
                    
                    // ====== FIM DA BUSCA DO NOME ======
                    
                    // Preencher campos da demanda
                    document.getElementById('loc_setor').value = dadosDemanda.setor || '';
                    document.getElementById('loc_objetivo').value = dadosDemanda.destino || ''; // Objetivo baseado em destino
                    document.getElementById('loc_nu_sei').value = dadosDemanda.nu_sei || '';
                    document.getElementById('loc_dt_inicio').value = dadosDemanda.dt_inicio;
                    document.getElementById('loc_dt_fim').value = dadosDemanda.dt_fim;
                    
                    // ====== PREENCHER HOR√ÅRIO - CORRIGIDO ======
                    let horarioInicial = dadosDemanda.horario || '07:00';
                    document.getElementById('loc_horario').value = horarioInicial;
                    // ====== FIM CORRE√á√ÉO HOR√ÅRIO ======
                    
                    // Calcular di√°rias
                    calcularDiariasLocacao();
                                
                    // ====== MODIFICAR EXIBI√á√ÉO DO STATUS DA CNH ======
                    const statusCNHDiscrete = document.getElementById('statusCNHDiscrete');
                    const divUploadCNH = document.getElementById('loc_divUploadCNH');
                    
                    if (dadosVinculoLocacao.tem_cnh) {
                        statusCNHDiscrete.style.background = '#d4edda';
                        statusCNHDiscrete.style.color = '#155724';
                        statusCNHDiscrete.style.border = '1px solid #c3e6cb';
                        statusCNHDiscrete.innerHTML = '‚úì CNH anexada';
                        divUploadCNH.style.display = 'none';
                    } else {
                        statusCNHDiscrete.style.background = '#f8d7da';
                        statusCNHDiscrete.style.color = '#721c24';
                        statusCNHDiscrete.style.border = '1px solid #f5c6cb';
                        statusCNHDiscrete.innerHTML = '‚ö† CNH n√£o anexada';
                        divUploadCNH.style.display = 'block';
                    }
                    // ====== FIM DA MODIFICA√á√ÉO ======
                    
                    // Contador de caracteres para observa√ß√µes
                    document.getElementById('loc_obs').addEventListener('input', function() {
                        document.getElementById('loc_charCount').textContent = this.value.length;
                    });
                    
                    // Abrir modal
                    document.getElementById('modalFormLocacao').style.display = 'block';
                    
                } catch (error) {
                    console.error('Erro ao abrir formul√°rio de loca√ß√£o:', error);
                    alert('Erro ao abrir formul√°rio de loca√ß√£o!');
                }
            }

            // ========== FUN√á√ÉO: Calcular Di√°rias e Valores ==========
            function calcularDiariasLocacao() {
                const dtInicio = document.getElementById('loc_dt_inicio').value;
                const dtFim = document.getElementById('loc_dt_fim').value;
                const vlDiaria = parseFloat(document.getElementById('loc_vl_diaria').value);
                
                if (!dtInicio || !dtFim || !vlDiaria) return;
                
                const dataInicio = new Date(dtInicio + 'T00:00:00');
                const dataFim = new Date(dtFim + 'T00:00:00');
                
                // Calcular quantidade de di√°rias
                let qtDiarias = 1; // Padr√£o
                
                if (dtInicio === dtFim) {
                    qtDiarias = 1; // Mesmo dia = 1 di√°ria
                } else {
                    const diffTime = dataFim.getTime() - dataInicio.getTime();
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    qtDiarias = diffDays > 0 ? diffDays : 1;
                }
                
                // Calcular valores
                const vlSubTotal = qtDiarias * vlDiaria;
                const vlTotal = vlSubTotal; // Por enquanto sem diferen√ßas
                
                // Preencher campos
                document.getElementById('loc_qt_diarias').value = qtDiarias;
                document.getElementById('loc_vl_diaria_display').value = vlDiaria.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                document.getElementById('loc_vl_total').value = vlTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            }

            // ========== FUN√á√ÉO: Fechar Modal de Loca√ß√£o ==========
            function fecharModalFormLocacao() {
                document.getElementById('modalFormLocacao').style.display = 'none';
                document.getElementById('formSolicitacaoLocacao').reset();
                dadosVinculoLocacao = null;
                idDemandaParaLocacao = null;
            }

            // ========== FUN√á√ÉO: Fechar Modal de Sucesso ==========
            async function fecharModalSucessoLocacao() {    
                document.getElementById('modalSucessoLocacao').style.display = 'none';
                await carregarAgenda();
            }

            // ========== FUN√á√ÉO CORRETA: confirmarSolicitacaoLocacao ==========
            async function confirmarSolicitacaoLocacao(event) {
                // Prevenir comportamento padr√£o
                if (event) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                
                try {
                    // Validar campos obrigat√≥rios
                    const idEmpenho = document.getElementById('loc_id_empenho').value;
                    const objetivo = document.getElementById('loc_objetivo').value.trim();
                    const horario = document.getElementById('loc_horario').value;
                    
                    if (!idEmpenho) {
                        mostrarAlerta('Selecione um empenho!', '‚ö†Ô∏è Aten√ß√£o', '#ffc107');
                        return;
                    }
                    
                    if (!objetivo) {
                        mostrarAlerta('Preencha o objetivo da loca√ß√£o!', '‚ö†Ô∏è Aten√ß√£o', '#ffc107');
                        return;
                    }
                    
                    // Validar hor√°rio obrigat√≥rio
                    if (!horario) {
                        mostrarAlerta('Informe o hor√°rio de in√≠cio da loca√ß√£o!', '‚ö†Ô∏è Aten√ß√£o', '#ffc107');
                        document.getElementById('loc_horario').focus();
                        return;
                    }
                    
                    // Se n√£o tem CNH, verificar se arquivo foi anexado
                    if (!dadosVinculoLocacao.tem_cnh) {
                        const arquivoCNH = document.getElementById('loc_arquivo_cnh').files[0];
                        if (!arquivoCNH) {
                            mostrarAlerta('√â necess√°rio anexar a CNH do motorista para prosseguir!', '‚ö†Ô∏è Aten√ß√£o', '#ffc107');
                            return;
                        }
                        
                        // Validar se √© PDF
                        if (arquivoCNH.type !== 'application/pdf') {
                            mostrarAlerta('O arquivo deve ser um PDF!', '‚ö†Ô∏è Aten√ß√£o', '#ffc107');
                            return;
                        }
                    }
                    
                    // Preparar dados para envio
                    const formData = new FormData();
                    
                    // Dados principais
                    formData.append('id_cl', document.getElementById('loc_id_cl').value);
                    formData.append('empenho', idEmpenho);
                    formData.append('setor_solicitante', document.getElementById('loc_setor').value);
                    formData.append('objetivo', objetivo);
                    formData.append('id_veiculo_loc', document.getElementById('loc_id_veiculo_loc').value);
                    formData.append('id_motorista', document.getElementById('loc_id_motorista').value);
                    formData.append('data_inicio', document.getElementById('loc_dt_inicio').value);
                    formData.append('data_fim', document.getElementById('loc_dt_fim').value);
                    formData.append('hora_inicio', horario);
                    formData.append('qt_diaria_km', document.getElementById('loc_qt_diarias').value);
                    
                    // Valores
                    const vlDiaria = document.getElementById('loc_vl_diaria').value;
                    const vlTotal = document.getElementById('loc_vl_total').value.replace(/\./g, '').replace(',', '.');
                    
                    formData.append('vl_dk', vlDiaria);
                    formData.append('vl_totalitem', vlTotal);
                    formData.append('nu_sei', document.getElementById('loc_nu_sei').value);
                    formData.append('obs', document.getElementById('loc_obs').value);
                    
                    // Anexar CNH se necess√°rio
                    if (!dadosVinculoLocacao.tem_cnh) {
                        const arquivoCNH = document.getElementById('loc_arquivo_cnh').files[0];
                        formData.append('file_cnh', arquivoCNH);
                    }
                    
                    // Mostrar spinner de carregamento
                    mostrarSpinner();
                    
                    // Enviar para API
                    const response = await fetch('/api/nova_locacao', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const resultado = await response.json();
                    
                    esconderSpinner();
                    
                    if (response.ok && resultado) {
                        // Construir mensagem
                        let mensagemHTML = '<div style="font-size: 16px; font-weight: 600; color: #28a745; margin-bottom: 10px;">Loca√ß√£o solicitada com sucesso!</div>';
                        
                        if (resultado.email_enviado) {
                            mensagemHTML += '<div style="font-size: 14px; color: #666;">üìß E-mail de notifica√ß√£o enviado.</div>';
                        } else if (resultado.erro_email) {
                            mensagemHTML += '<div style="font-size: 13px; color: #856404; background: #fff3cd; padding: 8px; border-radius: 4px; margin-top: 10px;">‚ö†Ô∏è A loca√ß√£o foi registrada, mas houve erro ao enviar e-mail.</div>';
                        }
                        
                        // Mostrar modal de sucesso
                        document.getElementById('mensagemSucessoLocacao').innerHTML = mensagemHTML;
                        document.getElementById('modalSucessoLocacao').style.display = 'block';
                        
                        // Fechar modal de loca√ß√£o
                        fecharModalFormLocacao();
                        
                    } else {
                        // Erro
                        const mensagemErro = resultado.mensagem || resultado.erro || 'Erro ao solicitar loca√ß√£o';
                        mostrarAlerta('Erro: ' + mensagemErro, '‚ùå Erro', '#dc3545');
                    }
                    
                } catch (error) {
                    esconderSpinner();
                    console.error('Erro ao confirmar solicita√ß√£o:', error);
                    mostrarAlerta('Erro ao solicitar loca√ß√£o: ' + error.message, '‚ùå Erro', '#dc3545');
                }
            }

            // ========== FUN√á√ÉO CORRETA: verificarBotaoLocacaoEdicao ==========
            async function verificarBotaoLocacaoEdicao(idAd) {
                try {
                    const demanda = dadosAgenda.demandas.find(d => d.id === idAd);
                    if (!demanda) return;
                    
                    // Verificar condi√ß√µes b√°sicas
                    if (!demanda.id_tipoveiculo || !demanda.id_motorista || parseInt(demanda.id_motorista) <= 0) {
                        return; // N√£o mostra nada
                    }
                    
                    // Verificar se tem v√≠nculo
                    const urlVinculo = `/api/verificar_vinculo_locacao?id_tipoveiculo=${demanda.id_tipoveiculo}&id_motorista=${demanda.id_motorista}`;
                    const resVinculo = await fetch(urlVinculo);
                    const resultVinculo = await resVinculo.json();
                    
                    if (!resultVinculo.tem_vinculo) {
                        return; // N√£o tem v√≠nculo, n√£o mostra nada
                    }
                    
                    // ========== VERIFICAR SE J√Å TEM LOCA√á√ÉO (MESMA L√ìGICA DA SE√á√ÉO VE√çCULOS ALOCADOS) ==========
                    // Verificar se existe loca√ß√£o ativa para este motorista neste per√≠odo
                    const temLocacao = locacoesAtivas.some(loc => 
                        loc.id_motorista === demanda.id_motorista &&
                        loc.data_inicio <= demanda.dt_fim &&
                        loc.data_fim >= demanda.dt_inicio
                    );
                    
                    // Criar elemento para status/bot√£o
                    const modalFooter = document.querySelector('#modal .modal-footer');
                    
                    // Remover elementos anteriores se existirem
                    const elementoExistente = document.getElementById('areaLocacaoStatus');
                    if (elementoExistente) {
                        elementoExistente.remove();
                    }
                    
                    // Criar novo elemento
                    const divStatus = document.createElement('div');
                    divStatus.id = 'areaLocacaoStatus';
                    divStatus.style.cssText = 'flex: 1; display: flex; align-items: center; gap: 10px;';
                    
                    if (temLocacao) {
                        // ========== J√Å TEM LOCA√á√ÉO - APENAS MOSTRAR TEXTO ==========
                        divStatus.innerHTML = `
                            <div style="background: #d4edda; color: #155724; padding: 8px 12px; border-radius: 4px; font-size: 13px; font-weight: 600; border: 1px solid #c3e6cb;">
                                ‚úì Loca√ß√£o solicitada
                            </div>
                        `;
                        
                    } else {
                        // ========== N√ÉO TEM LOCA√á√ÉO - MOSTRAR BOT√ÉO PARA SOLICITAR ==========
                        divStatus.innerHTML = `
                            <button type="button" class="btn btn-primary" id="btnSolicitarLocacaoEdicao" style="background: #28a745; border-color: #28a745;">
                                üöó Solicitar Loca√ß√£o
                            </button>
                        `;
                        
                        // Guardar dados do v√≠nculo para uso posterior
                        dadosVinculoLocacao = resultVinculo;
                        
                        // Adicionar event listener ao bot√£o
                        setTimeout(() => {
                            const btnSolicitar = document.getElementById('btnSolicitarLocacaoEdicao');
                            if (btnSolicitar) {
                                btnSolicitar.addEventListener('click', async function(e) {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    
                                    // Abrir formul√°rio de loca√ß√£o
                                    await abrirFormularioLocacao(demanda);
                                });
                            }
                        }, 100);
                    }
                    
                    // Inserir antes dos bot√µes de a√ß√£o
                    const btnCancelar = modalFooter.querySelector('.btn-secondary');
                    if (btnCancelar) {
                        modalFooter.insertBefore(divStatus, btnCancelar);
                    }
                    
                } catch (error) {
                    console.error('Erro ao verificar bot√£o de loca√ß√£o:', error);
                }
            }

            // ========== FUN√á√ÉO: Mostrar Modal de Confirma√ß√£o Personalizado ==========
            function mostrarModalConfirmacaoLocacao(callback) {
                callbackConfirmacaoLocacao = callback;
                document.getElementById('modalConfirmacaoLocacao').style.display = 'block';
            }

            // ========== FUN√á√ÉO: Fechar Modal de Confirma√ß√£o ==========
            function fecharModalConfirmacaoLocacao(resposta) {
                document.getElementById('modalConfirmacaoLocacao').style.display = 'none';
                
                if (callbackConfirmacaoLocacao) {
                    callbackConfirmacaoLocacao(resposta);
                    callbackConfirmacaoLocacao = null;
                }
            }


            ///////////////////////////////////////////////////////////////////
            ///////// FIM LOCA√á√ïES DE VE√çCULOS ////////////////////////////////
            ///////////////////////////////////////////////////////////////////

            // ========== AUTOCOMPLETE SETOR ==========

            async function buscarSetores(termo) {
                if (termo.length < 2) {
                    esconderAutocompleteSetor();
                    return;
                }
                
                try {
                    const res = await fetch(`/api/agenda_busca_setor?termo=${encodeURIComponent(termo)}`);
                    const setores = await res.json();
                    
                    if (setores.length > 0) {
                        exibirAutocompleteSetor(setores, termo);
                    } else {
                        esconderAutocompleteSetor();
                    }
                } catch (error) {
                    console.error('Erro ao buscar setores:', error);
                    esconderAutocompleteSetor();
                }
            }

            function exibirAutocompleteSetor(setores, termo) {
                const lista = document.getElementById('setorAutocompleteList');
                const termoLower = termo.toLowerCase();
                
                lista.innerHTML = setores.map((setor, index) => {
                    // Destacar o termo buscado
                    const indexTermo = setor.toLowerCase().indexOf(termoLower);
                    let setorHTML = setor;
                    
                    if (indexTermo !== -1) {
                        const antes = setor.substring(0, indexTermo);
                        const match = setor.substring(indexTermo, indexTermo + termo.length);
                        const depois = setor.substring(indexTermo + termo.length);
                        setorHTML = `${antes}<span class="autocomplete-item-highlight">${match}</span>${depois}`;
                    }
                    
                    return `<div class="autocomplete-item" data-index="${index}" data-value="${setor}">${setorHTML}</div>`;
                }).join('');
                
                lista.classList.add('visible');
                setorSelectedIndex = -1;
                
                // Adicionar eventos de clique nos itens
                lista.querySelectorAll('.autocomplete-item').forEach(item => {
                    item.addEventListener('click', function() {
                        selecionarSetor(this.dataset.value);
                    });
                    
                    item.addEventListener('mouseenter', function() {
                        removerSelecaoAutocomplete();
                        this.classList.add('selected');
                        setorSelectedIndex = parseInt(this.dataset.index);
                    });
                });
            }

            function esconderAutocompleteSetor() {
                const lista = document.getElementById('setorAutocompleteList');
                lista.classList.remove('visible');
                lista.innerHTML = '';
                setorSelectedIndex = -1;
            }

            function selecionarSetor(valor) {
                document.getElementById('setor').value = valor;
                esconderAutocompleteSetor();
            }

            function removerSelecaoAutocomplete() {
                const lista = document.getElementById('setorAutocompleteList');
                lista.querySelectorAll('.autocomplete-item').forEach(item => {
                    item.classList.remove('selected');
                });
            }

            function navegarAutocompleteSetor(direcao) {
                const lista = document.getElementById('setorAutocompleteList');
                const itens = lista.querySelectorAll('.autocomplete-item');
                
                if (itens.length === 0) return;
                
                removerSelecaoAutocomplete();
                
                if (direcao === 'down') {
                    setorSelectedIndex = (setorSelectedIndex + 1) % itens.length;
                } else if (direcao === 'up') {
                    setorSelectedIndex = setorSelectedIndex <= 0 ? itens.length - 1 : setorSelectedIndex - 1;
                }
                
                if (setorSelectedIndex >= 0 && setorSelectedIndex < itens.length) {
                    itens[setorSelectedIndex].classList.add('selected');
                    itens[setorSelectedIndex].scrollIntoView({ block: 'nearest' });
                }
            }

            function initAutocompleteSetor() {
                const inputSetor = document.getElementById('setor');
                
                if (!inputSetor) return;
                
                // Evento de digita√ß√£o
                inputSetor.addEventListener('input', function() {
                    const termo = this.value.trim();
                    
                    // Debounce para evitar muitas requisi√ß√µes
                    if (setorAutocompleteTimeout) {
                        clearTimeout(setorAutocompleteTimeout);
                    }
                    
                    setorAutocompleteTimeout = setTimeout(() => {
                        buscarSetores(termo);
                    }, 300);
                });
                
                // Navega√ß√£o com teclado
                inputSetor.addEventListener('keydown', function(e) {
                    const lista = document.getElementById('setorAutocompleteList');
                    
                    if (!lista.classList.contains('visible')) return;
                    
                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        navegarAutocompleteSetor('down');
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        navegarAutocompleteSetor('up');
                    } else if (e.key === 'Enter') {
                        e.preventDefault();
                        const itens = lista.querySelectorAll('.autocomplete-item');
                        if (setorSelectedIndex >= 0 && setorSelectedIndex < itens.length) {
                            selecionarSetor(itens[setorSelectedIndex].dataset.value);
                        }
                    } else if (e.key === 'Escape') {
                        esconderAutocompleteSetor();
                    }
                });
                
                // Esconder ao perder foco (com delay para permitir clique)
                inputSetor.addEventListener('blur', function() {
                    setTimeout(() => {
                        esconderAutocompleteSetor();
                    }, 200);
                });
                
                // Mostrar novamente ao focar se tiver texto
                inputSetor.addEventListener('focus', function() {
                    const termo = this.value.trim();
                    if (termo.length >= 2) {
                        buscarSetores(termo);
                    }
                });
            }

            // ========== FIM AUTOCOMPLETE SETOR ==========

            // Fun√ß√£o para adicionar destaque nas c√©lulas N. e Nome ao passar mouse
            function inicializarDestaqueLinha() {
                // Aguardar a renderiza√ß√£o completa
                setTimeout(() => {
                    // Selecionar todas as linhas de todas as tabelas
                    const todasLinhas = document.querySelectorAll('.agenda-table tbody tr');
                    
                    todasLinhas.forEach(linha => {
                        // Pegar as c√©lulas N. e Nome desta linha
                        const celulaNome = linha.querySelector('.col-nome');
                        const celulaNumero = linha.querySelector('.col-numero');
                        
                        if (!celulaNome && !celulaNumero) return;
                        
                        // Adicionar evento em todas as c√©lulas da linha
                        const celulas = linha.querySelectorAll('td');
                        
                        celulas.forEach(celula => {
                            // Mouseenter - adicionar destaque
                            celula.addEventListener('mouseenter', function() {
                                if (celulaNumero) {
                                    // Escolha um dos tr√™s efeitos:
                                    celulaNumero.classList.add('row-hover-combined'); // Escurecer + Zoom combinados
                                    // celulaNumero.classList.add('row-hover'); // Apenas escurecer
                                    // celulaNumero.classList.add('row-hover-zoom'); // Apenas zoom
                                }
                                if (celulaNome) {
                                    celulaNome.classList.add('row-hover-combined'); // Escurecer + Zoom combinados
                                    // celulaNome.classList.add('row-hover'); // Apenas escurecer
                                    // celulaNome.classList.add('row-hover-zoom'); // Apenas zoom
                                }
                            });
                            
                            // Mouseleave - remover destaque
                            celula.addEventListener('mouseleave', function() {
                                if (celulaNumero) {
                                    celulaNumero.classList.remove('row-hover-combined');
                                    celulaNumero.classList.remove('row-hover');
                                    celulaNumero.classList.remove('row-hover-zoom');
                                }
                                if (celulaNome) {
                                    celulaNome.classList.remove('row-hover-combined');
                                    celulaNome.classList.remove('row-hover');
                                    celulaNome.classList.remove('row-hover-zoom');
                                }
                            });
                        });
                    });
                }, 500); // Aguardar 500ms para garantir que as tabelas foram renderizadas
            }
            
            async function init() {
                await carregarSemanas();
                await carregarSelectsFixos();
                if (semanas.length > 0) {
                    const hoje = new Date();
                    hoje.setHours(0, 0, 0, 0);

                    // console.log('=== DEBUG SEMANA ATUAL ===');
                    // console.log('Data hoje:', hoje);
                    // console.log('Data hoje ISO:', hoje.toISOString().split('T')[0]);                
                    
                    let semanaEncontrada = -1;
                    for (let i = 0; i < semanas.length; i++) {
                        const inicio = new Date(semanas[i].inicio + 'T00:00:00');
                        const fim = new Date(semanas[i].fim + 'T00:00:00');

                        // console.log(`Semana ${i}: ${semanas[i].label}`);
                        // console.log(`  Inicio: ${inicio.toISOString().split('T')[0]}`);
                        // console.log(`  Fim: ${fim.toISOString().split('T')[0]}`);
                        // console.log(`  Hoje >= Inicio? ${hoje >= inicio}`);
                        // console.log(`  Hoje <= Fim? ${hoje <= fim}`);
                                    
                        if (hoje >= inicio && hoje <= fim) {
                            semanaEncontrada = i;
                            // console.log(`  ‚úì SEMANA ENCONTRADA: √≠ndice ${i}`);
                            break;
                        }
                    }

                    // console.log('Semana encontrada (√≠ndice):', semanaEncontrada);
                    // console.log('=========================');
                    
                    semanaAtual = semanaEncontrada !== -1 ? semanaEncontrada : semanas.length - 1;
                    
                    renderizarAbas();
                    
                    await carregarLocacoes();
                    await carregarFeriadosPeriodo();
                    await carregarAgenda();
                }

                // Inicializar autocomplete do setor
                initAutocompleteSetor();
            }

            // Carregar feriados do per√≠odo atual
            async function carregarFeriadosPeriodo() {
                try {
                    const semana = semanas[semanaAtual];
                    const res = await fetch(`/api/agenda/feriados-periodo?inicio=${semana.inicio}&fim=${semana.fim}`);
                    feriadosPeriodo = await res.json();
                } catch (error) {
                    console.error('Erro ao carregar feriados do per√≠odo:', error);
                    feriadosPeriodo = [];
                }
            }

            // Abrir modal de feriados
            async function abrirModalFeriados() {
                document.getElementById('modalFeriados').style.display = 'block';
                await carregarListaFeriados();
            }

            // Fechar modal de feriados
            function fecharModalFeriados() {
                document.getElementById('modalFeriados').style.display = 'none';
            }

            // Carregar lista de todos os feriados
            async function carregarListaFeriados() {
                const lista = document.getElementById('feriadosLista');
                lista.innerHTML = '<div class="loading">Carregando...</div>';
                
                try {
                    const res = await fetch('/api/agenda/feriados');
                    const feriados = await res.json();
                    
                    if (feriados.length === 0) {
                        lista.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Nenhum feriado cadastrado</div>';
                        return;
                    }
                    
                    lista.innerHTML = feriados.map(f => {
                        const data = new Date(f.dt_feriado + 'T00:00:00');
                        const dataFormatada = data.toLocaleDateString('pt-BR', { 
                            day: '2-digit', 
                            month: '2-digit', 
                            year: 'numeric',
                            weekday: 'short'
                        });
                        
                        return `
                            <div class="feriado-item">
                                <div class="feriado-info">
                                    <div class="feriado-descricao">${f.descricao}</div>
                                    <div class="feriado-data">${dataFormatada}</div>
                                </div>
                                <button class="btn-icon" onclick="excluirFeriado(${f.id})" title="Excluir">üóëÔ∏è</button>
                            </div>
                        `;
                    }).join('');
                    
                } catch (error) {
                    console.error('Erro ao carregar lista de feriados:', error);
                    lista.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">Erro ao carregar feriados</div>';
                }
            }

            // Adicionar novo feriado
            async function adicionarFeriado() {
                const tipo = document.getElementById('tipoFeriado').value;
                const data = document.getElementById('dataFeriado').value;
                
                if (!data) {
                    alert('Informe a data do feriado!');
                    return;
                }
                
                try {
                    const res = await fetch('/api/agenda/feriado', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            descricao: tipo,
                            dt_feriado: data
                        })
                    });
                    
                    const result = await res.json();
                    
                    if (result.success) {
                        document.getElementById('dataFeriado').value = '';
                        await carregarListaFeriados();
                        await carregarFeriadosPeriodo();
                        await carregarAgenda();
                    }
                } catch (error) {
                    console.error('Erro ao adicionar feriado:', error);
                }
            }

            // Excluir feriado
            async function excluirFeriado(id) {
                try {
                    const res = await fetch(`/api/agenda/feriado/${id}`, {
                        method: 'DELETE'
                    });
                    
                    const result = await res.json();
                    
                    if (result.success) {
                        await carregarListaFeriados();
                        await carregarFeriadosPeriodo();
                        await carregarAgenda();
                    }
                } catch (error) {
                    console.error('Erro ao excluir feriado:', error);
                }
            }

            // Verificar se uma data √© feriado
            function isFeriado(data) {
                return feriadosPeriodo.find(f => f.dt_feriado === data);
            }


            async function carregarLocacoes() {
                try {
                    const semana = semanas[semanaAtual];
                    const res = await fetch(`/api/agenda/locacoes?inicio=${semana.inicio}&fim=${semana.fim}`);
                    locacoesAtivas = await res.json();
                } catch (error) {
                    console.error('Erro ao carregar loca√ß√µes:', error);
                    locacoesAtivas = [];
                }
            }
            
            async function carregarSemanas() {
                try {
                    const res = await fetch('/api/agenda/semanas');
                    const data = await res.json();
                    
                    if (data.error) {
                        console.error('Erro na API:', data.error);
                        semanas = data.semanas || [];
                    } else if (Array.isArray(data)) {
                        semanas = data;
                    } else {
                        semanas = [];
                    }
                    
                    // renderizarAbas();
                } catch (error) {
                    console.error('Erro ao carregar semanas:', error);
                    semanas = [];
                    const hoje = new Date();
                    const domingo = new Date(hoje);
                    domingo.setDate(hoje.getDate() - ((hoje.getDay() + 7) % 7));
                    const sabado = new Date(domingo);
                    sabado.setDate(domingo.getDate() + 6);
                    
                    semanas = [{
                        inicio: domingo.toISOString().split('T')[0],
                        fim: sabado.toISOString().split('T')[0],
                        label: `${domingo.getDate()}/${domingo.getMonth()+1} - ${sabado.getDate()}/${sabado.getMonth()+1}/${sabado.getFullYear()}`
                    }];
                    // renderizarAbas();
                }
            }
            
            async function carregarSelectsFixos() {
                try {
                    const [resTiposDemanda, resTiposVeiculo] = await Promise.all([
                        fetch('/api/agenda/tipos-demanda'),
                        fetch('/api/agenda/tipos-veiculo')
                    ]);
                    
                    tiposDemanda = await resTiposDemanda.json();
                    tiposVeiculo = await resTiposVeiculo.json();
                    
                    const selectTipoDemanda = document.getElementById('idTipoDemanda');
                    const selectTipoVeiculo = document.getElementById('idTipoVeiculo');
                    
                    selectTipoDemanda.innerHTML = '<option value="">Selecione...</option>';
                    tiposDemanda.forEach(t => {
                        selectTipoDemanda.innerHTML += `<option value="${t.id}" data-descricao="${t.descricao}">${t.descricao}</option>`;
                    });
                    
                    selectTipoVeiculo.innerHTML = '<option value="">Selecione...</option>';
                    tiposVeiculo.forEach(t => {
                        selectTipoVeiculo.innerHTML += `<option value="${t.id}">${t.descricao}</option>`;
                    });
                    
                    // Event listeners para regras de neg√≥cio
                    selectTipoDemanda.addEventListener('change', aplicarRegrasTipoDemanda);
                    selectTipoVeiculo.addEventListener('change', aplicarRegrasTipoVeiculo);
                    document.getElementById('dtInicio').addEventListener('change', atualizarVeiculosDisponiveis);
                    document.getElementById('dtFim').addEventListener('change', atualizarVeiculosDisponiveis);
                } catch (error) {
                    console.error('Erro ao carregar selects:', error);
                }
            }
            
            function aplicarRegrasTipoDemanda() {
                const idTipoDemanda = parseInt(document.getElementById('idTipoDemanda').value);
                const selectTipoDemanda = document.getElementById('idTipoDemanda');
                const optionSelecionada = selectTipoDemanda.options[selectTipoDemanda.selectedIndex];
                const descricaoTipoDemanda = optionSelecionada ? optionSelecionada.getAttribute('data-descricao') : '';
                
                const motorista = document.getElementById('idMotorista');
                const tipoVeiculo = document.getElementById('idTipoVeiculo');
                const veiculo = document.getElementById('idVeiculo');
                const setor = document.getElementById('setor');
                const solicitante = document.getElementById('solicitante');
                const destino = document.getElementById('destino');
                
                const labelTipoVeiculo = document.getElementById('labelTipoVeiculo');
                const labelVeiculo = document.getElementById('labelVeiculo');
                const labelSetor = document.getElementById('labelSetor');
                const labelSolicitante = document.getElementById('labelSolicitante');
                const labelDestino = document.getElementById('labelDestino');
                const labelMotorista = document.getElementById('labelMotorista');
                
                // Resetar labels
                labelTipoVeiculo.innerHTML = 'Tipo de Ve√≠culo';
                labelVeiculo.innerHTML = 'Ve√≠culo';
                labelSetor.innerHTML = 'Setor';
                labelSolicitante.innerHTML = 'Solicitante';
                labelDestino.innerHTML = 'Destino';
                
                if (labelMotorista) {
                    labelMotorista.innerHTML = 'Motorista <span class="required">*</span>';
                }
                
                // Habilitar todos primeiro
                motorista.disabled = false;
                motorista.required = true;
                tipoVeiculo.disabled = false;
                veiculo.disabled = false;
                setor.disabled = false;
                solicitante.disabled = false;
                destino.disabled = false;
                
                if (idTipoDemanda === 10) {
                    // ID 10 (Ced√™ncia): Motorista n√£o obrigat√≥rio, Setor obrigat√≥rio
                    motorista.required = false;
                    if (labelMotorista) {
                        labelMotorista.innerHTML = 'Motorista';
                    }
                    
                    // Setor obrigat√≥rio
                    setor.disabled = false;
                    labelSetor.innerHTML = 'Setor <span class="required">*</span>';
                    
                    // Solicitante aberto mas n√£o obrigat√≥rio
                    solicitante.disabled = false;
                    
                } else if (idTipoDemanda === 9 || idTipoDemanda === 12) {
                    // ID 9 (Oficina): Motorista n√£o obrigat√≥rio, fecha Setor e Solicitante
                    motorista.required = false;
                    if (labelMotorista) {
                        labelMotorista.innerHTML = 'Motorista';
                    }
                    
                    setor.disabled = true;
                    setor.value = '';
                    solicitante.disabled = true;
                    solicitante.value = '';
                    
                } else if (idTipoDemanda >= 6 && idTipoDemanda <= 8) {
                    // ID 6-8: Fecha e desobriga Tipo Ve√≠culo, Ve√≠culo, Setor, Solicitante, Destino
                    tipoVeiculo.disabled = true;
                    tipoVeiculo.value = '';
                    veiculo.disabled = true;
                    veiculo.value = '';
                    setor.disabled = true;
                    setor.value = '';
                    solicitante.disabled = true;
                    solicitante.value = '';
                    destino.disabled = true;
                    if (!destino.value) {
                        destino.value = descricaoTipoDemanda;
                    }
                } else if (idTipoDemanda === 4 || idTipoDemanda === 5) {
                    // ID 4-5: Setor e Solicitante podem ficar em branco, Destino = DE_TIPODEMANDA
                    if (!destino.value) {
                        destino.value = descricaoTipoDemanda;
                    }
                } else if (idTipoDemanda === 3) {
                    // ID 3: Setor e Solicitante podem ficar em branco, Destino usu√°rio preenche
                    // N√£o preenche automaticamente
                } else if (idTipoDemanda === 1 || idTipoDemanda === 2 || idTipoDemanda === 11) {
                    labelSetor.innerHTML = 'Setor';
                    labelSolicitante.innerHTML = 'Solicitante';
                }
            }
                    
            function aplicarRegrasTipoVeiculo() {
                const idTipoVeiculo = parseInt(document.getElementById('idTipoVeiculo').value);
                const veiculo = document.getElementById('idVeiculo');
                const motorista = document.getElementById('idMotorista');
                const divSolicitado = document.getElementById('divSolicitado');
                const divExpandirVeiculos = document.getElementById('divExpandirVeiculos');
                const labelMotorista = document.getElementById('labelMotorista');
                
                // Ocultar checkbox Solicitado e Expandir Ve√≠culos por padr√£o
                divSolicitado.style.display = 'none';
                divExpandirVeiculos.style.display = 'none';
                
                if (!idTipoVeiculo) {
                    veiculo.disabled = false;
                    veiculo.innerHTML = '<option value="">Selecione...</option>';
                    return;
                }
                
                // IDs 7, 8, 9: Bloqueia motorista e ve√≠culo, exibe checkbox Solicitado
                if (idTipoVeiculo === 7 || idTipoVeiculo === 8 || idTipoVeiculo === 9) {
                    motorista.disabled = true;
                    motorista.required = false;
                    motorista.value = '';
                    if (labelMotorista) {
                        labelMotorista.innerHTML = 'Motorista';
                    }
                    
                    veiculo.disabled = true;
                    veiculo.value = '';
                    
                    // Exibir checkbox Solicitado
                    divSolicitado.style.display = 'block';
                    
                } else if (idTipoVeiculo !== 1) {
                    // Tipo diferente de 1 e n√£o √© 7, 8, 9: bloqueia ve√≠culo
                    veiculo.disabled = true;
                    veiculo.value = '';
                } else {
                    // Tipo 1: habilita e carrega ve√≠culos dispon√≠veis
                    veiculo.disabled = false;
                    
                    // MOSTRAR checkbox de expandir ve√≠culos
                    divExpandirVeiculos.style.display = 'block';
                    
                    const dtInicio = document.getElementById('dtInicio').value;
                    const dtFim = document.getElementById('dtFim').value;
                    
                    if (dtInicio && dtFim) {
                        // Se tem datas, carrega ve√≠culos dispon√≠veis
                        if (listaVeiculosExpandida) {
                            toggleExpandirVeiculos();
                        } else {
                            atualizarVeiculosDisponiveis();
                        }
                    } else {
                        // Se n√£o tem datas, carrega todos os ve√≠culos ou padr√£o
                        if (listaVeiculosExpandida) {
                            toggleExpandirVeiculos();
                        } else {
                            preencherSelectVeiculos();
                        }
                    }
                }
            }

            
            async function atualizarVeiculosDisponiveis() {
                const idTipoVeiculo = parseInt(document.getElementById('idTipoVeiculo').value);
                const dtInicio = document.getElementById('dtInicio').value;
                const dtFim = document.getElementById('dtFim').value;
                const selectVeiculo = document.getElementById('idVeiculo');
                const idAd = document.getElementById('idAd').value;
                const temHorario = document.getElementById('definirHorario').checked;
                
                // S√≥ atualiza se for tipo ve√≠culo 1 e tiver datas
                if (idTipoVeiculo !== 1 || !dtInicio || !dtFim) {
                    return;
                }
                
                try {
                    let url = `/api/agenda/veiculos-disponiveis?inicio=${dtInicio}&fim=${dtFim}&tem_horario=${temHorario}`;
                    if (idAd) {
                        url += `&id_demanda=${idAd}`;
                    }
                    
                    const res = await fetch(url);
                    const veiculosDisponiveis = await res.json();
                    
                    const veiculoAtual = selectVeiculo.value;
                    
                    selectVeiculo.innerHTML = '<option value="">Selecione...</option>';
                    
                    // Adiciona ve√≠culos dispon√≠veis
                    veiculosDisponiveis.forEach(v => {
                        selectVeiculo.innerHTML += `<option value="${v.id}">${v.veiculo}</option>`;
                    });
                    
                    // Se tinha um ve√≠culo selecionado e ele n√£o est√° na lista, adiciona
                    if (veiculoAtual && veiculoSelecionadoOriginal) {
                        const existe = Array.from(selectVeiculo.options).some(opt => opt.value == veiculoAtual);
                        if (!existe) {
                            selectVeiculo.innerHTML += `<option value="${veiculoSelecionadoOriginal.id}">${veiculoSelecionadoOriginal.veiculo}</option>`;
                        }
                        selectVeiculo.value = veiculoAtual;
                    }
                } catch (error) {
                    console.error('Erro ao carregar ve√≠culos dispon√≠veis:', error);
                }
            }
            
            function renderizarAbas() {
                const tabs = document.getElementById('weekTabs');
                // console.log('=== RENDERIZAR ABAS ===');
                // console.log('semanaAtual na renderiza√ß√£o:', semanaAtual);
                
                tabs.innerHTML = semanas.map((s, i) => {
                    const isActive = i === semanaAtual;
                    // console.log(`Aba ${i} (${s.label}): ${isActive ? 'ACTIVE' : 'inativa'}`);
                    return `<div class="week-tab ${isActive ? 'active' : ''}" 
                        onclick="mudarSemana(${i})">${s.label}</div>`;
                }).join('');
                
                // console.log('HTML gerado:', tabs.innerHTML.substring(0, 200) + '...');
                // console.log('=======================');
                
                // Scroll para a aba ativa ap√≥s renderizar
                setTimeout(() => {
                    scrollToActiveTab();
                    atualizarBotoesNavegacao();
                }, 100);
            }
            
            async function mudarSemana(index) {
                semanaAtual = index;
                renderizarAbas();
                await carregarFeriadosPeriodo();
                await carregarAgenda();
                inicializarDestaqueLinha();
            }
            
            async function carregarAgenda() {
                const wrapper = document.getElementById('agendaWrapper');
                wrapper.innerHTML = '<div class="loading">‚è≥ Carregando agenda...</div>';
                
                try {
                    const semana = semanas[semanaAtual];
                    await carregarLocacoes();
                    const res = await fetch(`/api/agenda/dados?inicio=${semana.inicio}&fim=${semana.fim}`);
                    dadosAgenda = await res.json();
                    
                    motoristas = dadosAgenda.motoristas;
                    outrosMotoristas = dadosAgenda.outros_motoristas || [];  // NOVO
                    veiculos = dadosAgenda.veiculos;
                    veiculosExtras = dadosAgenda.veiculos_extras || [];
                    
                    document.getElementById('semanaAtual').textContent = semana.label;
                    
                    renderizarAgenda();
                    inicializarDestaqueLinha();
                } catch (error) {
                    wrapper.innerHTML = '<div class="loading">‚ùå Erro ao carregar agenda</div>';
                    console.error('Erro:', error);
                }
            }

            // Nova fun√ß√£o para toggle de expandir ve√≠culos
            async function toggleExpandirVeiculos() {
                const checkbox = document.getElementById('expandirVeiculos');
                const selectVeiculo = document.getElementById('idVeiculo');
                const dtInicio = document.getElementById('dtInicio').value;
                const dtFim = document.getElementById('dtFim').value;
                const idAd = document.getElementById('idAd').value;
                const temHorario = document.getElementById('definirHorario').checked;
                
                listaVeiculosExpandida = checkbox.checked;
                
                if (!dtInicio || !dtFim) {
                    if (listaVeiculosExpandida) {
                        // Carregar todos os ve√≠culos sem filtro de data
                        try {
                            const res = await fetch(`/api/agenda/veiculos-todos?tem_horario=${temHorario}`);
                            const todosVeiculos = await res.json();
                            
                            const veiculoAtual = selectVeiculo.value;
                            selectVeiculo.innerHTML = '<option value="">Selecione...</option>';
                            
                            todosVeiculos.forEach(v => {
                                selectVeiculo.innerHTML += `<option value="${v.id}">${v.veiculo}</option>`;
                            });
                            
                            if (veiculoAtual) {
                                selectVeiculo.value = veiculoAtual;
                            }
                        } catch (error) {
                            console.error('Erro ao carregar todos os ve√≠culos:', error);
                        }
                    } else {
                        // Voltar para lista padr√£o
                        preencherSelectVeiculos();
                    }
                    return;
                }
            
                // Se tem datas, carregar com filtro
                if (listaVeiculosExpandida) {
                    try {
                        let url = `/api/agenda/veiculos-todos?inicio=${dtInicio}&fim=${dtFim}&tem_horario=${temHorario}`;
                        if (idAd) {
                            url += `&id_demanda=${idAd}`;
                        }
                        
                        const res = await fetch(url);
                        const todosVeiculos = await res.json();
                        
                        const veiculoAtual = selectVeiculo.value;
                        selectVeiculo.innerHTML = '<option value="">Selecione...</option>';
                        
                        todosVeiculos.forEach(v => {
                            selectVeiculo.innerHTML += `<option value="${v.id}">${v.veiculo}</option>`;
                        });
                        
                        if (veiculoAtual && veiculoSelecionadoOriginal) {
                            const existe = Array.from(selectVeiculo.options).some(opt => opt.value == veiculoAtual);
                            if (!existe) {
                                selectVeiculo.innerHTML += `<option value="${veiculoSelecionadoOriginal.id}">${veiculoSelecionadoOriginal.veiculo}</option>`;
                            }
                            selectVeiculo.value = veiculoAtual;
                        }
                    } catch (error) {
                        console.error('Erro ao carregar todos os ve√≠culos:', error);
                    }
                } else {
                    // Voltar para lista padr√£o com filtro de disponibilidade
                    await atualizarVeiculosDisponiveis();
                }
            }

            function renderizarAgenda() {
                const semana = semanas[semanaAtual];
                const dias = gerarDiasSemana(semana.inicio);
                
                let html = '';
                
                html += renderizarSecaoMotoristas(dias);
                html += renderizarSecaoOutrosMotoristas(dias);  // NOVO
                html += renderizarSecaoVeiculos(dias);
                html += renderizarSecaoVeiculosAlocados(dias);

                document.getElementById('agendaWrapper').innerHTML = html;

                // Preencher cabe√ßalhos flutuantes com os dias
                preencherDiasCabecalhosFlutuantes(dias);
                
                // Atualizar visibilidade inicial
                setTimeout(atualizarCabecalhosFlutuantes, 100);
            }

            // Controle dos cabe√ßalhos flutuantes
            function atualizarCabecalhosFlutuantes() {
                const sections = document.querySelectorAll('.agenda-section');
                const headerHeight = 70;
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                
                sections.forEach((section, index) => {
                    const table = section.querySelector('.agenda-table');
                    if (!table) return;
                    
                    const thead = table.querySelector('thead');
                    if (!thead) return;
                    
                    const rect = section.getBoundingClientRect();
                    const theadRect = thead.getBoundingClientRect();
                    
                    // Determinar qual sticky header usar
                    let stickyHeader;
                    if (section.querySelector('.section-header span')?.textContent.includes('SEGEOP - MOTORISTAS') && 
                        !section.querySelector('.section-header span')?.textContent.includes('OUTROS')) {
                        stickyHeader = document.getElementById('stickyHeaderMotoristas');
                    } else if (section.querySelector('.section-header span')?.textContent.includes('OUTROS MOTORISTAS')) {
                        stickyHeader = document.getElementById('stickyHeaderOutrosMotoristas');
                    } else if (section.querySelector('.section-header span')?.textContent.includes('VE√çCULOS OFICIAIS')) {
                        stickyHeader = document.getElementById('stickyHeaderVeiculos');
                    } else if (section.querySelector('.section-header span')?.textContent.includes('VE√çCULOS ALOCADOS')) {
                        stickyHeader = document.getElementById('stickyHeaderVeiculosAlocados');
                    }
                    
                    if (!stickyHeader) return;
                    
                    // Mostrar o cabe√ßalho flutuante se:
                    // - A se√ß√£o est√° vis√≠vel na tela
                    // - O thead original saiu da tela (scrollou para cima)
                    // - Ainda n√£o chegou no final da se√ß√£o
                    const shouldShow = theadRect.top < headerHeight && rect.bottom > headerHeight + 50;
                    
                    if (shouldShow) {
                        stickyHeader.classList.add('visible');
                    } else {
                        stickyHeader.classList.remove('visible');
                    }
                });
            }
            
            // Preencher os dias nos cabe√ßalhos flutuantes
            function preencherDiasCabecalhosFlutuantes(dias) {
                const prefixes = ['sticky', 'sticky-outros', 'sticky-veic', 'sticky-aloc'];
                
                prefixes.forEach(prefix => {
                    dias.forEach((dia, i) => {
                        const cell = document.getElementById(`${prefix}-dia-${i + 1}`);
                        if (cell) {
                            cell.innerHTML = `${dia.diaNome}<br>${dia.diaNum}/${dia.mes}`;
                        }
                    });
                });
            }
            
            // Event listener para scroll
            window.addEventListener('scroll', atualizarCabecalhosFlutuantes);
            window.addEventListener('resize', atualizarCabecalhosFlutuantes);
            
            function gerarDiasSemana(inicioStr) {
                const dias = [];
                const inicio = new Date(inicioStr + 'T00:00:00');
                
                for (let i = 0; i < 7; i++) {
                    const d = new Date(inicio);
                    d.setDate(inicio.getDate() + i);
                    dias.push({
                        data: d.toISOString().split('T')[0],
                        diaNum: d.getDate(),
                        mes: d.getMonth() + 1,
                        diaNome: ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'][d.getDay()],
                        diaIndex: d.getDay()
                    });
                }
                return dias;
            }
            
            function renderizarSecaoMotoristas(dias) {
                let html = '<div class="agenda-section">';
                html += `
                    <div class="section-header">
                        <span>üë≤ SEGEOP - MOTORISTAS</span>
                        <button class="btn-visualizar" onclick="abrirVisualizacaoSecao('motoristas')">üëÅÔ∏è Visualizar</button>
                    </div>
                `;
                html += '<table class="agenda-table"><thead><tr>';
                html += '<th class="col-numero">N.</th><th class="col-nome">Nome</th>';
                dias.forEach(d => html += `<th class="col-dia">${d.diaNome}<br>${d.diaNum}/${d.mes}</th>`);
                html += '</tr></thead><tbody>';
                
                motoristas.forEach((m, motoristaGlobalIndex) => {
                    // Para cada dia, verificar quantas demandas diferentes existem
                    const demandasPorDia = dias.map(dia => {
                        return dadosAgenda.demandas.filter(d => 
                            d.id_motorista === m.id && 
                            d.dt_inicio <= dia.data && 
                            d.dt_fim >= dia.data
                        );
                    });
                    
                    const maxDemandasPorDia = Math.max(...demandasPorDia.map(d => d.length), 1);
                    
                    // Criar matriz de controle de c√©lulas (qual c√©lula j√° foi renderizada)
                    const celulasRenderizadas = Array(maxDemandasPorDia).fill(0).map(() => Array(dias.length).fill(false));
                    
                    // Renderizar cada linha deste motorista
                    for (let linhaIndex = 0; linhaIndex < maxDemandasPorDia; linhaIndex++) {
                        html += `<tr>`;
                        
                        // Mostrar n√∫mero e nome apenas na primeira linha
                        if (linhaIndex === 0) {
                            if (maxDemandasPorDia > 1) {
                                html += `<td class="col-numero" rowspan="${maxDemandasPorDia}">${motoristaGlobalIndex + 1}</td>`;
                                html += `<td class="col-nome" rowspan="${maxDemandasPorDia}">${m.nome}</td>`;
                            } else {
                                html += `<td class="col-numero">${motoristaGlobalIndex + 1}</td>`;
                                html += `<td class="col-nome">${m.nome}</td>`;
                            }
                        }
                        
                        // Renderizar c√©lulas de cada dia
                        for (let diaIndex = 0; diaIndex < dias.length; diaIndex++) {
                            // Se esta c√©lula j√° foi renderizada (mesclada), pular
                            if (celulasRenderizadas[linhaIndex][diaIndex]) {
                                continue;
                            }
                            
                            const dia = dias[diaIndex];
                            const feriado = isFeriado(dia.data);
                            const isWeekend = dia.diaIndex === 0 || dia.diaIndex === 6;
                            const demandasDia = demandasPorDia[diaIndex];
                            
                            // Pegar a demanda correspondente a esta linha
                            const demanda = demandasDia[linhaIndex];
                            
                            if (demanda) {
                                // Tem demanda - verificar se pode mesclar com linhas vazias abaixo
                                let rowspanCount = 1;
                                
                                // Contar quantas linhas abaixo est√£o vazias para este dia
                                for (let proxLinha = linhaIndex + 1; proxLinha < maxDemandasPorDia; proxLinha++) {
                                    if (!demandasDia[proxLinha]) {
                                        rowspanCount++;
                                        celulasRenderizadas[proxLinha][diaIndex] = true;
                                    } else {
                                        break;
                                    }
                                }
                                
                                const corClass = `tipo-${demanda.id_tipodemanda}`;
                                const feriadoClass = feriado ? 'cell-feriado-com-demanda' : '';
                                // html += `<td class="${corClass} ${feriadoClass} col-dia" ${rowspanCount > 1 ? `rowspan="${rowspanCount}"` : ''} data-id-demanda="${demanda.id}" onclick="handleCellClick(event, ${demanda.id})">`;
                                html += `<td class="${corClass} ${feriadoClass} col-dia" ${rowspanCount > 1 ? `rowspan="${rowspanCount}"` : ''} data-id-demanda="${demanda.id}" onclick="handleCellClick(event, ${demanda.id})" onmouseenter="mostrarTooltipVeiculo(event, ${demanda.id})" onmousemove="posicionarTooltip(event)" onmouseleave="esconderTooltipVeiculo()">`;
        
                                html += '<div class="cell-content">';
                                
                                // ID 9 (Oficina) ou ID 12 (Lava-Jato)
                                if (demanda.id_tipodemanda === 9 || demanda.id_tipodemanda === 12) {
                                    html += `<div><strong>${demanda.de_tipodemanda || (demanda.id_tipodemanda === 9 ? 'Oficina' : 'Lava-Jato')}</strong></div>`;
                                    // if (demanda.nm_motorista) {
                                    //     html += `<div class="cell-divider"></div>`;
                                    //     html += `<div><strong>${demanda.nm_motorista}</strong></div>`;
                                    // }
                                    if (demanda.destino) {
                                        html += `<div>${demanda.destino}</div>`;
                                    }
                                }
                                // ID 10 (Ced√™ncia)
                                else if (demanda.id_tipodemanda === 10) {
                                    html += `<div><strong>${demanda.de_tipodemanda || 'Ced√™ncia'}</strong></div>`;
                                    if (demanda.nm_motorista) {
                                        html += `<div class="cell-divider"></div>`;
                                        html += `<div><strong>${demanda.nm_motorista}</strong></div>`;
                                    }
                                    if (demanda.setor) {
                                        html += `<div><strong>${demanda.setor}</strong></div>`;
                                    }
                                    if (demanda.nu_sei) {
                                        html += `<div>${demanda.nu_sei}</div>`;
                                    }
                                }
                                // ID 1, 2 ou 11 com hor√°rio
                                else if ((demanda.id_tipodemanda === 1 || demanda.id_tipodemanda === 2 || demanda.id_tipodemanda === 11) && demanda.horario) {
                                    html += `<div><strong>${demanda.setor || ''}</strong>${demanda.solicitante ? ' (' + demanda.solicitante + ')' : ''}</div>`;
                                    html += `<div>${demanda.destino || ''} <span class="demanda-horario">(${demanda.horario})</span></div>`;
                                    html += `<div>${demanda.nu_sei || ''}</div>`;
                                }
                                // Outros tipos
                                else {
                                    html += `<div><strong>${demanda.setor || ''}</strong>${demanda.solicitante ? ' (' + demanda.solicitante + ')' : ''}</div>`;
                                    html += `<div><strong>${demanda.destino || ''}</strong></div>`;
                                    html += `<div>${demanda.nu_sei || ''}</div>`;
                                }
                                                            
                                if (!demanda.id_tipoveiculo && ![6, 7, 8, 9, 10, 12].includes(demanda.id_tipodemanda)) {
                                    html += '<div class="informar-veiculo">(INFORMAR VE√çCULO)</div>';
                                }
                                
                                html += '</div></td>';
                                celulasRenderizadas[linhaIndex][diaIndex] = true;
                                
                            } else {
                                // N√£o tem demanda - calcular rowspan (mesclar com c√©lulas vazias abaixo)
                                let rowspanCount = 1;
                                
                                // Contar quantas linhas abaixo tamb√©m n√£o t√™m demanda para este dia
                                for (let proxLinha = linhaIndex + 1; proxLinha < maxDemandasPorDia; proxLinha++) {
                                    if (!demandasDia[proxLinha]) {
                                        rowspanCount++;
                                        celulasRenderizadas[proxLinha][diaIndex] = true;
                                    } else {
                                        break;
                                    }
                                }
                                
                                // Renderizar c√©lula vazia com rowspan
                                if (feriado) {
                                    if (linhaIndex === 0 && demandasDia.length === 0) {
                                        html += `<td class="cell-feriado col-dia" ${rowspanCount > 1 ? `rowspan="${rowspanCount}"` : ''} onclick="abrirModalNovoComData('${dia.data}', ${m.id})">${feriado.descricao}</td>`;
                                    } else {
                                        html += `<td class="cell-feriado col-dia" ${rowspanCount > 1 ? `rowspan="${rowspanCount}"` : ''}>${feriado.descricao}</td>`;
                                    }
                                } else {
                                    const weekendClass = isWeekend ? 'weekend-empty' : '';
                                    if (linhaIndex === 0 && demandasDia.length === 0) {
                                        html += `<td class="empty-cell ${weekendClass} col-dia" ${rowspanCount > 1 ? `rowspan="${rowspanCount}"` : ''} onclick="abrirModalNovoComData('${dia.data}', ${m.id})"></td>`;
                                    } else {
                                        html += `<td class="empty-cell ${weekendClass} col-dia" ${rowspanCount > 1 ? `rowspan="${rowspanCount}"` : ''}></td>`;
                                    }
                                }
                                celulasRenderizadas[linhaIndex][diaIndex] = true;
                            }
                        }
                        
                        html += '</tr>';
                    }
                });
                
                html += '</tbody></table></div>';
                return html;
            }

            function renderizarSecaoOutrosMotoristas(dias) {
                // Se n√£o houver outros motoristas com demandas, n√£o renderizar a se√ß√£o
                if (outrosMotoristas.length === 0) {
                    return '';
                }
                
                let html = '<div class="agenda-section">';
                html += `
                    <div class="section-header">
                        <span>üë≤ OUTROS MOTORISTAS</span>
                        <button class="btn-visualizar" onclick="abrirVisualizacaoSecao('outros-motoristas')">üëÅÔ∏è Visualizar</button>
                    </div>
                `;
                html += '<table class="agenda-table"><thead><tr>';
                html += '<th class="col-numero">N.</th><th class="col-nome">Nome</th>';
                dias.forEach(d => html += `<th class="col-dia">${d.diaNome}<br>${d.diaNum}/${d.mes}</th>`);
                html += '</tr></thead><tbody>';
                
                outrosMotoristas.forEach((m, motoristaGlobalIndex) => {
                    // Para cada dia, verificar quantas demandas diferentes existem
                    const demandasPorDia = dias.map(dia => {
                        return dadosAgenda.demandas.filter(d => 
                            d.id_motorista === m.id && 
                            d.dt_inicio <= dia.data && 
                            d.dt_fim >= dia.data
                        );
                    });
                    
                    const maxDemandasPorDia = Math.max(...demandasPorDia.map(d => d.length), 1);
                    
                    // Criar matriz de controle de c√©lulas (qual c√©lula j√° foi renderizada)
                    const celulasRenderizadas = Array(maxDemandasPorDia).fill(0).map(() => Array(dias.length).fill(false));
                    
                    // Renderizar cada linha deste motorista
                    for (let linhaIndex = 0; linhaIndex < maxDemandasPorDia; linhaIndex++) {
                        html += `<tr>`;
                        
                        // Mostrar n√∫mero e nome apenas na primeira linha
                        if (linhaIndex === 0) {
                            // Buscar setor da primeira demanda deste motorista
                            const primeiraDemanada = dadosAgenda.demandas.find(d => d.id_motorista === m.id);
                            const setor = primeiraDemanada ? primeiraDemanada.setor : '';
                            
                            if (maxDemandasPorDia > 1) {
                                html += `<td class="col-numero" rowspan="${maxDemandasPorDia}">${motoristaGlobalIndex + 1}</td>`;
                                html += `<td class="col-nome" rowspan="${maxDemandasPorDia}">`;
                                html += `<div>${m.nome}</div>`;
                                if (setor) {
                                    html += `<div style="font-size: 11px; color: #666; font-weight: normal;"><strong>${setor}</strong></div>`;
                                }
                                html += `</td>`;
                            } else {
                                html += `<td class="col-numero">${motoristaGlobalIndex + 1}</td>`;
                                html += `<td class="col-nome">`;
                                html += `<div>${m.nome}</div>`;
                                if (setor) {
                                    html += `<div style="font-size: 11px; color: #666; font-weight: normal;"><strong>${setor}</strong></div>`;
                                }
                                html += `</td>`;
                            }
                        }
                        
                        // Renderizar c√©lulas de cada dia
                        for (let diaIndex = 0; diaIndex < dias.length; diaIndex++) {
                            // Se esta c√©lula j√° foi renderizada (mesclada), pular
                            if (celulasRenderizadas[linhaIndex][diaIndex]) {
                                continue;
                            }
                            
                            const dia = dias[diaIndex];
                            const feriado = isFeriado(dia.data);
                            const isWeekend = dia.diaIndex === 0 || dia.diaIndex === 6;
                            const demandasDia = demandasPorDia[diaIndex];
                            
                            // Pegar a demanda correspondente a esta linha
                            const demanda = demandasDia[linhaIndex];
                            
                            if (demanda) {
                                // Tem demanda - verificar se pode mesclar com linhas vazias abaixo
                                let rowspanCount = 1;
                                
                                // Contar quantas linhas abaixo est√£o vazias para este dia
                                for (let proxLinha = linhaIndex + 1; proxLinha < maxDemandasPorDia; proxLinha++) {
                                    if (!demandasDia[proxLinha]) {
                                        rowspanCount++;
                                        celulasRenderizadas[proxLinha][diaIndex] = true;
                                    } else {
                                        break;
                                    }
                                }
                                
                                const corClass = `tipo-${demanda.id_tipodemanda}`;
                                const feriadoClass = feriado ? 'cell-feriado-com-demanda' : '';
                                // html += `<td class="${corClass} ${feriadoClass} col-dia" ${rowspanCount > 1 ? `rowspan="${rowspanCount}"` : ''} data-id-demanda="${demanda.id}" onclick="handleCellClick(event, ${demanda.id})">`;
                                html += `<td class="${corClass} ${feriadoClass} col-dia" ${rowspanCount > 1 ? `rowspan="${rowspanCount}"` : ''} data-id-demanda="${demanda.id}" onclick="handleCellClick(event, ${demanda.id})" onmouseenter="mostrarTooltipVeiculo(event, ${demanda.id})" onmousemove="posicionarTooltip(event)" onmouseleave="esconderTooltipVeiculo()">`;
                                html += '<div class="cell-content">';
                                
                                // ID 9 (Oficina) ou ID 12 (Lava-Jato)
                                if (demanda.id_tipodemanda === 9 || demanda.id_tipodemanda === 12) {
                                    html += `<div>${demanda.de_tipodemanda || (demanda.id_tipodemanda === 9 ? 'Oficina' : 'Lava-Jato')}</div>`;
                                    if (demanda.destino) {
                                        html += `<div>${demanda.destino}</div>`;
                                    }
                                }
                                // ID 10 (Ced√™ncia)
                                else if (demanda.id_tipodemanda === 10) {
                                    html += `<div><strong>${demanda.de_tipodemanda || 'Ced√™ncia'}</strong></div>`;
                                    if (demanda.setor) {
                                        html += `<div><strong>${demanda.setor}</strong></div>`;
                                    }
                                    if (demanda.nu_sei) {
                                        html += `<div>${demanda.nu_sei}</div>`;
                                    }
                                }
                                // ID 1, 2 ou 11 com hor√°rio
                                else if ((demanda.id_tipodemanda === 1 || demanda.id_tipodemanda === 2 || demanda.id_tipodemanda === 11) && demanda.horario) {
                                    html += `<div><strong>${demanda.setor || ''}</strong>${demanda.solicitante ? ' (' + demanda.solicitante + ')' : ''}</div>`;
                                    html += `<div>${demanda.destino || ''} <span class="demanda-horario">(${demanda.horario})</span></div>`;
                                    html += `<div>${demanda.nu_sei || ''}</div>`;
                                }
                                // Outros tipos
                                else {
                                    html += `<div><strong>${demanda.setor || ''}</strong>${demanda.solicitante ? ' (' + demanda.solicitante + ')' : ''}</div>`;
                                    html += `<div>${demanda.destino || ''}</div>`;
                                    html += `<div>${demanda.nu_sei || ''}</div>`;
                                }
                                
                                if (!demanda.id_tipoveiculo && ![6, 7, 8, 9, 10, 12].includes(demanda.id_tipodemanda)) {
                                    html += '<div class="informar-veiculo">(INFORMAR VE√çCULO)</div>';
                                }
                                
                                html += '</div></td>';
                                celulasRenderizadas[linhaIndex][diaIndex] = true;
                                
                            } else {
                                // N√£o tem demanda - calcular rowspan (mesclar com c√©lulas vazias abaixo)
                                let rowspanCount = 1;
                                
                                // Contar quantas linhas abaixo tamb√©m n√£o t√™m demanda para este dia
                                for (let proxLinha = linhaIndex + 1; proxLinha < maxDemandasPorDia; proxLinha++) {
                                    if (!demandasDia[proxLinha]) {
                                        rowspanCount++;
                                        celulasRenderizadas[proxLinha][diaIndex] = true;
                                    } else {
                                        break;
                                    }
                                }
                                
                                // Renderizar c√©lula vazia com rowspan
                                if (feriado) {
                                    if (linhaIndex === 0 && demandasDia.length === 0) {
                                        html += `<td class="cell-feriado col-dia" ${rowspanCount > 1 ? `rowspan="${rowspanCount}"` : ''} onclick="abrirModalNovoComData('${dia.data}', ${m.id})">${feriado.descricao}</td>`;
                                    } else {
                                        html += `<td class="cell-feriado col-dia" ${rowspanCount > 1 ? `rowspan="${rowspanCount}"` : ''}>${feriado.descricao}</td>`;
                                    }
                                } else {
                                    const weekendClass = isWeekend ? 'weekend-empty' : '';
                                    if (linhaIndex === 0 && demandasDia.length === 0) {
                                        html += `<td class="empty-cell ${weekendClass} col-dia" ${rowspanCount > 1 ? `rowspan="${rowspanCount}"` : ''} onclick="abrirModalNovoComData('${dia.data}', ${m.id})"></td>`;
                                    } else {
                                        html += `<td class="empty-cell ${weekendClass} col-dia" ${rowspanCount > 1 ? `rowspan="${rowspanCount}"` : ''}></td>`;
                                    }
                                }
                                celulasRenderizadas[linhaIndex][diaIndex] = true;
                            }
                        }
                        
                        html += '</tr>';
                    }
                });
                
                html += '</tbody></table></div>';
                return html;
            }
            
            function handleCellClick(event, idDemanda) {
                event.stopPropagation();
                const cell = event.currentTarget;
                
                // Se a c√©lula clicada j√° est√° selecionada, abre o modal de edi√ß√£o
                if (cell.classList.contains('cell-selected')) {
                    abrirModalEditar(idDemanda);
                    return;
                }
                
                // Remove sele√ß√£o anterior
                if (celulaSelecionada) {
                    celulaSelecionada.classList.remove('cell-selected');
                }
                
                // Seleciona a c√©lula atual
                cell.classList.add('cell-selected');
                celulaSelecionada = cell;
            }
                            
            function renderizarSecaoVeiculos(dias) {
                let html = '<div class="agenda-section">';
                html += `
                    <div class="section-header">
                        <span>üöô SEGEOP - VE√çCULOS OFICIAIS</span>
                        <button class="btn-visualizar" onclick="abrirVisualizacaoSecao('veiculos')">üëÅÔ∏è Visualizar</button>
                    </div>
                `;
                html += '<table class="agenda-table"><thead><tr>';
                html += '<th class="col-numero">N.</th><th class="col-nome">Ve√≠culo</th>';
                dias.forEach(d => html += `<th class="col-dia">${d.diaNome}<br>${d.diaNum}/${d.mes}</th>`);
                html += '</tr></thead><tbody>';
                
                // Combinar ve√≠culos padr√£o com extras que t√™m demandas
                const todosVeiculos = [...veiculos];
                
                // Adicionar ve√≠culos extras que t√™m demandas na semana atual
                veiculosExtras.forEach(vExtra => {
                    const temDemanda = dadosAgenda.demandas.some(d => 
                        d.id_veiculo === vExtra.id &&
                        dias.some(dia => d.dt_inicio <= dia.data && d.dt_fim >= dia.data)
                    );
                    
                    if (temDemanda) {
                        todosVeiculos.push({
                            ...vExtra,
                            isExtra: true
                        });
                    }
                });
                
                todosVeiculos.forEach((v, veiculoGlobalIndex) => {
                    const extraClass = v.isExtra ? 'veiculo-extra' : '';
                    
                    // Para cada dia, verificar quantas demandas diferentes existem
                    const demandasPorDia = dias.map(dia => {
                        return dadosAgenda.demandas.filter(d => 
                            d.id_veiculo === v.id && 
                            d.dt_inicio <= dia.data && 
                            d.dt_fim >= dia.data
                        );
                    });
                    
                    const maxDemandasPorDia = Math.max(...demandasPorDia.map(d => d.length), 1);
                    
                    // Criar matriz de controle de c√©lulas
                    const celulasRenderizadas = Array(maxDemandasPorDia).fill(0).map(() => Array(dias.length).fill(false));
                    
                    // Renderizar cada linha deste ve√≠culo
                    for (let linhaIndex = 0; linhaIndex < maxDemandasPorDia; linhaIndex++) {
                        html += `<tr>`;
                        
                        // Mostrar n√∫mero e nome apenas na primeira linha
                        if (linhaIndex === 0) {
                            if (maxDemandasPorDia > 1) {
                                html += `<td class="col-numero ${extraClass}" rowspan="${maxDemandasPorDia}">${veiculoGlobalIndex + 1}</td>`;
                                html += `<td class="col-nome ${extraClass}" rowspan="${maxDemandasPorDia}">${v.veiculo}</td>`;
                            } else {
                                html += `<td class="col-numero ${extraClass}">${veiculoGlobalIndex + 1}</td>`;
                                html += `<td class="col-nome ${extraClass}">${v.veiculo}</td>`;
                            }
                        }
                        
                        // Renderizar c√©lulas de cada dia
                        for (let diaIndex = 0; diaIndex < dias.length; diaIndex++) {
                            // Se esta c√©lula j√° foi renderizada (mesclada), pular
                            if (celulasRenderizadas[linhaIndex][diaIndex]) {
                                continue;
                            }
                            
                            const dia = dias[diaIndex];
                            const feriado = isFeriado(dia.data);
                            const isWeekend = dia.diaIndex === 0 || dia.diaIndex === 6;
                            const demandasDia = demandasPorDia[diaIndex];
                            
                            // Pegar a demanda correspondente a esta linha
                            const demanda = demandasDia[linhaIndex];
                            
                            if (demanda) {
                                // Tem demanda - verificar se pode mesclar com linhas vazias abaixo
                                let rowspanCount = 1;
                                
                                // Contar quantas linhas abaixo est√£o vazias para este dia
                                for (let proxLinha = linhaIndex + 1; proxLinha < maxDemandasPorDia; proxLinha++) {
                                    if (!demandasDia[proxLinha]) {
                                        rowspanCount++;
                                        celulasRenderizadas[proxLinha][diaIndex] = true;
                                    } else {
                                        break;
                                    }
                                }
                                
                                const corClass = `tipo-${demanda.id_tipodemanda}`;
                                const feriadoClass = feriado ? 'cell-feriado-com-demanda' : '';
                                //html += `<td class="${corClass} ${feriadoClass} col-dia" ${rowspanCount > 1 ? `rowspan="${rowspanCount}"` : ''} onclick="abrirModalEditar(${demanda.id})">`;
                                html += `<td class="${corClass} ${feriadoClass} col-dia" ${rowspanCount > 1 ? `rowspan="${rowspanCount}"` : ''} onclick="abrirModalEditar(${demanda.id})" onmouseenter="mostrarTooltipPeriodo(event, ${demanda.id})" onmousemove="posicionarTooltip(event)" onmouseleave="esconderTooltipVeiculo()">`;
                                html += '<div class="cell-content-veiculos">';
                                
                                // ID 9 (Oficina) ou ID 12 (Lava-Jato)
                                if (demanda.id_tipodemanda === 9 || demanda.id_tipodemanda === 12) {
                                    html += `<div>${demanda.de_tipodemanda || (demanda.id_tipodemanda === 9 ? 'Oficina' : 'Lava-Jato')}</div>`;
                                    if (demanda.id_motorista === 0 && demanda.nc_motorista) {
                                        html += `<div class="cell-divider"></div>`;
                                        html += `<div><strong>${demanda.nc_motorista}</strong></div>`;
                                    } else if (demanda.nm_motorista) {
                                        html += `<div class="cell-divider"></div>`;
                                        html += `<div><strong>${demanda.nm_motorista}</strong></div>`;
                                    }
                                    if (demanda.destino) {
                                        html += `<div><strong>${demanda.destino}</strong></div>`;
                                    }
                                }
                                // ID 10 (Ced√™ncia)
                                else if (demanda.id_tipodemanda === 10) {
                                    html += `<div>${demanda.de_tipodemanda || 'Ced√™ncia'}<strong>${' - ' + demanda.setor || ''}</strong></div>`;
                                    if (demanda.nu_sei) {
                                        html += `<div>${demanda.nu_sei}</div>`;
                                    }
                                }
                                // ID 1, 2 ou 11 com hor√°rio
                                else if ((demanda.id_tipodemanda === 1 || demanda.id_tipodemanda === 2 || demanda.id_tipodemanda === 11) && demanda.horario) {
                                    html += `<div><strong>${demanda.nm_motorista || ''}</strong></div>`;
                                    if (demanda.nu_sei) {
                                        html += `<div>${demanda.nu_sei}</div>`;
                                    }
                                    if (demanda.destino) {
                                        html += `<div>${demanda.destino} <span class="demanda-horario">(${demanda.horario})</span></div>`;
                                    }
                                }
                                // Outros tipos
                                else {
                                    html += `<div><strong>${demanda.nm_motorista || ''}</strong></div>`;
                                    if (demanda.nu_sei) {
                                        html += `<div>${demanda.nu_sei}</div>`;
                                    }
                                }
                                                            
                                html += '</div></td>';
                                celulasRenderizadas[linhaIndex][diaIndex] = true;
                                
                            } else {
                                // N√£o tem demanda - calcular rowspan (mesclar com c√©lulas vazias abaixo)
                                let rowspanCount = 1;
                                
                                // Contar quantas linhas abaixo tamb√©m n√£o t√™m demanda para este dia
                                for (let proxLinha = linhaIndex + 1; proxLinha < maxDemandasPorDia; proxLinha++) {
                                    if (!demandasDia[proxLinha]) {
                                        rowspanCount++;
                                        celulasRenderizadas[proxLinha][diaIndex] = true;
                                    } else {
                                        break;
                                    }
                                }
                                
                                // Renderizar c√©lula vazia com rowspan
                                if (feriado) {
                                    if (linhaIndex === 0 && demandasDia.length === 0) {
                                        html += `<td class="cell-feriado col-dia" ${rowspanCount > 1 ? `rowspan="${rowspanCount}"` : ''} onclick="abrirModalNovoComVeiculo('${dia.data}', ${v.id})">${feriado.descricao}</td>`;
                                    } else {
                                        html += `<td class="cell-feriado col-dia" ${rowspanCount > 1 ? `rowspan="${rowspanCount}"` : ''}>${feriado.descricao}</td>`;
                                    }
                                } else {
                                    const weekendClass = isWeekend ? 'weekend-empty' : '';
                                    if (linhaIndex === 0 && demandasDia.length === 0) {
                                        html += `<td class="empty-cell ${weekendClass} col-dia" ${rowspanCount > 1 ? `rowspan="${rowspanCount}"` : ''} onclick="abrirModalNovoComVeiculo('${dia.data}', ${v.id})"></td>`;
                                    } else {
                                        html += `<td class="empty-cell ${weekendClass} col-dia" ${rowspanCount > 1 ? `rowspan="${rowspanCount}"` : ''}></td>`;
                                    }
                                }
                                celulasRenderizadas[linhaIndex][diaIndex] = true;
                            }
                        }
                        
                        html += '</tr>';
                    }
                });
                
                html += '</tbody></table></div>';
                return html;
            }
                    
            function renderizarSecaoVeiculosAlocados(dias) {
                const demandasAlocadas = dadosAgenda.demandas.filter(d => d.id_tipoveiculo != 1 && d.id_tipoveiculo !== null);
                
                if (demandasAlocadas.length === 0) return '';
                
                const grupos = {};
                demandasAlocadas.forEach(d => {
                    const key = `${d.de_tipoveiculo}|${d.nu_sei}|${d.setor}|${d.destino}|${d.id_tipoveiculo}`;
                    if (!grupos[key]) {
                        grupos[key] = {
                            de_tipoveiculo: d.de_tipoveiculo,
                            nu_sei: d.nu_sei,
                            setor: d.setor,
                            destino: d.destino,
                            id_tipoveiculo: d.id_tipoveiculo,
                            demandas: []
                        };
                    }
                    grupos[key].demandas.push(d);
                });
                
                // Ordenar grupos: primeiro IDs 7, 8, 9 (em ordem crescente), depois ordenar por ID_AD ASC
                const gruposArray = Object.values(grupos);
                gruposArray.sort((a, b) => {
                    const prioridadeA = [7, 8, 9].includes(a.id_tipoveiculo);
                    const prioridadeB = [7, 8, 9].includes(b.id_tipoveiculo);
                    
                    // Se ambos s√£o priorit√°rios (7, 8, 9)
                    if (prioridadeA && prioridadeB) {
                        // Ordenar por ID_TIPOVEICULO crescente (7, 8, 9)
                        if (a.id_tipoveiculo !== b.id_tipoveiculo) {
                            return a.id_tipoveiculo - b.id_tipoveiculo;
                        }
                        // Se mesmo ID_TIPOVEICULO, ordenar por data de lan√ßamento ASC
                        const dataA = a.demandas[0].dt_lancamento || '';
                        const dataB = b.demandas[0].dt_lancamento || '';
                        return dataA.localeCompare(dataB);
                    }
                    
                    // Se ambos N√ÉO s√£o priorit√°rios, ordenar por data de lan√ßamento ASC
                    if (!prioridadeA && !prioridadeB) {
                        const dataA = a.demandas[0].dt_lancamento || '';
                        const dataB = b.demandas[0].dt_lancamento || '';
                        return dataA.localeCompare(dataB);
                    }
                    
                    // Priorit√°rios (7, 8, 9) v√™m primeiro
                    return prioridadeB - prioridadeA;
                });
                
                let html = '<div class="agenda-section">';
                html += `
                    <div class="section-header">
                        <span>üöå SEGEOP - VE√çCULOS ALOCADOS</span>
                        <button class="btn-visualizar" onclick="abrirVisualizacaoSecao('veiculos-alocados')">üëÅÔ∏è Visualizar</button>
                    </div>
                `;
                html += '<table class="agenda-table"><thead><tr>';
                html += '<th class="col-numero">N.</th><th class="col-nome">Tipo Ve√≠culo / SEI / Destino</th>';
                dias.forEach(d => html += `<th class="col-dia">${d.diaNome}<br>${d.diaNum}/${d.mes}</th>`);
                html += '</tr></thead><tbody>';
                
                gruposArray.forEach((grupo, index) => {
                    const isIdEspecial = [7, 8, 9].includes(grupo.id_tipoveiculo);
                    
                    html += `<tr><td class="col-numero">${index + 1}</td>`;
                    html += `<td class="col-nome">`;
                    html += `<div><strong>${grupo.de_tipoveiculo}</strong></div>`;
                    html += `<div>${grupo.nu_sei || ''}</div>`;
                    
                    // Montar linha Setor - Destino com setor em negrito
                    if (grupo.setor && grupo.destino) {
                        html += `<div><strong>${grupo.setor}</strong> - ${grupo.destino}</div>`;
                    } else if (grupo.setor) {
                        html += `<div><strong>${grupo.setor}</strong></div>`;
                    } else if (grupo.destino) {
                        html += `<div>${grupo.destino}</div>`;
                    }
                    
                    // Verificar se existe loca√ß√£o finalizada
                    const primeiraLocacao = locacoesAtivas.find(loc => 
                        loc.fl_status === 'F' && 
                        grupo.demandas.some(d => d.id_motorista === loc.id_motorista)
                    );
                    if (primeiraLocacao) {
                        html += `<div style="color: #6c757d; font-size: 11px; margin-top: 3px;">${primeiraLocacao.ds_veiculo_mod}</div>`;
                    }
                    
                    html += `</td>`;
                    
                    dias.forEach(dia => {
                        const feriado = isFeriado(dia.data);
                        const demandasDia = grupo.demandas.filter(d => 
                            d.dt_inicio <= dia.data && 
                            d.dt_fim >= dia.data
                        );
                        
                        if (demandasDia.length > 0) {
                            const demanda = demandasDia[0];
                            
                            let corClass = '';
                            
                            if (isIdEspecial) {
                                // Para IDs 7, 8, 9: verificar se foi solicitado
                                corClass = demanda.solicitado === 'S' ? 'tipo-solicitado' : '';
                            } else {
                                // Para outros IDs: verificar se existe loca√ß√£o
                                const temLocacao = locacoesAtivas.some(loc => 
                                    loc.id_motorista === demanda.id_motorista &&
                                    loc.data_inicio <= dia.data &&
                                    loc.data_fim >= dia.data
                                );
                                corClass = temLocacao ? 'tipo-locacao' : '';
                            }
                            
                            const feriadoClass = feriado ? 'cell-feriado-com-demanda' : '';
                            // html += `<td class="${corClass} ${feriadoClass} col-dia" data-id-demanda="${demanda.id}" onclick="handleCellClick(event, ${demanda.id})">`;
                            html += `<td class="${corClass} ${feriadoClass} col-dia" data-id-demanda="${demanda.id}" onclick="handleCellClick(event, ${demanda.id})" onmouseenter="mostrarTooltipPeriodo(event, ${demanda.id})" onmousemove="posicionarTooltip(event)" onmouseleave="esconderTooltipVeiculo()">`;
                            html += '<div class="cell-content-veiculos">';
                            
                            if (isIdEspecial) {
                                // Para IDs 7, 8, 9: mostrar apenas setor e destino
                                if (demanda.setor) {
                                    html += `<div><strong>${demanda.setor}</strong></div>`;
                                }
                                if (demanda.destino) {
                                    html += `<div>${demanda.destino}</div>`;
                                }                            

                            } else {
                                // Para outros IDs: mostrar motorista (nome ou NC) e setor
                                if (demanda.id_motorista === 0 && demanda.nc_motorista) {
                                    html += `<div><strong>${demanda.nc_motorista}</strong></div>`;
                                } else {
                                    html += `<div><strong>${demanda.nm_motorista || ''}</strong></div>`;
                                }
                                if (demanda.setor) {
                                    html += `<div>${demanda.setor}</div>`;
                                }
                            }
                            
                            html += '</div></td>';
                        } else if (feriado) {
                            // C√©lula de feriado sem demanda
                            html += `<td class="cell-feriado col-dia">${feriado.descricao}</td>`;
                        } else {
                            const isWeekend = dia.diaIndex === 0 || dia.diaIndex === 6;
                            const weekendClass = isWeekend ? 'weekend-empty' : '';
                            html += `<td class="empty-cell ${weekendClass} col-dia"></td>`;
                        }
                    });
                    html += '</tr>';
                });
                
                html += '</tbody></table></div>';
                return html;
            }
                            
            async function abrirModalNovo() {
                document.getElementById('modalTitle').textContent = 'Nova Demanda';
                document.getElementById('idAd').value = '';
                document.getElementById('formDemanda').reset();
                document.getElementById('btnExcluir').style.display = 'none';
                veiculoSelecionadoOriginal = null;
                listaVeiculosExpandida = false;
                
                // Reset de hor√°rio
                document.getElementById('definirHorario').checked = false;
                document.getElementById('definirHorario').disabled = false;
                document.getElementById('horario').value = '';
                document.getElementById('horario').disabled = true;
                
                // Reset checkbox expandir ve√≠culos
                document.getElementById('expandirVeiculos').checked = false;
                document.getElementById('divExpandirVeiculos').style.display = 'none';
                
                // Mostrar filtro e definir SEGEOP como padr√£o
                document.getElementById('motoristaFilter').style.display = 'flex';
                document.querySelector('input[name="tipoMotorista"][value="segeop"]').checked = true;
                
                // Ocultar checkbox Solicitado
                document.getElementById('divSolicitado').style.display = 'none';
                document.getElementById('solicitado').checked = false;
                
                // Reset campo motorista n√£o cadastrado
                document.getElementById('divNcMotorista').style.display = 'none';
                document.getElementById('ncMotorista').value = '';
                document.getElementById('ncMotorista').required = false;

                preencherSelectMotoristas('segeop');
                
                // N√ÉO carregar ve√≠culos no in√≠cio
                const selectVeiculo = document.getElementById('idVeiculo');
                selectVeiculo.innerHTML = '<option value="">Selecione...</option>';
                selectVeiculo.disabled = true;
                
                // Resetar labels
                document.getElementById('labelTipoVeiculo').innerHTML = 'Tipo de Ve√≠culo';
                document.getElementById('labelVeiculo').innerHTML = 'Ve√≠culo';
                document.getElementById('labelSetor').innerHTML = 'Setor';
                document.getElementById('labelSolicitante').innerHTML = 'Solicitante';
                document.getElementById('labelDestino').innerHTML = 'Destino';
                
                // Habilitar todos os campos
                document.getElementById('idMotorista').disabled = false;
                document.getElementById('idTipoVeiculo').disabled = false;
                document.getElementById('setor').disabled = false;
                document.getElementById('solicitante').disabled = false;
                document.getElementById('destino').disabled = false;
                
                // Adicionar event listeners para o filtro
                document.querySelectorAll('input[name="tipoMotorista"]').forEach(radio => {
                    radio.addEventListener('change', function() {
                        preencherSelectMotoristas(this.value);
                    });
                });
                
                document.getElementById('modal').style.display = 'block';
            }
            
            async function abrirModalNovoComData(data, idMotorista = null) {
                contextoAbertura = 'motorista'; // Definir ANTES
                await abrirModalNovo();
                await preencherSelectTiposDemanda(); // Carregar depois que contexto est√° definido
                document.getElementById('dtInicio').value = data;
                document.getElementById('dtFim').value = data;
                if (idMotorista) {
                    document.getElementById('idMotorista').value = idMotorista;
                }
            }
            
            async function abrirModalNovoComVeiculo(data, idVeiculo = null) {
                contextoAbertura = 'veiculo'; // Definir ANTES
                await abrirModalNovo();
                await preencherSelectTiposDemanda(); // Carregar depois que contexto est√° definido
                document.getElementById('dtInicio').value = data;
                document.getElementById('dtFim').value = data;
                
                if (idVeiculo) {
                    // Guardar o ve√≠culo que ser√° selecionado
                    const veiculoObj = veiculos.find(v => v.id === idVeiculo);
                    if (veiculoObj) {
                        veiculoSelecionadoOriginal = {
                            id: veiculoObj.id,
                            veiculo: veiculoObj.veiculo
                        };
                    }
                    
                    // Selecionar Tipo de Ve√≠culo = 1 (Ve√≠culo Oficial)
                    document.getElementById('idTipoVeiculo').value = '1';
                    
                    // Aplicar regras e aguardar carregar ve√≠culos dispon√≠veis
                    aplicarRegrasTipoVeiculo();
                    
                    // Aguardar a lista de ve√≠culos ser atualizada e ent√£o selecionar
                    setTimeout(async () => {
                        await atualizarVeiculosDisponiveis();
                        document.getElementById('idVeiculo').value = idVeiculo;
                    }, 150);
                }
            }
            
            async function abrirModalNovoGeral() {
                contextoAbertura = null; // Sem contexto espec√≠fico
                await abrirModalNovo();
                await preencherSelectTiposDemanda(); // Carregar todos os tipos
            }

            async function abrirModalEditar(idAd) {
                // Mostrar spinner
                mostrarSpinner();
                
                try {
                    const demanda = dadosAgenda.demandas.find(d => d.id === idAd);
                    if (!demanda) {
                        esconderSpinner();
                        return;
                    }
                    
                    document.getElementById('modalTitle').textContent = 'Editar Demanda';
                    contextoAbertura = null;
                    document.getElementById('idAd').value = demanda.id;
                    document.getElementById('btnExcluir').style.display = 'inline-block';
                    
                    // Definir se lista est√° expandida
                    listaVeiculosExpandida = demanda.todos_veiculos === 'S';
                    
                    // Ocultar filtro na edi√ß√£o
                    document.getElementById('motoristaFilter').style.display = 'none';
                    
                    // Guardar ve√≠culo original para manter na lista
                    if (demanda.id_veiculo) {
                        // Procurar primeiro nos ve√≠culos padr√£o
                        let veiculoObj = veiculos.find(v => v.id === demanda.id_veiculo);
                        
                        // Se n√£o encontrou, procurar nos ve√≠culos extras
                        if (!veiculoObj) {
                            veiculoObj = veiculosExtras.find(v => v.id === demanda.id_veiculo);
                        }
                        
                        // Se ainda n√£o encontrou, buscar diretamente (caso seja um ve√≠culo que n√£o est√° em nenhuma lista)
                        if (!veiculoObj && dadosAgenda.demandas) {
                            const todasDemandas = dadosAgenda.demandas.filter(d => d.id_veiculo === demanda.id_veiculo);
                            if (todasDemandas.length > 0) {
                                // Criar objeto tempor√°rio com dados da demanda
                                veiculoObj = {
                                    id: demanda.id_veiculo,
                                    veiculo: `Ve√≠culo ID ${demanda.id_veiculo}` // Placeholder
                                };
                            }
                        }
                        
                        if (veiculoObj) {
                            veiculoSelecionadoOriginal = {
                                id: veiculoObj.id,
                                veiculo: veiculoObj.veiculo
                            };
                        }
                    } else {
                        veiculoSelecionadoOriginal = null;
                    }
                    
                    preencherSelectMotoristas('todos');
                    
                    // Carregar tipos de demanda antes de preencher o formul√°rio
                    await preencherSelectTiposDemanda();
                    
                    document.getElementById('idMotorista').value = demanda.id_motorista || '';
                    document.getElementById('dtInicio').value = demanda.dt_inicio;
                    document.getElementById('dtFim').value = demanda.dt_fim;
                    document.getElementById('idTipoDemanda').value = demanda.id_tipodemanda;
                    document.getElementById('idTipoVeiculo').value = demanda.id_tipoveiculo || '';
                    document.getElementById('setor').value = demanda.setor || '';
                    document.getElementById('solicitante').value = demanda.solicitante || '';
                    document.getElementById('destino').value = demanda.destino || '';
                    document.getElementById('nuSei').value = demanda.nu_sei || '';
                    document.getElementById('obs').value = demanda.obs || '';
                    document.getElementById('solicitado').checked = demanda.solicitado === 'S';
                    
                    // Preencher motorista n√£o cadastrado
                    if (demanda.id_motorista === 0 && demanda.nc_motorista) {
                        document.getElementById('divNcMotorista').style.display = 'block';
                        document.getElementById('ncMotorista').value = demanda.nc_motorista;
                        document.getElementById('ncMotorista').required = true;
                    } else {
                        document.getElementById('divNcMotorista').style.display = 'none';
                        document.getElementById('ncMotorista').value = '';
                        document.getElementById('ncMotorista').required = false;
                    }
            
                    // Carregar hor√°rio
                    if (demanda.horario) {
                        document.getElementById('definirHorario').checked = true;
                        document.getElementById('definirHorario').disabled = false;
                        document.getElementById('horario').value = demanda.horario;
                        document.getElementById('horario').disabled = false;
                    } else {
                        document.getElementById('definirHorario').checked = false;
                        document.getElementById('definirHorario').disabled = false;
                        document.getElementById('horario').value = '';
                        document.getElementById('horario').disabled = true;
                    }
                    
                    // Aplicar regras ap√≥s preencher
                    aplicarRegrasTipoDemanda();
                    aplicarRegrasTipoVeiculo();
                    
                    // Configurar checkbox expandir ve√≠culos
                    document.getElementById('expandirVeiculos').checked = listaVeiculosExpandida;
                    
                    // Se tipo ve√≠culo √© 1, carregar lista apropriada
                    if (demanda.id_tipoveiculo === 1) {
                        if (listaVeiculosExpandida) {
                            await toggleExpandirVeiculos();
                        } else {
                            await atualizarVeiculosDisponiveis();
                        }
                        
                        // Selecionar ve√≠culo ap√≥s carregar lista
                        setTimeout(() => {
                            document.getElementById('idVeiculo').value = demanda.id_veiculo || '';
                            // Esconder spinner ap√≥s tudo carregar
                            esconderSpinner();
                        }, 200);
                    } else {
                        document.getElementById('idVeiculo').value = demanda.id_veiculo || '';
                        // Esconder spinner
                        esconderSpinner();
                    }
                    
                    await verificarBotaoLocacaoEdicao(idAd);
                    
                    document.getElementById('modal').style.display = 'block';

                } catch (error) {
                    console.error('Erro ao abrir modal de edi√ß√£o:', error);
                    esconderSpinner();
                    mostrarAlerta('Erro ao carregar dados da demanda!', '‚ùå Erro', '#dc3545');
                }
            }

            // ========== MODIFICAR FUN√á√ÉO EXISTENTE: fecharModal ==========
            function fecharModal() {
                document.getElementById('modal').style.display = 'none';
                veiculoSelecionadoOriginal = null;
                
                // ====== ADICIONAR ESTAS LINHAS ======
                // Limpar √°rea de status/bot√£o de loca√ß√£o
                const elementoLocacao = document.getElementById('areaLocacaoStatus');
                if (elementoLocacao) {
                    elementoLocacao.remove();
                }
                // ====== FIM DAS LINHAS ADICIONADAS ======
            }
            
            function preencherSelectMotoristas(tipo = 'segeop') {
                const select = document.getElementById('idMotorista');
                select.innerHTML = '<option value="">Selecione...</option>';
            
                let motoristasFiltrados = motoristas;
                
                if (tipo === 'segeop') {
                    // Motoristas SEGEOP (padr√£o atual)
                    motoristasFiltrados = motoristas.filter(m => 
                        m.tipo === 'Motorista Atendimento' || m.tipo === 'Tercerizado'
                    );
                } else if (tipo === 'outros') {
                    // Outros motoristas ativos, exceto SEGEOP
                    motoristasFiltrados = dadosAgenda.todos_motoristas.filter(m => 
                        m.tipo !== 'Motorista Atendimento' && m.tipo !== 'Tercerizado'
                    );
                } else if (tipo === 'todos') {
                    // Todos os motoristas ativos
                    motoristasFiltrados = dadosAgenda.todos_motoristas || motoristas;
                }
                
                motoristasFiltrados.forEach(m => {
                    select.innerHTML += `<option value="${m.id}">${m.nome}</option>`;
                });
            }

            
            function preencherSelectVeiculos() {
                const select = document.getElementById('idVeiculo');
                const veiculoAtual = select.value;
                
                select.innerHTML = '<option value="">Selecione...</option>';
                veiculos.forEach(v => {
                    select.innerHTML += `<option value="${v.id}">${v.veiculo}</option>`;
                });
                
                // Restaurar ve√≠culo selecionado se existir
                if (veiculoAtual && veiculoSelecionadoOriginal) {
                    const existe = Array.from(select.options).some(opt => opt.value == veiculoAtual);
                    if (existe) {
                        select.value = veiculoAtual;
                    } else {
                        // Se n√£o existe na lista, adiciona
                        select.innerHTML += `<option value="${veiculoSelecionadoOriginal.id}">${veiculoSelecionadoOriginal.veiculo}</option>`;
                        select.value = veiculoAtual;
                    }
                }
            }
            
            async function preencherSelectTiposDemanda() {
                try {
                    const selectTipoDemanda = document.getElementById('idTipoDemanda');
                    const valorAtual = selectTipoDemanda.value; // Guardar valor atual para edi√ß√£o
                    
                    // Montar URL - n√£o filtrar mais por contexto
                    let url = '/api/agenda/tipos-demanda';
                    
                    const res = await fetch(url);
                    const tipos = await res.json();
                    
                    selectTipoDemanda.innerHTML = '<option value="">Selecione...</option>';
                    tipos.forEach(t => {
                        selectTipoDemanda.innerHTML += `<option value="${t.id}" data-descricao="${t.descricao}">${t.descricao}</option>`;
                    });
                    
                    // Restaurar valor na edi√ß√£o (se ainda existir nas op√ß√µes)
                    if (valorAtual) {
                        const opcaoExiste = Array.from(selectTipoDemanda.options).some(opt => opt.value == valorAtual);
                        if (opcaoExiste) {
                            selectTipoDemanda.value = valorAtual;
                        }
                    }
                } catch (error) {
                    console.error('Erro ao carregar tipos de demanda:', error);
                }
            }

            // ========== MODIFICAR FUN√á√ÉO EXISTENTE: salvarDemanda ==========
            async function salvarDemanda() {
                const idAd = document.getElementById('idAd').value;
                const idTipoDemanda = parseInt(document.getElementById('idTipoDemanda').value);
                const definirHorario = document.getElementById('definirHorario').checked;
                const horario = document.getElementById('horario').value;
                const expandirVeiculos = document.getElementById('expandirVeiculos').checked;

                // Validar hor√°rio se checkbox estiver marcado
                if (definirHorario) {
                    if (!horario) {
                        mostrarAlerta('Informe o hor√°rio!', '‚ö†Ô∏è Aten√ß√£o', '#ffc107');
                        return;
                    }
                    if (!validarHorario(horario)) {
                        mostrarAlerta('Hor√°rio inv√°lido! Use o formato HH:MM (ex: 08:30)', '‚ö†Ô∏è Aten√ß√£o', '#ffc107');
                        return;
                    }
                }

                const dados = {
                    id_motorista: document.getElementById('idMotorista').value || null,
                    id_tipodemanda: idTipoDemanda,
                    id_tipoveiculo: document.getElementById('idTipoVeiculo').value || null,
                    id_veiculo: document.getElementById('idVeiculo').value || null,
                    dt_inicio: document.getElementById('dtInicio').value,
                    dt_fim: document.getElementById('dtFim').value,
                    setor: document.getElementById('setor').value,
                    solicitante: document.getElementById('solicitante').value,
                    destino: document.getElementById('destino').value,
                    nu_sei: document.getElementById('nuSei').value,
                    obs: document.getElementById('obs').value,
                    solicitado: document.getElementById('solicitado').checked ? 'S' : 'N',
                    horario: definirHorario ? horario : '',
                    nc_motorista: document.getElementById('ncMotorista').value || '',
                    todos_veiculos: expandirVeiculos ? 'S' : 'N',
                    usuario: document.getElementById('usuario').value
                };
                
                // Valida√ß√µes obrigat√≥rias b√°sicas
                if (!dados.id_tipodemanda || !dados.dt_inicio || !dados.dt_fim) {
                    mostrarAlerta('Preencha todos os campos obrigat√≥rios: Tipo de Demanda, Data In√≠cio e Data Fim!', '‚ö†Ô∏è Aten√ß√£o', '#ffc107');
                    return;
                }
                
                const idTipoVeiculo = parseInt(document.getElementById('idTipoVeiculo').value);
                
                // Valida√ß√£o de Motorista: obrigat√≥rio exceto para ID 9, 10, 12 e IDs tipo ve√≠culo 7, 8, 9
                const dispensaMotorista = idTipoDemanda === 9 || idTipoDemanda === 10 || idTipoDemanda === 12 ||
                                        idTipoVeiculo === 7 || idTipoVeiculo === 8 || idTipoVeiculo === 9;
                
                if (!dispensaMotorista && !dados.id_motorista) {
                    mostrarAlerta('O campo Motorista √© obrigat√≥rio!', '‚ö†Ô∏è Aten√ß√£o', '#ffc107');
                    return;
                }

                // Valida√ß√£o espec√≠fica para motorista n√£o cadastrado
                if (dados.id_motorista === '0' && !dados.nc_motorista) {
                    mostrarAlerta('Informe o nome do motorista n√£o cadastrado!', '‚ö†Ô∏è Aten√ß√£o', '#ffc107');
                    return;
                }            
                
                // Valida√ß√£o para ID 10: Setor obrigat√≥rio
                if (idTipoDemanda === 10 && !dados.setor) {
                    mostrarAlerta('Para Ced√™ncia, o campo Setor √© obrigat√≥rio!', '‚ö†Ô∏è Aten√ß√£o', '#ffc107');
                    return;
                }

                
                try {
                    let res;
                    let demandaIdRetornado = null;
                    
                    if (idAd) {
                        // EDI√á√ÉO - n√£o verifica loca√ß√£o
                        res = await fetch(`/api/agenda/demanda/${idAd}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(dados)
                        });
                    } else {
                        // NOVA DEMANDA
                        res = await fetch('/api/agenda/demanda', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(dados)
                        });
                    }
                    
                    const result = await res.json();
                    
                    if (result.success || result.id) {
                        demandaIdRetornado = result.id || idAd;
                        
                        // Fechar modal da demanda
                        fecharModal();
                        
                        // Recarregar semanas e agenda
                        await carregarSemanas();
                        await carregarAgenda();
                        
                        // ====== NOVA L√ìGICA: VERIFICAR LOCA√á√ÉO APENAS PARA NOVAS DEMANDAS ======
                        if (!idAd && demandaIdRetornado) {
                            // Aguardar um momento para garantir que a demanda foi salva
                            await new Promise(resolve => setTimeout(resolve, 500));
                            
                            // Verificar e solicitar loca√ß√£o
                            await verificarESolicitarLocacao(demandaIdRetornado, dados);
                        }
                        
                    } else {
                        mostrarAlerta('Erro ao salvar: ' + (result.error || 'Erro desconhecido'), '‚ùå Erro', '#dc3545');
                    }
                } catch (error) {
                    console.error('Erro:', error);
                    mostrarAlerta('Erro ao salvar demanda!', '‚ùå Erro', '#dc3545');
                }
            }
            
            async function excluirDemanda() {
                const idAd = document.getElementById('idAd').value;
                
                if (!idAd) {
                    return;
                }
                
                mostrarConfirmacao(
                    'Deseja realmente excluir esta demanda?',
                    async function(confirmado) {
                        if (!confirmado) {
                            return;
                        }
                        
                        try {
                            mostrarSpinner();
                            
                            const idAdNumero = parseInt(idAd);
                            const demanda = dadosAgenda.demandas.find(d => parseInt(d.id) === idAdNumero);
                            
                            if (!demanda) {
                                esconderSpinner();
                                mostrarAlerta('Demanda n√£o encontrada!', '‚ùå Erro', '#dc3545');
                                return;
                            }
                            
                            if (demanda.id_motorista && parseInt(demanda.id_motorista) > 0) {
                                const locacaoVinculada = locacoesAtivas.find(loc => 
                                    loc.id_motorista === demanda.id_motorista &&
                                    loc.data_inicio <= demanda.dt_fim &&
                                    loc.data_fim >= demanda.dt_inicio
                                );
                                
                                if (locacaoVinculada) {
                                    esconderSpinner();
                                    
                                    await new Promise(resolve => setTimeout(resolve, 300));
                                    
                                    mostrarConfirmacao(
                                        'Esta demanda possui uma loca√ß√£o vinculada.<br><br>A loca√ß√£o tamb√©m ser√° exclu√≠da. Deseja continuar?',
                                        async function(confirmarLocacao) {
                                            if (!confirmarLocacao) {
                                                return;
                                            }
                                            
                                            mostrarSpinner();
                                            
                                            try {
                                                const resLocacao = await fetch(`/api/excluir_locacao/${locacaoVinculada.id_item}`, {
                                                    method: 'DELETE'
                                                });
                                                
                                                if (!resLocacao.ok) {
                                                    const errorData = await resLocacao.json();
                                                    throw new Error(errorData.erro || 'Erro ao excluir loca√ß√£o vinculada');
                                                }
                                                
                                                const res = await fetch(`/api/agenda/demanda/${idAd}`, {
                                                    method: 'DELETE'
                                                });
                                                
                                                const result = await res.json();
                                                
                                                esconderSpinner();
                                                
                                                if (result.success) {
                                                    fecharModal();
                                                    
                                                    await carregarSemanas();
                                                    await carregarLocacoes();
                                                    await carregarAgenda();
                                                    
                                                    mostrarAlerta('Demanda e loca√ß√£o vinculada exclu√≠das com sucesso!', '‚úÖ Sucesso', '#28a745');
                                                } else {
                                                    mostrarAlerta('Erro ao excluir demanda: ' + (result.error || 'Erro desconhecido'), '‚ùå Erro', '#dc3545');
                                                }
                                                
                                            } catch (errorLocacao) {
                                                esconderSpinner();
                                                mostrarAlerta('Erro ao excluir loca√ß√£o vinculada: ' + errorLocacao.message, '‚ùå Erro', '#dc3545');
                                            }
                                        },
                                        '‚ö†Ô∏è Loca√ß√£o Vinculada'
                                    );
                                    
                                    return;
                                }
                            }
                            
                            const res = await fetch(`/api/agenda/demanda/${idAd}`, {
                                method: 'DELETE'
                            });
                            
                            const result = await res.json();
                            
                            esconderSpinner();
                            
                            if (result.success) {
                                fecharModal();
                                
                                await carregarSemanas();
                                await carregarLocacoes();
                                await carregarAgenda();
                                
                                mostrarAlerta('Demanda exclu√≠da com sucesso!', '‚úÖ Sucesso', '#28a745');
                            } else {
                                mostrarAlerta('Erro ao excluir: ' + (result.error || 'Erro desconhecido'), '‚ùå Erro', '#dc3545');
                            }
                            
                        } catch (error) {
                            esconderSpinner();
                            mostrarAlerta('Erro ao excluir demanda: ' + error.message, '‚ùå Erro', '#dc3545');
                        }
                    },
                    '‚ö†Ô∏è Excluir Demanda'
                );
            }
            
            // ========== EVENT LISTENER CONSOLIDADO PARA TODOS OS MODAIS ==========
            window.addEventListener('click', function(event) {
                // Modal principal de demanda
                const modal = document.getElementById('modal');
                if (event.target === modal) {
                    fecharModal();
                }
                
                // Modais de alerta e confirma√ß√£o padr√£o
                const modalAlerta = document.getElementById('modalAlerta');
                const modalConfirmacao = document.getElementById('modalConfirmacao');
                
                if (event.target === modalAlerta) {
                    fecharModalAlerta();
                }
                
                if (event.target === modalConfirmacao) {
                    fecharModalConfirmacao(false);
                }
                
                // Modais de loca√ß√£o
                const modalFormLocacao = document.getElementById('modalFormLocacao');
                const modalSucessoLocacao = document.getElementById('modalSucessoLocacao');
                const modalConfirmacaoLocacao = document.getElementById('modalConfirmacaoLocacao');
                
                if (event.target === modalFormLocacao) {
                    fecharModalFormLocacao();
                }
                
                if (event.target === modalSucessoLocacao) {
                    fecharModalSucessoLocacao();
                }
                
                if (event.target === modalConfirmacaoLocacao) {
                    fecharModalConfirmacaoLocacao(false);
                }
                
                // Modal de feriados
                const modalFeriados = document.getElementById('modalFeriados');
                if (event.target === modalFeriados) {
                    fecharModalFeriados();
                }
            });

            document.addEventListener('click', function(event) {
                if (celulaSelecionada && !event.target.closest('.agenda-table')) {
                    celulaSelecionada.classList.remove('cell-selected');
                    celulaSelecionada = null;
                }
            });
            
            function scrollWeekTabs(direction) {
                const scrollContainer = document.getElementById('weekTabsScroll');
                const scrollAmount = 200; // pixels
                
                scrollPosition += (direction * scrollAmount);
                scrollContainer.scrollLeft = scrollPosition;
                
                // Atualizar posi√ß√£o real ap√≥s scroll
                setTimeout(() => {
                    scrollPosition = scrollContainer.scrollLeft;
                    atualizarBotoesNavegacao();
                }, 100);
            }

            function atualizarBotoesNavegacao() {
                const scrollContainer = document.getElementById('weekTabsScroll');
                const btnPrev = document.getElementById('btnPrevWeek');
                const btnNext = document.getElementById('btnNextWeek');
                
                if (!scrollContainer || !btnPrev || !btnNext) return;
                
                const maxScroll = scrollContainer.scrollWidth - scrollContainer.clientWidth;
                
                // Desabilitar bot√£o esquerdo se estiver no in√≠cio
                btnPrev.disabled = scrollContainer.scrollLeft <= 0;
                
                // Desabilitar bot√£o direito se estiver no fim
                btnNext.disabled = scrollContainer.scrollLeft >= maxScroll;
            }

            function scrollToActiveTab() {
                const scrollContainer = document.getElementById('weekTabsScroll');
                const activeTab = document.querySelector('.week-tab.active');
                
                if (!scrollContainer || !activeTab) return;
                
                const containerRect = scrollContainer.getBoundingClientRect();
                const tabRect = activeTab.getBoundingClientRect();
                
                // Verificar se a aba est√° fora da vis√£o
                if (tabRect.left < containerRect.left || tabRect.right > containerRect.right) {
                    // Centralizar a aba ativa
                    const scrollLeft = activeTab.offsetLeft - (scrollContainer.clientWidth / 2) + (activeTab.clientWidth / 2);
                    scrollContainer.scrollLeft = scrollLeft;
                    scrollPosition = scrollLeft;
                }
                
                atualizarBotoesNavegacao();
            }

            // Atualizar bot√µes ao redimensionar janela
            window.addEventListener('resize', () => {
                atualizarBotoesNavegacao();
            });

            // Atualizar bot√µes ao scroll manual
            document.addEventListener('DOMContentLoaded', () => {
                const scrollContainer = document.getElementById('weekTabsScroll');
                if (scrollContainer) {
                    scrollContainer.addEventListener('scroll', () => {
                        scrollPosition = scrollContainer.scrollLeft;
                        atualizarBotoesNavegacao();
                    });
                }
            });

            // Verificar se ve√≠culo j√° possui demandas com hor√°rio no mesmo per√≠odo
            async function verificarObrigatoriedadeHorario() {
                const idVeiculo = document.getElementById('idVeiculo').value;
                const dtInicio = document.getElementById('dtInicio').value;
                const dtFim = document.getElementById('dtFim').value;
                const idAd = document.getElementById('idAd').value;
                
                if (!idVeiculo || !dtInicio || !dtFim) return;
                
                try {
                    let url = `/api/agenda/verificar-horario-veiculo?id_veiculo=${idVeiculo}&inicio=${dtInicio}&fim=${dtFim}`;
                    if (idAd) {
                        url += `&id_demanda=${idAd}`;
                    }
                    
                    const res = await fetch(url);
                    const result = await res.json();
                    
                    if (result.tem_horario) {
                        // For√ßar checkbox de hor√°rio
                        document.getElementById('definirHorario').checked = true;
                        document.getElementById('definirHorario').disabled = true;
                        document.getElementById('horario').disabled = false;
                        
                        mostrarAlerta('Este ve√≠culo j√° possui demandas com hor√°rio definido neste per√≠odo. √â obrigat√≥rio informar o hor√°rio.', '‚ÑπÔ∏è Informa√ß√£o', '#1a73e8');
                    } else {
                        document.getElementById('definirHorario').disabled = false;
                    }
                } catch (error) {
                    console.error('Erro ao verificar obrigatoriedade de hor√°rio:', error);
                }
            }
            
            // Adicionar event listener ao select de ve√≠culo
            document.getElementById('idVeiculo').addEventListener('change', verificarObrigatoriedadeHorario);
            
            function abrirVisualizacaoSecao(tipo) {
                const semana = semanas[semanaAtual];
                const dias = gerarDiasSemana(semana.inicio);
                
                let htmlSecao = '';
                let titulo = '';
                
                switch(tipo) {
                    case 'motoristas':
                        titulo = 'üë≤ SEGEOP - MOTORISTAS';
                        htmlSecao = renderizarSecaoMotoristasCompleta(dias, titulo);
                        break;
                    case 'outros-motoristas':
                        titulo = 'üë≤ OUTROS MOTORISTAS';
                        htmlSecao = renderizarSecaoOutrosMotoristas(dias);
                        // Extrair apenas a tabela (remover div externa)
                        const tempDiv1 = document.createElement('div');
                        tempDiv1.innerHTML = htmlSecao;
                        const tabela1 = tempDiv1.querySelector('table');
                        htmlSecao = `<div class="agenda-section">
                            <div class="section-title">${titulo}</div>
                            ${tabela1.outerHTML}
                        </div>`;
                        break;
                    case 'veiculos':
                        titulo = 'üöô SEGEOP - VE√çCULOS OFICIAIS';
                        htmlSecao = renderizarSecaoVeiculos(dias);
                        // Extrair apenas a tabela
                        const tempDiv2 = document.createElement('div');
                        tempDiv2.innerHTML = htmlSecao;
                        const tabela2 = tempDiv2.querySelector('table');
                        htmlSecao = `<div class="agenda-section">
                            <div class="section-title">${titulo}</div>
                            ${tabela2.outerHTML}
                        </div>`;
                        break;
                    case 'veiculos-alocados':
                        titulo = 'üöå SEGEOP - VE√çCULOS ALOCADOS';
                        htmlSecao = renderizarSecaoVeiculosAlocados(dias);
                        // Extrair apenas a tabela
                        const tempDiv3 = document.createElement('div');
                        tempDiv3.innerHTML = htmlSecao;
                        const tabela3 = tempDiv3.querySelector('table');
                        htmlSecao = `<div class="agenda-section">
                            <div class="section-title">${titulo}</div>
                            ${tabela3.outerHTML}
                        </div>`;
                        break;
                }
                
                // Criar nova janela
                const novaJanela = window.open('', '_blank');
                novaJanela.document.write(`
                    <!DOCTYPE html>
                    <html lang="pt-BR">
                    <head>
                        <meta charset="UTF-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <title>${titulo} - ${semana.label}</title>
                        <style>
                            * { margin: 0; padding: 0; box-sizing: border-box; }
                            
                            body {
                                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                                background: white;
                            }
                            
                            .print-view {
                                padding: 10px;
                                background: white;
                                min-height: 100vh;
                            }
                            
                            .agenda-section {
                                margin: 0;
                                height: auto;
                            }
                            
                            .section-title {
                                background: #34495e;
                                color: white;
                                padding: 12px 15px;
                                font-size: 18px;
                                text-align: center;
                                font-weight: bold;
                            }
                            
                            .agenda-table {
                                width: 100%;
                                border-collapse: collapse;
                                border: 1px solid #ddd;
                                table-layout: fixed;
                                font-size: 11px;
                            }
                            
                            .agenda-table th {
                                background: #ecf0f1;
                                padding: 10px;
                                text-align: center;
                                border: 1px solid #ddd;
                                font-size: 12px;
                                font-weight: 600;
                            }
                            
                            .agenda-table td {
                                border: 1px solid #bbb;
                                padding: 4px;
                                vertical-align: middle;
                                font-size: 10px;
                            }
                            
                            .col-numero {
                                width: 35px;
                                background: #f8f9fa;
                                font-weight: 600;
                                text-align: center;
                            }
                            
                            .col-nome {
                                width: 180px;
                                background: #f8f9fa;
                                font-weight: 600;
                                word-wrap: break-word;
                                white-space: normal;
                            }
                            
                            .col-dia {
                                width: calc((100% - 215px) / 7);
                            }
                            
                            .cell-content,
                            .cell-content-veiculos {
                                line-height: 1.3;
                                min-height: 30px;
                                font-size: 10px;
                            }
                            
                            .cell-divider {
                                border-top: 1px dashed #999;
                                margin: 5px 0;
                                padding-top: 5px;
                            }
                            
                            .demanda-horario {
                                font-size: 9px;
                                color: #666;
                                font-style: italic;
                            }
                            
                            .informar-veiculo {
                                color: #dc3545;
                                font-style: italic;
                                font-size: 9px;
                            }
                            
                            .tipo-1 { background: linear-gradient(to bottom, #5fa1df, #8dbde8); }
                            .tipo-2 { background: linear-gradient(to bottom, #79f183, #9ff7a7); }
                            .tipo-3, .tipo-4, .tipo-5 { background: linear-gradient(to bottom, #f8c295, #fad4b3); }
                            .tipo-6, .tipo-7, .tipo-8 { background: linear-gradient(to bottom, #f3f183, #f7f5a7); font-weight: bold; }
                            .tipo-9 { background: linear-gradient(to bottom, #ff5d5d, #fca5a5) !important; font-weight: bold; }
                            .tipo-10 { background: linear-gradient(to bottom, hsl(320, 1%, 61%), hsl(330, 7%, 84%)) !important; font-weight: bold; }
                            .tipo-11 { background: linear-gradient(to bottom, #ffb3d9, #ffd9ec); }
                            .tipo-locacao { background: linear-gradient(to bottom, #c7a3e7, #d9bef0) !important; }
                            .tipo-solicitado { background: linear-gradient(to bottom, #c7a3e7, #d9bef0) !important; }
                            
                            .empty-cell { background: #fafafa; }
                            .empty-cell.weekend-empty { background: #e0e0e0; }
                            
                            .cell-feriado {
                                background: #fdfcb2 !important;
                                font-weight: bold;
                                font-size: 10px;
                                text-align: center;
                            }
                            
                            .cell-feriado-com-demanda {
                                position: relative;
                            }
                            
                            .cell-feriado-com-demanda::before {
                                content: '';
                                position: absolute;
                                top: 0;
                                left: 0;
                                right: 0;
                                bottom: 0;
                                background: repeating-linear-gradient(
                                    45deg,
                                    transparent,
                                    transparent 10px,
                                    rgba(243, 241, 131, 0.3) 10px,
                                    rgba(243, 241, 131, 0.3) 20px
                                );
                                pointer-events: none;
                            }
                            
                            .veiculo-extra {
                                background: #fffacd !important;
                            }
                            
                            .col-nome.veiculo-extra {
                                background: #fffacd !important;
                                font-style: italic;
                            }
                            
                            .col-numero.veiculo-extra {
                                background: #fffacd !important;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="print-view">
                            ${htmlSecao}
                        </div>
                    </body>
                    </html>
                `);
                novaJanela.document.close();
            }

            function renderizarSecaoMotoristasCompleta(dias, titulo) {
                let html = '<div class="agenda-section">';
                html += `<div class="section-title">${titulo}</div>`;
                html += '<table class="agenda-table"><thead><tr>';
                html += '<th class="col-numero">N.</th><th class="col-nome">Nome</th>';
                dias.forEach(d => html += `<th class="col-dia">${d.diaNome}<br>${d.diaNum}/${d.mes}</th>`);
                html += '</tr></thead><tbody>';
                
                motoristas.forEach((m, motoristaGlobalIndex) => {
                    const demandasPorDia = dias.map(dia => {
                        return dadosAgenda.demandas.filter(d => 
                            d.id_motorista === m.id && 
                            d.dt_inicio <= dia.data && 
                            d.dt_fim >= dia.data
                        );
                    });
                    
                    const maxDemandasPorDia = Math.max(...demandasPorDia.map(d => d.length), 1);
                    const celulasRenderizadas = Array(maxDemandasPorDia).fill(0).map(() => Array(dias.length).fill(false));
                    
                    for (let linhaIndex = 0; linhaIndex < maxDemandasPorDia; linhaIndex++) {
                        html += `<tr>`;
                        
                        if (linhaIndex === 0) {
                            if (maxDemandasPorDia > 1) {
                                html += `<td class="col-numero" rowspan="${maxDemandasPorDia}">${motoristaGlobalIndex + 1}</td>`;
                                html += `<td class="col-nome" rowspan="${maxDemandasPorDia}">${m.nome}</td>`;
                            } else {
                                html += `<td class="col-numero">${motoristaGlobalIndex + 1}</td>`;
                                html += `<td class="col-nome">${m.nome}</td>`;
                            }
                        }
                        
                        for (let diaIndex = 0; diaIndex < dias.length; diaIndex++) {
                            if (celulasRenderizadas[linhaIndex][diaIndex]) continue;
                            
                            const dia = dias[diaIndex];
                            const feriado = isFeriado(dia.data);
                            const isWeekend = dia.diaIndex === 0 || dia.diaIndex === 6;
                            const demandasDia = demandasPorDia[diaIndex];
                            const demanda = demandasDia[linhaIndex];
                            
                            if (demanda) {
                                let rowspanCount = 1;
                                for (let proxLinha = linhaIndex + 1; proxLinha < maxDemandasPorDia; proxLinha++) {
                                    if (!demandasDia[proxLinha]) {
                                        rowspanCount++;
                                        celulasRenderizadas[proxLinha][diaIndex] = true;
                                    } else break;
                                }
                                
                                const corClass = `tipo-${demanda.id_tipodemanda}`;
                                const feriadoClass = feriado ? 'cell-feriado-com-demanda' : '';
                                // html += `<td class="${corClass} ${feriadoClass} col-dia" ${rowspanCount > 1 ? `rowspan="${rowspanCount}"` : ''}>`;
                                html += `<td class="${corClass} ${feriadoClass} col-dia" ${rowspanCount > 1 ? `rowspan="${rowspanCount}"` : ''} onmouseenter="mostrarTooltipVeiculo(event, ${demanda.id})" onmousemove="posicionarTooltip(event)" onmouseleave="esconderTooltipVeiculo()">`;
        
                                html += '<div class="cell-content">';
                                
                                // ID 9 (Oficina)
                                if (demanda.id_tipodemanda === 9) {
                                    html += `<div><strong>${demanda.de_tipodemanda || 'Oficina'}</strong></div>`;
                                    if (demanda.id_motorista === 0 && demanda.nc_motorista) {
                                        html += `<div class="cell-divider"></div>`;
                                        html += `<div><strong>${demanda.nc_motorista}</strong></div>`;
                                    } else if (demanda.nm_motorista) {
                                        html += `<div class="cell-divider"></div>`;
                                        html += `<div><strong>${demanda.nm_motorista}</strong></div>`;
                                    }
                                    if (demanda.destino) {
                                        html += `<div>${demanda.destino}</div>`;
                                    }
                                }
                                // ID 10 (Ced√™ncia)
                                else if (demanda.id_tipodemanda === 10) {
                                    html += `<div><strong>${demanda.de_tipodemanda || 'Ced√™ncia'}</strong></div>`;
                                    if (demanda.id_motorista === 0 && demanda.nc_motorista) {
                                        html += `<div class="cell-divider"></div>`;
                                        html += `<div><strong>${demanda.nc_motorista}</strong></div>`;
                                    } else if (demanda.nm_motorista) {
                                        html += `<div class="cell-divider"></div>`;
                                        html += `<div><strong>${demanda.nm_motorista}</strong></div>`;
                                    }
                                    if (demanda.setor) {
                                        html += `<div><strong>${demanda.setor}</strong></div>`;
                                    }
                                    if (demanda.nu_sei) {
                                        html += `<div>${demanda.nu_sei}</div>`;
                                    }
                                }
                                // ID 1, 2 ou 11 com hor√°rio
                                else if ((demanda.id_tipodemanda === 1 || demanda.id_tipodemanda === 2 || demanda.id_tipodemanda === 11) && demanda.horario) {
                                    if (demanda.setor || demanda.solicitante) {
                                        html += `<div><strong>${demanda.setor || ''}</strong>${demanda.solicitante ? ' (' + demanda.solicitante + ')' : ''}</div>`;
                                    }
                                    html += `<div>${demanda.destino || ''} <span class="demanda-horario">(${demanda.horario})</span></div>`;
                                    html += `<div>${demanda.nu_sei || ''}</div>`;
                                }
                                // Outros tipos
                                else {
                                    if (demanda.setor || demanda.solicitante) {
                                        html += `<div><strong>${demanda.setor || ''}</strong>${demanda.solicitante ? ' (' + demanda.solicitante + ')' : ''}</div>`;
                                    }
                                    html += `<div>${demanda.destino || ''}</div>`;
                                    html += `<div>${demanda.nu_sei || ''}</div>`;
                                }
                                
                                if (!demanda.id_tipoveiculo && ![6, 7, 8, 9, 10, 12].includes(demanda.id_tipodemanda)) {
                                    html += '<div class="informar-veiculo">(INFORMAR VE√çCULO)</div>';
                                }
                                
                                html += '</div></td>';
                                celulasRenderizadas[linhaIndex][diaIndex] = true;
                            } else {
                                let rowspanCount = 1;
                                for (let proxLinha = linhaIndex + 1; proxLinha < maxDemandasPorDia; proxLinha++) {
                                    if (!demandasDia[proxLinha]) {
                                        rowspanCount++;
                                        celulasRenderizadas[proxLinha][diaIndex] = true;
                                    } else break;
                                }
                                
                                if (feriado) {
                                    html += `<td class="cell-feriado col-dia" ${rowspanCount > 1 ? `rowspan="${rowspanCount}"` : ''}>${feriado.descricao}</td>`;
                                } else {
                                    const weekendClass = isWeekend ? 'weekend-empty' : '';
                                    html += `<td class="empty-cell ${weekendClass} col-dia" ${rowspanCount > 1 ? `rowspan="${rowspanCount}"` : ''}></td>`;
                                }
                                celulasRenderizadas[linhaIndex][diaIndex] = true;
                            }
                        }
                        html += '</tr>';
                    }
                });
                
                html += '</tbody></table></div>';
                return html;
            }

            // Fun√ß√£o para retornar √† p√°gina inicial
            function voltarPaginaInicial() {
                window.location.href = '/';
            }
            
            init();
            
        </script>
    </body>
    </html>
