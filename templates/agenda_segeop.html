<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="static/img/logo_sotweb.jpg">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda SEGEOP</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- CSS do Menu (se voc√™ tiver um arquivo separado) -->
    <link rel="stylesheet" href="/static/css/menu-styles.css">

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding-top: 38px !important;
            background-color: #f5f5f5;
            color: #333;
            font-size: 13px;
            min-height: 100vh;
        }

        /* ‚¨áÔ∏è ADICIONAR TODO ESTE BLOCO AQUI ‚¨áÔ∏è */
        /* ========================================= */
        /* ESTILOS DO MENU - FOR√áAR ALTURA E ALINHAMENTO CORRETO */
        /* ========================================= */

        .navbar-nav {
            height: 100% !important;
            align-items: center !important;
        }

        .navbar .container,
        .navbar .container-fluid {
            height: 100% !important;
            align-items: center !important;
        }

        .navbar-collapse {
            height: auto !important;
        }

        #menu-container * {
            margin: revert;
            padding: revert;
        }

        .page-container {
            max-width: 100%;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-top: 0; /* ‚¨ÖÔ∏è MODIFICADO: era 10px */ 
        }

        .header {
            background: #1a73e8;
            color: white;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
            position: relative; /* ‚¨ÖÔ∏è MODIFICADO: era 'fixed' */
            top: 0; /* ‚¨ÖÔ∏è MANTER */
            left: 0; /* ‚¨ÖÔ∏è MANTER */
            right: 0; /* ‚¨ÖÔ∏è MANTER */
            z-index: 100; /* ‚¨ÖÔ∏è MODIFICADO: era 200 */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-btn {
            background: white;
            color: #1a73e8;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .header-btn:hover {
            background: #f0f0f0;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .header h1 { 
            font-size: 18px; 
            margin: 0; 
        }

        .header .periodo {
            font-size: 14px;
            color: #fff9c4;
            font-weight: 500;
        }

        .agenda-wrapper {
            overflow-x: auto;
            padding: 20px;
        }

        .agenda-section {
            margin-bottom: 20px;
        }

        .section-title {
            background: #34495e;
            color: white;
            padding: 10px 15px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 4px 4px 0 0;
        }

        .agenda-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #ddd;
            table-layout: fixed;
        }

        .agenda-table th {
            background: #ecf0f1;
            padding: 10px;
            text-align: center;
            border: 1px solid #ddd;
            font-size: 13px;
            font-weight: 600;
        }

        .agenda-table td {
            border: 1px solid #bbb;
            padding: 6px;
            vertical-align: middle;
            font-size: 12px;
            position: relative;
            cursor: pointer;
            transition: background 0.2s;
            overflow: visible;
        }

        .cell-selected {
            filter: brightness(0.85);
            box-shadow: inset 0 0 0 2px #1a73e8;
        }

        .tipo-locacao {
            background: linear-gradient(to bottom, #c7a3e7, #d9bef0) !important;
        }

        .motorista-filter {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .motorista-filter label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            font-weight: normal;
            font-size: 14px;
        }

        .motorista-filter input[type="radio"] {
            cursor: pointer;
            width: auto;
        }

        .motorista-inline-filter {
            display: flex;
            gap: 20px;
            margin-bottom: 8px;
            padding: 8px 0;
        }

        .motorista-inline-filter label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            font-weight: normal;
            font-size: 14px;
            margin: 0;
        }

        .motorista-inline-filter input[type="radio"] {
            cursor: pointer;
            width: auto;
            margin: 0;
        }

        #divSolicitado label {
            display: flex;
            align-items: center;
            font-weight: 600;
            cursor: pointer;
        }

        .tipo-solicitado {
            background: linear-gradient(to bottom, #c7a3e7, #d9bef0) !important;
        }

        /* SUBSTITUIR a regra existente */
        .agenda-table td:hover {
            filter: brightness(1.1) !important; /* Clareia 10% mantendo a cor */
        }

        .col-numero {
            width: 40px;
            background: #f8f9fa;
            font-weight: 600;
            text-align: center;
        }

        .col-nome {
            width: 216px;
            background: #f8f9fa;
            font-weight: 600;
            word-wrap: break-word;
            white-space: normal;
        }

        .col-dia {
            width: calc((100% - 256px) / 7);
        }

        .cell-content {
            line-height: 1.2;
            min-height: 28px;
            height: auto;
            overflow: visible;
            font-size: 11px;
        }

        .cell-content-veiculos {
            line-height: 1.2;
            min-height: 24px;
            height: auto;
            overflow: visible;
            font-size: 11px;
        }

        .cell-content-veiculos div {
            margin-bottom: 1px;
        }
        
        .cell-content div {
            margin-bottom: 1px;
        }

        .informar-veiculo {
            color: #dc3545;
            font-style: italic;
            font-size: 10px;
        }

        .diaria-nao-solicitada {
            color: #dc3545;
            font-style: italic;
            font-size: 10px;
        }
        
        .empty-cell {
            background: #fafafa;
        }

        .empty-cell.weekend-empty {
            background: #e0e0e0;
        }

        /* FOOTER COM TABS ESTILO EXCEL/DELPHI */
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #e8e8e8;
            padding: 0;
            border-top: 1px solid #c0c0c0;
            display: flex;
            justify-content: flex-start;
            align-items: flex-start;
            gap: 0;
            z-index: 100;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
            height: 45px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
            margin: 10px 0 10px 15px;
            align-self: flex-start;
        }

        .btn-primary {
            background: #1a73e8;
            color: white;
        }

        .btn-primary:hover { background: #1557b0; }

        /* TABS NAVEGA√á√ÉO ESTILO EXCEL */
        .week-tabs-wrapper {
            display: flex;
            align-items: flex-start;
            gap: 0;
            flex: 1;
            overflow: hidden;
            height: 100%;
            background: #e8e8e8;
            padding-bottom: 0;
        }

        .week-nav-btn {
            background: #f0f0f0;
            /* border: 1px solid #c0c0c0; */
            border: 1px solid #c0c0c0 !important;
            /* border-bottom: none; */
            cursor: pointer;
            padding: 8px 10px;
            font-size: 10px;
            transition: all 0.2s;
            flex-shrink: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 2px 2px 0 8px;
            align-self: flex-start;
        }

        .week-nav-btn:hover:not(:disabled) {
            background: #fff;
        }

        .week-nav-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background: #e0e0e0;
        }

        .week-tabs-scroll {
            display: flex;
            gap: 0;
            overflow-x: auto;
            overflow-y: hidden;
            scroll-behavior: smooth;
            flex: 1;
            height: 100%;
            align-items: flex-start;
            background: #e8e8e8;
            padding: 0 4px 0 0;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .week-tabs-scroll::-webkit-scrollbar {
            display: none;
        }

        .week-tabs-container {
            display: inline-flex;
            gap: -1px;
            flex-wrap: nowrap;
            align-items: flex-start;
            height: 100%;
            padding: 0;
            margin: 0;
        }

        .week-tab {
            padding: 10px 20px;
            background: #d4d4d4;
            border: 1px solid #c0c0c0;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.15s;
            white-space: nowrap;
            flex-shrink: 0;
            user-select: none;
            display: inline-flex;
            align-items: center;
            height: 32px;
            margin: 0;
            border-radius: 0 0 6px 6px;  /* MANT√âM: arredondado embaixo */
            border-top: none;  /* SEM borda em cima */
            border-bottom: 1px solid #c0c0c0;  /* COM borda embaixo */
            position: relative;
            color: #333;
            font-weight: 500;
        }

        .week-tab:hover:not(.active) {
            background: #e8e8e8;
            border-color: #b0b0b0;
            z-index: 1;
        }

        .week-tab.active {
            /* background: #ffffff; */
            background: #73d7e4;
            color: #000;
            border-color: #c0c0c0;
            border-top: none;  /* SEM borda em cima */
            border-bottom: 1px solid #c0c0c0;  /* COM borda embaixo */
            font-weight: 600;
            z-index: 2;
            height: 35px;
            padding: 10px 22px;
            margin-top: 0;
            margin-bottom: 0;  /* SEM margin negativo */
        }

        .week-tab.active::before {
            content: '';
            position: absolute;
            top: -1px;  /* NO topo */
            left: 0;
            right: 0;
            height: 2px;
            background: #5aadb8;
        }

        .week-tab:not(.active) {
            box-shadow: inset 0 -2px 3px rgba(0,0,0,0.05);
        }

        /* MODALS */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000 !important;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }

        /* Garantir que modal de alerta apare√ßa ACIMA de todos os outros */
        #modalAlerta {
            z-index: 20000 !important; /* Maior que modalVisualizacao (10000) */
        }

        #modalConfirmacao {
            z-index: 20000 !important;
        }

        /* For√ßar altura de 30px no navbar */
        .navbar {
            min-height: 30px !important;
            height: 30px !important;
            padding: 0 !important; /* IMPORTANTE: remover padding */
        }

        .navbar-nav {
            height: 100% !important;
            align-items: center !important;
            margin: 0 !important; /* IMPORTANTE: remover margin */
        }

        .navbar .container,
        .navbar .container-fluid {
            height: 100% !important;
            align-items: center !important;
            padding: 0 15px !important; /* IMPORTANTE: padding horizontal apenas */
        }

        .navbar-collapse {
            height: auto !important;
            align-items: center !important; /* ADICIONAR */
        }

        /* Ajustar itens do menu para alinhamento vertical */
        .navbar-nav .nav-link {
            padding: 5px 10px !important; /* IMPORTANTE: padding vertical reduzido */
            line-height: 20px !important; /* IMPORTANTE: controlar altura da linha */
            display: flex !important;
            align-items: center !important;
            height: 30px !important;
        }

        /* Ajustar dropdown menu */
        .navbar-nav .dropdown-menu {
            margin-top: 0 !important;
        }

        /* Ajustar bot√£o toggler para mobile */
        .navbar-toggler {
            padding: 2px 5px !important;
            font-size: 1rem !important;
        }

        /* Garantir que dropdowns funcionem */
        .navbar-nav .dropdown:hover .dropdown-menu {
            display: block;
        }
        
        .navbar-nav .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            z-index: 1000;
            display: none;
            min-width: 10rem;
            padding: 0.5rem 0;
            margin: 0;
            font-size: 13px;
            color: #212529;
            background-color: #fff;
            border: 1px solid rgba(0,0,0,.15);
            border-radius: 0.25rem;
        }
        
        .navbar-nav .dropdown-item {
            padding: 0.25rem 1rem;
            clear: both;
            font-weight: 400;
            color: #212529;
            text-align: inherit;
            white-space: nowrap;
            background-color: transparent;
            border: 0;
        }
        
        .navbar-nav .dropdown-item:hover {
            background-color: #f8f9fa;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 0;
            width: 90%;
            max-width: 600px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            animation: slideDown 0.3s;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .modal-header {
            background: #1a73e8;
            color: white;
            padding: 10px 20px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .modal-header h2 { 
            font-size: 16px;
            margin: 0;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: white;
            opacity: 0.8;
        }

        .close:hover { opacity: 1; }

        .modal-body {
            padding: 15px 20px;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 600;
            font-size: 13px;
            color: #333;
        }

        .form-group label .required {
            color: #dc3545;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }

        .form-group input:disabled,
        .form-group select:disabled {
            background: #e9ecef;
            cursor: not-allowed;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 50px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .modal-footer {
            padding: 12px 20px;
            background: #f8f9fa;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            border-radius: 0 0 8px 8px;
            position: sticky;
            bottom: 0;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover { background: #5a6268; }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover { background: #c82333; }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .feriados-container {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .feriado-form {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .feriado-form-row {
            display: grid;
            grid-template-columns: 2fr 2fr 1fr;
            gap: 10px;
            align-items: end;
        }

        .feriados-lista {
            max-height: 400px;
            overflow-y: auto;
        }

        .feriado-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            margin-bottom: 8px;
            transition: background 0.2s;
        }

        .feriado-item:hover {
            filter: brightness(1.1) !important; /* Clareia 10% mantendo a cor */
            /* background: #f8f9fa; */
        }



        .feriado-info {
            flex: 1;
        }

        .feriado-descricao {
            font-weight: 600;
            color: #333;
            margin-bottom: 3px;
        }

        .feriado-data {
            font-size: 12px;
            color: #666;
        }

        .btn-icon {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            padding: 5px 10px;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .btn-icon:hover {
            opacity: 1;
        }

        .cell-feriado {
            background: #fdfcb2 !important;
            font-weight: bold;
            font-size: 11px;
            text-align: center;
            vertical-align: middle;
        }

        .cell-feriado-com-demanda {
            position: relative;
        }

        .cell-feriado-com-demanda::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(243, 241, 131, 0.3) 10px,
                rgba(243, 241, 131, 0.3) 20px
            );
            pointer-events: none;
        }

        #horario:disabled {
            background: #e9ecef;
            cursor: not-allowed;
        }
        
        .demanda-horario {
            font-size: 10px;
            color: #666;
            font-style: italic;
        }
        
        .cell-divider {
            border-top: 1px dashed #999;
            margin: 5px 0;
            padding-top: 5px;
        }

        /* Adicionar ap√≥s os outros estilos de c√©lulas */

        /* C√©lula marcada no intervalo */
        .cell-intervalo-selecionado {
            background: #d3d3d3 !important;
            position: relative;
        }

        .cell-intervalo-selecionado::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border: 2px solid #666;
            pointer-events: none;
        }

        /* Cursor especial quando Ctrl est√° pressionado - APENAS nas se√ß√µes permitidas */
        .modo-selecao-ativo .agenda-section:first-child .empty-cell,
        .modo-selecao-ativo .agenda-section:nth-child(2) .empty-cell,
        .modo-selecao-ativo .agenda-section:nth-child(3) .empty-cell {
            cursor: crosshair !important;
        }            

        .veiculo-extra {
            background: #fffacd !important; /* Cor amarelo claro */
        }
        
        .col-nome.veiculo-extra {
            background: #fffacd !important;
            font-style: italic;
        }
        
        .col-numero.veiculo-extra {
            background: #fffacd !important;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #34495e;
            color: white;
            padding: 10px 15px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 4px 4px 0 0;
        }

        .btn-visualizar {
            background: white;
            color: #34495e;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-visualizar:hover {
            background: #ecf0f1;
            transform: scale(1.05);
        }

        /* Estilos para a janela de visualiza√ß√£o */
        .print-view {
            padding: 10px;
            background: white;
            min-height: 100vh;
            box-sizing: border-box;
        }

        .print-view .agenda-section {
            margin: 0;
            height: auto;
        }

        .print-view .agenda-table {
            width: 100%;
            font-size: 11px;
        }

        .print-view .section-title,
        .print-view .section-header {
            background: #34495e;
            color: white;
            padding: 12px 15px;
            font-size: 18px;
            text-align: center;
            border-radius: 0;
        }

        .print-view .col-numero {
            width: 35px;
        }

        .print-view .col-nome {
            width: 180px;
        }

        .print-view .cell-content,
        .print-view .cell-content-veiculos {
            font-size: 10px;
            line-height: 1.3;
        }  

        /* Cabe√ßalho flutuante das se√ß√µes */
        .sticky-header {
            position: fixed;
            top: 40px; /* 126px */
            left: 20px;  /* ADICIONAR: margem esquerda igual ao padding do body */
            right: 20px;  /* ADICIONAR: margem direita igual ao padding do body */
            z-index: 90;
            background: rgba(236, 240, 241, 0.80);  /* ALTERADO: mais transparente (era 0.95) */
            backdrop-filter: blur(8px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            display: none;
            padding: 0;  /* REMOVIDO: padding de 20px */
            transition: opacity 0.3s ease;
        }
        
        .sticky-header.visible {
            display: block;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .sticky-header table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
            table-layout: fixed;  /* ADICIONAR: para manter larguras consistentes */
        }
        
        .sticky-header th {
            background: transparent;
            padding: 10px;
            text-align: center;
            border: none;
            border-right: 1px solid rgba(221, 221, 221, 0.5);
            font-size: 13px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .sticky-header th:last-child {
            border-right: none;
        }
        
        .sticky-header .col-numero {
            width: 40px;
        }
        
        .sticky-header .col-nome {
            width: 216px;
        }
        
        .sticky-header .col-dia {
            width: calc((100% - 256px) / 7);
        }   

        /* Tooltip para ve√≠culo */
        .tooltip-veiculo {
            position: absolute;
            background: rgba(0, 0, 0, 0.85); /* Mais opaco para melhor leitura */
            color: white;
            padding: 10px 14px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: normal;
            z-index: 1000;
            pointer-events: none;
            white-space: pre-line; /* ‚úÖ Permite quebra de linha */
            max-width: 350px; /* ‚úÖ Limita largura para OBS longos */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            opacity: 0;
            transition: opacity 0.2s;
            line-height: 1.5;
            word-wrap: break-word; /* ‚úÖ Quebra palavras longas */
        }
        
        .tooltip-veiculo.visible {
            opacity: 1;
        }

        /* Spinner de carregamento */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        
        .loading-overlay.visible {
            display: flex;
        }
        
        .spinner-container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1a73e8;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .spinner-text {
            color: #333;
            font-size: 14px;
            font-weight: 500;
        }
        
        .input-group-text {
            background: #e9ecef;
            border: 1px solid #ddd;
            font-weight: 600;
        }

        /* ========== ESTILOS PARA FORMUL√ÅRIO DE LOCA√á√ÉO ========== */

        #modalFormLocacao .modal-content {
            max-width: 700px;
        }

        #modalFormLocacao .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        #modalFormLocacao .form-group {
            margin-bottom: 15px;
        }

        #modalFormLocacao .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 13px;
            color: #333;
        }

        #modalFormLocacao .required {
            color: #dc3545;
        }

        #modalFormLocacao input[type="text"],
        #modalFormLocacao input[type="date"],
        #modalFormLocacao input[type="time"],
        #modalFormLocacao input[type="number"],
        #modalFormLocacao select,
        #modalFormLocacao textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }

        #modalFormLocacao input[readonly],
        #modalFormLocacao select[readonly] {
            background: #f8f9fa;
            cursor: not-allowed;
        }

        #modalFormLocacao textarea {
            resize: vertical;
            min-height: 70px;
        }

        #modalFormLocacao .text-end {
            text-align: right;
            margin-top: 5px;
            font-size: 12px;
            color: #666;
        }

        /* Input group para valores monet√°rios */
        .input-group {
            display: flex;
        }

        .input-group-sm .input-group-text {
            padding: 6px 10px;
            font-size: 13px;
            border-right: none;
            border-radius: 4px 0 0 4px;
        }

        .input-group-sm input {
            border-left: none;
            border-radius: 0 4px 4px 0;
        }

        /* Bot√£o Solicitar Loca√ß√£o na edi√ß√£o */
        #btnSolicitarLocacaoEdicao {
            font-size: 14px;
            padding: 8px 16px;
            transition: all 0.3s;
        }

        #btnSolicitarLocacaoEdicao:hover {
            background: #218838 !important;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
        }

        /* Bot√£o Solicitar Di√°ria na edi√ß√£o */
        #btnSolicitarDiariaEdicao {
            font-size: 14px;
            padding: 8px 16px;
            transition: all 0.3s;
        }

        #btnSolicitarDiariaEdicao:hover {
            background: #138496 !important;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(23, 162, 184, 0.3);
        }

        /* Status de loca√ß√£o solicitada */
        #areaLocacaoStatus {
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Anima√ß√£o para o modal de confirma√ß√£o */
        #modalConfirmacaoLocacao .modal-content {
            animation: bounceIn 0.5s;
        }
        
        @keyframes bounceIn {
            0% {
                transform: scale(0.3);
                opacity: 0;
            }
            50% {
                transform: scale(1.05);
            }
            70% {
                transform: scale(0.9);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        #modalConfirmacaoLocacao .btn {
            transition: all 0.3s;
        }
        
        #modalConfirmacaoLocacao .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        /* Anima√ß√£o para modal de sucesso */
        #modalSucessoLocacao .modal-dialog {
            animation: zoomIn 0.3s;
        }
        
        @keyframes zoomIn {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        #modalSucessoLocacao .modal-content {
            border: none;
        }
        
        #modalSucessoLocacao .btn-close {
            font-size: 12px;
        }

        #statusCNHDiscrete {
            transition: all 0.3s;
            font-size: 11px !important;
            padding: 3px 8px !important;
        }

        #statusCNHDiscrete:empty {
            display: none;
        }

        /* Anima√ß√£o sutil ao aparecer */
        @keyframes fadeInRight {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        #statusCNHDiscrete {
            animation: fadeInRight 0.3s;
        }

        /* Autocomplete Setor */
        .autocomplete-container {
            position: relative;
            width: 100%;
        }

        .autocomplete-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            display: none;
        }

        .autocomplete-list.visible {
            display: block;
        }

        .autocomplete-item {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 13px;
            border-bottom: 1px solid #f0f0f0;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:hover,
        .autocomplete-item.selected {
            background: #e8f0fe;
            color: #1a73e8;
        }

        .autocomplete-item-highlight {
            font-weight: 600;
            color: #1a73e8;
        }

        /* Destaque sutil nas c√©lulas N. e Nome ao passar mouse na linha */
        .col-numero.row-hover,
        .col-nome.row-hover {
            filter: brightness(0.94);
            transition: filter 0.15s ease;
        }
        
        /* Alternativa com zoom sutil na fonte */
        .col-numero.row-hover-zoom,
        .col-nome.row-hover-zoom {
            font-size: 1.05em;
            transition: font-size 0.2s ease;
        }
        
        /* Voc√™ pode escolher entre os dois efeitos ou combinar ambos */
        .col-numero.row-hover-combined,
        .col-nome.row-hover-combined {
            filter: brightness(0.92);
            font-size: 1.03em;
            transition: all 0.2s ease;
        }

        /* Anima√ß√£o de erro para c√©lulas */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-3px); }
            20%, 40%, 60%, 80% { transform: translateX(3px); }
        }

        .cell-intervalo-invalido {
            animation: shake 0.5s;
            background: rgba(255, 0, 0, 0.1) !important;
        }

        /* ========== MODAL DE VISUALIZA√á√ÉO COMPACTA ========== */
        #modalVisualizacao {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            animation: fadeIn 0.3s;
        }

        #modalVisualizacao .modal-content {
            background: white;
            margin: 20px auto;
            width: 75%; /* ALTERADO de 98% para 75% */
            max-width: 1050px; /* ALTERADO de 1400px para 1050px (75% de 1400) */
            height: calc(100vh - 40px);
            border-radius: 4px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #modalVisualizacao .modal-header {
            background: #1a73e8;
            color: white;
            padding: 8px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        #modalVisualizacao .modal-header h2 {
            font-size: 16px;
            margin: 0;
        }

        #modalVisualizacao .modal-body {
            flex: 1;
            overflow: auto;
            padding: 0;
            background: white;
        }

        /* ========== TABELA COMPACTA ESTILO EXCEL ========== */
        .view-compacta {
            width: 100%;
            margin: 0;
            padding: 0;
        }

        .view-compacta .section-title-compacto {
            background: #34495e;
            color: white;
            padding: 6px 10px;
            font-size: 14px;
            font-weight: bold;
            text-align: center;
            margin: 0;
            border: none;
        }

        .view-compacta .agenda-table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
            table-layout: fixed;
        }

        .view-compacta .agenda-table th {
            background: #e8e8e8;
            padding: 4px 2px;
            text-align: center;
            border: 1px solid #bbb;
            font-size: 10px;
            font-weight: 600;
            line-height: 1.2;
        }

        .view-compacta .agenda-table td {
            border: 1px solid #bbb;
            padding: 2px 3px;
            vertical-align: top;
            font-size: 9px;
            line-height: 1.2;
            min-height: 18px;
        }


        .view-compacta .col-numero {
            width: 28px;
            background: #f5f5f5;
            font-weight: 600;
            text-align: center;
            padding: 2px 1px;
        }

        .view-compacta .col-nome {
            width: 140px;
            background: #f5f5f5;
            font-weight: 600;
            word-wrap: break-word;
            white-space: normal;
            padding: 2px 4px;
        }

        
        .view-compacta .col-dia {
            width: calc((100% - 168px) / 7);
        }

        .view-compacta .cell-content,
        .view-compacta .cell-content-veiculos {
            font-size: 9px;
            line-height: 1.3;
            min-height: 16px;
        }

        .view-compacta .cell-content div,
        .view-compacta .cell-content-veiculos div {
            margin-bottom: 1px;
        }

        .view-compacta .cell-divider {
            border-top: 1px dashed #999;
            margin: 2px 0;
            padding-top: 2px;
        }

        .view-compacta .demanda-horario {
            font-size: 8px;
            color: #666;
            font-style: italic;
        }

        .view-compacta .informar-veiculo {
            color: #dc3545;
            font-style: italic;
            font-size: 8px;
        }

        .view-compacta .empty-cell {
            background: #fafafa;
            min-height: 18px;
        }

        .view-compacta .empty-cell.weekend-empty {
            background: #e8e8e8;
        }

        .view-compacta .cell-feriado {
            background: #fdfcb2 !important;
            font-weight: bold;
            font-size: 8px;
            text-align: center;
            padding: 2px;
        }

        .view-compacta .veiculo-extra {
            background: #fffacd !important;
        }

        .view-compacta .col-nome.veiculo-extra {
            background: #fffacd !important;
            font-style: italic;
        }

        .view-compacta .col-numero.veiculo-extra {
            background: #fffacd !important;
        }

        /* Bot√µes do modal */
        .modal-view-footer {
            padding: 8px 15px;
            background: #f8f9fa;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            border-top: 1px solid #ddd;
            flex-shrink: 0;
        }

        .btn-copiar-imagem {
            background: #28a745;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
        }

        .btn-copiar-imagem:hover {
            background: #218838;
        }

        /* Anima√ß√£o do bot√£o atualizar */
        .header-btn.atualizando {
            /* animation: rotate 1s linear infinite;  */
            pointer-events: none;
            opacity: 0.6;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Feedback visual de conflito */
        @keyframes pulseRed {
            0%, 100% { 
                background: rgba(220, 53, 69, 0.1);
                border-color: #dc3545;
            }
            50% { 
                background: rgba(220, 53, 69, 0.3);
                border-color: #c82333;
            }
        }

        .cell-conflito {
            animation: pulseRed 1s ease-in-out 3;
            border: 2px solid #dc3545 !important;
        }

        /* Notifica√ß√£o de Atualiza√ß√£o */
        .update-notification {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            min-width: 400px;
            max-width: 90%;
            animation: slideDown 0.4s ease-out;
        }

        /* Estilos do contador regressivo */
        .countdown-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: 15px;
        }
        
        .countdown-text {
            font-size: 13px;
            color: #fff;
            font-weight: 500;
        }
        
        .countdown-timer {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 12px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 14px;
            min-width: 35px;
            text-align: center;
        }
        
        .countdown-actions {
            display: flex;
            gap: 8px;
        }
        
        .countdown-btn {
            background: rgba(255, 255, 255, 0.9);
            color: #1976d2;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .countdown-btn:hover {
            background: #fff;
            transform: translateY(-1px);
        }
        
        .countdown-btn.btn-cancel {
            background: rgba(244, 67, 54, 0.9);
            color: white;
        }
        
        .countdown-btn.btn-cancel:hover {
            background: #f44336;
        }
        
        /* ========== GROUPBOX ESTILO DELPHI ========== */
        .group-box {
            border: 1px solid #c0c0c0;
            border-radius: 4px;
            padding: 15px 12px 12px 12px;
            margin-bottom: 15px;
            position: relative;
            background: #fafafa;
        }
        
        .group-box-legend {
            position: absolute;
            top: -10px;
            left: 10px;
            background: white;
            padding: 0 8px;
            font-weight: 600;
            font-size: 13px;
            color: #333;
        }
        
        .group-box-legend .required {
            color: #dc3545;
            margin-left: 2px;
        }
        
        .group-box-content {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        @keyframes slideDownBounce {
            0% {
                transform: translateX(-50%) translateY(-100px);
                opacity: 0;
            }
            60% {
                transform: translateX(-50%) translateY(10px);
                opacity: 1;
            }
            80% {
                transform: translateX(-50%) translateY(-5px);
            }
            100% {
                transform: translateX(-50%) translateY(0);
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 8px 24px rgba(255, 107, 107, 0.4), 0 0 0 3px rgba(255, 255, 255, 0.3);
            }
            50% {
                box-shadow: 0 8px 32px rgba(255, 107, 107, 0.7), 0 0 0 5px rgba(255, 255, 255, 0.5);
            }
        }
        
        .update-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            flex-wrap: wrap;
        }
                
        .update-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }
        
        .update-icon {
            font-size: 24px;
            animation: rotate 2s linear infinite;
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .update-text {
            font-size: 15px;
            font-weight: 600;
            flex: 1;
        }
        
        .btn-update-now {
            background: white;
            color: #667eea;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .btn-update-now:hover {
            background: #f0f0f0;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .btn-dismiss {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .btn-dismiss:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }
        
        /* Estilos do contador regressivo */
        .countdown-container {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            margin-left: auto;
        }
        
        .countdown-text {
            font-size: 13px;
            color: #fff;
            font-weight: 500;
            white-space: nowrap;
        }
        
        .countdown-timer {
            background: rgba(255, 255, 255, 0.9);
            color: #667eea;
            padding: 6px 14px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 15px;
            min-width: 45px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .countdown-actions {
            display: flex;
            gap: 8px;
        }
        
        .countdown-btn {
            background: rgba(255, 255, 255, 0.95);
            color: #667eea;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        .countdown-btn:hover {
            background: #fff;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        
        .countdown-btn.btn-cancel {
            background: rgba(244, 67, 54, 0.9);
            color: white;
        }
        
        .countdown-btn.btn-cancel:hover {
            background: #f44336;
        }
        
        /* Responsividade */
        @media (max-width: 768px) {
            .update-notification {
                min-width: 320px;
                padding: 12px 16px;
            }
            
            .update-content {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }
            
            .countdown-container {
                margin-left: 0;
                justify-content: center;
            }
            
            .btn-dismiss {
                position: absolute;
                top: 8px;
                right: 8px;
            }
        }
    </style>

    <!-- Biblioteca para copiar como imagem (OPCIONAL) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

</head>
<body>
    <!-- Menu ser√° carregado aqui pelo menu-loader.js -->
    <div id="menu-container"></div>

    <div class="page-container">
        <div class="header">
            <div class="header-left">
                <h1>üìÖ AGENDA SEGEOP</h1>
                <span class="periodo" id="semanaAtual"></span>
            </div>
                <div class="header-right">
                    <button class="header-btn" onclick="abrirModalNovoGeral()" title="Nova Demanda">
                        ‚ûï Nova Demanda
                    </button>
                    <button class="header-btn" onclick="atualizarAgendaManual()" title="Atualizar Listas">
                        üîÑ Atualizar
                    </button>
                    <button class="header-btn" onclick="abrirModalFeriados()" title="Gerenciar Feriados">
                        üóìÔ∏è
                    </button>
                    <button class="header-btn" onclick="voltarPaginaInicial()" title="Retornar √† P√°gina Inicial">
                        üè† In√≠cio
                    </button>
                </div>
        </div>

        <!-- Barra de Notifica√ß√£o de Atualiza√ß√£o -->
        <div id="updateNotification" class="update-notification" style="display: none;">
            <div class="update-content">
                <div class="update-info">
                    <span class="update-icon">üîÑ</span>
                    <span class="update-text">Existem atualiza√ß√µes dispon√≠veis na agenda</span>
                </div>
                <button class="btn-dismiss" onclick="dispensarNotificacao()">
                    ‚úï
                </button>
            </div>
        </div>

        <div class="agenda-wrapper" id="agendaWrapper">
            <div class="loading">‚è≥ Carregando agenda...</div>
        </div>
    </div>

    <!-- Cabe√ßalhos flutuantes para cada se√ß√£o -->
    <div id="stickyHeaderMotoristas" class="sticky-header">
        <table>
            <thead>
                <tr>
                    <th class="col-numero">N.</th>
                    <th class="col-nome">Nome</th>
                    <th class="col-dia" id="sticky-dia-1"></th>
                    <th class="col-dia" id="sticky-dia-2"></th>
                    <th class="col-dia" id="sticky-dia-3"></th>
                    <th class="col-dia" id="sticky-dia-4"></th>
                    <th class="col-dia" id="sticky-dia-5"></th>
                    <th class="col-dia" id="sticky-dia-6"></th>
                    <th class="col-dia" id="sticky-dia-7"></th>
                </tr>
            </thead>
        </table>
    </div>
    
    <div id="stickyHeaderAdministrativo" class="sticky-header">
        <table>
            <thead>
                <tr>
                    <th class="col-numero">N.</th>
                    <th class="col-nome">Nome</th>
                    <th class="col-dia" id="sticky-admin-dia-1"></th>
                    <th class="col-dia" id="sticky-admin-dia-2"></th>
                    <th class="col-dia" id="sticky-admin-dia-3"></th>
                    <th class="col-dia" id="sticky-admin-dia-4"></th>
                    <th class="col-dia" id="sticky-admin-dia-5"></th>
                    <th class="col-dia" id="sticky-admin-dia-6"></th>
                    <th class="col-dia" id="sticky-admin-dia-7"></th>
                </tr>
            </thead>
        </table>
    </div>    
    
    <div id="stickyHeaderOutrosMotoristas" class="sticky-header">
        <table>
            <thead>
                <tr>
                    <th class="col-numero">N.</th>
                    <th class="col-nome">Nome</th>
                    <th class="col-dia" id="sticky-outros-dia-1"></th>
                    <th class="col-dia" id="sticky-outros-dia-2"></th>
                    <th class="col-dia" id="sticky-outros-dia-3"></th>
                    <th class="col-dia" id="sticky-outros-dia-4"></th>
                    <th class="col-dia" id="sticky-outros-dia-5"></th>
                    <th class="col-dia" id="sticky-outros-dia-6"></th>
                    <th class="col-dia" id="sticky-outros-dia-7"></th>
                </tr>
            </thead>
        </table>
    </div>
    
    <div id="stickyHeaderVeiculos" class="sticky-header">
        <table>
            <thead>
                <tr>
                    <th class="col-numero">N.</th>
                    <th class="col-nome">Ve√≠culo</th>
                    <th class="col-dia" id="sticky-veic-dia-1"></th>
                    <th class="col-dia" id="sticky-veic-dia-2"></th>
                    <th class="col-dia" id="sticky-veic-dia-3"></th>
                    <th class="col-dia" id="sticky-veic-dia-4"></th>
                    <th class="col-dia" id="sticky-veic-dia-5"></th>
                    <th class="col-dia" id="sticky-veic-dia-6"></th>
                    <th class="col-dia" id="sticky-veic-dia-7"></th>
                </tr>
            </thead>
        </table>
    </div>
    
    <div id="stickyHeaderVeiculosAlocados" class="sticky-header">
        <table>
            <thead>
                <tr>
                    <th class="col-numero">N.</th>
                    <th class="col-nome">Tipo Ve√≠culo / SEI / Destino</th>
                    <th class="col-dia" id="sticky-aloc-dia-1"></th>
                    <th class="col-dia" id="sticky-aloc-dia-2"></th>
                    <th class="col-dia" id="sticky-aloc-dia-3"></th>
                    <th class="col-dia" id="sticky-aloc-dia-4"></th>
                    <th class="col-dia" id="sticky-aloc-dia-5"></th>
                    <th class="col-dia" id="sticky-aloc-dia-6"></th>
                    <th class="col-dia" id="sticky-aloc-dia-7"></th>
                </tr>
            </thead>
        </table>
    </div>
    
    <div class="footer">
        <div class="week-tabs-wrapper">
            <button class="week-nav-btn" id="btnPrevWeek" onclick="scrollWeekTabs(-1)" title="Anterior">‚óÄ</button>
            <div class="week-tabs-scroll" id="weekTabsScroll">
                <div class="week-tabs-container" id="weekTabs"></div>
            </div>
            <button class="week-nav-btn" id="btnNextWeek" onclick="scrollWeekTabs(1)" title="Pr√≥xima">‚ñ∂</button>
        </div>
    </div>
    
    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Nova Demanda</h2>
                <span class="close" onclick="fecharModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="formDemanda">
                    <input type="hidden" id="idAd" value="">
                    
                    <!-- Linha 1: Datas -->
                    <div class="form-row">
                        <div class="form-group">
                            <label>Data In√≠cio <span class="required">*</span></label>
                            <input type="date" id="dtInicio" required>
                        </div>
                        <div class="form-group">
                            <label>Data Fim <span class="required">*</span></label>
                            <input type="date" id="dtFim" required>
                        </div>
                    </div>
                    
                    <!-- Linha 2: Checkbox Hor√°rio e Input Hor√°rio -->
                    <div class="form-row">
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="definirHorario" style="width: auto; margin-right: 8px;" onchange="toggleHorario()">
                                Definir Hor√°rio
                            </label>
                        </div>
                        <div class="form-group">
                            <label>Hor√°rio</label>
                            <input type="text" id="horario" maxlength="5" placeholder="HH:MM" disabled>
                        </div>
                    </div>
                                        
                    <!-- Linha 3: Tipo de Demanda e Tipo de Ve√≠culo -->
                    <div class="form-row">
                        <div class="form-group">
                            <label>Tipo de Demanda <span class="required">*</span></label>
                            <select id="idTipoDemanda" required></select>
                        </div>
                        <div class="form-group">
                            <label id="labelTipoVeiculo">Tipo de Ve√≠culo</label>
                            <select id="idTipoVeiculo"></select>
                        </div>
                    </div>
                    
                    <!-- Linha 4: Motorista (GroupBox Estilo Delphi) -->
                    <div class="group-box">
                        <div class="group-box-legend">
                            <span id="labelMotorista">Motorista/Servidor <span class="required">*</span></span>
                        </div>
                        <div class="group-box-content">
                            <!-- Radio Buttons -->
                            <div class="motorista-inline-filter" id="motoristaFilter">
                                <label>
                                    <input type="radio" name="tipoMotorista" value="segeop" checked> Motorista Segeop
                                </label>
                                <label>
                                    <input type="radio" name="tipoMotorista" value="administrativo"> Administrativo
                                </label>
                                <label>
                                    <input type="radio" name="tipoMotorista" value="todos"> Todos
                                </label>
                            </div>
                            
                            <!-- Select Motorista - ADICIONAR STYLE INLINE -->
                            <select id="idMotorista" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;"></select>
                    
                            <!-- Campo Motorista N√£o Cadastrado (oculto por padr√£o) -->
                            <div id="divNcMotorista" style="display: none; margin-top: 8px;">
                                <label style="font-size: 12px; font-weight: 600;">Motorista n√£o cadastrado <span class="required">*</span></label>
                                <input type="text" id="ncMotorista" maxlength="50" style="margin-top: 4px; width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Linha 5: Ve√≠culo -->
                    <div class="form-group">
                        <label id="labelVeiculo">Ve√≠culo</label>
                        <select id="idVeiculo"></select>
                    </div>

                    <div class="form-group" id="divExpandirVeiculos" style="display: none;">
                        <label>
                            <input type="checkbox" id="expandirVeiculos" style="width: auto; margin-right: 8px;" onchange="toggleExpandirVeiculos()">
                            Expandir para todos os ve√≠culos da frota
                        </label>
                    </div>
                    
                    <!-- Linha 6: Setor e Solicitante -->
                    <div class="form-row">
                        <div class="form-group">
                            <label id="labelSetor">Setor</label>
                            <div class="autocomplete-container">
                                <input type="text" id="setor" maxlength="35" autocomplete="off">
                                <div class="autocomplete-list" id="setorAutocompleteList"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label id="labelSolicitante">Solicitante</label>
                            <input type="text" id="solicitante" maxlength="30">
                        </div>
                    </div>
                    
                    <!-- Linha 7: Destino e N¬∫ SEI -->
                    <div class="form-row">
                        <div class="form-group">
                            <label id="labelDestino">Destino</label>
                            <input type="text" id="destino" maxlength="40">
                        </div>    
                        <div class="form-group">
                            <label>N¬∫ SEI</label>
                            <input type="text" id="nuSei" maxlength="25">
                        </div>
                    </div>
                    
                    <!-- Linha 8: Observa√ß√µes -->
                    <div class="form-group">
                        <label>Observa√ß√µes</label>
                        <textarea id="obs" maxlength="200" rows="3"></textarea>
                    </div>
                    
                    <!-- Checkbox Solicitado (oculto por padr√£o) -->
                    <div class="form-group" id="divSolicitado" style="display: none;">
                        <label>
                            <input type="checkbox" id="solicitado" style="width: auto; margin-right: 8px;">
                            Solicitado
                        </label>
                    </div>
                    
                    <input type="hidden" id="usuario" value="ADMIN">
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="fecharModal()">Cancelar</button>
                <button class="btn btn-danger" id="btnExcluir" onclick="excluirDemanda()" style="display:none;">üóëÔ∏è Excluir</button>
                <button class="btn btn-primary" onclick="salvarDemanda()">üíæ Salvar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal Feriados -->
    <div id="modalFeriados" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üóìÔ∏è Gerenciar Feriados</h2>
                <span class="close" onclick="fecharModalFeriados()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="feriados-container">
                    <!-- Formul√°rio de Inclus√£o -->
                    <div class="feriado-form">
                        <div class="feriado-form-row">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Tipo</label>
                                <select id="tipoFeriado">
                                    <option value="Feriado">FERIADO</option>
                                    <option value="Ponto Facultativo">PONTO FACULTATIVO</option>
                                    <option value="Outro">OUTRO</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Data</label>
                                <input type="date" id="dataFeriado" required>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>&nbsp;</label>
                                <button class="btn btn-primary" onclick="adicionarFeriado()">‚ûï Adicionar</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Lista de Feriados -->
                    <div class="feriados-lista" id="feriadosLista">
                        <div class="loading">Carregando feriados...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Formul√°rio de Loca√ß√£o -->
    <div id="modalFormLocacao" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Solicitar Loca√ß√£o de Ve√≠culo</h2>
                <span class="close" onclick="fecharModalFormLocacao()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="formSolicitacaoLocacao">
                    <!-- Campos ocultos -->
                    <input type="hidden" id="loc_id_cl" value="">
                    <input type="hidden" id="loc_id_veiculo_loc" value="">
                    <input type="hidden" id="loc_id_motorista" value="">
                    <input type="hidden" id="loc_vl_diaria" value="">
                                
                    <!-- Linha 1: Empenho e Setor -->
                    <div class="form-row">
                        <div class="form-group">
                            <label>Empenho <span class="required">*</span></label>
                            <select id="loc_id_empenho" required>
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Setor Solicitante <span class="required">*</span></label>
                            <input type="text" id="loc_setor" maxlength="35" required readonly style="background: #f8f9fa;">
                        </div>
                    </div>

                    <!-- Linha 2: Objetivo -->
                    <div class="form-group">
                        <label>Objetivo <span class="required">*</span></label>
                        <input type="text" id="loc_objetivo" maxlength="300" required>
                    </div>

                    <!-- Linha 3: N√∫mero SEI -->
                    <div class="form-group">
                        <label>N√∫mero SEI <span class="required">*</span></label>
                        <input type="text" id="loc_nu_sei" maxlength="25" required readonly style="background: #f8f9fa;">
                    </div>

                    <!-- Linha 3.5: Nome do Motorista + Status CNH DISCRETO -->
                    <div class="form-group">
                        <label>Motorista</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="text" id="loc_nome_motorista" readonly style="background: #f8f9fa; font-weight: 600; color: #1a73e8; flex: 1;">
                            <span id="statusCNHDiscrete" style="font-size: 12px; padding: 4px 10px; border-radius: 4px; font-weight: 600; white-space: nowrap;">
                                <!-- Ser√° preenchido via JS -->
                            </span>
                        </div>
                    </div>
                    
                    <!-- Linha 3.6: Ve√≠culo -->
                    <div class="form-group">
                        <label>Tipo de Ve√≠culo</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="text" id="loc_tipo_veiculo" readonly style="background: #f8f9fa; font-weight: 600; color: #1a73e8; flex: 1;">
                        </div>
                    </div>

                    <!-- Linha 4: Datas -->
                    <div class="form-row">
                        <div class="form-group">
                            <label>Data In√≠cio <span class="required">*</span></label>
                            <input type="date" id="loc_dt_inicio" required readonly style="background: #f8f9fa;">
                        </div>
                        <div class="form-group">
                            <label>Data Fim <span class="required">*</span></label>
                            <input type="date" id="loc_dt_fim" required readonly style="background: #f8f9fa;">
                        </div>
                    </div>
                    
                    <!-- Linha 5: Hor√°rio e Quantidade de Di√°rias - CORRIGIDO -->
                    <div class="form-row">
                        <div class="form-group">
                            <label>Hor√°rio In√≠cio <span class="required">*</span></label>
                            <input type="time" id="loc_horario" required>
                        </div>
                        <div class="form-group">
                            <label>Qtd. Di√°rias <span class="required">*</span></label>
                            <input type="number" id="loc_qt_diarias" required readonly style="background: #f8f9fa; font-weight: 600;">
                        </div>
                    </div>
                    
                    <!-- Linha 6: Valores -->
                    <div class="form-row">
                        <div class="form-group">
                            <label>Valor Di√°ria</label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">R$</span>
                                <input type="text" id="loc_vl_diaria_display" readonly style="background: #f8f9fa; font-weight: 600;">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Valor Total</label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">R$</span>
                                <input type="text" id="loc_vl_total" readonly style="background: #f8f9fa; font-weight: 600; color: #1a73e8; font-size: 16px;">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Linha 7: Observa√ß√µes -->
                    <div class="form-group">
                        <label>Observa√ß√µes</label>
                        <textarea id="loc_obs" maxlength="200" rows="3"></textarea>
                        <div class="text-end">
                            <small><span id="loc_charCount">0</span>/200</small>
                        </div>
                    </div>
                    
                    <!-- Upload CNH (condicional) -->
                    <div id="loc_divUploadCNH" style="display: none;">
                        <div class="form-group">
                            <label>Anexar CNH do Motorista <span class="required">*</span></label>
                            <input type="file" id="loc_arquivo_cnh" accept=".pdf" class="form-control">
                            <small style="color: #dc3545;">√â necess√°rio anexar a CNH para prosseguir com a solicita√ß√£o.</small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="fecharModalFormLocacao()">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="confirmarSolicitacaoLocacao(event)">‚úì Confirmar Solicita√ß√£o</button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o Personalizado -->
    <div id="modalConfirmacaoLocacao" class="modal" style="z-index: 10000;">
        <div class="modal-content" style="max-width: 450px; animation: slideDown 0.3s;">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <h2 style="font-size: 18px; margin: 0;">üöó Solicita√ß√£o de Loca√ß√£o</h2>
            </div>
            <div class="modal-body" style="padding: 30px 20px; text-align: center;">
                <div style="font-size: 48px; margin-bottom: 15px;">üöô</div>
                <p style="font-size: 16px; color: #333; line-height: 1.6; margin-bottom: 20px;">
                    Esta demanda possui <strong>v√≠nculo com loca√ß√£o de ve√≠culos</strong>.
                </p>
                <p style="font-size: 15px; color: #666; margin-bottom: 0;">
                    Deseja solicitar a loca√ß√£o agora?
                </p>
            </div>
            <div class="modal-footer" style="justify-content: center; gap: 15px; padding: 15px 20px;">
                <button class="btn btn-secondary" onclick="fecharModalConfirmacaoLocacao(false)" style="min-width: 100px;">
                    N√£o
                </button>
                <button class="btn btn-primary" onclick="fecharModalConfirmacaoLocacao(true)" style="min-width: 100px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
                    Sim, solicitar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Sucesso -->
    <div id="modalSucessoLocacao" class="modal" style="z-index: 10001;">
        <div class="modal-content" style="max-width: 450px; animation: zoomIn 0.3s; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <div class="modal-header" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border-radius: 8px 8px 0 0;">
                <h2 style="font-size: 18px; margin: 0; font-weight: 600;">‚úì Sucesso</h2>
                <span class="close" onclick="fecharModalSucessoLocacao()" style="color: white;">&times;</span>
            </div>
            <div class="modal-body" id="mensagemSucessoLocacao" style="padding: 25px 20px; text-align: center; font-size: 15px; line-height: 1.6;">
                <!-- Mensagem ser√° inserida via JavaScript -->
            </div>
            <div class="modal-footer" style="justify-content: center; border-top: none; padding: 10px 20px 20px;">
                <button type="button" class="btn btn-primary" onclick="fecharModalSucessoLocacao()" style="min-width: 100px; background: #28a745; border-color: #28a745;">OK</button>
            </div>
        </div>
    </div>

    <!-- Modal de Alerta Padr√£o (OK) -->
    <div id="modalAlerta" class="modal" style="z-index: 10004;">
        <div class="modal-content" style="max-width: 450px; animation: zoomIn 0.3s;">
            <div class="modal-header" style="background: #1a73e8;">
                <h2 id="modalAlertaTitulo" style="font-size: 18px; margin: 0;">‚ÑπÔ∏è Informa√ß√£o</h2>
            </div>
            <div class="modal-body" id="modalAlertaMensagem" style="padding: 25px 20px; text-align: center; font-size: 15px; line-height: 1.6;">
                <!-- Mensagem ser√° inserida via JavaScript -->
            </div>
            <div class="modal-footer" style="justify-content: center; border-top: none; padding: 10px 20px 20px;">
                <button type="button" class="btn btn-primary" onclick="fecharModalAlerta()" style="min-width: 100px;">OK</button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o Padr√£o (Sim/N√£o) -->
    <div id="modalConfirmacao" class="modal" style="z-index: 10004;">
        <div class="modal-content" style="max-width: 450px; animation: slideDown 0.3s;">
            <div class="modal-header" style="background: #ffc107; color: #000;">
                <h2 id="modalConfirmacaoTitulo" style="font-size: 18px; margin: 0;">‚ö†Ô∏è Confirma√ß√£o</h2>
            </div>
            <div class="modal-body" id="modalConfirmacaoMensagem" style="padding: 25px 20px; text-align: center; font-size: 15px; line-height: 1.6;">
                <!-- Mensagem ser√° inserida via JavaScript -->
            </div>
            <div class="modal-footer" style="justify-content: center; gap: 15px; padding: 15px 20px;">
                <button class="btn btn-secondary" onclick="fecharModalConfirmacao(false)" style="min-width: 100px;">
                    N√£o
                </button>
                <button class="btn btn-primary" onclick="fecharModalConfirmacao(true)" style="min-width: 100px;">
                    Sim
                </button>
            </div>
        </div>
    </div>

    <!-- Tooltip para exibir ve√É¬≠culo -->
    <div id="tooltipVeiculo" class="tooltip-veiculo"></div>

    <!-- Spinner de carregamento -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner-container">
            <div class="spinner"></div>
            <div class="spinner-text">Carregando...</div>
        </div>
    </div>
    
    <!-- Spinner para verifica√ß√£o de v√≠nculos -->
    <div id="loadingVinculos" class="loading-overlay">
        <div class="spinner-container">
            <div class="spinner"></div>
            <div class="spinner-text">Verificando v√≠nculos...</div>
        </div>
    </div>

    <!-- Modal de Solicita√ß√£o de Loca√ß√£o por Email -->
    <div id="modalEmailFornecedor" class="modal" style="z-index: 10003;">
        <div class="modal-content" style="max-width: 1040px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <h2 style="font-size: 18px; margin: 0;">üìß Solicita√ß√£o de Loca√ß√£o por E-mail</h2>
                <!-- ===== GARANTIR QUE O X CHAMA A FUN√á√ÉO CORRETA ===== -->
                <span class="close" onclick="fecharModalEmailFornecedor()">&times;</span>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <form id="formEmailFornecedor">
                    <input type="hidden" id="email_id_demanda" value="">
                                            
                    <!-- Email do Destinat√°rio -->
                    <div class="form-group">
                        <label>Destinat√°rio <span class="required">*</span></label>
                        <input type="email" id="email_destinatario" required readonly 
                            style="background: #f8f9fa; font-weight: 600; color: #1a73e8;">
                    </div>

                    <!-- Campo oculto para IDITEM -->
                    <input type="hidden" id="email_iditem" value="">

                    <!-- Assunto -->
                    <div class="form-group">
                        <label>Assunto do E-mail <span class="required">*</span></label>
                        <input type="text" id="email_assunto" required maxlength="200">
                    </div>
                    
                    <!-- Editor de Texto Rico -->
                    <div class="form-group">
                        <label>Corpo do E-mail <span class="required">*</span></label>
                        
                        <!-- Barra de Ferramentas -->
                        <div id="email_toolbar" style="background: #f8f9fa; padding: 8px; border: 1px solid #ddd; border-bottom: none; border-radius: 4px 4px 0 0; display: flex; gap: 5px; align-items: center; flex-wrap: nowrap;">
                            <button type="button" onclick="formatarTexto('bold')" title="Negrito" style="padding: 5px 10px; border: 1px solid #ddd; background: white; cursor: pointer; border-radius: 3px;"><strong>B</strong></button>
                            <button type="button" onclick="formatarTexto('italic')" title="It√°lico" style="padding: 5px 10px; border: 1px solid #ddd; background: white; cursor: pointer; border-radius: 3px;"><em>I</em></button>
                            <button type="button" onclick="formatarTexto('underline')" title="Sublinhado" style="padding: 5px 10px; border: 1px solid #ddd; background: white; cursor: pointer; border-radius: 3px;"><u>U</u></button>
                            <div style="width: 1px; background: #ddd; margin: 0 5px;"></div>
                            <button type="button" onclick="formatarTexto('insertUnorderedList')" title="Lista" style="padding: 5px 10px; border: 1px solid #ddd; background: white; cursor: pointer; border-radius: 3px;">‚Ä¢ Lista</button>
                            <button type="button" onclick="formatarTexto('insertOrderedList')" title="Lista Numerada" style="padding: 5px 10px; border: 1px solid #ddd; background: white; cursor: pointer; border-radius: 3px;">1. Lista</button>
                            <div style="width: 1px; background: #ddd; margin: 0 5px;"></div>
                            <select onchange="formatarTexto('fontSize', this.value); this.selectedIndex=0;" style="padding: 5px; border: 1px solid #ddd; border-radius: 3px; width: auto;">
                                <option value="">Tamanho</option>
                                <option value="1">Pequeno</option>
                                <option value="3">Normal</option>
                                <option value="5">Grande</option>
                                <option value="7">Muito Grande</option>
                            </select>
                            <input type="color" onchange="formatarTexto('foreColor', this.value)" title="Cor do Texto" style="width: 40px; height: 32px; border: 1px solid #ddd; border-radius: 3px; cursor: pointer;">
                            <div style="width: 1px; background: #ddd; margin: 0 5px;"></div>
                            <button type="button" onclick="inserirTabela()" title="Inserir Tabela" style="padding: 5px 10px; border: 1px solid #ddd; background: white; cursor: pointer; border-radius: 3px;">üìä Tabela</button>
                        </div>
                        
                        <!-- √Årea Edit√°vel -->
                        <div id="email_corpo" contenteditable="true" 
                            style="min-height: 300px; max-height: 400px; overflow-y: auto; padding: 15px; border: 1px solid #ddd; border-radius: 0 0 4px 4px; background: white; font-family: Arial, sans-serif; font-size: 14px; line-height: 1.6;">
                        </div>
                    </div>
                    
                    <!-- Upload de Anexos -->
                    <div class="form-group">
                        <label>Anexos (Opcional)</label>
                        <input type="file" id="email_anexos" multiple 
                            accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.zip" 
                            style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 100%;">
                        <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">
                            Formatos aceitos: PDF, DOC, DOCX, XLS, XLSX, JPG, PNG, ZIP (m√°x. 10MB por arquivo)
                        </small>
                        <div id="lista_anexos" style="margin-top: 10px;"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="justify-content: flex-end; gap: 10px;">
                <button type="button" class="btn btn-secondary" onclick="fecharModalEmailFornecedor()">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="enviarEmailFornecedor()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
                    üìß Enviar E-mail
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Visualiza√ß√£o Compacta -->
    <div id="modalVisualizacao" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="tituloVisualizacao">Visualiza√ß√£o</h2>
                <span class="close" onclick="fecharModalVisualizacao()">&times;</span>
            </div>
            <div class="modal-body" id="conteudoVisualizacao">
                <!-- Conte√∫do ser√° inserido aqui -->
            </div>
            <div class="modal-view-footer">
                <button class="btn btn-secondary" onclick="fecharModalVisualizacao()">Fechar</button>
                <button class="btn-copiar-imagem" onclick="copiarComoImagem()">üìã Copiar como Imagem</button>
            </div>
        </div>
    </div>

    <!-- Scripts Bootstrap (ANTES dos seus scripts) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Verifica√ß√£o de autentica√ß√£o (se voc√™ tiver) -->
    <script src="/static/js/auth-check.js"></script>

    <!-- Carregador do menu -->
    <script src="/static/js/menu-loader.js"></script>

    <script>
        let semanas = [];
        let semanaAtual = 0;
        let dadosAgenda = null;
        let motoristas = [];
        let motoristasAdministrativo = [];
        let outrosMotoristas = [];        
        // let todosMotoristas = [];
        let veiculos = [];
        let veiculosExtras = [];
        let tiposDemanda = [];
        let tiposVeiculo = [];
        let veiculoSelecionadoOriginal = null;
        let celulaSelecionada = null;
        let locacoesAtivas = [];
        let contextoAbertura = null; // 'motorista', 'veiculo' ou null
        let feriadosPeriodo = [];
        let scrollPosition = 0;
        let listaVeiculosExpandida = false;
        let tooltipVeiculo = null; // Vari√°vel para controlar o tooltip
        // ========== VARI√ÅVEIS GLOBAIS PARA LOCA√á√ÉO ==========
        let dadosVinculoLocacao = null;
        let idDemandaParaLocacao = null;
        let callbackConfirmacaoLocacao = null;
        let callbackConfirmacaoPadrao = null; // Para o modal de confirma√ß√£o padr√£o
        let setorAutocompleteTimeout = null;
        let setorSelectedIndex = -1;
        let modoSelecaoIntervalo = false;
        let primeiraDataSelecionada = null;
        let segundaDataSelecionada = null;
        let linhaAtualSelecao = null;
        let celulasIntervalo = [];
        let tiposDemandaConfig = {}; // Armazenar configura√ß√µes completas dos tipos
        let cssClassesGeradas = false; // Controle para gerar CSS din√¢mico apenas uma vez
        // ========== VARI√ÅVEIS GLOBAIS PARA EMAIL FORNECEDOR ==========
        let dadosVinculoFornecedor = null;
        let idDemandaParaEmailFornecedor = null;
        let temVinculoFornecedorAtivo = false;
        let idItemLocacaoFornecedor = null;
        // ========== VARI√ÅVEIS GLOBAIS PARA DI√ÅRIAS DE MOTORISTA ==========
        let dadosVinculoDiarias = null;
        let idDemandaParaDiarias = null;
        let temVinculoDiariasAtivo = false;
        // ========== VARI√ÅVEIS GLOBAIS PARA CONTROLE DE FLUXO DE V√çNCULOS ==========
        let fluxoVinculosAtivo = false;
        let vinculosPendentes = {
            diarias: false,
            locacao: false
        };
        let dadosDemandaParaVinculos = null;
        let demandaIdVinculos = null;

        let ultimoCheckTimestamp = null;
        let intervaloVerificacao = null;
        let notificacaoAtiva = false;
        // Vari√°veis para controle do contador regressivo
        let countdownInterval = null;
        let countdownSeconds = 15;
        let countdownActive = false;

        // Controle de atualiza√ß√µes pr√≥prias vs. de outros usu√°rios
        let atualizacaoPropriaEmAndamento = false;
        let timestampUltimaAcaoLocal = null;

        // ========== FUN√á√ÉO: Verificar Fornecedor ao Selecionar Tipo de Ve√≠culo ==========
        async function verificarFornecedorTipoVeiculo(idTipoVeiculo) {
            if (!idTipoVeiculo) {
                temVinculoFornecedorAtivo = false;
                resetarCamposFornecedor();
                return;
            }
            
            try {
                const url = `/api/verificar_vinculo_fornecedor?id_tipoveiculo=${idTipoVeiculo}`;
                const response = await fetch(url);
                const resultado = await response.json();
                
                if (resultado.tem_vinculo && resultado.tipo === 'fornecedor') {
                    // TEM FORNECEDOR - Aplicar regras especiais
                    temVinculoFornecedorAtivo = true;
                    aplicarRegrasFornecedor();
                } else {
                    // N√ÉO TEM FORNECEDOR - Voltar ao normal
                    temVinculoFornecedorAtivo = false;
                    resetarCamposFornecedor();
                }
                
            } catch (error) {
                console.error('Erro ao verificar fornecedor:', error);
                temVinculoFornecedorAtivo = false;
            }
        }

        // ========== FUN√á√ÉO: Verificar se Motorista Terceirizado tem Fornecedor com Email ==========
        async function verificarVinculoDiarias(idTipoDemanda, idMotorista) {
            // Resetar
            temVinculoDiariasAtivo = false;
            dadosVinculoDiarias = null;
            
            // S√≥ verifica se for Tipo Demanda = 2 (Viagem) e tem motorista selecionado
            if (parseInt(idTipoDemanda) !== 2 || !idMotorista || parseInt(idMotorista) <= 0) {
                return;
            }
            
            try {
                const url = `/api/verificar_vinculo_diarias?id_motorista=${idMotorista}`;
                const response = await fetch(url);
                const resultado = await response.json();
                
                if (resultado.tem_vinculo) {
                    temVinculoDiariasAtivo = true;
                    dadosVinculoDiarias = resultado;
                }
                
            } catch (error) {
                console.error('Erro ao verificar v√≠nculo de di√°rias:', error);
                temVinculoDiariasAtivo = false;
            }
        }       
        
        // ========== FUN√á√ÉO: Calcular Di√°rias COM/SEM Pernoite ==========
        function calcularDiarias(dtInicio, dtFim) {
            const dataInicio = new Date(dtInicio + 'T00:00:00');
            const dataFim = new Date(dtFim + 'T00:00:00');
            
            if (dtInicio === dtFim) {
                // Mesmo dia = apenas SEM PERNOITE = 0.5 di√°ria
                return {
                    com_pernoite: 0,
                    sem_pernoite: 0.5,
                    total_diarias: 0.5
                };
            }
            
            // Calcular diferen√ßa em dias
            const diffTime = dataFim.getTime() - dataInicio.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
            
            // Total de dias - 1 = COM PERNOITE (1.0 cada)
            // √öltimo dia = SEM PERNOITE (0.5)
            const comPernoite = diffDays - 1;
            const semPernoite = 0.5;
            const totalDiarias = comPernoite + semPernoite;
            
            return {
                com_pernoite: comPernoite,
                sem_pernoite: semPernoite,
                total_diarias: totalDiarias
            };
        }

        // ========== FUN√á√ÉO: Formatar Per√≠odo para Assunto do Email ==========
        function formatarPeriodoAssunto(dtInicio, dtFim) {
            const dataInicio = new Date(dtInicio + 'T00:00:00');
            const dataFim = new Date(dtFim + 'T00:00:00');
            
            const diaIni = dataInicio.getDate().toString().padStart(2, '0');
            const mesIni = (dataInicio.getMonth() + 1).toString().padStart(2, '0');
            const anoIni = dataInicio.getFullYear();
            
            const diaFim = dataFim.getDate().toString().padStart(2, '0');
            const mesFim = (dataFim.getMonth() + 1).toString().padStart(2, '0');
            const anoFim = dataFim.getFullYear();
            
            if (dtInicio === dtFim) {
                // Mesmo dia
                return `dia ${diaIni}/${mesIni}/${anoIni}`;
            } else if (mesIni === mesFim && anoIni === anoFim) {
                // Mesmo m√™s/ano
                return `dias ${diaIni} a ${diaFim}/${mesFim}/${anoFim}`;
            } else {
                // Meses/anos diferentes
                return `dias ${diaIni}/${mesIni}/${anoIni} a ${diaFim}/${mesFim}/${anoFim}`;
            }
        }

        // ========== FUN√á√ÉO: Abrir Modal de Email para Di√°rias ==========
        async function abrirModalEmailDiarias(dadosDemanda) {
            try {
                // Calcular di√°rias
                const diarias = calcularDiarias(dadosDemanda.dt_inicio, dadosDemanda.dt_fim);
                
                // Formatar datas
                const dataInicio = new Date(dadosDemanda.dt_inicio + 'T00:00:00');
                const dataFim = new Date(dadosDemanda.dt_fim + 'T00:00:00');
                const dataInicioFormatada = dataInicio.toLocaleDateString('pt-BR');
                const dataFimFormatada = dataFim.toLocaleDateString('pt-BR');
                
                // Per√≠odo para assunto
                const periodoAssunto = formatarPeriodoAssunto(dadosDemanda.dt_inicio, dadosDemanda.dt_fim);
                
                // Buscar nome do motorista
                let nomeMotorista = dadosVinculoDiarias.nome_motorista || 'Motorista';
                
                // Preencher campos do modal
                document.getElementById('email_id_demanda').value = idDemandaParaDiarias || '';
                document.getElementById('email_destinatario').value = dadosVinculoDiarias.email_fornecedor;
        
                // ===== BUSCAR IDITEM DA DI√ÅRIA EXISTENTE =====
                let iditemDiaria = 0;
                try {
                    const resVerificarDiaria = await fetch(`/api/verificar_diaria_solicitada?id_ad=${idDemandaParaDiarias}`);
                    const resultDiaria = await resVerificarDiaria.json();
                    
                    if (resultDiaria.tem_diaria) {
                        iditemDiaria = resultDiaria.iditem;
                        document.getElementById('email_iditem').value = resultDiaria.iditem;
                        // console.log('IDITEM preenchido:', resultDiaria.iditem);
                    } else {
                        document.getElementById('email_iditem').value = '0';
                        console.warn('Nenhuma di√°ria encontrada para ID_AD:', idDemandaParaDiarias);
                    }
                } catch (error) {
                    console.error('Erro ao buscar IDITEM da di√°ria:', error);
                    document.getElementById('email_iditem').value = '0';
                }
                
                // ===== CORRE√á√ÉO: Assunto com formato correto =====
                const assunto = `TJRO - Solicita√ß√£o ${iditemDiaria} - Viagem motorista ${nomeMotorista} - ${periodoAssunto}`;
                document.getElementById('email_assunto').value = assunto;
                
                // ===== FORMATAR PER√çODO PARA EXIBI√á√ÉO =====
                let periodoExibicao;
                if (dadosDemanda.dt_inicio === dadosDemanda.dt_fim) {
                    // Apenas uma data
                    periodoExibicao = dataInicioFormatada;
                } else {
                    // Per√≠odo
                    periodoExibicao = `${dataInicioFormatada} a ${dataFimFormatada}`;
                }
                
                // ===== MONTAR TEXTO DAS DI√ÅRIAS LINHA POR LINHA =====
                let textosDiarias = [];
                
                if (diarias.com_pernoite > 0) {
                    const quantidadeExtenso = converterNumeroExtenso(diarias.com_pernoite);
                    const numeroFormatado = diarias.com_pernoite.toString().padStart(2, '0');
                    const plural = diarias.com_pernoite > 1 ? 's' : '';
                    textosDiarias.push(`${quantidadeExtenso} (${numeroFormatado}) di√°ria${plural} (COM PERNOITE)`);
                }
                
                textosDiarias.push('Uma (01) di√°ria (SEM PERNOITE)');
                
                // Juntar com <br>
                const diariasConcatenadas = textosDiarias.join('<br>');
                
                // ===== CORPO DO EMAIL =====
                const corpoHtml = `
        <p>Prezados(as),</p>
        
        <p>&nbsp;</p>
        
        <p>Informamos √† Vossa Senhoria que o funcion√°rio <strong>${nomeMotorista}</strong> foi designado para deslocamento conforme informa√ß√µes abaixo:</p>
        
        <p>&nbsp;</p>
        
        <table border="1" cellpadding="8" cellspacing="0" style="border-collapse: collapse; width: 100%; margin: 5px 0; border: 1px solid #000;">
            ${dadosDemanda.nu_sei ? `<tr>
                <td style="background: #f0f0f0; font-weight: bold; width: 20%; border: 1px solid #000;">Processo:</td>
                <td style="border: 1px solid #000;"> ${dadosDemanda.nu_sei}</td>
            </tr>` : ''}
            <tr>
                <td style="background: #f0f0f0; font-weight: bold; width: 20%; border: 1px solid #000;">Per√≠odo:</td>
                <td style="border: 1px solid #000;"> ${periodoExibicao}</td>
            </tr>
            <tr>
                <td style="background: #f0f0f0; font-weight: bold; border: 1px solid #000;">Di√°rias:</td>
                <td style="border: 1px solid #000;"> ${diariasConcatenadas}</td>
            </tr>
            ${dadosDemanda.destino ? `<tr>
                <td style="background: #f0f0f0; font-weight: bold; border: 1px solid #000;">Destino:</td>
                <td style="border: 1px solid #000;"> ${dadosDemanda.destino}</td>
            </tr>` : ''}
        </table>
        
        <p>&nbsp;</p>
        
        <p>Solicitamos observar o disposto no item 11.10 - Das Di√°rias, constante no Contrato 13/2025, bem como prazo para pagamento da di√°ria de no m√≠nimo 24 (vinte e quatro) horas antes da viagem.</p>
        
        <p>&nbsp;</p>
        
        <p><strong>Favor confirmar o recebimento do e-mail.</strong></p>
        
        <p>&nbsp;</p>
        
        <p>Atenciosamente,</p>
        
        <p>&nbsp;</p>
        
        <p><strong>${await obterNomeUsuario()}</strong><br>
        Tribunal de Justi√ßa do Estado de Rond√¥nia - TJRO<br>
        Se√ß√£o de Gest√£o Operacional do Transporte - SEGEOP<br>
        ‚òé (69) 3309-6229</p>
                `;
                
                document.getElementById('email_corpo').innerHTML = corpoHtml;
                
                // Limpar anexos
                document.getElementById('email_anexos').value = '';
                document.getElementById('lista_anexos').innerHTML = '';
                
                // Abrir modal
                document.getElementById('modalEmailFornecedor').style.display = 'block';
                
            } catch (error) {
                console.error('Erro ao abrir modal de di√°rias:', error);
                mostrarAlerta('Erro ao preparar e-mail de di√°rias!', '‚ùå Erro', '#dc3545');
            }
        }

        // ========== FUN√á√ÉO: Converter N√∫mero para Extenso (1-10) ==========
        function converterNumeroExtenso(numero) {
            const extenso = {
                1: 'Uma', 2: 'Duas', 3: 'Tr√™s', 4: 'Quatro', 5: 'Cinco',
                6: 'Seis', 7: 'Sete', 8: 'Oito', 9: 'Nove', 10: 'Dez'
            };
            
            return extenso[numero] || numero.toString();
        }

        function aplicarRegrasFornecedor() {
            // Hor√°rio obrigat√≥rio
            const checkboxHorario = document.getElementById('definirHorario');
            const inputHorario = document.getElementById('horario');
            const labelHorario = inputHorario.previousElementSibling;
            
            checkboxHorario.checked = true;
            checkboxHorario.disabled = true;
            inputHorario.disabled = false;
            inputHorario.required = true;
            labelHorario.textContent = 'Hor√°rio de Sa√≠da';
            labelHorario.innerHTML = 'Hor√°rio de Sa√≠da <span class="required">*</span>';
            
            // Bloquear Motorista
            const selectMotorista = document.getElementById('idMotorista');
            const motoristaFilter = document.getElementById('motoristaFilter');
            const labelMotorista = document.getElementById('labelMotorista');
            
            selectMotorista.value = '';
            selectMotorista.disabled = true;
            selectMotorista.required = false;
            motoristaFilter.style.display = 'none';
            labelMotorista.innerHTML = 'Motorista';
            
            // Bloquear Ve√≠culo
            const selectVeiculo = document.getElementById('idVeiculo');
            const labelVeiculo = document.getElementById('labelVeiculo');
            
            selectVeiculo.value = '';
            selectVeiculo.disabled = true;
            selectVeiculo.required = false;
            labelVeiculo.innerHTML = 'Ve√≠culo';
        }

        function resetarCamposFornecedor() {
            // Resetar Hor√°rio
            const checkboxHorario = document.getElementById('definirHorario');
            const inputHorario = document.getElementById('horario');
            const labelHorario = inputHorario.previousElementSibling;
            
            checkboxHorario.disabled = false;
            if (!checkboxHorario.checked) {
                inputHorario.disabled = true;
                inputHorario.required = false;
            }
            labelHorario.textContent = 'Hor√°rio';
            
            // Desbloquear Motorista (se n√£o houver outra regra bloqueando)
            const selectMotorista = document.getElementById('idMotorista');
            const motoristaFilter = document.getElementById('motoristaFilter');
            
            const idTipoDemanda = document.getElementById('idTipoDemanda').value;
            if (idTipoDemanda) {
                aplicarRegrasTipoDemanda(); // Reaplicar regras do tipo de demanda
            } else {
                selectMotorista.disabled = false;
                motoristaFilter.style.display = 'flex';
            }
        }
        
        
        // ========== FUN√á√ïES PARA MODAIS PADR√ÉO ==========

        // Modal de Alerta (OK)
        function mostrarAlerta(mensagem, titulo = '‚ÑπÔ∏è Informa√ß√£o', cor = '#1a73e8') {
            const modal = document.getElementById('modalAlerta');
            const modalTitulo = document.getElementById('modalAlertaTitulo');
            const modalMensagem = document.getElementById('modalAlertaMensagem');
            const modalHeader = modal.querySelector('.modal-header');
            
            modalTitulo.textContent = titulo;
            modalMensagem.innerHTML = mensagem;
            modalHeader.style.background = cor;
            
            modal.style.display = 'block';
        }

        function fecharModalAlerta() {
            document.getElementById('modalAlerta').style.display = 'none';
        }

        // Modal de Confirma√ß√£o (Sim/N√£o)
        function mostrarConfirmacao(mensagem, callback, titulo = '‚ö†Ô∏è Confirma√ß√£o') {
            
            esconderSpinnerVinculos();

            const modal = document.getElementById('modalConfirmacao');
            const modalTitulo = document.getElementById('modalConfirmacaoTitulo');
            const modalMensagem = document.getElementById('modalConfirmacaoMensagem');
            
            modalTitulo.textContent = titulo;
            modalMensagem.innerHTML = mensagem;
            
            callbackConfirmacaoPadrao = callback;
            modal.style.display = 'block';
        }

        function fecharModalConfirmacao(resposta) {
            document.getElementById('modalConfirmacao').style.display = 'none';
            
            if (callbackConfirmacaoPadrao) {
                callbackConfirmacaoPadrao(resposta);
                callbackConfirmacaoPadrao = null;
            }
        }

        // ========== FIM FUN√á√ïES MODAIS PADR√ÉO ==========

        // Fun√ß√µes para controlar o spinner
        function mostrarSpinner() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.classList.add('visible');
            }
        }
        
        function esconderSpinner() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.classList.remove('visible');
            }
        }
        
        // Fun√ß√µes para controlar o spinner de v√≠nculos
        function mostrarSpinnerVinculos() {
            const overlay = document.getElementById('loadingVinculos');
            if (overlay) {
                overlay.classList.add('visible');
            }
        }

        function esconderSpinnerVinculos() {
            const overlay = document.getElementById('loadingVinculos');
            if (overlay) {
                overlay.classList.remove('visible');
            }
        }

        // Fun√ß√£o para obter informa√ß√£o do ve√≠culo de uma demanda
        function obterVeiculoDemanda(idDemanda) {
            const demanda = dadosAgenda.demandas.find(d => d.id === idDemanda);
            if (!demanda) return null;
            
            // Se tem ID_VEICULO (ve√≠culo oficial)
            if (demanda.id_veiculo) {
                // Procurar nos ve√≠culos padr√£o
                let veiculo = veiculos.find(v => v.id === demanda.id_veiculo);
                
                // Se n√£o encontrou, procurar nos extras
                if (!veiculo) {
                    veiculo = veiculosExtras.find(v => v.id === demanda.id_veiculo);
                }
                
                return veiculo ? veiculo.veiculo : `Ve√≠culo ID ${demanda.id_veiculo}`;
            }
            
            // Se tem ID_TIPOVEICULO (ve√≠culo alocado)
            if (demanda.id_tipoveiculo && demanda.id_tipoveiculo !== 1) {
                return demanda.de_tipoveiculo || 'Ve√≠culo Alocado';
            }
            
            return null;
        }
        
        // Fun√ß√£o para mostrar tooltip
        function mostrarTooltipVeiculo(event, idDemanda) {
            const demanda = dadosAgenda.demandas.find(d => d.id === idDemanda);
            if (!demanda) return;
            
            const veiculo = obterVeiculoDemanda(idDemanda);
            
            if (!tooltipVeiculo) {
                tooltipVeiculo = document.getElementById('tooltipVeiculo');
            }
            
            // Formatar per√≠odo
            const dataInicio = new Date(demanda.dt_inicio + 'T00:00:00');
            const dataFim = new Date(demanda.dt_fim + 'T00:00:00');
            
            let periodoFormatado;
            if (demanda.dt_inicio === demanda.dt_fim) {
                // Data √∫nica
                periodoFormatado = `${dataInicio.getDate().toString().padStart(2, '0')}/${(dataInicio.getMonth() + 1).toString().padStart(2, '0')}/${dataInicio.getFullYear()}`;
            } else {
                // Per√≠odo
                periodoFormatado = `${dataInicio.getDate().toString().padStart(2, '0')}/${(dataInicio.getMonth() + 1).toString().padStart(2, '0')} a ${dataFim.getDate().toString().padStart(2, '0')}/${(dataFim.getMonth() + 1).toString().padStart(2, '0')}/${dataFim.getFullYear()}`;
            }
            
            // Montar conte√∫do do tooltip
            let conteudoHTML = '';
            
            // Adicionar ve√≠culo (se tiver)
            if (veiculo) {
                conteudoHTML += `üöó ${veiculo}<br>`;
            }
            
            // ‚úÖ SEMPRE adicionar per√≠odo
            conteudoHTML += `üìÖ ${periodoFormatado}`;
            
            // ‚úÖ ADICIONAR OBS se tiver
            if (demanda.obs && demanda.obs.trim() !== '') {
                conteudoHTML += `<br>üìù ${demanda.obs}`;
            }
            
            tooltipVeiculo.innerHTML = conteudoHTML;
            tooltipVeiculo.classList.add('visible');
            
            posicionarTooltip(event);
        }

        // Fun√ß√£o para mostrar tooltip apenas com per√≠odo (para ve√≠culos e alocados)
        function mostrarTooltipPeriodo(event, idDemanda) {
            const demanda = dadosAgenda.demandas.find(d => d.id === idDemanda);
            if (!demanda) return;
            
            if (!tooltipVeiculo) {
                tooltipVeiculo = document.getElementById('tooltipVeiculo');
            }
            
            // Formatar per√≠odo
            const dataInicio = new Date(demanda.dt_inicio + 'T00:00:00');
            const dataFim = new Date(demanda.dt_fim + 'T00:00:00');
            
            let periodoFormatado;
            if (demanda.dt_inicio === demanda.dt_fim) {
                // Data √∫nica
                periodoFormatado = `${dataInicio.getDate().toString().padStart(2, '0')}/${(dataInicio.getMonth() + 1).toString().padStart(2, '0')}/${dataInicio.getFullYear()}`;
            } else {
                // Per√≠odo
                periodoFormatado = `${dataInicio.getDate().toString().padStart(2, '0')}/${(dataInicio.getMonth() + 1).toString().padStart(2, '0')} a ${dataFim.getDate().toString().padStart(2, '0')}/${(dataFim.getMonth() + 1).toString().padStart(2, '0')}/${dataFim.getFullYear()}`;
            }
            
            // Montar conte√∫do
            let conteudoHTML = `üìÖ ${periodoFormatado}`;
            
            // Adicionar destino se tiver
            if (demanda.destino && demanda.destino.trim() !== '') {
                conteudoHTML += `<br>üìç ${demanda.destino}`;
            }
            
            // ‚úÖ ADICIONAR OBS se tiver
            if (demanda.obs && demanda.obs.trim() !== '') {
                conteudoHTML += `<br>üìù ${demanda.obs}`;
            }
            
            tooltipVeiculo.innerHTML = conteudoHTML;
            tooltipVeiculo.classList.add('visible');
            
            posicionarTooltip(event);
        }


        // function mostrarTooltipVeiculo(event, idDemanda) {
        //     const demanda = dadosAgenda.demandas.find(d => d.id === idDemanda);
        //     if (!demanda) return;
            
        //     const veiculo = obterVeiculoDemanda(idDemanda);
        //     if (!veiculo) return;
            
        //     if (!tooltipVeiculo) {
        //         tooltipVeiculo = document.getElementById('tooltipVeiculo');
        //     }
            
        //     // Formatar per√≠odo
        //     const dataInicio = new Date(demanda.dt_inicio + 'T00:00:00');
        //     const dataFim = new Date(demanda.dt_fim + 'T00:00:00');
            
        //     let periodoFormatado;
        //     if (demanda.dt_inicio === demanda.dt_fim) {
        //         // Data √∫nica
        //         periodoFormatado = `${dataInicio.getDate().toString().padStart(2, '0')}/${(dataInicio.getMonth() + 1).toString().padStart(2, '0')}/${dataInicio.getFullYear()}`;
        //     } else {
        //         // Per√≠odo
        //         periodoFormatado = `${dataInicio.getDate().toString().padStart(2, '0')}/${(dataInicio.getMonth() + 1).toString().padStart(2, '0')} a ${dataFim.getDate().toString().padStart(2, '0')}/${(dataFim.getMonth() + 1).toString().padStart(2, '0')}/${dataFim.getFullYear()}`;
        //     }
            
        //     // Duas linhas: ve√≠culo e per√≠odo
        //     tooltipVeiculo.innerHTML = `üöó ${veiculo}<br>${periodoFormatado}`;
        //     tooltipVeiculo.classList.add('visible');
            
        //     posicionarTooltip(event);
        // }
        
        // Fun√ß√£o para mostrar tooltip apenas com per√≠odo (para ve√≠culos e alocados)
        // function mostrarTooltipPeriodo(event, idDemanda) {
        //     const demanda = dadosAgenda.demandas.find(d => d.id === idDemanda);
        //     if (!demanda) return;
            
        //     if (!tooltipVeiculo) {
        //         tooltipVeiculo = document.getElementById('tooltipVeiculo');
        //     }
            
        //     // Formatar per√≠odo
        //     const dataInicio = new Date(demanda.dt_inicio + 'T00:00:00');
        //     const dataFim = new Date(demanda.dt_fim + 'T00:00:00');
        //     // const destino = new demanda.destino;
            
        //     let periodoFormatado;
        //     if (demanda.dt_inicio === demanda.dt_fim) {
        //         // Data √∫nica
        //         periodoFormatado = `${dataInicio.getDate().toString().padStart(2, '0')}/${(dataInicio.getMonth() + 1).toString().padStart(2, '0')}/${dataInicio.getFullYear()}`;
        //     } else {
        //         // Per√≠odo
        //         periodoFormatado = `${dataInicio.getDate().toString().padStart(2, '0')}/${(dataInicio.getMonth() + 1).toString().padStart(2, '0')} a ${dataFim.getDate().toString().padStart(2, '0')}/${(dataFim.getMonth() + 1).toString().padStart(2, '0')}/${dataFim.getFullYear()}`;
        //     }
            
        //     // Apenas o per√≠odo
        //     // tooltipVeiculo.innerHTML = periodoFormatado;
        //     tooltipVeiculo.innerHTML = `${periodoFormatado}<br>${demanda.destino}`;
            
        //     tooltipVeiculo.classList.add('visible');
            
        //     posicionarTooltip(event);
        // }        
        
        // Fun√ß√£o para posicionar tooltip com detec√ß√£o de limites
        function posicionarTooltip(event) {
            if (!tooltipVeiculo) return;
            
            const tooltip = tooltipVeiculo;
            const offsetX = 10; // Dist√¢ncia do cursor horizontalmente
            const offsetY = 20; // Dist√¢ncia do cursor verticalmente
            
            // Obter dimens√µes do tooltip
            const tooltipRect = tooltip.getBoundingClientRect();
            const tooltipWidth = tooltipRect.width;
            const tooltipHeight = tooltipRect.height;
            
            // Obter dimens√µes da viewport
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            
            // Posi√ß√£o inicial (abaixo e √† direita do cursor)
            let x = event.pageX + offsetX;
            let y = event.pageY + offsetY;
            
            // Verificar se ultrapassa a direita da p√°gina
            if (event.clientX + offsetX + tooltipWidth + 20 > viewportWidth) {
                // Posicionar √† esquerda do cursor
                x = event.pageX - tooltipWidth - offsetX;
            }
            
            // Verificar se ultrapassa o fundo da p√°gina
            if (event.clientY + offsetY + tooltipHeight > viewportHeight) {
                // Posicionar acima do cursor
                y = event.pageY - tooltipHeight - offsetY;
            }
            
            // Garantir que n√£o saia pela esquerda
            if (x < 0) {
                x = offsetX;
            }
            
            // Garantir que n√£o saia pelo topo
            if (y < window.pageYOffset) {
                y = window.pageYOffset + offsetY;
            }
            
            tooltip.style.left = x + 'px';
            tooltip.style.top = y + 'px';
        }
        
        // Fun√ß√£o para esconder tooltip
        function esconderTooltipVeiculo() {
            if (tooltipVeiculo) {
                tooltipVeiculo.classList.remove('visible');
            }
        }
        
        // M√°scara para o campo hor√°rio
        function aplicarMascaraHorario(input) {
            let valor = input.value.replace(/\D/g, '');
            
            if (valor.length >= 2) {
                valor = valor.substring(0, 2) + ':' + valor.substring(2, 4);
            }
            
            input.value = valor;
        }
        
        // Toggle do campo hor√°rio
        function toggleHorario() {
            const checkbox = document.getElementById('definirHorario');
            const inputHorario = document.getElementById('horario');
            
            if (checkbox.checked) {
                inputHorario.disabled = false;
                inputHorario.focus();
            } else {
                inputHorario.disabled = true;
                inputHorario.value = '';
            }
        }
        
        // Validar formato de hor√°rio
        function validarHorario(horario) {
            if (!horario) return true; // Vazio √© v√°lido
            
            const regex = /^([0-1][0-9]|2[0-3]):([0-5][0-9])$/;
            return regex.test(horario);
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // M√°scara de hor√°rio
            const inputHorario = document.getElementById('horario');
            if (inputHorario) {
                inputHorario.addEventListener('input', function() {
                    aplicarMascaraHorario(this);
                });
            }
            
            // Event listeners para datas (atualizar lista expandida)
            // ‚úÖ VALIDA√á√ÉO AUTOM√ÅTICA DE DATAS
            const dtInicio = document.getElementById('dtInicio');
            const dtFim = document.getElementById('dtFim');

            if (dtInicio && dtFim) {
                // Quando alterar Data In√≠cio
                dtInicio.addEventListener('change', function() {
                    const dataInicio = this.value;
                    const dataFim = dtFim.value;
                    
                    if (!dataFim) {
                        // Se Data Fim est√° vazia, preencher com mesma data
                        dtFim.value = dataInicio;
                    } else if (dataFim < dataInicio) {
                        // Se Data Fim for anterior, corrigir e alertar
                        dtFim.value = dataInicio;
                        mostrarAlerta(
                            '‚ö†Ô∏è <strong>Data Fim n√£o pode ser anterior √† Data In√≠cio!</strong><br><br>' +
                            'A Data Fim foi ajustada automaticamente para: <strong>' + 
                            new Date(dataInicio + 'T00:00:00').toLocaleDateString('pt-BR') + '</strong>',
                            '‚ö†Ô∏è Aten√ß√£o',
                            '#ffc107'
                        );
                    }
                    
                    // Atualizar lista de ve√≠culos se aplic√°vel
                    const expandirCheckbox = document.getElementById('expandirVeiculos');
                    const idTipoVeiculo = document.getElementById('idTipoVeiculo').value;
                    
                    if (idTipoVeiculo === '1' && expandirCheckbox.checked) {
                        toggleExpandirVeiculos();
                    }
                });
                
                // Quando alterar Data Fim
                dtFim.addEventListener('change', function() {
                    const dataInicio = dtInicio.value;
                    const dataFim = this.value;
                    
                    if (dataInicio && dataFim < dataInicio) {
                        // Se Data Fim for anterior, corrigir e alertar
                        this.value = dataInicio;
                        mostrarAlerta(
                            '‚ö†Ô∏è <strong>Data Fim n√£o pode ser anterior √† Data In√≠cio!</strong><br><br>' +
                            'A Data Fim foi ajustada automaticamente para: <strong>' + 
                            new Date(dataInicio + 'T00:00:00').toLocaleDateString('pt-BR') + '</strong>',
                            '‚ö†Ô∏è Aten√ß√£o',
                            '#ffc107'
                        );
                    }
                    
                    // Atualizar lista de ve√≠culos se aplic√°vel
                    const expandirCheckbox = document.getElementById('expandirVeiculos');
                    const idTipoVeiculo = document.getElementById('idTipoVeiculo').value;
                    
                    if (idTipoVeiculo === '1' && expandirCheckbox.checked) {
                        toggleExpandirVeiculos();
                    }
                });
            }

            // Event listener para exibir campo NC_MOTORISTA quando ID=0
            const selectMotorista = document.getElementById('idMotorista');
            if (selectMotorista) {
                selectMotorista.addEventListener('change', function() {
                    const divNcMotorista = document.getElementById('divNcMotorista');
                    const inputNcMotorista = document.getElementById('ncMotorista');
                    
                    if (this.value === '0') {
                        divNcMotorista.style.display = 'block';
                        inputNcMotorista.required = true;
                    } else {
                        divNcMotorista.style.display = 'none';
                        inputNcMotorista.required = false;
                        inputNcMotorista.value = '';
                    }
                });
            }

        });
        
        ////////////////////////////////////////////////////////////////////
        //////// LOCA√á√ÉO DE VEICULOS //////////////////////////////////////
        ///////////////////////////////////////////////////////////////////

        // ========== MODIFICAR FUN√á√ÉO: verificarESolicitarLocacao ==========
        async function verificarESolicitarLocacao(idDemanda, dadosDemanda) {
            try {
                // Verificar se tem os dados necess√°rios
                if (!dadosDemanda.id_tipoveiculo || !dadosDemanda.id_motorista) {
                    return; // N√£o faz nada
                }
                
                // Verificar se motorista √© cadastrado (> 0)
                if (parseInt(dadosDemanda.id_motorista) <= 0) {
                    return; // N√£o faz nada para motorista n√£o cadastrado
                }
                
                // Chamar API para verificar v√≠nculo
                const url = `/api/verificar_vinculo_locacao?id_tipoveiculo=${dadosDemanda.id_tipoveiculo}&id_motorista=${dadosDemanda.id_motorista}`;
                const res = await fetch(url);
                const resultado = await res.json();
                
                if (!resultado.tem_vinculo) {
                    return; // N√£o tem v√≠nculo, n√£o faz nada
                }
                
                // Guardar dados do v√≠nculo
                dadosVinculoLocacao = resultado;
                idDemandaParaLocacao = idDemanda;
                
                // ====== USAR MODAL PERSONALIZADO ======
                mostrarModalConfirmacaoLocacao(async function(resposta) {
                    if (resposta) {
                        // Usu√°rio clicou em "Sim, solicitar"
                        await abrirFormularioLocacao(dadosDemanda);
                    }
                    // Se clicar em "N√£o", n√£o faz nada
                });
                // ====== FIM DO USO DO MODAL ======
                
            } catch (error) {
                console.error('Erro ao verificar loca√ß√£o:', error);
            }
        }

        // ========== MODIFICAR FUN√á√ÉO: abrirFormularioLocacao ==========
        async function abrirFormularioLocacao(dadosDemanda) {
            try {
                // Preencher campos ocultos
                document.getElementById('loc_id_cl').value = dadosVinculoLocacao.id_cl;
                document.getElementById('loc_id_veiculo_loc').value = dadosVinculoLocacao.id_veiculo_loc;
                document.getElementById('loc_id_motorista').value = dadosDemanda.id_motorista;
                document.getElementById('loc_vl_diaria').value = dadosVinculoLocacao.vl_diaria_km;
                
                // Preencher empenhos
                const selectEmpenho = document.getElementById('loc_id_empenho');
                selectEmpenho.innerHTML = '<option value="">Selecione...</option>';
                
                dadosVinculoLocacao.empenhos.forEach(emp => {
                    selectEmpenho.innerHTML += `<option value="${emp.id}">${emp.numero}</option>`;
                });
                
                // Se houver apenas um empenho, selecionar automaticamente
                if (dadosVinculoLocacao.empenhos.length === 1) {
                    selectEmpenho.value = dadosVinculoLocacao.empenhos[0].id;
                }
                
                // ====== BUSCAR NOME DO MOTORISTA ======
                let nomeMotorista = 'N√£o identificado';
                
                // Procurar em motoristas SEGEOP
                let motoristaEncontrado = motoristas.find(m => m.id == dadosDemanda.id_motorista);
                
                // Se n√£o encontrou, procurar em outros motoristas
                if (!motoristaEncontrado && outrosMotoristas) {
                    motoristaEncontrado = outrosMotoristas.find(m => m.id == dadosDemanda.id_motorista);
                }
                
                // Se n√£o encontrou, procurar em todos_motoristas
                if (!motoristaEncontrado && dadosAgenda.todos_motoristas) {
                    motoristaEncontrado = dadosAgenda.todos_motoristas.find(m => m.id == dadosDemanda.id_motorista);
                }
                
                // Se encontrou, usar o nome
                if (motoristaEncontrado) {
                    nomeMotorista = motoristaEncontrado.nome;
                } else if (dadosDemanda.nm_motorista) {
                    // Se veio da demanda carregada
                    nomeMotorista = dadosDemanda.nm_motorista;
                }
                
                document.getElementById('loc_nome_motorista').value = nomeMotorista;
                document.getElementById('loc_tipo_veiculo').value = dadosVinculoLocacao.de_veiculo_loc;
                
                // ====== FIM DA BUSCA DO NOME ======
                
                // Preencher campos da demanda
                document.getElementById('loc_setor').value = dadosDemanda.setor || '';
                document.getElementById('loc_objetivo').value = dadosDemanda.destino || ''; // Objetivo baseado em destino
                document.getElementById('loc_nu_sei').value = dadosDemanda.nu_sei || '';
                document.getElementById('loc_dt_inicio').value = dadosDemanda.dt_inicio;
                document.getElementById('loc_dt_fim').value = dadosDemanda.dt_fim;
                
                // ====== PREENCHER HOR√ÅRIO - CORRIGIDO ======
                let horarioInicial = dadosDemanda.horario || '07:00';
                document.getElementById('loc_horario').value = horarioInicial;
                // ====== FIM CORRE√á√ÉO HOR√ÅRIO ======
                
                // Calcular di√°rias
                calcularDiariasLocacao();
                            
                // ====== MODIFICAR EXIBI√á√ÉO DO STATUS DA CNH ======
                const statusCNHDiscrete = document.getElementById('statusCNHDiscrete');
                const divUploadCNH = document.getElementById('loc_divUploadCNH');
                
                if (dadosVinculoLocacao.tem_cnh) {
                    statusCNHDiscrete.style.background = '#d4edda';
                    statusCNHDiscrete.style.color = '#155724';
                    statusCNHDiscrete.style.border = '1px solid #c3e6cb';
                    statusCNHDiscrete.innerHTML = '‚úì CNH anexada';
                    divUploadCNH.style.display = 'none';
                } else {
                    statusCNHDiscrete.style.background = '#f8d7da';
                    statusCNHDiscrete.style.color = '#721c24';
                    statusCNHDiscrete.style.border = '1px solid #f5c6cb';
                    statusCNHDiscrete.innerHTML = '‚ö† CNH n√£o anexada';
                    divUploadCNH.style.display = 'block';
                }
                // ====== FIM DA MODIFICA√á√ÉO ======
                
                // Contador de caracteres para observa√ß√µes
                document.getElementById('loc_obs').addEventListener('input', function() {
                    document.getElementById('loc_charCount').textContent = this.value.length;
                });
                
                // Abrir modal
                document.getElementById('modalFormLocacao').style.display = 'block';
                
            } catch (error) {
                console.error('Erro ao abrir formul√°rio de loca√ß√£o:', error);
                alert('Erro ao abrir formul√°rio de loca√ß√£o!');
            }
        }

        // ========== FUN√á√ÉO: Calcular Di√°rias e Valores ==========
        function calcularDiariasLocacao() {
            const dtInicio = document.getElementById('loc_dt_inicio').value;
            const dtFim = document.getElementById('loc_dt_fim').value;
            const vlDiaria = parseFloat(document.getElementById('loc_vl_diaria').value);
            
            if (!dtInicio || !dtFim || !vlDiaria) return;
            
            const dataInicio = new Date(dtInicio + 'T00:00:00');
            const dataFim = new Date(dtFim + 'T00:00:00');
            
            // Calcular quantidade de di√°rias
            let qtDiarias = 1; // Padr√£o
            
            if (dtInicio === dtFim) {
                qtDiarias = 1; // Mesmo dia = 1 di√°ria
            } else {
                const diffTime = dataFim.getTime() - dataInicio.getTime();
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                qtDiarias = diffDays > 0 ? diffDays : 1;
            }
            
            // Calcular valores
            const vlSubTotal = qtDiarias * vlDiaria;
            const vlTotal = vlSubTotal; // Por enquanto sem diferen√ßas
            
            // Preencher campos
            document.getElementById('loc_qt_diarias').value = qtDiarias;
            document.getElementById('loc_vl_diaria_display').value = vlDiaria.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('loc_vl_total').value = vlTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }

        // ========== FUN√á√ÉO: Fechar Modal de Loca√ß√£o ==========
        function fecharModalFormLocacao() {
            document.getElementById('modalFormLocacao').style.display = 'none';
            document.getElementById('formSolicitacaoLocacao').reset();
            dadosVinculoLocacao = null;
            idDemandaParaLocacao = null;
            
            // ====== VERIFICAR SE EST√Å NO FLUXO DE V√çNCULOS ======
            if (fluxoVinculosAtivo) {
                // Continuar processando pr√≥ximo v√≠nculo
                processarVinculosSequencial();
            }
        }

        // ========== FUN√á√ÉO: Fechar Modal de Sucesso ==========
        async function fecharModalSucessoLocacao() {    
            document.getElementById('modalSucessoLocacao').style.display = 'none';
            
            // ====== FECHAR TAMB√âM O MODAL DE LOCA√á√ÉO E DEMANDA ======
            fecharModalFormLocacao();
            fecharModal(); // Fecha o modal de demanda
            // ====== FIM ======
            
            // ====== VERIFICAR SE EST√Å NO FLUXO DE V√çNCULOS ======
            if (fluxoVinculosAtivo) {
                // Continuar processando pr√≥ximo v√≠nculo
                await processarVinculosSequencial();
            } else {
                // Fluxo normal - recarregar
                await carregarAgenda();
            }
        }

        // ========== FUN√á√ÉO CORRETA: confirmarSolicitacaoLocacao ==========
        async function confirmarSolicitacaoLocacao(event) {
            // Prevenir comportamento padr√£o
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            try {
                // Validar campos obrigat√≥rios
                const idEmpenho = document.getElementById('loc_id_empenho').value;
                const objetivo = document.getElementById('loc_objetivo').value.trim();
                const horario = document.getElementById('loc_horario').value;
                
                if (!idEmpenho) {
                    mostrarAlerta('Selecione um empenho!', '‚ö†Ô∏è Aten√ß√£o', '#ffc107');
                    return;
                }
                
                if (!objetivo) {
                    mostrarAlerta('Preencha o objetivo da loca√ß√£o!', '‚ö†Ô∏è Aten√ß√£o', '#ffc107');
                    return;
                }
                
                // Validar hor√°rio obrigat√≥rio
                if (!horario) {
                    mostrarAlerta('Informe o hor√°rio de in√≠cio da loca√ß√£o!', '‚ö†Ô∏è Aten√ß√£o', '#ffc107');
                    document.getElementById('loc_horario').focus();
                    return;
                }
                
                // Se n√£o tem CNH, verificar se arquivo foi anexado
                if (!dadosVinculoLocacao.tem_cnh) {
                    const arquivoCNH = document.getElementById('loc_arquivo_cnh').files[0];
                    if (!arquivoCNH) {
                        mostrarAlerta('√â necess√°rio anexar a CNH do motorista para prosseguir!', '‚ö†Ô∏è Aten√ß√£o', '#ffc107');
                        return;
                    }
                    
                    // Validar se √© PDF
                    if (arquivoCNH.type !== 'application/pdf') {
                        mostrarAlerta('O arquivo deve ser um PDF!', '‚ö†Ô∏è Aten√ß√£o', '#ffc107');
                        return;
                    }
                }
                
                // Preparar dados para envio
                const formData = new FormData();
                
                // Dados principais
                formData.append('id_cl', document.getElementById('loc_id_cl').value);
                formData.append('empenho', idEmpenho);
                formData.append('setor_solicitante', document.getElementById('loc_setor').value);
                formData.append('objetivo', objetivo);
                formData.append('id_veiculo_loc', document.getElementById('loc_id_veiculo_loc').value);
                formData.append('id_motorista', document.getElementById('loc_id_motorista').value);
                formData.append('data_inicio', document.getElementById('loc_dt_inicio').value);
                formData.append('data_fim', document.getElementById('loc_dt_fim').value);
                formData.append('hora_inicio', horario);
                formData.append('qt_diaria_km', document.getElementById('loc_qt_diarias').value);
                
                // Valores
                const vlDiaria = document.getElementById('loc_vl_diaria').value;
                const vlTotal = document.getElementById('loc_vl_total').value.replace(/\./g, '').replace(',', '.');
                
                formData.append('vl_dk', vlDiaria);
                formData.append('vl_totalitem', vlTotal);
                formData.append('nu_sei', document.getElementById('loc_nu_sei').value);
                formData.append('obs', document.getElementById('loc_obs').value);
                
                // Anexar CNH se necess√°rio
                if (!dadosVinculoLocacao.tem_cnh) {
                    const arquivoCNH = document.getElementById('loc_arquivo_cnh').files[0];
                    formData.append('file_cnh', arquivoCNH);
                }
                
                // Mostrar spinner de carregamento
                mostrarSpinner();
                
                // Enviar para API
                const response = await fetch('/api/nova_locacao', {
                    method: 'POST',
                    body: formData
                });
                
                const resultado = await response.json();
                
                esconderSpinner();
                
                if (response.ok && resultado) {
                    // Construir mensagem
                    let mensagemHTML = '<div style="font-size: 16px; font-weight: 600; color: #28a745; margin-bottom: 10px;">Loca√ß√£o solicitada com sucesso!</div>';
                    
                    if (resultado.email_enviado) {
                        mensagemHTML += '<div style="font-size: 14px; color: #666;">üìß E-mail de notifica√ß√£o enviado.</div>';
                    } else if (resultado.erro_email) {
                        mensagemHTML += '<div style="font-size: 13px; color: #856404; background: #fff3cd; padding: 8px; border-radius: 4px; margin-top: 10px;">‚ö†Ô∏è A loca√ß√£o foi registrada, mas houve erro ao enviar e-mail.</div>';
                    }
                    
                    // Mostrar modal de sucesso
                    document.getElementById('mensagemSucessoLocacao').innerHTML = mensagemHTML;
                    document.getElementById('modalSucessoLocacao').style.display = 'block';
                    
                    // ====== FECHAR AMBOS OS MODAIS ======
                    fecharModalFormLocacao();
                    fecharModal(); // Fecha tamb√©m o modal de demanda
                    // ====== FIM ======
                } else {
                    // Erro
                    const mensagemErro = resultado.mensagem || resultado.erro || 'Erro ao solicitar loca√ß√£o';
                    mostrarAlerta('Erro: ' + mensagemErro, '‚ùå Erro', '#dc3545');
                }
                
            } catch (error) {
                esconderSpinner();
                console.error('Erro ao confirmar solicita√ß√£o:', error);
                mostrarAlerta('Erro ao solicitar loca√ß√£o: ' + error.message, '‚ùå Erro', '#dc3545');
            }
        }

        // ========== FUN√á√ÉO: Verificar Bot√£o Loca√ß√£o OU Fornecedor na Edi√ß√£o ==========
        async function verificarBotaoLocacaoEdicao(idAd) {
            try {
                const demanda = dadosAgenda.demandas.find(d => d.id === idAd);
                if (!demanda) return;
                
                const modalFooter = document.querySelector('#modal .modal-footer');
                
                // Remover elementos anteriores se existirem
                const elementoExistente = document.getElementById('areaLocacaoStatus');
                if (elementoExistente) {
                    elementoExistente.remove();
                }
                
                let divStatus = null;
                
                // ========== 1¬∫: VERIFICAR LOCA√á√ÉO (Motorista + Tipo Ve√≠culo) ==========
                if (demanda.id_tipoveiculo && demanda.id_motorista && parseInt(demanda.id_motorista) > 0) {
                    const urlVinculo = `/api/verificar_vinculo_locacao?id_tipoveiculo=${demanda.id_tipoveiculo}&id_motorista=${demanda.id_motorista}`;
                    const resVinculo = await fetch(urlVinculo);
                    const resultVinculo = await resVinculo.json();
                    
                    if (resultVinculo.tem_vinculo) {
                        // Tem v√≠nculo de loca√ß√£o - verificar se j√° foi solicitada
                        const temLocacao = locacoesAtivas.some(loc => 
                            loc.id_motorista === demanda.id_motorista &&
                            loc.data_inicio <= demanda.dt_fim &&
                            loc.data_fim >= demanda.dt_inicio
                        );
                        
                        divStatus = document.createElement('div');
                        divStatus.id = 'areaLocacaoStatus';
                        divStatus.style.cssText = 'flex: 1; display: flex; align-items: center; gap: 10px;';
                        
                        if (temLocacao) {
                            // ‚úÖ J√° tem loca√ß√£o
                            divStatus.innerHTML = `
                                <div style="background: #d4edda; color: #155724; padding: 8px 12px; border-radius: 4px; font-size: 13px; font-weight: 600; border: 1px solid #c3e6cb;">
                                    ‚úì Loca√ß√£o solicitada
                                </div>
                            `;
                        } else {
                            // ‚ö†Ô∏è N√£o tem loca√ß√£o - mostrar bot√£o
                            divStatus.innerHTML = `
                                <button type="button" class="btn btn-primary" id="btnSolicitarLocacaoEdicao" style="background: #28a745; border-color: #28a745;">
                                    üöó Solicitar Loca√ß√£o
                                </button>
                            `;
                            
                            dadosVinculoLocacao = resultVinculo;
                            
                            setTimeout(() => {
                                const btnSolicitar = document.getElementById('btnSolicitarLocacaoEdicao');
                                if (btnSolicitar) {
                                    btnSolicitar.addEventListener('click', async function(e) {
                                        e.preventDefault();
                                        e.stopPropagation();
                                        await abrirFormularioLocacao(demanda);
                                    });
                                }
                            }, 100);
                        }
                        
                        const btnCancelar = modalFooter.querySelector('.btn-secondary');
                        if (btnCancelar) {
                            modalFooter.insertBefore(divStatus, btnCancelar);
                        }
                        
                        return; // ‚úÖ J√° processou loca√ß√£o, n√£o precisa verificar fornecedor
                    }
                }
                
                // ========== 2¬∫: VERIFICAR FORNECEDOR (se n√£o tem loca√ß√£o) ==========
                if (demanda.id_tipoveiculo) {
                    const urlFornecedor = `/api/verificar_vinculo_fornecedor?id_tipoveiculo=${demanda.id_tipoveiculo}`;
                    const resFornecedor = await fetch(urlFornecedor);
                    const resultFornecedor = await resFornecedor.json();
                    
                    if (resultFornecedor.tem_vinculo) {
                        // Tem v√≠nculo com fornecedor - verificar se e-mail foi enviado
                        const urlEmailEnviado = `/api/verificar_email_fornecedor_enviado?id_ad=${idAd}`;
                        const resEmailEnviado = await fetch(urlEmailEnviado);
                        const resultEmail = await resEmailEnviado.json();
                        
                        divStatus = document.createElement('div');
                        divStatus.id = 'areaLocacaoStatus';
                        divStatus.style.cssText = 'flex: 1; display: flex; align-items: center; gap: 10px;';
                        
                        if (resultEmail.email_enviado) {
                            // ‚úÖ E-mail j√° foi enviado
                            divStatus.innerHTML = `
                                <div style="background: #d4edda; color: #155724; padding: 8px 12px; border-radius: 4px; font-size: 13px; font-weight: 600; border: 1px solid #c3e6cb;">
                                    ‚úì Loca√ß√£o solicitada
                                </div>
                            `;
                        } else {
                            // ‚ö†Ô∏è E-mail ainda n√£o foi enviado - mostrar bot√£o
                            divStatus.innerHTML = `
                                <button type="button" class="btn btn-primary" id="btnSolicitarLocacaoFornecedor" style="background: #28a745; border-color: #28a745;">
                                    üìß Solicitar Loca√ß√£o
                                </button>
                            `;
                            
                            dadosVinculoFornecedor = resultFornecedor;
                            idDemandaParaEmailFornecedor = idAd;
                            
                            setTimeout(() => {
                                const btnSolicitar = document.getElementById('btnSolicitarLocacaoFornecedor');
                                if (btnSolicitar) {
                                    btnSolicitar.addEventListener('click', async function(e) {
                                        e.preventDefault();
                                        e.stopPropagation();
                                        
                                        // Criar registro de loca√ß√£o e abrir modal de e-mail
                                        mostrarSpinner();
                                        
                                        try {
                                            const resLocacao = await fetch('/api/criar_locacao_fornecedor', {
                                                method: 'POST',
                                                headers: { 'Content-Type': 'application/json' },
                                                body: JSON.stringify({ id_demanda: idAd })
                                            });
                                            
                                            const resultLocacao = await resLocacao.json();
                                            
                                            esconderSpinner();
                                            
                                            if (resultLocacao.success && resultLocacao.id_item) {
                                                idItemLocacaoFornecedor = resultLocacao.id_item;
                                                await abrirModalEmailFornecedor(demanda);
                                            } else {
                                                mostrarAlerta(
                                                    'Erro ao criar registro de loca√ß√£o.<br><br>Erro: ' + (resultLocacao.erro || 'Desconhecido'),
                                                    '‚ö†Ô∏è Erro',
                                                    '#dc3545'
                                                );
                                            }
                                        } catch (error) {
                                            esconderSpinner();
                                            console.error('Erro ao criar loca√ß√£o:', error);
                                            mostrarAlerta('Erro ao criar registro de loca√ß√£o.', '‚ùå Erro', '#dc3545');
                                        }
                                    });
                                }
                            }, 100);
                        }
                        
                        const btnCancelar = modalFooter.querySelector('.btn-secondary');
                        if (btnCancelar) {
                            modalFooter.insertBefore(divStatus, btnCancelar);
                        }
                    }
                }
                
            } catch (error) {
                console.error('Erro ao verificar bot√£o de loca√ß√£o:', error);
            }
        }

        // ========== FUN√á√ÉO: Verificar e Exibir Bot√£o/Status de Di√°ria na Edi√ß√£o ==========
        async function verificarBotaoDiariaEdicao(idAd) {
            try {
                const demanda = dadosAgenda.demandas.find(d => d.id === idAd);
                if (!demanda) return;
                
                // Verificar se √© tipo viagem (ID=2) e tem motorista
                if (demanda.id_tipodemanda !== 2 || !demanda.id_motorista || parseInt(demanda.id_motorista) <= 0) {
                    return;
                }
                
                // Verificar se tem v√≠nculo de di√°rias
                const urlVinculo = `/api/verificar_vinculo_diarias?id_motorista=${demanda.id_motorista}`;
                const resVinculo = await fetch(urlVinculo);
                const resultVinculo = await resVinculo.json();
                
                if (!resultVinculo.tem_vinculo) {
                    return;
                }
                
                // Verificar se j√° tem registro de di√°ria salvo
                const urlDiaria = `/api/verificar_diaria_solicitada?id_ad=${idAd}`;
                const resDiaria = await fetch(urlDiaria);
                const resultDiaria = await resDiaria.json();
                
                const modalFooter = document.querySelector('#modal .modal-footer');
                
                // Remover elementos anteriores se existirem
                const elementoExistente = document.getElementById('areaDiariaStatus');
                if (elementoExistente) {
                    elementoExistente.remove();
                }
                
                // Criar novo elemento
                const divStatus = document.createElement('div');
                divStatus.id = 'areaDiariaStatus';
                divStatus.style.cssText = 'flex: 1; display: flex; align-items: center; gap: 10px;';
                
                if (resultDiaria.tem_diaria && resultDiaria.email_enviado) {
                    // ===== J√Å TEM DI√ÅRIA E EMAIL ENVIADO =====
                    divStatus.innerHTML = `
                        <div style="background: #d4edda; color: #155724; padding: 8px 12px; border-radius: 4px; font-size: 13px; font-weight: 600; border: 1px solid #c3e6cb;">
                            ‚úÖ Di√°ria solicitada
                        </div>
                    `;
                    
                } else if (resultDiaria.tem_diaria && !resultDiaria.email_enviado) {
                    // ===== TEM DI√ÅRIA MAS EMAIL N√ÉO ENVIADO =====
                    divStatus.innerHTML = `
                        <button type="button" class="btn btn-primary" id="btnSolicitarDiariaEdicao" style="background: #17a2b8; border-color: #17a2b8;">
                            ‚úàÔ∏è Solicitar Di√°ria
                        </button>
                    `;
                    
                    // Guardar dados do v√≠nculo
                    dadosVinculoDiarias = resultVinculo;
                    idDemandaParaDiarias = idAd;
                    
                    // Event listener no bot√£o
                    setTimeout(() => {
                        const btnSolicitar = document.getElementById('btnSolicitarDiariaEdicao');
                        if (btnSolicitar) {
                            btnSolicitar.addEventListener('click', async function(e) {
                                e.preventDefault();
                                e.stopPropagation();
                                
                                // CORRE√á√ÉO: Preencher IDITEM corretamente
                                if (resultDiaria.tem_diaria) {
                                    document.getElementById('email_iditem').value = resultDiaria.iditem;
                                } else if (resultSalvar && resultSalvar.iditem) {
                                    document.getElementById('email_iditem').value = resultSalvar.iditem;
                                } else {
                                    document.getElementById('email_iditem').value = '0';
                                }
                                
                                await abrirModalEmailDiarias(demanda);
                            });
                        }
                    }, 100);
                    
                } else {
                    // ===== N√ÉO TEM DI√ÅRIA SALVA - CRIAR E MOSTRAR BOT√ÉO =====
                    
                    app.logger.warning('Di√°ria n√£o encontrada para demanda que deveria ter v√≠nculo');

                }
                
                // Inserir antes dos bot√µes de a√ß√£o
                const btnCancelar = modalFooter.querySelector('.btn-secondary');
                if (btnCancelar) {
                    modalFooter.insertBefore(divStatus, btnCancelar);
                }
                
            } catch (error) {
                console.error('Erro ao verificar bot√£o de di√°ria:', error);
            }
        }       
        
        
        // ========== FUN√á√ÉO: Mostrar Modal de Confirma√ß√£o Personalizado ==========
        function mostrarModalConfirmacaoLocacao(callback) {
            
            esconderSpinnerVinculos();
            
            callbackConfirmacaoLocacao = callback;
            document.getElementById('modalConfirmacaoLocacao').style.display = 'block';
        }

        // ========== FUN√á√ÉO: Fechar Modal de Confirma√ß√£o ==========
        function fecharModalConfirmacaoLocacao(resposta) {
            document.getElementById('modalConfirmacaoLocacao').style.display = 'none';
            
            if (callbackConfirmacaoLocacao) {
                callbackConfirmacaoLocacao(resposta);
                callbackConfirmacaoLocacao = null;
            }
        }


        ///////////////////////////////////////////////////////////////////
        ///////// FIM LOCA√á√ïES DE VE√çCULOS ////////////////////////////////
        ///////////////////////////////////////////////////////////////////

        // ========== AUTOCOMPLETE SETOR ==========

        async function buscarSetores(termo) {
            if (termo.length < 2) {
                esconderAutocompleteSetor();
                return;
            }
            
            try {
                const res = await fetch(`/api/agenda_busca_setor?termo=${encodeURIComponent(termo)}`);
                const setores = await res.json();
                
                if (setores.length > 0) {
                    exibirAutocompleteSetor(setores, termo);
                } else {
                    esconderAutocompleteSetor();
                }
            } catch (error) {
                console.error('Erro ao buscar setores:', error);
                esconderAutocompleteSetor();
            }
        }

        function exibirAutocompleteSetor(setores, termo) {
            const lista = document.getElementById('setorAutocompleteList');
            const termoLower = termo.toLowerCase();
            
            lista.innerHTML = setores.map((setor, index) => {
                // Destacar o termo buscado
                const indexTermo = setor.toLowerCase().indexOf(termoLower);
                let setorHTML = setor;
                
                if (indexTermo !== -1) {
                    const antes = setor.substring(0, indexTermo);
                    const match = setor.substring(indexTermo, indexTermo + termo.length);
                    const depois = setor.substring(indexTermo + termo.length);
                    setorHTML = `${antes}<span class="autocomplete-item-highlight">${match}</span>${depois}`;
                }
                
                return `<div class="autocomplete-item" data-index="${index}" data-value="${setor}">${setorHTML}</div>`;
            }).join('');
            
            lista.classList.add('visible');
            setorSelectedIndex = -1;
            
            // Adicionar eventos de clique nos itens
            lista.querySelectorAll('.autocomplete-item').forEach(item => {
                item.addEventListener('click', function() {
                    selecionarSetor(this.dataset.value);
                });
                
                item.addEventListener('mouseenter', function() {
                    removerSelecaoAutocomplete();
                    this.classList.add('selected');
                    setorSelectedIndex = parseInt(this.dataset.index);
                });
            });
        }

        function esconderAutocompleteSetor() {
            const lista = document.getElementById('setorAutocompleteList');
            lista.classList.remove('visible');
            lista.innerHTML = '';
            setorSelectedIndex = -1;
        }

        function selecionarSetor(valor) {
            document.getElementById('setor').value = valor;
            esconderAutocompleteSetor();
        }

        function removerSelecaoAutocomplete() {
            const lista = document.getElementById('setorAutocompleteList');
            lista.querySelectorAll('.autocomplete-item').forEach(item => {
                item.classList.remove('selected');
            });
        }

        function navegarAutocompleteSetor(direcao) {
            const lista = document.getElementById('setorAutocompleteList');
            const itens = lista.querySelectorAll('.autocomplete-item');
            
            if (itens.length === 0) return;
            
            removerSelecaoAutocomplete();
            
            if (direcao === 'down') {
                setorSelectedIndex = (setorSelectedIndex + 1) % itens.length;
            } else if (direcao === 'up') {
                setorSelectedIndex = setorSelectedIndex <= 0 ? itens.length - 1 : setorSelectedIndex - 1;
            }
            
            if (setorSelectedIndex >= 0 && setorSelectedIndex < itens.length) {
                itens[setorSelectedIndex].classList.add('selected');
                itens[setorSelectedIndex].scrollIntoView({ block: 'nearest' });
            }
        }

        function initAutocompleteSetor() {
            const inputSetor = document.getElementById('setor');
            
            if (!inputSetor) return;
            
            // Evento de digita√ß√£o
            inputSetor.addEventListener('input', function() {
                const termo = this.value.trim();
                
                // Debounce para evitar muitas requisi√ß√µes
                if (setorAutocompleteTimeout) {
                    clearTimeout(setorAutocompleteTimeout);
                }
                
                setorAutocompleteTimeout = setTimeout(() => {
                    buscarSetores(termo);
                }, 300);
            });
            
            // Navega√ß√£o com teclado
            inputSetor.addEventListener('keydown', function(e) {
                const lista = document.getElementById('setorAutocompleteList');
                
                if (!lista.classList.contains('visible')) return;
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    navegarAutocompleteSetor('down');
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    navegarAutocompleteSetor('up');
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    const itens = lista.querySelectorAll('.autocomplete-item');
                    if (setorSelectedIndex >= 0 && setorSelectedIndex < itens.length) {
                        selecionarSetor(itens[setorSelectedIndex].dataset.value);
                    }
                } else if (e.key === 'Escape') {
                    esconderAutocompleteSetor();
                }
            });
            
            // Esconder ao perder foco (com delay para permitir clique)
            inputSetor.addEventListener('blur', function() {
                setTimeout(() => {
                    esconderAutocompleteSetor();
                }, 200);
            });
            
            // Mostrar novamente ao focar se tiver texto
            inputSetor.addEventListener('focus', function() {
                const termo = this.value.trim();
                if (termo.length >= 2) {
                    buscarSetores(termo);
                }
            });
        }

        // ========== FIM AUTOCOMPLETE SETOR ==========

        // Fun√ß√£o para adicionar destaque nas c√©lulas N. e Nome ao passar mouse
        function inicializarDestaqueLinha() {
            // Aguardar a renderiza√ß√£o completa
            setTimeout(() => {
                // Selecionar todas as linhas de todas as tabelas
                const todasLinhas = document.querySelectorAll('.agenda-table tbody tr');
                
                todasLinhas.forEach(linha => {
                    // Pegar as c√©lulas N. e Nome desta linha
                    const celulaNome = linha.querySelector('.col-nome');
                    const celulaNumero = linha.querySelector('.col-numero');
                    
                    if (!celulaNome && !celulaNumero) return;
                    
                    // Adicionar evento em todas as c√©lulas da linha
                    const celulas = linha.querySelectorAll('td');
                    
                    celulas.forEach(celula => {
                        // Mouseenter - adicionar destaque
                        celula.addEventListener('mouseenter', function() {
                            if (celulaNumero) {
                                celulaNumero.classList.add('row-hover');
                            }
                            if (celulaNome) {
                                celulaNome.classList.add('row-hover');
                            }
                        });
                        
                        // Mouseleave - remover destaque
                        celula.addEventListener('mouseleave', function() {
                            if (celulaNumero) {
                                celulaNumero.classList.remove('row-hover');
                            }
                            if (celulaNome) {
                                celulaNome.classList.remove('row-hover');
                            }
                        });
                    });
                });
            }, 500);
        }
        
        function limparSelecaoIntervalo() {
            modoSelecaoIntervalo = false;
            primeiraDataSelecionada = null;
            segundaDataSelecionada = null;
            linhaAtualSelecao = null;
            
            // Remover marca√ß√£o visual de todas as c√©lulas
            celulasIntervalo.forEach(celula => {
                celula.classList.remove('cell-intervalo-selecionado');
            });
            celulasIntervalo = [];
            
            document.body.classList.remove('modo-selecao-ativo');
        }

        function marcarIntervaloCelulas(linha, dtInicio, dtFim) {
            const celulas = linha.querySelectorAll('td.col-dia.empty-cell');
            
            celulas.forEach(celula => {
                // Verificar se a c√©lula tem onclick que cont√©m uma data
                const onclickAttr = celula.getAttribute('onclick');
                if (!onclickAttr) return;
                
                // Extrair data do onclick (ex: "handleClickCelulaVazia(event, '2025-01-15', ...")
                const matchData = onclickAttr.match(/'(\d{4}-\d{2}-\d{2})'/);
                if (!matchData) return;
                
                const dataCell = matchData[1];
                const dataCellObj = new Date(dataCell + 'T00:00:00');
                const dataInicioObj = new Date(dtInicio + 'T00:00:00');
                const dataFimObj = new Date(dtFim + 'T00:00:00');
                
                // Se a data est√° no intervalo, marcar
                if (dataCellObj >= dataInicioObj && dataCellObj <= dataFimObj) {
                    celula.classList.add('cell-intervalo-selecionado');
                    celulasIntervalo.push(celula);
                }
            });
        }

        // Detectar quando Ctrl √© pressionado
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Control' && !modoSelecaoIntervalo) {
                modoSelecaoIntervalo = true;
                // Adicionar classe apenas no body (CSS j√° controla quais se√ß√µes recebem o cursor)
                document.body.classList.add('modo-selecao-ativo');
            }
        });

        // Detectar quando Ctrl √© solto
        document.addEventListener('keyup', function(event) {
            if (event.key === 'Control' && modoSelecaoIntervalo) {
                limparSelecaoIntervalo();
            }
        });

        // Limpar sele√ß√£o ao sair da p√°gina
        window.addEventListener('blur', function() {
            if (modoSelecaoIntervalo) {
                limparSelecaoIntervalo();
            }
        });

        // ========== FUN√á√ïES DO EDITOR DE TEXTO ==========
        function formatarTexto(comando, valor = null) {
            document.getElementById('email_corpo').focus();
            if (valor) {
                document.execCommand(comando, false, valor);
            } else {
                document.execCommand(comando, false, null);
            }
        }

        function inserirTabela() {
            const linhas = prompt('N√∫mero de linhas:', '3');
            const colunas = prompt('N√∫mero de colunas:', '3');
            
            if (linhas && colunas) {
                let tabelaHtml = '<table border="1" cellpadding="5" cellspacing="0" style="border-collapse: collapse; width: 100%; margin: 10px 0;">';
                
                for (let i = 0; i < parseInt(linhas); i++) {
                    tabelaHtml += '<tr>';
                    for (let j = 0; j < parseInt(colunas); j++) {
                        tabelaHtml += '<td style="border: 1px solid #ddd; padding: 8px;">&nbsp;</td>';
                    }
                    tabelaHtml += '</tr>';
                }
                
                tabelaHtml += '</table><p><br></p>';
                
                document.execCommand('insertHTML', false, tabelaHtml);
            }
        }

        // Atualizar lista de anexos
        document.addEventListener('DOMContentLoaded', function() {
            const inputAnexos = document.getElementById('email_anexos');
            if (inputAnexos) {
                inputAnexos.addEventListener('change', function() {
                    const listaAnexos = document.getElementById('lista_anexos');
                    listaAnexos.innerHTML = '';
                    
                    if (this.files.length > 0) {
                        listaAnexos.innerHTML = '<div style="margin-top: 10px;"><strong>Arquivos selecionados:</strong></div>';
                        
                        Array.from(this.files).forEach((file, index) => {
                            const tamanhoMB = (file.size / (1024 * 1024)).toFixed(2);
                            const cor = file.size > 10 * 1024 * 1024 ? '#dc3545' : '#28a745';
                            
                            listaAnexos.innerHTML += `
                                <div style="padding: 8px; background: #f8f9fa; margin: 5px 0; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-size: 13px;">
                                        üìé ${file.name} 
                                        <span style="color: ${cor}; font-weight: 600;">(${tamanhoMB} MB)</span>
                                    </span>
                                </div>
                            `;
                        });
                    }
                });
            }
        });

        // ========== FUN√á√ÉO: Abrir Modal de Email para Fornecedor ==========
        async function abrirModalEmailFornecedor(dadosDemanda) {
            try {
                // Preencher campos
                document.getElementById('email_id_demanda').value = idDemandaParaEmailFornecedor;
                document.getElementById('email_destinatario').value = dadosVinculoFornecedor.email_fornecedor;
                
                // ===== NOVO: Preencher ID_ITEM =====
                document.getElementById('email_iditem').value = idItemLocacaoFornecedor || 0;
                
                // Usar descri√ß√£o do item ou tipo de ve√≠culo
                const descricaoVeiculo = dadosVinculoFornecedor.descricao_item || dadosVinculoFornecedor.de_tipoveiculo;
                
                // ===== MODIFICADO: Assunto com ID_ITEM =====
                let assunto = 'TJRO - Solicita√ß√£o de Loca√ß√£o';
                if (idItemLocacaoFornecedor) {
                    assunto += ` ${idItemLocacaoFornecedor}`;
                }
                assunto += ` - ${descricaoVeiculo}`;
                
                document.getElementById('email_assunto').value = assunto;
                
                // Nome do usu√°rio (obter do backend via sess√£o)
                const nomeUsuario = await obterNomeUsuario();
                
                // Formatar datas
                const dataInicio = new Date(dadosDemanda.dt_inicio + 'T00:00:00');
                const dataFim = new Date(dadosDemanda.dt_fim + 'T00:00:00');
                const dataInicioFormatada = dataInicio.toLocaleDateString('pt-BR');
                const dataFimFormatada = dataFim.toLocaleDateString('pt-BR');
                
                // Hor√°rio de sa√≠da
                const horarioSaida = dadosDemanda.horario || '07:00';
                
                const corpoHtml = `
        <p>Prezados,</p>

        <p>&nbsp;</p>

        <p>Solicito loca√ß√£o de ve√≠culo conforme informa√ß√µes abaixo:</p>

        <table border="1" cellpadding="8" cellspacing="0" style="border-collapse: collapse; width: 100%; margin: 5px 0; border: 1px solid #000;">
            <tr>
                <td style="background: #f0f0f0; font-weight: bold; width: 20%; border: 1px solid #000;">Per√≠odo:</td>
                <td style="border: 1px solid #000;"> ${dataInicioFormatada} a ${dataFimFormatada}</td>
            </tr>
            <tr>
                <td style="background: #f0f0f0; font-weight: bold; border: 1px solid #000;">Hor√°rio de Sa√≠da:</td>
                <td style="border: 1px solid #000;"> ${horarioSaida}</td>
            </tr>
            <tr>
                <td style="background: #f0f0f0; font-weight: bold; border: 1px solid #000;">Local de Sa√≠da:</td>
                <td style="border: 1px solid #000;"></td>
            </tr>                
            <tr>
                <td style="background: #f0f0f0; font-weight: bold; border: 1px solid #000;">Tipo de Ve√≠culo:</td>
                <td style="border: 1px solid #000;"> ${descricaoVeiculo}</td>
            </tr>
            ${dadosDemanda.destino ? `<tr>
                <td style="background: #f0f0f0; font-weight: bold; border: 1px solid #000;">Destino:</td>
                <td style="border: 1px solid #000;"> ${dadosDemanda.destino}</td>
            </tr>` : ''}
            ${dadosDemanda.nu_sei ? `<tr>
                <td style="background: #f0f0f0; font-weight: bold; border: 1px solid #000;">N¬∫ Processo:</td>
                <td style="border: 1px solid #000;"> ${dadosDemanda.nu_sei}</td>
            </tr>` : ''}
        </table>

        <p>&nbsp;</p>

        <p>Atenciosamente,</p>

        <p>&nbsp;</p>

        <p><strong>${nomeUsuario}</strong><br>
        Tribunal de Justi√ßa do Estado de Rond√¥nia<br>
        Se√ß√£o de Gest√£o Operacional do Transporte<br>
        üìû (69) 3309-6229/6227</p>
                `;
                
                document.getElementById('email_corpo').innerHTML = corpoHtml;
                
                // Limpar anexos
                document.getElementById('email_anexos').value = '';
                document.getElementById('lista_anexos').innerHTML = '';
                
                // Abrir modal
                document.getElementById('modalEmailFornecedor').style.display = 'block';
                
            } catch (error) {
                console.error('Erro ao abrir modal de email:', error);
                mostrarAlerta('Erro ao abrir formul√°rio de email!', '‚ùå Erro', '#dc3545');
            }
        }

        // Fun√ß√£o auxiliar para obter nome do usu√°rio
        async function obterNomeUsuario() {
            try {
                const response = await fetch('/api/usuario_logado');
                const data = await response.json();
                return data.nome || 'Administrador';
            } catch (error) {
                return 'Administrador';
            }
        }

        // ========== FUN√á√ÉO: Fechar Modal de Email (Loca√ß√£o ou Di√°rias) ==========
        async function fecharModalEmailFornecedor(emailEnviado = false) {
            const modal = document.getElementById('modalEmailFornecedor');
            
            // Se o email foi enviado com sucesso, fechar diretamente
            if (emailEnviado) {
                // Limpar vari√°veis (ambos os tipos)
                idItemLocacaoFornecedor = null;
                dadosVinculoFornecedor = null;
                idDemandaParaEmailFornecedor = null;
                idDemandaParaDiarias = null;
                dadosVinculoDiarias = null;
                temVinculoDiariasAtivo = false;
                
                // Fechar modal de email
                modal.style.display = 'none';
                
                // ====== FECHAR TAMB√âM O MODAL DE DEMANDA =====
                fecharModal();
                // ====== FIM =====
                
                // ====== VERIFICAR SE EST√Å NO FLUXO DE V√çNCULOS ======
                if (fluxoVinculosAtivo) {
                    // Continuar processando pr√≥ximo v√≠nculo
                    await processarVinculosSequencial();
                } else {
                    // Fluxo normal - recarregar
                    await carregarSemanas();
                    await carregarAgenda();
                    inicializarDestaqueLinha();
                }
                return;
            }
            
            // ===== EXCLUIR REGISTRO DE LOCA√á√ÉO (APENAS PARA LOCA√á√ÉO) - SEM CONFIRMA√á√ÉO =====
            if (idItemLocacaoFornecedor) {
                // Excluir registro de loca√ß√£o silenciosamente
                try {
                    await fetch(`/api/excluir_locacao/${idItemLocacaoFornecedor}`, {
                        method: 'DELETE'
                    });
                    
                    // console.log(`Registro de loca√ß√£o ID_ITEM ${idItemLocacaoFornecedor} exclu√≠do automaticamente`);
                } catch (error) {
                    console.error('Erro ao excluir registro de loca√ß√£o:', error);
                }
            }
            
            // Limpar vari√°veis
            idItemLocacaoFornecedor = null;
            dadosVinculoFornecedor = null;
            idDemandaParaEmailFornecedor = null;
            idDemandaParaDiarias = null;
            dadosVinculoDiarias = null;
            temVinculoDiariasAtivo = false;
            
            // Fechar modal de email
            modal.style.display = 'none';
            
            // ====== VERIFICAR SE EST√Å NO FLUXO DE V√çNCULOS ======
            if (fluxoVinculosAtivo) {
                // Continuar processando pr√≥ximo v√≠nculo
                await processarVinculosSequencial();
            } else {
                // Fluxo normal - recarregar se√ß√µes
                await carregarSemanas();
                await carregarAgenda();
                inicializarDestaqueLinha();
            }
        }

        // ========== FUN√á√ÉO: Enviar Email para Fornecedor (Loca√ß√£o OU Di√°rias) ==========
        async function enviarEmailFornecedor() {
            try {
                const destinatario = document.getElementById('email_destinatario').value;
                const assunto = document.getElementById('email_assunto').value;
                const corpoHtml = document.getElementById('email_corpo').innerHTML;
                const idDemanda = document.getElementById('email_id_demanda').value;
                const idItem = document.getElementById('email_iditem').value;
                
                if (!destinatario || !assunto || !corpoHtml.trim()) {
                    mostrarAlerta('Preencha todos os campos obrigat√≥rios!', '‚ö†Ô∏è Aten√ß√£o', '#ffc107');
                    return;
                }
                
                // Preparar FormData
                const formData = new FormData();
                formData.append('email_destinatario', destinatario);
                formData.append('assunto', assunto);
                formData.append('corpo_html', corpoHtml);
                formData.append('id_demanda', idDemanda);
                
                // Determinar tipo de email baseado em vari√°veis globais
                if (idDemandaParaDiarias && temVinculoDiariasAtivo) {
                    // √â email de DI√ÅRIAS
                    formData.append('tipo_email', 'diarias');
                    formData.append('id_item_fornecedor', idItem);
                } else {
                    // √â email de LOCA√á√ÉO
                    formData.append('tipo_email', 'locacao');
                    formData.append('id_item_fornecedor', idItem);
                }

                // Adicionar anexos
                const inputAnexos = document.getElementById('email_anexos');
                if (inputAnexos.files.length > 0) {
                    Array.from(inputAnexos.files).forEach(file => {
                        formData.append('anexos', file);
                    });
                }
                
                mostrarSpinner();
                
                const response = await fetch('/api/enviar_email_fornecedor', {
                    method: 'POST',
                    body: formData
                });
                
                const resultado = await response.json();
                
                esconderSpinner();
                
                if (response.ok && resultado.success) {
                    // Limpar vari√°veis globais
                    if (idDemandaParaDiarias) {
                        idDemandaParaDiarias = null;
                        dadosVinculoDiarias = null;
                        temVinculoDiariasAtivo = false;
                    } else {
                        idItemLocacaoFornecedor = null;
                        dadosVinculoFornecedor = null;
                        idDemandaParaEmailFornecedor = null;
                    }
                    
                    // Fechar modal
                    await fecharModalEmailFornecedor(true);
                    
                    mostrarAlerta(
                        'üìß E-mail enviado com sucesso!<br><br>A solicita√ß√£o foi registrada.',
                        '‚úÖ Sucesso',
                        '#28a745'
                    );
                    
                } else {
                    mostrarAlerta('Erro ao enviar e-mail: ' + (resultado.erro || 'Erro desconhecido'), '‚ùå Erro', '#dc3545');
                }
                
            } catch (error) {
                esconderSpinner();
                console.error('Erro ao enviar email:', error);
                mostrarAlerta('Erro ao enviar e-mail: ' + error.message, '‚ùå Erro', '#dc3545');
            }
        }


        async function init() {
            await carregarSemanas();
            await carregarSelectsFixos();
            if (semanas.length > 0) {
                const hoje = new Date();
                hoje.setHours(0, 0, 0, 0);
                
                let semanaEncontrada = -1;
                for (let i = 0; i < semanas.length; i++) {
                    const inicio = new Date(semanas[i].inicio + 'T00:00:00');
                    const fim = new Date(semanas[i].fim + 'T00:00:00');
                    
                    if (hoje >= inicio && hoje <= fim) {
                        semanaEncontrada = i;
                        break;
                    }
                }
                
                semanaAtual = semanaEncontrada !== -1 ? semanaEncontrada : 0;

                renderizarAbas();
                
                await carregarLocacoes();
                await carregarFeriadosPeriodo();
                await carregarAgenda();
            }

            initAutocompleteSetor();
            
            // ===== ADICIONAR ESTA LINHA =====
            iniciarVerificacaoAtualizacoes();
        }

        // Iniciar verifica√ß√£o de atualiza√ß√µes
        function iniciarVerificacaoAtualizacoes() {
            // ===== USAR DATE DIRETO DO MYSQL (MAIS CONFI√ÅVEL) =====
            fetch('/api/agenda/check-updates?last_check=2000-01-01 00:00:00')
                .then(res => res.json())
                .then(result => {
                    // Usar o timestamp do servidor como inicial
                    ultimoCheckTimestamp = result.last_update;
                    // console.log('üöÄ Verifica√ß√£o iniciada - Timestamp inicial:', ultimoCheckTimestamp);
                })
                .catch(error => {
                    console.error('‚ùå Erro ao obter timestamp inicial:', error);
                    // Fallback: usar timestamp local
                    const agora = new Date();
                    const ano = agora.getFullYear();
                    const mes = String(agora.getMonth() + 1).padStart(2, '0');
                    const dia = String(agora.getDate()).padStart(2, '0');
                    const hora = String(agora.getHours()).padStart(2, '0');
                    const minuto = String(agora.getMinutes()).padStart(2, '0');
                    const segundo = String(agora.getSeconds()).padStart(2, '0');
                    ultimoCheckTimestamp = `${ano}-${mes}-${dia} ${hora}:${minuto}:${segundo}`;
                });
            
            // Verificar a cada 5 segundos
            intervaloVerificacao = setInterval(async () => {
                await verificarAtualizacoesDisponiveis();
            }, 5000);
            
            // console.log('‚úÖ Intervalo de verifica√ß√£o criado');
        }


        // Parar verifica√ß√£o (quando modal estiver aberto)
        function pausarVerificacaoAtualizacoes() {
            if (intervaloVerificacao) {
                clearInterval(intervaloVerificacao);
                intervaloVerificacao = null;
            }
        }

        // Retomar verifica√ß√£o
        function retomarVerificacaoAtualizacoes() {
            if (!intervaloVerificacao) {
                iniciarVerificacaoAtualizacoes();
            }
        }

        // Verificar se h√° atualiza√ß√µes
        async function verificarAtualizacoesDisponiveis() {
            // N√£o verificar se j√° h√° notifica√ß√£o ativa
            if (notificacaoAtiva) {
                // console.log('‚è∏Ô∏è Notifica√ß√£o j√° est√° ativa');
                return;
            }
            
            // N√£o verificar se modal estiver aberto
            const modalDemanda = document.getElementById('modal');
            const modalLocacao = document.getElementById('modalFormLocacao');
            const modalEmail = document.getElementById('modalEmailFornecedor');
            
            if (modalDemanda.style.display === 'block' || 
                modalLocacao.style.display === 'block' || 
                modalEmail.style.display === 'block') {
                // console.log('‚è∏Ô∏è Modal aberto - n√£o verifica');
                return;
            }
            
            try {
                const url = `/api/agenda/check-updates?last_check=${encodeURIComponent(ultimoCheckTimestamp)}`;
                const res = await fetch(url);
                
                if (!res.ok) {
                    console.error('‚ùå Erro na resposta:', res.status);
                    return;
                }
                
                const result = await res.json();
                
                // console.log('üìÖ √öltimo check:', ultimoCheckTimestamp);
                // console.log('üì¶ Resposta:', result);
                
                if (result.has_updates) {
                    // ===== VERIFICAR SE A ATUALIZA√á√ÉO √â DE OUTRO USU√ÅRIO =====
                    const timestampAtualizado = new Date(result.last_update);
                    
                    // Se temos um timestamp de a√ß√£o local recente (√∫ltimos 5 segundos)
                    if (timestampUltimaAcaoLocal) {
                        const diferencaTempo = timestampAtualizado - timestampUltimaAcaoLocal;
                        
                        // Se a diferen√ßa √© menor que 5 segundos, provavelmente √© nossa pr√≥pria a√ß√£o
                        if (diferencaTempo < 5000 && diferencaTempo >= 0) {
                            // console.log('üîï Atualiza√ß√£o pr√≥pria detectada - N√ÉO mostra notifica√ß√£o');
                            ultimoCheckTimestamp = result.last_update;
                            timestampUltimaAcaoLocal = null; // Limpa o timestamp
                            return;
                        }
                    }
                    
                    // √â uma atualiza√ß√£o de outro usu√°rio - MOSTRA NOTIFICA√á√ÉO
                    // console.log('üîî ATUALIZA√á√ÉO DE OUTRO USU√ÅRIO - MOSTRANDO NOTIFICA√á√ÉO!');
                    ultimoCheckTimestamp = result.last_update;
                    mostrarNotificacaoAtualizacao();
                } else {
                    // Atualiza o timestamp mesmo sem updates
                    if (result.last_update) {
                        ultimoCheckTimestamp = result.last_update;
                        // console.log('üìÖ Timestamp atualizado:', ultimoCheckTimestamp);
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao verificar atualiza√ß√µes:', error);
            }
        }

        // Marca que o usu√°rio atual fez uma a√ß√£o (salvar, excluir, etc)
        function marcarAcaoLocal() {
            timestampUltimaAcaoLocal = new Date();
            // console.log('‚úèÔ∏è A√ß√£o local marcada:', timestampUltimaAcaoLocal);
        }

        // Mostrar notifica√ß√£o
        function mostrarNotificacaoAtualizacao() {
            const notificacao = document.getElementById('updateNotification');
            
            if (notificacao) {
                // ===== FOR√áAR VISIBILIDADE =====
                notificacao.style.display = 'block';
                notificacao.style.position = 'fixed';
                notificacao.style.top = '80px';
                notificacao.style.left = '50%';
                notificacao.style.transform = 'translateX(-50%)';
                notificacao.style.zIndex = '10000';
                
                notificacaoAtiva = true;
                
                // ===== DEBUG =====
                // console.log('‚úÖ Notifica√ß√£o ativada!');
                
                // ===== SCROLL PARA O TOPO PARA GARANTIR QUE O USU√ÅRIO VEJA =====
                window.scrollTo({ top: 0, behavior: 'smooth' });
                
                // ===== INICIA O CONTADOR REGRESSIVO =====
                if (!countdownActive) {
                    startUpdateCountdown();
                }
            } else {
                console.error('‚ùå Elemento updateNotification N√ÉO encontrado!');
            }
        }

        // Esconder notifica√ß√£o
        function esconderNotificacaoAtualizacao() {
            const notificacao = document.getElementById('updateNotification');
            notificacao.style.display = 'none';
            notificacaoAtiva = false;
            
            // Para o contador se estiver ativo
            stopUpdateCountdown();
        }

        // Inicia o contador regressivo de atualiza√ß√£o
        function startUpdateCountdown() {
            // Verifica se o form de demandas est√° aberto
            const formDemandas = document.getElementById('formDemandas');
            const isFormOpen = formDemandas && formDemandas.style.display === 'block';

            // Para o contador se estiver ativo
            if (countdownActive) {
                stopUpdateCountdown();
                // console.log('‚è∏Ô∏è Contador pausado - Form de demandas aberto');
            }
                        
            // Se o form estiver aberto, n√£o inicia o contador
            if (isFormOpen) {
                // console.log('‚è∏Ô∏è Form de demandas aberto. Contador n√£o iniciado.');
                return;
            }
            
            // Inicializa o contador
            countdownSeconds = 15;
            countdownActive = true;
            
            // console.log('‚è±Ô∏è Iniciando contador regressivo de 15 segundos...');
            
            // Atualiza a interface com o contador
            updateCountdownDisplay();
            
            // Inicia o intervalo
            countdownInterval = setInterval(() => {
                countdownSeconds--;
                updateCountdownDisplay();
                
                if (countdownSeconds <= 0) {
                    // console.log('‚è∞ Contador zerou! Atualizando automaticamente...');
                    stopUpdateCountdown();
                    // Atualiza a p√°gina automaticamente
                    atualizarAgoraPelaNotificacao();
                }
            }, 1000);
        }
        
        // Atualiza a exibi√ß√£o do contador na interface
        function updateCountdownDisplay() {
            const notificationBar = document.getElementById('updateNotification');
            if (!notificationBar) return;
            
            // Verifica se j√° existe o container do contador
            let countdownContainer = notificationBar.querySelector('.countdown-container');
            
            if (!countdownContainer) {
                // Cria o container do contador
                countdownContainer = document.createElement('div');
                countdownContainer.className = 'countdown-container';
                countdownContainer.innerHTML = `
                    <span class="countdown-text">Atualizando em:</span>
                    <span class="countdown-timer">${countdownSeconds}s</span>
                    <div class="countdown-actions">
                        <button class="countdown-btn btn-cancel" onclick="stopUpdateCountdown()">Cancelar</button>
                        <button class="countdown-btn" onclick="atualizarAgoraPelaNotificacao(); stopUpdateCountdown();">Atualizar Agora</button>
                    </div>
                `;
                
                // Adiciona o contador dentro do .update-content, antes do bot√£o X
                const updateContent = notificationBar.querySelector('.update-content');
                const dismissBtn = notificationBar.querySelector('.btn-dismiss');
                
                if (updateContent && dismissBtn) {
                    updateContent.insertBefore(countdownContainer, dismissBtn);
                } else if (updateContent) {
                    updateContent.appendChild(countdownContainer);
                }
            } else {
                // Atualiza apenas o n√∫mero
                const timerElement = countdownContainer.querySelector('.countdown-timer');
                if (timerElement) {
                    timerElement.textContent = `${countdownSeconds}s`;
                }
            }
        }
        
        // Para o contador regressivo
        function stopUpdateCountdown() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
                // console.log('‚èπÔ∏è Contador interrompido pelo usu√°rio.');
            }
            countdownActive = false;
            countdownSeconds = 15;
            
            // Remove o container do contador da interface
            const notificationBar = document.getElementById('updateNotification');
            if (notificationBar) {
                const countdownContainer = notificationBar.querySelector('.countdown-container');
                if (countdownContainer) {
                    countdownContainer.remove();
                }
            }
        }
        
        // Atualizar agora pela notifica√ß√£o
        async function atualizarAgoraPelaNotificacao() {
            esconderNotificacaoAtualizacao();
            await atualizarAgendaManual();
            ultimoCheckTimestamp = new Date().toISOString().slice(0, 19).replace('T', ' ');
        }

        // Dispensar notifica√ß√£o (continuar vendo dados antigos)
        function dispensarNotificacao() {
            stopUpdateCountdown(); // Para o contador antes de esconder
            esconderNotificacaoAtualizacao();
            // ultimoCheckTimestamp = new Date().toISOString().slice(0, 19).replace('T', ' ');
        }

        // Carregar feriados do per√≠odo atual
        async function carregarFeriadosPeriodo() {
            try {
                const semana = semanas[semanaAtual];
                const res = await fetch(`/api/agenda/feriados-periodo?inicio=${semana.inicio}&fim=${semana.fim}`);
                feriadosPeriodo = await res.json();
            } catch (error) {
                console.error('Erro ao carregar feriados do per√≠odo:', error);
                feriadosPeriodo = [];
            }
        }

        // Abrir modal de feriados
        async function abrirModalFeriados() {
            document.getElementById('modalFeriados').style.display = 'block';
            await carregarListaFeriados();
        }

        // Fechar modal de feriados
        function fecharModalFeriados() {
            document.getElementById('modalFeriados').style.display = 'none';
        }

        function gerarCSSClassesDinamicas() {
            // Criar elemento <style> din√¢mico
            const style = document.createElement('style');
            style.id = 'dynamic-tipo-demanda-styles';
            
            let css = '/* Estilos din√¢micos de tipos de demanda */\n';
            
            tiposDemanda.forEach(tipo => {
                const corInicio = tipo.cor_inicio || '#5fa1df';
                const corFim = tipo.cor_fim || '#8dbde8';
                const negrito = tipo.negrito ? 'font-weight: bold;' : '';
                
                css += `
        .tipo-${tipo.id} {
            background: linear-gradient(to bottom, ${corInicio}, ${corFim}) !important;
            ${negrito}
        }
        `;
            });
            
            style.textContent = css;
            document.head.appendChild(style);
            
            // console.log('‚úÖ CSS din√¢mico gerado para tipos de demanda');
        }            
        
        
        // Carregar lista de todos os feriados
        async function carregarListaFeriados() {
            const lista = document.getElementById('feriadosLista');
            lista.innerHTML = '<div class="loading">Carregando...</div>';
            
            try {
                const res = await fetch('/api/agenda/feriados');
                const feriados = await res.json();
                
                if (feriados.length === 0) {
                    lista.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Nenhum feriado cadastrado</div>';
                    return;
                }
                
                lista.innerHTML = feriados.map(f => {
                    const data = new Date(f.dt_feriado + 'T00:00:00');
                    const dataFormatada = data.toLocaleDateString('pt-BR', { 
                        day: '2-digit', 
                        month: '2-digit', 
                        year: 'numeric',
                        weekday: 'short'
                    });
                    
                    return `
                        <div class="feriado-item">
                            <div class="feriado-info">
                                <div class="feriado-descricao">${f.descricao}</div>
                                <div class="feriado-data">${dataFormatada}</div>
                            </div>
                            <button class="btn-icon" onclick="excluirFeriado(${f.id})" title="Excluir">üóëÔ∏è</button>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Erro ao carregar lista de feriados:', error);
                lista.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">Erro ao carregar feriados</div>';
            }
        }

        // Adicionar novo feriado
        async function adicionarFeriado() {
            const tipo = document.getElementById('tipoFeriado').value;
            const data = document.getElementById('dataFeriado').value;
            
            if (!data) {
                alert('Informe a data do feriado!');
                return;
            }
            
            try {
                const res = await fetch('/api/agenda/feriado', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        descricao: tipo,
                        dt_feriado: data
                    })
                });
                
                const result = await res.json();
                
                if (result.success) {
                    document.getElementById('dataFeriado').value = '';
                    await carregarListaFeriados();
                    await carregarFeriadosPeriodo();
                    await carregarAgenda();
                }
            } catch (error) {
                console.error('Erro ao adicionar feriado:', error);
            }
        }

        // Excluir feriado
        async function excluirFeriado(id) {
            try {
                const res = await fetch(`/api/agenda/feriado/${id}`, {
                    method: 'DELETE'
                });
                
                const result = await res.json();
                
                if (result.success) {
                    await carregarListaFeriados();
                    await carregarFeriadosPeriodo();
                    await carregarAgenda();
                }
            } catch (error) {
                console.error('Erro ao excluir feriado:', error);
            }
        }

        // Verificar se uma data √© feriado
        function isFeriado(data) {
            return feriadosPeriodo.find(f => f.dt_feriado === data);
        }


        async function carregarLocacoes() {
            try {
                const semana = semanas[semanaAtual];
                const res = await fetch(`/api/agenda/locacoes?inicio=${semana.inicio}&fim=${semana.fim}`);
                locacoesAtivas = await res.json();
            } catch (error) {
                console.error('Erro ao carregar loca√ß√µes:', error);
                locacoesAtivas = [];
            }
        }
        
        async function carregarSemanas() {
            try {
                const res = await fetch('/api/agenda/semanas');
                const data = await res.json();
                
                if (data.error) {
                    console.error('Erro na API:', data.error);
                    semanas = data.semanas || [];
                } else if (Array.isArray(data)) {
                    semanas = data;
                } else {
                    semanas = [];
                }
                
                // renderizarAbas();
            } catch (error) {
                console.error('Erro ao carregar semanas:', error);
                semanas = [];
                const hoje = new Date();
                const domingo = new Date(hoje);
                domingo.setDate(hoje.getDate() - ((hoje.getDay() + 7) % 7));
                const sabado = new Date(domingo);
                sabado.setDate(domingo.getDate() + 6);
                
                semanas = [{
                    inicio: domingo.toISOString().split('T')[0],
                    fim: sabado.toISOString().split('T')[0],
                    label: `${domingo.getDate()}/${domingo.getMonth()+1} - ${sabado.getDate()}/${sabado.getMonth()+1}/${sabado.getFullYear()}`
                }];
                // renderizarAbas();
            }
        }
        
        async function carregarSelectsFixos() {
            try {
                const [resTiposDemanda, resTiposVeiculo] = await Promise.all([
                    fetch('/api/agenda/tipos-demanda-completo'), // ALTERADO: usar rota completa
                    fetch('/api/agenda/tipos-veiculo')
                ]);
                
                tiposDemanda = await resTiposDemanda.json();
                tiposVeiculo = await resTiposVeiculo.json();
                
                // Armazenar configura√ß√µes em objeto para acesso r√°pido
                tiposDemandaConfig = {};
                tiposDemanda.forEach(t => {
                    tiposDemandaConfig[t.id] = t;
                });
                
                // Gerar CSS din√¢mico para as cores (apenas uma vez)
                if (!cssClassesGeradas) {
                    gerarCSSClassesDinamicas();
                    cssClassesGeradas = true;
                }
                
                const selectTipoDemanda = document.getElementById('idTipoDemanda');
                const selectTipoVeiculo = document.getElementById('idTipoVeiculo');
                
                selectTipoDemanda.innerHTML = '<option value="">Selecione...</option>';
                tiposDemanda.forEach(t => {
                    selectTipoDemanda.innerHTML += `<option value="${t.id}" data-descricao="${t.descricao}">${t.descricao}</option>`;
                });
                
                selectTipoVeiculo.innerHTML = '<option value="">Selecione...</option>';
                tiposVeiculo.forEach(t => {
                    selectTipoVeiculo.innerHTML += `<option value="${t.id}">${t.descricao}</option>`;
                });
                
                // Event listeners para regras de neg√≥cio
                selectTipoDemanda.addEventListener('change', aplicarRegrasTipoDemanda);
                selectTipoVeiculo.addEventListener('change', aplicarRegrasTipoVeiculo);
                document.getElementById('dtInicio').addEventListener('change', atualizarVeiculosDisponiveis);
                document.getElementById('dtFim').addEventListener('change', atualizarVeiculosDisponiveis);
            } catch (error) {
                console.error('Erro ao carregar selects:', error);
            }
        }
        
        function aplicarRegrasTipoDemanda() {
            const idTipoDemanda = parseInt(document.getElementById('idTipoDemanda').value);
            const config = tiposDemandaConfig[idTipoDemanda] || {};
            
            const motorista = document.getElementById('idMotorista');
            const tipoVeiculo = document.getElementById('idTipoVeiculo');
            const veiculo = document.getElementById('idVeiculo');
            const setor = document.getElementById('setor');
            const solicitante = document.getElementById('solicitante');
            const destino = document.getElementById('destino');
            const divSolicitado = document.getElementById('divSolicitado');
            const divExpandirVeiculos = document.getElementById('divExpandirVeiculos');
            
            // Labels
            const labelTipoVeiculo = document.getElementById('labelTipoVeiculo');
            const labelVeiculo = document.getElementById('labelVeiculo');
            const labelSetor = document.getElementById('labelSetor');
            const labelSolicitante = document.getElementById('labelSolicitante');
            const labelDestino = document.getElementById('labelDestino');
            const labelMotorista = document.getElementById('labelMotorista');
            
            // ========== RESETAR TUDO PRIMEIRO ==========
            motorista.disabled = false;
            tipoVeiculo.disabled = false;
            // ‚Üê ALTERA√á√ÉO AQUI: N√ÉO resetar veiculo.disabled = false
            // O select ve√≠culo deve permanecer bloqueado at√© que aplicarRegrasTipoVeiculo() seja chamado
            setor.disabled = false;
            solicitante.disabled = false;
            destino.disabled = false;
            
            motorista.required = true;
            tipoVeiculo.required = false;
            veiculo.required = false;
            setor.required = false;
            solicitante.required = false;
            destino.required = false;
            
            divSolicitado.style.display = 'none';
            
            // Resetar labels (sem asteriscos)
            labelTipoVeiculo.innerHTML = 'Tipo de Ve√≠culo';
            labelVeiculo.innerHTML = 'Ve√≠culo';
            labelSetor.innerHTML = 'Setor';
            labelSolicitante.innerHTML = 'Solicitante';
            labelDestino.innerHTML = 'Destino';
            labelMotorista.innerHTML = 'Motorista <span class="required">*</span>';

            if (!config.destino_auto_preencher) {
                // S√≥ limpa se n√£o estiver em modo de edi√ß√£o (se n√£o tiver idAd)
                const idAd = document.getElementById('idAd').value;
                if (!idAd) {
                    destino.value = '';
                }
            }            
            
            // ========== APLICAR CONFIGURA√á√ïES DO BANCO ==========
            
            // Obrigatoriedade do Motorista
            motorista.required = config.motorista_obrigatorio;
            if (config.motorista_obrigatorio) {
                labelMotorista.innerHTML = 'Motorista <span class="required">*</span>';
            } else {
                labelMotorista.innerHTML = 'Motorista';
            }
            
            // Obrigatoriedade do Setor
            setor.required = config.setor_obrigatorio;
            if (config.setor_obrigatorio) {
                labelSetor.innerHTML = 'Setor <span class="required">*</span>';
            }
            
            // Obrigatoriedade do Solicitante
            solicitante.required = config.solicitante_obrigatorio;
            if (config.solicitante_obrigatorio) {
                labelSolicitante.innerHTML = 'Solicitante <span class="required">*</span>';
            }
            
            // Obrigatoriedade do Destino
            destino.required = config.destino_obrigatorio;
            if (config.destino_obrigatorio) {
                labelDestino.innerHTML = 'Destino <span class="required">*</span>';
            }
            
            // Tipo de Ve√≠culo obrigat√≥rio
            tipoVeiculo.required = config.tipo_veiculo_obrigatorio;
            if (config.tipo_veiculo_obrigatorio) {
                labelTipoVeiculo.innerHTML = 'Tipo de Ve√≠culo <span class="required">*</span>';
            }
            
            // Ve√≠culo obrigat√≥rio
            veiculo.required = config.veiculo_obrigatorio;
            if (config.veiculo_obrigatorio) {
                labelVeiculo.innerHTML = 'Ve√≠culo <span class="required">*</span>';
            }
            
            // Bloqueios de campos
            if (config.bloquear_tipo_veiculo) {
                tipoVeiculo.disabled = true;
                tipoVeiculo.value = '';
            }
            
            if (config.bloquear_veiculo) {
                veiculo.disabled = true;
                veiculo.value = '';
            }
            
            if (config.bloquear_setor) {
                setor.disabled = true;
                setor.value = '';
            }
            
            if (config.bloquear_solicitante) {
                solicitante.disabled = true;
                solicitante.value = '';
            }
            
            if (config.bloquear_destino) {
                destino.disabled = true;
            }
            
            // Auto-preencher destino com descri√ß√£o do tipo
            if (config.destino_auto_preencher && !destino.value) {
                destino.value = config.descricao;
            }
            
            // Exibir checkbox Solicitado
            if (config.exibir_checkbox_solicitado) {
                divSolicitado.style.display = 'block';
            }
            
            // ========== NOVA ADI√á√ÉO: Ocultar checkbox Expandir Ve√≠culos se bloquear ve√≠culo ==========
            if (config.bloquear_veiculo) {
                divExpandirVeiculos.style.display = 'none';
                document.getElementById('expandirVeiculos').checked = false;
            }
        }

                
        function aplicarRegrasTipoVeiculo() {
            const idTipoVeiculo = parseInt(document.getElementById('idTipoVeiculo').value);
            const veiculo = document.getElementById('idVeiculo');
            const motorista = document.getElementById('idMotorista');
            const divSolicitado = document.getElementById('divSolicitado');
            const divExpandirVeiculos = document.getElementById('divExpandirVeiculos');
            const labelMotorista = document.getElementById('labelMotorista');
            
            // ========== NOVO: Verificar se tem fornecedor vinculado ==========
            if (temVinculoFornecedorAtivo) {
                // Se tem fornecedor, for√ßar bloqueio de motorista e ve√≠culo
                motorista.value = '';
                motorista.disabled = true;
                motorista.required = false;
                document.getElementById('motoristaFilter').style.display = 'none';
                labelMotorista.innerHTML = 'Motorista';
                
                veiculo.value = '';
                veiculo.disabled = true;
                veiculo.required = false;
                
                divSolicitado.style.display = 'none';
                divExpandirVeiculos.style.display = 'none';
                
                return; // N√£o continua com as outras regras
            }
            
            // ========== Resto da fun√ß√£o continua igual ==========
            // Ocultar checkbox Solicitado e Expandir Ve√≠culos por padr√£o
            divSolicitado.style.display = 'none';
            divExpandirVeiculos.style.display = 'none';
            
            if (!idTipoVeiculo) {
                veiculo.disabled = false;
                veiculo.innerHTML = '<option value="">Selecione...</option>';
                return;
            }
            
            // IDs 7, 8, 9: Bloqueia motorista e ve√≠culo, exibe checkbox Solicitado
            if (idTipoVeiculo === 7 || idTipoVeiculo === 8 || idTipoVeiculo === 9) {
                motorista.disabled = true;
                motorista.required = false;
                motorista.value = '';
                if (labelMotorista) {
                    labelMotorista.innerHTML = 'Motorista';
                }
                
                veiculo.disabled = true;
                veiculo.value = '';
                
                // Exibir checkbox Solicitado
                divSolicitado.style.display = 'block';
                
            } else if (idTipoVeiculo !== 1) {
                // Tipo diferente de 1 e n√£o √© 7, 8, 9: bloqueia ve√≠culo
                veiculo.disabled = true;
                veiculo.value = '';
                
            } else {
                // ========== ALTERA√á√ÉO AQUI: Tipo 1 (Oficial) ==========
                // Verificar se o tipo de demanda bloqueia ve√≠culo
                const idTipoDemanda = parseInt(document.getElementById('idTipoDemanda').value);
                const configTipoDemanda = tiposDemandaConfig[idTipoDemanda];
                
                // Se tipo de demanda bloqueia ve√≠culo, N√ÉO desbloqueia mesmo sendo tipo ve√≠culo 1
                if (configTipoDemanda && configTipoDemanda.bloquear_veiculo) {
                    veiculo.disabled = true;
                    veiculo.value = '';
                    divExpandirVeiculos.style.display = 'none';
                } else {
                    // Se tipo de demanda N√ÉO bloqueia ve√≠culo, desbloqueia normalmente
                    veiculo.disabled = false;
                    
                    // MOSTRAR checkbox de expandir ve√≠culos
                    divExpandirVeiculos.style.display = 'block';
                    
                    const dtInicio = document.getElementById('dtInicio').value;
                    const dtFim = document.getElementById('dtFim').value;
                    
                    if (dtInicio && dtFim) {
                        // Se tem datas, carrega ve√≠culos dispon√≠veis
                        if (listaVeiculosExpandida) {
                            toggleExpandirVeiculos();
                        } else {
                            atualizarVeiculosDisponiveis();
                        }
                    } else {
                        // Se n√£o tem datas, carrega todos os ve√≠culos ou padr√£o
                        if (listaVeiculosExpandida) {
                            toggleExpandirVeiculos();
                        } else {
                            preencherSelectVeiculos();
                        }
                    }
                }
            }
        }

        
        async function atualizarVeiculosDisponiveis() {
            const idTipoVeiculo = parseInt(document.getElementById('idTipoVeiculo').value);
            const dtInicio = document.getElementById('dtInicio').value;
            const dtFim = document.getElementById('dtFim').value;
            const selectVeiculo = document.getElementById('idVeiculo');
            const idAd = document.getElementById('idAd').value;
            const temHorario = document.getElementById('definirHorario').checked;
            
            // S√≥ atualiza se for tipo ve√≠culo 1 e tiver datas
            if (idTipoVeiculo !== 1 || !dtInicio || !dtFim) {
                return;
            }
            
            try {
                let url = `/api/agenda/veiculos-disponiveis?inicio=${dtInicio}&fim=${dtFim}&tem_horario=${temHorario}`;
                if (idAd) {
                    url += `&id_demanda=${idAd}`;
                }
                
                const res = await fetch(url);
                const veiculosDisponiveis = await res.json();
                
                const veiculoAtual = selectVeiculo.value;
                
                selectVeiculo.innerHTML = '<option value="">Selecione...</option>';
                
                // Adiciona ve√≠culos dispon√≠veis
                veiculosDisponiveis.forEach(v => {
                    selectVeiculo.innerHTML += `<option value="${v.id}">${v.veiculo}</option>`;
                });
                
                // Se tinha um ve√≠culo selecionado e ele n√£o est√° na lista, adiciona
                if (veiculoAtual && veiculoSelecionadoOriginal) {
                    const existe = Array.from(selectVeiculo.options).some(opt => opt.value == veiculoAtual);
                    if (!existe) {
                        selectVeiculo.innerHTML += `<option value="${veiculoSelecionadoOriginal.id}">${veiculoSelecionadoOriginal.veiculo}</option>`;
                    }
                    selectVeiculo.value = veiculoAtual;
                }
            } catch (error) {
                console.error('Erro ao carregar ve√≠culos dispon√≠veis:', error);
            }
        }
        
        function renderizarAbas() {
            const tabs = document.getElementById('weekTabs');
            // console.log('=== RENDERIZAR ABAS ===');
            // console.log('semanaAtual na renderiza√ß√£o:', semanaAtual);
            
            tabs.innerHTML = semanas.map((s, i) => {
                const isActive = i === semanaAtual;
                // console.log(`Aba ${i} (${s.label}): ${isActive ? 'ACTIVE' : 'inativa'}`);
                return `<div class="week-tab ${isActive ? 'active' : ''}" 
                    onclick="mudarSemana(${i})">${s.label}</div>`;
            }).join('');
            
            // console.log('HTML gerado:', tabs.innerHTML.substring(0, 200) + '...');
            // console.log('=======================');
            
            // Scroll para a aba ativa ap√≥s renderizar
            setTimeout(() => {
                scrollToActiveTab();
                atualizarBotoesNavegacao();
            }, 100);
        }
        
        // ========== NOVA FUN√á√ÉO: Encontrar semana de uma data ==========
        function encontrarSemanaDaData(data) {
            const dataObj = new Date(data + 'T00:00:00');
            
            for (let i = 0; i < semanas.length; i++) {
                const inicio = new Date(semanas[i].inicio + 'T00:00:00');
                const fim = new Date(semanas[i].fim + 'T00:00:00');
                
                if (dataObj >= inicio && dataObj <= fim) {
                    return i;
                }
            }
            
            return -1; // N√£o encontrou
        }

        async function mudarSemana(index) {
            semanaAtual = index;
            renderizarAbas();
            await carregarFeriadosPeriodo();
            await carregarAgenda();
            inicializarDestaqueLinha();
        }
        
        async function carregarAgenda() {
            const wrapper = document.getElementById('agendaWrapper');
            wrapper.innerHTML = '<div class="loading">‚è≥ Carregando agenda...</div>';
            
            try {
                const semana = semanas[semanaAtual];
                await carregarLocacoes();
                const res = await fetch(`/api/agenda/dados?inicio=${semana.inicio}&fim=${semana.fim}`);
                dadosAgenda = await res.json();
                
                motoristas = dadosAgenda.motoristas;
                outrosMotoristas = dadosAgenda.outros_motoristas || [];
                motoristasAdministrativo = dadosAgenda.motoristas_administrativo || []; 
                veiculos = dadosAgenda.veiculos;
                veiculosExtras = dadosAgenda.veiculos_extras || [];
                
                document.getElementById('semanaAtual').textContent = semana.label;
                
                renderizarAgenda();
                inicializarDestaqueLinha();
            } catch (error) {
                wrapper.innerHTML = '<div class="loading">‚ùå Erro ao carregar agenda</div>';
                console.error('Erro:', error);
            }
        }

        // Nova fun√ß√£o para toggle de expandir ve√≠culos
        async function toggleExpandirVeiculos() {
            const checkbox = document.getElementById('expandirVeiculos');
            const selectVeiculo = document.getElementById('idVeiculo');
            const dtInicio = document.getElementById('dtInicio').value;
            const dtFim = document.getElementById('dtFim').value;
            const idAd = document.getElementById('idAd').value;
            const temHorario = document.getElementById('definirHorario').checked;
            
            listaVeiculosExpandida = checkbox.checked;
            
            if (!dtInicio || !dtFim) {
                if (listaVeiculosExpandida) {
                    // Carregar todos os ve√≠culos sem filtro de data
                    try {
                        const res = await fetch(`/api/agenda/veiculos-todos?tem_horario=${temHorario}`);
                        const todosVeiculos = await res.json();
                        
                        const veiculoAtual = selectVeiculo.value;
                        selectVeiculo.innerHTML = '<option value="">Selecione...</option>';
                        
                        todosVeiculos.forEach(v => {
                            selectVeiculo.innerHTML += `<option value="${v.id}">${v.veiculo}</option>`;
                        });
                        
                        if (veiculoAtual) {
                            selectVeiculo.value = veiculoAtual;
                        }
                    } catch (error) {
                        console.error('Erro ao carregar todos os ve√≠culos:', error);
                    }
                } else {
                    // Voltar para lista padr√£o
                    preencherSelectVeiculos();
                }
                return;
            }
        
            // Se tem datas, carregar com filtro
            if (listaVeiculosExpandida) {
                try {
                    let url = `/api/agenda/veiculos-todos?inicio=${dtInicio}&fim=${dtFim}&tem_horario=${temHorario}`;
                    if (idAd) {
                        url += `&id_demanda=${idAd}`;
                    }
                    
                    const res = await fetch(url);
                    const todosVeiculos = await res.json();
                    
                    const veiculoAtual = selectVeiculo.value;
                    selectVeiculo.innerHTML = '<option value="">Selecione...</option>';
                    
                    todosVeiculos.forEach(v => {
                        selectVeiculo.innerHTML += `<option value="${v.id}">${v.veiculo}</option>`;
                    });
                    
                    if (veiculoAtual && veiculoSelecionadoOriginal) {
                        const existe = Array.from(selectVeiculo.options).some(opt => opt.value == veiculoAtual);
                        if (!existe) {
                            selectVeiculo.innerHTML += `<option value="${veiculoSelecionadoOriginal.id}">${veiculoSelecionadoOriginal.veiculo}</option>`;
                        }
                        selectVeiculo.value = veiculoAtual;
                    }
                } catch (error) {
                    console.error('Erro ao carregar todos os ve√≠culos:', error);
                }
            } else {
                // Voltar para lista padr√£o com filtro de disponibilidade
                await atualizarVeiculosDisponiveis();
            }
        }

        function renderizarAgenda() {
            const semana = semanas[semanaAtual];
            const dias = gerarDiasSemana(semana.inicio);
            
            let html = '';
            
            html += renderizarSecaoMotoristas(dias);
            html += renderizarSecaoAdministrativo(dias); 
            html += renderizarSecaoOutrosMotoristas(dias);  // NOVO
            html += renderizarSecaoVeiculos(dias);
            html += renderizarSecaoVeiculosAlocados(dias);

            document.getElementById('agendaWrapper').innerHTML = html;

            // Preencher cabe√ßalhos flutuantes com os dias
            preencherDiasCabecalhosFlutuantes(dias);
            
            // Atualizar visibilidade inicial
            setTimeout(atualizarCabecalhosFlutuantes, 100);
        }

        // Controle dos cabe√ßalhos flutuantes
        function atualizarCabecalhosFlutuantes() {
            const sections = document.querySelectorAll('.agenda-section');
            const headerHeight = 0;
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            
            sections.forEach((section, index) => {
                const table = section.querySelector('.agenda-table');
                if (!table) return;
                
                const thead = table.querySelector('thead');
                if (!thead) return;
                
                const rect = section.getBoundingClientRect();
                const theadRect = thead.getBoundingClientRect();
                
                // Determinar qual sticky header usar
                let stickyHeader;
                if (section.querySelector('.section-header span')?.textContent.includes('SEGEOP - MOTORISTAS') && 
                    !section.querySelector('.section-header span')?.textContent.includes('OUTROS')) {
                    stickyHeader = document.getElementById('stickyHeaderMotoristas');
                } else if (section.querySelector('.section-header span')?.textContent.includes('SEGEOP - ADMINISTRATIVO')) {
                    stickyHeader = document.getElementById('stickyHeaderAdministrativo');                
                } else if (section.querySelector('.section-header span')?.textContent.includes('OUTROS MOTORISTAS')) {
                    stickyHeader = document.getElementById('stickyHeaderOutrosMotoristas');
                } else if (section.querySelector('.section-header span')?.textContent.includes('VE√çCULOS OFICIAIS')) {
                    stickyHeader = document.getElementById('stickyHeaderVeiculos');
                } else if (section.querySelector('.section-header span')?.textContent.includes('VE√çCULOS ALOCADOS')) {
                    stickyHeader = document.getElementById('stickyHeaderVeiculosAlocados');
                }
                
                if (!stickyHeader) return;
                
                // Mostrar o cabe√ßalho flutuante se:
                // - A se√ß√£o est√° vis√≠vel na tela
                // - O thead original saiu da tela (scrollou para cima)
                // - Ainda n√£o chegou no final da se√ß√£o
                const shouldShow = theadRect.top < headerHeight && rect.bottom > headerHeight + 50;
                
                if (shouldShow) {
                    stickyHeader.classList.add('visible');
                } else {
                    stickyHeader.classList.remove('visible');
                }
            });
        }
        
        // Preencher os dias nos cabe√ßalhos flutuantes
        function preencherDiasCabecalhosFlutuantes(dias) {
            const prefixes = ['sticky', 'sticky-admin', 'sticky-outros', 'sticky-veic', 'sticky-aloc'];
            prefixes.forEach(prefix => {
                dias.forEach((dia, i) => {
                    const cell = document.getElementById(`${prefix}-dia-${i + 1}`);
                    if (cell) {
                        cell.innerHTML = `${dia.diaNome}<br>${dia.diaNum}/${dia.mes}`;
                    }
                });
            });
        }
        
        // Event listener para scroll
        window.addEventListener('scroll', atualizarCabecalhosFlutuantes);
        window.addEventListener('resize', atualizarCabecalhosFlutuantes);
        
        function gerarDiasSemana(inicioStr) {
            const dias = [];
            const inicio = new Date(inicioStr + 'T00:00:00');
            
            for (let i = 0; i < 7; i++) {
                const d = new Date(inicio);
                d.setDate(inicio.getDate() + i);
                dias.push({
                    data: d.toISOString().split('T')[0],
                    diaNum: d.getDate(),
                    mes: d.getMonth() + 1,
                    diaNome: ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'][d.getDay()],
                    diaIndex: d.getDay()
                });
            }
            return dias;
        }
        
        // Fun√ß√£o para encurtar nome do solicitante (mant√©m apenas 2 primeiros nomes)
        function encurtarNomeSolicitante(nomeCompleto) {
            if (!nomeCompleto || nomeCompleto.trim() === '') {
                return '';
            }
            
            const partes = nomeCompleto.trim().split(/\s+/); // Split por espa√ßos
            
            // Se tem 2 ou menos nomes, retorna completo
            if (partes.length <= 2) {
                return nomeCompleto;
            }
            
            // Se tem mais de 2 nomes, retorna apenas os 2 primeiros
            return `${partes[0]} ${partes[1]}`;
        }

        function abreviarNomeMotorista(nomeCompleto) {
            if (!nomeCompleto || nomeCompleto.trim() === '') {
                return '';
            }
            
            const partes = nomeCompleto.trim().split(/\s+/);
            
            // Se tem 2 ou menos nomes, retorna completo
            if (partes.length <= 2) {
                return nomeCompleto;
            }
            
            // Part√≠culas que devem ser inclu√≠das
            const particulas = ['de', 'da', 'do', 'das', 'dos'];
            
            // Se o segundo nome √© uma part√≠cula, incluir o terceiro nome tamb√©m
            if (particulas.includes(partes[1].toLowerCase())) {
                return partes.length >= 3 
                    ? `${partes[0]} ${partes[1]} ${partes[2]}`
                    : nomeCompleto;
            }
            
            // Se n√£o tem part√≠cula no segundo nome, retorna os 2 primeiros
            return `${partes[0]} ${partes[1]}`;
        }
        
        function renderizarSecaoMotoristas(dias) {
            let html = '<div class="agenda-section">';
            html += `
                <div class="section-header">
                    <span>üë≤ SEGEOP - MOTORISTAS</span>
                    <button class="btn-visualizar" onclick="abrirVisualizacaoSecao('motoristas')">üëÅÔ∏è Visualizar</button>
                </div>
            `;
            html += '<table class="agenda-table"><thead><tr>';
            html += '<th class="col-numero">N.</th><th class="col-nome">Nome</th>';
            dias.forEach(d => html += `<th class="col-dia">${d.diaNome}<br>${d.diaNum}/${d.mes}</th>`);
            html += '</tr></thead><tbody>';
            
            motoristas.forEach((m, motoristaGlobalIndex) => {
                // Para cada dia, verificar quantas demandas diferentes existem
                const demandasPorDia = dias.map(dia => {
                    return dadosAgenda.demandas.filter(d => 
                        d.id_motorista === m.id && 
                        d.dt_inicio <= dia.data && 
                        d.dt_fim >= dia.data
                    );
                });
                
                const maxDemandasPorDia = Math.max(...demandasPorDia.map(d => d.length), 1);
                
                // Criar matriz de controle de c√©lulas (qual c√©lula j√° foi renderizada)
                const celulasRenderizadas = Array(maxDemandasPorDia).fill(0).map(() => Array(dias.length).fill(false));
                
                // Renderizar cada linha deste motorista
                for (let linhaIndex = 0; linhaIndex < maxDemandasPorDia; linhaIndex++) {
                    html += `<tr>`;
                    
                    // Mostrar n√∫mero e nome apenas na primeira linha
                    if (linhaIndex === 0) {
                        if (maxDemandasPorDia > 1) {
                            html += `<td class="col-numero" rowspan="${maxDemandasPorDia}">${motoristaGlobalIndex + 1}</td>`;
                            html += `<td class="col-nome" rowspan="${maxDemandasPorDia}">${m.nome}</td>`;
                        } else {
                            html += `<td class="col-numero">${motoristaGlobalIndex + 1}</td>`;
                            html += `<td class="col-nome">${m.nome}</td>`;
                        }
                    }
                    
                    // Renderizar c√©lulas de cada dia
                    for (let diaIndex = 0; diaIndex < dias.length; diaIndex++) {
                        // Se esta c√©lula j√° foi renderizada (mesclada), pular
                        if (celulasRenderizadas[linhaIndex][diaIndex]) {
                            continue;
                        }
                        
                        const dia = dias[diaIndex];
                        const feriado = isFeriado(dia.data);
                        const isWeekend = dia.diaIndex === 0 || dia.diaIndex === 6;
                        const demandasDia = demandasPorDia[diaIndex];
                        
                        // Pegar a demanda correspondente a esta linha
                        const demanda = demandasDia[linhaIndex];
                        
                        if (demanda) {
                            // Tem demanda - verificar se pode mesclar com linhas vazias abaixo
                            let rowspanCount = 1;
                            
                            // Contar quantas linhas abaixo est√£o vazias para este dia
                            for (let proxLinha = linhaIndex + 1; proxLinha < maxDemandasPorDia; proxLinha++) {
                                if (!demandasDia[proxLinha]) {
                                    rowspanCount++;
                                    celulasRenderizadas[proxLinha][diaIndex] = true;
                                } else {
                                    break;
                                }
                            }
                            
                            const corClass = `tipo-${demanda.id_tipodemanda}`;
                            const feriadoClass = feriado ? 'cell-feriado-com-demanda' : '';
                            html += `<td class="${corClass} ${feriadoClass} col-dia" ${rowspanCount > 1 ? `rowspan="${rowspanCount}"` : ''} data-id-demanda="${demanda.id}" onclick="handleCellClick(event, ${demanda.id})" onmouseenter="mostrarTooltipVeiculo(event, ${demanda.id})" onmousemove="posicionarTooltip(event)" onmouseleave="esconderTooltipVeiculo()">`;
                            
                            html += '<div class="cell-content">';
                            
                            // ========== L√ìGICA DIN√ÇMICA BASEADA EM CONFIGURA√á√ÉO ==========
                            const tipoConfig = tiposDemandaConfig[demanda.id_tipodemanda];
                            
                            // Verificar se √© tipo que bloqueia setor e solicitante (ex: Oficina, Lava-Jato)
                            const bloqueiaSetorSolicitante = tipoConfig && tipoConfig.bloquear_setor && tipoConfig.bloquear_solicitante;
                            
                            // Verificar se √© tipo Ced√™ncia (setor obrigat√≥rio)
                            const isCedencia = tipoConfig && tipoConfig.setor_obrigatorio && !tipoConfig.bloquear_setor;
                            
                            if (bloqueiaSetorSolicitante) {
                                // Tipos como Oficina (ID 9) ou Lava-Jato (ID 12)
                                html += `<div><strong>${demanda.de_tipodemanda || tipoConfig.descricao}</strong></div>`;
                                if (demanda.destino) {
                                    html += `<div>${demanda.destino}</div>`;
                                }
                            }
                            else if (isCedencia) {
                                // Tipo Ced√™ncia (ID 10)
                                html += `<div><strong>${demanda.de_tipodemanda || tipoConfig.descricao}</strong></div>`;
                                if (demanda.nm_motorista) {
                                    html += `<div class="cell-divider"></div>`;
                                    html += `<div><strong>${demanda.nm_motorista}</strong></div>`;
                                }
                                if (demanda.setor) {
                                    html += `<div><strong>${demanda.setor}</strong></div>`;
                                }
                                if (demanda.nu_sei) {
                                    html += `<div>${demanda.nu_sei}</div>`;
                                }
                            }
                            else if (demanda.horario) {
                                // Qualquer tipo com hor√°rio definido
                                html += `<div><strong>${demanda.setor || ''}</strong>${demanda.solicitante ? ' (' + encurtarNomeSolicitante(demanda.solicitante) + ')' : ''}</div>`;
                                html += `<div>${demanda.destino || ''} <span class="demanda-horario">(${demanda.horario})</span></div>`;
                                html += `<div>${demanda.nu_sei || ''}</div>`;
                            }
                            else {
                                // Padr√£o para outros tipos
                                html += `<div><strong>${demanda.setor || ''}</strong>${demanda.solicitante ? ' (' + encurtarNomeSolicitante(demanda.solicitante) + ')' : ''}</div>`;
                                html += `<div><strong>${demanda.destino || ''}</strong></div>`;
                                html += `<div>${demanda.nu_sei || ''}</div>`;
                            }
                            
                            // Exibir aviso "INFORMAR VE√çCULO" se necess√°rio
                            const deveMostrarAvisoVeiculo = !demanda.id_tipoveiculo && 
                                                            tipoConfig && 
                                                            !tipoConfig.bloquear_tipo_veiculo && 
                                                            !tipoConfig.bloquear_veiculo;
                            
                            if (deveMostrarAvisoVeiculo) {
                                html += '<div class="informar-veiculo">(INFORMAR VE√çCULO)</div>';
                            }
                            
                            // ===== NOVO: Exibir aviso "DI√ÅRIA N√ÉO SOLICITADA" para viagens de terceirizados =====
                            const ehViagem = demanda.id_tipodemanda === 2;
                            const ehTerceirizado = m.tipo === 'Terceirizado';
                            
                            if (ehViagem && ehTerceirizado && dadosAgenda.diarias_terceirizados) {
                                // Verificar se tem di√°ria e se FL_EMAIL = 'N'
                                const diaria = dadosAgenda.diarias_terceirizados.find(d => d.id_ad === demanda.id);
                                
                                if (diaria && diaria.fl_email === 'N') {
                                    html += '<div class="diaria-nao-solicitada">(DI√ÅRIA N√ÉO SOLICITADA)</div>';
                                }
                            }
                            
                            html += '</div></td>';
                            celulasRenderizadas[linhaIndex][diaIndex] = true;
                            
                        } else {
                            // N√£o tem demanda - calcular rowspan (mesclar com c√©lulas vazias abaixo)
                            let rowspanCount = 1;
                            
                            // Contar quantas linhas abaixo tamb√©m n√£o t√™m demanda para este dia
                            for (let proxLinha = linhaIndex + 1; proxLinha < maxDemandasPorDia; proxLinha++) {
                                if (!demandasDia[proxLinha]) {
                                    rowspanCount++;
                                    celulasRenderizadas[proxLinha][diaIndex] = true;
                                } else {
                                    break;
                                }
                            }
                            
                            // Renderizar c√©lula vazia com rowspan
                            if (feriado) {
                                if (linhaIndex === 0 && demandasDia.length === 0) {
                                    html += `<td class="cell-feriado col-dia" ${rowspanCount > 1 ? `rowspan="${rowspanCount}"` : ''} onclick="handleClickCelulaVazia(event, '${dia.data}', ${m.id}, null, this, 'motoristas')">${feriado.descricao}</td>`;
                                } else {
                                    html += `<td class="cell-feriado col-dia" ${rowspanCount > 1 ? `rowspan="${rowspanCount}"` : ''}>${feriado.descricao}</td>`;
                                }
                            } else {
                                const weekendClass = isWeekend ? 'weekend-empty' : '';
                                if (linhaIndex === 0 && demandasDia.length === 0) {
                                    html += `<td class="empty-cell ${weekendClass} col-dia" ${rowspanCount > 1 ? `rowspan="${rowspanCount}"` : ''} onclick="handleClickCelulaVazia(event, '${dia.data}', ${m.id}, null, this, 'motoristas')"></td>`;
                                } else {
                                    html += `<td class="empty-cell ${weekendClass} col-dia" ${rowspanCount > 1 ? `rowspan="${rowspanCount}"` : ''}></td>`;
                                }
                            }
                            celulasRenderizadas[linhaIndex][diaIndex] = true;
                        }
                    }
                    
                    html += '</tr>';
                }
            });
            
            html += '</tbody></table></div>';
            return html;
        }

        function renderizarSecaoAdministrativo(dias) {
            // Se n√£o houver motoristas administrativos, n√£o renderizar a se√ß√£o
            if (motoristasAdministrativo.length === 0) {
                return '';
            }
            
            let html = '<div class="agenda-section">';
            html += `
                <div class="section-header">
                    <span>üëî SEGEOP - ADMINISTRATIVO</span>
                    <button class="btn-visualizar" onclick="abrirVisualizacaoSecao('administrativo')">üëÅÔ∏è Visualizar</button>
                </div>
            `;
            html += '<table class="agenda-table"><thead><tr>';
            html += '<th class="col-numero">N.</th><th class="col-nome">Nome</th>';
            dias.forEach(d => html += `<th class="col-dia">${d.diaNome}<br>${d.diaNum}/${d.mes}</th>`);
            html += '</tr></thead><tbody>';
            
            motoristasAdministrativo.forEach((m, motoristaGlobalIndex) => {
                const demandasPorDia = dias.map(dia => {
                    return dadosAgenda.demandas.filter(d => 
                        d.id_motorista === m.id && 
                        d.dt_inicio <= dia.data && 
                        d.dt_fim >= dia.data
                    );
                });
                
                const maxDemandasPorDia = Math.max(...demandasPorDia.map(d => d.length), 1);
                const celulasRenderizadas = Array(maxDemandasPorDia).fill(0).map(() => Array(dias.length).fill(false));
                
                for (let linhaIndex = 0; linhaIndex < maxDemandasPorDia; linhaIndex++) {
                    html += `<tr>`;
                    
                    if (linhaIndex === 0) {
                        if (maxDemandasPorDia > 1) {
                            html += `<td class="col-numero" rowspan="${maxDemandasPorDia}">${motoristaGlobalIndex + 1}</td>`;
                            html += `<td class="col-nome" rowspan="${maxDemandasPorDia}">${m.nome}</td>`;
                        } else {
                            html += `<td class="col-numero">${motoristaGlobalIndex + 1}</td>`;
                            html += `<td class="col-nome">${m.nome}</td>`;
                        }
                    }
                    
                    for (let diaIndex = 0; diaIndex < dias.length; diaIndex++) {
                        if (celulasRenderizadas[linhaIndex][diaIndex]) continue;
                        
                        const dia = dias[diaIndex];
                        const feriado = isFeriado(dia.data);
                        const isWeekend = dia.diaIndex === 0 || dia.diaIndex === 6;
                        const demandasDia = demandasPorDia[diaIndex];
                        
                        const demanda = demandasDia[linhaIndex];
                        
                        if (demanda) {
                            let rowspanCount = 1;
                            
                            for (let proxLinha = linhaIndex + 1; proxLinha < maxDemandasPorDia; proxLinha++) {
                                if (!demandasDia[proxLinha]) {
                                    rowspanCount++;
                                    celulasRenderizadas[proxLinha][diaIndex] = true;
                                } else {
                                    break;
                                }
                            }
                            
                            const corClass = `tipo-${demanda.id_tipodemanda}`;
                            const feriadoClass = feriado ? 'cell-feriado-com-demanda' : '';
                            html += `<td class="${corClass} ${feriadoClass} col-dia" ${rowspanCount > 1 ? `rowspan="${rowspanCount}"` : ''} data-id-demanda="${demanda.id}" onclick="handleCellClick(event, ${demanda.id})" onmouseenter="mostrarTooltipVeiculo(event, ${demanda.id})" onmousemove="posicionarTooltip(event)" onmouseleave="esconderTooltipVeiculo()">`;
                            
                            html += '<div class="cell-content">';
                            
                            const tipoConfig = tiposDemandaConfig[demanda.id_tipodemanda];
                            const bloqueiaSetorSolicitante = tipoConfig && tipoConfig.bloquear_setor && tipoConfig.bloquear_solicitante;
                            const isCedencia = tipoConfig && tipoConfig.setor_obrigatorio && !tipoConfig.bloquear_setor;
                            
                            if (bloqueiaSetorSolicitante) {
                                html += `<div><strong>${demanda.de_tipodemanda || tipoConfig.descricao}</strong></div>`;
                                if (demanda.destino) {
                                    html += `<div>${demanda.destino}</div>`;
                                }
                            }
                            else if (isCedencia) {
                                html += `<div><strong>${demanda.de_tipodemanda || tipoConfig.descricao}</strong></div>`;
                                if (demanda.nm_motorista) {
                                    html += `<div class="cell-divider"></div>`;
                                    html += `<div><strong>${demanda.nm_motorista}</strong></div>`;
                                }
                                if (demanda.setor) {
                                    html += `<div><strong>${demanda.setor}</strong></div>`;
                                }
                                if (demanda.nu_sei) {
                                    html += `<div>${demanda.nu_sei}</div>`;
                                }
                            }
                            else if (demanda.horario) {
                                // html += `<div><strong>${demanda.setor || ''}</strong>${demanda.solicitante ? ' (' + demanda.solicitante + ')' : ''}</div>`;
                                html += `<div><strong>${demanda.setor || ''}</strong>${demanda.solicitante ? ' (' + encurtarNomeSolicitante(demanda.solicitante) + ')' : ''}</div>`;
                                html += `<div>${demanda.destino || ''} <span class="demanda-horario">(${demanda.horario})</span></div>`;
                                html += `<div>${demanda.nu_sei || ''}</div>`;
                            }
                            else {
                                // html += `<div><strong>${demanda.setor || ''}</strong>${demanda.solicitante ? ' (' + demanda.solicitante + ')' : ''}</div>`;
                                html += `<div><strong>${demanda.setor || ''}</strong>${demanda.solicitante ? ' (' + encurtarNomeSolicitante(demanda.solicitante) + ')' : ''}</div>`;
                                html += `<div><strong>${demanda.destino || ''}</strong></div>`;
                                html += `<div>${demanda.nu_sei || ''}</div>`;
                            }
                            
                            const deveMostrarAvisoVeiculo = !demanda.id_tipoveiculo && 
                                                            tipoConfig && 
                                                            !tipoConfig.bloquear_tipo_veiculo && 
                                                            !tipoConfig.bloquear_veiculo;
                            
                            if (deveMostrarAvisoVeiculo) {
                                html += '<div class="informar-veiculo">(INFORMAR VE√çCULO)</div>';
                            }
                            
                            html += '</div></td>';
                            celulasRenderizadas[linhaIndex][diaIndex] = true;
                            
                        } else {
                            let rowspanCount = 1;
                            
                            for (let proxLinha = linhaIndex + 1; proxLinha < maxDemandasPorDia; proxLinha++) {
                                if (!demandasDia[proxLinha]) {
                                    rowspanCount++;
                                    celulasRenderizadas[proxLinha][diaIndex] = true;
                                } else {
                                    break;
                                }
                            }
                            
                            if (feriado) {
                                if (linhaIndex === 0 && demandasDia.length === 0) {
                                    html += `<td class="cell-feriado col-dia" ${rowspanCount > 1 ? `rowspan="${rowspanCount}"` : ''} onclick="handleClickCelulaVazia(event, '${dia.data}', ${m.id}, null, this, 'administrativo')">${feriado.descricao}</td>`;
                                } else {
                                    html += `<td class="cell-feriado col-dia" ${rowspanCount > 1 ? `rowspan="${rowspanCount}"` : ''}>${feriado.descricao}</td>`;
                                }
                            } else {
                                const weekendClass = isWeekend ? 'weekend-empty' : '';
                                if (linhaIndex === 0 && demandasDia.length === 0) {
                                    html += `<td class="empty-cell ${weekendClass} col-dia" ${rowspanCount > 1 ? `rowspan="${rowspanCount}"` : ''} onclick="handleClickCelulaVazia(event, '${dia.data}', ${m.id}, null, this, 'administrativo')"></td>`;
                                } else {
                                    html += `<td class="empty-cell ${weekendClass} col-dia" ${rowspanCount > 1 ? `rowspan="${rowspanCount}"` : ''}></td>`;
                                }
                            }
                            celulasRenderizadas[linhaIndex][diaIndex] = true;
                        }
                    }
                    
                    html += '</tr>';
                }
            });
            
            html += '</tbody></table></div>';
            return html;
        }        
        
        
        function renderizarSecaoOutrosMotoristas(dias) {
            // Se n√£o houver outros motoristas com demandas, n√£o renderizar a se√ß√£o
            if (outrosMotoristas.length === 0) {
                return '';
            }
            
            let html = '<div class="agenda-section">';
            html += `
                <div class="section-header">
                    <span>üë≤ OUTROS MOTORISTAS</span>
                    <button class="btn-visualizar" onclick="abrirVisualizacaoSecao('outros-motoristas')">üëÅÔ∏è Visualizar</button>
                </div>
            `;
            html += '<table class="agenda-table"><thead><tr>';
            html += '<th class="col-numero">N.</th><th class="col-nome">Nome</th>';
            dias.forEach(d => html += `<th class="col-dia">${d.diaNome}<br>${d.diaNum}/${d.mes}</th>`);
            html += '</tr></thead><tbody>';
            
            outrosMotoristas.forEach((m, motoristaGlobalIndex) => {
                // Para cada dia, verificar quantas demandas diferentes existem
                const demandasPorDia = dias.map(dia => {
                    return dadosAgenda.demandas.filter(d => 
                        d.id_motorista === m.id && 
                        d.dt_inicio <= dia.data && 
                        d.dt_fim >= dia.data
                    );
                });
                
                const maxDemandasPorDia = Math.max(...demandasPorDia.map(d => d.length), 1);
                
                // Criar matriz de controle de c√©lulas
                const celulasRenderizadas = Array(maxDemandasPorDia).fill(0).map(() => Array(dias.length).fill(false));
                
                // Renderizar cada linha deste motorista
                for (let linhaIndex = 0; linhaIndex < maxDemandasPorDia; linhaIndex++) {
                    html += `<tr>`;
                    
                    // Mostrar n√∫mero e nome apenas na primeira linha
                    if (linhaIndex === 0) {
                        // Buscar setor da primeira demanda deste motorista
                        const primeiraDemanada = dadosAgenda.demandas.find(d => d.id_motorista === m.id);
                        const setor = primeiraDemanada ? primeiraDemanada.setor : '';
                        
                        if (maxDemandasPorDia > 1) {
                            html += `<td class="col-numero" rowspan="${maxDemandasPorDia}">${motoristaGlobalIndex + 1}</td>`;
                            html += `<td class="col-nome" rowspan="${maxDemandasPorDia}">`;
                            html += `<div>${m.nome}</div>`;
                            if (setor) {
                                html += `<div style="font-size: 11px; color: #666; font-weight: normal;"><strong>${setor}</strong></div>`;
                            }
                            html += `</td>`;
                        } else {
                            html += `<td class="col-numero">${motoristaGlobalIndex + 1}</td>`;
                            html += `<td class="col-nome">`;
                            html += `<div>${m.nome}</div>`;
                            if (setor) {
                                html += `<div style="font-size: 11px; color: #666; font-weight: normal;"><strong>${setor}</strong></div>`;
                            }
                            html += `</td>`;
                        }
                    }
                    
                    // Renderizar c√©lulas de cada dia
                    for (let diaIndex = 0; diaIndex < dias.length; diaIndex++) {
                        if (celulasRenderizadas[linhaIndex][diaIndex]) continue;
                        
                        const dia = dias[diaIndex];
                        const feriado = isFeriado(dia.data);
                        const isWeekend = dia.diaIndex === 0 || dia.diaIndex === 6;
                        const demandasDia = demandasPorDia[diaIndex];
                        
                        const demanda = demandasDia[linhaIndex];
                        
                        if (demanda) {
                            let rowspanCount = 1;
                            
                            for (let proxLinha = linhaIndex + 1; proxLinha < maxDemandasPorDia; proxLinha++) {
                                if (!demandasDia[proxLinha]) {
                                    rowspanCount++;
                                    celulasRenderizadas[proxLinha][diaIndex] = true;
                                } else {
                                    break;
                                }
                            }
                            
                            const corClass = `tipo-${demanda.id_tipodemanda}`;
                            const feriadoClass = feriado ? 'cell-feriado-com-demanda' : '';
                            html += `<td class="${corClass} ${feriadoClass} col-dia" ${rowspanCount > 1 ? `rowspan="${rowspanCount}"` : ''} data-id-demanda="${demanda.id}" onclick="handleCellClick(event, ${demanda.id})" onmouseenter="mostrarTooltipVeiculo(event, ${demanda.id})" onmousemove="posicionarTooltip(event)" onmouseleave="esconderTooltipVeiculo()">`;
                            html += '<div class="cell-content">';
                            
                            // ========== L√ìGICA DIN√ÇMICA ==========
                            const tipoConfig = tiposDemandaConfig[demanda.id_tipodemanda];
                            
                            const bloqueiaSetorSolicitante = tipoConfig && tipoConfig.bloquear_setor && tipoConfig.bloquear_solicitante;
                            const isCedencia = tipoConfig && tipoConfig.setor_obrigatorio && !tipoConfig.bloquear_setor;
                            
                            if (bloqueiaSetorSolicitante) {
                                html += `<div>${demanda.de_tipodemanda || tipoConfig.descricao}</div>`;
                                if (demanda.destino) {
                                    html += `<div>${demanda.destino}</div>`;
                                }
                            }
                            else if (isCedencia) {
                                html += `<div><strong>${demanda.de_tipodemanda || tipoConfig.descricao}</strong></div>`;
                                if (demanda.setor) {
                                    html += `<div><strong>${demanda.setor}</strong></div>`;
                                }
                                if (demanda.nu_sei) {
                                    html += `<div>${demanda.nu_sei}</div>`;
                                }
                            }
                            else if (demanda.horario) {
                                // html += `<div><strong>${demanda.setor || ''}</strong>${demanda.solicitante ? ' (' + demanda.solicitante + ')' : ''}</div>`;
                                html += `<div><strong>${demanda.setor || ''}</strong>${demanda.solicitante ? ' (' + encurtarNomeSolicitante(demanda.solicitante) + ')' : ''}</div>`;
                                html += `<div>${demanda.destino || ''} <span class="demanda-horario">(${demanda.horario})</span></div>`;
                                html += `<div>${demanda.nu_sei || ''}</div>`;
                            }
                            else {
                                // html += `<div><strong>${demanda.setor || ''}</strong>${demanda.solicitante ? ' (' + demanda.solicitante + ')' : ''}</div>`;
                                html += `<div><strong>${demanda.setor || ''}</strong>${demanda.solicitante ? ' (' + encurtarNomeSolicitante(demanda.solicitante) + ')' : ''}</div>`;
                                html += `<div>${demanda.destino || ''}</div>`;
                                html += `<div>${demanda.nu_sei || ''}</div>`;
                            }
                            
                            const deveMostrarAvisoVeiculo = !demanda.id_tipoveiculo && 
                                                            tipoConfig && 
                                                            !tipoConfig.bloquear_tipo_veiculo && 
                                                            !tipoConfig.bloquear_veiculo;
                            
                            if (deveMostrarAvisoVeiculo) {
                                html += '<div class="informar-veiculo">(INFORMAR VE√çCULO)</div>';
                            }
                            
                            html += '</div></td>';
                            celulasRenderizadas[linhaIndex][diaIndex] = true;
                            
                        } else {
                            let rowspanCount = 1;
                            
                            for (let proxLinha = linhaIndex + 1; proxLinha < maxDemandasPorDia; proxLinha++) {
                                if (!demandasDia[proxLinha]) {
                                    rowspanCount++;
                                    celulasRenderizadas[proxLinha][diaIndex] = true;
                                } else {
                                    break;
                                }
                            }
                            
                            if (feriado) {
                                if (linhaIndex === 0 && demandasDia.length === 0) {
                                    html += `<td class="cell-feriado col-dia" ${rowspanCount > 1 ? `rowspan="${rowspanCount}"` : ''} onclick="abrirModalNovoComData('${dia.data}', ${m.id}, 'outros')">${feriado.descricao}</td>`;
                                } else {
                                    html += `<td class="cell-feriado col-dia" ${rowspanCount > 1 ? `rowspan="${rowspanCount}"` : ''}>${feriado.descricao}</td>`;
                                }
                            } else {
                                const weekendClass = isWeekend ? 'weekend-empty' : '';
                                if (linhaIndex === 0 && demandasDia.length === 0) {
                                    html += `<td class="empty-cell ${weekendClass} col-dia" ${rowspanCount > 1 ? `rowspan="${rowspanCount}"` : ''} onclick="abrirModalNovoComData('${dia.data}', ${m.id}, 'outros')"></td>`;
                                } else {
                                    html += `<td class="empty-cell ${weekendClass} col-dia" ${rowspanCount > 1 ? `rowspan="${rowspanCount}"` : ''}></td>`;
                                }
                            }
                            celulasRenderizadas[linhaIndex][diaIndex] = true;
                        }
                    }
                    
                    html += '</tr>';
                }
            });
            
            html += '</tbody></table></div>';
            return html;
        }
        
        function handleCellClick(event, idDemanda) {
            event.stopPropagation();
            const cell = event.currentTarget;
            
            // Se a c√©lula clicada j√° est√° selecionada, abre o modal de edi√ß√£o
            if (cell.classList.contains('cell-selected')) {
                abrirModalEditar(idDemanda);
                return;
            }
            
            // Remove sele√ß√£o anterior
            if (celulaSelecionada) {
                celulaSelecionada.classList.remove('cell-selected');
            }
            
            // Seleciona a c√©lula atual
            cell.classList.add('cell-selected');
            celulaSelecionada = cell;
        }
        
        // Fun√ß√£o para validar se um intervalo est√° completamente vazio (incluindo verifica√ß√£o de demandas entre as datas)
        function validarIntervaloVazio(linhaElement, dtInicio, dtFim) {
            const celulas = linhaElement.querySelectorAll('td.col-dia');
            
            const dataInicioObj = new Date(dtInicio + 'T00:00:00');
            const dataFimObj = new Date(dtFim + 'T00:00:00');
            
            // Verificar TODAS as c√©lulas entre as datas selecionadas
            for (let celula of celulas) {
                // Verificar c√©lulas vazias (com onclick de c√©lula vazia)
                const onclickAttr = celula.getAttribute('onclick');
                if (onclickAttr && onclickAttr.includes('handleClickCelulaVazia')) {
                    const matchData = onclickAttr.match(/'(\d{4}-\d{2}-\d{2})'/);
                    if (matchData) {
                        const dataCell = matchData[1];
                        const dataCellObj = new Date(dataCell + 'T00:00:00');
                        
                        // Se est√° no intervalo, verificar se √© c√©lula vazia OU feriado sem demanda
                        if (dataCellObj >= dataInicioObj && dataCellObj <= dataFimObj) {
                            const isEmptyCell = celula.classList.contains('empty-cell');
                            const isFeriadoCell = celula.classList.contains('cell-feriado');
                            
                            // Aceita se for c√©lula vazia comum OU feriado (sem demanda)
                            if (!isEmptyCell && !isFeriadoCell) {
                                return false; // C√©lula n√£o est√° vazia nem √© feriado
                            }
                        }
                    }
                }
                
                // Verificar c√©lulas com demanda (com data-id-demanda)
                const idDemanda = celula.getAttribute('data-id-demanda');
                if (idDemanda) {
                    // Encontrou uma c√©lula com demanda, verificar se est√° no intervalo
                    const demanda = dadosAgenda.demandas.find(d => d.id == idDemanda);
                    if (demanda) {
                        const demandaInicio = new Date(demanda.dt_inicio + 'T00:00:00');
                        const demandaFim = new Date(demanda.dt_fim + 'T00:00:00');
                        
                        // Verificar se a demanda se sobrep√µe ao intervalo selecionado
                        // Sobrep√µe se: (demanda come√ßa antes do fim do intervalo) E (demanda termina depois do in√≠cio do intervalo)
                        if (demandaInicio <= dataFimObj && demandaFim >= dataInicioObj) {
                            return false; // H√° sobreposi√ß√£o com demanda
                        }
                    }
                }
            }
            
            return true; // Intervalo completamente vazio (pode ter feriados sem demanda)
        }            

        async function handleClickCelulaVazia(event, data, idMotorista, idVeiculo, elementoCelula, secao = null) {
            event.stopPropagation();
            
            // Se Ctrl N√ÉO est√° pressionado, comportamento normal
            if (!modoSelecaoIntervalo) {
                // ========== NOVA VALIDA√á√ÉO ANTES DE ABRIR MODAL ==========
                
                // Validar MOTORISTA
                if (idMotorista) {
                    try {
                        const resConflito = await fetch(`/api/agenda/verificar-conflito-motorista?id_motorista=${idMotorista}&dt_inicio=${data}&dt_fim=${data}`);
                        const resultConflito = await resConflito.json();
                        
                        if (resultConflito.tem_conflito) {
                            // Mostrar alerta com detalhes do conflito
                            const demandas = resultConflito.demandas_conflitantes;
                            let mensagem = `‚ö†Ô∏è <strong>ATEN√á√ÉO:</strong> Este motorista j√° possui ${demandas.length} demanda(s) nesta data:<br><br>`;
                            
                            demandas.forEach((d, index) => {
                                const periodo = d.dt_inicio === d.dt_fim 
                                    ? new Date(d.dt_inicio + 'T00:00:00').toLocaleDateString('pt-BR')
                                    : `${new Date(d.dt_inicio + 'T00:00:00').toLocaleDateString('pt-BR')} a ${new Date(d.dt_fim + 'T00:00:00').toLocaleDateString('pt-BR')}`;
                                
                                mensagem += `üìå <strong>${d.tipo_demanda || 'Demanda'}</strong><br>`;
                                mensagem += `   Per√≠odo: ${periodo}<br>`;
                                if (d.setor) mensagem += `   Setor: ${d.setor}<br>`;
                                if (d.destino) mensagem += `   Destino: ${d.destino}<br>`;
                                if (d.nu_sei) mensagem += `   SEI: ${d.nu_sei}<br>`;
                                if (index < demandas.length - 1) mensagem += `<br>`;
                            });
                            
                            mensagem += `<br><strong>N√£o √© poss√≠vel criar demanda sobreposta.</strong>`;
                            
                            // Destacar c√©lula com conflito
                            elementoCelula.classList.add('cell-conflito');
                            setTimeout(() => {
                                elementoCelula.classList.remove('cell-conflito');
                            }, 3000);
                            
                            mostrarAlerta(mensagem, '‚ö†Ô∏è Conflito Detectado', '#ffc107');
                            return;
                        }
                    } catch (error) {
                        console.error('Erro ao verificar conflito de motorista:', error);
                    }
                }
                
                // Validar VE√çCULO
                if (idVeiculo) {
                    try {
                        const resConflito = await fetch(`/api/agenda/verificar-conflito-veiculo?id_veiculo=${idVeiculo}&dt_inicio=${data}&dt_fim=${data}&tem_horario=false`);
                        const resultConflito = await resConflito.json();
                        
                        if (resultConflito.tem_conflito) {
                            const demandas = resultConflito.demandas_conflitantes;
                            let mensagem = `‚ö†Ô∏è <strong>ATEN√á√ÉO:</strong> Este ve√≠culo j√° possui ${demandas.length} demanda(s) SEM hor√°rio nesta data:<br><br>`;
                            
                            demandas.forEach((d, index) => {
                                const periodo = d.dt_inicio === d.dt_fim 
                                    ? new Date(d.dt_inicio + 'T00:00:00').toLocaleDateString('pt-BR')
                                    : `${new Date(d.dt_inicio + 'T00:00:00').toLocaleDateString('pt-BR')} a ${new Date(d.dt_fim + 'T00:00:00').toLocaleDateString('pt-BR')}`;
                                
                                mensagem += `üìå <strong>${d.tipo_demanda || 'Demanda'}</strong><br>`;
                                mensagem += `   Motorista: ${d.motorista || 'N√£o informado'}<br>`;
                                mensagem += `   Per√≠odo: ${periodo}<br>`;
                                if (d.setor) mensagem += `   Setor: ${d.setor}<br>`;
                                if (d.destino) mensagem += `   Destino: ${d.destino}<br>`;
                                if (index < demandas.length - 1) mensagem += `<br>`;
                            });
                            
                            mensagem += `<br><strong>N√£o √© poss√≠vel criar demanda sobreposta SEM hor√°rio.</strong><br>`;
                            mensagem += `<em>Dica: Se for criar demanda COM hor√°rio definido, isso ser√° permitido.</em>`;
                            
                            // Destacar c√©lula com conflito
                            elementoCelula.classList.add('cell-conflito');
                            setTimeout(() => {
                                elementoCelula.classList.remove('cell-conflito');
                            }, 3000);
                            
                            mostrarAlerta(mensagem, '‚ö†Ô∏è Conflito Detectado', '#ffc107');
                            return;
                        }
                    } catch (error) {
                        console.error('Erro ao verificar conflito de ve√≠culo:', error);
                    }
                }
                
                // ========== FIM DA VALIDA√á√ÉO ==========
                
                // Se passou pelas valida√ß√µes, abrir modal normalmente
                if (idMotorista) {
                    abrirModalNovoComData(data, idMotorista, secao);
                } else if (idVeiculo) {
                    abrirModalNovoComVeiculo(data, idVeiculo);
                }
                return;
            }
            
            // === MODO SELE√á√ÉO DE INTERVALO ATIVO ===
            
            // Verificar se √© da mesma linha
            const linhaClicada = elementoCelula.parentElement;
            
            if (!primeiraDataSelecionada) {
                // PRIMEIRO CLIQUE
                primeiraDataSelecionada = data;
                linhaAtualSelecao = linhaClicada;
                
                // Marcar c√©lula
                elementoCelula.classList.add('cell-intervalo-selecionado');
                celulasIntervalo.push(elementoCelula);
                
            } else if (linhaClicada === linhaAtualSelecao) {
                // SEGUNDO CLIQUE NA MESMA LINHA
                segundaDataSelecionada = data;
                
                // Determinar qual √© a data inicial e final (ordem cronol√≥gica)
                const data1 = new Date(primeiraDataSelecionada + 'T00:00:00');
                const data2 = new Date(segundaDataSelecionada + 'T00:00:00');
                
                let dtInicio, dtFim;
                if (data1 <= data2) {
                    dtInicio = primeiraDataSelecionada;
                    dtFim = segundaDataSelecionada;
                } else {
                    dtInicio = segundaDataSelecionada;
                    dtFim = primeiraDataSelecionada;
                }
                
                // ====== VALIDAR SE O INTERVALO EST√Å COMPLETAMENTE VAZIO ======
                if (!validarIntervaloVazio(linhaAtualSelecao, dtInicio, dtFim)) {
                    // Intervalo cont√©m demandas - n√£o permitir
                    mostrarAlerta(
                        'N√£o √© poss√≠vel selecionar este intervalo pois h√° demandas entre as datas selecionadas.<br><br>' +
                        '<strong>Regra:</strong> N√£o √© permitido criar demandas que atravessem per√≠odos j√° ocupados.',
                        '‚ö†Ô∏è Intervalo Inv√°lido',
                        '#ffc107'
                    );
                    limparSelecaoIntervalo();
                    return;
                }
                // ====== FIM DA VALIDA√á√ÉO ======
                
                // Marcar todas as c√©lulas do intervalo (feedback visual r√°pido)
                marcarIntervaloCelulas(linhaAtualSelecao, dtInicio, dtFim);
                
                // Pequeno delay para mostrar as c√©lulas marcadas antes de abrir o modal
                setTimeout(() => {
                    // Abrir modal com as datas preenchidas
                    if (idMotorista) {
                        abrirModalNovoComIntervalo(dtInicio, dtFim, idMotorista, null, secao);
                    } else if (idVeiculo) {
                        abrirModalNovoComIntervalo(dtInicio, dtFim, null, idVeiculo);
                    }
                    
                    // Limpar sele√ß√£o ap√≥s abrir modal
                    setTimeout(() => {
                        limparSelecaoIntervalo();
                    }, 100);
                }, 200);
                
            } else {
                // CLICOU EM LINHA DIFERENTE - resetar
                limparSelecaoIntervalo();
            }
        }            
        
        
        function renderizarSecaoVeiculos(dias) {
            let html = '<div class="agenda-section">';
            html += `
                <div class="section-header">
                    <span>üöô SEGEOP - VE√çCULOS OFICIAIS</span>
                    <button class="btn-visualizar" onclick="abrirVisualizacaoSecao('veiculos')">üëÅÔ∏è Visualizar</button>
                </div>
            `;
            html += '<table class="agenda-table"><thead><tr>';
            html += '<th class="col-numero">N.</th><th class="col-nome">Ve√≠culo</th>';
            dias.forEach(d => html += `<th class="col-dia">${d.diaNome}<br>${d.diaNum}/${d.mes}</th>`);
            html += '</tr></thead><tbody>';
            
            // Combinar ve√≠culos padr√£o com extras que t√™m demandas
            const todosVeiculos = [...veiculos];
            
            // Adicionar ve√≠culos extras que t√™m demandas na semana atual
            veiculosExtras.forEach(vExtra => {
                const temDemanda = dadosAgenda.demandas.some(d => 
                    d.id_veiculo === vExtra.id &&
                    dias.some(dia => d.dt_inicio <= dia.data && d.dt_fim >= dia.data)
                );
                
                if (temDemanda) {
                    todosVeiculos.push({
                        ...vExtra,
                        isExtra: true
                    });
                }
            });
            
            todosVeiculos.forEach((v, veiculoGlobalIndex) => {
                const extraClass = v.isExtra ? 'veiculo-extra' : '';
                
                const demandasPorDia = dias.map(dia => {
                    return dadosAgenda.demandas.filter(d => 
                        d.id_veiculo === v.id && 
                        d.dt_inicio <= dia.data && 
                        d.dt_fim >= dia.data
                    );
                });
                
                const maxDemandasPorDia = Math.max(...demandasPorDia.map(d => d.length), 1);
                const celulasRenderizadas = Array(maxDemandasPorDia).fill(0).map(() => Array(dias.length).fill(false));
                
                for (let linhaIndex = 0; linhaIndex < maxDemandasPorDia; linhaIndex++) {
                    html += `<tr>`;
                    
                    if (linhaIndex === 0) {
                        if (maxDemandasPorDia > 1) {
                            html += `<td class="col-numero ${extraClass}" rowspan="${maxDemandasPorDia}">${veiculoGlobalIndex + 1}</td>`;
                            html += `<td class="col-nome ${extraClass}" rowspan="${maxDemandasPorDia}">${v.veiculo}</td>`;
                        } else {
                            html += `<td class="col-numero ${extraClass}">${veiculoGlobalIndex + 1}</td>`;
                            html += `<td class="col-nome ${extraClass}">${v.veiculo}</td>`;
                        }
                    }
                    
                    for (let diaIndex = 0; diaIndex < dias.length; diaIndex++) {
                        if (celulasRenderizadas[linhaIndex][diaIndex]) continue;
                        
                        const dia = dias[diaIndex];
                        const feriado = isFeriado(dia.data);
                        const isWeekend = dia.diaIndex === 0 || dia.diaIndex === 6;
                        const demandasDia = demandasPorDia[diaIndex];
                        
                        const demanda = demandasDia[linhaIndex];
                        
                        if (demanda) {
                            let rowspanCount = 1;
                            
                            for (let proxLinha = linhaIndex + 1; proxLinha < maxDemandasPorDia; proxLinha++) {
                                if (!demandasDia[proxLinha]) {
                                    rowspanCount++;
                                    celulasRenderizadas[proxLinha][diaIndex] = true;
                                } else {
                                    break;
                                }
                            }
                            
                            const corClass = `tipo-${demanda.id_tipodemanda}`;
                            const feriadoClass = feriado ? 'cell-feriado-com-demanda' : '';
                            html += `<td class="${corClass} ${feriadoClass} col-dia" ${rowspanCount > 1 ? `rowspan="${rowspanCount}"` : ''} onclick="abrirModalEditar(${demanda.id})" onmouseenter="mostrarTooltipPeriodo(event, ${demanda.id})" onmousemove="posicionarTooltip(event)" onmouseleave="esconderTooltipVeiculo()">`;
                            html += '<div class="cell-content-veiculos">';
                            
                            // ========== L√ìGICA DIN√ÇMICA ==========
                            const tipoConfig = tiposDemandaConfig[demanda.id_tipodemanda];
                            
                            const bloqueiaSetorSolicitante = tipoConfig && tipoConfig.bloquear_setor && tipoConfig.bloquear_solicitante;
                            const isCedencia = tipoConfig && tipoConfig.setor_obrigatorio && !tipoConfig.bloquear_setor;
                            const exibeDestinoVeiculo = tipoConfig && tipoConfig.exibir_destino_veiculo;  // ‚≠ê NOVO
                            
                            if (bloqueiaSetorSolicitante) {
                                html += `<div>${demanda.de_tipodemanda || tipoConfig.descricao}</div>`;
                                if (demanda.id_motorista === 0 && demanda.nc_motorista) {
                                    html += `<div class="cell-divider"></div>`;
                                    const nomeAbreviado = abreviarNomeMotorista(demanda.nc_motorista);
                                    html += `<div><strong title="${demanda.nc_motorista}">${nomeAbreviado}</strong></div>`;
                                } else if (demanda.nm_motorista) {
                                    html += `<div class="cell-divider"></div>`;
                                    const nomeAbreviado = abreviarNomeMotorista(demanda.nm_motorista);
                                    html += `<div><strong title="${demanda.nm_motorista}">${nomeAbreviado}</strong></div>`;
                                }
                                if (demanda.destino) {
                                    html += `<div><strong>${demanda.destino}</strong></div>`;
                                }
                            }    
                            else if (isCedencia) {
                                html += `<div>${demanda.de_tipodemanda || tipoConfig.descricao}<strong>${' - ' + demanda.setor || ''}</strong></div>`;
                                if (demanda.nu_sei) {
                                    html += `<div>${demanda.nu_sei}</div>`;
                                }
                            }
                            else if (demanda.horario) {
                                const nomeAbreviado = abreviarNomeMotorista(demanda.nm_motorista || '');
                                html += `<div><strong title="${demanda.nm_motorista || ''}">${nomeAbreviado}</strong></div>`;                                
                                // html += `<div><strong>${demanda.nm_motorista || ''}</strong></div>`;
                                // ‚≠ê NOVO: Exibir destino se configurado
                                if (exibeDestinoVeiculo && demanda.destino) {
                                    html += `<div style="font-size: 10px; color: #666;">${demanda.destino}</div>`;
                                }
                                if (demanda.nu_sei) {
                                    html += `<div>${demanda.nu_sei}</div>`;
                                }
                                if (demanda.destino && !exibeDestinoVeiculo) { // S√≥ exibe com hor√°rio se n√£o foi exibido antes
                                    html += `<div>${demanda.destino} <span class="demanda-horario">(${demanda.horario})</span></div>`;
                                } else if (demanda.horario) {
                                    html += `<div><span class="demanda-horario">(${demanda.horario})</span></div>`;
                                }
                            }
                            else {
                                const nomeAbreviado = abreviarNomeMotorista(demanda.nm_motorista || '');
                                html += `<div><strong title="${demanda.nm_motorista || ''}">${nomeAbreviado}</strong></div>`;
                                // html += `<div><strong>${demanda.nm_motorista || ''}</strong></div>`;
                                // ‚≠ê NOVO: Exibir destino se configurado
                                if (exibeDestinoVeiculo && demanda.destino) {
                                    html += `<div style="font-size: 10px; color: #666;">${demanda.destino}</div>`;
                                }
                                if (demanda.nu_sei) {
                                    html += `<div>${demanda.nu_sei}</div>`;
                                }
                            }
                            
                            html += '</div></td>';
                            celulasRenderizadas[linhaIndex][diaIndex] = true;
                        } else {
                            let rowspanCount = 1;
                            
                            for (let proxLinha = linhaIndex + 1; proxLinha < maxDemandasPorDia; proxLinha++) {
                                if (!demandasDia[proxLinha]) {
                                    rowspanCount++;
                                    celulasRenderizadas[proxLinha][diaIndex] = true;
                                } else {
                                    break;
                                }
                            }
                            
                            if (feriado) {
                                if (linhaIndex === 0 && demandasDia.length === 0) {
                                    html += `<td class="cell-feriado col-dia" ${rowspanCount > 1 ? `rowspan="${rowspanCount}"` : ''} onclick="handleClickCelulaVazia(event, '${dia.data}', null, ${v.id}, this)">${feriado.descricao}</td>`;
                                } else {
                                    html += `<td class="cell-feriado col-dia" ${rowspanCount > 1 ? `rowspan="${rowspanCount}"` : ''}>${feriado.descricao}</td>`;
                                }
                            } else {
                                const weekendClass = isWeekend ? 'weekend-empty' : '';
                                if (linhaIndex === 0 && demandasDia.length === 0) {
                                    html += `<td class="empty-cell ${weekendClass} col-dia" ${rowspanCount > 1 ? `rowspan="${rowspanCount}"` : ''} onclick="handleClickCelulaVazia(event, '${dia.data}', null, ${v.id}, this)"></td>`;
                                } else {
                                    html += `<td class="empty-cell ${weekendClass} col-dia" ${rowspanCount > 1 ? `rowspan="${rowspanCount}"` : ''}></td>`;
                                }
                            }   
                            celulasRenderizadas[linhaIndex][diaIndex] = true;
                        }
                    }
                    
                    html += '</tr>';
                }
            });
            
            html += '</tbody></table></div>';
            return html;
        }

        function renderizarSecaoVeiculosAlocados(dias) {
            const demandasAlocadas = dadosAgenda.demandas.filter(d => d.id_tipoveiculo != 1 && d.id_tipoveiculo !== null);

            if (demandasAlocadas.length === 0) return '';

            const grupos = {};
            demandasAlocadas.forEach(d => {
                const key = `${d.de_tipoveiculo}|${d.nu_sei}|${d.setor}|${d.destino}|${d.id_tipoveiculo}`;
                if (!grupos[key]) {
                    grupos[key] = {
                        de_tipoveiculo: d.de_tipoveiculo,
                        nu_sei: d.nu_sei,
                        setor: d.setor,
                        destino: d.destino,
                        id_tipoveiculo: d.id_tipoveiculo,
                        demandas: []
                    };
                }
                grupos[key].demandas.push(d);
            });

            // ========== ORDENA√á√ÉO DIN√ÇMICA BASEADA EM CONFIGURA√á√ÉO ==========
            const gruposArray = Object.values(grupos);
            gruposArray.sort((a, b) => {
                // Aplicar a mesma l√≥gica do ORDER BY da SQL
                const getPrioridade = (id_tipoveiculo) => {
                    if (id_tipoveiculo === 7) return 1;
                    if (id_tipoveiculo === 8) return 2;
                    if (id_tipoveiculo === 9) return 3;
                    return 4;
                };
                
                const prioridadeA = getPrioridade(a.id_tipoveiculo);
                const prioridadeB = getPrioridade(b.id_tipoveiculo);
                
                // Primeiro: ordenar por prioridade
                if (prioridadeA !== prioridadeB) {
                    return prioridadeA - prioridadeB;
                }
                
                // Segundo: se mesma prioridade, ordenar por ID da primeira demanda (equivalente ao ID_AD ASC)
                const idA = a.demandas[0].id || 0;
                const idB = b.demandas[0].id || 0;
                return idA - idB;
            })

            let html = '<div class="agenda-section">';
            html += `
                <div class="section-header">
                    <span>üöå SEGEOP - VE√çCULOS ALOCADOS</span>
                    <button class="btn-visualizar" onclick="abrirVisualizacaoSecao('veiculos-alocados')">üëÅÔ∏è Visualizar</button>
                </div>
            `;
            html += '<table class="agenda-table"><thead><tr>';
            html += '<th class="col-numero">N.</th><th class="col-nome">Tipo Ve√≠culo / SEI / Destino</th>';
            dias.forEach(d => html += `<th class="col-dia">${d.diaNome}<br>${d.diaNum}/${d.mes}</th>`);
            html += '</tr></thead><tbody>';

            gruposArray.forEach((grupo, index) => {
                // ========== USAR CONFIGURA√á√ÉO PARA VERIFICAR SE √â "ESPECIAL" ==========
                const tipoConfig = tiposDemandaConfig[grupo.id_tipoveiculo];
                const isIdEspecial = tipoConfig && tipoConfig.exibir_checkbox_solicitado;
                
                html += `<tr><td class="col-numero">${index + 1}</td>`;
                html += `<td class="col-nome">`;
                html += `<div><strong>${grupo.de_tipoveiculo}</strong>`;
                
                // ========== BUSCAR ID_ITEM DA LOCA√á√ÉO CORRESPONDENTE ==========
                const locacaoCorrespondente = locacoesAtivas.find(loc => 
                    grupo.demandas.some(d => 
                        d.id_motorista === loc.id_motorista &&
                        d.dt_inicio <= loc.data_fim &&
                        d.dt_fim >= loc.data_inicio
                    )
                );
                
                if (locacaoCorrespondente) {
                    html += ` (ID ${locacaoCorrespondente.id_item})`;
                }
                
                html += `</div>`;
                html += `<div>${grupo.nu_sei || ''}</div>`;
                
                // Montar linha Setor - Destino com setor em negrito
                if (grupo.setor && grupo.destino) {
                    html += `<div><strong>${grupo.setor}</strong> - ${grupo.destino}</div>`;
                } else if (grupo.setor) {
                    html += `<div><strong>${grupo.setor}</strong></div>`;
                } else if (grupo.destino) {
                    html += `<div>${grupo.destino}</div>`;
                }
                
                // Verificar se existe loca√ß√£o finalizada
                const primeiraLocacao = locacoesAtivas.find(loc => 
                    loc.fl_status === 'F' && 
                    grupo.demandas.some(d => d.id_motorista === loc.id_motorista)
                );
                if (primeiraLocacao) {
                    html += `<div style="color: #6c757d; font-size: 11px; margin-top: 3px;">${primeiraLocacao.ds_veiculo_mod}</div>`;
                }
                
                html += `</td>`;
                
                dias.forEach(dia => {
                    const feriado = isFeriado(dia.data);
                    const demandasDia = grupo.demandas.filter(d => 
                        d.dt_inicio <= dia.data && 
                        d.dt_fim >= dia.data
                    );
                    
                    if (demandasDia.length > 0) {
                        const demanda = demandasDia[0];
                        
                        let corClass = '';
                        
                        if (isIdEspecial) {
                            // Para tipos "especiais": verificar se foi solicitado
                            corClass = demanda.solicitado === 'S' ? 'tipo-solicitado' : '';
                        } else {
                            // Para outros tipos: verificar se existe loca√ß√£o
                            const temLocacao = locacoesAtivas.some(loc => 
                                loc.id_motorista === demanda.id_motorista &&
                                loc.data_inicio <= dia.data &&
                                loc.data_fim >= dia.data
                            );
                            corClass = temLocacao ? 'tipo-locacao' : '';
                        }
                        
                        const feriadoClass = feriado ? 'cell-feriado-com-demanda' : '';
                        html += `<td class="${corClass} ${feriadoClass} col-dia" data-id-demanda="${demanda.id}" onclick="handleCellClick(event, ${demanda.id})" onmouseenter="mostrarTooltipPeriodo(event, ${demanda.id})" onmousemove="posicionarTooltip(event)" onmouseleave="esconderTooltipVeiculo()">`;
                        html += '<div class="cell-content-veiculos">';
                        
                        if (isIdEspecial) {
                            // Para tipos "especiais": mostrar DE_TIPODEMANDA em negrito e depois setor
                            html += `<div><strong>${demanda.de_tipodemanda}</strong></div>`;
                            if (demanda.setor) {
                                html += `<div>${demanda.setor}</div>`;
                            }
                            if (demanda.destino) {
                                html += `<div>${demanda.destino}</div>`;
                            }                            
                        } else {
                            // Para outros tipos: mostrar motorista (nome ou NC) e setor
                            // ========== TRATAR MOTORISTA N√ÉO CADASTRADO (nc_motorista) ==========
                            if (demanda.id_motorista === 0 && demanda.nc_motorista) {
                                const nomeAbreviado = abreviarNomeMotorista(demanda.nc_motorista);
                                html += `<div><strong title="${demanda.nc_motorista}">${nomeAbreviado}</strong></div>`;
                            } else if (demanda.nm_motorista) {
                                const nomeAbreviado = abreviarNomeMotorista(demanda.nm_motorista);
                                html += `<div><strong title="${demanda.nm_motorista}">${nomeAbreviado}</strong></div>`;
                            }                            
                            
                            
                            if (demanda.setor) {
                                html += `<div>${demanda.setor}</div>`;
                            }
                        }
                        
                        html += '</div></td>';
                    } else if (feriado) {
                        html += `<td class="cell-feriado col-dia">${feriado.descricao}</td>`;
                    } else {
                        const isWeekend = dia.diaIndex === 0 || dia.diaIndex === 6;
                        const weekendClass = isWeekend ? 'weekend-empty' : '';
                        html += `<td class="empty-cell ${weekendClass} col-dia"></td>`;
                    }
                });
                html += '</tr>';
            });

            html += '</tbody></table></div>';
            return html;
        }
        
        async function abrirModalNovo() {
            document.getElementById('modalTitle').textContent = 'Nova Demanda';
            document.getElementById('idAd').value = '';
            document.getElementById('formDemanda').reset();
            document.getElementById('btnExcluir').style.display = 'none';
            veiculoSelecionadoOriginal = null;
            listaVeiculosExpandida = false;
            
            // Reset de hor√°rio
            document.getElementById('definirHorario').checked = false;
            document.getElementById('definirHorario').disabled = false;
            document.getElementById('horario').value = '';
            document.getElementById('horario').disabled = true;
            
            // Reset checkbox expandir ve√≠culos
            document.getElementById('expandirVeiculos').checked = false;
            document.getElementById('divExpandirVeiculos').style.display = 'none';
            
            // Mostrar filtro e definir SEGEOP como padr√£o
            document.getElementById('motoristaFilter').style.display = 'flex';
            const radios = document.querySelectorAll('input[name="tipoMotorista"]');
            radios.forEach(radio => {
                radio.disabled = false;  // DESBLOQUEAR todos os radios
                if (radio.value === 'segeop') {
                    radio.checked = true;  // Selecionar SEGEOP por padr√£o
                }
            });
                    
            // Ocultar checkbox Solicitado
            document.getElementById('divSolicitado').style.display = 'none';
            document.getElementById('solicitado').checked = false;
            
            // Reset campo motorista n√£o cadastrado
            document.getElementById('divNcMotorista').style.display = 'none';
            document.getElementById('ncMotorista').value = '';
            document.getElementById('ncMotorista').required = false;

            preencherSelectMotoristas('segeop');
            
            // N√ÉO carregar ve√≠culos no in√≠cio
            const selectVeiculo = document.getElementById('idVeiculo');
            selectVeiculo.innerHTML = '<option value="">Selecione...</option>';
            selectVeiculo.disabled = true;
            
            // Resetar labels
            document.getElementById('labelTipoVeiculo').innerHTML = 'Tipo de Ve√≠culo';
            document.getElementById('labelVeiculo').innerHTML = 'Ve√≠culo';
            document.getElementById('labelSetor').innerHTML = 'Setor';
            document.getElementById('labelSolicitante').innerHTML = 'Solicitante';
            document.getElementById('labelDestino').innerHTML = 'Destino';
            
            // Habilitar todos os campos
            document.getElementById('idMotorista').disabled = false;
            document.getElementById('idTipoVeiculo').disabled = false;
            document.getElementById('setor').disabled = false;
            document.getElementById('solicitante').disabled = false;
            document.getElementById('destino').disabled = false;
            
            // Adicionar event listeners para o filtro
            document.querySelectorAll('input[name="tipoMotorista"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    preencherSelectMotoristas(this.value);
                });
            });
            
            document.getElementById('modal').style.display = 'block';
        }
                
        async function abrirModalNovoComData(data, idMotorista = null, secao = null) {
            contextoAbertura = 'motorista'; // Definir ANTES
            await abrirModalNovo();
            await preencherSelectTiposDemanda(); // Carregar depois que contexto est√° definido
            document.getElementById('dtInicio').value = data;
            document.getElementById('dtFim').value = data;
            
            // ========== CORRE√á√ÉO: BLOQUEAR RADIOS BASEADO NA SE√á√ÉO ==========
            const radios = document.querySelectorAll('input[name="tipoMotorista"]');
            
            // Detectar se√ß√£o SEGEOP - MOTORISTAS
            if (secao === 'motoristas' || secao === null) {
                radios.forEach(radio => {
                    if (radio.value === 'segeop') {
                        radio.checked = true;
                        radio.disabled = true;  // Bloquear todos os 3 radios
                    } else {
                        radio.disabled = true;  // Bloquear todos os 3 radios
                    }
                });
                preencherSelectMotoristas('segeop');
            }
            // Detectar se√ß√£o OUTROS MOTORISTAS
            else if (secao === 'outros') {
                radios.forEach(radio => {
                    if (radio.value === 'todos') {
                        radio.checked = true;
                        radio.disabled = true;  // Bloquear todos os 3 radios
                    } else {
                        radio.disabled = true;  // Bloquear todos os 3 radios
                    }
                });
                preencherSelectMotoristas('todos');
            }
            // Detectar se√ß√£o SEGEOP - ADMINISTRATIVO
            else if (secao === 'administrativo') {
                radios.forEach(radio => {
                    if (radio.value === 'administrativo') {
                        radio.checked = true;
                        radio.disabled = true;  // Bloquear todos os 3 radios
                    } else {
                        radio.disabled = true;  // Bloquear todos os 3 radios
                    }
                });
                preencherSelectMotoristas('administrativo');
            }
            // ========== FIM DA CORRE√á√ÉO ==========
            
            if (idMotorista) {
                document.getElementById('idMotorista').value = idMotorista;
            }
        }
        
        async function abrirModalNovoComVeiculo(data, idVeiculo = null) {
            contextoAbertura = 'veiculo'; // Definir ANTES
            await abrirModalNovo();
            await preencherSelectTiposDemanda(); // Carregar depois que contexto est√° definido
            document.getElementById('dtInicio').value = data;
            document.getElementById('dtFim').value = data;
            
            if (idVeiculo) {
                // Guardar o ve√≠culo que ser√° selecionado
                const veiculoObj = veiculos.find(v => v.id === idVeiculo);
                if (veiculoObj) {
                    veiculoSelecionadoOriginal = {
                        id: veiculoObj.id,
                        veiculo: veiculoObj.veiculo
                    };
                }
                
                // Selecionar Tipo de Ve√≠culo = 1 (Ve√≠culo Oficial)
                document.getElementById('idTipoVeiculo').value = '1';
                
                // Aplicar regras e aguardar carregar ve√≠culos dispon√≠veis
                aplicarRegrasTipoVeiculo();
                
                // Aguardar a lista de ve√≠culos ser atualizada e ent√£o selecionar
                setTimeout(async () => {
                    await atualizarVeiculosDisponiveis();
                    document.getElementById('idVeiculo').value = idVeiculo;
                }, 150);
            }
        }
        
        async function abrirModalNovoComIntervalo(dtInicio, dtFim, idMotorista = null, idVeiculo = null, secao = null) {
            if (idMotorista) {
                contextoAbertura = 'motorista';
                await abrirModalNovo();
                await preencherSelectTiposDemanda();
                
                document.getElementById('dtInicio').value = dtInicio;
                document.getElementById('dtFim').value = dtFim;
                
                // ========== CORRE√á√ÉO: BLOQUEAR RADIOS BASEADO NA SE√á√ÉO ==========
                const radios = document.querySelectorAll('input[name="tipoMotorista"]');
                
                // Detectar se√ß√£o SEGEOP - MOTORISTAS
                if (secao === 'motoristas' || secao === null) {
                    radios.forEach(radio => {
                        if (radio.value === 'segeop') {
                            radio.checked = true;
                            radio.disabled = true;  // Bloquear todos os 3 radios
                        } else {
                            radio.disabled = true;  // Bloquear todos os 3 radios
                        }
                    });
                    preencherSelectMotoristas('segeop');
                }
                // Detectar se√ß√£o OUTROS MOTORISTAS
                else if (secao === 'outros') {
                    radios.forEach(radio => {
                        if (radio.value === 'todos') {
                            radio.checked = true;
                            radio.disabled = true;  // Bloquear todos os 3 radios
                        } else {
                            radio.disabled = true;  // Bloquear todos os 3 radios
                        }
                    });
                    preencherSelectMotoristas('todos');
                }
                // Detectar se√ß√£o SEGEOP - ADMINISTRATIVO
                else if (secao === 'administrativo') {
                    radios.forEach(radio => {
                        if (radio.value === 'administrativo') {
                            radio.checked = true;
                            radio.disabled = true;  // Bloquear todos os 3 radios
                        } else {
                            radio.disabled = true;  // Bloquear todos os 3 radios
                        }
                    });
                    preencherSelectMotoristas('administrativo');
                }
                // ========== FIM DA CORRE√á√ÉO ==========
                
                document.getElementById('idMotorista').value = idMotorista;
                
            } else if (idVeiculo) {
                contextoAbertura = 'veiculo';
                await abrirModalNovo();
                await preencherSelectTiposDemanda();
                
                document.getElementById('dtInicio').value = dtInicio;
                document.getElementById('dtFim').value = dtFim;
                
                // Guardar o ve√≠culo que ser√° selecionado
                const veiculoObj = veiculos.find(v => v.id === idVeiculo);
                if (veiculoObj) {
                    veiculoSelecionadoOriginal = {
                        id: veiculoObj.id,
                        veiculo: veiculoObj.veiculo
                    };
                }
                
                // Selecionar Tipo de Ve√≠culo = 1 (Ve√≠culo Oficial)
                document.getElementById('idTipoVeiculo').value = '1';
                aplicarRegrasTipoVeiculo();
                
                // Aguardar e selecionar ve√≠culo
                setTimeout(async () => {
                    await atualizarVeiculosDisponiveis();
                    document.getElementById('idVeiculo').value = idVeiculo;
                }, 150);
            }
        }


        async function abrirModalNovoGeral() {
            // ========== ATUALIZAR LISTAS ANTES DE ABRIR ==========
            mostrarSpinner();
            
            try {
                // Recarregar dados da agenda (motoristas, ve√≠culos, demandas)
                const semana = semanas[semanaAtual];
                const res = await fetch(`/api/agenda/dados?inicio=${semana.inicio}&fim=${semana.fim}`);
                const dados = await res.json();
                
                // Atualizar dados globais
                motoristas = dados.motoristas;
                outrosMotoristas = dados.outros_motoristas || [];
                veiculos = dados.veiculos;
                veiculosExtras = dados.veiculos_extras || [];
                dadosAgenda.todos_motoristas = dados.todos_motoristas;
                dadosAgenda.demandas = dados.demandas;
                
                esconderSpinner();
            } catch (error) {
                esconderSpinner();
                console.error('Erro ao atualizar listas:', error);
                mostrarAlerta('Erro ao atualizar dados. Tente novamente.', '‚ö†Ô∏è Erro', '#dc3545');
                return;
            }
            
            // ========== ABRIR MODAL ==========
            contextoAbertura = null; // Sem contexto espec√≠fico
            await abrirModalNovo();
            await preencherSelectTiposDemanda(); // Carregar todos os tipos
        }

        async function abrirModalEditar(idAd) {
            // Mostrar spinner
            mostrarSpinner();
            
            try {
                const demanda = dadosAgenda.demandas.find(d => d.id === idAd);
                if (!demanda) {
                    esconderSpinner();
                    return;
                }
                
                document.getElementById('modalTitle').textContent = 'Editar Demanda';
                contextoAbertura = null;
                document.getElementById('idAd').value = demanda.id;
                document.getElementById('btnExcluir').style.display = 'inline-block';
                
                // Definir se lista est√° expandida
                listaVeiculosExpandida = demanda.todos_veiculos === 'S';
                
                // Ocultar filtro na edi√ß√£o
                document.getElementById('motoristaFilter').style.display = 'none';
                
                // Guardar ve√≠culo original para manter na lista
                if (demanda.id_veiculo) {
                    // Procurar primeiro nos ve√≠culos padr√£o
                    let veiculoObj = veiculos.find(v => v.id === demanda.id_veiculo);
                    
                    // Se n√£o encontrou, procurar nos ve√≠culos extras
                    if (!veiculoObj) {
                        veiculoObj = veiculosExtras.find(v => v.id === demanda.id_veiculo);
                    }
                    
                    // Se ainda n√£o encontrou, buscar diretamente (caso seja um ve√≠culo que n√£o est√° em nenhuma lista)
                    if (!veiculoObj && dadosAgenda.demandas) {
                        const todasDemandas = dadosAgenda.demandas.filter(d => d.id_veiculo === demanda.id_veiculo);
                        if (todasDemandas.length > 0) {
                            // Criar objeto tempor√°rio com dados da demanda
                            veiculoObj = {
                                id: demanda.id_veiculo,
                                veiculo: `Ve√≠culo ID ${demanda.id_veiculo}` // Placeholder
                            };
                        }
                    }
                    
                    if (veiculoObj) {
                        veiculoSelecionadoOriginal = {
                            id: veiculoObj.id,
                            veiculo: veiculoObj.veiculo
                        };
                    }
                } else {
                    veiculoSelecionadoOriginal = null;
                }
                
                preencherSelectMotoristas('todos');
                
                // Carregar tipos de demanda antes de preencher o formul√°rio
                await preencherSelectTiposDemanda();
                
                document.getElementById('idMotorista').value = demanda.id_motorista || '';
                document.getElementById('dtInicio').value = demanda.dt_inicio;
                document.getElementById('dtFim').value = demanda.dt_fim;
                document.getElementById('idTipoDemanda').value = demanda.id_tipodemanda;
                document.getElementById('idTipoVeiculo').value = demanda.id_tipoveiculo || '';
                document.getElementById('setor').value = demanda.setor || '';
                document.getElementById('solicitante').value = demanda.solicitante || '';
                document.getElementById('destino').value = demanda.destino || '';
                document.getElementById('nuSei').value = demanda.nu_sei || '';
                document.getElementById('obs').value = demanda.obs || '';
                document.getElementById('solicitado').checked = demanda.solicitado === 'S';
                
                // Preencher motorista n√£o cadastrado
                if (demanda.id_motorista === 0 && demanda.nc_motorista) {
                    document.getElementById('divNcMotorista').style.display = 'block';
                    document.getElementById('ncMotorista').value = demanda.nc_motorista;
                    document.getElementById('ncMotorista').required = true;
                } else {
                    document.getElementById('divNcMotorista').style.display = 'none';
                    document.getElementById('ncMotorista').value = '';
                    document.getElementById('ncMotorista').required = false;
                }
        
                // Carregar hor√°rio
                if (demanda.horario) {
                    document.getElementById('definirHorario').checked = true;
                    document.getElementById('definirHorario').disabled = false;
                    document.getElementById('horario').value = demanda.horario;
                    document.getElementById('horario').disabled = false;
                } else {
                    document.getElementById('definirHorario').checked = false;
                    document.getElementById('definirHorario').disabled = false;
                    document.getElementById('horario').value = '';
                    document.getElementById('horario').disabled = true;
                }
                
                // Aplicar regras ap√≥s preencher
                aplicarRegrasTipoDemanda();
                aplicarRegrasTipoVeiculo();
                
                // Configurar checkbox expandir ve√≠culos
                document.getElementById('expandirVeiculos').checked = listaVeiculosExpandida;
                
                // Se tipo ve√≠culo √© 1, carregar lista apropriada
                if (demanda.id_tipoveiculo === 1) {
                    if (listaVeiculosExpandida) {
                        await toggleExpandirVeiculos();
                    } else {
                        await atualizarVeiculosDisponiveis();
                    }
                    
                    // Selecionar ve√≠culo ap√≥s carregar lista
                    setTimeout(() => {
                        document.getElementById('idVeiculo').value = demanda.id_veiculo || '';
                    }, 200);
                } else {
                    document.getElementById('idVeiculo').value = demanda.id_veiculo || '';
                }

                // ===== ALTERA√á√ÉO: Verificar bot√µes ANTES de abrir o modal =====
                await verificarBotaoLocacaoEdicao(idAd);
                await verificarBotaoDiariaEdicao(idAd);

                // ===== ALTERA√á√ÉO: Abrir modal ANTES de esconder spinner =====
                document.getElementById('modal').style.display = 'block';

                // ===== ALTERA√á√ÉO: Esconder spinner apenas DEPOIS de tudo pronto =====
                // Pequeno delay para garantir que o DOM foi atualizado
                setTimeout(() => {
                    esconderSpinner();
                }, 100);

            } catch (error) {
                console.error('Erro ao abrir modal de edi√ß√£o:', error);
                esconderSpinner();
                mostrarAlerta('Erro ao carregar dados da demanda!', '‚ùå Erro', '#dc3545');
            }
        }

        // ========== FUN√á√ÉO: Atualizar Agenda Manualmente ==========
        async function atualizarAgendaManual() {
            const botaoAtualizar = event?.target;
            
            // REMOVER anima√ß√£o de rota√ß√£o - apenas desabilitar
            if (botaoAtualizar) {
                botaoAtualizar.disabled = true;
            }
            
            try {
                // Recarregar tudo
                await carregarLocacoes();
                await carregarFeriadosPeriodo();
                await carregarAgenda();
                inicializarDestaqueLinha();
                
                // ===== REMOVER MENSAGEM DE SUCESSO =====
                // mostrarAlerta(...) - COMENTAR OU REMOVER
                
            } catch (error) {
                console.error('Erro ao atualizar agenda:', error);
                mostrarAlerta(
                    'Erro ao atualizar a agenda. Tente novamente.',
                    '‚ö†Ô∏è Erro',
                    '#dc3545'
                );
            } finally {
                // Reabilitar bot√£o
                if (botaoAtualizar) {
                    botaoAtualizar.disabled = false;
                }
            }
        }


        // ========== MODIFICAR FUN√á√ÉO EXISTENTE: fecharModal ==========
        function fecharModal() {
            document.getElementById('modal').style.display = 'none';
            veiculoSelecionadoOriginal = null;
            
            // ====== EXISTENTE: Limpar √°rea de loca√ß√£o ======
            const elementoLocacao = document.getElementById('areaLocacaoStatus');
            if (elementoLocacao) {
                elementoLocacao.remove();
            }
            
            // ====== NOVO: LIMPAR √ÅREA DE DI√ÅRIA ======
            const elementoDiaria = document.getElementById('areaDiariaStatus');
            if (elementoDiaria) {
                elementoDiaria.remove();
            }
            
            // ====== NOVO: LIMPAR VARI√ÅVEIS DE DI√ÅRIA ======
            dadosVinculoDiarias = null;
            idDemandaParaDiarias = null;
            temVinculoDiariasAtivo = false;
            // ====== FIM =====
        }
        
        function preencherSelectMotoristas(tipo = 'segeop') {
            const select = document.getElementById('idMotorista');
            select.innerHTML = '<option value="">Selecione...</option>';

            let motoristasFiltrados = motoristas;
            
            if (tipo === 'segeop') {
                // Motoristas SEGEOP (padr√£o atual)
                motoristasFiltrados = motoristas.filter(m => 
                    m.tipo === 'Motorista Atendimento' || m.tipo === 'Terceirizado'
                );
            } else if (tipo === 'administrativo') {
                // Motoristas Administrativos - NOVO
                motoristasFiltrados = motoristasAdministrativo;
            } else if (tipo === 'outros') {
                // Outros motoristas ativos, exceto SEGEOP
                motoristasFiltrados = dadosAgenda.todos_motoristas.filter(m => 
                    m.tipo !== 'Motorista Atendimento' && m.tipo !== 'Terceirizado'
                );
            } else if (tipo === 'todos') {
                // Todos os motoristas ativos
                motoristasFiltrados = dadosAgenda.todos_motoristas || motoristas;
            }
            
            motoristasFiltrados.forEach(m => {
                select.innerHTML += `<option value="${m.id}">${m.nome}</option>`;
            });
        }

        
        function preencherSelectVeiculos() {
            const select = document.getElementById('idVeiculo');
            const veiculoAtual = select.value;
            
            select.innerHTML = '<option value="">Selecione...</option>';
            veiculos.forEach(v => {
                select.innerHTML += `<option value="${v.id}">${v.veiculo}</option>`;
            });
            
            // Restaurar ve√≠culo selecionado se existir
            if (veiculoAtual && veiculoSelecionadoOriginal) {
                const existe = Array.from(select.options).some(opt => opt.value == veiculoAtual);
                if (existe) {
                    select.value = veiculoAtual;
                } else {
                    // Se n√£o existe na lista, adiciona
                    select.innerHTML += `<option value="${veiculoSelecionadoOriginal.id}">${veiculoSelecionadoOriginal.veiculo}</option>`;
                    select.value = veiculoAtual;
                }
            }
        }
        
        async function preencherSelectTiposDemanda() {
            try {
                const selectTipoDemanda = document.getElementById('idTipoDemanda');
                const valorAtual = selectTipoDemanda.value; // Guardar valor atual para edi√ß√£o
                
                // Montar URL - n√£o filtrar mais por contexto
                let url = '/api/agenda/tipos-demanda';
                
                const res = await fetch(url);
                const tipos = await res.json();
                
                selectTipoDemanda.innerHTML = '<option value="">Selecione...</option>';
                tipos.forEach(t => {
                    selectTipoDemanda.innerHTML += `<option value="${t.id}" data-descricao="${t.descricao}">${t.descricao}</option>`;
                });
                
                // Restaurar valor na edi√ß√£o (se ainda existir nas op√ß√µes)
                if (valorAtual) {
                    const opcaoExiste = Array.from(selectTipoDemanda.options).some(opt => opt.value == valorAtual);
                    if (opcaoExiste) {
                        selectTipoDemanda.value = valorAtual;
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar tipos de demanda:', error);
            }
        }

        // ========== FUN√á√ÉO: Processar V√≠nculos em Sequ√™ncia ==========
        async function processarVinculosSequencial() {
            // Se n√£o tem mais v√≠nculos pendentes, finalizar
            if (!vinculosPendentes.diarias && !vinculosPendentes.locacao) {
                // Limpar vari√°veis
                fluxoVinculosAtivo = false;
                dadosDemandaParaVinculos = null;
                vinculosPendentes = { diarias: false, locacao: false };
                
                // Recarregar agenda
                await carregarSemanas();
                await carregarAgenda();
                inicializarDestaqueLinha();
                return;
            }
            
            // ===== 1¬∫ PRIORIDADE: DI√ÅRIAS =====
            if (vinculosPendentes.diarias) {
                vinculosPendentes.diarias = false; // Marcar como processado
                
                mostrarConfirmacao(
                    `üìß O motorista <strong>${dadosVinculoDiarias.nome_motorista}</strong> √© terceirizado.<br><br>Deseja enviar e-mail para a empresa solicitando pagamento das di√°rias?`,
                    async function(respostaEmail) {
                        if (respostaEmail) {
                            // Abrir modal de email de di√°rias
                            await abrirModalEmailDiarias(dadosDemandaParaVinculos);
                            // Quando fechar o modal de email, processar pr√≥ximo v√≠nculo
                        } else {
                            // Usu√°rio disse N√ÉO - processar pr√≥ximo v√≠nculo
                            await processarVinculosSequencial();
                        }
                    },
                    '‚úàÔ∏è Solicitar Di√°rias?'
                );
                return;
            }
            
            // ===== 2¬∫ PRIORIDADE: LOCA√á√ÉO =====
            if (vinculosPendentes.locacao) {
                vinculosPendentes.locacao = false; // Marcar como processado
                
                mostrarModalConfirmacaoLocacao(async function(respostaLocacao) {
                    if (respostaLocacao) {
                        // Abrir formul√°rio de loca√ß√£o
                        await abrirFormularioLocacao(dadosDemandaParaVinculos);
                        // Quando fechar o modal de loca√ß√£o, processar pr√≥ximo v√≠nculo (se houver)
                    } else {
                        // Usu√°rio disse N√ÉO - processar pr√≥ximo v√≠nculo
                        await processarVinculosSequencial();
                    }
                });
                return;
            }
        }


        async function salvarDemanda() {
            const idAd = document.getElementById('idAd').value;
            const idTipoDemanda = parseInt(document.getElementById('idTipoDemanda').value);
            const definirHorario = document.getElementById('definirHorario').checked;
            const horario = document.getElementById('horario').value;
            const expandirVeiculos = document.getElementById('expandirVeiculos').checked;

            // Validar hor√°rio se checkbox estiver marcado
            if (definirHorario) {
                if (!horario) {
                    mostrarAlerta('Informe o hor√°rio!', '‚ö†Ô∏è Aten√ß√£o', '#ffc107');
                    return;
                }
                if (!validarHorario(horario)) {
                    mostrarAlerta('Hor√°rio inv√°lido! Use o formato HH:MM (ex: 08:30)', '‚ö†Ô∏è Aten√ß√£o', '#ffc107');
                    return;
                }
            }

            const dados = {
                id_motorista: document.getElementById('idMotorista').value || null,
                id_tipodemanda: idTipoDemanda,
                id_tipoveiculo: document.getElementById('idTipoVeiculo').value || null,
                id_veiculo: document.getElementById('idVeiculo').value || null,
                dt_inicio: document.getElementById('dtInicio').value,
                dt_fim: document.getElementById('dtFim').value,
                setor: document.getElementById('setor').value,
                solicitante: document.getElementById('solicitante').value,
                destino: document.getElementById('destino').value,
                nu_sei: document.getElementById('nuSei').value,
                obs: document.getElementById('obs').value,
                solicitado: document.getElementById('solicitado').checked ? 'S' : 'N',
                horario: definirHorario ? horario : '',
                nc_motorista: document.getElementById('ncMotorista').value || '',
                todos_veiculos: expandirVeiculos ? 'S' : 'N',
                usuario: document.getElementById('usuario').value
            };
            
            // Valida√ß√µes obrigat√≥rias b√°sicas
            if (!dados.id_tipodemanda || !dados.dt_inicio || !dados.dt_fim) {
                mostrarAlerta('Preencha todos os campos obrigat√≥rios: Tipo de Demanda, Data In√≠cio e Data Fim!', '‚ö†Ô∏è Aten√ß√£o', '#ffc107');
                return;
            }
            
            // Buscar configura√ß√£o do tipo de demanda
            const config = tiposDemandaConfig[idTipoDemanda];
            
            if (!config) {
                mostrarAlerta('Configura√ß√£o do tipo de demanda n√£o encontrada!', '‚ùå Erro', '#dc3545');
                return;
            }
            
            // Valida√ß√µes din√¢micas (mant√©m as mesmas valida√ß√µes existentes)
            if (config.motorista_obrigatorio && !dados.id_motorista) {
                mostrarAlerta('O campo Motorista √© obrigat√≥rio para este tipo de demanda!', '‚ö†Ô∏è Aten√ß√£o', '#ffc107');
                return;
            }

            if (dados.id_motorista === '0' && !dados.nc_motorista) {
                mostrarAlerta('Informe o nome do motorista n√£o cadastrado!', '‚ö†Ô∏è Aten√ß√£o', '#ffc107');
                return;
            }
            
            if (config.tipo_veiculo_obrigatorio && !dados.id_tipoveiculo) {
                mostrarAlerta('O campo Tipo de Ve√≠culo √© obrigat√≥rio para este tipo de demanda!', '‚ö†Ô∏è Aten√ß√£o', '#ffc107');
                return;
            }
            
            if (config.veiculo_obrigatorio && !dados.id_veiculo) {
                mostrarAlerta('O campo Ve√≠culo √© obrigat√≥rio para este tipo de demanda!', '‚ö†Ô∏è Aten√ß√£o', '#ffc107');
                return;
            }
            
            if (config.setor_obrigatorio && !dados.setor) {
                mostrarAlerta('O campo Setor √© obrigat√≥rio para este tipo de demanda!', '‚ö†Ô∏è Aten√ß√£o', '#ffc107');
                return;
            }
            
            if (config.solicitante_obrigatorio && !dados.solicitante) {
                mostrarAlerta('O campo Solicitante √© obrigat√≥rio para este tipo de demanda!', '‚ö†Ô∏è Aten√ß√£o', '#ffc107');
                return;
            }
            
            if (config.destino_obrigatorio && !dados.destino) {
                mostrarAlerta('O campo Destino √© obrigat√≥rio para este tipo de demanda!', '‚ö†Ô∏è Aten√ß√£o', '#ffc107');
                return;
            }
            
            try {
                let res;
                let demandaIdRetornado = null;
                
                if (idAd) {
                    // ========== EDI√á√ÉO - N√ÉO VERIFICA LOCA√á√ÉO ==========
                    res = await fetch(`/api/agenda/demanda/${idAd}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(dados)
                    });
                    
                    const result = await res.json();
                    
                    if (result.success || result.id) {
                        marcarAcaoLocal();
                        fecharModal();
                        await carregarSemanas();
                        await carregarAgenda();
                        inicializarDestaqueLinha();
                    } else {
                        mostrarAlerta('Erro ao salvar: ' + (result.error || 'Erro desconhecido'), '‚ùå Erro', '#dc3545');
                    }
                    
                } else {
                    // ========== NOVA DEMANDA ==========
                    
                    // ===== SALVAR DEMANDA PRIMEIRO =====
                    const resSalvar = await fetch('/api/agenda/demanda', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(dados)
                    });
                    
                    const resultSalvar = await resSalvar.json();

                    // ========== TRATAR ERRO 409 (CONFLITO) ==========
                    if (resSalvar.status === 409) {
                        mostrarAlerta(
                            '‚ö†Ô∏è <strong>CONFLITO DETECTADO!</strong><br><br>' +
                            (resultSalvar.error || 'J√° existe demanda para este motorista/ve√≠culo no per√≠odo selecionado.') +
                            '<br><br><strong>A p√°gina ser√° atualizada automaticamente.</strong>',
                            '‚ö†Ô∏è Conflito',
                            '#ffc107'
                        );
                        
                        return;
                    }

                    if (!resultSalvar.success && !resultSalvar.id) {
                        mostrarAlerta('Erro ao salvar: ' + (resultSalvar.error || 'Erro desconhecido'), '‚ùå Erro', '#dc3545');
                        return;
                    }
                    
                    demandaIdVinculos = resultSalvar.id;
                    dadosDemandaParaVinculos = dados;
                    
                    marcarAcaoLocal();
                    // Fechar modal principal
                    fecharModal();

                    await carregarSemanas(); // Recarregar lista de semanas (pode ter semanas novas)
                    
                    // Encontrar √≠ndice da semana da data inicial da demanda
                    const indiceSemana = encontrarSemanaDaData(dados.dt_inicio);
                    
                    if (indiceSemana !== -1) {
                        semanaAtual = indiceSemana;
                        renderizarAbas(); // Atualizar as abas visualmente
                    }

                    mostrarSpinnerVinculos();
                    
                    // ===== VERIFICAR TODOS OS V√çNCULOS =====
                    let temDiarias = false;
                    let temLocacao = false;
                    let idItemDiariaSalvo = null;

                    // 1. Verificar Di√°rias de Motorista Terceirizado
                    // IMPORTANTE: Verificar ANTES de processar se as vari√°veis globais foram setadas
                    const idTipoDemandaSalvo = parseInt(dados.id_tipodemanda);
                    const idMotoristaSalvo = dados.id_motorista;

                    // console.log('=== DEBUG VERIFICA√á√ÉO DI√ÅRIAS ===');
                    // console.log('ID_TIPO_DEMANDA:', idTipoDemandaSalvo);
                    // console.log('ID_MOTORISTA:', idMotoristaSalvo);
                    // console.log('temVinculoDiariasAtivo:', temVinculoDiariasAtivo);
                    // console.log('dadosVinculoDiarias:', dadosVinculoDiarias);

                    // Verificar se √© tipo Viagem (ID=2) e tem motorista v√°lido
                    if (idTipoDemandaSalvo === 2 && idMotoristaSalvo && parseInt(idMotoristaSalvo) > 0) {
                        // Se ainda n√£o verificou o v√≠nculo, verificar agora
                        if (!temVinculoDiariasAtivo) {
                            try {
                                const urlVerificarDiarias = `/api/verificar_vinculo_diarias?id_motorista=${idMotoristaSalvo}`;
                                const resVerificarDiarias = await fetch(urlVerificarDiarias);
                                const resultadoDiarias = await resVerificarDiarias.json();
                                
                                // console.log('Resultado verifica√ß√£o di√°rias:', resultadoDiarias);
                                
                                if (resultadoDiarias.tem_vinculo) {
                                    temVinculoDiariasAtivo = true;
                                    dadosVinculoDiarias = resultadoDiarias;
                                    // console.log('‚úÖ V√≠nculo de di√°rias encontrado!');
                                }
                            } catch (error) {
                                console.error('Erro ao verificar v√≠nculo de di√°rias:', error);
                            }
                        }
                        
                        // Agora processar se tem v√≠nculo ativo
                        if (temVinculoDiariasAtivo && dadosVinculoDiarias) {
                            // console.log('‚û°Ô∏è Processando salvamento de di√°ria...');
                            
                            // ===== SALVAR REGISTRO DE DI√ÅRIA ANTES DE PERGUNTAR =====
                            try {
                                const diarias = calcularDiarias(dados.dt_inicio, dados.dt_fim);
                                
                                // console.log('Di√°rias calculadas:', diarias);
                                
                                const dadosSalvarDiaria = {
                                    id_ad: demandaIdVinculos,
                                    id_fornecedor: dadosVinculoDiarias.id_fornecedor,
                                    id_motorista: idMotoristaSalvo,
                                    qt_diarias: diarias.total_diarias,
                                    vl_diaria: dadosVinculoDiarias.vl_diaria,
                                    vl_total: diarias.total_diarias * dadosVinculoDiarias.vl_diaria
                                };
                                
                                // console.log('Dados para salvar di√°ria:', dadosSalvarDiaria);
                                
                                const resSalvarDiaria = await fetch('/api/salvar_diaria_terceirizado', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(dadosSalvarDiaria)
                                });
                                
                                const resultSalvarDiaria = await resSalvarDiaria.json();
                                
                                // console.log('Resultado salvamento di√°ria:', resultSalvarDiaria);
                                
                                if (resultSalvarDiaria.success) {
                                    temDiarias = true;
                                    idDemandaParaDiarias = demandaIdVinculos;
                                    idItemDiariaSalvo = resultSalvarDiaria.iditem;
                                    
                                    // IMPORTANTE: Guardar no campo oculto do modal de email
                                    document.getElementById('email_iditem').value = idItemDiariaSalvo;
                                    
                                    // console.log('‚úÖ Di√°ria salva com sucesso! IDITEM:', idItemDiariaSalvo);
                                } else {
                                    console.error('‚ùå Erro ao salvar di√°ria:', resultSalvarDiaria.erro);
                                }
                                
                            } catch (errorDiaria) {
                                console.error('‚ùå Erro ao salvar di√°ria:', errorDiaria);
                            }
                        } else {
                            console.log('‚ÑπÔ∏è N√£o tem v√≠nculo de di√°rias ativo');
                        }
                    }

                    // 2. Verificar Loca√ß√£o de Ve√≠culo
                    if (dados.id_tipoveiculo && idMotoristaSalvo && parseInt(idMotoristaSalvo) > 0) {
                        try {
                            const urlVerificarLocacao = `/api/verificar_vinculo_locacao?id_tipoveiculo=${dados.id_tipoveiculo}&id_motorista=${idMotoristaSalvo}`;
                            const resVerificarLocacao = await fetch(urlVerificarLocacao);
                            const resultadoLocacao = await resVerificarLocacao.json();
                            
                            // console.log('Resultado verifica√ß√£o loca√ß√£o:', resultadoLocacao);
                            
                            if (resultadoLocacao.tem_vinculo) {
                                temLocacao = true;
                                dadosVinculoLocacao = resultadoLocacao;
                                idDemandaParaLocacao = demandaIdVinculos;
                                //cconsole.log('‚úÖ V√≠nculo de loca√ß√£o encontrado!');
                            }
                        } catch (error) {
                            console.error('Erro ao verificar loca√ß√£o:', error);
                        }
                    }

                    // ===== ADICIONAR ESTE BLOCO AP√ìS A VERIFICA√á√ÉO DE LOCA√á√ÉO =====

                    // 2. Verificar Di√°rias de Motorista Terceirizado
                    if (dados.id_tipodemanda == 2 && dados.id_motorista && parseInt(dados.id_motorista) > 0) {
                        try {
                            const urlVerificarDiarias = `/api/verificar_vinculo_diarias?id_motorista=${dados.id_motorista}`;
                            const resVerificarDiarias = await fetch(urlVerificarDiarias);
                            const resultadoDiarias = await resVerificarDiarias.json();
                            
                            if (resultadoDiarias.tem_vinculo) {
                                // ===== SALVAR REGISTRO DE DI√ÅRIA IMEDIATAMENTE =====
                                const diarias = calcularDiarias(dados.dt_inicio, dados.dt_fim);
                                
                                const resSalvarDiaria = await fetch('/api/salvar_diaria_terceirizado', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        id_ad: demandaIdVinculos,
                                        id_fornecedor: resultadoDiarias.id_fornecedor,
                                        id_motorista: dados.id_motorista,
                                        qt_diarias: diarias.total_diarias,
                                        vl_diaria: resultadoDiarias.vl_diaria,
                                        vl_total: diarias.total_diarias * resultadoDiarias.vl_diaria
                                    })
                                });
                                
                                const resultSalvarDiaria = await resSalvarDiaria.json();
                                
                                if (resultSalvarDiaria.success) {
                                    temDiarias = true;
                                    dadosVinculoDiarias = resultadoDiarias;
                                    idDemandaParaDiarias = demandaIdVinculos;
                                    
                                    // Armazenar IDITEM no campo oculto do modal de email
                                    document.getElementById('email_iditem').value = resultSalvarDiaria.iditem;
                                    
                                    app.logger.info(`‚úÖ Di√°ria salva automaticamente - IDITEM: ${resultSalvarDiaria.iditem}`);
                                } else {
                                    console.error('Erro ao salvar di√°ria:', resultSalvarDiaria.erro);
                                }
                            }
                        } catch (errorDiaria) {
                            console.error('Erro ao verificar/salvar di√°ria:', errorDiaria);
                        }
                    }

                    // 3. Verificar Fornecedor (se n√£o tem loca√ß√£o)
                    if (!temLocacao && dados.id_tipoveiculo) {
                        try {
                            const urlVerificarFornecedor = `/api/verificar_vinculo_fornecedor?id_tipoveiculo=${dados.id_tipoveiculo}`;
                            const resVerificarFornecedor = await fetch(urlVerificarFornecedor);
                            const resultadoFornecedor = await resVerificarFornecedor.json();
                            
                            if (resultadoFornecedor.tem_vinculo) {
                                dadosVinculoFornecedor = resultadoFornecedor;
                                idDemandaParaEmailFornecedor = demandaIdVinculos;
                                
                                // Para fornecedor, perguntar imediatamente
                                mostrarConfirmacao(
                                    'üìß Esta demanda possui v√≠nculo com loca√ß√£o.<br><br>Deseja enviar e-mail de solicita√ß√£o desta loca√ß√£o?',
                                    async function(respostaEmail) {
                                        if (respostaEmail) {
                                            mostrarSpinner();
                                            
                                            try {
                                                const resLocacao = await fetch('/api/criar_locacao_fornecedor', {
                                                    method: 'POST',
                                                    headers: { 'Content-Type': 'application/json' },
                                                    body: JSON.stringify({ id_demanda: demandaIdVinculos })
                                                });
                                                
                                                const resultLocacao = await resLocacao.json();
                                                
                                                esconderSpinner();
                                                
                                                if (resultLocacao.success && resultLocacao.id_item) {
                                                    idItemLocacaoFornecedor = resultLocacao.id_item;
                                                    await abrirModalEmailFornecedor(dados);
                                                } else {
                                                    mostrarAlerta(
                                                        'Demanda criada, mas erro ao criar registro de loca√ß√£o.<br><br>Erro: ' + (resultLocacao.erro || 'Desconhecido'),
                                                        '‚ö†Ô∏è Aviso',
                                                        '#ffc107'
                                                    );
                                                    await carregarSemanas();
                                                    await carregarAgenda();
                                                    inicializarDestaqueLinha();
                                                }
                                            } catch (errorLocacao) {
                                                esconderSpinner();
                                                console.error('Erro ao criar registro de loca√ß√£o:', errorLocacao);
                                                mostrarAlerta(
                                                    'Demanda criada, mas erro ao criar registro de loca√ß√£o.',
                                                    '‚ö†Ô∏è Aviso',
                                                    '#ffc107'
                                                );
                                                await carregarSemanas();
                                                await carregarAgenda();
                                                inicializarDestaqueLinha();
                                            }
                                        } else {
                                            await carregarSemanas();
                                            await carregarAgenda();
                                            inicializarDestaqueLinha();
                                        }
                                    },
                                    'üìß Enviar E-mail?'
                                );
                                return;
                            }
                        } catch (errorFornecedor) {
                            console.error('Erro ao verificar fornecedor:', errorFornecedor);
                        }
                    }

                    // console.log('=== RESUMO DOS V√çNCULOS ===');
                    // console.log('temDiarias:', temDiarias);
                    // console.log('temLocacao:', temLocacao);

                    // ===== PROCESSAR V√çNCULOS EM SEQU√äNCIA =====
                    if (temDiarias || temLocacao) {
                        fluxoVinculosAtivo = true;
                        vinculosPendentes = {
                            diarias: temDiarias,
                            locacao: temLocacao
                        };
                        
                        // console.log('‚û°Ô∏è Iniciando fluxo de v√≠nculos...');
                        
                        // Iniciar processamento sequencial
                        await processarVinculosSequencial();
                    } else {
                        // console.log('‚ÑπÔ∏è Sem v√≠nculos - recarregando agenda');
            
                        esconderSpinnerVinculos();

                        // Sem v√≠nculos - apenas recarregar
                        await carregarSemanas();
                        await carregarAgenda();
                        inicializarDestaqueLinha();
                    }
                }
                
            } catch (error) {
                console.error('Erro:', error);

                esconderSpinner();
                esconderSpinnerVinculos();

                mostrarAlerta('Erro ao salvar demanda!', '‚ùå Erro', '#dc3545');
            }
        }
        
        async function excluirDemanda() {
            const idAd = document.getElementById('idAd').value;
            
            if (!idAd) {
                return;
            }
            
            mostrarConfirmacao(
                'Deseja realmente excluir esta demanda?',
                async function(confirmado) {
                    if (!confirmado) {
                        return;
                    }
                    
                    try {
                        mostrarSpinner();
                        
                        const idAdNumero = parseInt(idAd);
                        const demanda = dadosAgenda.demandas.find(d => parseInt(d.id) === idAdNumero);
                        
                        if (!demanda) {
                            esconderSpinner();
                            mostrarAlerta('Demanda n√£o encontrada!', '‚ùå Erro', '#dc3545');
                            return;
                        }
                        
                        if (demanda.id_motorista && parseInt(demanda.id_motorista) > 0) {
                            const locacaoVinculada = locacoesAtivas.find(loc => 
                                loc.id_motorista === demanda.id_motorista &&
                                loc.data_inicio <= demanda.dt_fim &&
                                loc.data_fim >= demanda.dt_inicio
                            );
                            
                            if (locacaoVinculada) {
                                esconderSpinner();
                                
                                await new Promise(resolve => setTimeout(resolve, 300));
                                
                                mostrarConfirmacao(
                                    'Esta demanda possui uma loca√ß√£o vinculada.<br><br>A loca√ß√£o tamb√©m ser√° exclu√≠da. Deseja continuar?',
                                    async function(confirmarLocacao) {
                                        if (!confirmarLocacao) {
                                            return;
                                        }
                                        
                                        mostrarSpinner();
                                        
                                        try {
                                            const resLocacao = await fetch(`/api/excluir_locacao/${locacaoVinculada.id_item}`, {
                                                method: 'DELETE'
                                            });
                                            
                                            if (!resLocacao.ok) {
                                                const errorData = await resLocacao.json();
                                                throw new Error(errorData.erro || 'Erro ao excluir loca√ß√£o vinculada');
                                            }
                                            
                                            // ===== NOVO: EXCLUIR DI√ÅRIA SE EXISTIR =====
                                            try {
                                                await fetch(`/api/excluir_diaria_terceirizado/${idAd}`, {
                                                    method: 'DELETE'
                                                });
                                            } catch (errorDiaria) {
                                                console.log('Nenhuma di√°ria para excluir ou erro:', errorDiaria);
                                            }

                                            // Excluir demanda
                                            const res = await fetch(`/api/agenda/demanda/${idAd}`, {
                                                method: 'DELETE'
                                            });

                                            const result = await res.json();
                                            
                                            esconderSpinner();
                                            
                                            if (result.success) {
                                                marcarAcaoLocal();
                                                fecharModal();
                                                
                                                await carregarSemanas();
                                                await carregarLocacoes();
                                                await carregarAgenda();
                                                
                                                // mostrarAlerta('Demanda e loca√ß√£o vinculada exclu√≠das com sucesso!', '‚úÖ Sucesso', '#28a745');
                                            } else {
                                                mostrarAlerta('Erro ao excluir demanda: ' + (result.error || 'Erro desconhecido'), '‚ùå Erro', '#dc3545');
                                            }
                                            
                                        } catch (errorLocacao) {
                                            esconderSpinner();
                                            mostrarAlerta('Erro ao excluir loca√ß√£o vinculada: ' + errorLocacao.message, '‚ùå Erro', '#dc3545');
                                        }
                                    },
                                    '‚ö†Ô∏è Loca√ß√£o Vinculada'
                                );
                                
                                return;
                            }
                        }
                        
                        const res = await fetch(`/api/agenda/demanda/${idAd}`, {
                            method: 'DELETE'
                        });
                        
                        const result = await res.json();
                        
                        esconderSpinner();
                        
                        if (result.success) {
                            marcarAcaoLocal();
                            fecharModal();
                            
                            await carregarSemanas();
                            await carregarLocacoes();
                            await carregarAgenda();
                            
                            // mostrarAlerta('Demanda exclu√≠da com sucesso!', '‚úÖ Sucesso', '#28a745');
                        } else {
                            mostrarAlerta('Erro ao excluir: ' + (result.error || 'Erro desconhecido'), '‚ùå Erro', '#dc3545');
                        }
                        
                    } catch (error) {
                        esconderSpinner();
                        mostrarAlerta('Erro ao excluir demanda: ' + error.message, '‚ùå Erro', '#dc3545');
                    }
                },
                '‚ö†Ô∏è Excluir Demanda'
            );
        }

        // ========== EVENT LISTENER SELETIVO - N√ÉO FECHA MODAIS DE FORMUL√ÅRIO ==========
        window.addEventListener('click', function(event) {
            // Modais de alerta e confirma√ß√£o padr√£o (PODEM fechar ao clicar fora)
            const modalAlerta = document.getElementById('modalAlerta');
            const modalConfirmacao = document.getElementById('modalConfirmacao');
            
            if (event.target === modalAlerta) {
                fecharModalAlerta();
            }
            
            if (event.target === modalConfirmacao) {
                fecharModalConfirmacao(false);
            }
            
            // Modal de sucesso de loca√ß√£o (PODE fechar ao clicar fora)
            const modalSucessoLocacao = document.getElementById('modalSucessoLocacao');
            if (event.target === modalSucessoLocacao) {
                fecharModalSucessoLocacao();
            }
            
            // Modal de feriados (PODE fechar ao clicar fora)
            const modalFeriados = document.getElementById('modalFeriados');
            if (event.target === modalFeriados) {
                fecharModalFeriados();
            }
            
            // NOTA: Os seguintes modais N√ÉO fecham ao clicar fora:
            // - modal (Nova/Editar Demanda)
            // - modalFormLocacao (Formul√°rio de Loca√ß√£o)
            // - modalConfirmacaoLocacao (Confirma√ß√£o de Loca√ß√£o)
            // - modalEmailFornecedor (Email para Fornecedor) ‚Üê ADICIONADO
        });

        // ========== EVENT LISTENER: Tipo de Ve√≠culo ==========
        document.addEventListener('DOMContentLoaded', function() {
            const selectTipoVeiculo = document.getElementById('idTipoVeiculo');
            
            if (selectTipoVeiculo) {
                selectTipoVeiculo.addEventListener('change', async function() {
                    await verificarFornecedorTipoVeiculo(this.value);
                    aplicarRegrasTipoVeiculo(); // Manter l√≥gica existente
                });
            }
        });

        // ========== TECLA ESC PARA MODAIS DE ALERTA ==========
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                // Verificar quais modais est√£o abertos
                const modalAlerta = document.getElementById('modalAlerta');
                const modalSucessoLocacao = document.getElementById('modalSucessoLocacao');
                const modalFeriados = document.getElementById('modalFeriados');
                
                // Fechar apenas modais n√£o-cr√≠ticos
                if (modalAlerta.style.display === 'block') {
                    fecharModalAlerta();
                } else if (modalSucessoLocacao.style.display === 'block') {
                    fecharModalSucessoLocacao();
                } else if (modalFeriados.style.display === 'block') {
                    fecharModalFeriados();
                }
                
                // N√ÉO fecha modal de demanda, loca√ß√£o, confirma√ß√£o de loca√ß√£o ou email de fornecedor
            }
        });

        document.addEventListener('click', function(event) {
            if (celulaSelecionada && !event.target.closest('.agenda-table')) {
                celulaSelecionada.classList.remove('cell-selected');
                celulaSelecionada = null;
            }
        });
        
        function scrollWeekTabs(direction) {
            const scrollContainer = document.getElementById('weekTabsScroll');
            const scrollAmount = 200; // pixels
            
            scrollPosition += (direction * scrollAmount);
            scrollContainer.scrollLeft = scrollPosition;
            
            // Atualizar posi√ß√£o real ap√≥s scroll
            setTimeout(() => {
                scrollPosition = scrollContainer.scrollLeft;
                atualizarBotoesNavegacao();
            }, 100);
        }

        function atualizarBotoesNavegacao() {
            const scrollContainer = document.getElementById('weekTabsScroll');
            const btnPrev = document.getElementById('btnPrevWeek');
            const btnNext = document.getElementById('btnNextWeek');
            
            if (!scrollContainer || !btnPrev || !btnNext) return;
            
            const maxScroll = scrollContainer.scrollWidth - scrollContainer.clientWidth;
            
            // Desabilitar bot√£o esquerdo se estiver no in√≠cio
            btnPrev.disabled = scrollContainer.scrollLeft <= 0;
            
            // Desabilitar bot√£o direito se estiver no fim
            btnNext.disabled = scrollContainer.scrollLeft >= maxScroll;
        }

        function scrollToActiveTab() {
            const scrollContainer = document.getElementById('weekTabsScroll');
            const activeTab = document.querySelector('.week-tab.active');
            
            if (!scrollContainer || !activeTab) return;
            
            const containerRect = scrollContainer.getBoundingClientRect();
            const tabRect = activeTab.getBoundingClientRect();
            
            // Verificar se a aba est√° fora da vis√£o
            if (tabRect.left < containerRect.left || tabRect.right > containerRect.right) {
                // Centralizar a aba ativa
                const scrollLeft = activeTab.offsetLeft - (scrollContainer.clientWidth / 2) + (activeTab.clientWidth / 2);
                scrollContainer.scrollLeft = scrollLeft;
                scrollPosition = scrollLeft;
            }
            
            atualizarBotoesNavegacao();
        }

        // Atualizar bot√µes ao redimensionar janela
        window.addEventListener('resize', () => {
            atualizarBotoesNavegacao();
        });

        // Atualizar bot√µes ao scroll manual
        document.addEventListener('DOMContentLoaded', () => {
            const scrollContainer = document.getElementById('weekTabsScroll');
            if (scrollContainer) {
                scrollContainer.addEventListener('scroll', () => {
                    scrollPosition = scrollContainer.scrollLeft;
                    atualizarBotoesNavegacao();
                });
            }
        });

        // Verificar se ve√≠culo j√° possui demandas com hor√°rio no mesmo per√≠odo
        async function verificarObrigatoriedadeHorario() {
            const idVeiculo = document.getElementById('idVeiculo').value;
            const dtInicio = document.getElementById('dtInicio').value;
            const dtFim = document.getElementById('dtFim').value;
            const idAd = document.getElementById('idAd').value;
            
            if (!idVeiculo || !dtInicio || !dtFim) return;
            
            try {
                let url = `/api/agenda/verificar-horario-veiculo?id_veiculo=${idVeiculo}&inicio=${dtInicio}&fim=${dtFim}`;
                if (idAd) {
                    url += `&id_demanda=${idAd}`;
                }
                
                const res = await fetch(url);
                const result = await res.json();
                
                if (result.tem_horario) {
                    // For√ßar checkbox de hor√°rio
                    document.getElementById('definirHorario').checked = true;
                    document.getElementById('definirHorario').disabled = true;
                    document.getElementById('horario').disabled = false;
                    
                    mostrarAlerta('Este ve√≠culo j√° possui demandas com hor√°rio definido neste per√≠odo. √â obrigat√≥rio informar o hor√°rio.', '‚ÑπÔ∏è Informa√ß√£o', '#1a73e8');
                } else {
                    document.getElementById('definirHorario').disabled = false;
                }
            } catch (error) {
                console.error('Erro ao verificar obrigatoriedade de hor√°rio:', error);
            }
        }
        
        // Adicionar event listener ao select de ve√≠culo
        document.getElementById('idVeiculo').addEventListener('change', verificarObrigatoriedadeHorario);
        
        function abrirVisualizacaoSecao(tipo) {
            const semana = semanas[semanaAtual];
            const dias = gerarDiasSemana(semana.inicio);
            
            let htmlSecao = '';
            let titulo = '';
            
            switch(tipo) {
                case 'motoristas':
                    titulo = 'üë≤ SEGEOP - MOTORISTAS';
                    htmlSecao = renderizarSecaoMotoristasCompacta(dias);
                    break;
                case 'administrativo':
                    titulo = 'üëî SEGEOP - ADMINISTRATIVO';
                    htmlSecao = renderizarSecaoAdministrativoCompacta(dias);
                    break;                    
                case 'outros-motoristas':
                    titulo = 'üë≤ OUTROS MOTORISTAS';
                    htmlSecao = renderizarSecaoOutrosMotoristas(dias);
                    htmlSecao = extrairTabelaParaVisualizacao(htmlSecao);
                    break;
                case 'veiculos':
                    titulo = 'üöô SEGEOP - VE√çCULOS OFICIAIS';
                    htmlSecao = renderizarSecaoVeiculos(dias);
                    htmlSecao = extrairTabelaParaVisualizacao(htmlSecao);
                    break;
                case 'veiculos-alocados':
                    titulo = 'üöå SEGEOP - VE√çCULOS ALOCADOS';
                    htmlSecao = renderizarSecaoVeiculosAlocados(dias);
                    htmlSecao = extrairTabelaParaVisualizacao(htmlSecao);
                    break;
            }
            
            // Inserir no modal
            document.getElementById('tituloVisualizacao').textContent = `${titulo} - ${semana.label}`;
            document.getElementById('conteudoVisualizacao').innerHTML = `<div class="view-compacta">${htmlSecao}</div>`;
            document.getElementById('modalVisualizacao').style.display = 'block';
        }

        function extrairTabelaParaVisualizacao(htmlSecao) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlSecao;
            const tabela = tempDiv.querySelector('table');
            const titulo = tempDiv.querySelector('.section-header span')?.textContent || '';
            
            return `
                <div class="section-title-compacto">${titulo}</div>
                ${tabela ? tabela.outerHTML : ''}
            `;
        }

        function fecharModalVisualizacao() {
            document.getElementById('modalVisualizacao').style.display = 'none';
        }

        async function copiarComoImagem() {
            const conteudo = document.getElementById('conteudoVisualizacao');
            
            // Verificar se html2canvas est√° dispon√≠vel
            if (typeof html2canvas === 'undefined') {
                mostrarAlerta(
                    'Para usar este recurso, √© necess√°rio incluir a biblioteca html2canvas.<br><br>' +
                    'Por enquanto, voc√™ pode usar a tecla Print Screen para capturar a tela.',
                    '‚ÑπÔ∏è Informa√ß√£o',
                    '#1a73e8'
                );
                return;
            }
            
            // ===== VERIFICAR PERMISS√ÉO DA CLIPBOARD API =====
            try {
                const permissionStatus = await navigator.permissions.query({ name: 'clipboard-write' });
                
                if (permissionStatus.state === 'denied') {
                    mostrarAlerta(
                        '‚ùå <strong>Permiss√£o Negada</strong><br><br>' +
                        'Seu navegador bloqueou o acesso √† √°rea de transfer√™ncia.<br><br>' +
                        '<strong>Solu√ß√£o:</strong><br>' +
                        '1. Clique no √≠cone de <strong>cadeado/informa√ß√£o</strong> na barra de endere√ßo<br>' +
                        '2. Permita o acesso √† <strong>√Årea de transfer√™ncia</strong><br>' +
                        '3. Recarregue a p√°gina e tente novamente<br><br>' +
                        '<em>Ou use Print Screen manualmente.</em>',
                        '‚ö†Ô∏è Acesso Bloqueado',
                        '#dc3545'
                    );
                    return;
                }
            } catch (permError) {
                console.warn('N√£o foi poss√≠vel verificar permiss√£o da clipboard:', permError);
            }
            
            try {
                mostrarSpinner();
                
                // ========== CAPTURAR TABELA COMPLETA SEM MODIFICAR ESTILOS ==========
                
                // Encontrar a tabela e o t√≠tulo
                const tabela = conteudo.querySelector('table');
                const tituloSecao = conteudo.querySelector('.section-title-compacto');
                
                if (!tabela) {
                    esconderSpinner();
                    mostrarAlerta('Nenhuma tabela encontrada para capturar!', '‚ö†Ô∏è Aviso', '#ffc107');
                    return;
                }
                
                // Criar container tempor√°rio que vai conter CLONES com estilos preservados
                const containerTemp = document.createElement('div');
                containerTemp.style.cssText = `
                    position: absolute;
                    left: -9999px;
                    top: 0;
                    background: white;
                    padding: 10px;
                `;
                
                // Clonar t√≠tulo se existir
                if (tituloSecao) {
                    const tituloClone = tituloSecao.cloneNode(true);
                    // Copiar estilos computados do t√≠tulo
                    const estilosTitulo = window.getComputedStyle(tituloSecao);
                    tituloClone.style.cssText = estilosTitulo.cssText;
                    containerTemp.appendChild(tituloClone);
                }
                
                // Clonar tabela PRESERVANDO todos os estilos computados
                const tabelaClone = tabela.cloneNode(true);
                
                // Fun√ß√£o para copiar estilos computados recursivamente
                function copiarEstilosComputados(elementoOriginal, elementoClone) {
                    const estilosComputados = window.getComputedStyle(elementoOriginal);
                    
                    // Copiar todos os estilos computados importantes
                    const estilosImportantes = [
                        'background-color', 'color', 'font-size', 'font-weight', 'font-family',
                        'padding', 'margin', 'border', 'border-color', 'border-width', 'border-style',
                        'text-align', 'vertical-align', 'line-height', 'width', 'height',
                        'min-width', 'max-width', 'min-height', 'max-height'
                    ];
                    
                    let cssText = '';
                    estilosImportantes.forEach(prop => {
                        const valor = estilosComputados.getPropertyValue(prop);
                        if (valor) {
                            cssText += `${prop}: ${valor}; `;
                        }
                    });
                    
                    elementoClone.style.cssText += cssText;
                    
                    // Copiar estilos dos filhos recursivamente
                    const filhosOriginais = elementoOriginal.children;
                    const filhosClone = elementoClone.children;
                    
                    for (let i = 0; i < filhosOriginais.length; i++) {
                        if (filhosClone[i]) {
                            copiarEstilosComputados(filhosOriginais[i], filhosClone[i]);
                        }
                    }
                }
                
                // Copiar estilos da tabela e todos os elementos internos
                copiarEstilosComputados(tabela, tabelaClone);
                
                // For√ßar table-layout e border-collapse da tabela original
                const estilosTabela = window.getComputedStyle(tabela);
                tabelaClone.style.tableLayout = estilosTabela.tableLayout;
                tabelaClone.style.borderCollapse = estilosTabela.borderCollapse;
                tabelaClone.style.borderSpacing = estilosTabela.borderSpacing;
                
                containerTemp.appendChild(tabelaClone);
                document.body.appendChild(containerTemp);
                
                // Aguardar renderiza√ß√£o completa
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // Capturar com html2canvas
                const canvas = await html2canvas(containerTemp, {
                    backgroundColor: '#ffffff',
                    scale: 3.3,  // Scale 2 para boa qualidade
                    logging: false,
                    useCORS: true,
                    allowTaint: true,
                    imageTimeout: 0,
                    windowWidth: containerTemp.scrollWidth,
                    windowHeight: containerTemp.scrollHeight
                });
                
                // Remover container tempor√°rio
                document.body.removeChild(containerTemp);
                
                // ===== TENTAR COPIAR PARA CLIPBOARD =====
                canvas.toBlob(async (blob) => {
                    try {
                        // Tentar usando Clipboard API moderna
                        await navigator.clipboard.write([
                            new ClipboardItem({ 'image/png': blob })
                        ]);
                        
                        esconderSpinner();
                        
                        mostrarAlerta(
                            '‚úÖ <strong>Imagem copiada com sucesso!</strong><br>',
                            '‚úÖ Sucesso',
                            '#28a745'
                        );
                        
                    } catch (clipboardError) {
                        esconderSpinner();
                        
                        console.error('Erro ao copiar para clipboard:', clipboardError);
                        
                        // ===== FALLBACK: DOWNLOAD AUTOM√ÅTICO =====
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = `agenda_${new Date().getTime()}.png`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                        
                        mostrarAlerta(
                            '‚ö†Ô∏è <strong>N√£o foi poss√≠vel copiar automaticamente</strong><br><br>' +
                            '‚úÖ A imagem foi <strong>baixada automaticamente</strong><br><br>' +
                            '<strong>Motivo:</strong> Seu navegador bloqueou o acesso √† √°rea de transfer√™ncia.<br><br>' +
                            '<strong>Solu√ß√£o alternativa:</strong><br>' +
                            '1. Localize o arquivo PNG baixado<br>' +
                            '2. Abra a imagem<br>' +
                            '3. Copie manualmente (Ctrl+C) e cole onde desejar<br><br>' +
                            '<em>Ou permita o acesso √† √°rea de transfer√™ncia nas configura√ß√µes do navegador.</em>',
                            '‚ÑπÔ∏è Download Realizado',
                            '#1a73e8'
                        );
                    }
                }, 'image/png');
                
            } catch (error) {
                esconderSpinner();
                console.error('Erro geral ao gerar imagem:', error);
                mostrarAlerta(
                    '‚ùå Erro ao gerar imagem.<br><br>' +
                    'Tente novamente ou use Print Screen manualmente.',
                    '‚ö†Ô∏è Erro',
                    '#dc3545'
                );
            }
        }        
        
        // Renderiza√ß√£o compacta para visualiza√ß√£o
        function renderizarSecaoMotoristasCompacta(dias) {
            let html = '<div class="section-title-compacto">üë≤ SEGEOP - MOTORISTAS</div>';
            html += '<table class="agenda-table"><thead><tr>';
            html += '<th class="col-numero">N.</th><th class="col-nome">Nome</th>';
            dias.forEach(d => html += `<th class="col-dia">${d.diaNome}<br>${d.diaNum}/${d.mes}</th>`);
            html += '</tr></thead><tbody>';
            
            motoristas.forEach((m, motoristaGlobalIndex) => {
                const demandasPorDia = dias.map(dia => {
                    return dadosAgenda.demandas.filter(d => 
                        d.id_motorista === m.id && 
                        d.dt_inicio <= dia.data && 
                        d.dt_fim >= dia.data
                    );
                });
                
                const maxDemandasPorDia = Math.max(...demandasPorDia.map(d => d.length), 1);
                const celulasRenderizadas = Array(maxDemandasPorDia).fill(0).map(() => Array(dias.length).fill(false));
                
                for (let linhaIndex = 0; linhaIndex < maxDemandasPorDia; linhaIndex++) {
                    html += `<tr>`;
                    
                    if (linhaIndex === 0) {
                        if (maxDemandasPorDia > 1) {
                            html += `<td class="col-numero" rowspan="${maxDemandasPorDia}">${motoristaGlobalIndex + 1}</td>`;
                            html += `<td class="col-nome" rowspan="${maxDemandasPorDia}">${m.nome}</td>`;
                        } else {
                            html += `<td class="col-numero">${motoristaGlobalIndex + 1}</td>`;
                            html += `<td class="col-nome">${m.nome}</td>`;
                        }
                    }
                    
                    for (let diaIndex = 0; diaIndex < dias.length; diaIndex++) {
                        if (celulasRenderizadas[linhaIndex][diaIndex]) continue;
                        
                        const dia = dias[diaIndex];
                        const feriado = isFeriado(dia.data);
                        const isWeekend = dia.diaIndex === 0 || dia.diaIndex === 6;
                        const demandasDia = demandasPorDia[diaIndex];
                        const demanda = demandasDia[linhaIndex];
                        
                        if (demanda) {
                            let rowspanCount = 1;
                            for (let proxLinha = linhaIndex + 1; proxLinha < maxDemandasPorDia; proxLinha++) {
                                if (!demandasDia[proxLinha]) {
                                    rowspanCount++;
                                    celulasRenderizadas[proxLinha][diaIndex] = true;
                                } else break;
                            }
                            
                            // USAR CLASSES DIN√ÇMICAS (mesmas da se√ß√£o principal)
                            const corClass = `tipo-${demanda.id_tipodemanda}`;
                            const feriadoClass = feriado ? 'cell-feriado-com-demanda' : '';
                            html += `<td class="${corClass} ${feriadoClass} col-dia" ${rowspanCount > 1 ? `rowspan="${rowspanCount}"` : ''}>`;
                            html += '<div class="cell-content">';
                            
                            const tipoConfig = tiposDemandaConfig[demanda.id_tipodemanda];
                            const bloqueiaSetorSolicitante = tipoConfig && tipoConfig.bloquear_setor && tipoConfig.bloquear_solicitante;
                            const isCedencia = tipoConfig && tipoConfig.setor_obrigatorio && !tipoConfig.bloquear_setor;
                            
                            if (bloqueiaSetorSolicitante) {
                                html += `<div><strong>${demanda.de_tipodemanda || tipoConfig.descricao}</strong></div>`;
                                if (demanda.destino) {
                                    html += `<div>${demanda.destino}</div>`;
                                }
                            }
                            else if (isCedencia) {
                                html += `<div><strong>${demanda.de_tipodemanda || tipoConfig.descricao}</strong></div>`;
                                if (demanda.setor) {
                                    html += `<div><strong>${demanda.setor}</strong></div>`;
                                }
                                if (demanda.nu_sei) {
                                    html += `<div>${demanda.nu_sei}</div>`;
                                }
                            }
                            else if (demanda.horario) {
                                // html += `<div><strong>${demanda.setor || ''}</strong>${demanda.solicitante ? ' (' + demanda.solicitante + ')' : ''}</div>`;
                                html += `<div><strong>${demanda.setor || ''}</strong>${demanda.solicitante ? ' (' + encurtarNomeSolicitante(demanda.solicitante) + ')' : ''}</div>`;
                                html += `<div>${demanda.destino || ''} <span class="demanda-horario">(${demanda.horario})</span></div>`;
                                html += `<div>${demanda.nu_sei || ''}</div>`;
                            }
                            else {
                                // html += `<div><strong>${demanda.setor || ''}</strong>${demanda.solicitante ? ' (' + demanda.solicitante + ')' : ''}</div>`;
                                html += `<div><strong>${demanda.setor || ''}</strong>${demanda.solicitante ? ' (' + encurtarNomeSolicitante(demanda.solicitante) + ')' : ''}</div>`;
                                html += `<div><strong>${demanda.destino || ''}</strong></div>`;
                                html += `<div>${demanda.nu_sei || ''}</div>`;
                            }
                            
                            const deveMostrarAvisoVeiculo = !demanda.id_tipoveiculo && 
                                                            tipoConfig && 
                                                            !tipoConfig.bloquear_tipo_veiculo && 
                                                            !tipoConfig.bloquear_veiculo;
                            
                            if (deveMostrarAvisoVeiculo) {
                                html += '<div class="informar-veiculo">(INFORMAR VE√çCULO)</div>';
                            }
                            
                            html += '</div></td>';
                            celulasRenderizadas[linhaIndex][diaIndex] = true;
                        } else {
                            let rowspanCount = 1;
                            for (let proxLinha = linhaIndex + 1; proxLinha < maxDemandasPorDia; proxLinha++) {
                                if (!demandasDia[proxLinha]) {
                                    rowspanCount++;
                                    celulasRenderizadas[proxLinha][diaIndex] = true;
                                } else break;
                            }
                            
                            if (feriado) {
                                html += `<td class="cell-feriado col-dia" ${rowspanCount > 1 ? `rowspan="${rowspanCount}"` : ''}>${feriado.descricao}</td>`;
                            } else {
                                const weekendClass = isWeekend ? 'weekend-empty' : '';
                                html += `<td class="empty-cell ${weekendClass} col-dia" ${rowspanCount > 1 ? `rowspan="${rowspanCount}"` : ''}></td>`;
                            }
                            celulasRenderizadas[linhaIndex][diaIndex] = true;
                        }
                    }
                    html += '</tr>';
                }
            });
            
            html += '</tbody></table>';
            return html;
        }

        function renderizarSecaoAdministrativoCompacta(dias) {
            let html = '<div class="section-title-compacto">üëî SEGEOP - ADMINISTRATIVO</div>';
            html += '<table class="agenda-table"><thead><tr>';
            html += '<th class="col-numero">N.</th><th class="col-nome">Nome</th>';
            dias.forEach(d => html += `<th class="col-dia">${d.diaNome}<br>${d.diaNum}/${d.mes}</th>`);
            html += '</tr></thead><tbody>';
            
            motoristasAdministrativo.forEach((m, motoristaGlobalIndex) => {
                const demandasPorDia = dias.map(dia => {
                    return dadosAgenda.demandas.filter(d => 
                        d.id_motorista === m.id && 
                        d.dt_inicio <= dia.data && 
                        d.dt_fim >= dia.data
                    );
                });
                
                const maxDemandasPorDia = Math.max(...demandasPorDia.map(d => d.length), 1);
                const celulasRenderizadas = Array(maxDemandasPorDia).fill(0).map(() => Array(dias.length).fill(false));
                
                for (let linhaIndex = 0; linhaIndex < maxDemandasPorDia; linhaIndex++) {
                    html += `<tr>`;
                    
                    if (linhaIndex === 0) {
                        if (maxDemandasPorDia > 1) {
                            html += `<td class="col-numero" rowspan="${maxDemandasPorDia}">${motoristaGlobalIndex + 1}</td>`;
                            html += `<td class="col-nome" rowspan="${maxDemandasPorDia}">${m.nome}</td>`;
                        } else {
                            html += `<td class="col-numero">${motoristaGlobalIndex + 1}</td>`;
                            html += `<td class="col-nome">${m.nome}</td>`;
                        }
                    }
                    
                    for (let diaIndex = 0; diaIndex < dias.length; diaIndex++) {
                        if (celulasRenderizadas[linhaIndex][diaIndex]) continue;
                        
                        const dia = dias[diaIndex];
                        const feriado = isFeriado(dia.data);
                        const isWeekend = dia.diaIndex === 0 || dia.diaIndex === 6;
                        const demandasDia = demandasPorDia[diaIndex];
                        const demanda = demandasDia[linhaIndex];
                        
                        if (demanda) {
                            let rowspanCount = 1;
                            for (let proxLinha = linhaIndex + 1; proxLinha < maxDemandasPorDia; proxLinha++) {
                                if (!demandasDia[proxLinha]) {
                                    rowspanCount++;
                                    celulasRenderizadas[proxLinha][diaIndex] = true;
                                } else break;
                            }
                            
                            const corClass = `tipo-${demanda.id_tipodemanda}`;
                            const feriadoClass = feriado ? 'cell-feriado-com-demanda' : '';
                            html += `<td class="${corClass} ${feriadoClass} col-dia" ${rowspanCount > 1 ? `rowspan="${rowspanCount}"` : ''}>`;
                            html += '<div class="cell-content">';
                            
                            const tipoConfig = tiposDemandaConfig[demanda.id_tipodemanda];
                            const bloqueiaSetorSolicitante = tipoConfig && tipoConfig.bloquear_setor && tipoConfig.bloquear_solicitante;
                            const isCedencia = tipoConfig && tipoConfig.setor_obrigatorio && !tipoConfig.bloquear_setor;
                            
                            if (bloqueiaSetorSolicitante) {
                                html += `<div><strong>${demanda.de_tipodemanda || tipoConfig.descricao}</strong></div>`;
                                if (demanda.destino) {
                                    html += `<div>${demanda.destino}</div>`;
                                }
                            }
                            else if (isCedencia) {
                                html += `<div><strong>${demanda.de_tipodemanda || tipoConfig.descricao}</strong></div>`;
                                if (demanda.setor) {
                                    html += `<div><strong>${demanda.setor}</strong></div>`;
                                }
                                if (demanda.nu_sei) {
                                    html += `<div>${demanda.nu_sei}</div>`;
                                }
                            }
                            else if (demanda.horario) {
                                // html += `<div><strong>${demanda.setor || ''}</strong>${demanda.solicitante ? ' (' + demanda.solicitante + ')' : ''}</div>`;
                                html += `<div><strong>${demanda.setor || ''}</strong>${demanda.solicitante ? ' (' + encurtarNomeSolicitante(demanda.solicitante) + ')' : ''}</div>`;
                                html += `<div>${demanda.destino || ''} <span class="demanda-horario">(${demanda.horario})</span></div>`;
                                html += `<div>${demanda.nu_sei || ''}</div>`;
                            }
                            else {
                                // html += `<div><strong>${demanda.setor || ''}</strong>${demanda.solicitante ? ' (' + demanda.solicitante + ')' : ''}</div>`;
                                html += `<div><strong>${demanda.setor || ''}</strong>${demanda.solicitante ? ' (' + encurtarNomeSolicitante(demanda.solicitante) + ')' : ''}</div>`;
                                html += `<div><strong>${demanda.destino || ''}</strong></div>`;
                                html += `<div>${demanda.nu_sei || ''}</div>`;
                            }
                            
                            const deveMostrarAvisoVeiculo = !demanda.id_tipoveiculo && 
                                                            tipoConfig && 
                                                            !tipoConfig.bloquear_tipo_veiculo && 
                                                            !tipoConfig.bloquear_veiculo;
                            
                            if (deveMostrarAvisoVeiculo) {
                                html += '<div class="informar-veiculo">(INFORMAR VE√çCULO)</div>';
                            }
                            
                            html += '</div></td>';
                            celulasRenderizadas[linhaIndex][diaIndex] = true;
                        } else {
                            let rowspanCount = 1;
                            for (let proxLinha = linhaIndex + 1; proxLinha < maxDemandasPorDia; proxLinha++) {
                                if (!demandasDia[proxLinha]) {
                                    rowspanCount++;
                                    celulasRenderizadas[proxLinha][diaIndex] = true;
                                } else break;
                            }
                            
                            if (feriado) {
                                html += `<td class="cell-feriado col-dia" ${rowspanCount > 1 ? `rowspan="${rowspanCount}"` : ''}>${feriado.descricao}</td>`;
                            } else {
                                const weekendClass = isWeekend ? 'weekend-empty' : '';
                                html += `<td class="empty-cell ${weekendClass} col-dia" ${rowspanCount > 1 ? `rowspan="${rowspanCount}"` : ''}></td>`;
                            }
                            celulasRenderizadas[linhaIndex][diaIndex] = true;
                        }
                    }
                    html += '</tr>';
                }
            });
            
            html += '</tbody></table>';
            return html;
        }        
         
        //renderizarSecaoMotoristasCompleta() - COMPLETA (Para Visualiza√ß√£o)**
        function renderizarSecaoMotoristasCompleta(dias, titulo) {
            let html = '<div class="agenda-section">';
            html += `<div class="section-title">${titulo}</div>`;
            html += '<table class="agenda-table"><thead><tr>';
            html += '<th class="col-numero">N.</th><th class="col-nome">Nome</th>';
            dias.forEach(d => html += `<th class="col-dia">${d.diaNome}<br>${d.diaNum}/${d.mes}</th>`);
            html += '</tr></thead><tbody>';
            
            motoristas.forEach((m, motoristaGlobalIndex) => {
                const demandasPorDia = dias.map(dia => {
                    return dadosAgenda.demandas.filter(d => 
                        d.id_motorista === m.id && 
                        d.dt_inicio <= dia.data && 
                        d.dt_fim >= dia.data
                    );
                });
                
                const maxDemandasPorDia = Math.max(...demandasPorDia.map(d => d.length), 1);
                const celulasRenderizadas = Array(maxDemandasPorDia).fill(0).map(() => Array(dias.length).fill(false));
                
                for (let linhaIndex = 0; linhaIndex < maxDemandasPorDia; linhaIndex++) {
                    html += `<tr>`;
                    
                    if (linhaIndex === 0) {
                        if (maxDemandasPorDia > 1) {
                            html += `<td class="col-numero" rowspan="${maxDemandasPorDia}">${motoristaGlobalIndex + 1}</td>`;
                            html += `<td class="col-nome" rowspan="${maxDemandasPorDia}">${m.nome}</td>`;
                        } else {
                            html += `<td class="col-numero">${motoristaGlobalIndex + 1}</td>`;
                            html += `<td class="col-nome">${m.nome}</td>`;
                        }
                    }
                    
                    for (let diaIndex = 0; diaIndex < dias.length; diaIndex++) {
                        if (celulasRenderizadas[linhaIndex][diaIndex]) continue;
                        
                        const dia = dias[diaIndex];
                        const feriado = isFeriado(dia.data);
                        const isWeekend = dia.diaIndex === 0 || dia.diaIndex === 6;
                        const demandasDia = demandasPorDia[diaIndex];
                        const demanda = demandasDia[linhaIndex];
                        
                        if (demanda) {
                            let rowspanCount = 1;
                            for (let proxLinha = linhaIndex + 1; proxLinha < maxDemandasPorDia; proxLinha++) {
                                if (!demandasDia[proxLinha]) {
                                    rowspanCount++;
                                    celulasRenderizadas[proxLinha][diaIndex] = true;
                                } else break;
                            }
                            
                            const corClass = `tipo-${demanda.id_tipodemanda}`;
                            const feriadoClass = feriado ? 'cell-feriado-com-demanda' : '';
                            html += `<td class="${corClass} ${feriadoClass} col-dia" ${rowspanCount > 1 ? `rowspan="${rowspanCount}"` : ''}>`;
                            html += '<div class="cell-content">';
                            
                            // ========== L√ìGICA DIN√ÇMICA BASEADA EM CONFIGURA√á√ÉO ==========
                            const tipoConfig = tiposDemandaConfig[demanda.id_tipodemanda];
                            
                            // Verificar se √© tipo que bloqueia setor e solicitante (ex: Oficina, Lava-Jato)
                            const bloqueiaSetorSolicitante = tipoConfig && tipoConfig.bloquear_setor && tipoConfig.bloquear_solicitante;
                            
                            // Verificar se √© tipo Ced√™ncia (setor obrigat√≥rio)
                            const isCedencia = tipoConfig && tipoConfig.setor_obrigatorio && !tipoConfig.bloquear_setor;
                            
                            if (bloqueiaSetorSolicitante) {
                                // Tipos como Oficina (ID 9) ou Lava-Jato (ID 12)
                                // NOTA: Na se√ß√£o MOTORISTAS SEGEOP n√£o h√° nc_motorista
                                html += `<div><strong>${demanda.de_tipodemanda || tipoConfig.descricao}</strong></div>`;
                                if (demanda.destino) {
                                    html += `<div>${demanda.destino}</div>`;
                                }
                            }
                            else if (isCedencia) {
                                // Tipo Ced√™ncia (ID 10)
                                // NOTA: Na se√ß√£o MOTORISTAS SEGEOP n√£o h√° nc_motorista
                                html += `<div><strong>${demanda.de_tipodemanda || tipoConfig.descricao}</strong></div>`;
                                if (demanda.setor) {
                                    html += `<div><strong>${demanda.setor}</strong></div>`;
                                }
                                if (demanda.nu_sei) {
                                    html += `<div>${demanda.nu_sei}</div>`;
                                }
                            }
                            else if (demanda.horario) {
                                // Qualquer tipo com hor√°rio definido
                                html += `<div><strong>${demanda.setor || ''}</strong>${demanda.solicitante ? ' (' + demanda.solicitante + ')' : ''}</div>`;
                                html += `<div>${demanda.destino || ''} <span class="demanda-horario">(${demanda.horario})</span></div>`;
                                html += `<div>${demanda.nu_sei || ''}</div>`;
                            }
                            else {
                                // Padr√£o para outros tipos
                                html += `<div><strong>${demanda.setor || ''}</strong>${demanda.solicitante ? ' (' + demanda.solicitante + ')' : ''}</div>`;
                                html += `<div><strong>${demanda.destino || ''}</strong></div>`;
                                html += `<div>${demanda.nu_sei || ''}</div>`;
                            }
                            
                            // Exibir aviso "INFORMAR VE√çCULO" se necess√°rio
                            const deveMostrarAvisoVeiculo = !demanda.id_tipoveiculo && 
                                                            tipoConfig && 
                                                            !tipoConfig.bloquear_tipo_veiculo && 
                                                            !tipoConfig.bloquear_veiculo;
                            
                            if (deveMostrarAvisoVeiculo) {
                                html += '<div class="informar-veiculo">(INFORMAR VE√çCULO)</div>';
                            }
                            
                            html += '</div></td>';
                            celulasRenderizadas[linhaIndex][diaIndex] = true;
                        } else {
                            let rowspanCount = 1;
                            for (let proxLinha = linhaIndex + 1; proxLinha < maxDemandasPorDia; proxLinha++) {
                                if (!demandasDia[proxLinha]) {
                                    rowspanCount++;
                                    celulasRenderizadas[proxLinha][diaIndex] = true;
                                } else break;
                            }
                            
                            if (feriado) {
                                html += `<td class="cell-feriado col-dia" ${rowspanCount > 1 ? `rowspan="${rowspanCount}"` : ''}>${feriado.descricao}</td>`;
                            } else {
                                const weekendClass = isWeekend ? 'weekend-empty' : '';
                                html += `<td class="empty-cell ${weekendClass} col-dia" ${rowspanCount > 1 ? `rowspan="${rowspanCount}"` : ''}></td>`;
                            }
                            celulasRenderizadas[linhaIndex][diaIndex] = true;
                        }
                    }
                    html += '</tr>';
                }
            });
            
            html += '</tbody></table></div>';
            return html;
        }

        // Fun√ß√£o para retornar √† p√°gina inicial
        function voltarPaginaInicial() {
            window.location.href = '/';
        }
        
        init();
        
    </script>
</body>
</html>
