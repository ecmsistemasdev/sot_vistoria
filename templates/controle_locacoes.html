<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Locações</title>
    <link rel="stylesheet" href="/static/css/controle_locacoes.css">    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="container-fluid mt-2">
        <h4 class="mb-3">Controle de Locações</h4>
        
        <div class="row">
            <!-- GroupBox - Processos de Locação -->
            <div class="col-md-6">
                <div class="groupbox">
                    <div class="groupbox-header">Processos de Locação</div>
                    <div class="groupbox-body">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Ano</th>
                                        <th>Fornecedor</th>
                                        <th>Nº SEI</th>
                                        <th>Nº Contrato</th>
                                        <th class="sticky-column">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="tabela-processos">
                                    <!-- Dados carregados via AJAX -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- GroupBox - Empenhos (com guias) -->
            <div class="col-md-6">
                <div class="groupbox">
                    <div class="tabs-body">
                        <!-- Guias (Tabs) -->
                        <ul class="nav nav-tabs" id="empenhosTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="empenhos-tab" data-bs-toggle="tab" 
                                        data-bs-target="#empenhos" type="button" role="tab" 
                                        aria-controls="empenhos" aria-selected="true">Empenhos</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="saldo-diarias-tab" data-bs-toggle="tab" 
                                        data-bs-target="#saldo-diarias" type="button" role="tab" 
                                        aria-controls="saldo-diarias" aria-selected="false">Saldo Diárias</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="dados-pls-tab" data-bs-toggle="tab" 
                                        data-bs-target="#dados-pls" type="button" role="tab" 
                                        aria-controls="dados-pls" aria-selected="true">Dados PLS</button>
                            </li>
                        </ul>
                        
                        <!-- Conteúdo das Guias -->
                        <div class="tab-content" id="empenhosTabsContent">
                            <!-- Guia Empenhos -->
                            <div class="tab-pane fade show active" id="empenhos" role="tabpanel" aria-labelledby="empenhos-tab">
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover">
                                        <thead>
                                            <tr>
                                                <th>Nº Empenho</th>
                                                <th>Vl. Empenho</th>
                                                <th>Vl. Diárias</th>
                                                <th>Vl. Dif.</th>
                                                <th>Vl. Total Util.</th>
                                                <th>Valor Saldo</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tabela-empenhos">
                                            <!-- Dados carregados via AJAX -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Guia Saldo Diárias -->
                            <div class="tab-pane fade" id="saldo-diarias" role="tabpanel" aria-labelledby="saldo-diarias-tab">
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover">
                                        <thead>
                                            <tr>
                                                <th>Veículo</th>
                                                <th>Vl. Diária</th>
                                                <th>Qtd. Diária</th>
                                                <th>Qtd. Util.</th>
                                                <th>Qtd. Saldo</th>
                                                <th>Valor Total</th>
                                                <th>Valor Util.</th>
                                                <th>Valor Saldo</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tabela-saldo-diarias">
                                            <!-- Dados carregados via AJAX -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Guia Dados PLS -->
                            <div class="tab-pane fade" id="dados-pls" role="tabpanel" aria-labelledby="dados-pls-tab">
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover">
                                        <thead>
                                            <tr>
                                                <th>Mês/Ano</th>
                                                <th>Qtde Locação</th>
                                                <th>Valor</th>
                                                <th>Combustível</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tabela-dados-pls">
                                            <!-- Dados carregados via AJAX -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- GroupBox - Locações em Trânsito -->
        <div class="row">
            <div class="col-12">
                <div class="groupbox">
                    <div class="groupbox-header">Locações em Trânsito</div>
                    <div class="groupbox-body lista-grande">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Mês/Ano</th>
                                        <th>Veículo</th>
                                        <th>Mod. Veículo</th>
                                        <th>Início</th>
                                        <th>Fim</th>
                                        <th>Diárias</th>
                                        <th>Valor Total</th>
                                        <th>Motorista</th>
                                        <th class="sticky-column">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="tabela-transito">
                                    <!-- Dados carregados via AJAX -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- GroupBox - Locações Finalizadas (com filtro) -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="groupbox">
                    <div class="groupbox-header d-flex justify-content-between align-items-center">
                        <span>Locações Finalizadas</span>
                        <div class="d-flex align-items-center">
                            <label for="filtroMesAno" class="me-2 mb-0">Filtro:</label>
                            <select id="filtroMesAno" class="form-select form-select-sm" style="width: auto;">
                                <option value="Todos">Todos</option>
                                <!-- Opções carregadas via AJAX -->
                            </select>
                        </div>
                    </div>
                    <div class="groupbox-body lista-grande">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Mês/Ano</th>
                                        <th>Veículo</th>
                                        <th>Mod. Veículo</th>
                                        <th>Início</th>
                                        <th>Fim</th>
                                        <th>Diárias</th>
                                        <th>Valor Total</th>
                                        <th>Motorista</th>
                                        <th class="sticky-column">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="tabela-finalizadas">
                                    <!-- Dados carregados via AJAX -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer (novo, baseado no footer da página de motoristas) -->
    <div class="footer">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <button id="btnNovaLocacao" class="btn btn-success me-2">
                        <i class="fas fa-plus-circle"></i> Nova Locação
                    </button>
                    <button id="btnRelatorioAnalitico" class="btn btn-info">
                        <i class="fas fa-file-alt"></i> Relatório Analítico
                    </button>
                </div>
                <button id="btnVoltar" class="btn btn-secondary" onclick="window.location.href='/';">
                    <i class="fas fa-arrow-left"></i> Voltar
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js"></script>
    <script>
        // Variáveis globais
        let processoIdSelecionado = null;
        let locacoesFinalizadasCompletas = []; // Para armazenar todas as locações finalizadas
        
        // Carregar lista de processos ao iniciar a página
        $(document).ready(function() {
            carregarProcessos();
            
            // Ação do botão Nova Locação
            $('#btnNovaLocacao').click(function() {
                // Aqui você irá adicionar a função posteriormente
                console.log("Botão Nova Locação clicado");
                alert("Funcionalidade em desenvolvimento");
            });
            
            // Evento de mudança no filtro de mês/ano
            $('#filtroMesAno').change(function() {
                aplicarFiltroMesAno();
            });

            $('#btnRelatorioAnalitico').click(function() {
                if (processoIdSelecionado) {
                    window.location.href = `/rel_locacao_analitico?id_cl=${processoIdSelecionado}`;
                } else {
                    alert("Por favor, selecione um processo de locação primeiro.");
                }
            });
        });
        
        // Função para carregar processos de locação
        function carregarProcessos() {
            $.ajax({
                url: '/api/processos_locacao',
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    let html = '';
                    data.forEach(function(item) {
                        html += `<tr>
                            <td>${item.ID_CL}</td>
                            <td>${item.ANO_EXERCICIO}</td>
                            <td>${item.NM_FORNECEDOR}</td>
                            <td>${item.NU_SEI}</td>
                            <td>${item.NU_CONTRATO}</td>
                            <td class="sticky-column">
                                <a href="javascript:void(0)" onclick="selecionarProcesso(${item.ID_CL})" class="btn-selecionar">Selecionar</a>
                            </td>
                        </tr>`;
                    });
                    $('#tabela-processos').html(html);
                },
                error: function(xhr, status, error) {
                    console.error("Erro ao carregar processos:", error);
                    alert("Erro ao carregar dados. Verifique o console para mais detalhes.");
                }
            });
        }
        
        // Função para selecionar um processo e carregar os dados relacionados
        function selecionarProcesso(id_cl) {
            console.log("Selecionando processo ID:", id_cl);
            processoIdSelecionado = id_cl;
            
            // Obter o nome do fornecedor a partir da tabela
            const fornecedorNome = $(`#tabela-processos tr:has(td:contains(${id_cl}):first-child) td:nth-child(3)`).text();
            
            // Armazenar no localStorage
            localStorage.setItem('fornecedorNome', fornecedorNome);
            console.log("Nome do fornecedor armazenado:", fornecedorNome);

            // Carregar empenhos
            $.ajax({
                url: `/api/empenhos/${id_cl}`,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    console.log("Empenhos carregados:", data);
                    let html = '';
                    if (data.length === 0) {
                        html = '<tr><td colspan="6" class="text-center">Nenhum empenho encontrado</td></tr>';
                    } else {
                        data.forEach(function(item) {
                            html += `<tr>
                                <td>${item.NU_EMPENHO}</td>
                                <td>R$ ${formatarValor(item.VL_EMPENHO)}</td>
                                <td>R$ ${formatarValor(item.VL_DIARIAS)}</td>
                                <td>R$ ${formatarValor(item.VL_DIF)}</td>
                                <td>R$ ${formatarValor(item.VL_UTILIZADO)}</td>
                                <td>R$ ${formatarValor(item.VL_SALDO)}</td>
                            </tr>`;
                        });
                    }
                    $('#tabela-empenhos').html(html);
                },
                error: function(xhr, status, error) {
                    console.error("Erro ao carregar empenhos:", error);
                    $('#tabela-empenhos').html('<tr><td colspan="6" class="text-center text-danger">Erro ao carregar dados</td></tr>');
                }
            });
            
            // Carregar saldo de diárias
            $.ajax({
                url: `/api/saldo_diarias/${id_cl}`,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    console.log("Saldo de diárias carregado:", data);
                    let html = '';
                    if (data.length === 0) {
                        html = '<tr><td colspan="8" class="text-center">Nenhum registro encontrado</td></tr>';
                    } else {
                        data.forEach(function(item) {
                            html += `<tr>
                                <td>${item.DE_VEICULO}</td>
                                <td>R$ ${formatarValor(item.VL_DIARIA_KM)}</td>
                                <td>${item.QT_DK}</td>
                                <td>${item.QT_UTILIZADO}</td>
                                <td>${item.QT_SALDO}</td>
                                <td>R$ ${formatarValor(item.VALOR_TOTAL)}</td>
                                <td>R$ ${formatarValor(item.VL_UTILIZADO)}</td>
                                <td>R$ ${formatarValor(item.VL_SALDO)}</td>
                            </tr>`;
                        });
                    }
                    $('#tabela-saldo-diarias').html(html);
                },
                error: function(xhr, status, error) {
                    console.error("Erro ao carregar saldo de diárias:", error);
                    $('#tabela-saldo-diarias').html('<tr><td colspan="8" class="text-center text-danger">Erro ao carregar dados</td></tr>');
                }
            });

            // Carregar dados do PLS
            $.ajax({
                url: `/api/dados_pls/${id_cl}`,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    console.log("Dados do PLS carregado:", data);
                    let html = '';
                    if (data.length === 0) {
                        html = '<tr><td colspan="8" class="text-center">Nenhum registro encontrado</td></tr>';
                    } else {
                        data.forEach(function(item) {
                            html += `<tr>
                                <td>${item.MES_ANO}</td>
                                <td>${item.QTD}</td>
                                <td>R$ ${formatarValor(item.VLTOTAL)}</td>
                                <td>${item.COMBUSTIVEL}</td>
                            </tr>`;
                        });
                    }
                    $('#tabela-dados-pls').html(html);
                },
                error: function(xhr, status, error) {
                    console.error("Erro ao carregar saldo de diárias:", error);
                    $('#tabela-dados-pls').html('<tr><td colspan="8" class="text-center text-danger">Erro ao carregar dados</td></tr>');
                }
            });            
            
            // Carregar locações em trânsito
            $.ajax({
                url: `/api/locacoes_transito/${id_cl}`,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    console.log("Locações em trânsito carregadas:", data);
                    let html = '';
                    if (data.length === 0) {
                        html = '<tr><td colspan="10" class="text-center">Nenhuma locação em trânsito encontrada</td></tr>';
                    } else {
                        data.forEach(function(item) {
                            html += `<tr>
                                <td>${item.ID_ITEM}</td>
                                <td>${item.MES_ANO}</td>
                                <td>${item.DE_VEICULO}</td>
                                <td>${item.DS_VEICULO_MOD}</td>
                                <td>${formatarDataString(item.DT_INICIAL)}</td>
                                <td>${formatarDataString(item.DT_FINAL)}</td>
                                <td>${item.QT_DIARIA_KM}</td>
                                <td>R$ ${formatarValor(item.VL_TOTALITEM)}</td>
                                <td>${item.MOTORISTA}</td>
                                <td class="sticky-column">
                                    <div class="d-flex justify-content-around">
                                        <a href="javascript:void(0)" class="btn btn-sm btn-primary" title="Abrir">
                                            <i class="fas fa-folder-open"></i>
                                        </a>
                                        <a href="javascript:void(0)" class="btn btn-sm btn-danger ms-1" title="Devolução">
                                            <i class="fas fa-undo-alt"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>`;
                        });
                    }
                    $('#tabela-transito').html(html);
                },
                error: function(xhr, status, error) {
                    console.error("Erro ao carregar locações em trânsito:", error);
                    console.error("Status:", xhr.status);
                    console.error("Resposta:", xhr.responseText);
                    $('#tabela-transito').html('<tr><td colspan="10" class="text-center text-danger">Erro ao carregar dados</td></tr>');
                }
            });
            
            // Carregar opções de filtro para mês/ano
            $.ajax({
                url: `/api/meses_locacoes/${id_cl}`,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    console.log("Opções de mês/ano carregadas:", data);
                    let selectHtml = '<option value="Todos">Todos</option>';
                    data.forEach(function(item) {
                        selectHtml += `<option value="${item.MES_ANO}">${item.MES_ANO}</option>`;
                    });
                    $('#filtroMesAno').html(selectHtml);
                },
                error: function(xhr, status, error) {
                    console.error("Erro ao carregar opções de mês/ano:", error);
                    $('#filtroMesAno').html('<option value="Todos">Todos</option>');
                }
            });
            
            // Carregar locações finalizadas
            carregarLocacoesFinalizadas(id_cl);
        }
        
        // Função para carregar locações finalizadas
        function carregarLocacoesFinalizadas(id_cl) {
            $.ajax({
                url: `/api/locacoes_finalizadas/${id_cl}`,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    console.log("Locações finalizadas carregadas:", data);
                    // Armazenar os dados completos para filtrar depois
                    locacoesFinalizadasCompletas = data;
                    
                    // Exibir todos os dados inicialmente
                    exibirLocacoesFinalizadas(data);
                },
                error: function(xhr, status, error) {
                    console.error("Erro ao carregar locações finalizadas:", error);
                    console.error("Status:", xhr.status);
                    console.error("Resposta:", xhr.responseText);
                    $('#tabela-finalizadas').html('<tr><td colspan="10" class="text-center text-danger">Erro ao carregar dados</td></tr>');
                }
            });
        }
        
        // Função para exibir locações finalizadas na tabela
        function exibirLocacoesFinalizadas(data) {
            let html = '';
            if (data.length === 0) {
                html = '<tr><td colspan="10" class="text-center">Nenhuma locação finalizada encontrada</td></tr>';
            } else {
                data.forEach(function(item) {
                    html += `<tr>
                        <td>${item.ID_ITEM}</td>
                        <td>${item.MES_ANO}</td>
                        <td>${item.DE_VEICULO}</td>
                        <td>${item.DS_VEICULO_MOD}</td>
                        <td>${formatarDataString(item.DT_INICIAL)}</td>
                        <td>${formatarDataString(item.DT_FINAL)}</td>
                        <td>${item.QT_DIARIA_KM}</td>
                        <td>R$ ${formatarValor(item.VL_TOTALITEM)}</td>
                        <td>${item.MOTORISTA}</td>
                        <td class="sticky-column">
                            <a href="javascript:void(0)" class="acao-btn btn-abrir">Visualizar</a>
                        </td>
                    </tr>`;
                });
            }
            $('#tabela-finalizadas').html(html);
        }
        
        // Função para aplicar filtro por mês/ano
        function aplicarFiltroMesAno() {
            const filtroSelecionado = $('#filtroMesAno').val();
            
            if (filtroSelecionado === 'Todos') {
                // Exibir todos os dados
                exibirLocacoesFinalizadas(locacoesFinalizadasCompletas);
            } else {
                // Filtrar os dados pelo mês/ano selecionado
                const dadosFiltrados = locacoesFinalizadasCompletas.filter(item => item.MES_ANO === filtroSelecionado);
                exibirLocacoesFinalizadas(dadosFiltrados);
            }
        }
        
        // Função para formatar valores monetários
        function formatarValor(valor) {
            if (valor === null || valor === undefined) return '0,00';
            return parseFloat(valor).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }
        
        // Função para formatar datas (string no formato dd/mm/yyyy)
        function formatarDataString(dataStr) {
            if (!dataStr) return '';
            
            // Verifica se a data já está no formato desejado (dd/mm/yyyy)
            if (typeof dataStr === 'string' && dataStr.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                return dataStr; // Já está no formato correto, retorna a própria string
            }
            
            // Tenta converter usando o formato ISO
            try {
                const dt = new Date(dataStr);
                if (!isNaN(dt.getTime())) {
                    return dt.toLocaleDateString('pt-BR');
                }
            } catch (e) {
                console.error("Erro ao formatar data como ISO:", e);
            }
            
            // Se não conseguiu converter como ISO, tenta outros formatos comuns
            try {
                // Tenta extrair dia, mês e ano para os casos onde dataStr é algo como "dd/mm/yyyy"
                // ou quando é uma string em outro formato que precisa ser manipulado
                let dia, mes, ano;
                
                // Formato dd/mm/yyyy
                const formatoBR = dataStr.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
                if (formatoBR) {
                    dia = formatoBR[1];
                    mes = formatoBR[2];
                    ano = formatoBR[3];
                    return `${dia}/${mes}/${ano}`;
                }
                
                // Formato yyyy-mm-dd ou yyyy/mm/dd
                const formatoISO = dataStr.match(/^(\d{4})[\/-](\d{2})[\/-](\d{2})$/);
                if (formatoISO) {
                    dia = formatoISO[3];
                    mes = formatoISO[2];
                    ano = formatoISO[1];
                    return `${dia}/${mes}/${ano}`;
                }
                
                // Se chegou até aqui, retorna a string original
                return dataStr;
            } catch (e) {
                console.error("Erro ao formatar data com regex:", e);
                return dataStr; // Em caso de erro, retorna o valor original
            }
        }
    </script>
</body>
</html>
