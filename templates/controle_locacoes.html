<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Locações</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            padding-bottom: 80px; /* Espaço para o footer */
            margin: 0;
            overflow-x: hidden;
        }
        .groupbox {
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 15px;
            padding: 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .groupbox-header {
            background-color: #f5f5f5;
            padding: 5px 15px; /* Reduzido de 8px para 5px */
            border-bottom: 1px solid #ddd;
            font-weight: 600;
            border-radius: 4px 4px 0 0;
            font-size: 0.9rem;
        }
        .groupbox-body {
            padding: 0; /* Removido o padding 10px;*/
            overflow-x: auto;
            height: calc(90px + 2rem);
        }
        .tabs-body {
            padding: 0; /* Removido o padding */
            overflow-x: auto;
            height: calc(130px + 2rem);
        }
        .lista-grande {
            height: 300px; /* Altura fixa para desktop calc(100vh - 450px); */ 
            min-height: 250px;
        }
        .table-responsive {
            height: 100%;
            overflow-y: auto;
        }
        .acao-btn {
            margin-bottom: 5px;
            display: block;
            text-align: center;
        }
        .btn-selecionar {
            background-color: #0d6efd;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            text-decoration: none;
            font-size: 0.75rem;
        }
        .btn-abrir {
            background-color: #198754;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            text-decoration: none;
            font-size: 0.75rem;
        }
        .btn-devolucao {
            background-color: #dc3545;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            text-decoration: none;
            font-size: 0.75rem;
        }
        .btn-sm {
            padding: 0.2rem 0.4rem;
            font-size: 0.75rem;
        }        
        .sticky-column {
            position: sticky;
            right: 0;
            background-color: #f8f9fa !important;
            z-index: 2;
            border-left: 1px solid #e0e0e0;
        }
        
        th.sticky-column {
            position: sticky;
            right: 0;
            background-color: #9ecde2 !important;
            z-index: 999;
            border-left: 1px solid #e0e0e0;
        }
        
        thead {
            z-index: 1000;
        }
        
        @media (max-width: 768px) {
            .sticky-column {
                position: sticky;
                right: 0;
                z-index: 2;
            }
            .groupbox-body {
                height: calc(150px + 2rem);
            }
            .lista-grande {
                height: calc(100vh - 350px);
                min-height: 200px; /* 300px; */
            }
            .footer .container-fluid {
                padding: 0 10px;
            }
        }
        .table-hover tbody tr:hover {
            background-color: rgba(0,0,0,.05);
        }
        th {
            position: sticky;
            top: 0;
            background-color: #9ecde2 !important;
            z-index: 998;
            font-size: 0.8rem;
        }
        .table {
            font-size: 0.8rem;
            margin-bottom: 0; /* Removendo a margem inferior das tabelas */
        }
        td {
            padding: 0.25rem 0.5rem !important;
            vertical-align: middle;
        }
        .table-sm td, .table-sm th {
            padding: 0.2rem 0.5rem;
        }
        
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #fff;
            border-top: 1px solid #ddd;
            padding: 15px 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            height: auto;
            display: flex;
            align-items: center;
            z-index: 1000;
        }
        
        .footer .container-fluid {
            width: 100%;
            padding: 0px 15px 0 15px;
        }
        
        .footer .d-flex {
            width: 100%;
        }
        
        /* Estilos ajustados para as guias (tabs) */
        .nav-tabs {
            border-bottom: 1px solid #ddd;
            margin-bottom: 0; /* Removida a margem inferior */
            font-size: 0.85rem;
            background-color: #f5f5f5;
            padding-top: 5px;
            padding-left: 5px;
            border-radius: 4px 4px 0 0;
        }
        
        .nav-tabs .nav-link {
            padding: 0.3rem 0.8rem;
            margin-bottom: -1px;
            border: 1px solid transparent;
            border-top-left-radius: 0.25rem;
            border-top-right-radius: 0.25rem;
        }
        
        .nav-tabs .nav-link.active {
            background-color: #fff;
            border-color: #ddd #ddd #fff;
        }
        
        .tab-content {
            background-color: #fff;
            padding: 0; /* Removido o padding */
            height: calc(100% - 32px); /* Ajuste para considerar a altura das tabs */
            overflow: hidden;
        }
        
        .tab-pane {
            height: 100%;
            overflow: hidden;
        }
        
        .tab-pane .table-responsive {
            height: 100%;
            overflow-y: auto;
            border-top: 0;
        }
        
        @media print {
            .footer {
                display: none; /* Ocultar no modo impressão */
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-2">
        <h4 class="mb-3">Controle de Locações</h4>
        
        <div class="row">
            <!-- GroupBox - Processos de Locação -->
            <div class="col-md-6">
                <div class="groupbox">
                    <div class="groupbox-header">Processos de Locação</div>
                    <div class="groupbox-body">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Ano</th>
                                        <th>Fornecedor</th>
                                        <th>Nº SEI</th>
                                        <th>Nº Contrato</th>
                                        <th class="sticky-column">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="tabela-processos">
                                    <!-- Dados carregados via AJAX -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- GroupBox - Empenhos (com guias) -->
            <div class="col-md-6">
                <div class="groupbox">
                    <div class="tabs-body">
                        <!-- Guias (Tabs) -->
                        <ul class="nav nav-tabs" id="empenhosTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="empenhos-tab" data-bs-toggle="tab" 
                                        data-bs-target="#empenhos" type="button" role="tab" 
                                        aria-controls="empenhos" aria-selected="true">Empenhos</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="saldo-diarias-tab" data-bs-toggle="tab" 
                                        data-bs-target="#saldo-diarias" type="button" role="tab" 
                                        aria-controls="saldo-diarias" aria-selected="false">Saldo Diárias</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="dados-pls-tab" data-bs-toggle="tab" 
                                        data-bs-target="#dados-pls" type="button" role="tab" 
                                        aria-controls="dados-pls" aria-selected="true">Dados PLS</button>
                            </li>
                        </ul>
                        
                        <!-- Conteúdo das Guias -->
                        <div class="tab-content" id="empenhosTabsContent">
                            <!-- Guia Empenhos -->
                            <div class="tab-pane fade show active" id="empenhos" role="tabpanel" aria-labelledby="empenhos-tab">
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover">
                                        <thead>
                                            <tr>
                                                <th>Nº Empenho</th>
                                                <th>Vl. Empenho</th>
                                                <th>Vl. Diárias</th>
                                                <th>Vl. Dif.</th>
                                                <th>Vl. Total Util.</th>
                                                <th>Valor Saldo</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tabela-empenhos">
                                            <!-- Dados carregados via AJAX -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Guia Saldo Diárias -->
                            <div class="tab-pane fade" id="saldo-diarias" role="tabpanel" aria-labelledby="saldo-diarias-tab">
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover">
                                        <thead>
                                            <tr>
                                                <th>Veículo</th>
                                                <th>Vl. Diária</th>
                                                <th>Qtd. Diária</th>
                                                <th>Qtd. Util.</th>
                                                <th>Qtd. Saldo</th>
                                                <th>Valor Total</th>
                                                <th>Valor Util.</th>
                                                <th>Valor Saldo</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tabela-saldo-diarias">
                                            <!-- Dados carregados via AJAX -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Guia Dados PLS -->
                            <div class="tab-pane fade" id="dados-pls" role="tabpanel" aria-labelledby="dados-pls-tab">
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover">
                                        <thead>
                                            <tr>
                                                <th>Mês/Ano</th>
                                                <th>Qtde Locação</th>
                                                <th>Valor</th>
                                                <th>Combustível</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tabela-dados-pls">
                                            <!-- Dados carregados via AJAX -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- GroupBox - Locações em Trânsito -->
        <div class="row">
            <div class="col-12">
                <div class="groupbox">
                    <div class="groupbox-header">Locações em Trânsito</div>
                    <div class="groupbox-body lista-grande">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Mês/Ano</th>
                                        <th>Veículo</th>
                                        <th>Mod. Veículo</th>
                                        <th>Início</th>
                                        <th>Fim</th>
                                        <th>Diárias</th>
                                        <th>Valor Total</th>
                                        <th>Motorista</th>
                                        <th class="sticky-column">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="tabela-transito">
                                    <!-- Dados carregados via AJAX -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- GroupBox - Locações Finalizadas (com filtro) -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="groupbox">
                    <div class="groupbox-header d-flex justify-content-between align-items-center">
                        <span>Locações Finalizadas</span>
                        <div class="d-flex align-items-center">
                            <label for="filtroMesAno" class="me-2 mb-0">Filtro:</label>
                            <select id="filtroMesAno" class="form-select form-select-sm" style="width: auto;">
                                <option value="Todos">Todos</option>
                                <!-- Opções carregadas via AJAX -->
                            </select>
                        </div>
                    </div>
                    <div class="groupbox-body lista-grande">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Mês/Ano</th>
                                        <th>Veículo</th>
                                        <th>Mod. Veículo</th>
                                        <th>Início</th>
                                        <th>Fim</th>
                                        <th>Diárias</th>
                                        <th>Valor Total</th>
                                        <th>Motorista</th>
                                        <th class="sticky-column">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="tabela-finalizadas">
                                    <!-- Dados carregados via AJAX -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer (novo, baseado no footer da página de motoristas) -->
    <div class="footer">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <button id="btnNovaLocacao" class="btn btn-success me-2">
                        <i class="fas fa-plus-circle"></i> Nova Locação
                    </button>
                    <button id="btnRelatorioAnalitico" class="btn btn-info">
                        <i class="fas fa-file-alt"></i> Relatório Analítico
                    </button>
                </div>
                <button id="btnVoltar" class="btn btn-secondary" onclick="window.location.href='/';">
                    <i class="fas fa-arrow-left"></i> Voltar
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal para Nova Locação -->
    <div class="modal fade" id="modalNovaLocacao" tabindex="-1" aria-labelledby="modalNovaLocacaoLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalNovaLocacaoLabel">Nova Locação de Veículo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <form id="formNovaLocacao">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="setorSolicitante" class="form-label">Setor Solicitante</label>
                                <select class="form-select" id="setorSolicitante" name="setor_solicitante" required>
                                    <option value="">Selecione...</option>
                                    <!-- Opções carregadas via AJAX -->
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="veiculoLocacao" class="form-label">Veículo</label>
                                <select class="form-select" id="veiculoLocacao" name="id_veiculo_loc" required>
                                    <option value="">Selecione...</option>
                                    <!-- Opções carregadas via AJAX -->
                                </select>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label for="objetivo" class="form-label">Objetivo</label>
                                <textarea class="form-control" id="objetivo" name="objetivo" rows="2" maxlength="300" required></textarea>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="motorista" class="form-label">Motorista</label>
                                <select class="form-select" id="motorista" name="id_motorista" required>
                                    <option value="">Selecione...</option>
                                    <!-- Opções carregadas via AJAX -->
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="nuSei" class="form-label">Número SEI</label>
                                <input type="text" class="form-control" id="nuSei" name="nu_sei" 
                                       placeholder="0000000-00.0000.0.00.0000" 
                                       pattern="[0-9]{7}-[0-9]{2}\.[0-9]{4}\.[0-9]\.[0-9]{2}\.[0-9]{4}" required>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="dataInicio" class="form-label">Data Início</label>
                                <input type="date" class="form-control" id="dataInicio" name="data_inicio" required>
                            </div>
                            <div class="col-md-4">
                                <label for="dataFim" class="form-label">Data Fim</label>
                                <input type="date" class="form-control" id="dataFim" name="data_fim" required>
                            </div>
                            <div class="col-md-4">
                                <label for="horaInicio" class="form-label">Hora Início</label>
                                <input type="time" class="form-control" id="horaInicio" name="hora_inicio" required>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="qtDiariaKm" class="form-label">Quantidade de Diárias</label>
                                <input type="number" class="form-control" id="qtDiariaKm" name="qt_diaria_km" readonly>
                            </div>
                            <div class="col-md-4">
                                <label for="vlDk" class="form-label">Valor da Diária (R$)</label>
                                <input type="text" class="form-control" id="vlDk" name="vl_dk" readonly>
                            </div>
                            <div class="col-md-4">
                                <label for="vlTotalitem" class="form-label">Valor Total (R$)</label>
                                <input type="text" class="form-control" id="vlTotalitem" name="vl_totalitem" readonly>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label for="obs" class="form-label">Observações</label>
                                <textarea class="form-control" id="obs" name="obs" rows="2" maxlength="200"></textarea>
                            </div>
                        </div>
                        
                        <!-- Área para upload de CNH caso necessário -->
                        <div id="areaCnh" class="row mb-3 d-none">
                            <div class="col-md-12">
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle"></i> 
                                    É necessário anexar a CNH do motorista para prosseguir.
                                </div>
                                <label for="fileCnh" class="form-label">Anexar CNH</label>
                                <input class="form-control" type="file" id="fileCnh" name="file_cnh" accept=".pdf">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </button>
                    <button type="button" class="btn btn-success" id="btnSalvarLocacao">
                        <i class="fas fa-save"></i> Salvar
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js"></script>
    <script>
        // Variáveis globais
        let processoIdSelecionado = null;
        let locacoesFinalizadasCompletas = []; // Para armazenar todas as locações finalizadas
        
        // Carregar lista de processos ao iniciar a página
        $(document).ready(function() {
            carregarProcessos();
            
            // Ação do botão Nova Locação
            $('#btnNovaLocacao').click(function() {
                // Aqui você irá adicionar a função posteriormente
                console.log("Botão Nova Locação clicado");
                alert("Funcionalidade em desenvolvimento");
            });
            
            // Evento de mudança no filtro de mês/ano
            $('#filtroMesAno').change(function() {
                aplicarFiltroMesAno();
            });

            $('#btnRelatorioAnalitico').click(function() {
                if (processoIdSelecionado) {
                    window.location.href = `/rel_locacao_analitico?id_cl=${processoIdSelecionado}`;
                } else {
                    alert("Por favor, selecione um processo de locação primeiro.");
                }
            });

            // Configurar o botão Nova Locação
            $('#btnNovaLocacao').click(function() {
                if (!processoIdSelecionado) {
                    alert("Por favor, selecione um processo de locação primeiro.");
                    return;
                }
                
                // Esconder o footer da página
                $('.footer').hide();
                
                // Limpar o formulário
                $('#formNovaLocacao')[0].reset();
                $('#areaCnh').addClass('d-none');
                
                // Pré-configurar campos de data e hora
                const hoje = new Date();
                const dataFormatada = hoje.toISOString().split('T')[0]; // formato yyyy-mm-dd para input date
                $('#dataInicio').val(dataFormatada);
                $('#dataFim').val(dataFormatada);
                $('#horaInicio').val('07:00'); // hora padrão
                
                // Carregar os dados necessários para o formulário
                carregarSetores();
                carregarVeiculos(processoIdSelecionado);
                carregarMotoristas();
                
                // Mostrar o modal
                $('#modalNovaLocacao').modal('show');
            });
            
            // Fechar modal e mostrar footer novamente
            $('#modalNovaLocacao').on('hidden.bs.modal', function () {
                $('.footer').show();
            });
            
            // Formatação do campo Número SEI
            $('#nuSei').on('input', function() {
                let value = $(this).val().replace(/\D/g, ''); // Remove não-dígitos
                
                if (value.length > 0) {
                    // Aplicar máscara 0000000-00.0000.0.00.0000
                    value = value.substring(0, 19); // Limita a 19 dígitos
                    
                    let formattedValue = '';
                    if (value.length > 7) {
                        formattedValue += value.substring(0, 7) + '-';
                        if (value.length > 9) {
                            formattedValue += value.substring(7, 9) + '.';
                            if (value.length > 13) {
                                formattedValue += value.substring(9, 13) + '.';
                                if (value.length > 14) {
                                    formattedValue += value.substring(13, 14) + '.';
                                    if (value.length > 16) {
                                        formattedValue += value.substring(14, 16) + '.';
                                        if (value.length > 19) {
                                            formattedValue += value.substring(16, 20);
                                        } else {
                                            formattedValue += value.substring(16);
                                        }
                                    } else {
                                        formattedValue += value.substring(14);
                                    }
                                } else {
                                    formattedValue += value.substring(13);
                                }
                            } else {
                                formattedValue += value.substring(9);
                            }
                        } else {
                            formattedValue += value.substring(7);
                        }
                    } else {
                        formattedValue = value;
                    }
                    
                    $(this).val(formattedValue);
                }
            });
            
            // Ao selecionar um veículo, preencher o valor da diária
            $('#veiculoLocacao').change(function() {
                const veiculosSelecionado = $(this).find('option:selected');
                const valorDiaria = veiculosSelecionado.data('valor');
                
                if (valorDiaria) {
                    $('#vlDk').val(formatarValorMoeda(valorDiaria));
                    calcularTotais();
                } else {
                    $('#vlDk').val('');
                    $('#vlTotalitem').val('');
                }
            });
            
            // Calcular diárias e total quando as datas mudarem
            $('#dataInicio, #dataFim').change(function() {
                calcularTotais();
            });
            
            // Botão Salvar
            $('#btnSalvarLocacao').click(function() {
                salvarLocacao();
            });
            
        });

        // Função para carregar setores
        function carregarSetores() {
            $.ajax({
                url: '/api/setores',
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    let options = '<option value="">Selecione...</option>';
                    data.forEach(function(item) {
                        options += `<option value="${item.SIGLA_SETOR}">${item.SIGLA_SETOR}</option>`;
                    });
                    $('#setorSolicitante').html(options);
                },
                error: function(xhr, status, error) {
                    console.error("Erro ao carregar setores:", error);
                    alert("Erro ao carregar lista de setores.");
                }
            });
        }
        
        // Função para carregar veículos
        function carregarVeiculos(idCl) {
            $.ajax({
                url: `/api/lista_veiculo?id_cl=${idCl}`,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    let options = '<option value="">Selecione...</option>';
                    data.forEach(function(item) {
                        options += `<option value="${item.ID_VEICULO_LOC}" data-valor="${item.VL_DIARIA_KM}">${item.DE_VEICULO}</option>`;
                    });
                    $('#veiculoLocacao').html(options);
                },
                error: function(xhr, status, error) {
                    console.error("Erro ao carregar veículos:", error);
                    alert("Erro ao carregar lista de veículos.");
                }
            });
        }
        
        // Função para carregar motoristas
        function carregarMotoristas() {
            $.ajax({
                url: '/api/lista_motorista',
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    let options = '<option value="">Selecione...</option>';
                    data.forEach(function(item) {
                        // Armazenar informações adicionais do motorista como data attributes
                        options += `<option value="${item.ID_MOTORISTA}" 
                                    data-telefone="${item.NU_TELEFONE || ''}" 
                                    data-cnh="${item.FILE_PDF ? 'S' : 'N'}" 
                                    data-nome-arquivo="${item.NOME_ARQUIVO || ''}">${item.NM_MOTORISTA}</option>`;
                    });
                    $('#motorista').html(options);
                },
                error: function(xhr, status, error) {
                    console.error("Erro ao carregar motoristas:", error);
                    alert("Erro ao carregar lista de motoristas.");
                }
            });
        }
        
        // Função para calcular diárias e valor total
        function calcularTotais() {
            const dataInicio = new Date($('#dataInicio').val());
            const dataFim = new Date($('#dataFim').val());
            
            if (isNaN(dataInicio.getTime()) || isNaN(dataFim.getTime())) {
                return; // Datas inválidas
            }
            
            // Calcular a diferença em dias
            const diffTime = Math.abs(dataFim - dataInicio);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            // Se as datas forem iguais, considerar como 1 diária
            const qtdDiarias = diffDays === 0 ? 1 : diffDays + 1;
            
            $('#qtDiariaKm').val(qtdDiarias);
            
            // Calcular valor total se tiver valor da diária
            const valorDiariaStr = $('#vlDk').val();
            if (valorDiariaStr) {
                const valorDiaria = parseFloat(valorDiariaStr.replace('R$ ', '').replace('.', '').replace(',', '.'));
                const valorTotal = valorDiaria * qtdDiarias;
                $('#vlTotalitem').val(formatarValorMoeda(valorTotal));
            }
        }
        
        // Formatar valor para exibição como moeda
        function formatarValorMoeda(valor) {
            return `R$ ${parseFloat(valor).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        }
        
        // Função para salvar a locação
        function salvarLocacao() {
            // Verificar se o formulário está válido
            if (!$('#formNovaLocacao')[0].checkValidity()) {
                $('#formNovaLocacao')[0].reportValidity();
                return;
            }
            
            // Verificar se tem CNH do motorista
            const motoristaOption = $('#motorista option:selected');
            const temCnh = motoristaOption.data('cnh') === 'S';
            const fileCnh = $('#fileCnh')[0].files[0];
            
            if (!temCnh && !fileCnh) {
                // Mostrar área para upload de CNH
                $('#areaCnh').removeClass('d-none');
                alert("É necessário anexar a CNH do motorista para prosseguir.");
                return;
            }
            
            // Obter dados do formulário
            const formData = new FormData();
            
            // Adicionar campos sem input visível
            formData.append('id_cl', processoIdSelecionado);
            formData.append('fl_email', 'N');
            formData.append('fl_status', 'T');
            
            // Obter a data final para extrair o mês e o ano
            const dataFim = new Date($('#dataFim').val());
            formData.append('id_exercicio', dataFim.getFullYear());
            formData.append('id_mes', dataFim.getMonth() + 1); // Mês em JavaScript começa em 0
            
            // Formatar datas para string no formato DD/MM/YYYY
            const dataInicio = new Date($('#dataInicio').val());
            const dataFimFormatada = dataFim.toLocaleDateString('pt-BR');
            const dataInicioFormatada = dataInicio.toLocaleDateString('pt-BR');
            
            formData.append('dt_inicial', dataInicioFormatada);
            formData.append('dt_final', dataFimFormatada);
            formData.append('hr_inicial', $('#horaInicio').val());
            
            // Obter outros valores do formulário
            $('#formNovaLocacao').find('input, select, textarea').each(function() {
                const input = $(this);
                const name = input.attr('name');
                
                if (name && !['file_cnh'].includes(name)) {
                    let value = input.val();
                    
                    // Para campos monetários, converter para formato numérico
                    if (name === 'vl_dk' || name === 'vl_totalitem') {
                        value = value.replace('R$ ', '').replace('.', '').replace(',', '.');
                    }
                    
                    formData.append(name, value);
                }
            });
            
            // Adicionar arquivo CNH se necessário
            if (fileCnh) {
                formData.append('file_cnh', fileCnh);
            }
            
            // Mostrar carregamento
            $('#btnSalvarLocacao').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Salvando...');
            
            // Enviar dados para o servidor
            $.ajax({
                url: '/api/nova_locacao',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    console.log("Locação salva:", response);
                    
                    // Verificar se a locação foi salva com sucesso
                    if (response.success) {
                        // Fechar o modal
                        $('#modalNovaLocacao').modal('hide');
                        
                        // Mostrar mensagem de sucesso
                        if (response.email_enviado) {
                            alert("Locação registrada com sucesso e e-mail enviado para a locadora.");
                        } else {
                            alert("Locação registrada com sucesso, mas houve um erro ao enviar o e-mail para a locadora.");
                        }
                        
                        // Recarregar as locações em trânsito
                        if (processoIdSelecionado) {
                            $.ajax({
                                url: `/api/locacoes_transito/${processoIdSelecionado}`,
                                type: 'GET',
                                dataType: 'json',
                                success: function(data) {
                                    let html = '';
                                    if (data.length === 0) {
                                        html = '<tr><td colspan="10" class="text-center">Nenhuma locação em trânsito encontrada</td></tr>';
                                    } else {
                                        data.forEach(function(item) {
                                            html += `<tr>
                                                <td>${item.ID_ITEM}</td>
                                                <td>${item.MES_ANO}</td>
                                                <td>${item.DE_VEICULO}</td>
                                                <td>${item.DS_VEICULO_MOD}</td>
                                                <td>${formatarDataString(item.DT_INICIAL)}</td>
                                                <td>${formatarDataString(item.DT_FINAL)}</td>
                                                <td>${item.QT_DIARIA_KM}</td>
                                                <td>R$ ${formatarValor(item.VL_TOTALITEM)}</td>
                                                <td>${item.MOTORISTA}</td>
                                                <td class="sticky-column">
                                                    <div class="d-flex justify-content-around">
                                                        <a href="javascript:void(0)" class="btn btn-sm btn-primary" title="Abrir">
                                                            <i class="fas fa-folder-open"></i>
                                                        </a>
                                                        <a href="javascript:void(0)" class="btn btn-sm btn-danger ms-1" title="Devolução">
                                                            <i class="fas fa-undo-alt"></i>
                                                        </a>
                                                    </div>
                                                </td>
                                            </tr>`;
                                        });
                                    }
                                    $('#tabela-transito').html(html);
                                }
                            });
                        }
                    } else {
                        alert("Erro ao registrar locação: " + (response.message || "Erro desconhecido"));
                    }
                },
                error: function(xhr, status, error) {
                    console.error("Erro ao salvar locação:", error);
                    console.error("Status:", xhr.status);
                    console.error("Resposta:", xhr.responseText);
                    alert("Erro ao registrar locação. Verifique o console para mais detalhes.");
                },
                complete: function() {
                    // Restaurar botão
                    $('#btnSalvarLocacao').prop('disabled', false).html('<i class="fas fa-save"></i> Salvar');
                }
            });
        }
        
        // Verificar CNH quando motorista for selecionado
        $('#motorista').change(function() {
            const motoristaOption = $(this).find('option:selected');
            const temCnh = motoristaOption.data('cnh') === 'S';
            
            if (!temCnh) {
                $('#areaCnh').removeClass('d-none');
            } else {
                $('#areaCnh').addClass('d-none');
            }
        });
        
        
        // Função para carregar processos de locação
        function carregarProcessos() {
            $.ajax({
                url: '/api/processos_locacao',
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    let html = '';
                    data.forEach(function(item) {
                        html += `<tr>
                            <td>${item.ID_CL}</td>
                            <td>${item.ANO_EXERCICIO}</td>
                            <td>${item.NM_FORNECEDOR}</td>
                            <td>${item.NU_SEI}</td>
                            <td>${item.NU_CONTRATO}</td>
                            <td class="sticky-column">
                                <a href="javascript:void(0)" onclick="selecionarProcesso(${item.ID_CL})" class="btn-selecionar">Selecionar</a>
                            </td>
                        </tr>`;
                    });
                    $('#tabela-processos').html(html);
                },
                error: function(xhr, status, error) {
                    console.error("Erro ao carregar processos:", error);
                    alert("Erro ao carregar dados. Verifique o console para mais detalhes.");
                }
            });
        }
        
        // Função para selecionar um processo e carregar os dados relacionados
        function selecionarProcesso(id_cl) {
            console.log("Selecionando processo ID:", id_cl);
            processoIdSelecionado = id_cl;
            
            // Obter o nome do fornecedor a partir da tabela
            const fornecedorNome = $(`#tabela-processos tr:has(td:contains(${id_cl}):first-child) td:nth-child(3)`).text();
            
            // Armazenar no localStorage
            localStorage.setItem('fornecedorNome', fornecedorNome);
            console.log("Nome do fornecedor armazenado:", fornecedorNome);

            // Carregar empenhos
            $.ajax({
                url: `/api/empenhos/${id_cl}`,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    console.log("Empenhos carregados:", data);
                    let html = '';
                    if (data.length === 0) {
                        html = '<tr><td colspan="6" class="text-center">Nenhum empenho encontrado</td></tr>';
                    } else {
                        data.forEach(function(item) {
                            html += `<tr>
                                <td>${item.NU_EMPENHO}</td>
                                <td>R$ ${formatarValor(item.VL_EMPENHO)}</td>
                                <td>R$ ${formatarValor(item.VL_DIARIAS)}</td>
                                <td>R$ ${formatarValor(item.VL_DIF)}</td>
                                <td>R$ ${formatarValor(item.VL_UTILIZADO)}</td>
                                <td>R$ ${formatarValor(item.VL_SALDO)}</td>
                            </tr>`;
                        });
                    }
                    $('#tabela-empenhos').html(html);
                },
                error: function(xhr, status, error) {
                    console.error("Erro ao carregar empenhos:", error);
                    $('#tabela-empenhos').html('<tr><td colspan="6" class="text-center text-danger">Erro ao carregar dados</td></tr>');
                }
            });
            
            // Carregar saldo de diárias
            $.ajax({
                url: `/api/saldo_diarias/${id_cl}`,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    console.log("Saldo de diárias carregado:", data);
                    let html = '';
                    if (data.length === 0) {
                        html = '<tr><td colspan="8" class="text-center">Nenhum registro encontrado</td></tr>';
                    } else {
                        data.forEach(function(item) {
                            html += `<tr>
                                <td>${item.DE_VEICULO}</td>
                                <td>R$ ${formatarValor(item.VL_DIARIA_KM)}</td>
                                <td>${item.QT_DK}</td>
                                <td>${item.QT_UTILIZADO}</td>
                                <td>${item.QT_SALDO}</td>
                                <td>R$ ${formatarValor(item.VALOR_TOTAL)}</td>
                                <td>R$ ${formatarValor(item.VL_UTILIZADO)}</td>
                                <td>R$ ${formatarValor(item.VL_SALDO)}</td>
                            </tr>`;
                        });
                    }
                    $('#tabela-saldo-diarias').html(html);
                },
                error: function(xhr, status, error) {
                    console.error("Erro ao carregar saldo de diárias:", error);
                    $('#tabela-saldo-diarias').html('<tr><td colspan="8" class="text-center text-danger">Erro ao carregar dados</td></tr>');
                }
            });

            // Carregar dados do PLS
            $.ajax({
                url: `/api/dados_pls/${id_cl}`,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    console.log("Dados do PLS carregado:", data);
                    let html = '';
                    if (data.length === 0) {
                        html = '<tr><td colspan="8" class="text-center">Nenhum registro encontrado</td></tr>';
                    } else {
                        data.forEach(function(item) {
                            html += `<tr>
                                <td>${item.MES_ANO}</td>
                                <td>${item.QTD}</td>
                                <td>R$ ${formatarValor(item.VLTOTAL)}</td>
                                <td>${item.COMBUSTIVEL}</td>
                            </tr>`;
                        });
                    }
                    $('#tabela-dados-pls').html(html);
                },
                error: function(xhr, status, error) {
                    console.error("Erro ao carregar saldo de diárias:", error);
                    $('#tabela-dados-pls').html('<tr><td colspan="8" class="text-center text-danger">Erro ao carregar dados</td></tr>');
                }
            });            
            
            // Carregar locações em trânsito
            $.ajax({
                url: `/api/locacoes_transito/${id_cl}`,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    console.log("Locações em trânsito carregadas:", data);
                    let html = '';
                    if (data.length === 0) {
                        html = '<tr><td colspan="10" class="text-center">Nenhuma locação em trânsito encontrada</td></tr>';
                    } else {
                        data.forEach(function(item) {
                            html += `<tr>
                                <td>${item.ID_ITEM}</td>
                                <td>${item.MES_ANO}</td>
                                <td>${item.DE_VEICULO}</td>
                                <td>${item.DS_VEICULO_MOD}</td>
                                <td>${formatarDataString(item.DT_INICIAL)}</td>
                                <td>${formatarDataString(item.DT_FINAL)}</td>
                                <td>${item.QT_DIARIA_KM}</td>
                                <td>R$ ${formatarValor(item.VL_TOTALITEM)}</td>
                                <td>${item.MOTORISTA}</td>
                                <td class="sticky-column">
                                    <div class="d-flex justify-content-around">
                                        <a href="javascript:void(0)" class="btn btn-sm btn-primary" title="Abrir">
                                            <i class="fas fa-folder-open"></i>
                                        </a>
                                        <a href="javascript:void(0)" class="btn btn-sm btn-danger ms-1" title="Devolução">
                                            <i class="fas fa-undo-alt"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>`;
                        });
                    }
                    $('#tabela-transito').html(html);
                },
                error: function(xhr, status, error) {
                    console.error("Erro ao carregar locações em trânsito:", error);
                    console.error("Status:", xhr.status);
                    console.error("Resposta:", xhr.responseText);
                    $('#tabela-transito').html('<tr><td colspan="10" class="text-center text-danger">Erro ao carregar dados</td></tr>');
                }
            });
            
            // Carregar opções de filtro para mês/ano
            $.ajax({
                url: `/api/meses_locacoes/${id_cl}`,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    console.log("Opções de mês/ano carregadas:", data);
                    let selectHtml = '<option value="Todos">Todos</option>';
                    data.forEach(function(item) {
                        selectHtml += `<option value="${item.MES_ANO}">${item.MES_ANO}</option>`;
                    });
                    $('#filtroMesAno').html(selectHtml);
                },
                error: function(xhr, status, error) {
                    console.error("Erro ao carregar opções de mês/ano:", error);
                    $('#filtroMesAno').html('<option value="Todos">Todos</option>');
                }
            });
            
            // Carregar locações finalizadas
            carregarLocacoesFinalizadas(id_cl);
        }
        
        // Função para carregar locações finalizadas
        function carregarLocacoesFinalizadas(id_cl) {
            $.ajax({
                url: `/api/locacoes_finalizadas/${id_cl}`,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    console.log("Locações finalizadas carregadas:", data);
                    // Armazenar os dados completos para filtrar depois
                    locacoesFinalizadasCompletas = data;
                    
                    // Exibir todos os dados inicialmente
                    exibirLocacoesFinalizadas(data);
                },
                error: function(xhr, status, error) {
                    console.error("Erro ao carregar locações finalizadas:", error);
                    console.error("Status:", xhr.status);
                    console.error("Resposta:", xhr.responseText);
                    $('#tabela-finalizadas').html('<tr><td colspan="10" class="text-center text-danger">Erro ao carregar dados</td></tr>');
                }
            });
        }
        
        // Função para exibir locações finalizadas na tabela
        function exibirLocacoesFinalizadas(data) {
            let html = '';
            if (data.length === 0) {
                html = '<tr><td colspan="10" class="text-center">Nenhuma locação finalizada encontrada</td></tr>';
            } else {
                data.forEach(function(item) {
                    html += `<tr>
                        <td>${item.ID_ITEM}</td>
                        <td>${item.MES_ANO}</td>
                        <td>${item.DE_VEICULO}</td>
                        <td>${item.DS_VEICULO_MOD}</td>
                        <td>${formatarDataString(item.DT_INICIAL)}</td>
                        <td>${formatarDataString(item.DT_FINAL)}</td>
                        <td>${item.QT_DIARIA_KM}</td>
                        <td>R$ ${formatarValor(item.VL_TOTALITEM)}</td>
                        <td>${item.MOTORISTA}</td>
                        <td class="sticky-column">
                            <a href="javascript:void(0)" class="acao-btn btn-abrir">Visualizar</a>
                        </td>
                    </tr>`;
                });
            }
            $('#tabela-finalizadas').html(html);
        }
        
        // Função para aplicar filtro por mês/ano
        function aplicarFiltroMesAno() {
            const filtroSelecionado = $('#filtroMesAno').val();
            
            if (filtroSelecionado === 'Todos') {
                // Exibir todos os dados
                exibirLocacoesFinalizadas(locacoesFinalizadasCompletas);
            } else {
                // Filtrar os dados pelo mês/ano selecionado
                const dadosFiltrados = locacoesFinalizadasCompletas.filter(item => item.MES_ANO === filtroSelecionado);
                exibirLocacoesFinalizadas(dadosFiltrados);
            }
        }
        
        // Função para formatar valores monetários
        function formatarValor(valor) {
            if (valor === null || valor === undefined) return '0,00';
            return parseFloat(valor).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }
        
        // Função para formatar datas (string no formato dd/mm/yyyy)
        function formatarDataString(dataStr) {
            if (!dataStr) return '';
            
            // Verifica se a data já está no formato desejado (dd/mm/yyyy)
            if (typeof dataStr === 'string' && dataStr.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                return dataStr; // Já está no formato correto, retorna a própria string
            }
            
            // Tenta converter usando o formato ISO
            try {
                const dt = new Date(dataStr);
                if (!isNaN(dt.getTime())) {
                    return dt.toLocaleDateString('pt-BR');
                }
            } catch (e) {
                console.error("Erro ao formatar data como ISO:", e);
            }
            
            // Se não conseguiu converter como ISO, tenta outros formatos comuns
            try {
                // Tenta extrair dia, mês e ano para os casos onde dataStr é algo como "dd/mm/yyyy"
                // ou quando é uma string em outro formato que precisa ser manipulado
                let dia, mes, ano;
                
                // Formato dd/mm/yyyy
                const formatoBR = dataStr.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
                if (formatoBR) {
                    dia = formatoBR[1];
                    mes = formatoBR[2];
                    ano = formatoBR[3];
                    return `${dia}/${mes}/${ano}`;
                }
                
                // Formato yyyy-mm-dd ou yyyy/mm/dd
                const formatoISO = dataStr.match(/^(\d{4})[\/-](\d{2})[\/-](\d{2})$/);
                if (formatoISO) {
                    dia = formatoISO[3];
                    mes = formatoISO[2];
                    ano = formatoISO[1];
                    return `${dia}/${mes}/${ano}`;
                }
                
                // Se chegou até aqui, retorna a string original
                return dataStr;
            } catch (e) {
                console.error("Erro ao formatar data com regex:", e);
                return dataStr; // Em caso de erro, retorna o valor original
            }
        }
    </script>
</body>
</html>
