<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Locações</title>
    <link rel="stylesheet" href="/static/css/controle_locacoes.css">    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="container-fluid mt-2">
        <h4 class="mb-3">Controle de Locações</h4>
        
        <div class="row">
            <!-- GroupBox - Processos de Locação -->
            <div class="col-md-6">
                <div class="groupbox">
                    <div class="groupbox-header">Processos de Locação</div>
                    <div class="groupbox-body">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Ano</th>
                                        <th>Fornecedor</th>
                                        <th>Nº SEI</th>
                                        <th>Nº Contrato</th>
                                        <th class="sticky-column">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="tabela-processos">
                                    <!-- Dados carregados via AJAX -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- GroupBox - Empenhos (com guias) -->
            <div class="col-md-6">
                <div class="groupbox">
                    <div class="tabs-body">
                        <!-- Guias (Tabs) -->
                        <ul class="nav nav-tabs" id="empenhosTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="empenhos-tab" data-bs-toggle="tab" 
                                        data-bs-target="#empenhos" type="button" role="tab" 
                                        aria-controls="empenhos" aria-selected="true">Empenhos</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="saldo-diarias-tab" data-bs-toggle="tab" 
                                        data-bs-target="#saldo-diarias" type="button" role="tab" 
                                        aria-controls="saldo-diarias" aria-selected="false">Saldo Diárias</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="dados-pls-tab" data-bs-toggle="tab" 
                                        data-bs-target="#dados-pls" type="button" role="tab" 
                                        aria-controls="dados-pls" aria-selected="true">Dados PLS</button>
                            </li>
                        </ul>
                        
                        <!-- Conteúdo das Guias -->
                        <div class="tab-content" id="empenhosTabsContent">
                            <!-- Guia Empenhos -->
                            <div class="tab-pane fade show active" id="empenhos" role="tabpanel" aria-labelledby="empenhos-tab">
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover">
                                        <thead>
                                            <tr>
                                                <th>Nº Empenho</th>
                                                <th>Vl. Empenho</th>
                                                <th>Vl. Diárias</th>
                                                <th>Vl. Dif.</th>
                                                <th>Vl. Total Util.</th>
                                                <th>Valor Saldo</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tabela-empenhos">
                                            <!-- Dados carregados via AJAX -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Guia Saldo Diárias -->
                            <div class="tab-pane fade" id="saldo-diarias" role="tabpanel" aria-labelledby="saldo-diarias-tab">
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover">
                                        <thead>
                                            <tr>
                                                <th>Veículo</th>
                                                <th>Vl. Diária</th>
                                                <th>Qtd. Diária</th>
                                                <th>Qtd. Util.</th>
                                                <th>Qtd. Saldo</th>
                                                <th>Valor Total</th>
                                                <th>Valor Util.</th>
                                                <th>Valor Saldo</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tabela-saldo-diarias">
                                            <!-- Dados carregados via AJAX -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Guia Dados PLS -->
                            <div class="tab-pane fade" id="dados-pls" role="tabpanel" aria-labelledby="dados-pls-tab">
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover">
                                        <thead>
                                            <tr>
                                                <th>Mês/Ano</th>
                                                <th>Qtde Locação</th>
                                                <th>Valor</th>
                                                <th>Combustível</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tabela-dados-pls">
                                            <!-- Dados carregados via AJAX -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- GroupBox - Locações em Trânsito -->
        <div class="row">
            <div class="col-12">
                <div class="groupbox">
                    <div class="groupbox-header">Locações em Trânsito</div>
                    <div class="groupbox-body lista-grande">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Mês/Ano</th>
                                        <th>Veículo</th>
                                        <th>Mod. Veículo</th>
                                        <th>Início</th>
                                        <th>Fim</th>
                                        <th>Diárias</th>
                                        <th>Valor Total</th>
                                        <th>Motorista</th>
                                        <th class="sticky-column">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="tabela-transito">
                                    <!-- Dados carregados via AJAX -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- GroupBox - Locações Finalizadas (com filtro) -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="groupbox">
                    <div class="groupbox-header d-flex justify-content-between align-items-center">
                        <span>Locações Finalizadas</span>
                        <div class="d-flex align-items-center">
                            <label for="filtroMesAno" class="me-2 mb-0">Filtro:</label>
                            <select id="filtroMesAno" class="form-select form-select-sm" style="width: auto;">
                                <option value="Todos">Todos</option>
                                <!-- Opções carregadas via AJAX -->
                            </select>
                        </div>
                    </div>
                    <div class="groupbox-body lista-grande">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Mês/Ano</th>
                                        <th>Veículo</th>
                                        <th>Mod. Veículo</th>
                                        <th>Início</th>
                                        <th>Fim</th>
                                        <th>Diárias</th>
                                        <th>Valor Total</th>
                                        <th>Motorista</th>
                                        <th class="sticky-column">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="tabela-finalizadas">
                                    <!-- Dados carregados via AJAX -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer (novo, baseado no footer da página de motoristas) -->
    <div class="footer">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <button id="btnNovaLocacao" class="btn btn-success me-2">
                        <i class="fas fa-plus-circle"></i> Nova Locação
                    </button>
                    <button id="btnRelatorioAnalitico" class="btn btn-info">
                        <i class="fas fa-file-alt"></i> Relatório Analítico
                    </button>
                    <button id="btnTeste">
                        <i></i> Teste
                    </button>
                </div>
                <button id="btnVoltar" class="btn btn-secondary" onclick="window.location.href='/';">
                    <i class="fas fa-arrow-left"></i> Voltar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Nova Locação -->
    <div class="modal fade" id="modalNovaLocacao" tabindex="-1" aria-labelledby="modalNovaLocacaoLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalNovaLocacaoLabel">Nova Locação</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="formNovaLocacao" class="row g-3">
                        <div class="col-md-6">
                            <label for="empenholoc" class="form-label small">Empenho</label>
                            <select class="form-select form-select-sm" id="empenholoc" required>
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="setorSolicitante" class="form-label small">Setor Solicitante</label>
                            <select class="form-select form-select-sm" id="setorSolicitante" required>
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                        <div class="col-md-8">
                            <label for="objetivo" class="form-label small">Objetivo</label>
                            <input type="text" class="form-control form-control-sm" id="objetivo" maxlength="300" required>
                        </div>
                        <div class="col-md-4">
                            <label for="numSei" class="form-label small">Número SEI</label>
                            <input type="text" class="form-control form-control-sm" id="numSei" maxlength="25" required>
                        </div>
                        <div class="col-md-6">
                            <label for="veiculo" class="form-label small">Veículo</label>
                            <select class="form-select form-select-sm" id="veiculo" required>
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="motorista" class="form-label small">Motorista</label>
                            <select class="form-select form-select-sm" id="motorista" required>
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="dataInicio" class="form-label small">Data Início</label>
                            <input type="date" class="form-control form-control-sm" id="dataInicio" required>
                        </div>
                        <div class="col-md-4">
                            <label for="horaInicio" class="form-label small">Hora Início</label>
                            <input type="time" class="form-control form-control-sm" id="horaInicio" required>
                        </div>                        
                        <div class="col-md-4">
                            <label for="dataFim" class="form-label small">Data Fim</label>
                            <input type="date" class="form-control form-control-sm" id="dataFim" required>
                        </div>
                        <div class="col-md-4">
                            <label for="qtdDiarias" class="form-label small">Qtd. Diárias</label>
                            <input type="number" class="form-control form-control-sm" id="qtdDiarias" readonly>
                        </div>
                        <div class="col-md-4">
                            <label for="valorDiaria" class="form-label small">Valor Diária</label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">R$</span>
                                <input type="text" class="form-control form-control-sm" id="valorDiaria" readonly>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label for="valorTotal" class="form-label small">Valor Total</label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">R$</span>
                                <input type="text" class="form-control form-control-sm" id="valorTotal" readonly>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <label for="observacoes" class="form-label small">Observações</label>
                            <textarea class="form-control form-control-sm" id="observacoes" rows="2" maxlength="200"></textarea>
                            <div class="text-end">
                                <small><span id="charCount">0</span>/200</small>
                            </div>
                        </div>
                        <div id="arquivoCnhDiv" class="col-md-12 d-none">
                            <label for="arquivoCnh" class="form-label small">Arquivo CNH</label>
                            <input type="file" class="form-control form-control-sm" id="arquivoCnh" accept=".pdf">
                            <div class="text-danger small mt-1">É necessário anexar a CNH do motorista para prosseguir.</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </button>
                    <button type="button" class="btn btn-success btn-sm" id="btnSalvarLocacao">
                        <i class="fas fa-save"></i> Salvar
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- adicionado 07/04/2025 -->
    
    <!-- Modal Devolução de Locação -->
    <div class="modal fade" id="modalDevolucaoLocacao" tabindex="-1" aria-labelledby="modalDevolucaoLocacaoLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="modalDevolucaoLocacaoLabel">Devolução de Locação</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="formDevolucaoLocacao" class="row g-3">
                        <div class="col-md-6">
                            <label for="empenholocDev" class="form-label small">Empenho</label>
                            <select class="form-select form-select-sm" id="empenholocDev" required>
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="setorSolicitanteDev" class="form-label small">Setor Solicitante</label>
                            <select class="form-select form-select-sm" id="setorSolicitanteDev" required>
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="numSeiDev" class="form-label small">Número SEI</label>
                            <input type="text" class="form-control form-control-sm" id="numSeiDev" maxlength="25" required>
                        </div>
                        <div class="col-md-8">
                            <label for="motoristaDev" class="form-label small">Motorista</label>
                            <select class="form-select form-select-sm" id="motoristaDev" required>
                                <option value="">Selecione...</option>
                            </select>                            
                            <!-- <input type="text" class="form-control form-control-sm" id="motoristaDev" maxlength="25" readonly> -->
                        </div>
                        <div class="col-md-6">
                            <label for="veiculoDev" class="form-label small">Veículo</label>
                            <select class="form-select form-select-sm" id="veiculoDev" required>
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="veiculoModeloDev" class="form-label small">Modelo Veículo</label>
                            <input type="text" class="form-control form-control-sm" id="veiculoModeloDev" maxlength="25" required>
                            <div id="sugestoesModeloVeiculo" class="position-absolute bg-white border shadow-sm" 
                                 style="z-index: 9999; display: none; width: calc(100% - 24px); max-height: 200px; overflow-y: auto;">
                            </div>                   
                        </div>
                        <div class="col-md-3">
                            <label for="dataInicioDev" class="form-label small">Data Início</label>
                            <input type="date" class="form-control form-control-sm" id="dataInicioDev" required>
                        </div>
                        <div class="col-md-3">
                            <label for="horaInicioDev" class="form-label small">Hora Início</label>
                            <input type="time" class="form-control form-control-sm" id="horaInicioDev" required>
                        </div>                        
                        <div class="col-md-3">
                            <label for="dataFimDev" class="form-label small">Data Fim</label>
                            <input type="date" class="form-control form-control-sm" id="dataFimDev" required>
                        </div>
                        <div class="col-md-3">
                            <label for="horaFimDev" class="form-label small">Hora Dev.</label>
                            <input type="time" class="form-control form-control-sm" id="horaFimDev" required>
                        </div>                        
                        <div class="col-md-3">
                            <label for="qtdDiariasDev" class="form-label small">Qtd. Diárias</label>
                            <input type="number" class="form-control form-control-sm" id="qtdDiariasDev" readonly>
                        </div>
                        <div class="col-md-3">
                            <label for="valorDiariaDev" class="form-label small">Valor Diária</label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">R$</span>
                                <input type="text" class="form-control form-control-sm" id="valorDiariaDev" readonly>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label for="valorDifDev" class="form-label small">Valor Dif.</label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">R$</span>
                                <input type="text" class="form-control form-control-sm" id="valorDifDev" readonly>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label for="valorTotalDev" class="form-label small">Valor Total</label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">R$</span>
                                <input type="text" class="form-control form-control-sm" id="valorTotalDev" readonly>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <label for="observacoesDev" class="form-label small">Observações</label>
                            <textarea class="form-control form-control-sm" id="observacoesDev" rows="2" maxlength="200"></textarea>
                            <div class="text-end">
                                <small><span id="charCountDev">0</span>/200</small>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </button>
                    <button type="button" class="btn btn-success btn-sm" id="btnSalvarDevolucao">
                        <i class="fas fa-save"></i> Salvar Devolução
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!--  fim - adicionado 07/05/2025 -->
    
    <!-- Modal CNH Não Encontrada -->
    <div class="modal fade" id="modalCnhNaoEncontrada" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title">Atenção</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>CNH do motorista não encontrada no sistema.</p>
                    <p>Por favor, anexe o arquivo da CNH para prosseguir.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Sucesso -->
    <div class="modal fade" id="modalSucesso" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">Sucesso</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="mensagemSucesso">
                    <!-- Mensagem será inserida via JavaScript -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js"></script>
    <script>
        // Variáveis globais
        let processoIdSelecionado = null;
        let locacoesFinalizadasCompletas = []; // Para armazenar todas as locações finalizadas
        let motoristasLista = [];
        let veiculosLista = [];
        let empenhoLista = [];
        let arquivoCnh = null;
        
        const TOLERANCIA_HORAS = 2; // 2 horas de tolerância
        const FRACAO_HORA_EXTRA = 0.1; // 1/10 do valor da diária por hora extra

        // Função para formatar valores monetários para exibição
        function formatarValorMonetario(valor) {
            if (valor === null || valor === undefined) return '0,00';
            return parseFloat(valor).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }
        
        // Função para converter valor formatado para número
        function converterParaNumero(valor) {
            if (!valor) return 0;
            
            // Se já for um número, retornar ele mesmo
            if (typeof valor === 'number') return valor;
            
            // Se for string, remover formatação
            if (typeof valor === 'string') {
                return parseFloat(valor.replace(/\./g, '').replace(',', '.')) || 0;
            }
            
            return 0;
        }

        // // Quando o campo recebe foco, ajusta a largura da lista de sugestões
        // $("#veiculoModeloDev").on("focus", function() {
        //     const inputWidth = $(this).outerWidth();
        //     $("#sugestoesModeloVeiculo").css("width", inputWidth + "px");
        // });        

        // Carregar lista de processos ao iniciar a página
        $(document).ready(function() {
            const ajustarLarguraSugestoes = function() {
                const inputWidth = $('#veiculoModeloDev').outerWidth();
                const inputOffset = $('#veiculoModeloDev').offset();
                
                $('#sugestoesModeloVeiculo').css({
                    'width': inputWidth + 'px',
                    'left': inputOffset.left + 'px'
                });
            };
            
            // Ajustar quando o campo recebe foco
            $('#veiculoModeloDev').on('focus', ajustarLarguraSugestoes);
            
            // Ajustar quando a janela é redimensionada
            $(window).on('resize', function() {
                if ($('#sugestoesModeloVeiculo').is(':visible')) {
                    ajustarLarguraSugestoes();
                }
            });
            
            // Ajustar quando o modal é aberto
            $('#modalDevolucaoLocacao').on('shown.bs.modal', function() {
                ajustarLarguraSugestoes();
            });            



            carregarProcessos();
                    
            // Atualizar valor da diária quando selecionar veículo
            $('#veiculo').change(function() {
                const veiculoId = $(this).val();
                const veiculoSelecionado = veiculosLista.find(v => v.ID_VEICULO_LOC == veiculoId);
                
                if (veiculoSelecionado) {
                    $('#valorDiaria').val(veiculoSelecionado.VL_DIARIA_KM.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
                    calcularDiariasEValores();
                } else {
                    $('#valorDiaria').val('');
                    $('#valorTotal').val('');
                }
            });
            
            // Recalcular diárias quando alterar datas
            $('#dataInicio, #dataFim').change(function() {
                calcularDiariasEValores();
            });
            
            // Contador de caracteres para observações
            $('#observacoes').on('input', function() {
                const caracteres = $(this).val().length;
                $('#charCount').text(caracteres);
            });
            
            // Máscara para o número SEI
            $('#numSei').on('input', function() {
                let value = $(this).val().replace(/\D/g, '');
                

                if (value.length > 13) {
                    value = `${value.substring(0, 7)}-${value.substring(7, 9)}.${value.substring(9, 13)}.${value.substring(13, 14)}.${value.substring(14, 16)}.${value.substring(16)}`;
                } else if (value.length > 9) {
                    value = `${value.substring(0, 7)}-${value.substring(7, 9)}.${value.substring(9)}`;
                } else if (value.length > 7) {
                    value = `${value.substring(0, 7)}-${value.substring(7)}`;
                }                
                
                $(this).val(value);
            });
            
            // Verificar CNH do motorista
            $('#motorista').change(function() {
                const motoristaId = $(this).val();
                if (!motoristaId) return;
                
                const motoristaSelecionado = motoristasLista.find(m => m.ID_MOTORISTA == motoristaId);
                
                if (motoristaSelecionado && !motoristaSelecionado.FILE_PDF) {
                    $('#arquivoCnhDiv').removeClass('d-none');
                    const modalCnhNaoEncontrada = new bootstrap.Modal(document.getElementById('modalCnhNaoEncontrada'));
                    modalCnhNaoEncontrada.show();
                } else {
                    $('#arquivoCnhDiv').addClass('d-none');
                }
            });
            
            // Capturar arquivo CNH quando selecionado
            $('#arquivoCnh').change(function(e) {
                arquivoCnh = e.target.files[0];
            });

            // Função para carregar locações em trânsito - Atualizada para recarregar após salvar
            function carregarLocacoesTransito(id_cl) {
                $.ajax({
                    url: `/api/locacoes_transito/${id_cl}`,
                    type: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        console.log("Locações em trânsito carregadas:", data);
                        let html = '';
                        if (data.length === 0) {
                            html = '<tr><td colspan="10" class="text-center">Nenhuma locação em trânsito encontrada</td></tr>';
                        } else {
                            data.forEach(function(item) {
                                html += `<tr>
                                    <td>${item.ID_ITEM}</td>
                                    <td>${item.MES_ANO}</td>
                                    <td>${item.DE_VEICULO}</td>
                                    <td>${item.DS_VEICULO_MOD}</td>
                                    <td>${formatarDataString(item.DT_INICIAL)}</td>
                                    <td>${formatarDataString(item.DT_FINAL)}</td>
                                    <td>${item.QT_DIARIA_KM}</td>
                                    <td>R$ ${formatarValor(item.VL_TOTALITEM)}</td>
                                    <td>${item.MOTORISTA}</td>
                                    <td class="sticky-column">
                                        <div class="d-flex justify-content-around">
                                            <a href="javascript:void(0)" class="btn btn-sm btn-primary" title="Abrir">
                                                <i class="fas fa-folder-open"></i>
                                            </a>
                                            <a href="javascript:void(0)" class="btn btn-sm btn-danger ms-1" title="Devolução">
                                                <i class="fas fa-undo-alt"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>`;
                            });
                        }
                        $('#tabela-transito').html(html);
                    },
                    error: function(xhr, status, error) {
                        console.error("Erro ao carregar locações em trânsito:", error);
                        console.error("Status:", xhr.status);
                        console.error("Resposta:", xhr.responseText);
                        $('#tabela-transito').html('<tr><td colspan="10" class="text-center text-danger">Erro ao carregar dados</td></tr>');
                    }
                });
            }

            // Salvar locação
            $('#btnSalvarLocacao').click(function() {
                // Validar formulário
                if (!validarFormulario()) {
                    return;
                }
                
                // Mostrar loader ou spinner
                $(this).prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Salvando...');
                
                // Verificar se precisa de arquivo CNH
                const motoristaId = $('#motorista').val();
                const motoristaSelecionado = motoristasLista.find(m => m.ID_MOTORISTA == motoristaId);
                
                if (!motoristaSelecionado.FILE_PDF && !$('#arquivoCnh')[0].files[0]) {
                    alert("É necessário anexar a CNH do motorista.");
                    $(this).prop('disabled', false).html('<i class="fas fa-save"></i> Salvar');
                    return;
                }
                
                // Preparar dados para envio
                const formData = new FormData();
                formData.append('id_cl', processoIdSelecionado);
                formData.append('empenho', $('#empenholoc').val());
                formData.append('setor_solicitante', $('#setorSolicitante').val());
                formData.append('objetivo', $('#objetivo').val());
                formData.append('id_veiculo_loc', $('#veiculo').val());
                formData.append('id_motorista', $('#motorista').val());
                formData.append('data_inicio', $('#dataInicio').val());
                formData.append('data_fim', $('#dataFim').val());
                formData.append('hora_inicio', $('#horaInicio').val());
                formData.append('qt_diaria_km', $('#qtdDiarias').val());
                
                // Corrigir formatação dos valores decimais
                const valorDiaria = $('#valorDiaria').val().replace(/\./g, '').replace(',', '.');
                const valorTotal = $('#valorTotal').val().replace(/\./g, '').replace(',', '.');
                
                formData.append('vl_dk', valorDiaria);
                formData.append('vl_totalitem', valorTotal);
                formData.append('nu_sei', $('#numSei').val());
                formData.append('obs', $('#observacoes').val());
                
                // Anexar arquivo da CNH se necessário
                if (!motoristaSelecionado.FILE_PDF && $('#arquivoCnh')[0].files[0]) {
                    // Importante: corrigir o nome do campo para 'file_cnh' conforme esperado pelo backend
                    formData.append('file_cnh', $('#arquivoCnh')[0].files[0]);
                }
                
                // Log para verificar os dados enviados
                console.log("Enviando dados para API:", processoIdSelecionado);
                
                // Enviar dados para API
                $.ajax({
                    url: '/api/nova_locacao',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        console.log("Resposta:", response);
                        
                        // Mostrar mensagem de sucesso
                        let mensagem = "Locação registrada com sucesso!";
                        if (response.email_enviado) {
                            mensagem += " E-mail enviado com sucesso.";
                        } else if (response.erro_email) {
                            mensagem += " A locação foi registrada, mas ocorreu um erro ao enviar o e-mail: " + response.erro_email;
                        }
                        
                        $('#mensagemSucesso').text(mensagem);
                        
                        // Fechar modal de locação
                        $('#modalNovaLocacao').modal('hide');
                        
                        // Mostrar modal de sucesso
                        const modalSucesso = new bootstrap.Modal(document.getElementById('modalSucesso'));
                        modalSucesso.show();
                        
                        // Reativar o footer quando o modal fechar
                        $('.footer').removeClass('d-none');
                        
                        // Recarregar locações em trânsito se a função existir
                        if (typeof carregarLocacoesTransito === 'function') {
                            carregarLocacoesTransito(processoIdSelecionado);
                        }
                        
                        // Reset botão salvar
                        $('#btnSalvarLocacao').prop('disabled', false).html('<i class="fas fa-save"></i> Salvar');
                    },
                    error: function(xhr, status, error) {
                        console.error("Erro ao salvar locação:", error);
                        console.error("Resposta:", xhr.responseText);
                        
                        let mensagemErro = "Erro ao salvar locação";
                        if (xhr.responseJSON && xhr.responseJSON.mensagem) {
                            mensagemErro += ": " + xhr.responseJSON.mensagem;
                        } else if (xhr.statusText) {
                            mensagemErro += ": " + xhr.statusText;
                        } else {
                            mensagemErro += ": " + error;
                        }
                        
                        alert(mensagemErro);
                        
                        // Reset botão salvar
                        $('#btnSalvarLocacao').prop('disabled', false).html('<i class="fas fa-save"></i> Salvar');
                    }
                });
            });

            // Fechar modal event
            $('#modalNovaLocacao').on('hidden.bs.modal', function () {
                // Reativar o footer quando o modal fechar
                $('.footer').removeClass('d-none');
            });          
            
            // Ação do botão Nova Locação
            $('#btnNovaLocacao').click(function() {
                if (!processoIdSelecionado) {
                    alert("Por favor, selecione um processo de locação primeiro.");
                    return;
                }
                
                // Esconder o footer quando o modal estiver aberto
                $('.footer').addClass('d-none');
                
                // Resetar o formulário
                $('#formNovaLocacao')[0].reset();
                $('#arquivoCnhDiv').addClass('d-none');
                arquivoCnh = null;
            
                
                const hoje = new Date();
                const amanha = new Date(hoje);
                amanha.setDate(hoje.getDate() + 1);
                const dataFormatada = amanha.toISOString().split('T')[0];
                $('#dataInicio').val(dataFormatada);
                $('#dataFim').val(dataFormatada);
                $('#horaInicio').val('07:00');

                // Carregar dados necessários
                carregarEmpenhos(processoIdSelecionado);
                carregarSetores();
                carregarMotoristas();
                carregarVeiculos(processoIdSelecionado);
                
                // Calcular diárias inicialmente (como as datas são iguais, será 1)
                calcularDiariasEValores();
                
                // Abrir o modal
                const modalNovaLocacao = new bootstrap.Modal(document.getElementById('modalNovaLocacao'));
                modalNovaLocacao.show();
            });
                
            // Evento de mudança no filtro de mês/ano
            $('#filtroMesAno').change(function() {
                aplicarFiltroMesAno();
            });

            $('#btnRelatorioAnalitico').click(function() {
                if (processoIdSelecionado) {
                    window.location.href = `/rel_locacao_analitico?id_cl=${processoIdSelecionado}`;
                } else {
                    alert("Por favor, selecione um processo de locação primeiro.");
                }
            });

            // Busca de modelos de veículos
            $('#veiculoModeloDev').on('input', function() {
                const termo = $(this).val().trim();
                if (termo.length >= 4) {
                    $.ajax({
                        url: `/api/busca_modelos_veiculos?termo=${encodeURIComponent(termo)}`,
                        type: 'GET',
                        dataType: 'json',
                        success: function(data) {
                            let html = '';
                            if (data.length > 0) {
                                data.forEach(function(modelo) {
                                    html += `<div class="p-2 border-bottom modelo-sugestao" style="cursor: pointer;">${modelo}</div>`;
                                });
                                $('#sugestoesModeloVeiculo').html(html).show();
                                
                                // Adicionar evento de clique às sugestões
                                $('.modelo-sugestao').click(function() {
                                    $('#veiculoModeloDev').val($(this).text());
                                    $('#sugestoesModeloVeiculo').hide();
                                });
                            } else {
                                $('#sugestoesModeloVeiculo').hide();
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error("Erro ao buscar modelos de veículos:", error);
                            $('#sugestoesModeloVeiculo').hide();
                        }
                    });
                } else {
                    $('#sugestoesModeloVeiculo').hide();
                }
            });

            // Fechar sugestões ao clicar fora
            $(document).click(function(e) {
                if (!$(e.target).closest('#veiculoModeloDev, #sugestoesModeloVeiculo').length) {
                    $('#sugestoesModeloVeiculo').hide();
                }
            });
            
            // Contador de caracteres para observações
            $('#observacoesDev').on('input', function() {
                const caracteres = $(this).val().length;
                $('#charCountDev').text(caracteres);
            });

            // Botão de devolução na tabela de locações em trânsito
            $(document).on('click', '#tabela-transito .btn-danger', function() {
                const tr = $(this).closest('tr');
                const idItem = tr.find('td:first').text();
                const self = this;
                
                // Mostrar um indicador de carregamento
                $(self).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>');

                // Primeiro, carregar os dados da locação
                $.ajax({
                    url: `/api/locacao_item/${idItem}`,
                    type: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        console.log("Dados da locação carregados:", data);
                        
                        // Guardar os dados para uso posterior
                        const itemData = data;
                        
                        // Configurar campos ocultos
                        if (!$('#idItemDev').length) {
                            $('#formDevolucaoLocacao').append('<input type="hidden" id="idItemDev">');
                        }
                        if (!$('#valorSubTotalDev').length) {
                            $('#formDevolucaoLocacao').append('<input type="hidden" id="valorSubTotalDev">');
                        }
                        
                        // Preencher os campos de texto imediatamente
                        $('#idItemDev').val(idItem);
                        $('#veiculoModeloDev').val(tr.find('td:eq(3)').text());
                        $('#numSeiDev').val(data.nu_sei);
                        $('#dataInicioDev').val(formatarDataParaInput(data.dt_inicio));
                        $('#horaInicioDev').val(data.hora_inicio ? data.hora_inicio.substring(0, 5) : '');
                        $('#dataFimDev').val(formatarDataParaInput(data.dt_fim || new Date().toISOString().split('T')[0]));
                        $('#horaFimDev').val(new Date().toTimeString().substring(0, 5));
                        $('#valorDiariaDev').val(formatarValorMonetario(data.valor_diaria || 0));
                        $('#qtdDiariasDev').val(data.qt_diarias || 0);
                        $('#valorDifDev').val(formatarValorMonetario(data.valor_diferenca || 0));
                        $('#valorSubTotalDev').val(data.valor_subtotal || 0);
                        $('#valorTotalDev').val(formatarValorMonetario(data.valor_total || 0));
                        
                        // SOLUÇÃO 1: Chamar as funções existentes para carregar os selects
                        carregarEmpenhos(processoIdSelecionado);
                        carregarSetores();
                        carregarMotoristas();
                        carregarVeiculos(processoIdSelecionado);
                        
                        // Esperar um pequeno intervalo para garantir que os dropdowns foram populados
                        setTimeout(function() {
                            // Agora definir os valores selecionados
                            $('#empenholocDev').val(itemData.id_empenho);
                            $('#setorSolicitanteDev').val(itemData.setor_solicitante);
                            $('#motoristaDev').val(data.id_motorista);
                            $('#veiculoDev').val(itemData.id_veiculo_loc);
                            
                            // Calcular diárias e valores
                            calcularDiariasEValoresDev();
                            
                            // Restaurar o botão e abrir o modal
                            $(self).html('<i class="fas fa-undo-alt"></i>');
                            const modalDevolucaoLocacao = new bootstrap.Modal(document.getElementById('modalDevolucaoLocacao'));
                            modalDevolucaoLocacao.show();
                        }, 1000); // Esperar 1 segundo
                    },
                    error: function(xhr, status, error) {
                        console.error("Erro ao carregar dados da locação:", error);
                        alert("Erro ao carregar dados da locação: " + (xhr.responseJSON?.erro || error));
                        $(self).html('<i class="fas fa-undo-alt"></i>');
                    }
                });
            });

            // Recalcular diárias e valores ao alterar datas e horas
            $('#dataFimDev, #horaFimDev, #qtdDiariaDev, #valorDifDev').on('change input', function() {
                calcularDiariasEValoresDev();
            });
            
            // Botão salvar devolução
            $('#btnSalvarDevolucao').click(function() {
                // Validar formulário
                if (!validarFormularioDevolucao()) {
                    return;
                }
                
                // Mostrar loader
                $(this).prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Salvando...');
                
                const idItem = $('#idItemDev').val();
                const formData = new FormData();
                
                // Adicionar dados ao FormData
                formData.append('data_fim', $('#dataFimDev').val());
                formData.append('hora_fim', $('#horaFimDev').val());
                formData.append('qt_diarias', $('#qtdDiariaDev').val());
                formData.append('valor_diferenca', converterParaNumero($('#valorDifDev').val()));
                formData.append('valor_subtotal', $('#valorSubTotalDev').val());
                formData.append('valor_total', converterParaNumero($('#valorTotalDev').val()));
                formData.append('veiculo_modelo', $('#veiculoModeloDev').val());
                
                // Enviar dados para API
                $.ajax({
                    url: `/api/salvar_devolucao/${idItem}`,
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        console.log("Resposta:", response);
                        
                        // Mostrar mensagem de sucesso
                        $('#mensagemSucesso').text("Devolução registrada com sucesso!");
                        
                        // Fechar modal de devolução
                        $('#modalDevolucaoLocacao').modal('hide');
                        
                        // Mostrar modal de sucesso
                        const modalSucesso = new bootstrap.Modal(document.getElementById('modalSucesso'));
                        modalSucesso.show();
                        
                        // Recarregar locações em trânsito
                        if (processoIdSelecionado) {
                            carregarLocacoesTransito(processoIdSelecionado);
                            carregarLocacoesFinalizadas(processoIdSelecionado);
                        }
                        
                        // Reset botão salvar
                        $('#btnSalvarDevolucao').prop('disabled', false).html('<i class="fas fa-save"></i> Salvar Devolução');
                    },
                    error: function(xhr, status, error) {
                        console.error("Erro ao salvar devolução:", error);
                        console.error("Resposta:", xhr.responseText);
                        
                        let mensagemErro = "Erro ao salvar devolução";
                        if (xhr.responseJSON && xhr.responseJSON.erro) {
                            mensagemErro += ": " + xhr.responseJSON.erro;
                        } else if (xhr.statusText) {
                            mensagemErro += ": " + xhr.statusText;
                        } else {
                            mensagemErro += ": " + error;
                        }
                        
                        alert(mensagemErro);
                        
                        // Reset botão salvar
                        $('#btnSalvarDevolucao').prop('disabled', false).html('<i class="fas fa-save"></i> Salvar Devolução');
                    }
                });
            });            
            
        });
        
        // Função para carregar setores  - Form Nova Locação
        function carregarSetores() {
            $.ajax({
                url: '/api/setores_loc',
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    let html = '<option value="">Selecione...</option>';
                    data.forEach(function(item) {
                        html += `<option value="${item.SIGLA_SETOR}">${item.SIGLA_SETOR}</option>`;
                    });
                    $('#setorSolicitante').html(html);
                    $('#setorSolicitanteDev').html(html);
                },
                error: function(xhr, status, error) {
                    console.error("Erro ao carregar setores:", error);
                    alert("Erro ao carregar lista de setores.");
                }
            });
        }
        
        // Função para carregar motoristas - Form Nova Locação
        function carregarMotoristas() {
            $.ajax({
                url: '/api/lista_motorista_loc',
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    motoristasLista = data;
                    let html = '<option value="">Selecione...</option>';
                    data.forEach(function(item) {
                        html += `<option value="${item.ID_MOTORISTA}">${item.NM_MOTORISTA}</option>`;
                    });
                    $('#motorista').html(html);
                    $('#motoristaDev').html(html);
                },
                error: function(xhr, status, error) {
                    console.error("Erro ao carregar motoristas:", error);
                    alert("Erro ao carregar lista de motoristas.");
                }
            });
        }
        
        // Função para carregar empenhos - Form Nova Locação
        function carregarEmpenhos(id_cl) {
            $.ajax({
                url: `/api/empenhos_loc?id_cl=${id_cl}`,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    empenhoLista = data;
                    let html = '<option value="">Selecione...</option>';
                    data.forEach(function(item) {
                        html += `<option value="${item.ID_EMPENHO}">${item.NU_EMPENHO}</option>`;
                    });
                    $('#empenholoc').html(html);
                    $('#empenholocDev').html(html);
                },
                error: function(xhr, status, error) {
                    console.error("Erro ao carregar empenhos:", error);
                    alert("Erro ao carregar lista de empenhos.");
                }
            });
        }

        // Função para carregar veículos - Form Nova Locação
        function carregarVeiculos(id_cl) {
            $.ajax({
                url: `/api/lista_veiculo?id_cl=${id_cl}`,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    veiculosLista = data;
                    let html = '<option value="">Selecione...</option>';
                    data.forEach(function(item) {
                        html += `<option value="${item.ID_VEICULO_LOC}" data-valor="${item.VL_DIARIA_KM}">${item.DE_VEICULO}</option>`;
                    });
                    $('#veiculo').html(html);
                    $('#veiculoDev').html(html);
                },
                error: function(xhr, status, error) {
                    console.error("Erro ao carregar veículos:", error);
                    alert("Erro ao carregar lista de veículos.");
                }
            });
        }
        
        // Calcular diárias e valores
        function calcularDiariasEValores() {
            const dataInicio = new Date($('#dataInicio').val());
            const dataFim = new Date($('#dataFim').val());
            
            if (!isNaN(dataInicio.getTime()) && !isNaN(dataFim.getTime())) {
                // Diferença em dias
                const diffTime = dataFim.getTime() - dataInicio.getTime();
                let diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                // Se for o mesmo dia ou diferença negativa, consideramos como 1 diária
                if (diffDays <= 0) {
                    diffDays = 1;
                }
                
                $('#qtdDiarias').val(diffDays);
                
                // Calcular valor total
                const valorDiaria = $('#valorDiaria').val().replace('.', '').replace(',', '.') || 0;
                const valorTotal = diffDays * parseFloat(valorDiaria);
                
                $('#valorTotal').val(valorTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
            }
        }   
        
        // Função para carregar processos de locação
        function carregarProcessos() {
            $.ajax({
                url: '/api/processos_locacao',
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    let html = '';
                    data.forEach(function(item) {
                        html += `<tr>
                            <td>${item.ID_CL}</td>
                            <td>${item.ANO_EXERCICIO}</td>
                            <td>${item.NM_FORNECEDOR}</td>
                            <td>${item.NU_SEI}</td>
                            <td>${item.NU_CONTRATO}</td>
                            <td class="sticky-column">
                                <a href="javascript:void(0)" onclick="selecionarProcesso(${item.ID_CL})" class="btn-selecionar">Selecionar</a>
                            </td>
                        </tr>`;
                    });
                    $('#tabela-processos').html(html);
                },
                error: function(xhr, status, error) {
                    console.error("Erro ao carregar processos:", error);
                    alert("Erro ao carregar dados. Verifique o console para mais detalhes.");
                }
            });
        }
        
        // Função para validar o formulário
        function validarFormulario() {
            if (!$('#setorSolicitante').val()) {
                alert("Por favor, selecione o setor solicitante.");
                return false;
            }
            
            if (!$('#objetivo').val()) {
                alert("Por favor, informe o objetivo da locação.");
                return false;
            }
            
            if (!$('#veiculo').val()) {
                alert("Por favor, selecione um veículo.");
                return false;
            }
            
            if (!$('#motorista').val()) {
                alert("Por favor, selecione um motorista.");
                return false;
            }
            
            if (!$('#dataInicio').val()) {
                alert("Por favor, informe a data de início.");
                return false;
            }
            
            if (!$('#dataFim').val()) {
                alert("Por favor, informe a data de fim.");
                return false;
            }
            
            if (!$('#horaInicio').val()) {
                alert("Por favor, informe a hora de início.");
                return false;
            }
            
            // if (!$('#numSei').val() || !$('#numSei').val().match(/^\d{7}-\d{2}\.\d{1}\.\d{2}\.\d{2}\.\d{4}$/)) {
            //     alert("Por favor, informe um número SEI válido no formato 0000000-00.0.00.0000.");
            //     return false;
            // }
            
            // Verificar se as datas são válidas
            const dataInicio = new Date($('#dataInicio').val());
            const dataFim = new Date($('#dataFim').val());
            
            if (dataFim < dataInicio) {
                alert("A data final não pode ser anterior à data inicial!");
                return false;
            }
                            
            return true;
        }
                
        // Função para validar o formulário de devolução
        function validarFormularioDevolucao() {
            if (!$('#dataFimDev').val()) {
                alert("Por favor, informe a data de devolução.");
                return false;
            }
            
            if (!$('#horaFimDev').val()) {
                alert("Por favor, informe a hora de devolução.");
                return false;
            }
            
            if (!$('#veiculoModeloDev').val()) {
                alert("Por favor, informe o modelo do veículo.");
                return false;
            }
            
            // Verificar se as datas são válidas
            const dataInicio = new Date($('#dataInicioDev').val() + 'T' + $('#horaInicioDev').val());
            const dataFim = new Date($('#dataFimDev').val() + 'T' + $('#horaFimDev').val());
            
            if (dataFim < dataInicio) {
                alert("A data/hora de devolução não pode ser anterior à data/hora de início!");
                return false;
            }
            
            return true;
        }      

        // Corrija a função de cálculo de diárias e valores para devolução
        function calcularDiariasEValoresDev() {
            // Obtém as datas e horas de início e fim
            const dataInicio = new Date($('#dataInicioDev').val() + 'T' + $('#horaInicioDev').val() + ':00');
            const dataFim = new Date($('#dataFimDev').val() + 'T' + $('#horaFimDev').val() + ':00');
            
            console.log("Calculando diárias:", dataInicio, dataFim);
            
            if (isNaN(dataInicio.getTime()) || isNaN(dataFim.getTime())) {
                console.error("Datas inválidas:", $('#dataInicioDev').val(), $('#horaInicioDev').val(), $('#dataFimDev').val(), $('#horaFimDev').val());
                return; // Datas inválidas
            }
            
            // Se o usuário já alterou manualmente o valor das diárias, respeitar esse valor
            if (document.activeElement !== document.getElementById('qtdDiariasDev')) { // CORRIGIDO
                // Calcular a diferença em milissegundos
                const diffMs = dataFim - dataInicio;
                
                // Converter para horas
                const diffHoras = diffMs / (1000 * 60 * 60);
                
                // Calcular diárias (24 horas = 1 diária)
                let diarias = Math.floor(diffHoras / 24);
                
                // Calcular horas excedentes
                const horasExcedentes = diffHoras % 24;
                
                // Se tiver horas excedentes além da tolerância, calcular o valor adicional
                if (horasExcedentes > TOLERANCIA_HORAS) {
                    // Adicionar horas extras convertidas em fração de diária
                    const horasExtras = horasExcedentes - TOLERANCIA_HORAS;
                    
                    // Cada hora extra vale 1/10 do valor da diária
                    const fracaoHorasExtras = Math.ceil(horasExtras) * FRACAO_HORA_EXTRA;
                    
                    // Se a fração passar de 1, considerar uma diária completa
                    if (fracaoHorasExtras >= 1) {
                        diarias += 1;
                        $('#valorDifDev').val('0,00');
                    } else {
                        // Atualizar o campo de diárias e calcular o valor da diferença (horas extras)
                        const valorDiaria = converterParaNumero($('#valorDiariaDev').val());
                        const valorDiferenca = valorDiaria * fracaoHorasExtras;
                        
                        $('#valorDifDev').val(formatarValorMonetario(valorDiferenca));
                    }
                } else {
                    // Sem horas extras
                    $('#valorDifDev').val('0,00');
                }
                
                // Garantir no mínimo 1 diária
                diarias = Math.max(1, diarias);
                $('#qtdDiariasDev').val(diarias); // CORRIGIDO
            }
            
            // Calcular valor total
            const valorDiaria = converterParaNumero($('#valorDiariaDev').val());
            const qtdDiarias = parseFloat($('#qtdDiariasDev').val() || 0); // CORRIGIDO
            const valorDiferenca = converterParaNumero($('#valorDifDev').val());
            
            console.log("Valores para cálculo:", valorDiaria, qtdDiarias, valorDiferenca);
            
            const valorSubTotal = valorDiaria * qtdDiarias;
            const valorTotal = valorSubTotal + valorDiferenca;
            
            console.log("Valores calculados:", valorSubTotal, valorTotal);
            
            // Armazenar valor subtotal em campo hidden
            $('#valorSubTotalDev').val(valorSubTotal);
            
            // Atualizar campos na interface
            $('#valorTotalDev').val(formatarValorMonetario(valorTotal));
        }


        // Função para formatar data para input (YYYY-MM-DD)
        function formatarDataParaInput(dataStr) {
            if (!dataStr) return '';
            
            try {
                // Se for uma string no formato dd/mm/yyyy
                const partesData = dataStr.split('/');
                if (partesData.length === 3) {
                    return `${partesData[2]}-${partesData[1]}-${partesData[0]}`;
                }
                
                // Se for uma string ISO ou outro formato reconhecido pelo construtor Date
                const data = new Date(dataStr);
                if (!isNaN(data.getTime())) {
                    return data.toISOString().split('T')[0];
                }
                
                return '';
            } catch (e) {
                console.error("Erro ao converter data para input:", e);
                return '';
            }
        }
        
        
        // Função para selecionar um processo e carregar os dados relacionados
        function selecionarProcesso(id_cl) {
            console.log("Selecionando processo ID:", id_cl);
            processoIdSelecionado = id_cl;
            
            // Obter o nome do fornecedor a partir da tabela
            const fornecedorNome = $(`#tabela-processos tr:has(td:contains(${id_cl}):first-child) td:nth-child(3)`).text();
            
            // Armazenar no localStorage
            localStorage.setItem('fornecedorNome', fornecedorNome);
            console.log("Nome do fornecedor armazenado:", fornecedorNome);

            // Carregar empenhos
            $.ajax({
                url: `/api/empenhos/${id_cl}`,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    console.log("Empenhos carregados:", data);
                    let html = '';
                    if (data.length === 0) {
                        html = '<tr><td colspan="6" class="text-center">Nenhum empenho encontrado</td></tr>';
                    } else {
                        data.forEach(function(item) {
                            html += `<tr>
                                <td>${item.NU_EMPENHO}</td>
                                <td>R$ ${formatarValor(item.VL_EMPENHO)}</td>
                                <td>R$ ${formatarValor(item.VL_DIARIAS)}</td>
                                <td>R$ ${formatarValor(item.VL_DIF)}</td>
                                <td>R$ ${formatarValor(item.VL_UTILIZADO)}</td>
                                <td>R$ ${formatarValor(item.VL_SALDO)}</td>
                            </tr>`;
                        });
                    }
                    $('#tabela-empenhos').html(html);
                },
                error: function(xhr, status, error) {
                    console.error("Erro ao carregar empenhos:", error);
                    $('#tabela-empenhos').html('<tr><td colspan="6" class="text-center text-danger">Erro ao carregar dados</td></tr>');
                }
            });
            
            // Carregar saldo de diárias
            $.ajax({
                url: `/api/saldo_diarias/${id_cl}`,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    console.log("Saldo de diárias carregado:", data);
                    let html = '';
                    if (data.length === 0) {
                        html = '<tr><td colspan="8" class="text-center">Nenhum registro encontrado</td></tr>';
                    } else {
                        data.forEach(function(item) {
                            html += `<tr>
                                <td>${item.DE_VEICULO}</td>
                                <td>R$ ${formatarValor(item.VL_DIARIA_KM)}</td>
                                <td>${item.QT_DK}</td>
                                <td>${item.QT_UTILIZADO}</td>
                                <td>${item.QT_SALDO}</td>
                                <td>R$ ${formatarValor(item.VALOR_TOTAL)}</td>
                                <td>R$ ${formatarValor(item.VL_UTILIZADO)}</td>
                                <td>R$ ${formatarValor(item.VL_SALDO)}</td>
                            </tr>`;
                        });
                    }
                    $('#tabela-saldo-diarias').html(html);
                },
                error: function(xhr, status, error) {
                    console.error("Erro ao carregar saldo de diárias:", error);
                    $('#tabela-saldo-diarias').html('<tr><td colspan="8" class="text-center text-danger">Erro ao carregar dados</td></tr>');
                }
            });

            // Carregar dados do PLS
            $.ajax({
                url: `/api/dados_pls/${id_cl}`,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    console.log("Dados do PLS carregado:", data);
                    let html = '';
                    if (data.length === 0) {
                        html = '<tr><td colspan="8" class="text-center">Nenhum registro encontrado</td></tr>';
                    } else {
                        data.forEach(function(item) {
                            html += `<tr>
                                <td>${item.MES_ANO}</td>
                                <td>${item.QTD}</td>
                                <td>R$ ${formatarValor(item.VLTOTAL)}</td>
                                <td>${item.COMBUSTIVEL}</td>
                            </tr>`;
                        });
                    }
                    $('#tabela-dados-pls').html(html);
                },
                error: function(xhr, status, error) {
                    console.error("Erro ao carregar saldo de diárias:", error);
                    $('#tabela-dados-pls').html('<tr><td colspan="8" class="text-center text-danger">Erro ao carregar dados</td></tr>');
                }
            });            
            
            // Carregar locações em trânsito
            $.ajax({
                url: `/api/locacoes_transito/${id_cl}`,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    console.log("Locações em trânsito carregadas:", data);
                    let html = '';
                    if (data.length === 0) {
                        html = '<tr><td colspan="10" class="text-center">Nenhuma locação em trânsito encontrada</td></tr>';
                    } else {
                        data.forEach(function(item) {
                            html += `<tr>
                                <td>${item.ID_ITEM}</td>
                                <td>${item.MES_ANO}</td>
                                <td>${item.DE_VEICULO}</td>
                                <td>${item.DS_VEICULO_MOD}</td>
                                <td>${formatarDataString(item.DT_INICIAL)}</td>
                                <td>${formatarDataString(item.DT_FINAL)}</td>
                                <td>${item.QT_DIARIA_KM}</td>
                                <td>R$ ${formatarValor(item.VL_TOTALITEM)}</td>
                                <td>${item.MOTORISTA}</td>
                                <td class="sticky-column">
                                    <div class="d-flex justify-content-around">
                                        <a href="javascript:void(0)" class="btn btn-sm btn-primary" title="Abrir">
                                            <i class="fas fa-folder-open"></i>
                                        </a>
                                        <a href="javascript:void(0)" class="btn btn-sm btn-danger ms-1" title="Devolução">
                                            <i class="fas fa-undo-alt"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>`;
                        });
                    }
                    $('#tabela-transito').html(html);
                },
                error: function(xhr, status, error) {
                    console.error("Erro ao carregar locações em trânsito:", error);
                    console.error("Status:", xhr.status);
                    console.error("Resposta:", xhr.responseText);
                    $('#tabela-transito').html('<tr><td colspan="10" class="text-center text-danger">Erro ao carregar dados</td></tr>');
                }
            });
            
            // Carregar opções de filtro para mês/ano
            $.ajax({
                url: `/api/meses_locacoes/${id_cl}`,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    console.log("Opções de mês/ano carregadas:", data);
                    let selectHtml = '<option value="Todos">Todos</option>';
                    data.forEach(function(item) {
                        selectHtml += `<option value="${item.MES_ANO}">${item.MES_ANO}</option>`;
                    });
                    $('#filtroMesAno').html(selectHtml);
                },
                error: function(xhr, status, error) {
                    console.error("Erro ao carregar opções de mês/ano:", error);
                    $('#filtroMesAno').html('<option value="Todos">Todos</option>');
                }
            });
            
            // Carregar locações finalizadas
            carregarLocacoesFinalizadas(id_cl);
        }
        
        // Função para carregar locações finalizadas
        function carregarLocacoesFinalizadas(id_cl) {
            $.ajax({
                url: `/api/locacoes_finalizadas/${id_cl}`,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    console.log("Locações finalizadas carregadas:", data);
                    // Armazenar os dados completos para filtrar depois
                    locacoesFinalizadasCompletas = data;
                    
                    // Exibir todos os dados inicialmente
                    exibirLocacoesFinalizadas(data);
                },
                error: function(xhr, status, error) {
                    console.error("Erro ao carregar locações finalizadas:", error);
                    console.error("Status:", xhr.status);
                    console.error("Resposta:", xhr.responseText);
                    $('#tabela-finalizadas').html('<tr><td colspan="10" class="text-center text-danger">Erro ao carregar dados</td></tr>');
                }
            });
        }
        
        // Função para exibir locações finalizadas na tabela
        function exibirLocacoesFinalizadas(data) {
            let html = '';
            if (data.length === 0) {
                html = '<tr><td colspan="10" class="text-center">Nenhuma locação finalizada encontrada</td></tr>';
            } else {
                data.forEach(function(item) {
                    html += `<tr>
                        <td>${item.ID_ITEM}</td>
                        <td>${item.MES_ANO}</td>
                        <td>${item.DE_VEICULO}</td>
                        <td>${item.DS_VEICULO_MOD}</td>
                        <td>${formatarDataString(item.DT_INICIAL)}</td>
                        <td>${formatarDataString(item.DT_FINAL)}</td>
                        <td>${item.QT_DIARIA_KM}</td>
                        <td>R$ ${formatarValor(item.VL_TOTALITEM)}</td>
                        <td>${item.MOTORISTA}</td>
                        <td class="sticky-column">
                            <a href="javascript:void(0)" class="acao-btn btn-abrir">Visualizar</a>
                        </td>
                    </tr>`;
                });
            }
            $('#tabela-finalizadas').html(html);
        }
        
        // Função para aplicar filtro por mês/ano
        function aplicarFiltroMesAno() {
            const filtroSelecionado = $('#filtroMesAno').val();
            
            if (filtroSelecionado === 'Todos') {
                // Exibir todos os dados
                exibirLocacoesFinalizadas(locacoesFinalizadasCompletas);
            } else {
                // Filtrar os dados pelo mês/ano selecionado
                const dadosFiltrados = locacoesFinalizadasCompletas.filter(item => item.MES_ANO === filtroSelecionado);
                exibirLocacoesFinalizadas(dadosFiltrados);
            }
        }
        
        // Função para formatar valores monetários
        function formatarValor(valor) {
            if (valor === null || valor === undefined) return '0,00';
            return parseFloat(valor).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }
        
        // Função para formatar datas (string no formato dd/mm/yyyy)
        function formatarDataString(dataStr) {
            if (!dataStr) return '';
            
            // Verifica se a data já está no formato desejado (dd/mm/yyyy)
            if (typeof dataStr === 'string' && dataStr.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                return dataStr; // Já está no formato correto, retorna a própria string
            }
            
            // Tenta converter usando o formato ISO
            try {
                const dt = new Date(dataStr);
                if (!isNaN(dt.getTime())) {
                    return dt.toLocaleDateString('pt-BR');
                }
            } catch (e) {
                console.error("Erro ao formatar data como ISO:", e);
            }
            
            // Se não conseguiu converter como ISO, tenta outros formatos comuns
            try {
                // Tenta extrair dia, mês e ano para os casos onde dataStr é algo como "dd/mm/yyyy"
                // ou quando é uma string em outro formato que precisa ser manipulado
                let dia, mes, ano;
                
                // Formato dd/mm/yyyy
                const formatoBR = dataStr.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
                if (formatoBR) {
                    dia = formatoBR[1];
                    mes = formatoBR[2];
                    ano = formatoBR[3];
                    return `${dia}/${mes}/${ano}`;
                }
                
                // Formato yyyy-mm-dd ou yyyy/mm/dd
                const formatoISO = dataStr.match(/^(\d{4})[\/-](\d{2})[\/-](\d{2})$/);
                if (formatoISO) {
                    dia = formatoISO[3];
                    mes = formatoISO[2];
                    ano = formatoISO[1];
                    return `${dia}/${mes}/${ano}`;
                }
                
                // Se chegou até aqui, retorna a string original
                return dataStr;
            } catch (e) {
                console.error("Erro ao formatar data com regex:", e);
                return dataStr; // Em caso de erro, retorna o valor original
            }
        }
    </script>
</body>
</html>
