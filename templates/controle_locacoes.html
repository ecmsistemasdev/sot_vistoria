<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="static/img/logo_sotweb.jpg">
    <title>Controle de Locações</title>
    <link rel="stylesheet" href="/static/css/controle_locacoes.css">    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Modal RelatÃ³rio AnalÃ­tico */
        .modal-cnh {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }
    
        .modal-cnh-content {
            background-color: #fefefe;
            margin: 2% auto;
            padding: 0;
            border: 1px solid #888;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
    
        .modal-cnh-header {
            padding: 15px;
            background-color: #0d6efd;
            color: white;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    
        .modal-cnh-header h5 {
            margin: 0;
            font-size: 1.25rem;
        }
    
        .modal-cnh-close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            line-height: 28px;
            text-align: center;
        }
    
        .modal-cnh-close:hover,
        .modal-cnh-close:focus {
            color: #ddd;
            text-decoration: none;
            cursor: pointer;
        }
    
        .modal-cnh-body {
            padding: 20px;
        }
    </style>
</head>
<body>
    <!-- Menu de navegação fixo -->
    <nav class="navbar navbar-expand-lg navbar-light fixed-navbar">
        <div class="container">
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <!-- Cadastros -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarCadastros" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Cadastros
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="navbarCadastros">
                            <li><a class="dropdown-item" href="/motoristas">Motorista</a></li>
                            <li><a class="dropdown-item" href="/veiculos_frota">Veículo da Frota</a></li>
                        </ul>
                    </li>
                    
                    <!-- Controles -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarControles" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Controles
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="navbarControles">
                            <li><a class="dropdown-item" href="/controle_locacoes">Locação de Veículos</a></li>
                            <li><a class="dropdown-item" href="/fluxo_veiculos">Fluxo de Veículo</a></li>
                        </ul>
                    </li>
                    
                    <!-- Vistorias -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarVistorias" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Vistorias
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="navbarVistorias">
                            <li><a class="dropdown-item" href="/nova_vistoria">Nova Vistoria Completa</a></li>
                            <li><a class="dropdown-item" href="/nova_vistoria2">Nova Vistoria em Duas Etapas</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="/vistorias">Lista Vistorias</a></li>
                        </ul>
                    </li>
                    
                    <!-- Relatórios -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarRelatorios" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Relatórios
                        </a>
                        <!-- <ul class="dropdown-menu" aria-labelledby="navbarRelatorios">
                            <li><a class="dropdown-item" href="#">Relatório 1</a></li>
                            <li><a class="dropdown-item" href="#">Relatório 2</a></li>
                        </ul> -->
                    </li>
                </ul>
                <!-- Botão Sair -->
                <div class="ms-auto">
                    <button class="btn btn-sm btn-logout" id="btnLogout" onclick="fazerLogout()">Sair</button>
                </div>                
            </div>
        </div>
    </nav>
    
    <div class="container-fluid mt-2">
        <h4 class="mb-3">Controle de Locações</h4>
        
        <div class="row">
            <!-- GroupBox - Processos de Locação -->
            <div class="col-md-6">
                <div class="groupbox">
                    <div class="groupbox-header">Processos de Locação</div>
                    <div class="groupbox-body">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Ano</th>
                                        <th>Fornecedor</th>
                                        <th>Nº SEI</th>
                                        <th>Nº Contrato</th>
                                        <th class="sticky-column">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="tabela-processos">
                                    <!-- Dados carregados via AJAX -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- GroupBox - Empenhos (com guias) -->
            <div class="col-md-6">
                <div class="groupbox">
                    <div class="tabs-body">
                        <!-- Guias (Tabs) -->
                        <ul class="nav nav-tabs" id="empenhosTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="empenhos-tab" data-bs-toggle="tab" 
                                        data-bs-target="#empenhos" type="button" role="tab" 
                                        aria-controls="empenhos" aria-selected="true">Empenhos</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="saldo-diarias-tab" data-bs-toggle="tab" 
                                        data-bs-target="#saldo-diarias" type="button" role="tab" 
                                        aria-controls="saldo-diarias" aria-selected="false">Saldo Diárias</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="sintetico-mensal-tab" data-bs-toggle="tab" 
                                        data-bs-target="#sintetico-mensal" type="button" role="tab" 
                                        aria-controls="sintetico-mensal" aria-selected="false">Sintético Mensal</button>
                            </li>                            
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="dados-pls-tab" data-bs-toggle="tab" 
                                        data-bs-target="#dados-pls" type="button" role="tab" 
                                        aria-controls="dados-pls" aria-selected="true">Dados PLS</button>
                            </li>
                        </ul>
                        
                        <!-- Conteúdo das Guias -->
                        <div class="tab-content" id="empenhosTabsContent">
                            <!-- Guia Empenhos -->
                            <div class="tab-pane fade show active" id="empenhos" role="tabpanel" aria-labelledby="empenhos-tab">
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover">
                                        <thead>
                                            <tr>
                                                <th>Nº Empenho</th>
                                                <th>Valor Empenho</th>
                                                <th>Valor Liquidado</th>
                                                <th>Valor Saldo</th>
                                                <th>Valor À Liquidar</th>
                                                <th>Valor Saldo Disponível</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tabela-empenhos">
                                            <!-- Dados carregados via AJAX -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Guia Saldo Diárias -->
                            <div class="tab-pane fade" id="saldo-diarias" role="tabpanel" aria-labelledby="saldo-diarias-tab">
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover">
                                        <thead>
                                            <tr>
                                                <th>Veículo</th>
                                                <th>Vl. Diária</th>
                                                <th>Qtd. Diária</th>
                                                <th>Qtd. Util.</th>
                                                <th>Qtd. Saldo</th>
                                                <th>Valor Total</th>
                                                <th>Valor Util.</th>
                                                <th>Valor Saldo</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tabela-saldo-diarias">
                                            <!-- Dados carregados via AJAX -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Guia Sintético Mensal -->
                            <div class="tab-pane fade" id="sintetico-mensal" role="tabpanel" aria-labelledby="sintetico-mensal-tab">
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover">
                                        <thead>
                                            <tr>
                                                <th>Mês/Ano</th>
                                                <th>Valor Subtotal</th>
                                                <th>Valor Hora Extra</th>
                                                <th>Valor Total</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tabela-sintetico-mensal">
                                            <!-- Dados carregados via AJAX -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>                            

                            <!-- Guia Dados PLS -->
                            <div class="tab-pane fade" id="dados-pls" role="tabpanel" aria-labelledby="dados-pls-tab">
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover">
                                        <thead>
                                            <tr>
                                                <th>Mês/Ano</th>
                                                <th>Qtde Locação</th>
                                                <th>Km Rodado</th>
                                                <th>Valor</th>
                                                <th>Combustível</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tabela-dados-pls">
                                            <!-- Dados carregados via AJAX -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row splitter-row">
            <div class="col-12">
                <div class="splitter" id="splitter1">
                    <div class="splitter-handle">
                        <i class="fas fa-grip-lines"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- GroupBox - Locações em Trânsito -->
        <div class="row">
            <div class="col-12">
                <div class="groupbox">
                    <div class="groupbox-header">Locações em Trânsito</div>
                    <div class="groupbox-body lista-grande">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Mês/Ano</th>
                                        <th>Veículo</th>
                                        <th>Mod. Veículo</th>
                                        <th>Início</th>
                                        <th>Fim</th>
                                        <th>Diárias</th>
                                        <th>Valor Total</th>
                                        <th>Motorista</th>
                                        <th class="sticky-column">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="tabela-transito">
                                    <!-- Dados carregados via AJAX -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row splitter-row">
            <div class="col-12">
                <div class="splitter" id="splitter2">
                    <div class="splitter-handle">
                        <i class="fas fa-grip-lines"></i>
                    </div>
                </div>
            </div>
        </div>        

        <!-- GroupBox - Locações Finalizadas (com filtro) -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="groupbox">
                    <div class="groupbox-header d-flex justify-content-between align-items-center">
                        <span>Locações Finalizadas</span>
                        <div class="d-flex align-items-center">
                            <label for="filtroMesAno" class="me-2 mb-0">Filtro:</label>
                            <select id="filtroMesAno" class="form-select form-select-sm" style="width: auto;">
                                <option value="Todos">Todos</option>
                                <!-- Opções carregadas via AJAX -->
                            </select>
                        </div>
                    </div>
                    <div class="groupbox-body lista-grande">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Mês/Ano</th>
                                        <th>Veículo</th>
                                        <th>Mod. Veículo</th>
                                        <th>Início</th>
                                        <th>Fim</th>
                                        <th>Diárias</th>
                                        <th>Valor Total</th>
                                        <th>Motorista</th>
                                        <th class="sticky-column">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="tabela-finalizadas">
                                    <!-- Dados carregados via AJAX -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer (novo, baseado no footer da página de motoristas) -->
    <div class="footer">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <button id="btnNovaLocacao" class="btn btn-success me-2">
                        <i class="fas fa-plus-circle"></i> Nova Locação
                    </button>
                    <button id="btnRelatorioAnalitico" class="btn btn-info">
                        <i class="fas fa-file-alt"></i> Relatório Analítico
                    </button>
                </div>
                <button id="btnVoltar" class="btn btn-secondary" onclick="window.history.back();">
                    <i class="fas fa-arrow-left"></i> Voltar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Nova Locação -->
    <div class="modal fade" id="modalNovaLocacao" data-bs-backdrop="static" tabindex="-1" aria-labelledby="modalNovaLocacaoLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalNovaLocacaoLabel">Nova Locação</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="formNovaLocacao" class="row g-3">
                        <div class="col-md-6">
                            <label for="empenholoc" class="form-label small">Empenho</label>
                            <select class="form-select form-select-sm" id="empenholoc" required>
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="setorSolicitante" class="form-label small">Setor Solicitante</label>
                            <select class="form-select form-select-sm" id="setorSolicitante" required>
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                        <div class="col-md-8">
                            <label for="objetivo" class="form-label small">Objetivo</label>
                            <input type="text" class="form-control form-control-sm" id="objetivo" maxlength="300" required>
                        </div>
                        <div class="col-md-4">
                            <label for="numSei" class="form-label small">Número SEI</label>
                            <input type="text" class="form-control form-control-sm" id="numSei" maxlength="25" required>
                        </div>
                        <div class="col-md-6">
                            <label for="veiculo" class="form-label small">Veículo</label>
                            <select class="form-select form-select-sm" id="veiculo" required>
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="motorista" class="form-label small">Motorista 
                                <a href="#" id="btnBuscarMotorista" class="ms-2 small text-primary">
                                    <i class="fas fa-search"></i> Buscar Motorista
                                </a>
                            </label>
                            <select class="form-select form-select-sm" id="motorista" required>
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="dataInicio" class="form-label small">Data Início</label>
                            <input type="date" class="form-control form-control-sm" id="dataInicio" required>
                        </div>
                        <div class="col-md-4">
                            <label for="horaInicio" class="form-label small">Hora Início</label>
                            <input type="time" class="form-control form-control-sm" id="horaInicio" required>
                        </div>                        
                        <div class="col-md-4">
                            <label for="dataFim" class="form-label small">Data Fim</label>
                            <input type="date" class="form-control form-control-sm" id="dataFim" required>
                        </div>
                        <div class="col-md-4">
                            <label for="qtdDiarias" class="form-label small">Qtd. Diárias</label>
                            <input type="number" class="form-control form-control-sm" id="qtdDiarias" readonly>
                        </div>
                        <div class="col-md-4">
                            <label for="valorDiaria" class="form-label small">Valor Diária</label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">R$</span>
                                <input type="text" class="form-control form-control-sm" id="valorDiaria" readonly>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label for="valorTotal" class="form-label small">Valor Total</label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">R$</span>
                                <input type="text" class="form-control form-control-sm" id="valorTotal" readonly>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <label for="observacoes" class="form-label small">Observações</label>
                            <textarea class="form-control form-control-sm" id="observacoes" rows="2" maxlength="200"></textarea>
                            <div class="text-end">
                                <small><span id="charCount">0</span>/200</small>
                            </div>
                        </div>
                        <div id="arquivoCnhDiv" class="col-md-12 d-none">
                            <label for="arquivoCnh" class="form-label small">Arquivo CNH</label>
                            <input type="file" class="form-control form-control-sm" id="arquivoCnh" accept=".pdf">
                            <div class="text-danger small mt-1">É necessário anexar a CNH do motorista para prosseguir.</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger btn-sm" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="button" class="btn btn-success btn-sm" id="btnSalvarLocacao">
                        <i class="fas fa-save"></i> Salvar
                    </button>
                </div>
            </div>
        </div>
    </div>
        
    <!-- Modal Devolução de Locação -->
    <div class="modal fade" id="modalDevolucaoLocacao" data-bs-backdrop="static" tabindex="-1" aria-labelledby="modalDevolucaoLocacaoLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="modalDevolucaoLocacaoLabel">Devolução de Locação</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="formDevolucaoLocacao" class="row g-3">
                        <div class="col-md-6">
                            <label for="empenholocDev" class="form-label small">Empenho</label>
                            <select class="form-select form-select-sm" id="empenholocDev" required>
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="setorSolicitanteDev" class="form-label small">Setor Solicitante</label>
                            <select class="form-select form-select-sm" id="setorSolicitanteDev" required>
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                        <div class="col-md-12">
                            <label for="objetivoDev" class="form-label small">Objetivo</label>
                            <input type="text" class="form-control form-control-sm" id="objetivoDev" maxlength="300" required>
                        </div>                        
                        <div class="col-md-4">
                            <label for="numSeiDev" class="form-label small">Número SEI</label>
                            <input type="text" class="form-control form-control-sm" id="numSeiDev" maxlength="25" required>
                        </div>
                        <div class="col-md-8">
                            <label for="motoristaDev" class="form-label small">Motorista</label>
                            <select class="form-select form-select-sm" id="motoristaDev" required>
                                <option value="">Selecione...</option>
                            </select>                            
                            <!-- <input type="text" class="form-control form-control-sm" id="motoristaDev" maxlength="25" readonly> -->
                        </div>
                        <div class="col-md-4">
                            <label for="veiculoDev" class="form-label small">Veículo</label>
                            <select class="form-select form-select-sm" id="veiculoDev" required>
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="veiculoModeloDev" class="form-label small">Modelo Veículo</label>
                            <input type="text" class="form-control form-control-sm uppercase" id="veiculoModeloDev" placeholder="MARCA/MODELO - PLACA" maxlength="35" required>
                            <div id="sugestoesModeloVeiculo" class="position-absolute bg-white border shadow-sm" 
                                 style="z-index: 9999; display: none; width: calc(100% - 24px); max-height: 200px; overflow-y: auto;">
                            </div>                   
                        </div>
                        <div class="col-md-4">
                            <label for="combustivelDev" class="form-label small">Combustível</label>
                            <select class="form-select form-select-sm" id="combustivelDev" required>
                                <option value="">Selecione...</option>
                                <option value="GASOLINA">GASOLINA</option>
                                <option value="ETANOL">ETANOL</option>
                                <option value="DIESEL">DIESEL</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="dataInicioDev" class="form-label small">Data Início</label>
                            <input type="date" class="form-control form-control-sm" id="dataInicioDev" required>
                        </div>
                        <div class="col-md-3">
                            <label for="horaInicioDev" class="form-label small">Hora Início</label>
                            <input type="time" class="form-control form-control-sm" id="horaInicioDev" required>
                        </div>                        
                        <div class="col-md-3">
                            <label for="dataFimDev" class="form-label small">Data Fim</label>
                            <input type="date" class="form-control form-control-sm" id="dataFimDev" required>
                        </div>
                        <div class="col-md-3">
                            <label for="horaFimDev" class="form-label small">Hora Dev.</label>
                            <input type="time" class="form-control form-control-sm" id="horaFimDev" required>
                        </div>                        
                        <div class="col-md-2">
                            <label for="qtdDiariasDev" class="form-label small">Qtd. Diárias</label>
                            <input type="number" class="form-control form-control-sm" id="qtdDiariasDev">
                        </div>
                        <div class="col-md-2">
                            <label for="valorDiariaDev" class="form-label small">Valor Diária</label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">R$</span>
                                <input type="text" class="form-control form-control-sm" id="valorDiariaDev">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <label for="valorDifDev" class="form-label small">Valor Dif.</label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">R$</span>
                                <input type="text" class="form-control form-control-sm" id="valorDifDev">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label for="valorTotalDev" class="form-label small">Valor Total</label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">R$</span>
                                <input type="text" class="form-control form-control-sm" id="valorTotalDev" readonly>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label for="kmDev" class="form-label small">Km Rodado</label>
                            <input type="number" class="form-control form-control-sm" id="kmDev">
                        </div>
                        <div class="col-md-12">
                            <label for="observacoesDev" class="form-label small">Observações</label>
                            <textarea class="form-control form-control-sm" id="observacoesDev" rows="2" maxlength="200"></textarea>
                            <div class="text-end">
                                <small><span id="charCountDev">0</span>/200</small>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger btn-sm" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="button" class="btn btn-success btn-sm" id="btnSalvarDevolucao">
                        <i class="fas fa-save"></i> Salvar Devolução
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Editar Locação -->
    <div class="modal fade" id="modalEditarLocacao" data-bs-backdrop="static" tabindex="-1" aria-labelledby="modalEditarLocacaoLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title" id="modalDevolucaoLocacaoLabel">Editar Locação</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="formEditarLocacao" class="row g-3">
                        <div class="col-md-6">
                            <label for="empenholocEdt" class="form-label small">Empenho</label>
                            <select class="form-select form-select-sm" id="empenholocEdt" required>
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="setorSolicitanteEdt" class="form-label small">Setor Solicitante</label>
                            <select class="form-select form-select-sm" id="setorSolicitanteEdt" required>
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                        <div class="col-md-12">
                            <label for="objetivoEdt" class="form-label small">Objetivo</label>
                            <input type="text" class="form-control form-control-sm" id="objetivoEdt" maxlength="300" required>
                        </div>                        
                        <div class="col-md-4">
                            <label for="numSeiEdt" class="form-label small">Número SEI</label>
                            <input type="text" class="form-control form-control-sm" id="numSeiEdt" maxlength="25" required>
                        </div>
                        <div class="col-md-8">
                            <label for="motoristaEdt" class="form-label small">Motorista</label>
                            <select class="form-select form-select-sm" id="motoristaEdt" required>
                                <option value="">Selecione...</option>
                            </select>                            
                        </div>
                        <div class="col-md-4">
                            <label for="veiculoEdt" class="form-label small">Veículo</label>
                            <select class="form-select form-select-sm" id="veiculoEdt" required>
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="veiculoModeloEdt" class="form-label small">Modelo Veículo</label>
                            <input type="text" class="form-control form-control-sm uppercase" id="veiculoModeloEdt" placeholder="MARCA/MODELO - PLACA" maxlength="35" required>
                            <div id="sugestoesModeloVeiculoEdt" class="position-absolute bg-white border shadow-sm" 
                                 style="z-index: 9999; display: none; width: calc(100% - 24px); max-height: 200px; overflow-y: auto;">
                            </div>                   
                        </div>
                        <div class="col-md-4">
                            <label for="combustivelEdt" class="form-label small">Combustível</label>
                            <select class="form-select form-select-sm" id="combustivelEdt" required>
                                <option value="">Selecione...</option>
                                <option value="GASOLINA">GASOLINA</option>
                                <option value="ETANOL">ETANOL</option>
                                <option value="DIESEL">DIESEL</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="dataInicioEdt" class="form-label small">Data Início</label>
                            <input type="date" class="form-control form-control-sm" id="dataInicioEdt" required>
                        </div>
                        <div class="col-md-4">
                            <label for="horaInicioEdt" class="form-label small">Hora Início</label>
                            <input type="time" class="form-control form-control-sm" id="horaInicioEdt" required>
                        </div>                        
                        <div class="col-md-4">
                            <label for="dataFimEdt" class="form-label small">Data Fim</label>
                            <input type="date" class="form-control form-control-sm" id="dataFimEdt" required>
                        </div>
                        <div class="col-md-3">
                            <label for="qtdDiariasEdt" class="form-label small">Qtd. Diárias</label>
                            <input type="number" class="form-control form-control-sm" id="qtdDiariasEdt">
                        </div>
                        <div class="col-md-3">
                            <label for="valorDiariaEdt" class="form-label small">Valor Diária</label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">R$</span>
                                <input type="text" class="form-control form-control-sm" id="valorDiariaEdt" readonly>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label for="valorDifEdt" class="form-label small">Valor Dif.</label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">R$</span>
                                <input type="text" class="form-control form-control-sm" id="valorDifEdt">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label for="valorTotalEdt" class="form-label small">Valor Total</label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">R$</span>
                                <input type="text" class="form-control form-control-sm" id="valorTotalEdt" readonly>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <label for="observacoesEdt" class="form-label small">Observações</label>
                            <textarea class="form-control form-control-sm" id="observacoesEdt" rows="2" maxlength="200"></textarea>
                            <div class="text-end">
                                <small><span id="charCountEdt">0</span>/200</small>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer d-flex justify-content-between">
                    <div>
                        <button type="button" class="btn btn-danger btn-sm" id="btnExcluirLocacao">
                            <i class="fas fa-trash"></i> Excluir
                        </button>
                    </div>
                    <div>
                        <button type="button" class="btn btn-danger btn-sm" data-bs-dismiss="modal">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button type="button" class="btn btn-success btn-sm" id="btnSalvarEdt">
                            <i class="fas fa-save"></i> Salvar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>    

    <!-- Modal Visualiza Locação -->
    <div class="modal fade" id="modalVisualizaLocacao" data-bs-backdrop="static" tabindex="-1" aria-labelledby="modalVisualizaLocacaoLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="modalVisualizaLocacaoLabel">Detalhes da Locação</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="formVisualizaLocacao" class="row g-3">
                        <div class="col-md-6">
                            <label for="empenholocVis" class="form-label small">Empenho</label>
                            <input type="text" class="form-control form-control-sm" id="empenholocVis" readonly>
                        </div>
                        <div class="col-md-6">
                            <label for="setorSolicitanteVis" class="form-label small">Setor Solicitante</label>
                            <input type="text" class="form-control form-control-sm" id="setorSolicitanteVis" readonly>
                        </div>
                        <div class="col-md-12">
                            <label for="objetivoVis" class="form-label small">Objetivo</label>
                            <input type="text" class="form-control form-control-sm" id="objetivoVis" readonly>
                        </div>                        
                        <div class="col-md-4">
                            <label for="numSeiVis" class="form-label small">Número SEI</label>
                            <input type="text" class="form-control form-control-sm" id="numSeiVis" readonly>
                        </div>
                        <div class="col-md-8">
                            <label for="motoristaVis" class="form-label small">Motorista</label>
                            <input type="text" class="form-control form-control-sm" id="motoristaVis" readonly>                          
                        </div>
                        <div class="col-md-4">
                            <label for="veiculoVis" class="form-label small">Veículo</label>
                            <input type="text" class="form-control form-control-sm" id="veiculoVis" readonly>
                        </div>
                        <div class="col-md-4">
                            <label for="veiculoModeloVis" class="form-label small">Modelo Veículo</label>
                            <input type="text" class="form-control form-control-sm" id="veiculoModeloVis" readonly>                   
                        </div>
                        <div class="col-md-4">
                            <label for="combustivelVis" class="form-label small">Combustível</label>
                            <input type="text" class="form-control form-control-sm" id="combustivelVis" readonly>
                        </div>
                        <div class="col-md-3">
                            <label for="dataInicioVis" class="form-label small">Data Início</label>
                            <input type="date" class="form-control form-control-sm" id="dataInicioVis" readonly>
                        </div>
                        <div class="col-md-3">
                            <label for="horaInicioVis" class="form-label small">Hora Início</label>
                            <input type="time" class="form-control form-control-sm" id="horaInicioVis" readonly>
                        </div>                        
                        <div class="col-md-3">
                            <label for="dataFimVis" class="form-label small">Data Fim</label>
                            <input type="date" class="form-control form-control-sm" id="dataFimVis" readonly>
                        </div>
                        <div class="col-md-3">
                            <label for="horaFimVis" class="form-label small">Hora Dev.</label>
                            <input type="time" class="form-control form-control-sm" id="horaFimVis" readonly>
                        </div>                        
                        <div class="col-md-2">
                            <label for="qtdDiariasVis" class="form-label small">Qtd. Diárias</label>
                            <input type="number" class="form-control form-control-sm" id="qtdDiariasVis" readonly>
                        </div>
                        <div class="col-md-2">
                            <label for="valorDiariaVis" class="form-label small">Valor Diária</label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">R$</span>
                                <input type="text" class="form-control form-control-sm" id="valorDiariaVis" readonly>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <label for="valorDifVis" class="form-label small">Valor Dif.</label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">R$</span>
                                <input type="text" class="form-control form-control-sm" id="valorDifVis" readonly>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label for="valorTotalVis" class="form-label small">Valor Total</label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">R$</span>
                                <input type="text" class="form-control form-control-sm" id="valorTotalVis" readonly>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label for="kmVis" class="form-label small">Km Rodado</label>
                            <input type="number" class="form-control form-control-sm" id="kmVis" readonly>
                        </div>
                        <div class="col-md-12">
                            <label for="observacoesVis" class="form-label small">Observações da Locação</label>
                            <textarea class="form-control form-control-sm" id="observacoesVis" rows="2" readonly></textarea>
                        </div>
                        <div class="col-md-12">
                            <label for="observacoesDevVis" class="form-label small">Observações da Devolução</label>
                            <textarea class="form-control form-control-sm" id="observacoesDevVis" rows="2" readonly></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger btn-sm" data-bs-dismiss="modal">
                        <i class="fas fa-times-circle"></i> Fechar
                    </button>
                </div>
            </div>
        </div>
    </div>       

    <!-- Modal Buscar Motorista -->
    <div class="modal fade" id="modalBuscarMotorista" data-bs-backdrop="static" tabindex="-1" aria-labelledby="modalBuscarMotoristaLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalBuscarMotoristaLabel">Buscar Motorista</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-3">
                    <div class="row mb-3">
                        <div class="col-md-10">
                            <input type="text" class="form-control form-control-sm" id="pesquisaMotorista" placeholder="Pesquise por matrícula, nome ou setor...">
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-primary btn-sm w-100 d-flex align-items-center justify-content-center" id="btnPesquisarMotorista" style="height: 31px;">
                                <i class="fas fa-search me-1"></i> Pesquisar
                            </button>
                        </div>
                    </div>
                    <div class="table-container" style="max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 4px;">
                        <table class="table table-sm table-striped table-hover mb-0">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th style="position: sticky; top: 0; background-color: #f8f9fa; z-index: 1;">Matrícula</th>
                                    <th style="position: sticky; top: 0; background-color: #f8f9fa; z-index: 1;">Nome</th>
                                    <th style="position: sticky; top: 0; background-color: #f8f9fa; z-index: 1;">Setor</th>
                                    <th style="position: sticky; top: 0; background-color: #f8f9fa; z-index: 1; text-align: center;">Ação</th>
                                </tr>
                            </thead>
                            <tbody id="resultadoPesquisaMotorista">
                                <!-- Resultados serão carregados aqui -->
                            </tbody>
                        </table>
                    </div>
                    <div id="semResultados" class="text-center py-2 d-none">
                        <p class="text-muted mb-0">Nenhum motorista encontrado</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Fechar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal CNH Não Encontrada -->
    <div class="modal fade" id="modalCnhNaoEncontrada" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title">Atenção</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>CNH do motorista não encontrada no sistema.</p>
                    <p>Por favor, anexe o arquivo da CNH para prosseguir.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Relatório Analítico -->
    <div id="modalRelatorioAnalitico" class="modal-cnh">
        <div class="modal-cnh-content" style="max-width: 95%; width: 1200px;">
            <div class="modal-cnh-header">
                <h5>Relatório Analítico de Locações</h5>
                <button class="modal-cnh-close" onclick="fecharModalRelatorio()">&times;</button>
            </div>
            <div class="modal-cnh-body">
                <iframe id="iframeRelatorio" style="width: 100%; height: 600px; border: none;"></iframe>
            </div>
        </div>
    </div>

    
    <!-- Modal de Sucesso -->
    <div class="modal fade" id="modalSucesso" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">Sucesso</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="mensagemSucesso">
                    <!-- Mensagem será inserida via JavaScript -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação de Exclusão -->
    <div class="modal fade" id="modalConfirmacaoExclusao" tabindex="-1" aria-labelledby="modalConfirmacaoExclusaoLabel" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="modalConfirmacaoExclusaoLabel">Confirmar Exclusão</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Tem certeza que deseja excluir esta locação?</p>
                    <p class="small text-danger"><strong>Atenção:</strong> Esta ação não poderá ser desfeita!</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger btn-sm" id="btnConfirmarExclusao">
                        <i class="fas fa-trash"></i> Excluir
                    </button>
                </div>
            </div>
        </div>
    </div>  
    
    <!-- ============== HTML DO MODAL DE CARREGAMENTO ============== -->
    <div class="modal fade" id="modalCarregando" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-hidden="true">
         <div class="modal-dialog modal-dialog-centered modal-sm">
             <div class="modal-content">
                 <div class="modal-body text-center p-4">
                     <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                         <span class="visually-hidden">Carregando...</span>
                     </div>
                     <h5>Carregando dados</h5>
                     <p class="mb-0">Por favor aguarde...</p>
                 </div>
             </div>
         </div>
     </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js"></script>
    <script>
        // Variáveis globais
        let processoIdSelecionado = null;
        let locacoesFinalizadasCompletas = []; // Para armazenar todas as locações finalizadas
        let motoristasLista = [];
        let veiculosLista = [];
        let empenhoLista = [];
        let arquivoCnh = null;
        let qtdDiariasEditadaManualmente = false;
        let valorDifEditadoManualmente = false;
        let idLocacaoAtual;
        
        const TOLERANCIA_HORAS = 2; // 2 horas de tolerância
        const FRACAO_HORA_EXTRA = 0.1; // 1/10 do valor da diária por hora extra

        // Função para formatar valores monetários para exibição
        function formatarValorMonetario(valor) {
            if (valor === null || valor === undefined) return '0,00';
            return parseFloat(valor).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }
        
        // Função para converter valor formatado para número
        function converterParaNumero(valor) {
            if (!valor) return 0;
            
            // Se já for um número, retornar ele mesmo
            if (typeof valor === 'number') return valor;
            
            // Se for string, remover formatação
            if (typeof valor === 'string') {
                return parseFloat(valor.replace(/\./g, '').replace(',', '.')) || 0;
            }
            
            return 0;
        }

        // Quando o campo recebe foco, ajusta a largura da lista de sugestões
        $("#veiculoModeloDev").on("focus", function() {
            const inputWidth = $(this).outerWidth();
            $("#sugestoesModeloVeiculo").css("width", inputWidth + "px");
        });        

        $("#veiculoModeloEdt").on("focus", function() {
            const inputWidth = $(this).outerWidth();
            $("#sugestoesModeloVeiculoEdt").css("width", inputWidth + "px");
        });        

        // Função para mostrar o modal de carregamento
        function mostrarModalCarregando() {
            const modalCarregando = new bootstrap.Modal(document.getElementById('modalCarregando'), {
                backdrop: 'static',
                keyboard: false
            });
            modalCarregando.show();
        }

        // Função para fechar o modal de carregamento
        function fecharModalCarregando() {
            const modalCarregandoEl = document.getElementById('modalCarregando');
            const modalCarregando = bootstrap.Modal.getInstance(modalCarregandoEl);
            if (modalCarregando) {
                modalCarregando.hide();
            }
        }

        // Função para abrir o modal de edição (assumindo que você já tem algo semelhante)
        //function abrirModalEditar(idLocacao) {
        //    idLocacaoAtual = idLocacao;
            
            // Aqui você carregaria os dados da locação para o modal de edição
            // ...

            // Abre o modal de edição
        //    $('#modalEditarLocacao').modal('show');
        //}

        // Carregar lista de processos ao iniciar a página
        $(document).ready(function() {

            // Configuração dos splitters
            function setupSplitters() {
                // Configurar o primeiro splitter (entre grupos superiores e Locações em Trânsito)
                let isDragging1 = false;
                let startY1 = 0;
                let startHeight1 = 0;
                
                $('#splitter1').on('mousedown', function(e) {
                    e.preventDefault();
                    isDragging1 = true;
                    startY1 = e.pageY;
                    
                    // Alturas dos grupos superiores
                    const processosGroupbox = $('.groupbox').eq(0);
                    const empenhosGroupbox = $('.groupbox').eq(1);
                    startHeight1 = {
                        processos: processosGroupbox.find('.groupbox-body').height(),
                        empenhos: empenhosGroupbox.find('.tabs-body').height()
                    };
                    
                    $(document).on('mousemove', function(e) {
                        if (!isDragging1) return;
                        
                        const deltaY = e.pageY - startY1;
                        
                        // Aplicar nova altura aos groupbox superiores
                        processosGroupbox.find('.groupbox-body').height(Math.max(100, startHeight1.processos + deltaY));
                        empenhosGroupbox.find('.tabs-body').height(Math.max(100, startHeight1.empenhos + deltaY));
                    });
                    
                    $(document).on('mouseup', function() {
                        isDragging1 = false;
                        $(document).off('mousemove');
                        $(document).off('mouseup');
                    });
                });
                
                // Configurar o segundo splitter (entre Locações em Trânsito e Locações Finalizadas)
                let isDragging2 = false;
                let startY2 = 0;
                let startHeight2 = 0;
                let startHeightFinalizadas = 0;
                
                $('#splitter2').on('mousedown', function(e) {
                    e.preventDefault();
                    isDragging2 = true;
                    startY2 = e.pageY;
                    
                    // Altura dos grupos relevantes
                    const transitoGroupbox = $('.groupbox').eq(2);
                    const finalizadasGroupbox = $('.groupbox').eq(3);
                    
                    startHeight2 = transitoGroupbox.find('.groupbox-body').height();
                    startHeightFinalizadas = finalizadasGroupbox.find('.groupbox-body').height();
                    
                    $(document).on('mousemove', function(e) {
                        if (!isDragging2) return;
                        
                        const deltaY = e.pageY - startY2;
                        
                        // Permitir redução significativa - mínimo de apenas 50px
                        const novaAlturaTransito = Math.max(50, startHeight2 + deltaY);
                        
                        // Aplicar nova altura ao groupbox de Locações em Trânsito
                        transitoGroupbox.find('.groupbox-body').height(novaAlturaTransito);
                        
                        // Opcionalmente, ajustar o grupo de Locações Finalizadas para compensar
                        // Isso criará um efeito de "push" em vez de apenas redimensionar um grupo
                        finalizadasGroupbox.find('.groupbox-body').height(startHeightFinalizadas - deltaY);
                    });
                    
                    $(document).on('mouseup', function() {
                        isDragging2 = false;
                        $(document).off('mousemove');
                        $(document).off('mouseup');
                    });
                });
                
                // Definir alturas iniciais adequadas para os grupos
                setTimeout(function() {
                    const alturaTransito = 200; // Altura inicial para Locações em Trânsito
                    const alturaFinalizadas = 300; // Altura inicial para Locações Finalizadas
                    
                    $('.groupbox').eq(2).find('.groupbox-body').height(alturaTransito);
                    $('.groupbox').eq(3).find('.groupbox-body').height(alturaFinalizadas);
                }, 100);
            }

            // Chamar a configuração dos splitters quando a página estiver pronta
            setupSplitters();

            // Garantir que os splitters se ajustem quando a janela for redimensionada
            $(window).on('resize', function() {
                // Recalcular dimensões se necessário
            });

  	        // Converter para maiúsculo os campos com classe uppercase
            $('.uppercase').on('input', function() {
                $(this).val($(this).val().toUpperCase());
            });

            carregarProcessos();
                    
            // Atualizar valor da diária quando selecionar veículo
            $('#veiculo').change(function() {
                const veiculoId = $(this).val();
                const veiculoSelecionado = veiculosLista.find(v => v.ID_VEICULO_LOC == veiculoId);
                
                if (veiculoSelecionado) {
                    $('#valorDiaria').val(veiculoSelecionado.VL_DIARIA_KM.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
                    calcularDiariasEValores();
                } else {
                    $('#valorDiaria').val('');
                    $('#valorTotal').val('');
                }
            });
            
            // Recalcular diárias quando alterar datas
            $('#dataInicio, #dataFim').change(function() {
                calcularDiariasEValores();
            });
            
            // Contador de caracteres para observações
            $('#observacoes').on('input', function() {
                const caracteres = $(this).val().length;
                $('#charCount').text(caracteres);
            });
            
            $('#observacoesDev').on('input', function() {
                const caracteres = $(this).val().length;
                $('#charCountDev').text(caracteres);
            });

            $('#observacoesEdt').on('input', function() {
                const caracteres = $(this).val().length;
                $('#charCountEdt').text(caracteres);
            });

            // Máscara para o número SEI
            $('#numSei').on('input', function() {
                let value = $(this).val().replace(/\D/g, '');
                

                if (value.length > 13) {
                    value = `${value.substring(0, 7)}-${value.substring(7, 9)}.${value.substring(9, 13)}.${value.substring(13, 14)}.${value.substring(14, 16)}.${value.substring(16)}`;
                } else if (value.length > 9) {
                    value = `${value.substring(0, 7)}-${value.substring(7, 9)}.${value.substring(9)}`;
                } else if (value.length > 7) {
                    value = `${value.substring(0, 7)}-${value.substring(7)}`;
                }                
                
                $(this).val(value);
            });
            

            // Máscara para o número SEI
            $('#numSeiDev').on('input', function() {
                let value = $(this).val().replace(/\D/g, '');
                

                if (value.length > 13) {
                    value = `${value.substring(0, 7)}-${value.substring(7, 9)}.${value.substring(9, 13)}.${value.substring(13, 14)}.${value.substring(14, 16)}.${value.substring(16)}`;
                } else if (value.length > 9) {
                    value = `${value.substring(0, 7)}-${value.substring(7, 9)}.${value.substring(9)}`;
                } else if (value.length > 7) {
                    value = `${value.substring(0, 7)}-${value.substring(7)}`;
                }                
                
                $(this).val(value);
            });

            // Verificar CNH do motorista
            $('#motorista').change(function() {
                const motoristaId = $(this).val();
                if (!motoristaId) return;
                
                const motoristaSelecionado = motoristasLista.find(m => m.ID_MOTORISTA == motoristaId);
                
                if (motoristaSelecionado && !motoristaSelecionado.FILE_PDF) {
                    $('#arquivoCnhDiv').removeClass('d-none');
                    const modalCnhNaoEncontrada = new bootstrap.Modal(document.getElementById('modalCnhNaoEncontrada'));
                    modalCnhNaoEncontrada.show();
                } else {
                    $('#arquivoCnhDiv').addClass('d-none');
                }
            });
            
            // Capturar arquivo CNH quando selecionado
            $('#arquivoCnh').change(function(e) {
                arquivoCnh = e.target.files[0];
            });

            // Função para carregar locações em trânsito - Atualizada para recarregar após salvar
            function carregarLocacoesTransito(id_cl) {
                $.ajax({
                    url: `/api/locacoes_transito/${id_cl}`,
                    type: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        console.log("Locações em trânsito carregadas:", data);
                        let html = '';
                        if (data.length === 0) {
                            html = '<tr><td colspan="10" class="text-center">Nenhuma locação em trânsito encontrada</td></tr>';
                        } else {
                            data.forEach(function(item) {
                                html += `<tr>
                                    <td>${item.ID_ITEM}</td>
                                    <td>${item.MES_ANO}</td>
                                    <td>${item.DE_VEICULO}</td>
                                    <td>${item.DS_VEICULO_MOD}</td>
                                    <td>${formatarDataString(item.DT_INICIAL)} ${item.HR_INICIAL}</td>
                                    <td>${formatarDataString(item.DT_FINAL)}</td>
                                    <td>${item.QT_DIARIA_KM}</td>
                                    <td>R$ ${formatarValor(item.VL_TOTALITEM)}</td>
                                    <td>${item.MOTORISTA}</td>
                                    <td class="sticky-column">
                                        <div class="d-flex justify-content-around">
                                            <a href="javascript:void(0)" class="btn btn-sm btn-primary" title="Abrir">
                                                <i class="fas fa-folder-open"></i>
                                            </a>
                                            <a href="javascript:void(0)" class="btn btn-sm btn-danger ms-1" title="Devolução">
                                                <i class="fa-solid fa-car"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>`;
                            });
                        }
                        $('#tabela-transito').html(html);
                    },
                    error: function(xhr, status, error) {
                        console.error("Erro ao carregar locações em trânsito:", error);
                        console.error("Status:", xhr.status);
                        console.error("Resposta:", xhr.responseText);
                        $('#tabela-transito').html('<tr><td colspan="10" class="text-center text-danger">Erro ao carregar dados</td></tr>');
                    }
                });

                // Carregar empenhos
                $.ajax({
                    url: `/api/empenhos/${id_cl}`,
                    type: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        console.log("Empenhos carregados:", data);
                        let html = '';
                        if (data.length === 0) {
                            html = '<tr><td colspan="6" class="text-center">Nenhum empenho encontrado</td></tr>';
                        } else {
                            data.forEach(function(item) {
                                html += `<tr>
                                    <td>${item.NU_EMPENHO}</td>
                                    <td>R$ ${formatarValor(item.VL_EMPENHO)}</td>
                                    <td>R$ ${formatarValor(item.VL_LIQUIDADO)}</td>
                                    <td>R$ ${formatarValor(item.VL_SALDO)}</td>
                                    <td>R$ ${formatarValor(item.VL_ALIQUIDAR)}</td>
                                    <td>R$ ${formatarValor(item.VL_SALDO_DISPONIVEL)}</td>
                                </tr>`;
                            });
                        }
                        $('#tabela-empenhos').html(html);
                    },
                    error: function(xhr, status, error) {
                        console.error("Erro ao carregar empenhos:", error);
                        $('#tabela-empenhos').html('<tr><td colspan="6" class="text-center text-danger">Erro ao carregar dados</td></tr>');              
                    }
                });
                
                // Carregar saldo de diárias
                $.ajax({
                    url: `/api/saldo_diarias/${id_cl}`,
                    type: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        console.log("Saldo de diárias carregado:", data);
                        let html = '';
                        if (data.length === 0) {
                            html = '<tr><td colspan="8" class="text-center">Nenhum registro encontrado</td></tr>';
                        } else {
                            data.forEach(function(item) {
                                html += `<tr>
                                    <td>${item.DE_VEICULO}</td>
                                    <td>R$ ${formatarValor(item.VL_DIARIA_KM)}</td>
                                    <td>${item.QT_DK}</td>
                                    <td>${item.QT_UTILIZADO}</td>
                                    <td>${item.QT_SALDO}</td>
                                    <td>R$ ${formatarValor(item.VALOR_TOTAL)}</td>
                                    <td>R$ ${formatarValor(item.VL_UTILIZADO)}</td>
                                    <td>R$ ${formatarValor(item.VL_SALDO)}</td>
                                </tr>`;
                            });
                        }
                        $('#tabela-saldo-diarias').html(html);
                    },
                    error: function(xhr, status, error) {
                        console.error("Erro ao carregar saldo de diárias:", error);
                        $('#tabela-saldo-diarias').html('<tr><td colspan="8" class="text-center text-danger">Erro ao carregar dados</td></tr>');
                    }
                });

                // Carregar sintético mensal
                $.ajax({
                    url: `/api/sintetico_mensal/${id_cl}`,
                    type: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        console.log("Sintético mensal carregado:", data);
                        let html = '';
                        if (data.length === 0) {
                            html = '<tr><td colspan="4" class="text-center">Nenhum registro encontrado</td></tr>';
                        } else {
                            data.forEach(function(item) {
                                html += `<tr>
                                    <td>${item.MESANO}</td>
                                    <td>R$ ${formatarValor(item.SUBTOTAL)}</td>
                                    <td>R$ ${formatarValor(item.HORA_EXTRA)}</td>
                                    <td>R$ ${formatarValor(item.TOTAL)}</td>
                                </tr>`;
                            });
                        }
                        $('#tabela-sintetico-mensal').html(html);
                    },
                    error: function(xhr, status, error) {
                        console.error("Erro ao carregar sintético mensal:", error);
                        $('#tabela-sintetico-mensal').html('<tr><td colspan="4" class="text-center text-danger">Erro ao carregar dados</td></tr>');
                    }
                });

                // Carregar dados do PLS
                $.ajax({
                    url: `/api/dados_pls/${id_cl}`,
                    type: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        console.log("Dados do PLS carregado:", data);
                        let html = '';
                        if (data.length === 0) {
                            html = '<tr><td colspan="8" class="text-center">Nenhum registro encontrado</td></tr>';
                        } else {
                            data.forEach(function(item) {
                                html += `<tr>
                                    <td>${item.MES_ANO}</td>
                                    <td>${item.QTD}</td>
                                    <td>${item.KM}</td>
                                    <td>R$ ${formatarValor(item.VLTOTAL)}</td>
                                    <td>${item.COMBUSTIVEL}</td>
                                </tr>`;
                            });
                        }
                        $('#tabela-dados-pls').html(html);
                    },
                    error: function(xhr, status, error) {
                        console.error("Erro ao carregar saldo de diárias:", error);
                        $('#tabela-dados-pls').html('<tr><td colspan="8" class="text-center text-danger">Erro ao carregar dados</td></tr>');
                    }
                });
            }

            
            // function carregarLocacoesFinalizadas(id_cl) {   
            //     $.ajax({
            //         url: `/api/locacoes_finalizadas/${id_cl}`,
            //         type: 'GET',
            //         dataType: 'json',
            //         success: function(data) {
            //             console.log("Locações finalizadas carregadas:", data);
            //             // Armazenar os dados completos para filtrar depois
            //             locacoesFinalizadasCompletas = data;
            //             let html = '';
            //             if (data.length === 0) {
            //                 html = '<tr><td colspan="10" class="text-center">Nenhuma locação finalizada encontrada</td></tr>';
            //             } else {
            //                 data.forEach(function(item) {
            //                     html += `<tr>
            //                         <td>${item.ID_ITEM}</td>
            //                         <td>${item.MES_ANO}</td>
            //                         <td>${item.DE_VEICULO}</td>
            //                         <td>${item.DS_VEICULO_MOD}</td>
            //                         <td>${formatarDataString(item.DT_INICIAL)}</td>
            //                         <td>${formatarDataString(item.DT_FINAL)}</td>
            //                         <td>${item.QT_DIARIA_KM}</td>
            //                         <td>R$ ${formatarValor(item.VL_TOTALITEM)}</td>
            //                         <td>${item.MOTORISTA}</td>
            //                         <td class="sticky-column">
            //                             <div class="d-flex justify-content-around">
            //                                 <a href="javascript:void(0)" class="acao-btn btn-abrir" title="Visualizar">
            //                                     <i class="fas fa-search"></i>
            //                                 </a>
            //                             </div>
            //                         </td>
            //                     </tr>`;
            //                 });
            //             }
            //             $('#tabela-finalizadas').html(html);                    
            //             // Exibir todos os dados inicialmente
            //             verificarCarregamentoCompleto();
            //         },
            //         error: function(xhr, status, error) {
            //             console.error("Erro ao carregar locações finalizadas:", error);
            //             console.error("Status:", xhr.status);
            //             console.error("Resposta:", xhr.responseText);
            //             $('#tabela-finalizadas').html('<tr><td colspan="10" class="text-center text-danger">Erro ao carregar dados</td></tr>');
            //             verificarCarregamentoCompleto();
            //         }
            //     });                 
            // }
            
            // Abrir modal de busca de motorista
            $('#btnBuscarMotorista').on('click', function(e) {
                e.preventDefault();
                $('#modalBuscarMotorista').modal({
                    backdrop: 'static',
                    keyboard: false
                });
                $('#modalBuscarMotorista').modal('show');
                $('#pesquisaMotorista').val('').focus();
                $('#resultadoPesquisaMotorista').empty();
                $('#semResultados').addClass('d-none');
            });

            // Função para pesquisar motoristas
            function pesquisarMotoristas(nome = '') {
                if (nome.trim() === '') {
                    $('#resultadoPesquisaMotorista').empty();
                    $('#semResultados').addClass('d-none');
                    return;
                }

                $.ajax({
                    url: '/api/busca_motorista',
                    type: 'GET',
                    data: { nome: nome },
                    success: function(response) {
                        $('#resultadoPesquisaMotorista').empty();
                        
                        if (response.length > 0) {
                            $('#semResultados').addClass('d-none');
                            
                            response.forEach(function(motorista) {
                                let linha = `
                                    <tr>
                                        <td>${motorista.matricula}</td>
                                        <td>${motorista.nm_motorista}</td>
                                        <td>${motorista.sigla_setor}</td>
                                        <td class="text-center">
                                            <button type="button" class="btn btn-sm btn-outline-success selecionar-motorista" 
                                                    data-id="${motorista.id_motorista}" 
                                                    data-nome="${motorista.nm_motorista}">
                                                <i class="fas fa-check"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `;
                                $('#resultadoPesquisaMotorista').append(linha);
                            });
                            
                            // Adicionar evento aos botões de seleção
                            $('.selecionar-motorista').on('click', function() {
                                let id = $(this).data('id');
                                let nome = $(this).data('nome');
                                
                                // Verificar se o motorista já existe no select
                                let existeOpcao = false;
                                $('#motorista option').each(function() {
                                    if ($(this).val() == id) {
                                        existeOpcao = true;
                                        return false;
                                    }
                                });
                                
                                // Se não existir, adiciona a opção
                                if (!existeOpcao) {
                                    $('#motorista').append(new Option(nome, id));
                                }
                                
                                // Seleciona o motorista
                                $('#motorista').val(id);
                                
                                // Fecha o modal
                                $('#modalBuscarMotorista').modal('hide');
                            });
                            
                        } else {
                            $('#semResultados').removeClass('d-none');
                        }
                    },
                    error: function(error) {
                        console.error('Erro ao buscar motoristas:', error);
                        alert('Erro ao buscar motoristas. Por favor, tente novamente.');
                    }
                });
            }

            // Evento de clique no botão de pesquisa
            $('#btnPesquisarMotorista').on('click', function() {
                let termoPesquisa = $('#pesquisaMotorista').val().trim();
                pesquisarMotoristas(termoPesquisa);
            });

            // Evento de tecla Enter no campo de pesquisa
            $('#pesquisaMotorista').on('keypress', function(e) {
                if (e.which === 13) {
                    e.preventDefault();
                    let termoPesquisa = $(this).val().trim();
                    pesquisarMotoristas(termoPesquisa);
                }
            });

            // Configurar modal para ser estático (não fechar quando clicar fora)
            $('#modalBuscarMotorista').modal({
                backdrop: 'static',
                keyboard: false
            });            
            
            
            // Salvar locação
            $('#btnSalvarLocacao').click(function() {
                // Validar formulário
                if (!validarFormulario()) {
                    return;
                }
                
                // Mostrar loader ou spinner
                $(this).prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Salvando...');
                
                // Verificar se precisa de arquivo CNH
                const motoristaId = $('#motorista').val();
                const motoristaSelecionado = motoristasLista.find(m => m.ID_MOTORISTA == motoristaId);
                
                if (!motoristaSelecionado.FILE_PDF && !$('#arquivoCnh')[0].files[0]) {
                    alert("É necessário anexar a CNH do motorista.");
                    $(this).prop('disabled', false).html('<i class="fas fa-save"></i> Salvar');
                    return;
                }
                
                // Preparar dados para envio
                const formData = new FormData();
                formData.append('id_cl', processoIdSelecionado);
                formData.append('empenho', $('#empenholoc').val());
                formData.append('setor_solicitante', $('#setorSolicitante').val());
                formData.append('objetivo', $('#objetivo').val());
                formData.append('id_veiculo_loc', $('#veiculo').val());
                formData.append('id_motorista', $('#motorista').val());
                formData.append('data_inicio', $('#dataInicio').val());
                formData.append('data_fim', $('#dataFim').val());
                formData.append('hora_inicio', $('#horaInicio').val());
                formData.append('qt_diaria_km', $('#qtdDiarias').val());
                
                
                // Corrigir formatação dos valores decimais
                const valorDiaria = $('#valorDiaria').val().replace(/\./g, '').replace(',', '.');
                const valorTotal = $('#valorTotal').val().replace(/\./g, '').replace(',', '.');
                
                formData.append('vl_dk', valorDiaria);
                formData.append('vl_totalitem', valorTotal);
                formData.append('nu_sei', $('#numSei').val());
                formData.append('obs', $('#observacoes').val());
                
                // Anexar arquivo da CNH se necessário
                if (!motoristaSelecionado.FILE_PDF && $('#arquivoCnh')[0].files[0]) {
                    // Importante: corrigir o nome do campo para 'file_cnh' conforme esperado pelo backend
                    formData.append('file_cnh', $('#arquivoCnh')[0].files[0]);
                }
                
                // Log para verificar os dados enviados
                console.log("Enviando dados para API:", processoIdSelecionado);
                
                // Enviar dados para API
                $.ajax({
                    url: '/api/nova_locacao',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        console.log("Resposta:", response);
                        
                        // Mostrar mensagem de sucesso
                        let mensagem = "Locação registrada com sucesso!";
                        if (response.email_enviado) {
                            mensagem += " E-mail enviado com sucesso.";
                        } else if (response.erro_email) {
                            mensagem += " A locação foi registrada, mas ocorreu um erro ao enviar o e-mail: " + response.erro_email;
                        }
                        
                        $('#mensagemSucesso').text(mensagem);
                        
                        // Fechar modal de locação
                        $('#modalNovaLocacao').modal('hide');
                        
                        // Mostrar modal de sucesso
                        const modalSucesso = new bootstrap.Modal(document.getElementById('modalSucesso'));
                        modalSucesso.show();
                        
                        // Reativar o footer quando o modal fechar
                        $('.footer').removeClass('d-none');
                        
                        // Recarregar locações em trânsito se a função existir
                        if (typeof carregarLocacoesTransito === 'function') {
                            carregarLocacoesTransito(processoIdSelecionado);
                        }
                        
                        // Reset botão salvar
                        $('#btnSalvarLocacao').prop('disabled', false).html('<i class="fas fa-save"></i> Salvar');
                    },
                    error: function(xhr, status, error) {
                        console.error("Erro ao salvar locação:", error);
                        console.error("Resposta:", xhr.responseText);
                        
                        let mensagemErro = "Erro ao salvar locação";
                        if (xhr.responseJSON && xhr.responseJSON.mensagem) {
                            mensagemErro += ": " + xhr.responseJSON.mensagem;
                        } else if (xhr.statusText) {
                            mensagemErro += ": " + xhr.statusText;
                        } else {
                            mensagemErro += ": " + error;
                        }
                        
                        alert(mensagemErro);
                        
                        // Reset botão salvar
                        $('#btnSalvarLocacao').prop('disabled', false).html('<i class="fas fa-save"></i> Salvar');
                    }
                });
            });

            // Fechar modal event
            $('#modalNovaLocacao').on('hidden.bs.modal', function () {
                // Reativar o footer quando o modal fechar
                $('.footer').removeClass('d-none');
            });          
            
            // Ação do botão Nova Locação
            $('#btnNovaLocacao').click(function() {
                console.log("=== BOTÃO NOVA LOCAÇÃO CLICADO ===");
                console.log("Processo selecionado:", processoIdSelecionado);

                if (!processoIdSelecionado) {
                    alert("Por favor, selecione um processo de locação primeiro.");
                    return;
                }
                
                // Mostrar modal de carregamento
                mostrarModalCarregando();

                // Esconder o footer quando o modal estiver aberto
                $('.footer').addClass('d-none');
                
                // Resetar o formulário
                $('#formNovaLocacao')[0].reset();
                $('#arquivoCnhDiv').addClass('d-none');
                arquivoCnh = null;
            
                
                const hoje = new Date();
                const amanha = new Date(hoje);
                amanha.setDate(hoje.getDate() + 1);
                const dataFormatada = amanha.toISOString().split('T')[0];
                $('#dataInicio').val(dataFormatada);
                $('#dataFim').val(dataFormatada);
                $('#horaInicio').val('07:00');

                // Contador para controlar carregamentos pendentes
                let carregamentosPendentes = 5; // Quantidade de carregamentos assíncronos

                function verificarCarregamentoCompleto() {
                    carregamentosPendentes--;
                    console.log(">>> Carregamentos pendentes:", carregamentosPendentes);
                    if (carregamentosPendentes <= 0) {
                        // Todos os dados foram carregados
                        fecharModalCarregando();
                        
                        // Calcular diárias inicialmente (como as datas são iguais, será 1)
                        calcularDiariasEValores();
                        
                        // Abrir o modal principal apenas após todos os dados estarem carregados
                        const modalNovaLocacao = new bootstrap.Modal(document.getElementById('modalNovaLocacao'));
                        modalNovaLocacao.show();
                    }
                }

                // Carregar empenhos com callback
                $.ajax({
                    url: `/api/empenhos_loc?id_cl=${processoIdSelecionado}`,
                    type: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        empenhoLista = data;
                        let html = '<option value="">Selecione...</option>';
                        data.forEach(function(item) {
                            html += `<option value="${item.ID_EMPENHO}">${item.NU_EMPENHO}</option>`;
                        });
                        $('#empenholoc').html(html);
                        verificarCarregamentoCompleto();
                    },
                    error: function(xhr, status, error) {
                        console.error("Erro ao carregar empenhos:", error);
                        alert("Erro ao carregar lista de empenhos.");
                        verificarCarregamentoCompleto();
                    }
                });
                

                // Carregar empenhos com callback
                $.ajax({
                    url: `/api/empenhos_loc?id_cl=${processoIdSelecionado}`,
                    type: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        empenhoLista = data;
                        let html = '<option value="">Selecione...</option>';
                        data.forEach(function(item) {
                            html += `<option value="${item.ID_EMPENHO}">${item.NU_EMPENHO}</option>`;
                        });
                        $('#empenholoc').html(html);
                        verificarCarregamentoCompleto();
                    },
                    error: function(xhr, status, error) {
                        console.error("Erro ao carregar empenhos:", error);
                        alert("Erro ao carregar lista de empenhos.");
                        verificarCarregamentoCompleto();
                    }
                });

                // Carregar setores com callback
                $.ajax({
                    url: '/api/setores_loc',
                    type: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        let html = '<option value="">Selecione...</option>';
                        data.forEach(function(item) {
                            html += `<option value="${item.SIGLA_SETOR}">${item.SIGLA_SETOR}</option>`;
                        });
                        $('#setorSolicitante').html(html);
                        verificarCarregamentoCompleto();
                    },
                    error: function(xhr, status, error) {
                        console.error("Erro ao carregar setores:", error);
                        alert("Erro ao carregar lista de setores.");
                        verificarCarregamentoCompleto();
                    }
                });
                
                // Carregar motoristas com callback
                $.ajax({
                    url: '/api/lista_motorista_loc',
                    type: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        motoristasLista = data;
                        let html = '<option value="">Selecione...</option>';
                        data.forEach(function(item) {
                            html += `<option value="${item.ID_MOTORISTA}">${item.NM_MOTORISTA}</option>`;
                        });
                        $('#motorista').html(html);
                        verificarCarregamentoCompleto();
                    },
                    error: function(xhr, status, error) {
                        console.error("Erro ao carregar motoristas:", error);
                        alert("Erro ao carregar lista de motoristas.");
                        verificarCarregamentoCompleto();
                    }
                });
                
                // Carregar veículos com callback
                $.ajax({
                    url: `/api/lista_veiculo?id_cl=${processoIdSelecionado}`,
                    type: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        veiculosLista = data;
                        let html = '<option value="">Selecione...</option>';
                        data.forEach(function(item) {
                            html += `<option value="${item.ID_VEICULO_LOC}" data-valor="${item.VL_DIARIA_KM}">${item.DE_VEICULO}</option>`;
                        });
                        $('#veiculo').html(html);
                        verificarCarregamentoCompleto();
                    },
                    error: function(xhr, status, error) {
                        console.error("Erro ao carregar veículos:", error);
                        alert("Erro ao carregar lista de veículos.");
                        verificarCarregamentoCompleto();
                    }
                });

            });
                
            // Evento de mudança no filtro de mês/ano
            $('#filtroMesAno').change(function() {
                aplicarFiltroMesAno();
            });

            // $('#btnRelatorioAnalitico').click(function() {
            //     if (processoIdSelecionado) {
            //         window.location.href = `/rel_locacao_analitico?id_cl=${processoIdSelecionado}`;
            //     } else {
            //         alert("Por favor, selecione um processo de locação primeiro.");
            //     }
            // });

            $('#btnRelatorioAnalitico').click(function() {
                if (processoIdSelecionado) {
                    abrirModalRelatorio(processoIdSelecionado);
                } else {
                    alert("Por favor, selecione um processo de locação primeiro.");
                }
            });            
            
            const selectCombustivel = document.getElementById('combustivelDev');

            function buscarCombustivel(modelo) {
                // Faz uma requisição fetch para a API
                $.ajax({
                    url: '/api/busca_combustivel',
                    type: 'GET',
                    data: { termo: modelo },
                    dataType: 'json',
                    success: function(data) {
                        // Verifica se retornou algum combustível
                        if (data && data.length > 0) {
                            // Pega o primeiro combustível da lista
                            const combustivel = data[0];
                            
                            // Verifica se o combustível existe nas opções do select
                            const opcoesExistentes = Array.from(selectCombustivel.options).map(opt => opt.value);
                            
                            if (opcoesExistentes.includes(combustivel)) {
                                // Seleciona o combustível no dropdown
                                $(selectCombustivel).val(combustivel);
                            } else {
                                console.warn('Combustível retornado não está nas opções do select:', combustivel);
                                $(selectCombustivel).val('');
                            }
                        } else {
                            // Sem resultados, reseta o select
                            $(selectCombustivel).val('');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Erro ao buscar combustível:', error);
                        $(selectCombustivel).val('');
                    }
                });
            }

            // Busca de modelos de veículos - Devolução
            $('#veiculoModeloDev').on('input', function() {
                const termo = $(this).val().trim();
                if (termo.length >= 3) {
                    $.ajax({
                        url: `/api/busca_modelos_veiculos?termo=${encodeURIComponent(termo)}`,
                        type: 'GET',
                        dataType: 'json',
                        success: function(data) {
                            let html = '';
                            if (data.length > 0) {
                                data.forEach(function(modelo) {
                                    html += `<div class="p-2 border-bottom modelo-sugestao" style="cursor: pointer;">${modelo}</div>`;
                                });
                                $('#sugestoesModeloVeiculo').html(html).show();
                                
                                // Adicionar evento de clique às sugestões
                                $('.modelo-sugestao').click(function() {
                                    const modeloSelecionado = $(this).text();
                                    $('#veiculoModeloDev').val(modeloSelecionado);
                                    $('#sugestoesModeloVeiculo').hide();
                                    
                                    // Chamar a função buscarCombustivel para atualizar o select
                                    buscarCombustivel(modeloSelecionado);

                                });
                            } else {
                                $('#sugestoesModeloVeiculo').hide();
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error("Erro ao buscar modelos de veículos:", error);
                            $('#sugestoesModeloVeiculo').hide();
                        }
                    });
                } else {
                    $('#sugestoesModeloVeiculo').hide();
                }
            });

            // Fechar sugestões ao clicar fora
            $(document).click(function(e) {
                if (!$(e.target).closest('#veiculoModeloDev, #sugestoesModeloVeiculo').length) {
                    $('#sugestoesModeloVeiculo').hide();
                }
            });
            
            // Contador de caracteres para observações
            $('#observacoesDev').on('input', function() {
                const caracteres = $(this).val().length;
                $('#charCountDev').text(caracteres);
            });

            ////

            // Busca de modelos de veículos - Edição
            $('#veiculoModeloEdt').on('input', function() {
                const termo = $(this).val().trim();
                if (termo.length >= 3) {
                    $.ajax({
                        url: `/api/busca_modelos_veiculos?termo=${encodeURIComponent(termo)}`,
                        type: 'GET',
                        dataType: 'json',
                        success: function(data) {
                            let html = '';
                            if (data.length > 0) {
                                data.forEach(function(modelo) {
                                    html += `<div class="p-2 border-bottom modelo-sugestao" style="cursor: pointer;">${modelo}</div>`;
                                });
                                $('#sugestoesModeloVeiculoEdt').html(html).show();
                                
                                // Adicionar evento de clique às sugestões
                                $('.modelo-sugestao').click(function() {
                                    const modeloSelecionado = $(this).text();
                                    $('#veiculoModeloEdt').val(modeloSelecionado);
                                    $('#sugestoesModeloVeiculoEdt').hide();
                                    
                                    // Chamar a função buscarCombustivel para atualizar o select
                                    buscarCombustivel(modeloSelecionado);

                                });
                            } else {
                                $('#sugestoesModeloVeiculoEdt').hide();
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error("Erro ao buscar modelos de veículos:", error);
                            $('#sugestoesModeloVeiculoEdt').hide();
                        }
                    });
                } else {
                    $('#sugestoesModeloVeiculoEdt').hide();
                }
            });

            // Fechar sugestões ao clicar fora
            $(document).click(function(e) {
                if (!$(e.target).closest('#veiculoModeloDev, #sugestoesModeloVeiculoEdt').length) {
                    $('#sugestoesModeloVeiculoEdt').hide();
                }
            });
            
            ///

            // Botão de devolução na tabela de locações em trânsito
            $(document).on('click', '#tabela-transito .btn-danger', function() {
                const tr = $(this).closest('tr');
                const idItem = tr.find('td:first').text();
                const self = this;

                // Resetar o formulário completamente antes de abrir
                $('#formDevolucaoLocacao')[0].reset();
                
                // Limpar explicitamente o campo de hora fim e restaurar o botão de salvar
                $('#horaFimDev').val('');
                $('#btnSalvarDevolucao').prop('disabled', false).html('<i class="fas fa-save"></i> Salvar Devolução');

                // Mostrar modal de carregamento
                mostrarModalCarregando();
                                
                // Mostrar um indicador de carregamento
                $(self).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>');

                // Primeiro, carregar os dados da locação
                $.ajax({
                    url: `/api/locacao_item/${idItem}`,
                    type: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        console.log("Dados da locação carregados:", data);
                        
                        // Guardar os dados para uso posterior
                        const itemData = data;
                        
                        // Configurar campos ocultos
                        if (!$('#idItemDev').length) {
                            $('#formDevolucaoLocacao').append('<input type="hidden" id="idItemDev">');
                        }
                        if (!$('#valorSubTotalDev').length) {
                            $('#formDevolucaoLocacao').append('<input type="hidden" id="valorSubTotalDev">');
                        }
                        
                        // Preencher os campos de texto imediatamente
                        $('#idItemDev').val(idItem);
                        //$('#veiculoModeloDev').val(tr.find('td:eq(3)').text());
                        $('#objetivoDev').val(data.objetivo);
                        $('#numSeiDev').val(data.nu_sei);
                        //$('#veiculoModeloDev').val(data.veículo_modelo);
                        $('#veiculoModeloDev').val(data.veículo_modelo || tr.find('td:eq(3)').text());
                        $('#combustivelDev').val(data.combustivel);
                        $('#dataInicioDev').val(formatarDataParaInput(data.dt_inicio));
                        $('#horaInicioDev').val(data.hora_inicio ? data.hora_inicio.substring(0, 5) : '');
                        $('#dataFimDev').val(formatarDataParaInput(data.dt_fim || new Date().toISOString().split('T')[0]));
                        $('#horaFimDev').val('');
                        $('#valorDiariaDev').val(formatarValorMonetario(data.valor_diaria || 0));
                        $('#qtdDiariasDev').val(data.qt_diarias || 0);
                        $('#valorDifDev').val(formatarValorMonetario(data.valor_diferenca || 0));
                        $('#valorSubTotalDev').val(data.valor_subtotal || 0);
                        $('#valorTotalDev').val(formatarValorMonetario(data.valor_total || 0));
                        $('#observacoesDev').val('');
                        
                        // Contador para carregamentos pendentes
                        let carregamentosPendentes = 5; // Número de carregamentos assíncronos
                        
                        function verificarCarregamentoCompleto() {
                            carregamentosPendentes--;
                            console.log("Carregamentos pendentes:", carregamentosPendentes);
                            if (carregamentosPendentes <= 0) {
                                // Todos os dados foram carregados
                                fecharModalCarregando();
                                
                                // Restaurar o botão
                                $(self).html('<i class="fas fa-arrow-right-to-bracket"></i>');

                                // Garantir que o botão de salvar está no estado correto
                                $('#btnSalvarDevolucao').prop('disabled', false).html('<i class="fas fa-save"></i> Salvar Devolução');
                                
                                // Definir valores após carregamento
                                $('#empenholocDev').val(itemData.id_empenho);
                                $('#setorSolicitanteDev').val(itemData.setor_solicitante);
                                $('#motoristaDev').val(itemData.id_motorista);
                                $('#veiculoDev').val(itemData.id_veiculo_loc);
                                
                                // Calcular diárias
                                calcularDiariasEValoresDev();
                                
                                // Abrir o modal
                                const modalDevolucaoLocacao = new bootstrap.Modal(document.getElementById('modalDevolucaoLocacao'));
                                modalDevolucaoLocacao.show();
                            }
                        }
                        
                        // Carregar empenhos
                        $.ajax({
                            url: `/api/empenhos_loc?id_cl=${processoIdSelecionado}`,
                            type: 'GET',
                            dataType: 'json',
                            success: function(data) {
                                empenhoLista = data;
                                let html = '<option value="">Selecione...</option>';
                                data.forEach(function(item) {
                                    html += `<option value="${item.ID_EMPENHO}">${item.NU_EMPENHO}</option>`;
                                });
                                $('#empenholocDev').html(html);
                                verificarCarregamentoCompleto();
                            },
                            error: function(xhr, status, error) {
                                console.error("Erro ao carregar empenhos:", error);
                                verificarCarregamentoCompleto();
                            }
                        });
                        
                        // Carregar setores
                        $.ajax({
                            url: '/api/setores_loc',
                            type: 'GET',
                            dataType: 'json',
                            success: function(data) {
                                let html = '<option value="">Selecione...</option>';
                                data.forEach(function(item) {
                                    html += `<option value="${item.SIGLA_SETOR}">${item.SIGLA_SETOR}</option>`;
                                });
                                $('#setorSolicitanteDev').html(html);
                                verificarCarregamentoCompleto();
                            },
                            error: function(xhr, status, error) {
                                console.error("Erro ao carregar setores:", error);
                                verificarCarregamentoCompleto();
                            }
                        });
                        
                        // Carregar processos
                        $.ajax({
                            url: '/api/processos_locacao',
                            type: 'GET',
                            dataType: 'json',
                            success: function(data) {
                                verificarCarregamentoCompleto();
                            },
                            error: function(xhr, status, error) {
                                console.error("Erro ao carregar processos:", error);
                                verificarCarregamentoCompleto();
                            }
                        });
                        
                        // Carregar motoristas
                        $.ajax({
                            url: '/api/lista_motorista_loc',
                            type: 'GET',
                            dataType: 'json',
                            success: function(data) {
                                motoristasLista = data;
                                let html = '<option value="">Selecione...</option>';
                                data.forEach(function(item) {
                                    html += `<option value="${item.ID_MOTORISTA}">${item.NM_MOTORISTA}</option>`;
                                });
                                $('#motoristaDev').html(html);
                                verificarCarregamentoCompleto();
                            },
                            error: function(xhr, status, error) {
                                console.error("Erro ao carregar motoristas:", error);
                                verificarCarregamentoCompleto();
                            }
                        });
                        
                        // Carregar veículos
                        $.ajax({
                            url: `/api/lista_veiculo?id_cl=${processoIdSelecionado}`,
                            type: 'GET',
                            dataType: 'json',
                            success: function(data) {
                                veiculosLista = data;
                                let html = '<option value="">Selecione...</option>';
                                data.forEach(function(item) {
                                    html += `<option value="${item.ID_VEICULO_LOC}" data-valor="${item.VL_DIARIA_KM}">${item.DE_VEICULO}</option>`;
                                });
                                $('#veiculoDev').html(html);
                                verificarCarregamentoCompleto();
                            },
                            error: function(xhr, status, error) {
                                console.error("Erro ao carregar veículos:", error);
                                verificarCarregamentoCompleto();
                            }
                        });
                    },
                    error: function(xhr, status, error) {
                        console.error("Erro ao carregar dados da locação:", error);
                        alert("Erro ao carregar dados da locação: " + (xhr.responseJSON?.erro || error));
                        $(self).html('<i class="fas fa-arrow-right-to-bracket"></i>');
                        fecharModalCarregando();
                    }
                });
            });

            // Evento para reiniciar o formulário quando o modal é fechado
            $('#modalDevolucaoLocacao').on('hidden.bs.modal', function () {
                // Resetar o formulário
                $('#formDevolucaoLocacao')[0].reset();
                
                // Garantir que o botão de salvar está no estado correto
                $('#btnSalvarDevolucao').prop('disabled', false).html('<i class="fas fa-save"></i> Salvar Devolução');
                
                // Limpar explicitamente o campo de hora fim
                $('#horaFimDev').val('');
            });

            
            // Recalcular diárias e valores ao alterar datas e horas
            $('#dataFimDev, #horaFimDev, #qtdDiariasDev, #valorDifDev').on('change input', function() {
                calcularDiariasEValoresDev();
            });

            // Resetar flags quando mudar data/hora
            $('#dataFimDev, #horaFimDev').on('change', function() {
                qtdDiariasEditadaManualmente = false;
                valorDifEditadoManualmente = false;
                calcularDiariasEValoresDev();
            });            

            // Marcadores para edição manual dos campos de diárias e diferença
            $('#qtdDiariasDev').on('input', function() {
                qtdDiariasEditadaManualmente = true;
                calcularDiariasEValoresDev();
            });
            
            $('#valorDifDev').on('input', function() {
                valorDifEditadoManualmente = true;
                calcularDiariasEValoresDev();
            });
            
            // Novo event listener para o campo Valor Diária
            $('#valorDiariaDev').on('input', function() {
                calcularDiariasEValoresDev();
            });
            
            // Formatação do campo Valor Diária ao perder foco
            $('#valorDiariaDev').on('blur', function() {
                const valor = converterParaNumero($(this).val());
                $(this).val(formatarValorMonetario(valor));
                calcularDiariasEValoresDev();
            });

            
            // Para o campo de valor diferença, formatar como valor monetário ao perder foco
            $('#valorDifDev').on('blur', function() {
                if (valorDifEditadoManualmente) {
                    const valor = converterParaNumero($(this).val());
                    $(this).val(formatarValorMonetario(valor));
                    calcularDiariasEValoresDev();
                }
            });
            
            // Para o campo de quantidade de diárias, garantir valor mínimo de 1 ao perder foco
            $('#qtdDiariasDev').on('blur', function() {
                if (qtdDiariasEditadaManualmente) {
                    const valor = parseFloat($(this).val()) || 0;
                    if (valor < 1) {
                        $(this).val(1);
                    }
                    calcularDiariasEValoresDev();
                }
            });
            
            // Botão salvar devolução
            $('#btnSalvarDevolucao').click(function() {
                // Validar formulário
                if (!validarFormularioDevolucao()) {
                    return;
                }
                
                // Mostrar loader
                $(this).prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Salvando...');
                
                const idItem = $('#idItemDev').val();
                const formData = new FormData();
                
                // Adicionar dados ao FormData
                formData.append('objetivo', $('#objetivoDev').val());
                formData.append('id_veiculo', $('#veiculoDev').val());
                formData.append('id_motorista', $('#motoristaDev').val());
                formData.append('setor_solicitante', $('#setorSolicitanteDev').val());
                formData.append('data_inicio', $('#dataInicioDev').val());
                formData.append('data_fim', $('#dataFimDev').val());
                formData.append('hora_inicio', $('#horaInicioDev').val());
                formData.append('hora_fim', $('#horaFimDev').val());
                formData.append('qt_diarias', $('#qtdDiariasDev').val());
                formData.append('km_rodado', $('#kmDev').val());
                formData.append('valor_diferenca', converterParaNumero($('#valorDifDev').val()));
                formData.append('valor_subtotal', $('#valorSubTotalDev').val());
                formData.append('valor_total', converterParaNumero($('#valorTotalDev').val()));
                formData.append('veiculo_modelo', $('#veiculoModeloDev').val());
                formData.append('combustivel', $('#combustivelDev').val());
                formData.append('obs_dev', $('#observacoesDev').val());

                $.ajax({
                    url: `/api/salvar_devolucao/${idItem}`,
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        console.log("Resposta:", response);
                        
                        // Mostrar mensagem de sucesso
                        $('#mensagemSucesso').text("Devolução registrada com sucesso!");
                        
                        // Fechar modal de devolução e garantir que o botão de salvar está no estado correto
                        $('#modalDevolucaoLocacao').modal('hide');
                        $('#btnSalvarDevolucao').prop('disabled', false).html('<i class="fas fa-save"></i> Salvar Devolução');
                        
                        // Mostrar modal de sucesso
                        const modalSucesso = new bootstrap.Modal(document.getElementById('modalSucesso'));
                        modalSucesso.show();
                        
                        // Recarregar locações em trânsito
                        if (processoIdSelecionado) {
                            carregarLocacoesTransito(processoIdSelecionado);
                            carregarLocacoesFinalizadas(processoIdSelecionado);
                        }
                        
                        // Reset botão salvar
                        //$('#btnSalvarDevolucao').prop('disabled', false).html('<i class="fas fa-save"></i> Salvar Devolução');
                    },
                    error: function(xhr, status, error) {
                        console.error("Erro ao salvar devolução:", error);
                        console.error("Resposta:", xhr.responseText);
                        
                        let mensagemErro = "Erro ao salvar devolução";
                        if (xhr.responseJSON && xhr.responseJSON.erro) {
                            mensagemErro += ": " + xhr.responseJSON.erro;
                        } else if (xhr.statusText) {
                            mensagemErro += ": " + xhr.statusText;
                        } else {
                            mensagemErro += ": " + error;
                        }
                        
                        alert(mensagemErro);
                        
                        // Reset botão salvar
                        $('#btnSalvarDevolucao').prop('disabled', false).html('<i class="fas fa-save"></i> Salvar Devolução');
                    }
                });
            });
            
            /// ********** NOVO ***********   //////////
            // Botão de abrir na tabela de locações em trânsito
            $(document).on('click', '#tabela-transito .btn-primary', function() {
                const tr = $(this).closest('tr');
                const idItem = tr.find('td:first').text();
                const self = this;
                
                // Mostrar modal de carregamento
                mostrarModalCarregando();
                                
                // Mostrar um indicador de carregamento
                $(self).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>');

                // Primeiro, carregar os dados da locação
                $.ajax({
                    url: `/api/locacao_item/${idItem}`,
                    type: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        console.log("Dados da locação carregados:", data);
                        
                        // Guardar os dados para uso posterior
                        const itemData = data;
                        
                        // Configurar campos ocultos
                        if (!$('#idItemEdt').length) {
                            $('#formEditarLocacao').append('<input type="hidden" id="idItemEdt">');
                        }
                        if (!$('#valorSubTotalEdt').length) {
                            $('#formEditarLocacao').append('<input type="hidden" id="valorSubTotalEdt">');
                        }
                        
                        // Preencher os campos de texto imediatamente
                        $('#idItemEdt').val(idItem);
                        $('#veiculoModeloEdt').val(tr.find('td:eq(3)').text());
                        $('#objetivoEdt').val(data.objetivo);
                        $('#numSeiEdt').val(data.nu_sei);
                        $('#veiculoModeloEdt').val(data.veículo_modelo);                        
                        $('#combustivelEdt').val(data.combustivel);
                        $('#dataInicioEdt').val(formatarDataParaInput(data.dt_inicio));
                        $('#horaInicioEdt').val(data.hora_inicio ? data.hora_inicio.substring(0, 5) : '');
                        $('#dataFimEdt').val(formatarDataParaInput(data.dt_fim || new Date().toISOString().split('T')[0]));
                        $('#valorDiariaEdt').val(formatarValorMonetario(data.valor_diaria || 0));
                        $('#qtdDiariasEdt').val(data.qt_diarias || 0);
                        $('#valorDifEdt').val(formatarValorMonetario(data.valor_diferenca || 0));
                        $('#valorSubTotalEdt').val(data.valor_subtotal || 0);
                        $('#valorTotalEdt').val(formatarValorMonetario(data.valor_total || 0));
                        $('#observacoesEdt').val(data.obs);

                        // Contador para carregamentos pendentes
                        let carregamentosPendentes = 5; // Número de carregamentos assíncronos
                        
                        idLocacaoAtual = idItem;

                        function verificarCarregamentoCompleto() {
                            carregamentosPendentes--;
                            console.log("Carregamentos pendentes:", carregamentosPendentes);
                            if (carregamentosPendentes <= 0) {
                                // Todos os dados foram carregados
                                fecharModalCarregando();
                                
                                // Restaurar o botão
                                $(self).html('<i class="fas fa-folder-open"></i>');
                                
                                // Definir valores após carregamento
                                $('#empenholocEdt').val(itemData.id_empenho);
                                $('#setorSolicitanteEdt').val(itemData.setor_solicitante);
                                $('#motoristaEdt').val(itemData.id_motorista);
                                $('#veiculoEdt').val(itemData.id_veiculo_loc);
                                
                                // Calcular diárias
                                calcularDiariasEValoresDev();
                                
                                // Abrir o modal
                                const modalEditarLocacao = new bootstrap.Modal(document.getElementById('modalEditarLocacao'));
                                modalEditarLocacao.show();
                            }
                        }
                        
                        // Carregar empenhos
                        $.ajax({
                            url: `/api/empenhos_loc?id_cl=${processoIdSelecionado}`,
                            type: 'GET',
                            dataType: 'json',
                            success: function(data) {
                                empenhoLista = data;
                                let html = '<option value="">Selecione...</option>';
                                data.forEach(function(item) {
                                    html += `<option value="${item.ID_EMPENHO}">${item.NU_EMPENHO}</option>`;
                                });
                                $('#empenholocEdt').html(html);
                                verificarCarregamentoCompleto();
                            },
                            error: function(xhr, status, error) {
                                console.error("Erro ao carregar empenhos:", error);
                                verificarCarregamentoCompleto();
                            }
                        });
                        
                        // Carregar setores
                        $.ajax({
                            url: '/api/setores_loc',
                            type: 'GET',
                            dataType: 'json',
                            success: function(data) {
                                let html = '<option value="">Selecione...</option>';
                                data.forEach(function(item) {
                                    html += `<option value="${item.SIGLA_SETOR}">${item.SIGLA_SETOR}</option>`;
                                });
                                $('#setorSolicitanteEdt').html(html);
                                verificarCarregamentoCompleto();
                            },
                            error: function(xhr, status, error) {
                                console.error("Erro ao carregar setores:", error);
                                verificarCarregamentoCompleto();
                            }
                        });
                        
                        // Carregar processos
                        $.ajax({
                            url: '/api/processos_locacao',
                            type: 'GET',
                            dataType: 'json',
                            success: function(data) {
                                verificarCarregamentoCompleto();
                            },
                            error: function(xhr, status, error) {
                                console.error("Erro ao carregar processos:", error);
                                verificarCarregamentoCompleto();
                            }
                        });
                        
                        // Carregar motoristas
                        $.ajax({
                            url: '/api/lista_motorista_loc',
                            type: 'GET',
                            dataType: 'json',
                            success: function(data) {
                                motoristasLista = data;
                                let html = '<option value="">Selecione...</option>';
                                data.forEach(function(item) {
                                    html += `<option value="${item.ID_MOTORISTA}">${item.NM_MOTORISTA}</option>`;
                                });
                                $('#motoristaEdt').html(html);
                                verificarCarregamentoCompleto();
                            },
                            error: function(xhr, status, error) {
                                console.error("Erro ao carregar motoristas:", error);
                                verificarCarregamentoCompleto();
                            }
                        });
                        
                        // Carregar veículos
                        $.ajax({
                            url: `/api/lista_veiculo?id_cl=${processoIdSelecionado}`,
                            type: 'GET',
                            dataType: 'json',
                            success: function(data) {
                                veiculosLista = data;
                                let html = '<option value="">Selecione...</option>';
                                data.forEach(function(item) {
                                    html += `<option value="${item.ID_VEICULO_LOC}" data-valor="${item.VL_DIARIA_KM}">${item.DE_VEICULO}</option>`;
                                });
                                $('#veiculoEdt').html(html);
                                verificarCarregamentoCompleto();
                            },
                            error: function(xhr, status, error) {
                                console.error("Erro ao carregar veículos:", error);
                                verificarCarregamentoCompleto();
                            }
                        });
                    },
                    error: function(xhr, status, error) {
                        console.error("Erro ao carregar dados da locação:", error);
                        alert("Erro ao carregar dados da locação: " + (xhr.responseJSON?.erro || error));
                        $(self).html('<i class="fas fa-folder-open"></i>');
                        fecharModalCarregando();
                    }
                });
            });

            // Recalcular diárias e valores ao alterar datas e horas
            $('#dataFimEdt, #horaFimEdt, #qtdDiariasEdt, #valorDifEdt').on('change input', function() {
                calcularDiariasEValoresDev();
            });

            // Resetar flags quando mudar data/hora
            $('#dataFimEdt, #horaFimEdt').on('change', function() {
                qtdDiariasEditadaManualmente = false;
                valorDifEditadoManualmente = false;
                calcularDiariasEValoresDev();
            });            

            // Marcadores para edição manual dos campos de diárias e diferença
            $('#qtdDiariasEdt').on('input', function() {
                qtdDiariasEditadaManualmente = true;
                calcularDiariasEValoresDev();
            });
            
            $('#valorDifEdt').on('input', function() {
                valorDifEditadoManualmente = true;
                calcularDiariasEValoresDev();
            });

            
            // Para o campo de valor diferença, formatar como valor monetário ao perder foco
            $('#valorDifEdt').on('blur', function() {
                if (valorDifEditadoManualmente) {
                    const valor = converterParaNumero($(this).val());
                    $(this).val(formatarValorMonetario(valor));
                    calcularDiariasEValoresDev();
                }
            });
            
            // Para o campo de quantidade de diárias, garantir valor mínimo de 1 ao perder foco
            $('#qtdDiariasEdt').on('blur', function() {
                if (qtdDiariasEditadaManualmente) {
                    const valor = parseFloat($(this).val()) || 0;
                    if (valor < 1) {
                        $(this).val(1);
                    }
                    calcularDiariasEValoresDev();
                }
            });
            
             // Botão salvar Form Editar
             $('#btnSalvarEdt').click(function() {
                // Validar formulário
                if (!validarFormularioEdicao()) {
                    return;
                }
                
                // Mostrar loader
                $(this).prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Salvando...');
                
                const idItem = $('#idItemEdt').val();
                const formData = new FormData();
                
                // Adicionar dados ao FormData
                formData.append('objetivo', $('#objetivoEdt').val());
                formData.append('setor_solicitante', $('#setorSolicitanteEdt').val());
                formData.append('id_veiculo', $('#veiculoEdt').val());
                formData.append('id_motorista', $('#motoristaEdt').val());
                formData.append('data_inicio', $('#dataInicioEdt').val());
                formData.append('data_fim', $('#dataFimEdt').val());
                formData.append('hora_inicio', $('#horaInicioEdt').val());
                formData.append('qt_diarias', $('#qtdDiariasEdt').val());
                formData.append('valor_diferenca', converterParaNumero($('#valorDifEdt').val()));
                formData.append('valor_subtotal', $('#valorSubTotalEdt').val());
                formData.append('valor_total', converterParaNumero($('#valorTotalEdt').val()));
                formData.append('veiculo_modelo', $('#veiculoModeloEdt').val());
                formData.append('combustivel', $('#combustivelEdt').val());
                formData.append('obs', $('#observacoesEdt').val());

                $.ajax({
                    url: `/api/editar_locacao/${idItem}`,
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        console.log("Resposta:", response);
                        
                        // Mostrar mensagem de sucesso
                        $('#mensagemSucesso').text("Registro alterado com sucesso!");
                        
                        // Fechar modal de devolução
                        $('#modalEditarLocacao').modal('hide');
                        
                        // Mostrar modal de sucesso
                        const modalSucesso = new bootstrap.Modal(document.getElementById('modalSucesso'));
                        modalSucesso.show();
                        
                        // Recarregar locações em trânsito
                        if (processoIdSelecionado) {
                            carregarLocacoesTransito(processoIdSelecionado);
                        }
                        
                        // Reset botão salvar
                        $('#btnSalvarEdt').prop('disabled', false).html('<i class="fas fa-save"></i> Salvar');
                    },
                    error: function(xhr, status, error) {
                        console.error("Erro ao salvar registro:", error);
                        console.error("Resposta:", xhr.responseText);
                        
                        let mensagemErro = "Erro ao salvar registro";
                        if (xhr.responseJSON && xhr.responseJSON.erro) {
                            mensagemErro += ": " + xhr.responseJSON.erro;
                        } else if (xhr.statusText) {
                            mensagemErro += ": " + xhr.statusText;
                        } else {
                            mensagemErro += ": " + error;
                        }
                        
                        alert(mensagemErro);
                        
                        // Reset botão salvar
                        $('#btnSalvarEdt').prop('disabled', false).html('<i class="fas fa-save"></i> Salvar');
                    }
                });
            });
 
            // Botão de visualizar na tabela de locações em finalizada
            $(document).on('click', '#tabela-finalizadas .btn-abrir', function() {
                const tr = $(this).closest('tr');
                const idItem = tr.find('td:first').text();
                const self = this;
                
                // Mostrar modal de carregamento
                mostrarModalCarregando();
                                
                // Mostrar um indicador de carregamento
                $(self).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>');

                // Primeiro, carregar os dados da locação
                $.ajax({
                    url: `/api/locacao_visualiza/${idItem}`,
                    type: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        console.log("Dados da locação carregados:", data);
                        
                        // Guardar os dados para uso posterior
                        const itemData = data;
                        
                        // Configurar campos ocultos
                        if (!$('#idItemVis').length) {
                            $('#formVisualizaLocacao').append('<input type="hidden" id="idItemVis">');
                        }
                        if (!$('#valorSubTotalVis').length) {
                            $('#formDevolucaoLocacao').append('<input type="hidden" id="valorSubTotalVis">');
                        }
                        
                        // Preencher os campos de texto imediatamente
                        $('#idItemVis').val(idItem);
                        $('#empenholocVis').val(data.nu_empenho);
                        $('#setorSolicitanteVis').val(data.setor_solicitante);
                        $('#objetivoVis').val(data.objetivo);
                        $('#numSeiVis').val(data.nu_sei);
                        $('#motoristaVis').val(data.nome_motorista);
                        $('#veiculoVis').val(data.de_veiculo);
                        $('#veiculoModeloVis').val(data.veiculo_modelo);
                        $('#combustivelVis').val(data.combustivel);
                        $('#dataInicioVis').val(formatarDataParaInput(data.dt_inicio));
                        $('#horaInicioVis').val(data.hora_inicio ? data.hora_inicio.substring(0, 5) : '');
                        $('#dataFimVis').val(formatarDataParaInput(data.dt_fim || new Date().toISOString().split('T')[0]));
                        $('#horaFimVis').val(data.hora_fim ? data.hora_fim.substring(0, 5) : '');
                        $('#qtdDiariasVis').val(data.qt_diarias || 0);
                        $('#valorDiariaVis').val(formatarValorMonetario(data.valor_diaria || 0));
                        $('#valorDifVis').val(formatarValorMonetario(data.valor_diferenca || 0));
                        $('#valorSubTotalVis').val(data.valor_subtotal || 0);
                        $('#valorTotalVis').val(formatarValorMonetario(data.valor_total || 0));
                        $('#kmVis').val(data.km_rodado || 0);
                        $('#observacoesVis').val(data.obs);
                        $('#observacoesDevVis').val(data.obs_dev);

                        
                        // Contador para carregamentos pendentes
                        let carregamentosPendentes = 0; // Número de carregamentos assíncronos
                        
                        function verificarCarregamentoCompleto() {
                            carregamentosPendentes--;
                            console.log("Carregamentos pendentes:", carregamentosPendentes);
                            if (carregamentosPendentes <= 0) {
                                // Todos os dados foram carregados
                                fecharModalCarregando();
                                
                                // Restaurar o botão
                                $(self).html('<i class="fas fa-search"></i>');
                                
                                // Calcular diárias
                                calcularDiariasEValoresDev();
                                
                                // Abrir o modal
                                const modalVisualizaLocacao = new bootstrap.Modal(document.getElementById('modalVisualizaLocacao'));
                                modalVisualizaLocacao.show();
                            }
                        }

                        verificarCarregamentoCompleto();
                        
                    },
                    error: function(xhr, status, error) {
                        console.error("Erro ao carregar dados da locação:", error);
                        alert("Erro ao carregar dados da locação: " + (xhr.responseJSON?.erro || error));
                        $(self).html('<i class="fas fa-search"></i>');
                        fecharModalCarregando();
                    }
                });
            });

            // Evento de clique no botão de excluir locação
            $(document).on('click', '#btnExcluirLocacao', function() {
                // Fecha o modal de edição
                $('#modalEditarLocacao').modal('hide');
                
                // Abre o modal de confirmação de exclusão
                $('#modalConfirmacaoExclusao').modal('show');
            });

            // Evento de clique no botão de confirmar exclusão
            $(document).on('click', '#btnConfirmarExclusao', function() {
                // Desabilita o botão para evitar cliques múltiplos
                
                const idItem = $('#idItemEdt').val();
                idLocacaoAtual = idItem;

                $(this).prop('disabled', true);
                $(this).html('<i class="fas fa-spinner fa-spin"></i> Excluindo...');
                
                
                // Faz a requisição AJAX para excluir a locação
                $.ajax({
                    url: `api/excluir_locacao/${idLocacaoAtual}`,
                    type: 'DELETE',
                    success: function(response) {
                        // Fecha o modal de confirmação
                        $('#modalConfirmacaoExclusao').modal('hide');
                        
                        // Exibe mensagem de sucesso
                        Swal.fire({
                            title: 'Sucesso!',
                            text: 'Locação excluída com sucesso.',
                            icon: 'success',
                            confirmButtonText: 'OK'
                        }).then(() => {
                            // Recarregar locações em trânsito se a função existir
                            if (typeof carregarLocacoesTransito === 'function') {
                                carregarLocacoesTransito(processoIdSelecionado);
                            }

                        });
                    },
                    error: function(xhr, status, error) {
                        // Reativa o botão
                        $('#btnConfirmarExclusao').prop('disabled', false);
                        $('#btnConfirmarExclusao').html('<i class="fas fa-trash"></i> Excluir');
                        
                        // Exibe mensagem de erro
                        Swal.fire({
                            title: 'Erro!',
                            text: 'Não foi possível excluir a locação. ' + (xhr.responseJSON?.message || error),
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                    }
                });
            });

            // // Se o modal de edição for fechado, limpa o ID atual da locação
            // $('#modalEditarLocacao').on('hidden.bs.modal', function() {
            //     idLocacaoAtual = null;
            // });

            // // Se o modal de confirmação for fechado, reativa o botão de confirmar exclusão
            // $('#modalConfirmacaoExclusao').on('hidden.bs.modal', function() {
            //     $('#btnConfirmarExclusao').prop('disabled', false);
            //     $('#btnConfirmarExclusao').html('<i class="fas fa-trash"></i> Excluir');
                
            //     // Se o modal de edição ainda estiver aberto, mostra-o novamente
            //     if (idLocacaoAtual) {
            //         $('#modalEditarLocacao').modal('show');
            //     }
            // });

        });

        // Função para carregar setores  - Form Nova Locação
        function carregarSetores() {
            $.ajax({
                url: '/api/setores_loc',
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    let html = '<option value="">Selecione...</option>';
                    data.forEach(function(item) {
                        html += `<option value="${item.SIGLA_SETOR}">${item.SIGLA_SETOR}</option>`;
                    });
                    $('#setorSolicitante').html(html);
                },
                error: function(xhr, status, error) {
                    console.error("Erro ao carregar setores:", error);
                    alert("Erro ao carregar lista de setores.");
                }
            });
        }
        
        // Função para carregar motoristas - Form Nova Locação
        function carregarMotoristas() {
            $.ajax({
                url: '/api/lista_motorista_loc',
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    motoristasLista = data;
                    let html = '<option value="">Selecione...</option>';
                    data.forEach(function(item) {
                        html += `<option value="${item.ID_MOTORISTA}">${item.NM_MOTORISTA}</option>`;
                    });
                    $('#motorista').html(html);
                },
                error: function(xhr, status, error) {
                    console.error("Erro ao carregar motoristas:", error);
                    alert("Erro ao carregar lista de motoristas.");
                }
            });
        }
        
        // Função para carregar empenhos - Form Nova Locação
        function carregarEmpenhos(id_cl) {
            $.ajax({
                url: `/api/empenhos_loc?id_cl=${id_cl}`,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    empenhoLista = data;
                    let html = '<option value="">Selecione...</option>';
                    data.forEach(function(item) {
                        html += `<option value="${item.ID_EMPENHO}">${item.NU_EMPENHO}</option>`;
                    });
                    $('#empenholoc').html(html);
                },
                error: function(xhr, status, error) {
                    console.error("Erro ao carregar empenhos:", error);
                    alert("Erro ao carregar lista de empenhos.");
                }
            });
        }

        // Função para carregar veículos - Form Nova Locação
        function carregarVeiculos(id_cl) {
            $.ajax({
                url: `/api/lista_veiculo?id_cl=${id_cl}`,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    veiculosLista = data;
                    let html = '<option value="">Selecione...</option>';
                    data.forEach(function(item) {
                        html += `<option value="${item.ID_VEICULO_LOC}" data-valor="${item.VL_DIARIA_KM}">${item.DE_VEICULO}</option>`;
                    });
                    $('#veiculo').html(html);
                },
                error: function(xhr, status, error) {
                    console.error("Erro ao carregar veículos:", error);
                    alert("Erro ao carregar lista de veículos.");
                }
            });
        }
        
        // Função para carregar setores  - Form Devolução Locação
        function carregarSetoresDev() {
            $.ajax({
                url: '/api/setores_loc',
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    let html = '<option value="">Selecione...</option>';
                    data.forEach(function(item) {
                        html += `<option value="${item.SIGLA_SETOR}">${item.SIGLA_SETOR}</option>`;
                    });
                    $('#setorSolicitanteDev').html(html);
                },
                error: function(xhr, status, error) {
                    console.error("Erro ao carregar setores:", error);
                    alert("Erro ao carregar lista de setores.");
                }
            });
        }
        
        // Função para carregar motoristas - Form Devolução Locação
        function carregarMotoristasDev() {
            $.ajax({
                url: '/api/lista_motorista_loc',
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    motoristasLista = data;
                    let html = '<option value="">Selecione...</option>';
                    data.forEach(function(item) {
                        html += `<option value="${item.ID_MOTORISTA}">${item.NM_MOTORISTA}</option>`;
                    });
                    $('#motoristaDev').html(html);
                },
                error: function(xhr, status, error) {
                    console.error("Erro ao carregar motoristas:", error);
                    alert("Erro ao carregar lista de motoristas.");
                }
            });
        }
        
        // Função para carregar empenhos - Form Devolução Locação
        function carregarEmpenhosDev(id_cl) {
            $.ajax({
                url: `/api/empenhos_loc?id_cl=${id_cl}`,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    empenhoLista = data;
                    let html = '<option value="">Selecione...</option>';
                    data.forEach(function(item) {
                        html += `<option value="${item.ID_EMPENHO}">${item.NU_EMPENHO}</option>`;
                    });
                    $('#empenholocDev').html(html);
                },
                error: function(xhr, status, error) {
                    console.error("Erro ao carregar empenhos:", error);
                    alert("Erro ao carregar lista de empenhos.");
                }
            });
        }

        // Função para carregar veículos - Form Devolução Locação
        function carregarVeiculosDev(id_cl) {
            $.ajax({
                url: `/api/lista_veiculo?id_cl=${id_cl}`,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    veiculosLista = data;
                    let html = '<option value="">Selecione...</option>';
                    data.forEach(function(item) {
                        html += `<option value="${item.ID_VEICULO_LOC}" data-valor="${item.VL_DIARIA_KM}">${item.DE_VEICULO}</option>`;
                    });
                    $('#veiculoDev').html(html);
                },
                error: function(xhr, status, error) {
                    console.error("Erro ao carregar veículos:", error);
                    alert("Erro ao carregar lista de veículos.");
                }
            });
        }

        // Calcular diárias e valores
        function calcularDiariasEValores() {
            const dataInicio = new Date($('#dataInicio').val());
            const dataFim = new Date($('#dataFim').val());
            
            if (!isNaN(dataInicio.getTime()) && !isNaN(dataFim.getTime())) {
                // Diferença em dias
                const diffTime = dataFim.getTime() - dataInicio.getTime();
                let diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                // Se for o mesmo dia ou diferença negativa, consideramos como 1 diária
                if (diffDays <= 0) {
                    diffDays = 1;
                }
                
                $('#qtdDiarias').val(diffDays);
                
                // Calcular valor total
                const valorDiaria = $('#valorDiaria').val().replace('.', '').replace(',', '.') || 0;
                const valorTotal = diffDays * parseFloat(valorDiaria);
                
                $('#valorTotal').val(valorTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
            }
        }   
        
        // Função para carregar processos de locação
        function carregarProcessos() {
            $.ajax({
                url: '/api/processos_locacao',
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    let html = '';
                    data.forEach(function(item) {
                        html += `<tr data-id="${item.ID_CL}">
                            <td>${item.ID_CL}</td>
                            <td>${item.ANO_EXERCICIO}</td>
                            <td>${item.NM_FORNECEDOR}</td>
                            <td>${item.NU_SEI}</td>
                            <td>${item.NU_CONTRATO}</td>
                            <td class="sticky-column">
                                <div class="d-flex justify-content-around">
                                    <a href="javascript:void(0)" onclick="selecionarProcesso(${item.ID_CL})" class="btn btn-sm btn-primary" title="Selecionar">
                                        <i class="fas fa-check-circle"></i>
                                    </a>
                                    <a href="javascript:void(0)" onclick="sairProcesso(${item.ID_CL})" class="btn btn-sm btn-danger ms-1" title="Sair" style="display: none;">
                                        <i class="fas fa-times-circle"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>`;
                    });
                    $('#tabela-processos').html(html);
                },
                error: function(xhr, status, error) {
                    console.error("Erro ao carregar processos:", error);
                    alert("Erro ao carregar dados. Verifique o console para mais detalhes.");
                }
            });
        }
        
        // Função para validar o formulário
        function validarFormulario() {
            if (!$('#setorSolicitante').val()) {
                alert("Por favor, selecione o setor solicitante.");
                return false;
            }
            
            if (!$('#objetivo').val()) {
                alert("Por favor, informe o objetivo da locação.");
                return false;
            }
            
            if (!$('#veiculo').val()) {
                alert("Por favor, selecione um veículo.");
                return false;
            }
            
            if (!$('#motorista').val()) {
                alert("Por favor, selecione um motorista.");
                return false;
            }
            
            if (!$('#dataInicio').val()) {
                alert("Por favor, informe a data de início.");
                return false;
            }
            
            if (!$('#dataFim').val()) {
                alert("Por favor, informe a data de fim.");
                return false;
            }
            
            if (!$('#horaInicio').val()) {
                alert("Por favor, informe a hora de início.");
                return false;
            }
            
            
            // Verificar se as datas são válidas
            const dataInicio = new Date($('#dataInicio').val());
            const dataFim = new Date($('#dataFim').val());
            
            if (dataFim < dataInicio) {
                alert("A data final não pode ser anterior à data inicial!");
                return false;
            }
                            
            return true;
        }
                
        // Função para validar o formulário de devolução
        function validarFormularioDevolucao() {
            if (!$('#setorSolicitanteDev').val()) {
                alert("Por favor, selecione o setor solicitante.");
                return false;
            }
            
            if (!$('#objetivoDev').val()) {
                alert("Por favor, informe o objetivo da locação.");
                return false;
            }
            
            if (!$('#veiculoDev').val()) {
                alert("Por favor, selecione um veículo.");
                return false;
            }
            
            if (!$('#motoristaDev').val()) {
                alert("Por favor, selecione um motorista.");
                return false;
            }

            if (!$('#dataFimDev').val()) {
                alert("Por favor, informe a data de devolução.");
                return false;
            }
            
            if (!$('#horaFimDev').val()) {
                alert("Por favor, informe a hora de devolução.");
                return false;
            }
            
            if (!$('#veiculoModeloDev').val()) {
                alert("Por favor, informe o modelo do veículo.");
                return false;
            }

            if (!$('#kmDev').val()) {
                alert("Por favor, informe o Km rodado.");
                return false;
            }
            
            if (!$('#combustivelDev').val()) {
                alert("Por favor, informe o tipo de combustível.");
                return false;
            }
            
            // Verificar se as datas são válidas
            const dataInicio = new Date($('#dataInicioDev').val() + 'T' + $('#horaInicioDev').val());
            const dataFim = new Date($('#dataFimDev').val() + 'T' + $('#horaFimDev').val());
            
            if (dataFim < dataInicio) {
                alert("A data/hora de devolução não pode ser anterior à data/hora de início!");
                return false;
            }
            
            return true;
        }      


        // Função para validar o formulário de edição
        function validarFormularioEdicao() {
            if (!$('#setorSolicitanteEdt').val()) {
                alert("Por favor, selecione o setor solicitante.");
                return false;
            }
            
            if (!$('#objetivoEdt').val()) {
                alert("Por favor, informe o objetivo da locação.");
                return false;
            }
            
            if (!$('#veiculoEdt').val()) {
                alert("Por favor, selecione um veículo.");
                return false;
            }
            
            if (!$('#motoristaEdt').val()) {
                alert("Por favor, selecione um motorista.");
                return false;
            }           
           
            if (!$('#dataFimEdt').val()) {
                alert("Por favor, informe a data de devolução.");
                return false;
            }
            
            
            // Verificar se as datas são válidas
            const dataInicio = new Date($('#dataInicioEdt').val());
            const dataFim = new Date($('#dataFimEdt').val());
            
            if (dataFim < dataInicio) {
                alert("A data/hora de devolução não pode ser anterior à data/hora de início!");
                return false;
            }
            
            return true;
        }      

        // Calcular diárias e valores para devolução
        function calcularDiariasEValoresDev() {
            // Obtém as datas e horas de início e fim
            const dataInicio = new Date($('#dataInicioDev').val() + 'T' + $('#horaInicioDev').val() + ':00');
            const dataFim = new Date($('#dataFimDev').val() + 'T' + $('#horaFimDev').val() + ':00');
            
            console.log("Calculando diárias:", dataInicio, dataFim);
            
            if (isNaN(dataInicio.getTime()) || isNaN(dataFim.getTime())) {
                console.error("Datas inválidas:", $('#dataInicioDev').val(), $('#horaInicioDev').val(), $('#dataFimDev').val(), $('#horaFimDev').val());
                return; // Datas inválidas
            }
            
            // Identificar qual campo disparou o evento
            const campoAtivo = document.activeElement ? document.activeElement.id : null;
            
            // Se for mudança de data/hora e não houver edição manual, recalcular tudo
            if ((campoAtivo === 'dataFimDev' || campoAtivo === 'horaFimDev') && 
                !qtdDiariasEditadaManualmente && !valorDifEditadoManualmente) {
                
                // Resetar bandeiras quando data/hora mudar
                qtdDiariasEditadaManualmente = false;
                valorDifEditadoManualmente = false;
                
                // Verificar se é a mesma data
                const dataInicioStr = $('#dataInicioDev').val();
                const dataFimStr = $('#dataFimDev').val();
                const mesmaData = dataInicioStr === dataFimStr;
                
                // Calcular a diferença em milissegundos
                const diffMs = dataFim - dataInicio;
                
                // Converter para horas
                const diffHoras = diffMs / (1000 * 60 * 60);
                
                let diarias = 0;
                let valorDiferenca = 0;
                
                if (mesmaData) {
                    // REGRA: Se for a mesma data, sempre 1 diária, sem hora extra
                    diarias = 1;
                    valorDiferenca = 0;
                    console.log("Mesma data - 1 diária, sem hora extra");
                } else {
                    // Calcular diárias completas (24 horas = 1 diária)
                    diarias = Math.floor(diffHoras / 24);
                    
                    // Calcular horas excedentes
                    const horasExcedentes = diffHoras % 24;
                    
                    console.log(`Horas excedentes: ${horasExcedentes}, Tolerância: ${TOLERANCIA_HORAS}`);
                    
                    if (horasExcedentes > TOLERANCIA_HORAS) {
                        // REGRA: Cobra TODAS as horas excedentes (não apenas as que passaram da tolerância)
                        const valorDiaria = converterParaNumero($('#valorDiariaDev').val());
                        
                        // Cada hora excedente vale 1/10 do valor da diária
                        const valorPorHora = valorDiaria * FRACAO_HORA_EXTRA;
                        
                        // Calcular valor total das horas excedentes (arredondando para cima as horas)
                        const horasParaCobranca = Math.ceil(horasExcedentes);
                        valorDiferenca = valorPorHora * horasParaCobranca;
                        
                        // Verificar se o valor das horas extras não ultrapassa uma nova diária
                        if (valorDiferenca >= valorDiaria) {
                            // Se ultrapassar, adicionar uma diária completa e zerar diferença
                            diarias += 1;
                            valorDiferenca = 0;
                            console.log("Horas extras convertidas para diária completa");
                        } else {
                            console.log(`Cobrando ${horasParaCobranca} horas extras: R$ ${formatarValorMonetario(valorDiferenca)}`);
                        }
                    } else {
                        // Dentro da tolerância - não cobra extra
                        valorDiferenca = 0;
                        console.log("Dentro da tolerância - sem cobrança extra");
                    }
                    
                    // Garantir no mínimo 1 diária
                    diarias = Math.max(1, diarias);
                }
                
                // Atualizar os campos
                $('#qtdDiariasDev').val(diarias);
                $('#valorDifDev').val(formatarValorMonetario(valorDiferenca));
            }
            
            // Calcular valor total (sempre recalcular, independente de qual campo foi editado)
            const valorDiaria = converterParaNumero($('#valorDiariaDev').val());
            const qtdDiarias = parseFloat($('#qtdDiariasDev').val() || 0);
            const valorDiferenca = converterParaNumero($('#valorDifDev').val());
            
            console.log("Valores para cálculo:", valorDiaria, qtdDiarias, valorDiferenca);
            
            const valorSubTotal = valorDiaria * qtdDiarias;
            const valorTotal = valorSubTotal + valorDiferenca;
            
            console.log("Valores calculados:", valorSubTotal, valorTotal);
            
            // Armazenar valor subtotal em campo hidden (assumindo que existe)
            if ($('#valorSubTotalDev').length) {
                $('#valorSubTotalDev').val(valorSubTotal);
            }
            
            // Atualizar campos na interface
            $('#valorTotalDev').val(formatarValorMonetario(valorTotal));
        }

        // Calcular diárias e valores para devolução
        function calcularDiariasEValoresEdt() {
            // Obtém as datas e horas de início e fim
            const dataInicio = new Date($('#dataInicioEdt').val() + 'T' + $('#horaInicioEdt').val() + ':00');
            const dataFim = new Date($('#dataFimEdt').val() + 'T' + $('#horaFimEdt').val() + ':00');
            
            console.log("Calculando diárias:", dataInicio, dataFim);
            
            if (isNaN(dataInicio.getTime()) || isNaN(dataFim.getTime())) {
                console.error("Datas inválidas:", $('#dataInicioEdt').val(), $('#horaInicioEdt').val(), $('#dataFimEdt').val(), $('#horaFimEdt').val());
                return; // Datas inválidas
            }
            
            // Identificar qual campo disparou o evento
            const campoAtivo = document.activeElement ? document.activeElement.id : null;
            
            // Se for mudança de data/hora e não houver edição manual, recalcular tudo
            if ((campoAtivo === 'dataFimEdt' || campoAtivo === 'horaFimEdt') && 
                !qtdDiariasEditadaManualmente && !valorDifEditadoManualmente) {
                
                // Resetar bandeiras quando data/hora mudar
                qtdDiariasEditadaManualmente = false;
                valorDifEditadoManualmente = false;
                
                // Calcular a diferença em milissegundos
                const diffMs = dataFim - dataInicio;
                
                // Converter para horas
                const diffHoras = diffMs / (1000 * 60 * 60);
                
                // Calcular diárias (24 horas = 1 diária)
                let diarias = Math.floor(diffHoras / 24);
                
                // Calcular horas excedentes
                const horasExcedentes = diffHoras % 24;
                
                // Se tiver horas excedentes além da tolerância, calcular o valor adicional
                if (horasExcedentes > TOLERANCIA_HORAS) {
                    // Adicionar horas extras convertidas em fração de diária
                    const horasExtras = horasExcedentes - TOLERANCIA_HORAS;
                    
                    // Cada hora extra vale 1/10 do valor da diária
                    const fracaoHorasExtras = Math.ceil(horasExtras) * FRACAO_HORA_EXTRA;
                    
                    // Se a fração passar de 1, considerar uma diária completa
                    if (fracaoHorasExtras >= 1) {
                        diarias += 1;
                        $('#valorDifEdt').val('0,00');
                    } else {
                        // Atualizar o campo de diárias e calcular o valor da diferença (horas extras)
                        const valorDiaria = converterParaNumero($('#valorDiariaEdt').val());
                        const valorDiferenca = valorDiaria * fracaoHorasExtras;
                        
                        $('#valorDifEdt').val(formatarValorMonetario(valorDiferenca));
                    }
                } else {
                    // Sem horas extras
                    $('#valorDifEdt').val('0,00');
                }
                
                // Garantir no mínimo 1 diária
                diarias = Math.max(1, diarias);
                $('#qtdDiariasEdt').val(diarias);
            }
            
            // Calcular valor total (sempre recalcular, independente de qual campo foi editado)
            const valorDiaria = converterParaNumero($('#valorDiariaEdt').val());
            const qtdDiarias = parseFloat($('#qtdDiariasEdt').val() || 0);
            const valorDiferenca = converterParaNumero($('#valorDifEdt').val());
            
            console.log("Valores para cálculo:", valorDiaria, qtdDiarias, valorDiferenca);
            
            const valorSubTotal = valorDiaria * qtdDiarias;
            const valorTotal = valorSubTotal + valorDiferenca;
            
            console.log("Valores calculados:", valorSubTotal, valorTotal);
            
            // Armazenar valor subtotal em campo hidden
            $('#valorSubTotalEdt').val(valorSubTotal);
            
            // Atualizar campos na interface
            $('#valorTotalEdt').val(formatarValorMonetario(valorTotal));
        }


        // Função para formatar data para input (YYYY-MM-DD)
        function formatarDataParaInput(dataStr) {
            if (!dataStr) return '';
            
            try {
                // Se for uma string no formato dd/mm/yyyy
                const partesData = dataStr.split('/');
                if (partesData.length === 3) {
                    return `${partesData[2]}-${partesData[1]}-${partesData[0]}`;
                }
                
                // Se for uma string ISO ou outro formato reconhecido pelo construtor Date
                const data = new Date(dataStr);
                if (!isNaN(data.getTime())) {
                    return data.toISOString().split('T')[0];
                }
                
                return '';
            } catch (e) {
                console.error("Erro ao converter data para input:", e);
                return '';
            }
        }
        
        // Função para selecionar um processo e carregar os dados relacionados
        function selecionarProcesso(id_cl) {
            console.log("Selecionando processo ID:", id_cl);
            processoIdSelecionado = id_cl;
        
            // Mostrar modal de carregamento
            mostrarModalCarregando();
            
            // Obter o nome do fornecedor a partir da tabela
            const fornecedorNome = $(`#tabela-processos tr:has(td:contains(${id_cl}):first-child) td:nth-child(3)`).text();
            
            // Armazenar no localStorage
            localStorage.setItem('fornecedorNome', fornecedorNome);
            console.log("Nome do fornecedor armazenado:", fornecedorNome);
        
            // Ocultar todos os processos exceto o selecionado
            $(`#tabela-processos tr`).hide();
            $(`#tabela-processos tr[data-id="${id_cl}"]`).show();
            
            // Mostrar o botão de sair apenas para o processo selecionado
            $(`#tabela-processos tr[data-id="${id_cl}"] .btn-danger`).show();
        
            // Contador para controlar carregamentos pendentes
            let carregamentosPendentes = 7; // Quantidade de carregamentos assíncronos
        
            function verificarCarregamentoCompleto() {
                carregamentosPendentes--;
                if (carregamentosPendentes <= 0) {
                    // Todos os dados foram carregados
                    fecharModalCarregando();
                }
            }
        
            // Carregar empenhos
            $.ajax({
                url: `/api/empenhos/${id_cl}`,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    console.log("Empenhos carregados:", data);
                    let html = '';
                    if (data.length === 0) {
                        html = '<tr><td colspan="6" class="text-center">Nenhum empenho encontrado</td></tr>';
                    } else {
                        data.forEach(function(item) {
                            html += `<tr>
                                <td>${item.NU_EMPENHO}</td>
                                <td>R$ ${formatarValor(item.VL_EMPENHO)}</td>
                                <td>R$ ${formatarValor(item.VL_LIQUIDADO)}</td>
                                <td>R$ ${formatarValor(item.VL_SALDO)}</td>
                                <td>R$ ${formatarValor(item.VL_ALIQUIDAR)}</td>
                                <td>R$ ${formatarValor(item.VL_SALDO_DISPONIVEL)}</td>
                            </tr>`;
                        });
                    }
                    $('#tabela-empenhos').html(html);
                    verificarCarregamentoCompleto();
                },
                error: function(xhr, status, error) {
                    console.error("Erro ao carregar empenhos:", error);
                    $('#tabela-empenhos').html('<tr><td colspan="6" class="text-center text-danger">Erro ao carregar dados</td></tr>');
                    verificarCarregamentoCompleto();                
                }
            });
            
            // Carregar saldo de diárias
            $.ajax({
                url: `/api/saldo_diarias/${id_cl}`,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    console.log("Saldo de diárias carregado:", data);
                    let html = '';
                    if (data.length === 0) {
                        html = '<tr><td colspan="8" class="text-center">Nenhum registro encontrado</td></tr>';
                    } else {
                        data.forEach(function(item) {
                            html += `<tr>
                                <td>${item.DE_VEICULO}</td>
                                <td>R$ ${formatarValor(item.VL_DIARIA_KM)}</td>
                                <td>${item.QT_DK}</td>
                                <td>${item.QT_UTILIZADO}</td>
                                <td>${item.QT_SALDO}</td>
                                <td>R$ ${formatarValor(item.VALOR_TOTAL)}</td>
                                <td>R$ ${formatarValor(item.VL_UTILIZADO)}</td>
                                <td>R$ ${formatarValor(item.VL_SALDO)}</td>
                            </tr>`;
                        });
                    }
                    $('#tabela-saldo-diarias').html(html);
                    verificarCarregamentoCompleto();
                },
                error: function(xhr, status, error) {
                    console.error("Erro ao carregar saldo de diárias:", error);
                    $('#tabela-saldo-diarias').html('<tr><td colspan="8" class="text-center text-danger">Erro ao carregar dados</td></tr>');
                    verificarCarregamentoCompleto();
                }
            });
        
            // Carregar sintético mensal
            $.ajax({
                url: `/api/sintetico_mensal/${id_cl}`,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    console.log("Sintético mensal carregado:", data);
                    let html = '';
                    if (data.length === 0) {
                        html = '<tr><td colspan="4" class="text-center">Nenhum registro encontrado</td></tr>';
                    } else {
                        data.forEach(function(item) {
                            html += `<tr>
                                <td>${item.MESANO}</td>
                                <td>R$ ${formatarValor(item.SUBTOTAL)}</td>
                                <td>R$ ${formatarValor(item.HORA_EXTRA)}</td>
                                <td>R$ ${formatarValor(item.TOTAL)}</td>
                            </tr>`;
                        });
                    }
                    $('#tabela-sintetico-mensal').html(html);
                    verificarCarregamentoCompleto();
                },
                error: function(xhr, status, error) {
                    console.error("Erro ao carregar sintético mensal:", error);
                    $('#tabela-sintetico-mensal').html('<tr><td colspan="4" class="text-center text-danger">Erro ao carregar dados</td></tr>');
                    verificarCarregamentoCompleto();
                }
            });           
            
            // Carregar dados do PLS
            $.ajax({
                url: `/api/dados_pls/${id_cl}`,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    console.log("Dados do PLS carregado:", data);
                    let html = '';
                    if (data.length === 0) {
                        html = '<tr><td colspan="8" class="text-center">Nenhum registro encontrado</td></tr>';
                    } else {
                        data.forEach(function(item) {
                            html += `<tr>
                                <td>${item.MES_ANO}</td>
                                <td>${item.QTD}</td>
                                <td>${item.KM}</td>
                                <td>R$ ${formatarValor(item.VLTOTAL)}</td>
                                <td>${item.COMBUSTIVEL}</td>
                            </tr>`;
                        });
                    }
                    $('#tabela-dados-pls').html(html);
                    verificarCarregamentoCompleto();
                },
                error: function(xhr, status, error) {
                    console.error("Erro ao carregar saldo de diárias:", error);
                    $('#tabela-dados-pls').html('<tr><td colspan="8" class="text-center text-danger">Erro ao carregar dados</td></tr>');
                    verificarCarregamentoCompleto();
                }
            });            
            
            // Carregar locações em trânsito
            $.ajax({
                url: `/api/locacoes_transito/${id_cl}`,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    console.log("Locações em trânsito carregadas:", data);
                    let html = '';
                    if (data.length === 0) {
                        html = '<tr><td colspan="10" class="text-center">Nenhuma locação em trânsito encontrada</td></tr>';
                    } else {
                        data.forEach(function(item) {
                            html += `<tr>
                                <td>${item.ID_ITEM}</td>
                                <td>${item.MES_ANO}</td>
                                <td>${item.DE_VEICULO}</td>
                                <td>${item.DS_VEICULO_MOD}</td>
                                <td>${formatarDataString(item.DT_INICIAL)}</td>
                                <td>${formatarDataString(item.DT_FINAL)}</td>
                                <td>${item.QT_DIARIA_KM}</td>
                                <td>R$ ${formatarValor(item.VL_TOTALITEM)}</td>
                                <td>${item.MOTORISTA}</td>
                                <td class="sticky-column">
                                    <div class="d-flex justify-content-around">
                                        <a href="javascript:void(0)" class="btn btn-sm btn-primary" title="Abrir">
                                            <i class="fas fa-folder-open"></i>
                                        </a>
                                        <a href="javascript:void(0)" class="btn btn-sm btn-danger ms-1" title="Devolução">
                                            <i class="fas fa-arrow-right-to-bracket"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>`;
                        });
                    }
                    $('#tabela-transito').html(html);
                    verificarCarregamentoCompleto();
                },
                error: function(xhr, status, error) {
                    console.error("Erro ao carregar locações em trânsito:", error);
                    console.error("Status:", xhr.status);
                    console.error("Resposta:", xhr.responseText);
                    $('#tabela-transito').html('<tr><td colspan="10" class="text-center text-danger">Erro ao carregar dados</td></tr>');
                    verificarCarregamentoCompleto();
                }
            });
            
            // Carregar opções de filtro para mês/ano
            $.ajax({
                url: `/api/meses_locacoes/${id_cl}`,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    console.log("Opções de mês/ano carregadas:", data);
                    let selectHtml = '<option value="Todos">Todos</option>';
                    data.forEach(function(item) {
                        selectHtml += `<option value="${item.MES_ANO}">${item.MES_ANO}</option>`;
                    });
                    $('#filtroMesAno').html(selectHtml);
                    verificarCarregamentoCompleto();
                },
                error: function(xhr, status, error) {
                    console.error("Erro ao carregar opções de mês/ano:", error);
                    $('#filtroMesAno').html('<option value="Todos">Todos</option>');
                    verificarCarregamentoCompleto();
                }
            });
            
            $.ajax({
                url: `/api/locacoes_finalizadas/${id_cl}`,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    console.log("Locações finalizadas carregadas:", data);
                    // Armazenar os dados completos para filtrar depois
                    locacoesFinalizadasCompletas = data;
                    let html = '';
                    if (data.length === 0) {
                        html = '<tr><td colspan="10" class="text-center">Nenhuma locação finalizada encontrada</td></tr>';
                    } else {
                        data.forEach(function(item) {
                            html += `<tr>
                                <td>${item.ID_ITEM}</td>
                                <td>${item.MES_ANO}</td>
                                <td>${item.DE_VEICULO}</td>
                                <td>${item.DS_VEICULO_MOD}</td>
                                <td>${formatarDataString(item.DT_INICIAL)}</td>
                                <td>${formatarDataString(item.DT_FINAL)}</td>
                                <td>${item.QT_DIARIA_KM}</td>
                                <td>R$ ${formatarValor(item.VL_TOTALITEM)}</td>
                                <td>${item.MOTORISTA}</td>
                                <td class="sticky-column">
                                    <div class="d-flex justify-content-around">
                                        <a href="javascript:void(0)" class="acao-btn btn-abrir" title="Visualizar">
                                            <i class="fas fa-search"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>`;
                        });
                    }
                    $('#tabela-finalizadas').html(html);                    
                    // Exibir todos os dados inicialmente
                    verificarCarregamentoCompleto();
                },
                error: function(xhr, status, error) {
                    console.error("Erro ao carregar locações finalizadas:", error);
                    console.error("Status:", xhr.status);
                    console.error("Resposta:", xhr.responseText);
                    $('#tabela-finalizadas').html('<tr><td colspan="10" class="text-center text-danger">Erro ao carregar dados</td></tr>');
                    verificarCarregamentoCompleto();
                }
            });
        
            //Carregar locações finalizadas
            // carregarLocacoesFinalizadas(id_cl);  

            // Carregar locações finalizadas - NOVA
            $.ajax({
                url: `/api/locacoes_finalizadas/${id_cl}`,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    console.log("Locações finalizadas carregadas:", data);
                    // Armazenar os dados completos para filtrar depois
                    locacoesFinalizadasCompletas = data;
                    let html = '';
                    if (data.length === 0) {
                        html = '<tr><td colspan="10" class="text-center">Nenhuma locação finalizada encontrada</td></tr>';
                    } else {
                        data.forEach(function(item) {
                            html += `<tr>
                                <td>${item.ID_ITEM}</td>
                                <td>${item.MES_ANO}</td>
                                <td>${item.DE_VEICULO}</td>
                                <td>${item.DS_VEICULO_MOD}</td>
                                <td>${formatarDataString(item.DT_INICIAL)}</td>
                                <td>${formatarDataString(item.DT_FINAL)}</td>
                                <td>${item.QT_DIARIA_KM}</td>
                                <td>R$ ${formatarValor(item.VL_TOTALITEM)}</td>
                                <td>${item.MOTORISTA}</td>
                                <td class="sticky-column">
                                    <div class="d-flex justify-content-around">
                                        <a href="javascript:void(0)" class="acao-btn btn-abrir" title="Visualizar">
                                            <i class="fas fa-search"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>`;
                        });
                    }
                    $('#tabela-finalizadas').html(html);                    
                    verificarCarregamentoCompleto();
                },
                error: function(xhr, status, error) {
                    console.error("Erro ao carregar locações finalizadas:", error);
                    console.error("Status:", xhr.status);
                    console.error("Resposta:", xhr.responseText);
                    $('#tabela-finalizadas').html('<tr><td colspan="10" class="text-center text-danger">Erro ao carregar dados</td></tr>');
                    verificarCarregamentoCompleto();
                }
            });
            
            
        }

        // Nova função para sair do processo selecionado
        function sairProcesso(id_cl) {
            console.log("Saindo do processo ID:", id_cl);
            processoIdSelecionado = null;
            
            // Limpar localStorage
            localStorage.removeItem('fornecedorNome');
            
            // Limpar todas as tabelas
            $('#tabela-empenhos').html('<tr><td colspan="6" class="text-center">Selecione um processo para visualizar os empenhos</td></tr>');
            $('#tabela-saldo-diarias').html('<tr><td colspan="8" class="text-center">Selecione um processo para visualizar o saldo de diárias</td></tr>');
            $('#tabela-sintetico-mensal').html('<tr><td colspan="4" class="text-center">Selecione um processo para visualizar o sintético mensal</td></tr>');
            $('#tabela-dados-pls').html('<tr><td colspan="5" class="text-center">Selecione um processo para visualizar os dados do PLS</td></tr>');
            $('#tabela-transito').html('<tr><td colspan="10" class="text-center">Selecione um processo para visualizar as locações em trânsito</td></tr>');
            $('#tabela-finalizadas').html('<tr><td colspan="10" class="text-center">Selecione um processo para visualizar as locações finalizadas</td></tr>');
            $('#filtroMesAno').html('<option value="Todos">Todos</option>');
            
            // Recarregar todos os processos
            carregarProcessos();
        }        
              
        // Função para exibir locações finalizadas na tabela
        function exibirLocacoesFinalizadas(data) {
            let html = '';
            if (data.length === 0) {
                html = '<tr><td colspan="10" class="text-center">Nenhuma locação finalizada encontrada</td></tr>';
            } else {
                data.forEach(function(item) {
                    html += `<tr>
                        <td>${item.ID_ITEM}</td>
                        <td>${item.MES_ANO}</td>
                        <td>${item.DE_VEICULO}</td>
                        <td>${item.DS_VEICULO_MOD}</td>
                        <td>${formatarDataString(item.DT_INICIAL)}</td>
                        <td>${formatarDataString(item.DT_FINAL)}</td>
                        <td>${item.QT_DIARIA_KM}</td>
                        <td>R$ ${formatarValor(item.VL_TOTALITEM)}</td>
                        <td>${item.MOTORISTA}</td>
                        <td class="sticky-column">
                            <div class="d-flex justify-content-around">
                                <a href="javascript:void(0)" class="acao-btn btn-abrir" title="Visualizar">
                                    <i class="fas fa-search"></i>
                                </a>
                            </div>
                        </td>
                    </tr>`;
                });
            }
            $('#tabela-finalizadas').html(html);
        }

        // Função para aplicar filtro por mês/ano
        function aplicarFiltroMesAno() {
            const filtroSelecionado = $('#filtroMesAno').val();
            
            if (filtroSelecionado === 'Todos') {
                // Exibir todos os dados
                exibirLocacoesFinalizadas(locacoesFinalizadasCompletas);
            } else {
                // Filtrar os dados pelo mês/ano selecionado
                const dadosFiltrados = locacoesFinalizadasCompletas.filter(item => item.MES_ANO === filtroSelecionado);
                exibirLocacoesFinalizadas(dadosFiltrados);
            }
        }
        
        // Função para formatar valores monetários
        function formatarValor(valor) {
            if (valor === null || valor === undefined) return '0,00';
            return parseFloat(valor).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }
        
        // Função para formatar datas (string no formato dd/mm/yyyy)
        function formatarDataString(dataStr) {
            if (!dataStr) return '';
            
            // Verifica se a data já está no formato desejado (dd/mm/yyyy)
            if (typeof dataStr === 'string' && dataStr.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                return dataStr; // Já está no formato correto, retorna a própria string
            }
            
            // Tenta converter usando o formato ISO
            try {
                const dt = new Date(dataStr);
                if (!isNaN(dt.getTime())) {
                    return dt.toLocaleDateString('pt-BR');
                }
            } catch (e) {
                console.error("Erro ao formatar data como ISO:", e);
            }
            
            // Se não conseguiu converter como ISO, tenta outros formatos comuns
            try {
                // Tenta extrair dia, mês e ano para os casos onde dataStr é algo como "dd/mm/yyyy"
                // ou quando é uma string em outro formato que precisa ser manipulado
                let dia, mes, ano;
                
                // Formato dd/mm/yyyy
                const formatoBR = dataStr.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
                if (formatoBR) {
                    dia = formatoBR[1];
                    mes = formatoBR[2];
                    ano = formatoBR[3];
                    return `${dia}/${mes}/${ano}`;
                }
                
                // Formato yyyy-mm-dd ou yyyy/mm/dd
                const formatoISO = dataStr.match(/^(\d{4})[\/-](\d{2})[\/-](\d{2})$/);
                if (formatoISO) {
                    dia = formatoISO[3];
                    mes = formatoISO[2];
                    ano = formatoISO[1];
                    return `${dia}/${mes}/${ano}`;
                }
                
                // Se chegou até aqui, retorna a string original
                return dataStr;
            } catch (e) {
                console.error("Erro ao formatar data com regex:", e);
                return dataStr; // Em caso de erro, retorna o valor original
            }
        }

        // Função de logout corrigida
        function fazerLogout() {
            const btnLogout = document.getElementById('btnLogout');
            
            // Desabilitar o botão para evitar múltiplos cliques
            btnLogout.disabled = true;
            btnLogout.textContent = 'Saindo...';
            
            // Fazer requisição para o endpoint de logout do backend
            fetch('/logout', {
                method: 'GET',
                credentials: 'same-origin' // Importante para manter os cookies de sessão
            })
            .then(response => {
                // Independente da resposta, limpar o localStorage
                localStorage.removeItem('usuario_logado');
                localStorage.removeItem('usuario_id');
                localStorage.removeItem('usuario_login');
                localStorage.removeItem('usuario_nome');
                localStorage.removeItem('nivel_acesso');
                
                // Redirecionar para a página de login
                window.location.href = '/login';
            })
            .catch(error => {
                console.error('Erro durante logout:', error);
                
                // Mesmo com erro, limpar o localStorage e redirecionar
                localStorage.removeItem('usuario_logado');
                localStorage.removeItem('usuario_id');
                localStorage.removeItem('usuario_login');
                localStorage.removeItem('usuario_nome');
                localStorage.removeItem('nivel_acesso');
                
                // Redirecionar para a página de login
                window.location.href = '/login';
            })
            .finally(() => {
                // Reabilitar o botão (caso algo dê errado)
                btnLogout.disabled = false;
                btnLogout.textContent = 'Sair';
            });
        }

        // Funções para o modal de Relatório Analítico
        function abrirModalRelatorio(idCl) {
            const modal = document.getElementById('modalRelatorioAnalitico');
            const iframe = document.getElementById('iframeRelatorio');
            
            // Obter o filtro de mês/ano selecionado
            const filtroMesAno = $('#filtroMesAno').val();
            
            // Construir URL com parâmetros
            let url = `/rel_locacao_analitico?id_cl=${idCl}`;
            if (filtroMesAno && filtroMesAno !== 'Todos') {
                url += `&mes_ano=${encodeURIComponent(filtroMesAno)}`;
            }
            
            iframe.src = url;
            modal.style.display = 'block';
            
            // Prevenir scroll do body quando modal está aberto
            document.body.style.overflow = 'hidden';
        }
        
        function fecharModalRelatorio() {
            const modal = document.getElementById('modalRelatorioAnalitico');
            const iframe = document.getElementById('iframeRelatorio');
            modal.style.display = 'none';
            iframe.src = '';
            
            // Restaurar scroll do body
            document.body.style.overflow = 'auto';
        }
        
        // Event listeners para fechar o modal
        window.addEventListener('click', function(event) {
            const modalRelatorio = document.getElementById('modalRelatorioAnalitico');
            if (event.target === modalRelatorio) {
                fecharModalRelatorio();
            }
        });
        
        document.addEventListener('keydown', function(event) {
            const modalRelatorio = document.getElementById('modalRelatorioAnalitico');
            if (event.key === 'Escape' && modalRelatorio.style.display === 'block') {
                fecharModalRelatorio();
            }
        });
        
    </script>
</body>
</html>




