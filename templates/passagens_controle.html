<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Bilhetes - Passagens Aéreas</title>
    
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.21/css/dataTables.bootstrap4.min.css">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            font-size: 13px;
            padding-top: 20px;
        }
        
        .navbar {
            background-color: #2c3e50;
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
            padding: 8px 0;
        }

        .navbar-brand {
            font-size: 14px;
            font-weight: 600;
            color: white !important;
        }

        .navbar-nav .nav-link {
            font-size: 13px;
            color: white !important;
            padding: 8px 15px;
        }

        .navbar-nav .nav-link:hover {
            background-color: rgba(255,255,255,0.1);
            border-radius: 3px;
        }
        
        .content-wrapper {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .page-header {
            background-color: #2c3e50;
            color: white;
            padding: 10px 20px;
            margin-bottom: 15px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-header h2 {
            font-size: 16px;
            font-weight: 600;
            margin: 0;
            letter-spacing: 0.5px;
        }

        .page-header p {
            font-size: 12px;
            margin: 0;
            opacity: 0.9;
        }
        
        .card {
            border: none;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,.1);
            margin-bottom: 20px;
            background-color: white;
        }
        
        .card-header {
            background-color: #2c3e50;
            color: white;
            border-radius: 4px 4px 0 0 !important;
            padding: 10px 15px;
        }

        .card-header h5 {
            font-size: 14px;
            font-weight: 600;
            margin: 0;
        }

        .card-body {
            padding: 15px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn i {
            margin-right: 5px;
        }
        
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
            color: white;
        }
        
        .btn-success {
            background-color: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background-color: #229954;
            color: white;
        }
        
        .btn-warning {
            background-color: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background-color: #e67e22;
            color: white;
        }
        
        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
            color: white;
        }
        
        .btn-info {
            background-color: #16a085;
            color: white;
        }

        .btn-info:hover {
            background-color: #138d75;
            color: white;
        }

        .btn-secondary {
            background-color: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #7f8c8d;
            color: white;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
            justify-content: center;
        }
        
        .table {
            font-size: 12px;
            margin-bottom: 0;
        }
        
        .table thead th {
            background-color: #ecf0f1;
            border-bottom: 2px solid #bdc3c7;
            font-weight: 600;
            color: #2c3e50;
            font-size: 12px;
            padding: 10px;
            vertical-align: middle;
        }

        .table tbody td {
            padding: 8px 10px;
            vertical-align: middle;
        }
        
        .modal-header {
            background-color: #2c3e50;
            color: white;
            padding: 12px 20px;
        }

        .modal-header .modal-title {
            font-size: 14px;
            font-weight: 600;
        }
        
        .modal-header .close {
            color: white;
            opacity: 1;
            font-size: 24px;
            font-weight: 300;
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            font-size: 12px;
            font-weight: 600;
            color: #555;
            margin-bottom: 4px;
        }

        .form-control {
            padding: 6px 10px;
            font-size: 13px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }

        .form-control-sm {
            padding: 5px 8px;
            font-size: 12px;
        }
        
        .form-control:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }
        
        .badge {
            padding: 4px 8px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-info {
            background-color: #3498db;
        }

        .badge-success {
            background-color: #27ae60;
        }
        
        .required:after {
            content: " *";
            color: #e74c3c;
            font-weight: bold;
        }
        
        .info-box {
            background-color: #e8f4f8;
            border-left: 4px solid #3498db;
            padding: 8px 12px;
            margin-bottom: 12px;
            border-radius: 3px;
            font-size: 12px;
        }
        
        .info-box i {
            color: #3498db;
            margin-right: 8px;
        }

        .valor-total {
            font-weight: bold;
            color: #27ae60;
            font-size: 15px;
            padding: 8px;
            background-color: #e8f8f5;
            border-radius: 3px;
            text-align: center;
        }

        .table-responsive {
            overflow-x: auto;
        }

        .dataTables_wrapper .dataTables_length,
        .dataTables_wrapper .dataTables_filter,
        .dataTables_wrapper .dataTables_info,
        .dataTables_wrapper .dataTables_paginate {
            font-size: 12px;
        }

        .form-row {
            display: flex;
            gap: 10px;
            margin-bottom: 0;
        }

        .form-row .form-group {
            flex: 1;
            min-width: 0;
            margin-bottom: 12px;
        }

        input[readonly] {
            background-color: #f8f9fa;
            color: #666;
        }

        .input-group-append .btn {
            padding: 6px 12px;
        }

        .col-auto {
            flex: 0 0 auto;
            width: auto;
        }

        .col-2 {
            flex: 0 0 16.666667%;
            max-width: 16.666667%;
        }

        .col-3 {
            flex: 0 0 25%;
            max-width: 25%;
        }

        .col-4 {
            flex: 0 0 33.333333%;
            max-width: 33.333333%;
        }

        .col-6 {
            flex: 0 0 50%;
            max-width: 50%;
        }

        .col-8 {
            flex: 0 0 66.666667%;
            max-width: 66.666667%;
        }

        /* Reduzir o modal em 25% */
        .modal-dialog.modal-form {
            max-width: 650px;
        }

        .modal-dialog.modal-lg {
            max-width: 900px;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/controle_passagens_aereas">
                <i class="fas fa-plane"></i> Passagens Aéreas
            </a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/controle_passagens_aereas">
                            <i class="fas fa-arrow-left"></i> Voltar ao Orçamento
                        </a>
                    </li>
                    <li class="nav-item">
                        <span class="nav-link">
                            <i class="fas fa-user"></i> {{ usuario }}
                        </span>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/logout">
                            <i class="fas fa-sign-out-alt"></i> Sair
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Conteúdo Principal -->
    <div class="container-fluid content-wrapper">
        <!-- Cabeçalho -->
        <div class="page-header">
            <div>
                <h2><i class="fas fa-ticket-alt"></i> Controle de Bilhetes Emitidos</h2>
                <p>Gerencie os bilhetes de passagens aéreas emitidas</p>
            </div>
        </div>

        <!-- Botões de Ação -->
        <div class="row mb-3">
            <div class="col-md-12">
                <button class="btn btn-primary" data-toggle="modal" data-target="#modalCadastro">
                    <i class="fas fa-plus"></i> Nova Passagem
                </button>
                <button class="btn btn-info" data-toggle="modal" data-target="#modalFiltros">
                    <i class="fas fa-filter"></i> Filtros
                </button>
                <button class="btn btn-success" onclick="limparFiltros()">
                    <i class="fas fa-sync"></i> Limpar Filtros
                </button>
            </div>
        </div>

        <!-- Card com a Tabela -->
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-list"></i> Bilhetes Emitidos</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table id="tabelaPassagens" class="table table-striped table-bordered table-hover" style="width:100%">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Passageiro</th>
                                        <th>CIA</th>
                                        <th>Localizador</th>
                                        <th>Rota</th>
                                        <th>Emissão</th>
                                        <th>Embarque</th>
                                        <th>Valor Total</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for p in passagens %}
                                    <tr>
                                        <td>{{ p[0] }}</td>
                                        <td>{{ p[4] }}</td>
                                        <td><span class="badge badge-info">{{ p[10] }}</span></td>
                                        <td>{{ p[11] }}</td>
                                        <td><strong>{{ p[6] }}</strong></td>
                                        <td>{{ p[5] }}</td>
                                        <td>{{ p[9] }}</td>
                                        <td>R$ {{ p[16] }}</td>
                                        <td>
                                            <div class="action-buttons">
                                                <button class="btn btn-sm btn-warning" onclick="editarPassagem({{ p[0] }})" title="Editar">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-sm btn-danger" onclick="confirmarExclusao({{ p[0] }})" title="Excluir">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Cadastro -->
    <div class="modal fade" id="modalCadastro" tabindex="-1">
        <div class="modal-dialog modal-form">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-plus"></i> Nova Passagem</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="formCadastro" onsubmit="salvarPassagem(event)">
                        <input type="hidden" id="id_opa" name="id_opa">
                        <input type="hidden" name="id_controle" value="0">

                        <div class="info-box">
                            <i class="fas fa-info-circle"></i>
                            <strong>Atenção:</strong> Campos com <span style="color: #e74c3c;">*</span> são obrigatórios.
                        </div>

                        <!-- Unidade/Programa/Empenho -->
                        <div class="form-group">
                            <label class="required">Unidade/Programa/Empenho</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="orcamento_display" readonly placeholder="Clique em buscar para selecionar" required>
                                <div class="input-group-append">
                                    <button type="button" class="btn btn-info" onclick="abrirSeletorOrcamento()">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Nº SEI -->
                        <div class="row">
                            <div class="col-6">
                                <div class="form-group">
                                    <label>Nº SEI</label>
                                    <input type="text" class="form-control sei-mask" id="nu_sei" name="nu_sei" placeholder="0000000-00.0000.0.00.0000">
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="form-group">
                                    <label class="required">Data Emissão</label>
                                    <input type="date" class="form-control" id="dt_emissao" name="dt_emissao" required>
                                </div>
                            </div>
                        </div>

                        <!-- Nome do Passageiro -->
                        <div class="form-group">
                            <label class="required">Nome do Passageiro</label>
                            <input type="text" class="form-control" id="nome_passageiro" name="nome_passageiro" maxlength="100" required>
                        </div>

                        <!-- Rota, Origem, Destino -->
                        <div class="row">
                            <div class="col-4">
                                <div class="form-group">
                                    <label class="required">Rota</label>
                                    <input type="text" class="form-control" id="rota" name="rota" style="text-transform: uppercase;" required>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="form-group">
                                    <label class="required">Origem</label>
                                    <input type="text" class="form-control" id="origem" name="origem" style="text-transform: uppercase;" required>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="form-group">
                                    <label class="required">Destino</label>
                                    <input type="text" class="form-control" id="destino" name="destino" style="text-transform: uppercase;" required>
                                </div>
                            </div>
                        </div>

                        <!-- Data Embarque, CIA, Localizador -->
                        <div class="row">
                            <div class="col-4">
                                <div class="form-group">
                                    <label class="required">Data Embarque</label>
                                    <input type="date" class="form-control" id="dt_embarque" name="dt_embarque" required>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="form-group">
                                    <label class="required">Cia Aérea</label>
                                    <input type="text" class="form-control" id="cia" name="cia" maxlength="10" style="text-transform: uppercase;" required>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="form-group">
                                    <label>Localizador</label>
                                    <input type="text" class="form-control" id="localizador" name="localizador" maxlength="10" style="text-transform: uppercase;">
                                </div>
                            </div>
                        </div>

                        <hr>
                        <h6 style="font-size: 13px; margin-bottom: 10px;"><i class="fas fa-dollar-sign"></i> Valores</h6>

                        <!-- Valores -->
                        <div class="row">
                            <div class="col-3">
                                <div class="form-group">
                                    <label class="required">Tarifa</label>
                                    <input type="text" class="form-control form-control-sm money-mask" id="vl_tarifa" name="vl_tarifa" value="0,00" required>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="form-group">
                                    <label>Taxa Extra</label>
                                    <input type="text" class="form-control form-control-sm money-mask" id="vl_taxa_extra" name="vl_taxa_extra" value="0,00">
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="form-group">
                                    <label>Assento</label>
                                    <input type="text" class="form-control form-control-sm money-mask" id="vl_assento" name="vl_assento" value="0,00">
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="form-group">
                                    <label>Taxa Embarque</label>
                                    <input type="text" class="form-control form-control-sm money-mask" id="vl_taxa_embarque" name="vl_taxa_embarque" value="0,00">
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Valor Total</label>
                            <input type="hidden" id="vl_total" name="vl_total" value="0,00">
                            <div class="valor-total" id="vl_total_display">R$ 0,00</div>
                        </div>

                        <div class="text-right mt-3">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Salvar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Seletor de Orçamento -->
    <div class="modal fade" id="modalSeletorOrcamento" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-search"></i> Selecionar Orçamento</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table id="tabelaOrcamentos" class="table table-striped table-bordered table-hover table-sm" style="width:100%; font-size: 11px;">
                            <thead>
                                <tr>
                                    <th>UO</th>
                                    <th>Unidade</th>
                                    <th>Programa</th>
                                    <th>Subitem</th>
                                    <th>Aprovado</th>
                                    <th>Utilizado</th>
                                    <th>Saldo</th>
                                    <th>Empenho</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="tbodyOrcamentos">
                                <!-- Será preenchido via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Edição -->
    <div class="modal fade" id="modalEdicao" tabindex="-1">
        <div class="modal-dialog modal-form">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-edit"></i> Editar Passagem</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="formEdicao" onsubmit="atualizarPassagem(event)">
                        <input type="hidden" id="id_of_edit" name="id_of_edit">
                        <input type="hidden" id="id_opa_edit" name="id_opa_edit">
                        <input type="hidden" name="id_controle_edit" value="0">

                        <div class="info-box">
                            <i class="fas fa-info-circle"></i>
                            <strong>Atenção:</strong> Campos com <span style="color: #e74c3c;">*</span> são obrigatórios.
                        </div>

                        <!-- Unidade/Programa/Empenho (somente leitura na edição) -->
                        <div class="form-group">
                            <label>Unidade/Programa/Empenho</label>
                            <input type="text" class="form-control" id="orcamento_display_edit" readonly>
                        </div>

                        <!-- Nº SEI -->
                        <div class="row">
                            <div class="col-6">
                                <div class="form-group">
                                    <label>Nº SEI</label>
                                    <input type="text" class="form-control sei-mask" id="nu_sei_edit" name="nu_sei_edit" placeholder="0000000-00.0000.0.00.0000">
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="form-group">
                                    <label class="required">Data Emissão</label>
                                    <input type="date" class="form-control" id="dt_emissao_edit" name="dt_emissao_edit" required>
                                </div>
                            </div>
                        </div>

                        <!-- Nome do Passageiro -->
                        <div class="form-group">
                            <label class="required">Nome do Passageiro</label>
                            <input type="text" class="form-control" id="nome_passageiro_edit" name="nome_passageiro_edit" maxlength="100" required>
                        </div>

                        <!-- Rota, Origem, Destino -->
                        <div class="row">
                            <div class="col-4">
                                <div class="form-group">
                                    <label class="required">Rota</label>
                                    <input type="text" class="form-control" id="rota_edit" name="rota_edit" style="text-transform: uppercase;" required>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="form-group">
                                    <label class="required">Origem</label>
                                    <input type="text" class="form-control" id="origem_edit" name="origem_edit" style="text-transform: uppercase;" required>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="form-group">
                                    <label class="required">Destino</label>
                                    <input type="text" class="form-control" id="destino_edit" name="destino_edit" style="text-transform: uppercase;" required>
                                </div>
                            </div>
                        </div>

                        <!-- Data Embarque, CIA, Localizador -->
                        <div class="row">
                            <div class="col-4">
                                <div class="form-group">
                                    <label class="required">Data Embarque</label>
                                    <input type="date" class="form-control" id="dt_embarque_edit" name="dt_embarque_edit" required>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="form-group">
                                    <label class="required">Cia Aérea</label>
                                    <input type="text" class="form-control" id="cia_edit" name="cia_edit" maxlength="10" style="text-transform: uppercase;" required>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="form-group">
                                    <label>Localizador</label>
                                    <input type="text" class="form-control" id="localizador_edit" name="localizador_edit" maxlength="10" style="text-transform: uppercase;">
                                </div>
                            </div>
                        </div>

                        <hr>
                        <h6 style="font-size: 13px; margin-bottom: 10px;"><i class="fas fa-dollar-sign"></i> Valores</h6>

                        <!-- Valores -->
                        <div class="row">
                            <div class="col-3">
                                <div class="form-group">
                                    <label class="required">Tarifa</label>
                                    <input type="text" class="form-control form-control-sm money-mask" id="vl_tarifa_edit" name="vl_tarifa_edit" value="0,00" required>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="form-group">
                                    <label>Taxa Extra</label>
                                    <input type="text" class="form-control form-control-sm money-mask" id="vl_taxa_extra_edit" name="vl_taxa_extra_edit" value="0,00">
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="form-group">
                                    <label>Assento</label>
                                    <input type="text" class="form-control form-control-sm money-mask" id="vl_assento_edit" name="vl_assento_edit" value="0,00">
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="form-group">
                                    <label>Taxa Embarque</label>
                                    <input type="text" class="form-control form-control-sm money-mask" id="vl_taxa_embarque_edit" name="vl_taxa_embarque_edit" value="0,00">
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Valor Total</label>
                            <input type="hidden" id="vl_total_edit" name="vl_total_edit" value="0,00">
                            <div class="valor-total" id="vl_total_display_edit">R$ 0,00</div>
                        </div>

                        <div class="text-right mt-3">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Atualizar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Filtros -->
    <div class="modal fade" id="modalFiltros" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-filter"></i> Filtros</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="formFiltros" onsubmit="aplicarFiltros(event)">
                        <div class="row">
                            <div class="col-6">
                                <div class="form-group">
                                    <label>Data Início</label>
                                    <input type="date" class="form-control" id="dt_inicio_filtro" name="dt_inicio_filtro">
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="form-group">
                                    <label>Data Fim</label>
                                    <input type="date" class="form-control" id="dt_fim_filtro" name="dt_fim_filtro">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-6">
                                <div class="form-group">
                                    <label>Companhia Aérea</label>
                                    <select class="form-control" id="cia_filtro" name="cia_filtro">
                                        <option value="">Todas</option>
                                        {% for cia in cias %}
                                        <option value="{{ cia[0] }}">{{ cia[0] }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="form-group">
                                    <label>Passageiro</label>
                                    <input type="text" class="form-control" id="passageiro_filtro" name="passageiro_filtro" placeholder="Nome do passageiro">
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Localizador</label>
                            <input type="text" class="form-control" id="localizador_filtro" name="localizador_filtro" placeholder="Código do localizador">
                        </div>

                        <div class="text-right mt-3">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search"></i> Aplicar Filtros
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.21/js/dataTables.bootstrap4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>

    <script>
        $(document).ready(function() {
            // Inicializar DataTable principal
            $('#tabelaPassagens').DataTable({
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.10.21/i18n/Portuguese-Brasil.json'
                },
                order: [[0, 'desc']],
                pageLength: 25,
                responsive: true
            });

            // Máscara SEI
            $('.sei-mask').mask('0000000-00.0000.0.00.0000');
            
            // Máscara de moeda melhorada
            $('.money-mask').each(function() {
                $(this).mask('#.##0,00', {
                    reverse: true,
                    placeholder: '0,00'
                });
            });

            // Garantir que campos de valor sempre comecem com 0,00
            $('.money-mask').on('focus', function() {
                if ($(this).val() === '' || $(this).val() === '0,00') {
                    $(this).val('0,00');
                }
            });

            // Calcular total ao digitar nos campos de valor (Cadastro)
            $('#vl_tarifa, #vl_taxa_extra, #vl_assento, #vl_taxa_embarque').on('input blur', function() {
                calcularTotal();
            });

            // Calcular total ao digitar nos campos de valor (Edição)
            $('#vl_tarifa_edit, #vl_taxa_extra_edit, #vl_assento_edit, #vl_taxa_embarque_edit').on('input blur', function() {
                calcularTotalEdit();
            });

            // Limpar formulário ao fechar modal
            $('#modalCadastro').on('hidden.bs.modal', function () {
                $('#formCadastro')[0].reset();
                $('#id_opa').val('');
                $('#orcamento_display').val('');
                $('.money-mask').val('0,00');
                $('#vl_total_display').text('R$ 0,00');
            });
        });

        // Função para abrir seletor de orçamento
        function abrirSeletorOrcamento() {
            $.ajax({
                url: '/api/orcamento/passagens/disponiveis',
                type: 'GET',
                success: function(response) {
                    if (response.success) {
                        var tbody = $('#tbodyOrcamentos');
                        tbody.empty();
                        
                        response.registros.forEach(function(orcamento) {
                            var row = '<tr>' +
                                '<td>' + orcamento.uo + '</td>' +
                                '<td>' + orcamento.unidade + '</td>' +
                                '<td>' + orcamento.programa + '</td>' +
                                '<td>' + orcamento.subitem + '</td>' +
                                '<td>R$ ' + orcamento.vl_aprovado.toLocaleString('pt-BR', {minimumFractionDigits: 2}) + '</td>' +
                                '<td>R$ ' + orcamento.vl_utilizado.toLocaleString('pt-BR', {minimumFractionDigits: 2}) + '</td>' +
                                '<td><span class="badge badge-success">R$ ' + orcamento.saldo.toLocaleString('pt-BR', {minimumFractionDigits: 2}) + '</span></td>' +
                                '<td>' + orcamento.nu_empenho + '</td>' +
                                '<td><button type="button" class="btn btn-sm btn-primary" onclick="selecionarOrcamento(' + 
                                    orcamento.id_opa + ', \'' + orcamento.unidade + '\', \'' + orcamento.nu_empenho + '\')">Selecionar</button></td>' +
                                '</tr>';
                            tbody.append(row);
                        });
                        
                        // Destruir DataTable anterior se existir
                        if ($.fn.DataTable.isDataTable('#tabelaOrcamentos')) {
                            $('#tabelaOrcamentos').DataTable().destroy();
                        }
                        
                        // Inicializar DataTable do modal
                        $('#tabelaOrcamentos').DataTable({
                            language: {
                                url: '//cdn.datatables.net/plug-ins/1.10.21/i18n/Portuguese-Brasil.json'
                            },
                            pageLength: 10,
                            order: [[0, 'asc']]
                        });
                        
                        $('#modalSeletorOrcamento').modal('show');
                    } else {
                        alert('Erro ao carregar orçamentos: ' + response.error);
                    }
                },
                error: function(xhr) {
                    alert('Erro ao buscar orçamentos disponíveis');
                }
            });
        }

        // Função para selecionar orçamento
        function selecionarOrcamento(idOpa, unidade, empenho) {
            $('#id_opa').val(idOpa);
            $('#orcamento_display').val(unidade + ' - ' + empenho);
            $('#modalSeletorOrcamento').modal('hide');
        }

        // Função para calcular o valor total (Cadastro)
        function calcularTotal() {
            var tarifa = parseFloat($('#vl_tarifa').val().replace(/\./g, '').replace(',', '.')) || 0;
            var taxaExtra = parseFloat($('#vl_taxa_extra').val().replace(/\./g, '').replace(',', '.')) || 0;
            var assento = parseFloat($('#vl_assento').val().replace(/\./g, '').replace(',', '.')) || 0;
            var taxaEmbarque = parseFloat($('#vl_taxa_embarque').val().replace(/\./g, '').replace(',', '.')) || 0;
            
            var total = tarifa + taxaExtra + assento + taxaEmbarque;
            
            $('#vl_total').val(total.toFixed(2).replace('.', ','));
            $('#vl_total_display').text('R$ ' + total.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
        }

        // Função para calcular o valor total (Edição)
        function calcularTotalEdit() {
            var tarifa = parseFloat($('#vl_tarifa_edit').val().replace(/\./g, '').replace(',', '.')) || 0;
            var taxaExtra = parseFloat($('#vl_taxa_extra_edit').val().replace(/\./g, '').replace(',', '.')) || 0;
            var assento = parseFloat($('#vl_assento_edit').val().replace(/\./g, '').replace(',', '.')) || 0;
            var taxaEmbarque = parseFloat($('#vl_taxa_embarque_edit').val().replace(/\./g, '').replace(',', '.')) || 0;
            
            var total = tarifa + taxaExtra + assento + taxaEmbarque;
            
            $('#vl_total_edit').val(total.toFixed(2).replace('.', ','));
            $('#vl_total_display_edit').text('R$ ' + total.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
        }

        // Salvar nova passagem
        function salvarPassagem(event) {
            event.preventDefault();
            
            if (!$('#id_opa').val()) {
                alert('Por favor, selecione um orçamento (Unidade/Programa/Empenho)');
                return;
            }
            
            $.ajax({
                url: '/passagens/salvar',
                type: 'POST',
                data: $('#formCadastro').serialize(),
                success: function(response) {
                    if (response.success) {
                        alert('Passagem cadastrada com sucesso!');
                        location.reload();
                    } else {
                        alert('Erro: ' + response.message);
                    }
                },
                error: function(xhr) {
                    alert('Erro ao salvar: ' + (xhr.responseJSON ? xhr.responseJSON.message : 'Erro desconhecido'));
                }
            });
        }

        // Buscar dados para edição
        function editarPassagem(id) {
            $.ajax({
                url: '/passagens/buscar/' + id,
                type: 'GET',
                success: function(response) {
                    if (response.success) {
                        var data = response.data;
                        
                        // Preencher formulário de edição
                        $('#id_of_edit').val(data[0]);
                        $('#id_opa_edit').val(data[1]);
                        $('#orcamento_display_edit').val('ID OPA: ' + data[1]);
                        $('#nu_sei_edit').val(data[3]);
                        $('#nome_passageiro_edit').val(data[4]);
                        
                        // Converter datas de dd/mm/yyyy para yyyy-mm-dd
                        if (data[5]) {
                            var partes = data[5].split('/');
                            $('#dt_emissao_edit').val(partes[2] + '-' + partes[1] + '-' + partes[0]);
                        }
                        
                        $('#rota_edit').val(data[6]);
                        $('#origem_edit').val(data[7]);
                        $('#destino_edit').val(data[8]);
                        
                        if (data[9]) {
                            var partes = data[9].split('/');
                            $('#dt_embarque_edit').val(partes[2] + '-' + partes[1] + '-' + partes[0]);
                        }
                        
                        $('#cia_edit').val(data[10]);
                        $('#localizador_edit').val(data[11]);
                        $('#vl_tarifa_edit').val(data[12]);
                        $('#vl_taxa_extra_edit').val(data[13]);
                        $('#vl_assento_edit').val(data[14]);
                        $('#vl_taxa_embarque_edit').val(data[15]);
                        $('#vl_total_edit').val(data[16]);
                        
                        // Calcular e exibir total
                        calcularTotalEdit();
                        
                        // Abrir modal
                        $('#modalEdicao').modal('show');
                    } else {
                        alert('Erro: ' + response.message);
                    }
                },
                error: function(xhr) {
                    alert('Erro ao buscar dados: ' + (xhr.responseJSON ? xhr.responseJSON.message : 'Erro desconhecido'));
                }
            });
        }

        // Atualizar passagem
        function atualizarPassagem(event) {
            event.preventDefault();
            
            // Converter datas de yyyy-mm-dd para dd/mm/yyyy antes de enviar
            var dtEmissao = $('#dt_emissao_edit').val();
            var dtEmbarque = $('#dt_embarque_edit').val();
            
            // Criar um FormData para manipular os dados
            var formData = new FormData($('#formEdicao')[0]);
            
            // Converter as datas de volta para dd/mm/yyyy
            if (dtEmissao) {
                var partes = dtEmissao.split('-');
                formData.set('dt_emissao_edit', partes[2] + '/' + partes[1] + '/' + partes[0]);
            }
            
            if (dtEmbarque) {
                var partes = dtEmbarque.split('-');
                formData.set('dt_embarque_edit', partes[2] + '/' + partes[1] + '/' + partes[0]);
            }
            
            $.ajax({
                url: '/passagens/atualizar',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.success) {
                        alert('Passagem atualizada com sucesso!');
                        location.reload();
                    } else {
                        alert('Erro: ' + response.message);
                    }
                },
                error: function(xhr) {
                    alert('Erro ao atualizar: ' + (xhr.responseJSON ? xhr.responseJSON.message : 'Erro desconhecido'));
                }
            });
        }

        // Confirmar exclusão
        function confirmarExclusao(id) {
            if (confirm('Tem certeza que deseja excluir esta passagem?')) {
                $.ajax({
                    url: '/passagens/excluir/' + id,
                    type: 'POST',
                    success: function(response) {
                        if (response.success) {
                            alert('Passagem excluída com sucesso!');
                            location.reload();
                        } else {
                            alert('Erro: ' + response.message);
                        }
                    },
                    error: function(xhr) {
                        alert('Erro ao excluir: ' + (xhr.responseJSON ? xhr.responseJSON.message : 'Erro desconhecido'));
                    }
                });
            }
        }

        // Aplicar filtros
        function aplicarFiltros(event) {
            event.preventDefault();
            
            // Converter datas para formato dd/mm/yyyy
            var dtInicio = $('#dt_inicio_filtro').val();
            var dtFim = $('#dt_fim_filtro').val();
            
            var formData = $('#formFiltros').serialize();
            
            if (dtInicio) {
                var partes = dtInicio.split('-');
                formData += '&dt_inicio_filtro=' + partes[2] + '/' + partes[1] + '/' + partes[0];
            }
            
            if (dtFim) {
                var partes = dtFim.split('-');
                formData += '&dt_fim_filtro=' + partes[2] + '/' + partes[1] + '/' + partes[0];
            }
            
            $.ajax({
                url: '/passagens/filtrar',
                type: 'POST',
                data: formData,
                success: function(response) {
                    if (response.success) {
                        var table = $('#tabelaPassagens').DataTable();
                        table.clear();
                        
                        response.data.forEach(function(passagem) {
                            table.row.add([
                                passagem[0],
                                passagem[4],
                                '<span class="badge badge-info">' + passagem[10] + '</span>',
                                passagem[11],
                                '<strong>' + passagem[6] + '</strong>',
                                passagem[5],
                                passagem[9],
                                'R$ ' + passagem[16],
                                '<div class="action-buttons">' +
                                '<button class="btn btn-sm btn-warning" onclick="editarPassagem(' + passagem[0] + ')" title="Editar"><i class="fas fa-edit"></i></button> ' +
                                '<button class="btn btn-sm btn-danger" onclick="confirmarExclusao(' + passagem[0] + ')" title="Excluir"><i class="fas fa-trash"></i></button>' +
                                '</div>'
                            ]);
                        });
                        
                        table.draw();
                        $('#modalFiltros').modal('hide');
                    } else {
                        alert('Erro: ' + response.message);
                    }
                },
                error: function(xhr) {
                    alert('Erro ao filtrar: ' + (xhr.responseJSON ? xhr.responseJSON.message : 'Erro desconhecido'));
                }
            });
        }

        // Limpar filtros
        function limparFiltros() {
            location.reload();
        }
    </script>
</body>
</html>
