<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda SEGEOP</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            padding-bottom: 80px;
        }
        
        .container {
            max-width: 100%;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: #1a73e8;
            color: white;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .header h1 { 
            font-size: 18px; 
            margin: 0; 
        }
        
        .header .periodo {
            font-size: 14px;
            color: #fff9c4;
            font-weight: 500;
        }
        
        .agenda-wrapper {
            overflow-x: auto;
            padding: 20px;
        }
        
        .agenda-section {
            margin-bottom: 40px;
        }
        
        .section-title {
            background: #34495e;
            color: white;
            padding: 10px 15px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 4px 4px 0 0;
        }
        
        .agenda-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #ddd;
            table-layout: fixed;
        }
        
        .agenda-table th {
            background: #ecf0f1;
            padding: 10px;
            text-align: center;
            border: 1px solid #ddd;
            font-size: 13px;
            font-weight: 600;
        }
        
        .agenda-table td {
            border: 1px solid #ddd;
            padding: 6px;
            vertical-align: middle;
            font-size: 12px;
            position: relative;
            cursor: pointer;
            transition: background 0.2s;
            overflow: visible;
        }

        .cell-selected {
            filter: brightness(0.85);
            box-shadow: inset 0 0 0 2px #1a73e8;
        }
        
        .tipo-locacao {
            background: #c7a3e7 !important;
        }        

        .motorista-filter {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        
        .motorista-filter label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            font-weight: normal;
            font-size: 14px;
        }
        
        .motorista-filter input[type="radio"] {
            cursor: pointer;
            width: auto;
        }
        
        .motorista-inline-filter {
            display: flex;
            gap: 20px;
            margin-bottom: 8px;
            padding: 8px 0;
        }

        .motorista-inline-filter label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            font-weight: normal;
            font-size: 14px;
            margin: 0;
        }

        .motorista-inline-filter input[type="radio"] {
            cursor: pointer;
            width: auto;
            margin: 0;
        }

        #divSolicitado label {
            display: flex;
            align-items: center;
            font-weight: 600;
            cursor: pointer;
        }

        .tipo-solicitado {
            background: #c7a3e7 !important;
        }

        .agenda-table td:hover {
            background: #f8f9fa !important;
        }
        
        .col-numero {
            width: 40px;
            background: #f8f9fa;
            font-weight: 600;
            text-align: center;
        }
        
        .col-nome {
            width: 216px;
            background: #f8f9fa;
            font-weight: 600;
            word-wrap: break-word;
            white-space: normal;
        }
        
        .col-dia {
            width: calc((100% - 256px) / 7);
        }
        
        .cell-content {
            line-height: 1.4;
            min-height: 35px;
            height: auto;
            overflow: visible;
            font-size: 11px;
        }
        
        .cell-content-veiculos {
            line-height: 1.4;
            min-height: 30px;
            height: auto;
            overflow: visible;
            font-size: 11px;
        }
        
        .cell-content div {
            margin-bottom: 2px;
        }
        
        .informar-veiculo {
            color: #dc3545;
            font-style: italic;
            font-size: 10px;
        }
        
        /* Cores por tipo de demanda */
        .tipo-1 { background: #5fa1df; }
        .tipo-2 { background: #79f183; }
        .tipo-3 { background: #f8c295; }
        .tipo-4, .tipo-5 { background: #f8c295; }
        .tipo-6, .tipo-7, .tipo-8 { 
            background: #f3f183; 
            font-weight: bold;
        }
        .tipo-9 { 
            background: #fa8484 !important; 
            /*color: rgb(12, 12, 12);*/
            font-weight: bold;
        }        
        .tipo-10 { 
            background: hsl(320, 96%, 79%) !important; 
            /*color: rgb(12, 12, 12);*/
            font-weight: bold;
        }        
        
        .empty-cell {
            background: #fafafa;
        }
        
        .empty-cell.weekend-empty {
            background: #e0e0e0;
        }
        
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #f8f9fa;
            padding: 15px 20px;
            border-top: 2px solid #dee2e6;
            display: flex;
            justify-content: flex-start;
            align-items: center;
            gap: 10px;
            z-index: 100;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #1a73e8;
            color: white;
        }
        
        .btn-primary:hover { background: #1557b0; }
        
        .footer-divider {
            width: 2px;
            height: 30px;
            background: #dee2e6;
            margin: 0 10px;
        }
        
        .week-tabs-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .week-tab {
            padding: 8px 16px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }
        
        .week-tab:hover {
            background: #e9ecef;
        }
        
        .week-tab.active {
            background: #1a73e8;
            color: white;
            border-color: #1a73e8;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 0;
            width: 90%;
            max-width: 600px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            animation: slideDown 0.3s;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        @keyframes slideDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            background: #1a73e8;
            color: white;
            padding: 10px 20px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .modal-header h2 { 
            font-size: 16px;
            margin: 0;
        }
        
        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: white;
            opacity: 0.8;
        }
        
        .close:hover { opacity: 1; }
        
        .modal-body {
            padding: 15px 20px;
        }
        
        .form-group {
            margin-bottom: 12px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 600;
            font-size: 13px;
            color: #333;
        }
        
        .form-group label .required {
            color: #dc3545;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }

        .form-group input:disabled,
        .form-group select:disabled {
            background: #e9ecef;
            cursor: not-allowed;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 50px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .modal-footer {
            padding: 12px 20px;
            background: #f8f9fa;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            border-radius: 0 0 8px 8px;
            position: sticky;
            bottom: 0;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover { background: #5a6268; }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover { background: #c82333; }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .header-icon {
            cursor: pointer;
            font-size: 20px;
            opacity: 0.85;
            transition: opacity 0.2s, transform 0.2s;
            margin-left: auto;
            padding: 5px 10px;
            text-decoration: none;
            color: white;
        }

        .header-icon:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        .feriados-container {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .feriado-form {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .feriado-form-row {
            display: grid;
            grid-template-columns: 2fr 2fr 1fr;
            gap: 10px;
            align-items: end;
        }

        .feriados-lista {
            max-height: 400px;
            overflow-y: auto;
        }

        .feriado-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            margin-bottom: 8px;
            transition: background 0.2s;
        }

        .feriado-item:hover {
            background: #f8f9fa;
        }

        .feriado-info {
            flex: 1;
        }

        .feriado-descricao {
            font-weight: 600;
            color: #333;
            margin-bottom: 3px;
        }

        .feriado-data {
            font-size: 12px;
            color: #666;
        }

        .btn-icon {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            padding: 5px 10px;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .btn-icon:hover {
            opacity: 1;
        }

        .cell-feriado {
            background: #f3f183 !important;
            font-weight: bold;
            font-size: 11px;
            text-align: center;
            vertical-align: middle;
        }

        .cell-feriado-com-demanda {
            position: relative;
        }

        .cell-feriado-com-demanda::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(243, 241, 131, 0.3) 10px,
                rgba(243, 241, 131, 0.3) 20px
            );
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="container">
    <div class="header">
        <h1>üìÖ AGENDA SEGEOP</h1>
        <span class="periodo" id="semanaAtual"></span>
        <a href="#" class="header-icon" onclick="abrirModalFeriados(); return false;" title="Gerenciar Feriados">üéâ</a>
    </div>
        
        <div class="agenda-wrapper" id="agendaWrapper">
            <div class="loading">‚è≥ Carregando agenda...</div>
        </div>
    </div>
    
    <div class="footer">
        <button class="btn btn-primary" onclick="abrirModalNovoGeral()">‚ûï Nova Demanda</button>
        <div class="footer-divider"></div>
        <div class="week-tabs-container" id="weekTabs"></div>
    </div>
    
    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Nova Demanda</h2>
                <span class="close" onclick="fecharModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="formDemanda">
                    <input type="hidden" id="idAd" value="">
                    
                    <!-- Linha 1: Tipo de Demanda e Tipo de Ve√≠culo -->
                    <div class="form-row">
                        <div class="form-group">
                            <label>Tipo de Demanda <span class="required">*</span></label>
                            <select id="idTipoDemanda" required></select>
                        </div>
                        <div class="form-group">
                            <label id="labelTipoVeiculo">Tipo de Ve√≠culo</label>
                            <select id="idTipoVeiculo"></select>
                        </div>
                    </div>
                    
                    <!-- Linha 2: Motorista com Radio Inline -->
                    <div class="form-group">
                        <label id="labelMotorista">Motorista <span class="required">*</span></label>
                        <div class="motorista-inline-filter" id="motoristaFilter">
                            <label>
                                <input type="radio" name="tipoMotorista" value="segeop" checked> SEGEOP
                            </label>
                            <label>
                                <input type="radio" name="tipoMotorista" value="todos"> Todos
                            </label>
                        </div>
                        <select id="idMotorista" required></select>
                    </div>
                    
                    <!-- Linha 3: Ve√≠culo -->
                    <div class="form-group">
                        <label id="labelVeiculo">Ve√≠culo</label>
                        <select id="idVeiculo"></select>
                    </div>

                    <!-- Linha 4: Datas -->
                    <div class="form-row">
                        <div class="form-group">
                            <label>Data In√≠cio <span class="required">*</span></label>
                            <input type="date" id="dtInicio" required>
                        </div>
                        <div class="form-group">
                            <label>Data Fim <span class="required">*</span></label>
                            <input type="date" id="dtFim" required>
                        </div>
                    </div>

                    <!-- Linha 5: Setor e Solicitante -->
                    <div class="form-row">
                        <div class="form-group">
                            <label id="labelSetor">Setor</label>
                            <input type="text" id="setor" maxlength="35">
                        </div>
                        <div class="form-group">
                            <label id="labelSolicitante">Solicitante</label>
                            <input type="text" id="solicitante" maxlength="30">
                        </div>
                    </div>
                    
                    <!-- Linha 6: Destino e N¬∫ SEI -->
                    <div class="form-row">
                        <div class="form-group">
                            <label id="labelDestino">Destino</label>
                            <input type="text" id="destino" maxlength="25">
                        </div>    
                        <div class="form-group">
                            <label>N¬∫ SEI</label>
                            <input type="text" id="nuSei" maxlength="25">
                        </div>
                    </div>
                    
                    <!-- Linha 7: Observa√ß√µes -->
                    <div class="form-group">
                        <label>Observa√ß√µes</label>
                        <textarea id="obs" maxlength="200" rows="3"></textarea>
                    </div>
                    
                    <!-- Checkbox Solicitado (oculto por padr√£o) -->
                    <div class="form-group" id="divSolicitado" style="display: none;">
                        <label>
                            <input type="checkbox" id="solicitado" style="width: auto; margin-right: 8px;">
                            Solicitado
                        </label>
                    </div>
                    
                    <input type="hidden" id="usuario" value="ADMIN">
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="fecharModal()">Cancelar</button>
                <button class="btn btn-danger" id="btnExcluir" onclick="excluirDemanda()" style="display:none;">üóëÔ∏è Excluir</button>
                <button class="btn btn-primary" onclick="salvarDemanda()">üíæ Salvar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal Feriados -->
    <div id="modalFeriados" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üóìÔ∏è Gerenciar Feriados</h2>
                <span class="close" onclick="fecharModalFeriados()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="feriados-container">
                    <!-- Formul√°rio de Inclus√£o -->
                    <div class="feriado-form">
                        <div class="feriado-form-row">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Tipo</label>
                                <select id="tipoFeriado">
                                    <option value="FERIADO">FERIADO</option>
                                    <option value="PONTO FACULTATIVO">PONTO FACULTATIVO</option>
                                    <option value="OUTRO">OUTRO</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Data</label>
                                <input type="date" id="dataFeriado" required>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>&nbsp;</label>
                                <button class="btn btn-primary" onclick="adicionarFeriado()">‚ûï Adicionar</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Lista de Feriados -->
                    <div class="feriados-lista" id="feriadosLista">
                        <div class="loading">Carregando feriados...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let semanas = [];
        let semanaAtual = 0;
        let dadosAgenda = null;
        let motoristas = [];
        let veiculos = [];
        let tiposDemanda = [];
        let tiposVeiculo = [];
        let veiculoSelecionadoOriginal = null;
        let celulaSelecionada = null;
        let locacoesAtivas = [];
        let contextoAbertura = null; // 'motorista', 'veiculo' ou null
        let feriadosPeriodo = [];

        async function init() {
            await carregarSemanas();
            await carregarSelectsFixos();
            if (semanas.length > 0) {
                const hoje = new Date();
                hoje.setHours(0, 0, 0, 0);
                
                let semanaEncontrada = -1;
                for (let i = 0; i < semanas.length; i++) {
                    const inicio = new Date(semanas[i].inicio + 'T00:00:00');
                    const fim = new Date(semanas[i].fim + 'T00:00:00');
                    
                    if (hoje >= inicio && hoje <= fim) {
                        semanaEncontrada = i;
                        break;
                    }
                }
                
                semanaAtual = semanaEncontrada !== -1 ? semanaEncontrada : semanas.length - 1;
                await carregarLocacoes();
                await carregarFeriadosPeriodo();
                await carregarAgenda();
            }
        }

        // Carregar feriados do per√≠odo atual
        async function carregarFeriadosPeriodo() {
            try {
                const semana = semanas[semanaAtual];
                const res = await fetch(`/api/agenda/feriados-periodo?inicio=${semana.inicio}&fim=${semana.fim}`);
                feriadosPeriodo = await res.json();
            } catch (error) {
                console.error('Erro ao carregar feriados do per√≠odo:', error);
                feriadosPeriodo = [];
            }
        }

        // Abrir modal de feriados
        async function abrirModalFeriados() {
            document.getElementById('modalFeriados').style.display = 'block';
            await carregarListaFeriados();
        }

        // Fechar modal de feriados
        function fecharModalFeriados() {
            document.getElementById('modalFeriados').style.display = 'none';
        }

        // Carregar lista de todos os feriados
        async function carregarListaFeriados() {
            const lista = document.getElementById('feriadosLista');
            lista.innerHTML = '<div class="loading">Carregando...</div>';
            
            try {
                const res = await fetch('/api/agenda/feriados');
                const feriados = await res.json();
                
                if (feriados.length === 0) {
                    lista.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Nenhum feriado cadastrado</div>';
                    return;
                }
                
                lista.innerHTML = feriados.map(f => {
                    const data = new Date(f.dt_feriado + 'T00:00:00');
                    const dataFormatada = data.toLocaleDateString('pt-BR', { 
                        day: '2-digit', 
                        month: '2-digit', 
                        year: 'numeric',
                        weekday: 'short'
                    });
                    
                    return `
                        <div class="feriado-item">
                            <div class="feriado-info">
                                <div class="feriado-descricao">${f.descricao}</div>
                                <div class="feriado-data">${dataFormatada}</div>
                            </div>
                            <button class="btn-icon" onclick="excluirFeriado(${f.id})" title="Excluir">üóëÔ∏è</button>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Erro ao carregar lista de feriados:', error);
                lista.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">Erro ao carregar feriados</div>';
            }
        }

        // Adicionar novo feriado
        async function adicionarFeriado() {
            const tipo = document.getElementById('tipoFeriado').value;
            const data = document.getElementById('dataFeriado').value;
            
            if (!data) {
                alert('Informe a data do feriado!');
                return;
            }
            
            try {
                const res = await fetch('/api/agenda/feriado', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        descricao: tipo,
                        dt_feriado: data
                    })
                });
                
                const result = await res.json();
                
                if (result.success) {
                    document.getElementById('dataFeriado').value = '';
                    await carregarListaFeriados();
                    await carregarFeriadosPeriodo();
                    await carregarAgenda();
                }
            } catch (error) {
                console.error('Erro ao adicionar feriado:', error);
            }
        }

        // Excluir feriado
        async function excluirFeriado(id) {
            try {
                const res = await fetch(`/api/agenda/feriado/${id}`, {
                    method: 'DELETE'
                });
                
                const result = await res.json();
                
                if (result.success) {
                    await carregarListaFeriados();
                    await carregarFeriadosPeriodo();
                    await carregarAgenda();
                }
            } catch (error) {
                console.error('Erro ao excluir feriado:', error);
            }
        }

        // Verificar se uma data √© feriado
        function isFeriado(data) {
            return feriadosPeriodo.find(f => f.dt_feriado === data);
        }


        async function carregarLocacoes() {
            try {
                const semana = semanas[semanaAtual];
                const res = await fetch(`/api/agenda/locacoes?inicio=${semana.inicio}&fim=${semana.fim}`);
                locacoesAtivas = await res.json();
            } catch (error) {
                console.error('Erro ao carregar loca√ß√µes:', error);
                locacoesAtivas = [];
            }
        }
        
        async function carregarSemanas() {
            try {
                const res = await fetch('/api/agenda/semanas');
                const data = await res.json();
                
                if (data.error) {
                    console.error('Erro na API:', data.error);
                    semanas = data.semanas || [];
                } else if (Array.isArray(data)) {
                    semanas = data;
                } else {
                    semanas = [];
                }
                
                renderizarAbas();
            } catch (error) {
                console.error('Erro ao carregar semanas:', error);
                semanas = [];
                const hoje = new Date();
                const domingo = new Date(hoje);
                domingo.setDate(hoje.getDate() - ((hoje.getDay() + 7) % 7));
                const sabado = new Date(domingo);
                sabado.setDate(domingo.getDate() + 6);
                
                semanas = [{
                    inicio: domingo.toISOString().split('T')[0],
                    fim: sabado.toISOString().split('T')[0],
                    label: `${domingo.getDate()}/${domingo.getMonth()+1} - ${sabado.getDate()}/${sabado.getMonth()+1}/${sabado.getFullYear()}`
                }];
                renderizarAbas();
            }
        }
        
        async function carregarSelectsFixos() {
            try {
                const [resTiposDemanda, resTiposVeiculo] = await Promise.all([
                    fetch('/api/agenda/tipos-demanda'),
                    fetch('/api/agenda/tipos-veiculo')
                ]);
                
                tiposDemanda = await resTiposDemanda.json();
                tiposVeiculo = await resTiposVeiculo.json();
                
                const selectTipoDemanda = document.getElementById('idTipoDemanda');
                const selectTipoVeiculo = document.getElementById('idTipoVeiculo');
                
                selectTipoDemanda.innerHTML = '<option value="">Selecione...</option>';
                tiposDemanda.forEach(t => {
                    selectTipoDemanda.innerHTML += `<option value="${t.id}" data-descricao="${t.descricao}">${t.descricao}</option>`;
                });
                
                selectTipoVeiculo.innerHTML = '<option value="">Selecione...</option>';
                tiposVeiculo.forEach(t => {
                    selectTipoVeiculo.innerHTML += `<option value="${t.id}">${t.descricao}</option>`;
                });
                
                // Event listeners para regras de neg√≥cio
                selectTipoDemanda.addEventListener('change', aplicarRegrasTipoDemanda);
                selectTipoVeiculo.addEventListener('change', aplicarRegrasTipoVeiculo);
                document.getElementById('dtInicio').addEventListener('change', atualizarVeiculosDisponiveis);
                document.getElementById('dtFim').addEventListener('change', atualizarVeiculosDisponiveis);
            } catch (error) {
                console.error('Erro ao carregar selects:', error);
            }
        }
        
        function aplicarRegrasTipoDemanda() {
            const idTipoDemanda = parseInt(document.getElementById('idTipoDemanda').value);
            const selectTipoDemanda = document.getElementById('idTipoDemanda');
            const optionSelecionada = selectTipoDemanda.options[selectTipoDemanda.selectedIndex];
            const descricaoTipoDemanda = optionSelecionada ? optionSelecionada.getAttribute('data-descricao') : '';
            
            const motorista = document.getElementById('idMotorista');
            const tipoVeiculo = document.getElementById('idTipoVeiculo');
            const veiculo = document.getElementById('idVeiculo');
            const setor = document.getElementById('setor');
            const solicitante = document.getElementById('solicitante');
            const destino = document.getElementById('destino');
            
            const labelTipoVeiculo = document.getElementById('labelTipoVeiculo');
            const labelVeiculo = document.getElementById('labelVeiculo');
            const labelSetor = document.getElementById('labelSetor');
            const labelSolicitante = document.getElementById('labelSolicitante');
            const labelDestino = document.getElementById('labelDestino');
            const labelMotorista = document.getElementById('labelMotorista');
            
            // Resetar labels
            labelTipoVeiculo.innerHTML = 'Tipo de Ve√≠culo';
            labelVeiculo.innerHTML = 'Ve√≠culo';
            labelSetor.innerHTML = 'Setor';
            labelSolicitante.innerHTML = 'Solicitante';
            labelDestino.innerHTML = 'Destino';
            
            if (labelMotorista) {
                labelMotorista.innerHTML = 'Motorista <span class="required">*</span>';
            }
            
            // Habilitar todos primeiro
            motorista.disabled = false;
            motorista.required = true;
            tipoVeiculo.disabled = false;
            veiculo.disabled = false;
            setor.disabled = false;
            solicitante.disabled = false;
            destino.disabled = false;
            
            if (idTipoDemanda === 10) {
                // ID 10 (Ced√™ncia): Fecha Motorista, abre Setor (obrigat√≥rio), abre Solicitante (n√£o obrigat√≥rio)
                motorista.disabled = true;
                motorista.required = false;
                motorista.value = '';
                if (labelMotorista) {
                    labelMotorista.innerHTML = 'Motorista';
                }
                
                // Setor obrigat√≥rio
                setor.disabled = false;
                labelSetor.innerHTML = 'Setor <span class="required">*</span>';
                
                // Solicitante aberto mas n√£o obrigat√≥rio
                solicitante.disabled = false;
                
            } else if (idTipoDemanda === 9) {
                // ID 9 (Oficina): Fecha Motorista, Setor, Solicitante
                motorista.disabled = true;
                motorista.required = false;
                motorista.value = '';
                if (labelMotorista) {
                    labelMotorista.innerHTML = 'Motorista';
                }               
                setor.disabled = true;
                setor.value = '';
                solicitante.disabled = true;
                solicitante.value = '';
                
            } else if (idTipoDemanda >= 6 && idTipoDemanda <= 8) {
                // ID 6-8: Fecha e desobriga Tipo Ve√≠culo, Ve√≠culo, Setor, Solicitante, Destino
                tipoVeiculo.disabled = true;
                tipoVeiculo.value = '';
                veiculo.disabled = true;
                veiculo.value = '';
                setor.disabled = true;
                setor.value = '';
                solicitante.disabled = true;
                solicitante.value = '';
                destino.disabled = true;
                if (!destino.value) {
                    destino.value = descricaoTipoDemanda;
                }
            } else if (idTipoDemanda === 4 || idTipoDemanda === 5) {
                // ID 4-5: Setor e Solicitante podem ficar em branco, Destino = DE_TIPODEMANDA
                if (!destino.value) {
                    destino.value = descricaoTipoDemanda;
                }
            } else if (idTipoDemanda === 3) {
                // ID 3: Setor e Solicitante podem ficar em branco, Destino usu√°rio preenche
                // N√£o preenche automaticamente
            } else if (idTipoDemanda === 1 || idTipoDemanda === 2) {
                // ID 1-2: Setor e Solicitante obrigat√≥rios
                labelSetor.innerHTML = 'Setor <span class="required">*</span>';
                labelSolicitante.innerHTML = 'Solicitante <span class="required">*</span>';
            }
        }
        
        function aplicarRegrasTipoVeiculo() {
            const idTipoVeiculo = parseInt(document.getElementById('idTipoVeiculo').value);
            const veiculo = document.getElementById('idVeiculo');
            const motorista = document.getElementById('idMotorista');
            const divSolicitado = document.getElementById('divSolicitado');
            const labelMotorista = document.getElementById('labelMotorista');
            
            // Ocultar checkbox Solicitado por padr√£o
            divSolicitado.style.display = 'none';
            
            if (!idTipoVeiculo) {
                veiculo.disabled = false;
                veiculo.innerHTML = '<option value="">Selecione...</option>';
                return;
            }
            
            // IDs 7, 8, 9: Bloqueia motorista e ve√≠culo, exibe checkbox Solicitado
            if (idTipoVeiculo === 7 || idTipoVeiculo === 8 || idTipoVeiculo === 9) {
                motorista.disabled = true;
                motorista.required = false;
                motorista.value = '';
                if (labelMotorista) {
                    labelMotorista.innerHTML = 'Motorista';
                }
                
                veiculo.disabled = true;
                veiculo.value = '';
                
                // Exibir checkbox Solicitado
                divSolicitado.style.display = 'block';
                
            } else if (idTipoVeiculo !== 1) {
                // Tipo diferente de 1 e n√£o √© 7, 8, 9: bloqueia ve√≠culo
                veiculo.disabled = true;
                veiculo.value = '';
            } else {
                // Tipo 1: habilita e carrega ve√≠culos dispon√≠veis
                veiculo.disabled = false;
                atualizarVeiculosDisponiveis();
            }
        }
        
        async function atualizarVeiculosDisponiveis() {
            const idTipoVeiculo = parseInt(document.getElementById('idTipoVeiculo').value);
            const dtInicio = document.getElementById('dtInicio').value;
            const dtFim = document.getElementById('dtFim').value;
            const selectVeiculo = document.getElementById('idVeiculo');
            const idAd = document.getElementById('idAd').value;
            
            // S√≥ atualiza se for tipo ve√≠culo 1 e tiver datas
            if (idTipoVeiculo !== 1 || !dtInicio || !dtFim) {
                return;
            }
            
            try {
                let url = `/api/agenda/veiculos-disponiveis?inicio=${dtInicio}&fim=${dtFim}`;
                if (idAd) {
                    url += `&id_demanda=${idAd}`;
                }
                
                const res = await fetch(url);
                const veiculosDisponiveis = await res.json();
                
                const veiculoAtual = selectVeiculo.value;
                
                selectVeiculo.innerHTML = '<option value="">Selecione...</option>';
                
                // Adiciona ve√≠culos dispon√≠veis
                veiculosDisponiveis.forEach(v => {
                    selectVeiculo.innerHTML += `<option value="${v.id}">${v.veiculo}</option>`;
                });
                
                // Se tinha um ve√≠culo selecionado e ele n√£o est√° na lista, adiciona
                if (veiculoAtual && veiculoSelecionadoOriginal) {
                    const existe = Array.from(selectVeiculo.options).some(opt => opt.value == veiculoAtual);
                    if (!existe) {
                        selectVeiculo.innerHTML += `<option value="${veiculoSelecionadoOriginal.id}">${veiculoSelecionadoOriginal.veiculo}</option>`;
                    }
                    selectVeiculo.value = veiculoAtual;
                }
            } catch (error) {
                console.error('Erro ao carregar ve√≠culos dispon√≠veis:', error);
            }
        }
        
        function renderizarAbas() {
            const tabs = document.getElementById('weekTabs');
            tabs.innerHTML = semanas.map((s, i) => 
                `<div class="week-tab ${i === semanaAtual ? 'active' : ''}" 
                    onclick="mudarSemana(${i})">${s.label}</div>`
            ).join('');
        }
        
        async function mudarSemana(index) {
            semanaAtual = index;
            renderizarAbas();
            await carregarFeriadosPeriodo();
            await carregarAgenda();
        }
        
        async function carregarAgenda() {
            const wrapper = document.getElementById('agendaWrapper');
            wrapper.innerHTML = '<div class="loading">‚è≥ Carregando agenda...</div>';
            
            try {
                const semana = semanas[semanaAtual];
                await carregarLocacoes();
                const res = await fetch(`/api/agenda/dados?inicio=${semana.inicio}&fim=${semana.fim}`);
                dadosAgenda = await res.json();
                
                motoristas = dadosAgenda.motoristas;
                veiculos = dadosAgenda.veiculos;
                
                document.getElementById('semanaAtual').textContent = semana.label;
                
                renderizarAgenda();
            } catch (error) {
                wrapper.innerHTML = '<div class="loading">‚ùå Erro ao carregar agenda</div>';
                console.error('Erro:', error);
            }
        }
        
        function renderizarAgenda() {
            const semana = semanas[semanaAtual];
            const dias = gerarDiasSemana(semana.inicio);
            
            let html = '';
            
            html += renderizarSecaoMotoristas(dias);
            html += renderizarSecaoVeiculos(dias);
            html += renderizarSecaoVeiculosAlocados(dias);
            
            document.getElementById('agendaWrapper').innerHTML = html;
        }
        
        function gerarDiasSemana(inicioStr) {
            const dias = [];
            const inicio = new Date(inicioStr + 'T00:00:00');
            
            for (let i = 0; i < 7; i++) {
                const d = new Date(inicio);
                d.setDate(inicio.getDate() + i);
                dias.push({
                    data: d.toISOString().split('T')[0],
                    diaNum: d.getDate(),
                    mes: d.getMonth() + 1,
                    diaNome: ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'][d.getDay()],
                    diaIndex: d.getDay()
                });
            }
            return dias;
        }
        
        function renderizarSecaoMotoristas(dias) {
            let html = '<div class="agenda-section">';
            html += '<div class="section-title">üöó SEGEOP - MOTORISTAS</div>';
            html += '<table class="agenda-table"><thead><tr>';
            html += '<th class="col-numero">N.</th><th class="col-nome">Nome</th>';
            dias.forEach(d => html += `<th class="col-dia">${d.diaNome}<br>${d.diaNum}/${d.mes}</th>`);
            html += '</tr></thead><tbody>';
            
            motoristas.forEach((m, index) => {
                html += `<tr><td class="col-numero">${index + 1}</td>`;
                html += `<td class="col-nome">${m.nome}</td>`;
                
                dias.forEach(dia => {
                    const feriado = isFeriado(dia.data);
                    const demandasDia = dadosAgenda.demandas.filter(d => 
                        d.id_motorista === m.id && 
                        d.dt_inicio <= dia.data && 
                        d.dt_fim >= dia.data
                    );
                    
                    if (demandasDia.length > 0) {
                        const demanda = demandasDia[0];
                        const corClass = `tipo-${demanda.id_tipodemanda}`;
                        const feriadoClass = feriado ? 'cell-feriado-com-demanda' : '';
                        html += `<td class="${corClass} ${feriadoClass} col-dia" data-id-demanda="${demanda.id}" onclick="handleCellClick(event, ${demanda.id})">`;
                        html += '<div class="cell-content">';
                        
                        // ID 9 (Oficina): mostra descri√ß√£o do tipo (negrito) e destino (regular)
                        if (demanda.id_tipodemanda === 9) {
                            html += `<div><strong>${demanda.de_tipodemanda || 'Oficina'}</strong></div>`;
                            if (demanda.destino) {
                                html += `<div>${demanda.destino}</div>`;
                            }
                        }
                        // ID 10 (Ced√™ncia): mostra descri√ß√£o do tipo (negrito), setor (negrito) e n¬∫ SEI (regular)
                        else if (demanda.id_tipodemanda === 10) {
                            html += `<div><strong>${demanda.de_tipodemanda || 'Ced√™ncia'}</strong></div>`;
                            if (demanda.setor) {
                                html += `<div><strong>${demanda.setor}</strong></div>`;
                            }
                            if (demanda.nu_sei) {
                                html += `<div>${demanda.nu_sei}</div>`;
                            }
                        }
                        // Outros tipos: formato padr√£o
                        else {
                            html += `<div><strong>${demanda.setor || ''}</strong>${demanda.solicitante ? ' (' + demanda.solicitante + ')' : ''}</div>`;
                            html += `<div>${demanda.destino || ''}</div>`;
                            html += `<div>${demanda.nu_sei || ''}</div>`;
                        }
                        
                        // Mostrar (INFORMAR VE√çCULO) se n√£o tiver tipo de ve√≠culo
                        if (!demanda.id_tipoveiculo && ![6, 7, 8, 9, 10].includes(demanda.id_tipodemanda)) {
                            html += '<div class="informar-veiculo">(INFORMAR VE√çCULO)</div>';
                        }                        
                        
                        html += '</div></td>';
                    } else if (feriado) {
                        // C√©lula de feriado sem demanda
                        html += `<td class="cell-feriado col-dia" onclick="abrirModalNovoComData('${dia.data}', ${m.id})">${feriado.descricao}</td>`;
                    } else {
                        const isWeekend = dia.diaIndex === 0 || dia.diaIndex === 6;
                        const weekendClass = isWeekend ? 'weekend-empty' : '';
                        html += `<td class="empty-cell ${weekendClass} col-dia" onclick="abrirModalNovoComData('${dia.data}', ${m.id})"></td>`;
                    }
                });
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            return html;
        }
        
        function handleCellClick(event, idDemanda) {
            event.stopPropagation();
            const cell = event.currentTarget;
            
            // Se a c√©lula clicada j√° est√° selecionada, abre o modal de edi√ß√£o
            if (cell.classList.contains('cell-selected')) {
                abrirModalEditar(idDemanda);
                return;
            }
            
            // Remove sele√ß√£o anterior
            if (celulaSelecionada) {
                celulaSelecionada.classList.remove('cell-selected');
            }
            
            // Seleciona a c√©lula atual
            cell.classList.add('cell-selected');
            celulaSelecionada = cell;
        }
        
        function renderizarSecaoVeiculos(dias) {
            let html = '<div class="agenda-section">';
            html += '<div class="section-title">üöô SEGEOP - VE√çCULOS OFICIAIS</div>';
            html += '<table class="agenda-table"><thead><tr>';
            html += '<th class="col-numero">N.</th><th class="col-nome">Ve√≠culo</th>';
            dias.forEach(d => html += `<th class="col-dia">${d.diaNome}<br>${d.diaNum}/${d.mes}</th>`);
            html += '</tr></thead><tbody>';
            
            veiculos.forEach((v, index) => {
                html += `<tr><td class="col-numero">${index + 1}</td>`;
                html += `<td class="col-nome">${v.veiculo}</td>`;
                
                dias.forEach(dia => {
                    const feriado = isFeriado(dia.data);
                    const demandasDia = dadosAgenda.demandas.filter(d => 
                        d.id_veiculo === v.id && 
                        d.dt_inicio <= dia.data && 
                        d.dt_fim >= dia.data
                    );
                    
                    if (demandasDia.length > 0) {
                        const demanda = demandasDia[0];
                        const corClass = `tipo-${demanda.id_tipodemanda}`;
                        const feriadoClass = feriado ? 'cell-feriado-com-demanda' : '';
                        html += `<td class="${corClass} ${feriadoClass} col-dia" onclick="abrirModalEditar(${demanda.id})">`;
                        html += '<div class="cell-content-veiculos">';
                        
                        // ID 9 (Oficina): mostra descri√ß√£o do tipo (negrito) e destino (regular)
                        if (demanda.id_tipodemanda === 9) {
                            html += `<div>${demanda.de_tipodemanda || 'Oficina'}</div>`;
                            if (demanda.destino) {
                                html += `<div><strong>${demanda.destino}</strong></div>`;
                            }
                        }

                        // ID 10 (Ced√™ncia): mostra descri√ß√£o do tipo (negrito), setor (negrito) e n¬∫ SEI (regular)
                        else if (demanda.id_tipodemanda === 10) {
                            html += `<div>${demanda.de_tipodemanda || 'Ced√™ncia'}<strong>${' - ' + demanda.setor || ''}</strong></div>`;
                            if (demanda.nu_sei) {
                                html += `<div>${demanda.nu_sei}</div>`;
                            }
                        }
                        // Outros tipos: formato padr√£o (motorista e n¬∫ SEI)
                        else {
                            html += `<div><strong>${demanda.nm_motorista || ''}</strong></div>`;
                            if (demanda.nu_sei) {
                                html += `<div>${demanda.nu_sei}</div>`;
                            }
                        }
                        
                        html += '</div></td>';
                    } else if (feriado) {
                        // C√©lula de feriado sem demanda
                        html += `<td class="cell-feriado col-dia" onclick="abrirModalNovoComVeiculo('${dia.data}', ${v.id})">${feriado.descricao}</td>`;
                    } else {
                        const isWeekend = dia.diaIndex === 0 || dia.diaIndex === 6;
                        const weekendClass = isWeekend ? 'weekend-empty' : '';
                        html += `<td class="empty-cell ${weekendClass} col-dia" onclick="abrirModalNovoComVeiculo('${dia.data}', ${v.id})"></td>`;
                    }
                });
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            return html;
        }
                
        function renderizarSecaoVeiculosAlocados(dias) {
            const demandasAlocadas = dadosAgenda.demandas.filter(d => d.id_tipoveiculo != 1 && d.id_tipoveiculo !== null);
            
            if (demandasAlocadas.length === 0) return '';
            
            const grupos = {};
            demandasAlocadas.forEach(d => {
                const key = `${d.de_tipoveiculo}|${d.nu_sei}|${d.setor}|${d.destino}|${d.id_tipoveiculo}`;
                if (!grupos[key]) {
                    grupos[key] = {
                        de_tipoveiculo: d.de_tipoveiculo,
                        nu_sei: d.nu_sei,
                        setor: d.setor,
                        destino: d.destino,
                        id_tipoveiculo: d.id_tipoveiculo,
                        demandas: []
                    };
                }
                grupos[key].demandas.push(d);
            });
            
            // Ordenar grupos: primeiro IDs 7, 8, 9, depois ordenar por DT_LANCAMENTO
            const gruposArray = Object.values(grupos);
            gruposArray.sort((a, b) => {
                const prioridadeA = [7, 8, 9].includes(a.id_tipoveiculo);
                const prioridadeB = [7, 8, 9].includes(b.id_tipoveiculo);
                
                // Se ambos s√£o priorit√°rios ou ambos n√£o s√£o, ordenar por data de lan√ßamento
                if (prioridadeA === prioridadeB) {
                    const dataA = a.demandas[0].dt_lancamento || '';
                    const dataB = b.demandas[0].dt_lancamento || '';
                    return dataB.localeCompare(dataA); // Mais recente primeiro
                }
                
                // Priorit√°rios (7, 8, 9) v√™m primeiro
                return prioridadeB - prioridadeA;
            });
            
            let html = '<div class="agenda-section">';
            html += '<div class="section-title">üöå SEGEOP - VE√çCULOS ALOCADOS</div>';
            html += '<table class="agenda-table"><thead><tr>';
            html += '<th class="col-numero">N.</th><th class="col-nome">Tipo Ve√≠culo / SEI / Destino</th>';
            dias.forEach(d => html += `<th class="col-dia">${d.diaNome}<br>${d.diaNum}/${d.mes}</th>`);
            html += '</tr></thead><tbody>';
            
            gruposArray.forEach((grupo, index) => {
                const isIdEspecial = [7, 8, 9].includes(grupo.id_tipoveiculo);
                
                html += `<tr><td class="col-numero">${index + 1}</td>`;
                html += `<td class="col-nome">`;
                html += `<div><strong>${grupo.de_tipoveiculo}</strong></div>`;
                html += `<div>${grupo.nu_sei || ''}</div>`;
                
                // Montar linha Setor - Destino com setor em negrito
                if (grupo.setor && grupo.destino) {
                    html += `<div><strong>${grupo.setor}</strong> - ${grupo.destino}</div>`;
                } else if (grupo.setor) {
                    html += `<div><strong>${grupo.setor}</strong></div>`;
                } else if (grupo.destino) {
                    html += `<div>${grupo.destino}</div>`;
                }
                
                // Verificar se existe loca√ß√£o finalizada
                const primeiraLocacao = locacoesAtivas.find(loc => 
                    loc.fl_status === 'F' && 
                    grupo.demandas.some(d => d.id_motorista === loc.id_motorista)
                );
                if (primeiraLocacao) {
                    html += `<div style="color: #6c757d; font-size: 11px; margin-top: 3px;">${primeiraLocacao.ds_veiculo_mod}</div>`;
                }
                
                html += `</td>`;
                
                dias.forEach(dia => {
                    const feriado = isFeriado(dia.data);
                    const demandasDia = grupo.demandas.filter(d => 
                        d.dt_inicio <= dia.data && 
                        d.dt_fim >= dia.data
                    );
                    
                    if (demandasDia.length > 0) {
                        const demanda = demandasDia[0];
                        
                        let corClass = '';
                        
                        if (isIdEspecial) {
                            // Para IDs 7, 8, 9: verificar se foi solicitado
                            corClass = demanda.solicitado === 'S' ? 'tipo-solicitado' : '';
                        } else {
                            // Para outros IDs: verificar se existe loca√ß√£o
                            const temLocacao = locacoesAtivas.some(loc => 
                                loc.id_motorista === demanda.id_motorista &&
                                loc.data_inicio <= dia.data &&
                                loc.data_fim >= dia.data
                            );
                            corClass = temLocacao ? 'tipo-locacao' : '';
                        }
                        
                        const feriadoClass = feriado ? 'cell-feriado-com-demanda' : '';
                        html += `<td class="${corClass} ${feriadoClass} col-dia" data-id-demanda="${demanda.id}" onclick="handleCellClick(event, ${demanda.id})">`;
                        html += '<div class="cell-content-veiculos">';
                        
                        if (isIdEspecial) {
                            // Para IDs 7, 8, 9: mostrar apenas setor e destino
                            if (demanda.setor) {
                                html += `<div><strong>${demanda.setor}</strong></div>`;
                            }
                            if (demanda.destino) {
                                html += `<div>${demanda.destino}</div>`;
                            }                            

                        } else {
                            // Para outros IDs: mostrar motorista e setor
                            html += `<div><strong>${demanda.nm_motorista || ''}</strong></div>`;
                            if (demanda.setor) {
                                html += `<div>${demanda.setor}</div>`;
                            }
                        }
                        
                        html += '</div></td>';
                    } else if (feriado) {
                        // C√©lula de feriado sem demanda
                        html += `<td class="cell-feriado col-dia">${feriado.descricao}</td>`;
                    } else {
                        const isWeekend = dia.diaIndex === 0 || dia.diaIndex === 6;
                        const weekendClass = isWeekend ? 'weekend-empty' : '';
                        html += `<td class="empty-cell ${weekendClass} col-dia"></td>`;
                    }
                });
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            return html;
        }
        
        async function abrirModalNovo() {
            document.getElementById('modalTitle').textContent = 'Nova Demanda';
            document.getElementById('idAd').value = '';
            document.getElementById('formDemanda').reset();
            document.getElementById('btnExcluir').style.display = 'none';
            veiculoSelecionadoOriginal = null;
            
            // Mostrar filtro e definir SEGEOP como padr√£o
            document.getElementById('motoristaFilter').style.display = 'flex';
            document.querySelector('input[name="tipoMotorista"][value="segeop"]').checked = true;
            
            // Ocultar checkbox Solicitado
            document.getElementById('divSolicitado').style.display = 'none';
            document.getElementById('solicitado').checked = false;
            
            preencherSelectMotoristas('segeop');
            
            // N√ÉO carregar ve√≠culos no in√≠cio
            const selectVeiculo = document.getElementById('idVeiculo');
            selectVeiculo.innerHTML = '<option value="">Selecione...</option>';
            selectVeiculo.disabled = true;
            
            // Resetar labels
            document.getElementById('labelTipoVeiculo').innerHTML = 'Tipo de Ve√≠culo';
            document.getElementById('labelVeiculo').innerHTML = 'Ve√≠culo';
            document.getElementById('labelSetor').innerHTML = 'Setor';
            document.getElementById('labelSolicitante').innerHTML = 'Solicitante';
            document.getElementById('labelDestino').innerHTML = 'Destino';
            
            // Habilitar todos os campos
            document.getElementById('idMotorista').disabled = false;
            document.getElementById('idTipoVeiculo').disabled = false;
            document.getElementById('setor').disabled = false;
            document.getElementById('solicitante').disabled = false;
            document.getElementById('destino').disabled = false;
            
            // Adicionar event listeners para o filtro
            document.querySelectorAll('input[name="tipoMotorista"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    preencherSelectMotoristas(this.value);
                });
            });
            
            document.getElementById('modal').style.display = 'block';
        }
        
        async function abrirModalNovoComData(data, idMotorista = null) {
            contextoAbertura = 'motorista'; // Definir ANTES
            await abrirModalNovo();
            await preencherSelectTiposDemanda(); // Carregar depois que contexto est√° definido
            document.getElementById('dtInicio').value = data;
            document.getElementById('dtFim').value = data;
            if (idMotorista) {
                document.getElementById('idMotorista').value = idMotorista;
            }
        }
        
        async function abrirModalNovoComVeiculo(data, idVeiculo = null) {
            contextoAbertura = 'veiculo'; // Definir ANTES
            await abrirModalNovo();
            await preencherSelectTiposDemanda(); // Carregar depois que contexto est√° definido
            document.getElementById('dtInicio').value = data;
            document.getElementById('dtFim').value = data;
            
            if (idVeiculo) {
                // Guardar o ve√≠culo que ser√° selecionado
                const veiculoObj = veiculos.find(v => v.id === idVeiculo);
                if (veiculoObj) {
                    veiculoSelecionadoOriginal = {
                        id: veiculoObj.id,
                        veiculo: veiculoObj.veiculo
                    };
                }
                
                // Selecionar Tipo de Ve√≠culo = 1 (Ve√≠culo Oficial)
                document.getElementById('idTipoVeiculo').value = '1';
                
                // Aplicar regras e aguardar carregar ve√≠culos dispon√≠veis
                aplicarRegrasTipoVeiculo();
                
                // Aguardar a lista de ve√≠culos ser atualizada e ent√£o selecionar
                setTimeout(async () => {
                    await atualizarVeiculosDisponiveis();
                    document.getElementById('idVeiculo').value = idVeiculo;
                }, 150);
            }
        }
        
        async function abrirModalNovoGeral() {
            contextoAbertura = null; // Sem contexto espec√≠fico
            await abrirModalNovo();
            await preencherSelectTiposDemanda(); // Carregar todos os tipos
        }

        async function abrirModalEditar(idAd) {
            const demanda = dadosAgenda.demandas.find(d => d.id === idAd);
            if (!demanda) return;
            
            document.getElementById('modalTitle').textContent = 'Editar Demanda';
            contextoAbertura = null;
            document.getElementById('idAd').value = demanda.id;
            document.getElementById('btnExcluir').style.display = 'inline-block';
            
            // Ocultar filtro na edi√ß√£o
            document.getElementById('motoristaFilter').style.display = 'none';
            
            // Guardar ve√≠culo original para manter na lista
            if (demanda.id_veiculo) {
                veiculoSelecionadoOriginal = {
                    id: demanda.id_veiculo,
                    veiculo: veiculos.find(v => v.id === demanda.id_veiculo)?.veiculo || ''
                };
            } else {
                veiculoSelecionadoOriginal = null;
            }
            
            preencherSelectMotoristas('todos');
            
            // Carregar tipos de demanda antes de preencher o formul√°rio
            await preencherSelectTiposDemanda();
            
            document.getElementById('idMotorista').value = demanda.id_motorista || '';
            document.getElementById('dtInicio').value = demanda.dt_inicio;
            document.getElementById('dtFim').value = demanda.dt_fim;
            document.getElementById('idTipoDemanda').value = demanda.id_tipodemanda;
            document.getElementById('idTipoVeiculo').value = demanda.id_tipoveiculo || '';
            document.getElementById('idVeiculo').value = demanda.id_veiculo || '';
            document.getElementById('setor').value = demanda.setor || '';
            document.getElementById('solicitante').value = demanda.solicitante || '';
            document.getElementById('destino').value = demanda.destino || '';
            document.getElementById('nuSei').value = demanda.nu_sei || '';
            document.getElementById('obs').value = demanda.obs || '';
            document.getElementById('solicitado').checked = demanda.solicitado === 'S';
            
            // Aplicar regras ap√≥s preencher
            aplicarRegrasTipoDemanda();
            aplicarRegrasTipoVeiculo();
            
            document.getElementById('modal').style.display = 'block';
        }
        
        function fecharModal() {
            document.getElementById('modal').style.display = 'none';
            veiculoSelecionadoOriginal = null;
        }
        
        function preencherSelectMotoristas(tipo = 'segeop') {
            const select = document.getElementById('idMotorista');
            select.innerHTML = '<option value="">Selecione...</option>';
            
            let motoristasFiltrados = motoristas;
            
            if (tipo === 'segeop') {
                // Motoristas SEGEOP (padr√£o atual)
                motoristasFiltrados = motoristas.filter(m => 
                    m.tipo === 'Motorista Atendimento' || m.tipo === 'Tercerizado'
                );
            } else if (tipo === 'outros') {
                // Outros motoristas ativos, exceto SEGEOP
                motoristasFiltrados = dadosAgenda.todos_motoristas.filter(m => 
                    m.tipo !== 'Motorista Atendimento' && m.tipo !== 'Tercerizado'
                );
            } else if (tipo === 'todos') {
                // Todos os motoristas ativos
                motoristasFiltrados = dadosAgenda.todos_motoristas || motoristas;
            }
            
            motoristasFiltrados.forEach(m => {
                select.innerHTML += `<option value="${m.id}">${m.nome}</option>`;
            });
        }
        
        function preencherSelectVeiculos() {
            const select = document.getElementById('idVeiculo');
            select.innerHTML = '<option value="">Selecione...</option>';
            veiculos.forEach(v => {
                select.innerHTML += `<option value="${v.id}">${v.veiculo}</option>`;
            });
        }
        
        async function preencherSelectTiposDemanda() {
            try {
                const selectTipoDemanda = document.getElementById('idTipoDemanda');
                const valorAtual = selectTipoDemanda.value; // Guardar valor atual para edi√ß√£o
                
                // Montar URL com contexto
                let url = '/api/agenda/tipos-demanda-filtrados';
                if (contextoAbertura) {
                    url += `?contexto=${contextoAbertura}`;
                }
                
                console.log('Carregando tipos com contexto:', contextoAbertura, 'URL:', url); // Debug
                
                const res = await fetch(url);
                const tipos = await res.json();
                
                console.log('Tipos carregados:', tipos); // Debug
                
                selectTipoDemanda.innerHTML = '<option value="">Selecione...</option>';
                tipos.forEach(t => {
                    selectTipoDemanda.innerHTML += `<option value="${t.id}" data-descricao="${t.descricao}">${t.descricao}</option>`;
                });
                
                // Restaurar valor na edi√ß√£o (se ainda existir nas op√ß√µes)
                if (valorAtual) {
                    const opcaoExiste = Array.from(selectTipoDemanda.options).some(opt => opt.value == valorAtual);
                    if (opcaoExiste) {
                        selectTipoDemanda.value = valorAtual;
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar tipos de demanda filtrados:', error);
            }
        }

        async function salvarDemanda() {
            const idAd = document.getElementById('idAd').value;
            const idTipoDemanda = parseInt(document.getElementById('idTipoDemanda').value);

            const dados = {
                id_motorista: document.getElementById('idMotorista').value || null,
                id_tipodemanda: idTipoDemanda,
                id_tipoveiculo: document.getElementById('idTipoVeiculo').value || null,
                id_veiculo: document.getElementById('idVeiculo').value || null,
                dt_inicio: document.getElementById('dtInicio').value,
                dt_fim: document.getElementById('dtFim').value,
                setor: document.getElementById('setor').value,
                solicitante: document.getElementById('solicitante').value,
                destino: document.getElementById('destino').value,
                nu_sei: document.getElementById('nuSei').value,
                obs: document.getElementById('obs').value,
                solicitado: document.getElementById('solicitado').checked ? 'S' : 'N',
                usuario: document.getElementById('usuario').value
            };
            
            // Valida√ß√µes obrigat√≥rias b√°sicas
            if (!dados.id_tipodemanda || !dados.dt_inicio || !dados.dt_fim) {
                alert('Preencha todos os campos obrigat√≥rios: Tipo de Demanda, Data In√≠cio e Data Fim!');
                return;
            }
            
            const idTipoVeiculo = parseInt(document.getElementById('idTipoVeiculo').value);
            
            // Valida√ß√£o de Motorista: obrigat√≥rio exceto para ID 9, 10 e IDs tipo ve√≠culo 7, 8, 9
            const dispensaMotorista = idTipoDemanda === 9 || idTipoDemanda === 10 || 
                                    idTipoVeiculo === 7 || idTipoVeiculo === 8 || idTipoVeiculo === 9;
            
            if (!dispensaMotorista && !dados.id_motorista) {
                alert('O campo Motorista √© obrigat√≥rio!');
                return;
            }
            
            // Valida√ß√£o para ID 10: Setor obrigat√≥rio
            if (idTipoDemanda === 10 && !dados.setor) {
                alert('Para Ced√™ncia, o campo Setor √© obrigat√≥rio!');
                return;
            }
            
            // Valida√ß√£o para ID 1 ou 2: Setor e Solicitante obrigat√≥rios
            if ((idTipoDemanda === 1 || idTipoDemanda === 2) && (!dados.setor || !dados.solicitante)) {
                alert('Para este tipo de demanda, Setor e Solicitante s√£o obrigat√≥rios!');
                return;
            }
            
            try {
                let res;
                if (idAd) {
                    res = await fetch(`/api/agenda/demanda/${idAd}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(dados)
                    });
                } else {
                    res = await fetch('/api/agenda/demanda', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(dados)
                    });
                }
                
                const result = await res.json();
                
                if (result.success || result.id) {
                    fecharModal();
                    await carregarSemanas();
                    await carregarAgenda();
                } else {
                    alert('Erro ao salvar: ' + (result.error || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao salvar demanda!');
            }
        }
        
        async function excluirDemanda() {
            const idAd = document.getElementById('idAd').value;
            if (!idAd) return;
            
            if (!confirm('Deseja realmente excluir esta demanda?')) return;
            
            try {
                const res = await fetch(`/api/agenda/demanda/${idAd}`, {
                    method: 'DELETE'
                });
                
                const result = await res.json();
                
                if (result.success) {
                    fecharModal();
                    await carregarSemanas();
                    await carregarAgenda();
                } else {
                    alert('Erro ao excluir: ' + (result.error || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao excluir demanda!');
            }
        }
        
        window.onclick = function(event) {
            const modal = document.getElementById('modal');
            if (event.target == modal) {
                fecharModal();
            }
        }

        document.addEventListener('click', function(event) {
            if (celulaSelecionada && !event.target.closest('.agenda-table')) {
                celulaSelecionada.classList.remove('cell-selected');
                celulaSelecionada = null;
            }
        });
        
        // Fechar modal de feriados ao clicar fora
        window.addEventListener('click', function(event) {
            const modalFeriados = document.getElementById('modalFeriados');
            if (event.target == modalFeriados) {
                fecharModalFeriados();
            }
        });

        init();
    </script>
</body>
</html>
