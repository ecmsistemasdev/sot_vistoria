<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda SEGEOP</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            padding-bottom: 20px;
            padding-top: 70px; /* ADICIONAR ESTA LINHA */
        }

        .container {
            max-width: 100%;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-top: 50px; /* ADICIONAR ESTA LINHA */
        }

        .header {
            background: #1a73e8;
            color: white;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 200;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-btn {
            background: white;
            color: #1a73e8;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .header-btn:hover {
            background: #f0f0f0;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .header h1 { 
            font-size: 18px; 
            margin: 0; 
        }

        .header .periodo {
            font-size: 14px;
            color: #fff9c4;
            font-weight: 500;
        }

        .agenda-wrapper {
            overflow-x: auto;
            padding: 20px;
        }

        .agenda-section {
            margin-bottom: 40px;
        }

        .section-title {
            background: #34495e;
            color: white;
            padding: 10px 15px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 4px 4px 0 0;
        }

        .agenda-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #ddd;
            table-layout: fixed;
        }

        .agenda-table th {
            background: #ecf0f1;
            padding: 10px;
            text-align: center;
            border: 1px solid #ddd;
            font-size: 13px;
            font-weight: 600;
        }

        .agenda-table td {
            border: 1px solid #ddd;
            padding: 6px;
            vertical-align: middle;
            font-size: 12px;
            position: relative;
            cursor: pointer;
            transition: background 0.2s;
            overflow: visible;
        }

        .cell-selected {
            filter: brightness(0.85);
            box-shadow: inset 0 0 0 2px #1a73e8;
        }

        .tipo-locacao {
            background: #c7a3e7 !important;
        }

        .motorista-filter {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .motorista-filter label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            font-weight: normal;
            font-size: 14px;
        }

        .motorista-filter input[type="radio"] {
            cursor: pointer;
            width: auto;
        }

        .motorista-inline-filter {
            display: flex;
            gap: 20px;
            margin-bottom: 8px;
            padding: 8px 0;
        }

        .motorista-inline-filter label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            font-weight: normal;
            font-size: 14px;
            margin: 0;
        }

        .motorista-inline-filter input[type="radio"] {
            cursor: pointer;
            width: auto;
            margin: 0;
        }

        #divSolicitado label {
            display: flex;
            align-items: center;
            font-weight: 600;
            cursor: pointer;
        }

        .tipo-solicitado {
            background: #c7a3e7 !important;
        }

        .agenda-table td:hover {
            background: #f8f9fa !important;
        }

        .col-numero {
            width: 40px;
            background: #f8f9fa;
            font-weight: 600;
            text-align: center;
        }

        .col-nome {
            width: 216px;
            background: #f8f9fa;
            font-weight: 600;
            word-wrap: break-word;
            white-space: normal;
        }

        .col-dia {
            width: calc((100% - 256px) / 7);
        }

        .cell-content {
            line-height: 1.4;
            min-height: 35px;
            height: auto;
            overflow: visible;
            font-size: 11px;
        }

        .cell-content-veiculos {
            line-height: 1.4;
            min-height: 30px;
            height: auto;
            overflow: visible;
            font-size: 11px;
        }

        .cell-content div {
            margin-bottom: 2px;
        }

        .informar-veiculo {
            color: #dc3545;
            font-style: italic;
            font-size: 10px;
        }

        /* Cores por tipo de demanda */
        .tipo-1 { background: #5fa1df; }
        .tipo-2 { background: #79f183; }
        .tipo-3 { background: #f8c295; }
        .tipo-4, .tipo-5 { background: #f8c295; }
        .tipo-6, .tipo-7, .tipo-8 { 
            background: #f3f183; 
            font-weight: bold;
        }
        .tipo-9 { 
            background: #fa8484 !important;
            font-weight: bold;
        }
        .tipo-10 { 
            background: hsl(320, 96%, 79%) !important;
            font-weight: bold;
        }

        .empty-cell {
            background: #fafafa;
        }

        .empty-cell.weekend-empty {
            background: #e0e0e0;
        }

        /* FOOTER COM TABS ESTILO EXCEL/DELPHI */
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #e8e8e8;
            padding: 0;
            border-top: 1px solid #c0c0c0;
            display: flex;
            justify-content: flex-start;
            align-items: flex-start;
            gap: 0;
            z-index: 100;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
            height: 45px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
            margin: 10px 0 10px 15px;
            align-self: flex-start;
        }

        .btn-primary {
            background: #1a73e8;
            color: white;
        }

        .btn-primary:hover { background: #1557b0; }

        /* .footer-divider {
            width: 1px;
            height: 40px;
            background: #c0c0c0;
            margin: 0 10px;
            align-self: center;
        } */

        /* TABS NAVEGAÇÃO ESTILO EXCEL */
        .week-tabs-wrapper {
            display: flex;
            align-items: flex-start;
            gap: 0;
            flex: 1;
            overflow: hidden;
            height: 100%;
            background: #e8e8e8;
            padding-bottom: 0;
        }

        .week-nav-btn {
            background: #f0f0f0;
            /* border: 1px solid #c0c0c0; */
            border: 1px solid #c0c0c0 !important;
            /* border-bottom: none; */
            cursor: pointer;
            padding: 8px 10px;
            font-size: 10px;
            transition: all 0.2s;
            flex-shrink: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 2px 2px 0 8px;
            align-self: flex-start;
        }

        .week-nav-btn:hover:not(:disabled) {
            background: #fff;
        }

        .week-nav-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background: #e0e0e0;
        }

        .week-tabs-scroll {
            display: flex;
            gap: 0;
            overflow-x: auto;
            overflow-y: hidden;
            scroll-behavior: smooth;
            flex: 1;
            height: 100%;
            align-items: flex-start;
            background: #e8e8e8;
            padding: 0 4px 0 0;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .week-tabs-scroll::-webkit-scrollbar {
            display: none;
        }

        .week-tabs-container {
            display: inline-flex;
            gap: -1px;
            flex-wrap: nowrap;
            align-items: flex-start;
            height: 100%;
            padding: 0;
            margin: 0;
        }

        .week-tab {
            padding: 10px 20px;
            background: #d4d4d4;
            border: 1px solid #c0c0c0;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.15s;
            white-space: nowrap;
            flex-shrink: 0;
            user-select: none;
            display: inline-flex;
            align-items: center;
            height: 32px;
            margin: 0;
            border-radius: 0 0 6px 6px;  /* MANTÉM: arredondado embaixo */
            border-top: none;  /* SEM borda em cima */
            border-bottom: 1px solid #c0c0c0;  /* COM borda embaixo */
            position: relative;
            color: #333;
            font-weight: 500;
        }

        .week-tab:hover:not(.active) {
            background: #e8e8e8;
            border-color: #b0b0b0;
            z-index: 1;
        }

        .week-tab.active {
            /* background: #ffffff; */
            background: #99ff14;
            color: #000;
            border-color: #c0c0c0;
            border-top: none;  /* SEM borda em cima */
            border-bottom: 1px solid #c0c0c0;  /* COM borda embaixo */
            font-weight: 600;
            z-index: 2;
            height: 35px;
            padding: 10px 22px;
            margin-top: 0;
            margin-bottom: 0;  /* SEM margin negativo */
        }

        .week-tab.active::before {
            content: '';
            position: absolute;
            top: -1px;  /* NO topo */
            left: 0;
            right: 0;
            height: 2px;
            /* background: #ffffff; 
            background: #fc7e08; 
            background: #ffff33;  */
            background: #1fc909; 
        }

        .week-tab:not(.active) {
            box-shadow: inset 0 -2px 3px rgba(0,0,0,0.05);
        }

        /* MODALS */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 0;
            width: 90%;
            max-width: 600px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            animation: slideDown 0.3s;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes slideDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            background: #1a73e8;
            color: white;
            padding: 10px 20px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .modal-header h2 { 
            font-size: 16px;
            margin: 0;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: white;
            opacity: 0.8;
        }

        .close:hover { opacity: 1; }

        .modal-body {
            padding: 15px 20px;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 600;
            font-size: 13px;
            color: #333;
        }

        .form-group label .required {
            color: #dc3545;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }

        .form-group input:disabled,
        .form-group select:disabled {
            background: #e9ecef;
            cursor: not-allowed;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 50px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .modal-footer {
            padding: 12px 20px;
            background: #f8f9fa;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            border-radius: 0 0 8px 8px;
            position: sticky;
            bottom: 0;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover { background: #5a6268; }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover { background: #c82333; }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        /* .header-icon {
            cursor: pointer;
            font-size: 20px;
            opacity: 0.85;
            transition: opacity 0.2s, transform 0.2s;
            margin-left: auto;
            padding: 5px 10px;
            text-decoration: none;
            color: white;
        }

        .header-icon:hover {
            opacity: 1;
            transform: scale(1.1);
        } */

        .feriados-container {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .feriado-form {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .feriado-form-row {
            display: grid;
            grid-template-columns: 2fr 2fr 1fr;
            gap: 10px;
            align-items: end;
        }

        .feriados-lista {
            max-height: 400px;
            overflow-y: auto;
        }

        .feriado-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            margin-bottom: 8px;
            transition: background 0.2s;
        }

        .feriado-item:hover {
            background: #f8f9fa;
        }

        .feriado-info {
            flex: 1;
        }

        .feriado-descricao {
            font-weight: 600;
            color: #333;
            margin-bottom: 3px;
        }

        .feriado-data {
            font-size: 12px;
            color: #666;
        }

        .btn-icon {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            padding: 5px 10px;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .btn-icon:hover {
            opacity: 1;
        }

        .cell-feriado {
            background: #fdfcb2 !important;
            font-weight: bold;
            font-size: 11px;
            text-align: center;
            vertical-align: middle;
        }

        .cell-feriado-com-demanda {
            position: relative;
        }

        .cell-feriado-com-demanda::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(243, 241, 131, 0.3) 10px,
                rgba(243, 241, 131, 0.3) 20px
            );
            pointer-events: none;
        }

        #horario:disabled {
            background: #e9ecef;
            cursor: not-allowed;
        }
        
        .demanda-horario {
            font-size: 10px;
            color: #666;
            font-style: italic;
        }
        
        .cell-divider {
            border-top: 1px dashed #999;
            margin: 5px 0;
            padding-top: 5px;
        }

        .veiculo-extra {
            background: #fffacd !important; /* Cor amarelo claro */
        }
        
        .col-nome.veiculo-extra {
            background: #fffacd !important;
            font-style: italic;
        }
        
        .col-numero.veiculo-extra {
            background: #fffacd !important;
        }
        
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1>📅 AGENDA SEGEOP</h1>
                <span class="periodo" id="semanaAtual"></span>
            </div>
            <div class="header-right">
                <button class="header-btn" onclick="abrirModalNovoGeral()" title="Nova Demanda">
                    ➕ Nova Demanda
                </button>
                <button class="header-btn" onclick="abrirModalFeriados()" title="Gerenciar Feriados">
                    🗓️
                </button>                
            </div>
        </div>

        <div class="agenda-wrapper" id="agendaWrapper">
            <div class="loading">⏳ Carregando agenda...</div>
        </div>
    </div>
    
    <div class="footer">
        <div class="week-tabs-wrapper">
            <button class="week-nav-btn" id="btnPrevWeek" onclick="scrollWeekTabs(-1)" title="Anterior">◀</button>
            <div class="week-tabs-scroll" id="weekTabsScroll">
                <div class="week-tabs-container" id="weekTabs"></div>
            </div>
            <button class="week-nav-btn" id="btnNextWeek" onclick="scrollWeekTabs(1)" title="Próxima">▶</button>
        </div>
    </div>
    
    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Nova Demanda</h2>
                <span class="close" onclick="fecharModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="formDemanda">
                    <input type="hidden" id="idAd" value="">
                    
                    <!-- Linha 1: Tipo de Demanda e Tipo de Veículo -->
                    <div class="form-row">
                        <div class="form-group">
                            <label>Tipo de Demanda <span class="required">*</span></label>
                            <select id="idTipoDemanda" required></select>
                        </div>
                        <div class="form-group">
                            <label id="labelTipoVeiculo">Tipo de Veículo</label>
                            <select id="idTipoVeiculo"></select>
                        </div>
                    </div>
                    
                    <!-- Linha 2: Motorista com Radio Inline -->
                    <div class="form-group">
                        <label id="labelMotorista">Motorista <span class="required">*</span></label>
                        <div class="motorista-inline-filter" id="motoristaFilter">
                            <label>
                                <input type="radio" name="tipoMotorista" value="segeop" checked> SEGEOP
                            </label>
                            <label>
                                <input type="radio" name="tipoMotorista" value="todos"> Todos
                            </label>
                        </div>
                        <select id="idMotorista" required></select>
                    </div>
                    
                    <!-- Linha 3: Datas -->
                    <div class="form-row">
                        <div class="form-group">
                            <label>Data Início <span class="required">*</span></label>
                            <input type="date" id="dtInicio" required>
                        </div>
                        <div class="form-group">
                            <label>Data Fim <span class="required">*</span></label>
                            <input type="date" id="dtFim" required>
                        </div>
                    </div>
                    
                    <!-- Linha 4: Checkbox Horário e Input Horário -->
                    <div class="form-row">
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="definirHorario" style="width: auto; margin-right: 8px;" onchange="toggleHorario()">
                                Definir Horário
                            </label>
                        </div>
                        <div class="form-group">
                            <label>Horário</label>
                            <input type="text" id="horario" maxlength="5" placeholder="HH:MM" disabled>
                        </div>
                    </div>

                    <!-- Linha 5: Veículo -->
                    <div class="form-group">
                        <label id="labelVeiculo">Veículo</label>
                        <select id="idVeiculo"></select>
                    </div>

                    <div class="form-group" id="divExpandirVeiculos" style="display: none;">
                        <label>
                            <input type="checkbox" id="expandirVeiculos" style="width: auto; margin-right: 8px;" onchange="toggleExpandirVeiculos()">
                            Expandir para todos os veículos da frota
                        </label>
                    </div>
                    
                    <!-- Linha 6: Setor e Solicitante -->
                    <div class="form-row">
                        <div class="form-group">
                            <label id="labelSetor">Setor</label>
                            <input type="text" id="setor" maxlength="35">
                        </div>
                        <div class="form-group">
                            <label id="labelSolicitante">Solicitante</label>
                            <input type="text" id="solicitante" maxlength="30">
                        </div>
                    </div>
                    
                    <!-- Linha 7: Destino e Nº SEI -->
                    <div class="form-row">
                        <div class="form-group">
                            <label id="labelDestino">Destino</label>
                            <input type="text" id="destino" maxlength="25">
                        </div>    
                        <div class="form-group">
                            <label>Nº SEI</label>
                            <input type="text" id="nuSei" maxlength="25">
                        </div>
                    </div>
                    
                    <!-- Linha 8: Observações -->
                    <div class="form-group">
                        <label>Observações</label>
                        <textarea id="obs" maxlength="200" rows="3"></textarea>
                    </div>
                    
                    <!-- Checkbox Solicitado (oculto por padrão) -->
                    <div class="form-group" id="divSolicitado" style="display: none;">
                        <label>
                            <input type="checkbox" id="solicitado" style="width: auto; margin-right: 8px;">
                            Solicitado
                        </label>
                    </div>
                    
                    <input type="hidden" id="usuario" value="ADMIN">
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="fecharModal()">Cancelar</button>
                <button class="btn btn-danger" id="btnExcluir" onclick="excluirDemanda()" style="display:none;">🗑️ Excluir</button>
                <button class="btn btn-primary" onclick="salvarDemanda()">💾 Salvar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal Feriados -->
    <div id="modalFeriados" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🗓️ Gerenciar Feriados</h2>
                <span class="close" onclick="fecharModalFeriados()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="feriados-container">
                    <!-- Formulário de Inclusão -->
                    <div class="feriado-form">
                        <div class="feriado-form-row">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Tipo</label>
                                <select id="tipoFeriado">
                                    <option value="Feriado">FERIADO</option>
                                    <option value="Ponto Facultativo">PONTO FACULTATIVO</option>
                                    <option value="Outro">OUTRO</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Data</label>
                                <input type="date" id="dataFeriado" required>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>&nbsp;</label>
                                <button class="btn btn-primary" onclick="adicionarFeriado()">➕ Adicionar</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Lista de Feriados -->
                    <div class="feriados-lista" id="feriadosLista">
                        <div class="loading">Carregando feriados...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let semanas = [];
        let semanaAtual = 0;
        let dadosAgenda = null;
        let motoristas = [];
        let veiculos = [];
        let tiposDemanda = [];
        let tiposVeiculo = [];
        let veiculoSelecionadoOriginal = null;
        let celulaSelecionada = null;
        let locacoesAtivas = [];
        let contextoAbertura = null; // 'motorista', 'veiculo' ou null
        let feriadosPeriodo = [];
        let scrollPosition = 0;
        let veiculosExtras = [];
        let listaVeiculosExpandida = false;        

        // Máscara para o campo horário
        function aplicarMascaraHorario(input) {
            let valor = input.value.replace(/\D/g, '');
            
            if (valor.length >= 2) {
                valor = valor.substring(0, 2) + ':' + valor.substring(2, 4);
            }
            
            input.value = valor;
        }
        
        // Toggle do campo horário
        function toggleHorario() {
            const checkbox = document.getElementById('definirHorario');
            const inputHorario = document.getElementById('horario');
            
            if (checkbox.checked) {
                inputHorario.disabled = false;
                inputHorario.focus();
            } else {
                inputHorario.disabled = true;
                inputHorario.value = '';
            }
        }
        
        // Validar formato de horário
        function validarHorario(horario) {
            if (!horario) return true; // Vazio é válido
            
            const regex = /^([0-1][0-9]|2[0-3]):([0-5][0-9])$/;
            return regex.test(horario);
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // Máscara de horário
            const inputHorario = document.getElementById('horario');
            if (inputHorario) {
                inputHorario.addEventListener('input', function() {
                    aplicarMascaraHorario(this);
                });
            }
            
            // Event listeners para datas (atualizar lista expandida)
            const dtInicio = document.getElementById('dtInicio');
            const dtFim = document.getElementById('dtFim');
            
            if (dtInicio && dtFim) {
                dtInicio.addEventListener('change', function() {
                    const expandirCheckbox = document.getElementById('expandirVeiculos');
                    const idTipoVeiculo = document.getElementById('idTipoVeiculo').value;
                    
                    if (idTipoVeiculo === '1' && expandirCheckbox.checked) {
                        toggleExpandirVeiculos();
                    }
                });
                
                dtFim.addEventListener('change', function() {
                    const expandirCheckbox = document.getElementById('expandirVeiculos');
                    const idTipoVeiculo = document.getElementById('idTipoVeiculo').value;
                    
                    if (idTipoVeiculo === '1' && expandirCheckbox.checked) {
                        toggleExpandirVeiculos();
                    }
                });
            }
        });
        
        async function init() {
            await carregarSemanas();
            await carregarSelectsFixos();
            if (semanas.length > 0) {
                const hoje = new Date();
                hoje.setHours(0, 0, 0, 0);
                
                let semanaEncontrada = -1;
                for (let i = 0; i < semanas.length; i++) {
                    const inicio = new Date(semanas[i].inicio + 'T00:00:00');
                    const fim = new Date(semanas[i].fim + 'T00:00:00');
                    
                    if (hoje >= inicio && hoje <= fim) {
                        semanaEncontrada = i;
                        break;
                    }
                }
                
                semanaAtual = semanaEncontrada !== -1 ? semanaEncontrada : semanas.length - 1;
                await carregarLocacoes();
                await carregarFeriadosPeriodo();
                await carregarAgenda();
            }
        }

        // Carregar feriados do período atual
        async function carregarFeriadosPeriodo() {
            try {
                const semana = semanas[semanaAtual];
                const res = await fetch(`/api/agenda/feriados-periodo?inicio=${semana.inicio}&fim=${semana.fim}`);
                feriadosPeriodo = await res.json();
            } catch (error) {
                console.error('Erro ao carregar feriados do período:', error);
                feriadosPeriodo = [];
            }
        }

        // Abrir modal de feriados
        async function abrirModalFeriados() {
            document.getElementById('modalFeriados').style.display = 'block';
            await carregarListaFeriados();
        }

        // Fechar modal de feriados
        function fecharModalFeriados() {
            document.getElementById('modalFeriados').style.display = 'none';
        }

        // Carregar lista de todos os feriados
        async function carregarListaFeriados() {
            const lista = document.getElementById('feriadosLista');
            lista.innerHTML = '<div class="loading">Carregando...</div>';
            
            try {
                const res = await fetch('/api/agenda/feriados');
                const feriados = await res.json();
                
                if (feriados.length === 0) {
                    lista.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Nenhum feriado cadastrado</div>';
                    return;
                }
                
                lista.innerHTML = feriados.map(f => {
                    const data = new Date(f.dt_feriado + 'T00:00:00');
                    const dataFormatada = data.toLocaleDateString('pt-BR', { 
                        day: '2-digit', 
                        month: '2-digit', 
                        year: 'numeric',
                        weekday: 'short'
                    });
                    
                    return `
                        <div class="feriado-item">
                            <div class="feriado-info">
                                <div class="feriado-descricao">${f.descricao}</div>
                                <div class="feriado-data">${dataFormatada}</div>
                            </div>
                            <button class="btn-icon" onclick="excluirFeriado(${f.id})" title="Excluir">🗑️</button>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Erro ao carregar lista de feriados:', error);
                lista.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">Erro ao carregar feriados</div>';
            }
        }

        // Adicionar novo feriado
        async function adicionarFeriado() {
            const tipo = document.getElementById('tipoFeriado').value;
            const data = document.getElementById('dataFeriado').value;
            
            if (!data) {
                alert('Informe a data do feriado!');
                return;
            }
            
            try {
                const res = await fetch('/api/agenda/feriado', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        descricao: tipo,
                        dt_feriado: data
                    })
                });
                
                const result = await res.json();
                
                if (result.success) {
                    document.getElementById('dataFeriado').value = '';
                    await carregarListaFeriados();
                    await carregarFeriadosPeriodo();
                    await carregarAgenda();
                }
            } catch (error) {
                console.error('Erro ao adicionar feriado:', error);
            }
        }

        // Excluir feriado
        async function excluirFeriado(id) {
            try {
                const res = await fetch(`/api/agenda/feriado/${id}`, {
                    method: 'DELETE'
                });
                
                const result = await res.json();
                
                if (result.success) {
                    await carregarListaFeriados();
                    await carregarFeriadosPeriodo();
                    await carregarAgenda();
                }
            } catch (error) {
                console.error('Erro ao excluir feriado:', error);
            }
        }

        // Verificar se uma data é feriado
        function isFeriado(data) {
            return feriadosPeriodo.find(f => f.dt_feriado === data);
        }


        async function carregarLocacoes() {
            try {
                const semana = semanas[semanaAtual];
                const res = await fetch(`/api/agenda/locacoes?inicio=${semana.inicio}&fim=${semana.fim}`);
                locacoesAtivas = await res.json();
            } catch (error) {
                console.error('Erro ao carregar locações:', error);
                locacoesAtivas = [];
            }
        }
        
        async function carregarSemanas() {
            try {
                const res = await fetch('/api/agenda/semanas');
                const data = await res.json();
                
                if (data.error) {
                    console.error('Erro na API:', data.error);
                    semanas = data.semanas || [];
                } else if (Array.isArray(data)) {
                    semanas = data;
                } else {
                    semanas = [];
                }
                
                renderizarAbas();
            } catch (error) {
                console.error('Erro ao carregar semanas:', error);
                semanas = [];
                const hoje = new Date();
                const domingo = new Date(hoje);
                domingo.setDate(hoje.getDate() - ((hoje.getDay() + 7) % 7));
                const sabado = new Date(domingo);
                sabado.setDate(domingo.getDate() + 6);
                
                semanas = [{
                    inicio: domingo.toISOString().split('T')[0],
                    fim: sabado.toISOString().split('T')[0],
                    label: `${domingo.getDate()}/${domingo.getMonth()+1} - ${sabado.getDate()}/${sabado.getMonth()+1}/${sabado.getFullYear()}`
                }];
                renderizarAbas();
            }
        }
        
        async function carregarSelectsFixos() {
            try {
                const [resTiposDemanda, resTiposVeiculo] = await Promise.all([
                    fetch('/api/agenda/tipos-demanda'),
                    fetch('/api/agenda/tipos-veiculo')
                ]);
                
                tiposDemanda = await resTiposDemanda.json();
                tiposVeiculo = await resTiposVeiculo.json();
                
                const selectTipoDemanda = document.getElementById('idTipoDemanda');
                const selectTipoVeiculo = document.getElementById('idTipoVeiculo');
                
                selectTipoDemanda.innerHTML = '<option value="">Selecione...</option>';
                tiposDemanda.forEach(t => {
                    selectTipoDemanda.innerHTML += `<option value="${t.id}" data-descricao="${t.descricao}">${t.descricao}</option>`;
                });
                
                selectTipoVeiculo.innerHTML = '<option value="">Selecione...</option>';
                tiposVeiculo.forEach(t => {
                    selectTipoVeiculo.innerHTML += `<option value="${t.id}">${t.descricao}</option>`;
                });
                
                // Event listeners para regras de negócio
                selectTipoDemanda.addEventListener('change', aplicarRegrasTipoDemanda);
                selectTipoVeiculo.addEventListener('change', aplicarRegrasTipoVeiculo);
                document.getElementById('dtInicio').addEventListener('change', atualizarVeiculosDisponiveis);
                document.getElementById('dtFim').addEventListener('change', atualizarVeiculosDisponiveis);
            } catch (error) {
                console.error('Erro ao carregar selects:', error);
            }
        }
        
        function aplicarRegrasTipoDemanda() {
            const idTipoDemanda = parseInt(document.getElementById('idTipoDemanda').value);
            const selectTipoDemanda = document.getElementById('idTipoDemanda');
            const optionSelecionada = selectTipoDemanda.options[selectTipoDemanda.selectedIndex];
            const descricaoTipoDemanda = optionSelecionada ? optionSelecionada.getAttribute('data-descricao') : '';
            
            const motorista = document.getElementById('idMotorista');
            const tipoVeiculo = document.getElementById('idTipoVeiculo');
            const veiculo = document.getElementById('idVeiculo');
            const setor = document.getElementById('setor');
            const solicitante = document.getElementById('solicitante');
            const destino = document.getElementById('destino');
            
            const labelTipoVeiculo = document.getElementById('labelTipoVeiculo');
            const labelVeiculo = document.getElementById('labelVeiculo');
            const labelSetor = document.getElementById('labelSetor');
            const labelSolicitante = document.getElementById('labelSolicitante');
            const labelDestino = document.getElementById('labelDestino');
            const labelMotorista = document.getElementById('labelMotorista');
            
            // Resetar labels
            labelTipoVeiculo.innerHTML = 'Tipo de Veículo';
            labelVeiculo.innerHTML = 'Veículo';
            labelSetor.innerHTML = 'Setor';
            labelSolicitante.innerHTML = 'Solicitante';
            labelDestino.innerHTML = 'Destino';
            
            if (labelMotorista) {
                labelMotorista.innerHTML = 'Motorista <span class="required">*</span>';
            }
            
            // Habilitar todos primeiro
            motorista.disabled = false;
            motorista.required = true;
            tipoVeiculo.disabled = false;
            veiculo.disabled = false;
            setor.disabled = false;
            solicitante.disabled = false;
            destino.disabled = false;
            
            if (idTipoDemanda === 10) {
                // ID 10 (Cedência): Fecha Motorista, abre Setor (obrigatório), abre Solicitante (não obrigatório)
                motorista.disabled = true;
                motorista.required = false;
                motorista.value = '';
                if (labelMotorista) {
                    labelMotorista.innerHTML = 'Motorista';
                }
                
                // Setor obrigatório
                setor.disabled = false;
                labelSetor.innerHTML = 'Setor <span class="required">*</span>';
                
                // Solicitante aberto mas não obrigatório
                solicitante.disabled = false;
                
            } else if (idTipoDemanda === 9) {
                // ID 9 (Oficina): Fecha Motorista, Setor, Solicitante
                motorista.disabled = true;
                motorista.required = false;
                motorista.value = '';
                if (labelMotorista) {
                    labelMotorista.innerHTML = 'Motorista';
                }               
                setor.disabled = true;
                setor.value = '';
                solicitante.disabled = true;
                solicitante.value = '';
                
            } else if (idTipoDemanda >= 6 && idTipoDemanda <= 8) {
                // ID 6-8: Fecha e desobriga Tipo Veículo, Veículo, Setor, Solicitante, Destino
                tipoVeiculo.disabled = true;
                tipoVeiculo.value = '';
                veiculo.disabled = true;
                veiculo.value = '';
                setor.disabled = true;
                setor.value = '';
                solicitante.disabled = true;
                solicitante.value = '';
                destino.disabled = true;
                if (!destino.value) {
                    destino.value = descricaoTipoDemanda;
                }
            } else if (idTipoDemanda === 4 || idTipoDemanda === 5) {
                // ID 4-5: Setor e Solicitante podem ficar em branco, Destino = DE_TIPODEMANDA
                if (!destino.value) {
                    destino.value = descricaoTipoDemanda;
                }
            } else if (idTipoDemanda === 3) {
                // ID 3: Setor e Solicitante podem ficar em branco, Destino usuário preenche
                // Não preenche automaticamente
            } else if (idTipoDemanda === 1 || idTipoDemanda === 2) {
                // ID 1-2: Setor e Solicitante obrigatórios
                labelSetor.innerHTML = 'Setor <span class="required">*</span>';
                labelSolicitante.innerHTML = 'Solicitante <span class="required">*</span>';
            }
        }
                
        function aplicarRegrasTipoVeiculo() {
            const idTipoVeiculo = parseInt(document.getElementById('idTipoVeiculo').value);
            const veiculo = document.getElementById('idVeiculo');
            const motorista = document.getElementById('idMotorista');
            const divSolicitado = document.getElementById('divSolicitado');
            const divExpandirVeiculos = document.getElementById('divExpandirVeiculos');
            const labelMotorista = document.getElementById('labelMotorista');
            
            // Ocultar checkbox Solicitado e Expandir Veículos por padrão
            divSolicitado.style.display = 'none';
            divExpandirVeiculos.style.display = 'none';
            
            if (!idTipoVeiculo) {
                veiculo.disabled = false;
                veiculo.innerHTML = '<option value="">Selecione...</option>';
                return;
            }
            
            // IDs 7, 8, 9: Bloqueia motorista e veículo, exibe checkbox Solicitado
            if (idTipoVeiculo === 7 || idTipoVeiculo === 8 || idTipoVeiculo === 9) {
                motorista.disabled = true;
                motorista.required = false;
                motorista.value = '';
                if (labelMotorista) {
                    labelMotorista.innerHTML = 'Motorista';
                }
                
                veiculo.disabled = true;
                veiculo.value = '';
                
                // Exibir checkbox Solicitado
                divSolicitado.style.display = 'block';
                
            } else if (idTipoVeiculo !== 1) {
                // Tipo diferente de 1 e não é 7, 8, 9: bloqueia veículo
                veiculo.disabled = true;
                veiculo.value = '';
            } else {
                // Tipo 1: habilita e carrega veículos disponíveis
                veiculo.disabled = false;
                
                // MOSTRAR checkbox de expandir veículos
                divExpandirVeiculos.style.display = 'block';
                
                const dtInicio = document.getElementById('dtInicio').value;
                const dtFim = document.getElementById('dtFim').value;
                
                if (dtInicio && dtFim) {
                    // Se tem datas, carrega veículos disponíveis
                    if (listaVeiculosExpandida) {
                        toggleExpandirVeiculos();
                    } else {
                        atualizarVeiculosDisponiveis();
                    }
                } else {
                    // Se não tem datas, carrega todos os veículos ou padrão
                    if (listaVeiculosExpandida) {
                        toggleExpandirVeiculos();
                    } else {
                        preencherSelectVeiculos();
                    }
                }
            }
        }

        
        async function atualizarVeiculosDisponiveis() {
            const idTipoVeiculo = parseInt(document.getElementById('idTipoVeiculo').value);
            const dtInicio = document.getElementById('dtInicio').value;
            const dtFim = document.getElementById('dtFim').value;
            const selectVeiculo = document.getElementById('idVeiculo');
            const idAd = document.getElementById('idAd').value;
            const temHorario = document.getElementById('definirHorario').checked;
            
            // Só atualiza se for tipo veículo 1 e tiver datas
            if (idTipoVeiculo !== 1 || !dtInicio || !dtFim) {
                return;
            }
            
            try {
                let url = `/api/agenda/veiculos-disponiveis?inicio=${dtInicio}&fim=${dtFim}&tem_horario=${temHorario}`;
                if (idAd) {
                    url += `&id_demanda=${idAd}`;
                }
                
                const res = await fetch(url);
                const veiculosDisponiveis = await res.json();
                
                const veiculoAtual = selectVeiculo.value;
                
                selectVeiculo.innerHTML = '<option value="">Selecione...</option>';
                
                // Adiciona veículos disponíveis
                veiculosDisponiveis.forEach(v => {
                    selectVeiculo.innerHTML += `<option value="${v.id}">${v.veiculo}</option>`;
                });
                
                // Se tinha um veículo selecionado e ele não está na lista, adiciona
                if (veiculoAtual && veiculoSelecionadoOriginal) {
                    const existe = Array.from(selectVeiculo.options).some(opt => opt.value == veiculoAtual);
                    if (!existe) {
                        selectVeiculo.innerHTML += `<option value="${veiculoSelecionadoOriginal.id}">${veiculoSelecionadoOriginal.veiculo}</option>`;
                    }
                    selectVeiculo.value = veiculoAtual;
                }
            } catch (error) {
                console.error('Erro ao carregar veículos disponíveis:', error);
            }
        }
        
        function renderizarAbas() {
            const tabs = document.getElementById('weekTabs');
            tabs.innerHTML = semanas.map((s, i) => 
                `<div class="week-tab ${i === semanaAtual ? 'active' : ''}" 
                    onclick="mudarSemana(${i})">${s.label}</div>`
            ).join('');
            
            // Scroll para a aba ativa após renderizar
            setTimeout(() => {
                scrollToActiveTab();
                atualizarBotoesNavegacao();
            }, 100);
        }
        
        async function mudarSemana(index) {
            semanaAtual = index;
            renderizarAbas();
            await carregarFeriadosPeriodo();
            await carregarAgenda();
        }
        
        async function carregarAgenda() {
            const wrapper = document.getElementById('agendaWrapper');
            wrapper.innerHTML = '<div class="loading">⏳ Carregando agenda...</div>';
            
            try {
                const semana = semanas[semanaAtual];
                await carregarLocacoes();
                const res = await fetch(`/api/agenda/dados?inicio=${semana.inicio}&fim=${semana.fim}`);
                dadosAgenda = await res.json();
                
                motoristas = dadosAgenda.motoristas;
                veiculos = dadosAgenda.veiculos;
                veiculosExtras = dadosAgenda.veiculos_extras || [];
                
                document.getElementById('semanaAtual').textContent = semana.label;
                
                renderizarAgenda();
            } catch (error) {
                wrapper.innerHTML = '<div class="loading">❌ Erro ao carregar agenda</div>';
                console.error('Erro:', error);
            }
        }

        // Nova função para toggle de expandir veículos
        async function toggleExpandirVeiculos() {
            const checkbox = document.getElementById('expandirVeiculos');
            const selectVeiculo = document.getElementById('idVeiculo');
            const dtInicio = document.getElementById('dtInicio').value;
            const dtFim = document.getElementById('dtFim').value;
            const idAd = document.getElementById('idAd').value;
            const temHorario = document.getElementById('definirHorario').checked;
            
            listaVeiculosExpandida = checkbox.checked;
            
            if (!dtInicio || !dtFim) {
                if (listaVeiculosExpandida) {
                    // Carregar todos os veículos sem filtro de data
                    try {
                        const res = await fetch(`/api/agenda/veiculos-todos?tem_horario=${temHorario}`);
                        const todosVeiculos = await res.json();
                        
                        const veiculoAtual = selectVeiculo.value;
                        selectVeiculo.innerHTML = '<option value="">Selecione...</option>';
                        
                        todosVeiculos.forEach(v => {
                            selectVeiculo.innerHTML += `<option value="${v.id}">${v.veiculo}</option>`;
                        });
                        
                        if (veiculoAtual) {
                            selectVeiculo.value = veiculoAtual;
                        }
                    } catch (error) {
                        console.error('Erro ao carregar todos os veículos:', error);
                    }
                } else {
                    // Voltar para lista padrão
                    preencherSelectVeiculos();
                }
                return;
            }
        
            // Se tem datas, carregar com filtro
            if (listaVeiculosExpandida) {
                try {
                    let url = `/api/agenda/veiculos-todos?inicio=${dtInicio}&fim=${dtFim}&tem_horario=${temHorario}`;
                    if (idAd) {
                        url += `&id_demanda=${idAd}`;
                    }
                    
                    const res = await fetch(url);
                    const todosVeiculos = await res.json();
                    
                    const veiculoAtual = selectVeiculo.value;
                    selectVeiculo.innerHTML = '<option value="">Selecione...</option>';
                    
                    todosVeiculos.forEach(v => {
                        selectVeiculo.innerHTML += `<option value="${v.id}">${v.veiculo}</option>`;
                    });
                    
                    if (veiculoAtual && veiculoSelecionadoOriginal) {
                        const existe = Array.from(selectVeiculo.options).some(opt => opt.value == veiculoAtual);
                        if (!existe) {
                            selectVeiculo.innerHTML += `<option value="${veiculoSelecionadoOriginal.id}">${veiculoSelecionadoOriginal.veiculo}</option>`;
                        }
                        selectVeiculo.value = veiculoAtual;
                    }
                } catch (error) {
                    console.error('Erro ao carregar todos os veículos:', error);
                }
            } else {
                // Voltar para lista padrão com filtro de disponibilidade
                await atualizarVeiculosDisponiveis();
            }
        }

    
        function renderizarAgenda() {
            const semana = semanas[semanaAtual];
            const dias = gerarDiasSemana(semana.inicio);
            
            let html = '';
            
            html += renderizarSecaoMotoristas(dias);
            html += renderizarSecaoVeiculos(dias);
            html += renderizarSecaoVeiculosAlocados(dias);
            
            document.getElementById('agendaWrapper').innerHTML = html;
        }
        
        function gerarDiasSemana(inicioStr) {
            const dias = [];
            const inicio = new Date(inicioStr + 'T00:00:00');
            
            for (let i = 0; i < 7; i++) {
                const d = new Date(inicio);
                d.setDate(inicio.getDate() + i);
                dias.push({
                    data: d.toISOString().split('T')[0],
                    diaNum: d.getDate(),
                    mes: d.getMonth() + 1,
                    diaNome: ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'][d.getDay()],
                    diaIndex: d.getDay()
                });
            }
            return dias;
        }
        
        function renderizarSecaoMotoristas(dias) {
            let html = '<div class="agenda-section">';
            html += '<div class="section-title">🚗 SEGEOP - MOTORISTAS</div>';
            html += '<table class="agenda-table"><thead><tr>';
            html += '<th class="col-numero">N.</th><th class="col-nome">Nome</th>';
            dias.forEach(d => html += `<th class="col-dia">${d.diaNome}<br>${d.diaNum}/${d.mes}</th>`);
            html += '</tr></thead><tbody>';
            
            motoristas.forEach((m, index) => {
                html += `<tr><td class="col-numero">${index + 1}</td>`;
                html += `<td class="col-nome">${m.nome}</td>`;
                
                dias.forEach(dia => {
                    const feriado = isFeriado(dia.data);
                    const demandasDia = dadosAgenda.demandas.filter(d => 
                        d.id_motorista === m.id && 
                        d.dt_inicio <= dia.data && 
                        d.dt_fim >= dia.data
                    );
                    
                    if (demandasDia.length > 0) {
                        const demanda = demandasDia[0];
                        const corClass = `tipo-${demanda.id_tipodemanda}`;
                        const feriadoClass = feriado ? 'cell-feriado-com-demanda' : '';
                        html += `<td class="${corClass} ${feriadoClass} col-dia" data-id-demanda="${demanda.id}" onclick="handleCellClick(event, ${demanda.id})">`;
                        html += '<div class="cell-content">';
                        
                        // ID 9 (Oficina): mostra descrição do tipo (negrito) e destino (regular)
                        if (demanda.id_tipodemanda === 9) {
                            html += `<div><strong>${demanda.de_tipodemanda || 'Oficina'}</strong></div>`;
                            if (demanda.destino) {
                                html += `<div>${demanda.destino}</div>`;
                            }
                        }
                        // ID 10 (Cedência): mostra descrição do tipo (negrito), setor (negrito) e nº SEI (regular)
                        else if (demanda.id_tipodemanda === 10) {
                            html += `<div><strong>${demanda.de_tipodemanda || 'Cedência'}</strong></div>`;
                            if (demanda.setor) {
                                html += `<div><strong>${demanda.setor}</strong></div>`;
                            }
                            if (demanda.nu_sei) {
                                html += `<div>${demanda.nu_sei}</div>`;
                            }
                        }
                        // ID 1 ou 2 com horário: mostrar horário após destino
                        else if ((demanda.id_tipodemanda === 1 || demanda.id_tipodemanda === 2) && demanda.horario) {
                            html += `<div><strong>${demanda.setor || ''}</strong>${demanda.solicitante ? ' (' + demanda.solicitante + ')' : ''}</div>`;
                            html += `<div>${demanda.destino || ''} <span class="demanda-horario">(${demanda.horario})</span></div>`;
                            html += `<div>${demanda.nu_sei || ''}</div>`;
                        }
                        // Outros tipos: formato padrão
                        else {
                            html += `<div><strong>${demanda.setor || ''}</strong>${demanda.solicitante ? ' (' + demanda.solicitante + ')' : ''}</div>`;
                            html += `<div>${demanda.destino || ''}</div>`;
                            html += `<div>${demanda.nu_sei || ''}</div>`;
                        }
                        
                        // Mostrar (INFORMAR VEÍCULO) se não tiver tipo de veículo
                        if (!demanda.id_tipoveiculo && ![6, 7, 8, 9, 10].includes(demanda.id_tipodemanda)) {
                            html += '<div class="informar-veiculo">(INFORMAR VEÍCULO)</div>';
                        }                        
                        
                        html += '</div></td>';
                    } else if (feriado) {
                        // Célula de feriado sem demanda
                        html += `<td class="cell-feriado col-dia" onclick="abrirModalNovoComData('${dia.data}', ${m.id})">${feriado.descricao}</td>`;
                    } else {
                        const isWeekend = dia.diaIndex === 0 || dia.diaIndex === 6;
                        const weekendClass = isWeekend ? 'weekend-empty' : '';
                        html += `<td class="empty-cell ${weekendClass} col-dia" onclick="abrirModalNovoComData('${dia.data}', ${m.id})"></td>`;
                    }
                });
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            return html;
        }
        
        function handleCellClick(event, idDemanda) {
            event.stopPropagation();
            const cell = event.currentTarget;
            
            // Se a célula clicada já está selecionada, abre o modal de edição
            if (cell.classList.contains('cell-selected')) {
                abrirModalEditar(idDemanda);
                return;
            }
            
            // Remove seleção anterior
            if (celulaSelecionada) {
                celulaSelecionada.classList.remove('cell-selected');
            }
            
            // Seleciona a célula atual
            cell.classList.add('cell-selected');
            celulaSelecionada = cell;
        }
                        
        function renderizarSecaoVeiculos(dias) {
            let html = '<div class="agenda-section">';
            html += '<div class="section-title">🚙 SEGEOP - VEÍCULOS OFICIAIS</div>';
            html += '<table class="agenda-table"><thead><tr>';
            html += '<th class="col-numero">N.</th><th class="col-nome">Veículo</th>';
            dias.forEach(d => html += `<th class="col-dia">${d.diaNome}<br>${d.diaNum}/${d.mes}</th>`);
            html += '</tr></thead><tbody>';
            
            // Combinar veículos padrão com extras que têm demandas
            const todosVeiculos = [...veiculos];
            
            // Adicionar veículos extras que têm demandas na semana atual
            veiculosExtras.forEach(vExtra => {
                const temDemanda = dadosAgenda.demandas.some(d => 
                    d.id_veiculo === vExtra.id &&
                    dias.some(dia => d.dt_inicio <= dia.data && d.dt_fim >= dia.data)
                );
                
                if (temDemanda) {
                    todosVeiculos.push({
                        ...vExtra,
                        isExtra: true
                    });
                }
            });
            
            // Criar mapa de veículos com linhas duplicadas se necessário
            const veiculosComLinhas = [];
            
            todosVeiculos.forEach(v => {
                // Para cada dia, verificar quantas demandas diferentes existem
                const maxDemandasPorDia = Math.max(...dias.map(dia => {
                    const demandasDia = dadosAgenda.demandas.filter(d => 
                        d.id_veiculo === v.id && 
                        d.dt_inicio <= dia.data && 
                        d.dt_fim >= dia.data
                    );
                    return demandasDia.length;
                }));
                
                // Se há mais de uma demanda em algum dia, criar linhas duplicadas
                const numLinhas = maxDemandasPorDia > 0 ? maxDemandasPorDia : 1;
                
                for (let linha = 0; linha < numLinhas; linha++) {
                    veiculosComLinhas.push({
                        veiculo: v,
                        linhaIndex: linha,
                        totalLinhas: numLinhas
                    });
                }
            });
            
            veiculosComLinhas.forEach((item, index) => {
                const v = item.veiculo;
                const linhaIndex = item.linhaIndex;
                const totalLinhas = item.totalLinhas;
                const extraClass = v.isExtra ? 'veiculo-extra' : '';
                
                html += `<tr>`;
                
                // Mostrar número e nome apenas na primeira linha de cada veículo
                if (linhaIndex === 0) {
                    const veiculoIndex = todosVeiculos.findIndex(vei => vei.id === v.id) + 1;
                    if (totalLinhas > 1) {
                        html += `<td class="col-numero ${extraClass}" rowspan="${totalLinhas}">${veiculoIndex}</td>`;
                        html += `<td class="col-nome ${extraClass}" rowspan="${totalLinhas}">${v.veiculo}</td>`;
                    } else {
                        html += `<td class="col-numero ${extraClass}">${veiculoIndex}</td>`;
                        html += `<td class="col-nome ${extraClass}">${v.veiculo}</td>`;
                    }
                }
                
                dias.forEach(dia => {
                    const feriado = isFeriado(dia.data);
                    const isWeekend = dia.diaIndex === 0 || dia.diaIndex === 6;
                    const demandasDia = dadosAgenda.demandas.filter(d => 
                        d.id_veiculo === v.id && 
                        d.dt_inicio <= dia.data && 
                        d.dt_fim >= dia.data
                    );
                    
                    // Pegar a demanda correspondente a esta linha
                    const demanda = demandasDia[linhaIndex];
                    
                    if (demanda) {
                        const corClass = `tipo-${demanda.id_tipodemanda}`;
                        const feriadoClass = feriado ? 'cell-feriado-com-demanda' : '';
                        html += `<td class="${corClass} ${feriadoClass} col-dia" onclick="abrirModalEditar(${demanda.id})">`;
                        html += '<div class="cell-content-veiculos">';
                        
                        // ID 9 (Oficina): mostra descrição do tipo (negrito) e destino (regular)
                        if (demanda.id_tipodemanda === 9) {
                            html += `<div>${demanda.de_tipodemanda || 'Oficina'}</div>`;
                            if (demanda.destino) {
                                html += `<div><strong>${demanda.destino}</strong></div>`;
                            }
                        }
                        // ID 10 (Cedência): mostra descrição do tipo (negrito), setor (negrito) e nº SEI (regular)
                        else if (demanda.id_tipodemanda === 10) {
                            html += `<div>${demanda.de_tipodemanda || 'Cedência'}<strong>${' - ' + demanda.setor || ''}</strong></div>`;
                            if (demanda.nu_sei) {
                                html += `<div>${demanda.nu_sei}</div>`;
                            }
                        }
                        // ID 1 ou 2 com horário: mostrar destino com horário
                        else if ((demanda.id_tipodemanda === 1 || demanda.id_tipodemanda === 2) && demanda.horario) {
                            html += `<div><strong>${demanda.nm_motorista || ''}</strong></div>`;
                            if (demanda.nu_sei) {
                                html += `<div>${demanda.nu_sei}</div>`;
                            }
                            if (demanda.destino) {
                                html += `<div>${demanda.destino} <span class="demanda-horario">(${demanda.horario})</span></div>`;
                            }
                        }
                        // Outros tipos: formato padrão (motorista e nº SEI)
                        else {
                            html += `<div><strong>${demanda.nm_motorista || ''}</strong></div>`;
                            if (demanda.nu_sei) {
                                html += `<div>${demanda.nu_sei}</div>`;
                            }
                        }
                        
                        html += '</div></td>';
                    } else if (demandasDia.length === 0) {
                        // Todas as linhas devem mostrar feriado ou final de semana corretamente
                        if (feriado) {
                            if (linhaIndex === 0) {
                                html += `<td class="cell-feriado col-dia" onclick="abrirModalNovoComVeiculo('${dia.data}', ${v.id})">${feriado.descricao}</td>`;
                            } else {
                                html += `<td class="cell-feriado col-dia">${feriado.descricao}</td>`;
                            }
                        } else {
                            const weekendClass = isWeekend ? 'weekend-empty' : '';
                            if (linhaIndex === 0) {
                                html += `<td class="empty-cell ${weekendClass} col-dia" onclick="abrirModalNovoComVeiculo('${dia.data}', ${v.id})"></td>`;
                            } else {
                                html += `<td class="empty-cell ${weekendClass} col-dia"></td>`;
                            }
                        }
                    } else {
                        // Linhas extras quando há menos demandas que o total de linhas
                        if (feriado) {
                            html += `<td class="cell-feriado col-dia">${feriado.descricao}</td>`;
                        } else {
                            const weekendClass = isWeekend ? 'weekend-empty' : '';
                            html += `<td class="empty-cell ${weekendClass} col-dia"></td>`;
                        }
                    }
                });
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            return html;
        }
                
        function renderizarSecaoVeiculosAlocados(dias) {
            const demandasAlocadas = dadosAgenda.demandas.filter(d => d.id_tipoveiculo != 1 && d.id_tipoveiculo !== null);
            
            if (demandasAlocadas.length === 0) return '';
            
            const grupos = {};
            demandasAlocadas.forEach(d => {
                const key = `${d.de_tipoveiculo}|${d.nu_sei}|${d.setor}|${d.destino}|${d.id_tipoveiculo}`;
                if (!grupos[key]) {
                    grupos[key] = {
                        de_tipoveiculo: d.de_tipoveiculo,
                        nu_sei: d.nu_sei,
                        setor: d.setor,
                        destino: d.destino,
                        id_tipoveiculo: d.id_tipoveiculo,
                        demandas: []
                    };
                }
                grupos[key].demandas.push(d);
            });
            
            // Ordenar grupos: primeiro IDs 7, 8, 9, depois ordenar por DT_LANCAMENTO
            const gruposArray = Object.values(grupos);
            gruposArray.sort((a, b) => {
                const prioridadeA = [7, 8, 9].includes(a.id_tipoveiculo);
                const prioridadeB = [7, 8, 9].includes(b.id_tipoveiculo);
                
                // Se ambos são prioritários ou ambos não são, ordenar por data de lançamento
                if (prioridadeA === prioridadeB) {
                    const dataA = a.demandas[0].dt_lancamento || '';
                    const dataB = b.demandas[0].dt_lancamento || '';
                    return dataB.localeCompare(dataA); // Mais recente primeiro
                }
                
                // Prioritários (7, 8, 9) vêm primeiro
                return prioridadeB - prioridadeA;
            });
            
            let html = '<div class="agenda-section">';
            html += '<div class="section-title">🚌 SEGEOP - VEÍCULOS ALOCADOS</div>';
            html += '<table class="agenda-table"><thead><tr>';
            html += '<th class="col-numero">N.</th><th class="col-nome">Tipo Veículo / SEI / Destino</th>';
            dias.forEach(d => html += `<th class="col-dia">${d.diaNome}<br>${d.diaNum}/${d.mes}</th>`);
            html += '</tr></thead><tbody>';
            
            gruposArray.forEach((grupo, index) => {
                const isIdEspecial = [7, 8, 9].includes(grupo.id_tipoveiculo);
                
                html += `<tr><td class="col-numero">${index + 1}</td>`;
                html += `<td class="col-nome">`;
                html += `<div><strong>${grupo.de_tipoveiculo}</strong></div>`;
                html += `<div>${grupo.nu_sei || ''}</div>`;
                
                // Montar linha Setor - Destino com setor em negrito
                if (grupo.setor && grupo.destino) {
                    html += `<div><strong>${grupo.setor}</strong> - ${grupo.destino}</div>`;
                } else if (grupo.setor) {
                    html += `<div><strong>${grupo.setor}</strong></div>`;
                } else if (grupo.destino) {
                    html += `<div>${grupo.destino}</div>`;
                }
                
                // Verificar se existe locação finalizada
                const primeiraLocacao = locacoesAtivas.find(loc => 
                    loc.fl_status === 'F' && 
                    grupo.demandas.some(d => d.id_motorista === loc.id_motorista)
                );
                if (primeiraLocacao) {
                    html += `<div style="color: #6c757d; font-size: 11px; margin-top: 3px;">${primeiraLocacao.ds_veiculo_mod}</div>`;
                }
                
                html += `</td>`;
                
                dias.forEach(dia => {
                    const feriado = isFeriado(dia.data);
                    const demandasDia = grupo.demandas.filter(d => 
                        d.dt_inicio <= dia.data && 
                        d.dt_fim >= dia.data
                    );
                    
                    if (demandasDia.length > 0) {
                        const demanda = demandasDia[0];
                        
                        let corClass = '';
                        
                        if (isIdEspecial) {
                            // Para IDs 7, 8, 9: verificar se foi solicitado
                            corClass = demanda.solicitado === 'S' ? 'tipo-solicitado' : '';
                        } else {
                            // Para outros IDs: verificar se existe locação
                            const temLocacao = locacoesAtivas.some(loc => 
                                loc.id_motorista === demanda.id_motorista &&
                                loc.data_inicio <= dia.data &&
                                loc.data_fim >= dia.data
                            );
                            corClass = temLocacao ? 'tipo-locacao' : '';
                        }
                        
                        const feriadoClass = feriado ? 'cell-feriado-com-demanda' : '';
                        html += `<td class="${corClass} ${feriadoClass} col-dia" data-id-demanda="${demanda.id}" onclick="handleCellClick(event, ${demanda.id})">`;
                        html += '<div class="cell-content-veiculos">';
                        
                        if (isIdEspecial) {
                            // Para IDs 7, 8, 9: mostrar apenas setor e destino
                            if (demanda.setor) {
                                html += `<div><strong>${demanda.setor}</strong></div>`;
                            }
                            if (demanda.destino) {
                                html += `<div>${demanda.destino}</div>`;
                            }                            

                        } else {
                            // Para outros IDs: mostrar motorista e setor
                            html += `<div><strong>${demanda.nm_motorista || ''}</strong></div>`;
                            if (demanda.setor) {
                                html += `<div>${demanda.setor}</div>`;
                            }
                        }
                        
                        html += '</div></td>';
                    } else if (feriado) {
                        // Célula de feriado sem demanda
                        html += `<td class="cell-feriado col-dia">${feriado.descricao}</td>`;
                    } else {
                        const isWeekend = dia.diaIndex === 0 || dia.diaIndex === 6;
                        const weekendClass = isWeekend ? 'weekend-empty' : '';
                        html += `<td class="empty-cell ${weekendClass} col-dia"></td>`;
                    }
                });
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            return html;
        }
                        
        async function abrirModalNovo() {
            document.getElementById('modalTitle').textContent = 'Nova Demanda';
            document.getElementById('idAd').value = '';
            document.getElementById('formDemanda').reset();
            document.getElementById('btnExcluir').style.display = 'none';
            veiculoSelecionadoOriginal = null;
            listaVeiculosExpandida = false;
            
            // Reset de horário
            document.getElementById('definirHorario').checked = false;
            document.getElementById('definirHorario').disabled = false;
            document.getElementById('horario').value = '';
            document.getElementById('horario').disabled = true;
            
            // Reset checkbox expandir veículos
            document.getElementById('expandirVeiculos').checked = false;
            document.getElementById('divExpandirVeiculos').style.display = 'none';
            
            // Mostrar filtro e definir SEGEOP como padrão
            document.getElementById('motoristaFilter').style.display = 'flex';
            document.querySelector('input[name="tipoMotorista"][value="segeop"]').checked = true;
            
            // Ocultar checkbox Solicitado
            document.getElementById('divSolicitado').style.display = 'none';
            document.getElementById('solicitado').checked = false;
            
            preencherSelectMotoristas('segeop');
            
            // NÃO carregar veículos no início
            const selectVeiculo = document.getElementById('idVeiculo');
            selectVeiculo.innerHTML = '<option value="">Selecione...</option>';
            selectVeiculo.disabled = true;
            
            // Resetar labels
            document.getElementById('labelTipoVeiculo').innerHTML = 'Tipo de Veículo';
            document.getElementById('labelVeiculo').innerHTML = 'Veículo';
            document.getElementById('labelSetor').innerHTML = 'Setor';
            document.getElementById('labelSolicitante').innerHTML = 'Solicitante';
            document.getElementById('labelDestino').innerHTML = 'Destino';
            
            // Habilitar todos os campos
            document.getElementById('idMotorista').disabled = false;
            document.getElementById('idTipoVeiculo').disabled = false;
            document.getElementById('setor').disabled = false;
            document.getElementById('solicitante').disabled = false;
            document.getElementById('destino').disabled = false;
            
            // Adicionar event listeners para o filtro
            document.querySelectorAll('input[name="tipoMotorista"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    preencherSelectMotoristas(this.value);
                });
            });
            
            document.getElementById('modal').style.display = 'block';
        }
        
        async function abrirModalNovoComData(data, idMotorista = null) {
            contextoAbertura = 'motorista'; // Definir ANTES
            await abrirModalNovo();
            await preencherSelectTiposDemanda(); // Carregar depois que contexto está definido
            document.getElementById('dtInicio').value = data;
            document.getElementById('dtFim').value = data;
            if (idMotorista) {
                document.getElementById('idMotorista').value = idMotorista;
            }
        }
        
        async function abrirModalNovoComVeiculo(data, idVeiculo = null) {
            contextoAbertura = 'veiculo'; // Definir ANTES
            await abrirModalNovo();
            await preencherSelectTiposDemanda(); // Carregar depois que contexto está definido
            document.getElementById('dtInicio').value = data;
            document.getElementById('dtFim').value = data;
            
            if (idVeiculo) {
                // Guardar o veículo que será selecionado
                const veiculoObj = veiculos.find(v => v.id === idVeiculo);
                if (veiculoObj) {
                    veiculoSelecionadoOriginal = {
                        id: veiculoObj.id,
                        veiculo: veiculoObj.veiculo
                    };
                }
                
                // Selecionar Tipo de Veículo = 1 (Veículo Oficial)
                document.getElementById('idTipoVeiculo').value = '1';
                
                // Aplicar regras e aguardar carregar veículos disponíveis
                aplicarRegrasTipoVeiculo();
                
                // Aguardar a lista de veículos ser atualizada e então selecionar
                setTimeout(async () => {
                    await atualizarVeiculosDisponiveis();
                    document.getElementById('idVeiculo').value = idVeiculo;
                }, 150);
            }
        }
        
        async function abrirModalNovoGeral() {
            contextoAbertura = null; // Sem contexto específico
            await abrirModalNovo();
            await preencherSelectTiposDemanda(); // Carregar todos os tipos
        }

        async function abrirModalEditar(idAd) {
            const demanda = dadosAgenda.demandas.find(d => d.id === idAd);
            if (!demanda) return;
            
            document.getElementById('modalTitle').textContent = 'Editar Demanda';
            contextoAbertura = null;
            document.getElementById('idAd').value = demanda.id;
            document.getElementById('btnExcluir').style.display = 'inline-block';
            
            // Definir se lista está expandida
            listaVeiculosExpandida = demanda.todos_veiculos === 'S';
            
            // Ocultar filtro na edição
            document.getElementById('motoristaFilter').style.display = 'none';
            
            // Guardar veículo original para manter na lista
            if (demanda.id_veiculo) {
                // Procurar primeiro nos veículos padrão
                let veiculoObj = veiculos.find(v => v.id === demanda.id_veiculo);
                
                // Se não encontrou, procurar nos veículos extras
                if (!veiculoObj) {
                    veiculoObj = veiculosExtras.find(v => v.id === demanda.id_veiculo);
                }
                
                // Se ainda não encontrou, buscar diretamente (caso seja um veículo que não está em nenhuma lista)
                if (!veiculoObj && dadosAgenda.demandas) {
                    const todasDemandas = dadosAgenda.demandas.filter(d => d.id_veiculo === demanda.id_veiculo);
                    if (todasDemandas.length > 0) {
                        // Criar objeto temporário com dados da demanda
                        veiculoObj = {
                            id: demanda.id_veiculo,
                            veiculo: `Veículo ID ${demanda.id_veiculo}` // Placeholder
                        };
                    }
                }
                
                if (veiculoObj) {
                    veiculoSelecionadoOriginal = {
                        id: veiculoObj.id,
                        veiculo: veiculoObj.veiculo
                    };
                }
            } else {
                veiculoSelecionadoOriginal = null;
            }
            
            preencherSelectMotoristas('todos');
            
            // Carregar tipos de demanda antes de preencher o formulário
            await preencherSelectTiposDemanda();
            
            document.getElementById('idMotorista').value = demanda.id_motorista || '';
            document.getElementById('dtInicio').value = demanda.dt_inicio;
            document.getElementById('dtFim').value = demanda.dt_fim;
            document.getElementById('idTipoDemanda').value = demanda.id_tipodemanda;
            document.getElementById('idTipoVeiculo').value = demanda.id_tipoveiculo || '';
            document.getElementById('setor').value = demanda.setor || '';
            document.getElementById('solicitante').value = demanda.solicitante || '';
            document.getElementById('destino').value = demanda.destino || '';
            document.getElementById('nuSei').value = demanda.nu_sei || '';
            document.getElementById('obs').value = demanda.obs || '';
            document.getElementById('solicitado').checked = demanda.solicitado === 'S';
            
            // Carregar horário
            if (demanda.horario) {
                document.getElementById('definirHorario').checked = true;
                document.getElementById('definirHorario').disabled = false;
                document.getElementById('horario').value = demanda.horario;
                document.getElementById('horario').disabled = false;
            } else {
                document.getElementById('definirHorario').checked = false;
                document.getElementById('definirHorario').disabled = false;
                document.getElementById('horario').value = '';
                document.getElementById('horario').disabled = true;
            }
            
            // Aplicar regras após preencher
            aplicarRegrasTipoDemanda();
            aplicarRegrasTipoVeiculo();
            
            // Configurar checkbox expandir veículos
            document.getElementById('expandirVeiculos').checked = listaVeiculosExpandida;
            
            // Se tipo veículo é 1, carregar lista apropriada
            if (demanda.id_tipoveiculo === 1) {
                if (listaVeiculosExpandida) {
                    await toggleExpandirVeiculos();
                } else {
                    await atualizarVeiculosDisponiveis();
                }
                
                // Selecionar veículo após carregar lista
                setTimeout(() => {
                    document.getElementById('idVeiculo').value = demanda.id_veiculo || '';
                }, 200);
            } else {
                document.getElementById('idVeiculo').value = demanda.id_veiculo || '';
            }
            
            document.getElementById('modal').style.display = 'block';
        }

        function fecharModal() {
            document.getElementById('modal').style.display = 'none';
            veiculoSelecionadoOriginal = null;
        }
        
        function preencherSelectMotoristas(tipo = 'segeop') {
            const select = document.getElementById('idMotorista');
            select.innerHTML = '<option value="">Selecione...</option>';
            
            let motoristasFiltrados = motoristas;
            
            if (tipo === 'segeop') {
                // Motoristas SEGEOP (padrão atual)
                motoristasFiltrados = motoristas.filter(m => 
                    m.tipo === 'Motorista Atendimento' || m.tipo === 'Tercerizado'
                );
            } else if (tipo === 'outros') {
                // Outros motoristas ativos, exceto SEGEOP
                motoristasFiltrados = dadosAgenda.todos_motoristas.filter(m => 
                    m.tipo !== 'Motorista Atendimento' && m.tipo !== 'Tercerizado'
                );
            } else if (tipo === 'todos') {
                // Todos os motoristas ativos
                motoristasFiltrados = dadosAgenda.todos_motoristas || motoristas;
            }
            
            motoristasFiltrados.forEach(m => {
                select.innerHTML += `<option value="${m.id}">${m.nome}</option>`;
            });
        }
        
        function preencherSelectVeiculos() {
            const select = document.getElementById('idVeiculo');
            const veiculoAtual = select.value;
            
            select.innerHTML = '<option value="">Selecione...</option>';
            veiculos.forEach(v => {
                select.innerHTML += `<option value="${v.id}">${v.veiculo}</option>`;
            });
            
            // Restaurar veículo selecionado se existir
            if (veiculoAtual && veiculoSelecionadoOriginal) {
                const existe = Array.from(select.options).some(opt => opt.value == veiculoAtual);
                if (existe) {
                    select.value = veiculoAtual;
                } else {
                    // Se não existe na lista, adiciona
                    select.innerHTML += `<option value="${veiculoSelecionadoOriginal.id}">${veiculoSelecionadoOriginal.veiculo}</option>`;
                    select.value = veiculoAtual;
                }
            }
        }
        
        async function preencherSelectTiposDemanda() {
            try {
                const selectTipoDemanda = document.getElementById('idTipoDemanda');
                const valorAtual = selectTipoDemanda.value; // Guardar valor atual para edição
                
                // Montar URL com contexto
                let url = '/api/agenda/tipos-demanda-filtrados';
                if (contextoAbertura) {
                    url += `?contexto=${contextoAbertura}`;
                }
                
                console.log('Carregando tipos com contexto:', contextoAbertura, 'URL:', url); // Debug
                
                const res = await fetch(url);
                const tipos = await res.json();
                
                console.log('Tipos carregados:', tipos); // Debug
                
                selectTipoDemanda.innerHTML = '<option value="">Selecione...</option>';
                tipos.forEach(t => {
                    selectTipoDemanda.innerHTML += `<option value="${t.id}" data-descricao="${t.descricao}">${t.descricao}</option>`;
                });
                
                // Restaurar valor na edição (se ainda existir nas opções)
                if (valorAtual) {
                    const opcaoExiste = Array.from(selectTipoDemanda.options).some(opt => opt.value == valorAtual);
                    if (opcaoExiste) {
                        selectTipoDemanda.value = valorAtual;
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar tipos de demanda filtrados:', error);
            }
        }

        async function salvarDemanda() {
            const idAd = document.getElementById('idAd').value;
            const idTipoDemanda = parseInt(document.getElementById('idTipoDemanda').value);
            const definirHorario = document.getElementById('definirHorario').checked;
            const horario = document.getElementById('horario').value;
            const expandirVeiculos = document.getElementById('expandirVeiculos').checked;
        
            // Validar horário se checkbox estiver marcado
            if (definirHorario) {
                if (!horario) {
                    alert('Informe o horário!');
                    return;
                }
                if (!validarHorario(horario)) {
                    alert('Horário inválido! Use o formato HH:MM (ex: 08:30)');
                    return;
                }
            }
        
            const dados = {
                id_motorista: document.getElementById('idMotorista').value || null,
                id_tipodemanda: idTipoDemanda,
                id_tipoveiculo: document.getElementById('idTipoVeiculo').value || null,
                id_veiculo: document.getElementById('idVeiculo').value || null,
                dt_inicio: document.getElementById('dtInicio').value,
                dt_fim: document.getElementById('dtFim').value,
                setor: document.getElementById('setor').value,
                solicitante: document.getElementById('solicitante').value,
                destino: document.getElementById('destino').value,
                nu_sei: document.getElementById('nuSei').value,
                obs: document.getElementById('obs').value,
                solicitado: document.getElementById('solicitado').checked ? 'S' : 'N',
                horario: definirHorario ? horario : '',
                todos_veiculos: expandirVeiculos ? 'S' : 'N',
                usuario: document.getElementById('usuario').value
            };
            
            // Validações obrigatórias básicas
            if (!dados.id_tipodemanda || !dados.dt_inicio || !dados.dt_fim) {
                alert('Preencha todos os campos obrigatórios: Tipo de Demanda, Data Início e Data Fim!');
                return;
            }
            
            const idTipoVeiculo = parseInt(document.getElementById('idTipoVeiculo').value);
            
            // Validação de Motorista: obrigatório exceto para ID 9, 10 e IDs tipo veículo 7, 8, 9
            const dispensaMotorista = idTipoDemanda === 9 || idTipoDemanda === 10 || 
                                    idTipoVeiculo === 7 || idTipoVeiculo === 8 || idTipoVeiculo === 9;
            
            if (!dispensaMotorista && !dados.id_motorista) {
                alert('O campo Motorista é obrigatório!');
                return;
            }
            
            // Validação para ID 10: Setor obrigatório
            if (idTipoDemanda === 10 && !dados.setor) {
                alert('Para Cedência, o campo Setor é obrigatório!');
                return;
            }
            
            // Validação para ID 1 ou 2: Setor e Solicitante obrigatórios
            if ((idTipoDemanda === 1 || idTipoDemanda === 2) && (!dados.setor || !dados.solicitante)) {
                alert('Para este tipo de demanda, Setor e Solicitante são obrigatórios!');
                return;
            }
            
            try {
                let res;
                if (idAd) {
                    res = await fetch(`/api/agenda/demanda/${idAd}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(dados)
                    });
                } else {
                    res = await fetch('/api/agenda/demanda', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(dados)
                    });
                }
                
                const result = await res.json();
                
                if (result.success || result.id) {
                    fecharModal();
                    await carregarSemanas();
                    await carregarAgenda();
                } else {
                    alert('Erro ao salvar: ' + (result.error || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao salvar demanda!');
            }
        }
        
        async function excluirDemanda() {
            const idAd = document.getElementById('idAd').value;
            if (!idAd) return;
            
            if (!confirm('Deseja realmente excluir esta demanda?')) return;
            
            try {
                const res = await fetch(`/api/agenda/demanda/${idAd}`, {
                    method: 'DELETE'
                });
                
                const result = await res.json();
                
                if (result.success) {
                    fecharModal();
                    await carregarSemanas();
                    await carregarAgenda();
                } else {
                    alert('Erro ao excluir: ' + (result.error || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao excluir demanda!');
            }
        }
        
        window.onclick = function(event) {
            const modal = document.getElementById('modal');
            if (event.target == modal) {
                fecharModal();
            }
        }

        document.addEventListener('click', function(event) {
            if (celulaSelecionada && !event.target.closest('.agenda-table')) {
                celulaSelecionada.classList.remove('cell-selected');
                celulaSelecionada = null;
            }
        });
        
        // Fechar modal de feriados ao clicar fora
        window.addEventListener('click', function(event) {
            const modalFeriados = document.getElementById('modalFeriados');
            if (event.target == modalFeriados) {
                fecharModalFeriados();
            }
        });

        function scrollWeekTabs(direction) {
            const scrollContainer = document.getElementById('weekTabsScroll');
            const scrollAmount = 200; // pixels
            
            scrollPosition += (direction * scrollAmount);
            scrollContainer.scrollLeft = scrollPosition;
            
            // Atualizar posição real após scroll
            setTimeout(() => {
                scrollPosition = scrollContainer.scrollLeft;
                atualizarBotoesNavegacao();
            }, 100);
        }

        function atualizarBotoesNavegacao() {
            const scrollContainer = document.getElementById('weekTabsScroll');
            const btnPrev = document.getElementById('btnPrevWeek');
            const btnNext = document.getElementById('btnNextWeek');
            
            if (!scrollContainer || !btnPrev || !btnNext) return;
            
            const maxScroll = scrollContainer.scrollWidth - scrollContainer.clientWidth;
            
            // Desabilitar botão esquerdo se estiver no início
            btnPrev.disabled = scrollContainer.scrollLeft <= 0;
            
            // Desabilitar botão direito se estiver no fim
            btnNext.disabled = scrollContainer.scrollLeft >= maxScroll;
        }

        function scrollToActiveTab() {
            const scrollContainer = document.getElementById('weekTabsScroll');
            const activeTab = document.querySelector('.week-tab.active');
            
            if (!scrollContainer || !activeTab) return;
            
            const containerRect = scrollContainer.getBoundingClientRect();
            const tabRect = activeTab.getBoundingClientRect();
            
            // Verificar se a aba está fora da visão
            if (tabRect.left < containerRect.left || tabRect.right > containerRect.right) {
                // Centralizar a aba ativa
                const scrollLeft = activeTab.offsetLeft - (scrollContainer.clientWidth / 2) + (activeTab.clientWidth / 2);
                scrollContainer.scrollLeft = scrollLeft;
                scrollPosition = scrollLeft;
            }
            
            atualizarBotoesNavegacao();
        }

        // Atualizar botões ao redimensionar janela
        window.addEventListener('resize', () => {
            atualizarBotoesNavegacao();
        });

        // Atualizar botões ao scroll manual
        document.addEventListener('DOMContentLoaded', () => {
            const scrollContainer = document.getElementById('weekTabsScroll');
            if (scrollContainer) {
                scrollContainer.addEventListener('scroll', () => {
                    scrollPosition = scrollContainer.scrollLeft;
                    atualizarBotoesNavegacao();
                });
            }
        });

        // Verificar se veículo já possui demandas com horário no mesmo período
        async function verificarObrigatoriedadeHorario() {
            const idVeiculo = document.getElementById('idVeiculo').value;
            const dtInicio = document.getElementById('dtInicio').value;
            const dtFim = document.getElementById('dtFim').value;
            const idAd = document.getElementById('idAd').value;
            
            if (!idVeiculo || !dtInicio || !dtFim) return;
            
            try {
                let url = `/api/agenda/verificar-horario-veiculo?id_veiculo=${idVeiculo}&inicio=${dtInicio}&fim=${dtFim}`;
                if (idAd) {
                    url += `&id_demanda=${idAd}`;
                }
                
                const res = await fetch(url);
                const result = await res.json();
                
                if (result.tem_horario) {
                    // Forçar checkbox de horário
                    document.getElementById('definirHorario').checked = true;
                    document.getElementById('definirHorario').disabled = true;
                    document.getElementById('horario').disabled = false;
                    
                    alert('Este veículo já possui demandas com horário definido neste período. É obrigatório informar o horário.');
                } else {
                    document.getElementById('definirHorario').disabled = false;
                }
            } catch (error) {
                console.error('Erro ao verificar obrigatoriedade de horário:', error);
            }
        }
        
        // Adicionar event listener ao select de veículo
        // (adicionar na função init ou após DOMContentLoaded)
        document.getElementById('idVeiculo').addEventListener('change', verificarObrigatoriedadeHorario);
        
        init();
        
    </script>
</body>
</html>
