<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda SEGEOP</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            padding-bottom: 80px;
        }
        
        .container {
            max-width: 100%;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: #1a73e8;
            color: white;
            padding: 12px 20px;
            text-align: center;
        }
        
        .header h1 { font-size: 22px; margin: 0; }
        
        .toolbar {
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #1a73e8;
            color: white;
        }
        
        .btn-primary:hover { background: #1557b0; }
        
        .agenda-wrapper {
            overflow-x: auto;
            padding: 20px;
        }
        
        .agenda-section {
            margin-bottom: 40px;
        }
        
        .section-title {
            background: #34495e;
            color: white;
            padding: 10px 15px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 4px 4px 0 0;
        }
        
        .agenda-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #ddd;
            table-layout: fixed;
        }
        
        .agenda-table th {
            background: #ecf0f1;
            padding: 10px;
            text-align: center;
            border: 1px solid #ddd;
            font-size: 13px;
            font-weight: 600;
        }
        
        .agenda-table td {
            border: 1px solid #ddd;
            padding: 6px;
            vertical-align: top;
            font-size: 12px;
            position: relative;
            cursor: pointer;
            transition: background 0.2s;
            overflow: hidden;
        }
        
        .agenda-table td:hover {
            background: #f8f9fa !important;
        }
        
        .col-numero {
            width: 40px;
            background: #f8f9fa;
            font-weight: 600;
            text-align: center;
        }
        
        .col-nome {
            width: 216px;
            background: #f8f9fa;
            font-weight: 600;
            word-wrap: break-word;
            white-space: normal;
        }
        
        .col-dia {
            width: calc((100% - 256px) / 7);
        }
        
        .cell-content {
            line-height: 1.4;
            height: 60px;
            overflow: hidden;
            font-size: 11px;
            text-align: center;
        }
        
        .cell-content-veiculos {
            line-height: 1.4;
            height: 45px;
            overflow: hidden;
            font-size: 11px;
        }
        
        .cell-content div {
            margin-bottom: 2px;
        }
        
        .informar-veiculo {
            color: #dc3545;
            font-style: italic;
            font-size: 10px;
        }
        
        /* Cores por tipo de demanda */
        .tipo-1 { background: #cfe2ff; }
        .tipo-2 { background: #d1e7dd; }
        .tipo-3 { background: #ffe5d0; }
        .tipo-4, .tipo-5 { background: #fff3cd; }
        .tipo-6, .tipo-7, .tipo-8 { background: #fff9c4; }
        
        .empty-cell {
            background: #fafafa;
        }
        
        .empty-cell.weekend-empty {
            background: #e0e0e0;
        }
        
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #f8f9fa;
            padding: 15px 20px;
            border-top: 2px solid #dee2e6;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            z-index: 100;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        
        .week-tab {
            padding: 8px 16px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }
        
        .week-tab:hover {
            background: #e9ecef;
        }
        
        .week-tab.active {
            background: #1a73e8;
            color: white;
            border-color: #1a73e8;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 0;
            width: 90%;
            max-width: 600px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            animation: slideDown 0.3s;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        @keyframes slideDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            background: #1a73e8;
            color: white;
            padding: 20px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .modal-header h2 { font-size: 20px; }
        
        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: white;
            opacity: 0.8;
        }
        
        .close:hover { opacity: 1; }
        
        .modal-body {
            padding: 25px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 14px;
            color: #333;
        }
        
        .form-group label .required {
            color: #dc3545;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-group input:disabled,
        .form-group select:disabled {
            background: #e9ecef;
            cursor: not-allowed;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .modal-footer {
            padding: 20px;
            background: #f8f9fa;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            border-radius: 0 0 8px 8px;
            position: sticky;
            bottom: 0;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover { background: #5a6268; }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover { background: #c82333; }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìÖ AGENDA SEGEOP</h1>
        </div>
        
        <div class="toolbar">
            <div>
                <span id="semanaAtual" style="font-weight: 600; color: #333;"></span>
            </div>
            <button class="btn btn-primary" onclick="abrirModalNovo()">‚ûï Nova Demanda</button>
        </div>
        
        <div class="agenda-wrapper" id="agendaWrapper">
            <div class="loading">‚è≥ Carregando agenda...</div>
        </div>
    </div>
    
    <div class="footer" id="weekTabs"></div>
    
    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Nova Demanda</h2>
                <span class="close" onclick="fecharModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="formDemanda">
                    <input type="hidden" id="idAd" value="">
                    
                    <div class="form-group">
                        <label>Motorista <span class="required">*</span></label>
                        <select id="idMotorista" required></select>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Data In√≠cio <span class="required">*</span></label>
                            <input type="date" id="dtInicio" required>
                        </div>
                        <div class="form-group">
                            <label>Data Fim <span class="required">*</span></label>
                            <input type="date" id="dtFim" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Tipo de Demanda <span class="required">*</span></label>
                            <select id="idTipoDemanda" required></select>
                        </div>
                        <div class="form-group">
                            <label id="labelTipoVeiculo">Tipo de Ve√≠culo</label>
                            <select id="idTipoVeiculo"></select>
                        </div>                        
                    </div>
                    
                    <div class="form-group">
                        <label id="labelVeiculo">Ve√≠culo</label>
                        <select id="idVeiculo"></select>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label id="labelSetor">Setor</label>
                            <input type="text" id="setor" maxlength="35">
                        </div>
                        <div class="form-group">
                            <label id="labelSolicitante">Solicitante</label>
                            <input type="text" id="solicitante" maxlength="30">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label id="labelDestino">Destino</label>
                            <input type="text" id="destino" maxlength="25">
                        </div>    
                        <div class="form-group">
                            <label>N¬∫ SEI</label>
                            <input type="text" id="nuSei" maxlength="25">
                        </div>
                    </div>
                    
                    <input type="hidden" id="usuario" value="ADMIN">
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="fecharModal()">Cancelar</button>
                <button class="btn btn-danger" id="btnExcluir" onclick="excluirDemanda()" style="display:none;">üóëÔ∏è Excluir</button>
                <button class="btn btn-primary" onclick="salvarDemanda()">üíæ Salvar</button>
            </div>
        </div>
    </div>
    
    <script>
        let semanas = [];
        let semanaAtual = 0;
        let dadosAgenda = null;
        let motoristas = [];
        let veiculos = [];
        let tiposDemanda = [];
        let tiposVeiculo = [];
        let veiculoSelecionadoOriginal = null;
        
        async function init() {
            await carregarSemanas();
            await carregarSelectsFixos();
            if (semanas.length > 0) {
                const hoje = new Date();
                hoje.setHours(0, 0, 0, 0);
                
                let semanaEncontrada = -1;
                for (let i = 0; i < semanas.length; i++) {
                    const inicio = new Date(semanas[i].inicio + 'T00:00:00');
                    const fim = new Date(semanas[i].fim + 'T00:00:00');
                    
                    if (hoje >= inicio && hoje <= fim) {
                        semanaEncontrada = i;
                        break;
                    }
                }
                
                semanaAtual = semanaEncontrada !== -1 ? semanaEncontrada : semanas.length - 1;
                await carregarAgenda();
            }
        }
        
        async function carregarSemanas() {
            try {
                const res = await fetch('/api/agenda/semanas');
                const data = await res.json();
                
                if (data.error) {
                    console.error('Erro na API:', data.error);
                    semanas = data.semanas || [];
                } else if (Array.isArray(data)) {
                    semanas = data;
                } else {
                    semanas = [];
                }
                
                renderizarAbas();
            } catch (error) {
                console.error('Erro ao carregar semanas:', error);
                semanas = [];
                const hoje = new Date();
                const domingo = new Date(hoje);
                domingo.setDate(hoje.getDate() - ((hoje.getDay() + 7) % 7));
                const sabado = new Date(domingo);
                sabado.setDate(domingo.getDate() + 6);
                
                semanas = [{
                    inicio: domingo.toISOString().split('T')[0],
                    fim: sabado.toISOString().split('T')[0],
                    label: `${domingo.getDate()}/${domingo.getMonth()+1} - ${sabado.getDate()}/${sabado.getMonth()+1}/${sabado.getFullYear()}`
                }];
                renderizarAbas();
            }
        }
        
        async function carregarSelectsFixos() {
            try {
                const [resTiposDemanda, resTiposVeiculo] = await Promise.all([
                    fetch('/api/agenda/tipos-demanda'),
                    fetch('/api/agenda/tipos-veiculo')
                ]);
                
                tiposDemanda = await resTiposDemanda.json();
                tiposVeiculo = await resTiposVeiculo.json();
                
                const selectTipoDemanda = document.getElementById('idTipoDemanda');
                const selectTipoVeiculo = document.getElementById('idTipoVeiculo');
                
                selectTipoDemanda.innerHTML = '<option value="">Selecione...</option>';
                tiposDemanda.forEach(t => {
                    selectTipoDemanda.innerHTML += `<option value="${t.id}" data-descricao="${t.descricao}">${t.descricao}</option>`;
                });
                
                selectTipoVeiculo.innerHTML = '<option value="">Selecione...</option>';
                tiposVeiculo.forEach(t => {
                    selectTipoVeiculo.innerHTML += `<option value="${t.id}">${t.descricao}</option>`;
                });
                
                // Event listeners para regras de neg√≥cio
                selectTipoDemanda.addEventListener('change', aplicarRegrasTipoDemanda);
                selectTipoVeiculo.addEventListener('change', aplicarRegrasTipoVeiculo);
                document.getElementById('dtInicio').addEventListener('change', atualizarVeiculosDisponiveis);
                document.getElementById('dtFim').addEventListener('change', atualizarVeiculosDisponiveis);
            } catch (error) {
                console.error('Erro ao carregar selects:', error);
            }
        }
        
        function aplicarRegrasTipoDemanda() {
            const idTipoDemanda = parseInt(document.getElementById('idTipoDemanda').value);
            const selectTipoDemanda = document.getElementById('idTipoDemanda');
            const optionSelecionada = selectTipoDemanda.options[selectTipoDemanda.selectedIndex];
            const descricaoTipoDemanda = optionSelecionada ? optionSelecionada.getAttribute('data-descricao') : '';
            
            const tipoVeiculo = document.getElementById('idTipoVeiculo');
            const veiculo = document.getElementById('idVeiculo');
            const setor = document.getElementById('setor');
            const solicitante = document.getElementById('solicitante');
            const destino = document.getElementById('destino');
            
            const labelTipoVeiculo = document.getElementById('labelTipoVeiculo');
            const labelVeiculo = document.getElementById('labelVeiculo');
            const labelSetor = document.getElementById('labelSetor');
            const labelSolicitante = document.getElementById('labelSolicitante');
            const labelDestino = document.getElementById('labelDestino');
            
            // Resetar labels
            labelTipoVeiculo.innerHTML = 'Tipo de Ve√≠culo';
            labelVeiculo.innerHTML = 'Ve√≠culo';
            labelSetor.innerHTML = 'Setor';
            labelSolicitante.innerHTML = 'Solicitante';
            labelDestino.innerHTML = 'Destino';
            
            // Habilitar todos primeiro
            tipoVeiculo.disabled = false;
            veiculo.disabled = false;
            setor.disabled = false;
            solicitante.disabled = false;
            destino.disabled = false;
            
            if (idTipoDemanda >= 6 && idTipoDemanda <= 8) {
                // ID 6-8: Fecha e desobriga Tipo Ve√≠culo, Ve√≠culo, Setor, Solicitante, Destino
                tipoVeiculo.disabled = true;
                tipoVeiculo.value = '';
                veiculo.disabled = true;
                veiculo.value = '';
                setor.disabled = true;
                setor.value = '';
                solicitante.disabled = true;
                solicitante.value = '';
                destino.disabled = true;
                if (!destino.value) {
                    destino.value = descricaoTipoDemanda;
                }
            } else if (idTipoDemanda === 4 || idTipoDemanda === 5) {
                // ID 4-5: Setor e Solicitante podem ficar em branco, Destino = DE_TIPODEMANDA
                if (!destino.value) {
                    destino.value = descricaoTipoDemanda;
                }
            } else if (idTipoDemanda === 3) {
                // ID 3: Setor e Solicitante podem ficar em branco, Destino usu√°rio preenche
                // N√£o preenche automaticamente
            } else if (idTipoDemanda === 1 || idTipoDemanda === 2) {
                // ID 1-2: Setor e Solicitante obrigat√≥rios
                labelSetor.innerHTML = 'Setor <span class="required">*</span>';
                labelSolicitante.innerHTML = 'Solicitante <span class="required">*</span>';
            }
        }
        
        function aplicarRegrasTipoVeiculo() {
            const idTipoVeiculo = parseInt(document.getElementById('idTipoVeiculo').value);
            const veiculo = document.getElementById('idVeiculo');
            
            if (!idTipoVeiculo) {
                veiculo.disabled = false;
                veiculo.innerHTML = '<option value="">Selecione...</option>';
                return;
            }
            
            if (idTipoVeiculo !== 1) {
                // Tipo diferente de 1: bloqueia ve√≠culo
                veiculo.disabled = true;
                veiculo.value = '';
            } else {
                // Tipo 1: habilita e carrega ve√≠culos dispon√≠veis
                veiculo.disabled = false;
                atualizarVeiculosDisponiveis();
            }
        }
        
        async function atualizarVeiculosDisponiveis() {
            const idTipoVeiculo = parseInt(document.getElementById('idTipoVeiculo').value);
            const dtInicio = document.getElementById('dtInicio').value;
            const dtFim = document.getElementById('dtFim').value;
            const selectVeiculo = document.getElementById('idVeiculo');
            const idAd = document.getElementById('idAd').value;
            
            // S√≥ atualiza se for tipo ve√≠culo 1 e tiver datas
            if (idTipoVeiculo !== 1 || !dtInicio || !dtFim) {
                return;
            }
            
            try {
                let url = `/api/agenda/veiculos-disponiveis?inicio=${dtInicio}&fim=${dtFim}`;
                if (idAd) {
                    url += `&id_demanda=${idAd}`;
                }
                
                const res = await fetch(url);
                const veiculosDisponiveis = await res.json();
                
                const veiculoAtual = selectVeiculo.value;
                
                selectVeiculo.innerHTML = '<option value="">Selecione...</option>';
                
                // Adiciona ve√≠culos dispon√≠veis
                veiculosDisponiveis.forEach(v => {
                    selectVeiculo.innerHTML += `<option value="${v.id}">${v.veiculo}</option>`;
                });
                
                // Se tinha um ve√≠culo selecionado e ele n√£o est√° na lista, adiciona
                if (veiculoAtual && veiculoSelecionadoOriginal) {
                    const existe = Array.from(selectVeiculo.options).some(opt => opt.value == veiculoAtual);
                    if (!existe) {
                        selectVeiculo.innerHTML += `<option value="${veiculoSelecionadoOriginal.id}">${veiculoSelecionadoOriginal.veiculo}</option>`;
                    }
                    selectVeiculo.value = veiculoAtual;
                }
            } catch (error) {
                console.error('Erro ao carregar ve√≠culos dispon√≠veis:', error);
            }
        }
        
        function renderizarAbas() {
            const tabs = document.getElementById('weekTabs');
            tabs.innerHTML = semanas.map((s, i) => 
                `<div class="week-tab ${i === semanaAtual ? 'active' : ''}" 
                      onclick="mudarSemana(${i})">${s.label}</div>`
            ).join('');
        }
        
        async function mudarSemana(index) {
            semanaAtual = index;
            renderizarAbas();
            await carregarAgenda();
        }
        
        async function carregarAgenda() {
            const wrapper = document.getElementById('agendaWrapper');
            wrapper.innerHTML = '<div class="loading">‚è≥ Carregando agenda...</div>';
            
            try {
                const semana = semanas[semanaAtual];
                const res = await fetch(`/api/agenda/dados?inicio=${semana.inicio}&fim=${semana.fim}`);
                dadosAgenda = await res.json();
                
                motoristas = dadosAgenda.motoristas;
                veiculos = dadosAgenda.veiculos;
                
                document.getElementById('semanaAtual').textContent = semana.label;
                
                renderizarAgenda();
            } catch (error) {
                wrapper.innerHTML = '<div class="loading">‚ùå Erro ao carregar agenda</div>';
                console.error('Erro:', error);
            }
        }
        
        function renderizarAgenda() {
            const semana = semanas[semanaAtual];
            const dias = gerarDiasSemana(semana.inicio);
            
            let html = '';
            
            html += renderizarSecaoMotoristas(dias);
            html += renderizarSecaoVeiculos(dias);
            html += renderizarSecaoVeiculosAlocados(dias);
            
            document.getElementById('agendaWrapper').innerHTML = html;
        }
        
        function gerarDiasSemana(inicioStr) {
            const dias = [];
            const inicio = new Date(inicioStr + 'T00:00:00');
            
            for (let i = 0; i < 7; i++) {
                const d = new Date(inicio);
                d.setDate(inicio.getDate() + i);
                dias.push({
                    data: d.toISOString().split('T')[0],
                    diaNum: d.getDate(),
                    mes: d.getMonth() + 1,
                    diaNome: ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'][d.getDay()],
                    diaIndex: d.getDay()
                });
            }
            return dias;
        }
        
        function renderizarSecaoMotoristas(dias) {
            let html = '<div class="agenda-section">';
            html += '<div class="section-title">üöó SEGEOP - MOTORISTAS</div>';
            html += '<table class="agenda-table"><thead><tr>';
            html += '<th class="col-numero">N.</th><th class="col-nome">Nome</th>';
            dias.forEach(d => html += `<th class="col-dia">${d.diaNome}<br>${d.diaNum}/${d.mes}</th>`);
            html += '</tr></thead><tbody>';
            
            motoristas.forEach((m, index) => {
                html += `<tr><td class="col-numero">${index + 1}</td>`;
                html += `<td class="col-nome">${m.nome}</td>`;
                
                dias.forEach(dia => {
                    const demandasDia = dadosAgenda.demandas.filter(d => 
                        d.id_motorista === m.id && 
                        d.dt_inicio <= dia.data && 
                        d.dt_fim >= dia.data
                    );
                    
                    if (demandasDia.length > 0) {
                        const demanda = demandasDia[0];
                        const corClass = `tipo-${demanda.id_tipodemanda}`;
                        html += `<td class="${corClass} col-dia" onclick="abrirModalEditar(${demanda.id})">`;
                        html += '<div class="cell-content">';
                        html += `<div><strong>${demanda.setor || ''}</strong>${demanda.solicitante ? ' (' + demanda.solicitante + ')' : ''}</div>`;
                        html += `<div>${demanda.destino || ''}</div>`;
                        html += `<div>${demanda.nu_sei || ''}</div>`;
                        
                        // Mostrar (INFORMAR VE√çCULO) se n√£o tiver tipo de ve√≠culo
                        if (!demanda.id_tipoveiculo) {
                            html += '<div class="informar-veiculo">(INFORMAR VE√çCULO)</div>';
                        }
                        
                        html += '</div></td>';
                    } else {
                        const isWeekend = dia.diaIndex === 0 || dia.diaIndex === 6;
                        const weekendClass = isWeekend ? 'weekend-empty' : '';
                        html += `<td class="empty-cell ${weekendClass} col-dia" onclick="abrirModalNovoComData('${dia.data}', ${m.id})"></td>`;
                    }
                });
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            return html;
        }
        
        function renderizarSecaoVeiculos(dias) {
            let html = '<div class="agenda-section">';
            html += '<div class="section-title">üöô SEGEOP - VE√çCULOS OFICIAIS</div>';
            html += '<table class="agenda-table"><thead><tr>';
            html += '<th class="col-numero">N.</th><th class="col-nome">Ve√≠culo</th>';
            dias.forEach(d => html += `<th class="col-dia">${d.diaNome}<br>${d.diaNum}/${d.mes}</th>`);
            html += '</tr></thead><tbody>';
            
            veiculos.forEach((v, index) => {
                html += `<tr><td class="col-numero">${index + 1}</td>`;
                html += `<td class="col-nome">${v.veiculo}</td>`;
                
                dias.forEach(dia => {
                    const demandasDia = dadosAgenda.demandas.filter(d => 
                        d.id_veiculo === v.id && 
                        d.dt_inicio <= dia.data && 
                        d.dt_fim >= dia.data
                    );
                    
                    if (demandasDia.length > 0) {
                        const demanda = demandasDia[0];
                        const corClass = `tipo-${demanda.id_tipodemanda}`;
                        html += `<td class="${corClass} col-dia" onclick="abrirModalEditar(${demanda.id})">`;
                        html += '<div class="cell-content-veiculos">';
                        html += `<div><strong>${demanda.nm_motorista || ''}</strong></div>`;
                        html += `<div>${demanda.nu_sei || ''}</div>`;
                        html += '</div></td>';
                    } else {
                        const isWeekend = dia.diaIndex === 0 || dia.diaIndex === 6;
                        const weekendClass = isWeekend ? 'weekend-empty' : '';
                        html += `<td class="empty-cell ${weekendClass} col-dia"></td>`;
                    }
                });
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            return html;
        }
        
        function renderizarSecaoVeiculosAlocados(dias) {
            // const demandasAlocadas = dadosAgenda.demandas.filter(d => d.id_tipoveiculo != 1);
            const demandasAlocadas = dadosAgenda.demandas.filter(d => d.id_tipoveiculo != 1 && d.id_tipoveiculo !== null);

            
            if (demandasAlocadas.length === 0) return '';
            
            const grupos = {};
            demandasAlocadas.forEach(d => {
                const key = `${d.de_tipoveiculo}|${d.nu_sei}|${d.destino}`;
                if (!grupos[key]) {
                    grupos[key] = {
                        de_tipoveiculo: d.de_tipoveiculo,
                        nu_sei: d.nu_sei,
                        destino: d.destino,
                        demandas: []
                    };
                }
                grupos[key].demandas.push(d);
            });
            
            let html = '<div class="agenda-section">';
            html += '<div class="section-title">üöå SEGEOP - VE√çCULOS ALOCADOS</div>';
            html += '<table class="agenda-table"><thead><tr>';
            html += '<th class="col-numero">N.</th><th class="col-nome">Tipo Ve√≠culo / SEI / Destino</th>';
            dias.forEach(d => html += `<th class="col-dia">${d.diaNome}<br>${d.diaNum}/${d.mes}</th>`);
            html += '</tr></thead><tbody>';
            
            Object.values(grupos).forEach((grupo, index) => {
                html += `<tr><td class="col-numero">${index + 1}</td>`;
                html += `<td class="col-nome">`;
                html += `<div><strong>${grupo.de_tipoveiculo}</strong></div>`;
                html += `<div>${grupo.nu_sei || ''}</div>`;
                html += `<div>${grupo.destino || ''}</div>`;
                html += `</td>`;
                
                dias.forEach(dia => {
                    const demandasDia = grupo.demandas.filter(d => 
                        d.dt_inicio <= dia.data && 
                        d.dt_fim >= dia.data
                    );
                    
                    if (demandasDia.length > 0) {
                        const demanda = demandasDia[0];
                        html += `<td class="col-dia" onclick="abrirModalEditar(${demanda.id})">`;
                        html += '<div class="cell-content-veiculos">';
                        html += `<div><strong>${demanda.nm_motorista || ''}</strong></div>`;
                        html += '</div></td>';
                    } else {
                        const isWeekend = dia.diaIndex === 0 || dia.diaIndex === 6;
                        const weekendClass = isWeekend ? 'weekend-empty' : '';
                        html += `<td class="empty-cell ${weekendClass} col-dia"></td>`;
                    }
                });
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            return html;
        }
        
        function abrirModalNovo() {
            document.getElementById('modalTitle').textContent = 'Nova Demanda';
            document.getElementById('idAd').value = '';
            document.getElementById('formDemanda').reset();
            document.getElementById('btnExcluir').style.display = 'none';
            veiculoSelecionadoOriginal = null;
            
            preencherSelectMotoristas();
            preencherSelectVeiculos();
            
            // Resetar labels
            document.getElementById('labelTipoVeiculo').innerHTML = 'Tipo de Ve√≠culo';
            document.getElementById('labelVeiculo').innerHTML = 'Ve√≠culo';
            document.getElementById('labelSetor').innerHTML = 'Setor';
            document.getElementById('labelSolicitante').innerHTML = 'Solicitante';
            document.getElementById('labelDestino').innerHTML = 'Destino';
            
            // Habilitar todos os campos
            document.getElementById('idTipoVeiculo').disabled = false;
            document.getElementById('idVeiculo').disabled = false;
            document.getElementById('setor').disabled = false;
            document.getElementById('solicitante').disabled = false;
            document.getElementById('destino').disabled = false;
            
            document.getElementById('modal').style.display = 'block';
        }
        
        function abrirModalNovoComData(data, idMotorista = null) {
            abrirModalNovo();
            document.getElementById('dtInicio').value = data;
            document.getElementById('dtFim').value = data;
            if (idMotorista) {
                document.getElementById('idMotorista').value = idMotorista;
            }
        }
        
        function abrirModalEditar(idAd) {
            const demanda = dadosAgenda.demandas.find(d => d.id === idAd);
            if (!demanda) return;
            
            document.getElementById('modalTitle').textContent = 'Editar Demanda';
            document.getElementById('idAd').value = demanda.id;
            document.getElementById('btnExcluir').style.display = 'inline-block';
            
            // Guardar ve√≠culo original para manter na lista
            if (demanda.id_veiculo) {
                veiculoSelecionadoOriginal = {
                    id: demanda.id_veiculo,
                    veiculo: veiculos.find(v => v.id === demanda.id_veiculo)?.veiculo || ''
                };
            } else {
                veiculoSelecionadoOriginal = null;
            }
            
            preencherSelectMotoristas();
            preencherSelectVeiculos();
            
            document.getElementById('idMotorista').value = demanda.id_motorista;
            document.getElementById('dtInicio').value = demanda.dt_inicio;
            document.getElementById('dtFim').value = demanda.dt_fim;
            document.getElementById('idTipoDemanda').value = demanda.id_tipodemanda;
            document.getElementById('idTipoVeiculo').value = demanda.id_tipoveiculo || '';
            document.getElementById('idVeiculo').value = demanda.id_veiculo || '';
            document.getElementById('setor').value = demanda.setor || '';
            document.getElementById('solicitante').value = demanda.solicitante || '';
            document.getElementById('destino').value = demanda.destino || '';
            document.getElementById('nuSei').value = demanda.nu_sei || '';
            
            // Aplicar regras ap√≥s preencher
            aplicarRegrasTipoDemanda();
            aplicarRegrasTipoVeiculo();
            
            document.getElementById('modal').style.display = 'block';
        }
        
        function fecharModal() {
            document.getElementById('modal').style.display = 'none';
            veiculoSelecionadoOriginal = null;
        }
        
        function preencherSelectMotoristas() {
            const select = document.getElementById('idMotorista');
            select.innerHTML = '<option value="">Selecione...</option>';
            motoristas.forEach(m => {
                select.innerHTML += `<option value="${m.id}">${m.nome}</option>`;
            });
        }
        
        function preencherSelectVeiculos() {
            const select = document.getElementById('idVeiculo');
            select.innerHTML = '<option value="">Selecione...</option>';
            veiculos.forEach(v => {
                select.innerHTML += `<option value="${v.id}">${v.veiculo}</option>`;
            });
        }
        
        async function salvarDemanda() {
            const idAd = document.getElementById('idAd').value;
            const idTipoDemanda = parseInt(document.getElementById('idTipoDemanda').value);
            
            const dados = {
                id_motorista: document.getElementById('idMotorista').value,
                id_tipodemanda: idTipoDemanda,
                id_tipoveiculo: document.getElementById('idTipoVeiculo').value || null,
                id_veiculo: document.getElementById('idVeiculo').value || null,
                dt_inicio: document.getElementById('dtInicio').value,
                dt_fim: document.getElementById('dtFim').value,
                setor: document.getElementById('setor').value,
                solicitante: document.getElementById('solicitante').value,
                destino: document.getElementById('destino').value,
                nu_sei: document.getElementById('nuSei').value,
                usuario: document.getElementById('usuario').value
            };
            
            // Valida√ß√µes obrigat√≥rias
            if (!dados.id_motorista || !dados.id_tipodemanda || !dados.dt_inicio || !dados.dt_fim) {
                alert('Preencha todos os campos obrigat√≥rios: Motorista, Tipo de Demanda, Data In√≠cio e Data Fim!');
                return;
            }
            
            // Valida√ß√£o para ID 1 ou 2: Setor e Solicitante obrigat√≥rios
            if ((idTipoDemanda === 1 || idTipoDemanda === 2) && (!dados.setor || !dados.solicitante)) {
                alert('Para este tipo de demanda, Setor e Solicitante s√£o obrigat√≥rios!');
                return;
            }
            
            try {
                let res;
                if (idAd) {
                    res = await fetch(`/api/agenda/demanda/${idAd}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(dados)
                    });
                } else {
                    res = await fetch('/api/agenda/demanda', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(dados)
                    });
                }
                
                const result = await res.json();
                
                if (result.success || result.id) {
                    fecharModal();
                    await carregarSemanas();
                    await carregarAgenda();
                    alert('Demanda salva com sucesso!');
                } else {
                    alert('Erro ao salvar: ' + (result.error || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao salvar demanda!');
            }
        }
        
        async function excluirDemanda() {
            const idAd = document.getElementById('idAd').value;
            if (!idAd) return;
            
            if (!confirm('Deseja realmente excluir esta demanda?')) return;
            
            try {
                const res = await fetch(`/api/agenda/demanda/${idAd}`, {
                    method: 'DELETE'
                });
                
                const result = await res.json();
                
                if (result.success) {
                    fecharModal();
                    await carregarSemanas();
                    await carregarAgenda();
                    alert('Demanda exclu√≠da com sucesso!');
                } else {
                    alert('Erro ao excluir: ' + (result.error || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao excluir demanda!');
            }
        }
        
        window.onclick = function(event) {
            const modal = document.getElementById('modal');
            if (event.target == modal) {
                fecharModal();
            }
        }
        
        init();
    </script>
</body>
</html>
